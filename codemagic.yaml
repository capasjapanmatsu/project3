      - name: Build IPA with Xcode
        script: |
          set -e
          EXPORT_PLIST="$HOME/export_options.plist"
          cat > "$EXPORT_PLIST" <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>uploadSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          if [ -d "ios/App/App.xcworkspace" ]; then
            xcode-project build-ipa \
              --workspace ios/App/App.xcworkspace \
              --scheme "$IOS_SCHEME" \
              --archive-flags "-destination generic/platform=iOS DEVELOPMENT_TEAM=$APPLE_TEAM_ID" \
              --export-options-plist "$EXPORT_PLIST"
          elif [ -d "ios/App/App.xcodeproj" ]; then
            xcode-project build-ipa \
              --project ios/App/App.xcodeproj \
              --scheme "$IOS_SCHEME" \
              --archive-flags "-destination generic/platform=iOS DEVELOPMENT_TEAM=$APPLE_TEAM_ID" \
              --export-options-plist "$EXPORT_PLIST"
          else
            echo "No Xcode project under ios/App/"
            exit 1
          fi
