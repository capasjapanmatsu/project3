<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DogParkJP ログイン</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{color-scheme:light dark}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#f0f7ff,#ffffff);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .wrap{width:100%;max-width:520px;padding:32px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:28px;box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .brand .logo{width:36px;height:36px;border-radius:12px;background:#10b981;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:18px;margin:0;color:#111827}
    p.caption{margin:4px 0 20px;color:#6b7280;font-size:13px}
    .center{display:flex;align-items:center;gap:12px}
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid #dbeafe;border-top-color:#2563eb;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status{color:#374151;font-size:14px}
    .err{color:#dc2626;margin-top:8px}
    .action{margin-top:16px}
    .btn{padding:10px 16px;border:0;border-radius:999px;background:#2563eb;color:#fff;cursor:pointer}
  </style>
  <!-- NOTE: {{LIFF_ID}} は動作確認時に実値へ置き換えてください。将来的にビルド時注入でも可 -->
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="brand">
        <div class="logo" aria-hidden="true">JP</div>
        <h1>DogPark JP にログインしています…</h1>
      </div>
      <p class="caption">LINE認証の後、自動でマイページに移動します</p>
      <div class="center">
        <div class="spinner" aria-hidden="true"></div>
        <div class="status" id="status">初期化中…</div>
      </div>
      <div class="action">
        <button id="retry" class="btn" style="display:none">もう一度試す</button>
      </div>
      <div id="result" style="display:none"></div>
    </div>
  </div>

  <script>
    // ★ LIFF_ID の決め方
    // 1) URLクエリ ?liffId=XXXX を優先
    // 2) それが無い場合は本番固定IDを使用
    const params = new URL(location.href).searchParams;
    const LIFF_ID = params.get('liffId') || "2007901083-yrjAg3Q5";

    async function main() {
      const $status = document.getElementById('status');
      const $result = document.getElementById('result');
      const $retry  = document.getElementById('retry');

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login({ scope: ['profile','openid'] });
          return;
        }

        $status.textContent = "LINEプロフィール取得中…";
        const profile = await liff.getProfile();
        try { sessionStorage.setItem('liff_display_name', profile.displayName || ''); } catch {}
        const idToken = liff.getIDToken();

        $status.textContent = "ログイン処理中…";
        // 新APIへ切替
        const res = await fetch('/.netlify/functions/auth-session', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken })
        });

        const data = await res.json();
        if (!res.ok || !data.ok) {
          // トークン期限切れなどの際は再ログインを要求
          if (res.status === 401 && data && typeof data.error === 'string' && data.error.toLowerCase().includes('expired')) {
            $status.textContent = 'トークン期限切れのため再ログインします…';
            try { await liff.logout(); } catch {}
            liff.login({ scope: ['profile','openid'], prompt: 'consent' });
            return;
          }
          throw new Error(data.error || '検証に失敗しました');
        }

        // iOS/LINE WebView 対策：Cookie反映待ち
        await new Promise(r => setTimeout(r, 0));
        $status.textContent = `ようこそ、${profile.displayName} さん。ログイン完了！`;
        // スプラッシュを一度だけスキップするフラグ
        try { localStorage.setItem('skipSplashOnce', '1'); } catch {}
        // 成功: リダイレクト先（?redirect=/profile-settings 等）へ
        const redirect = params.get('redirect') || '/dashboard';
        location.assign(redirect);
      } catch (err) {
        console.error(err);
        $status.innerHTML = '<span class="err">エラー: ' + err.message + '</span>';
        $retry.style.display = 'inline-block';
        $retry.onclick = async () => {
          try { await liff.logout(); } catch {}
          location.reload();
        };
      }
    }

    main();
  </script>
</body>
</html>


