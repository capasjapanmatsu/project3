import{j as e,w as s,C as a,g as l,aO as r,X as t}from"./ui-vendor.5lywbznV.js";import{u as i,r as d}from"./react-vendor.C7ykWfwV.js";import{u as n,C as c,I as m,B as o,s as x}from"./admin-pages.BuCPNRRu.js";import"./supabase-vendor.CX-WoPCS.js";const h=[{id:"pet_hotel",name:"ペットホテル",monthly_fee:5e3,is_free:!0},{id:"pet_salon",name:"ペットサロン",monthly_fee:3e3,is_free:!0},{id:"veterinary",name:"動物病院",monthly_fee:8e3,is_free:!0},{id:"pet_cafe",name:"ペットカフェ",monthly_fee:4e3,is_free:!0},{id:"pet_restaurant",name:"ペット同伴レストラン",monthly_fee:6e3,is_free:!0},{id:"pet_shop",name:"ペットショップ",monthly_fee:7e3,is_free:!0},{id:"pet_accommodation",name:"ペット同伴宿泊",monthly_fee:1e4,is_free:!0}];function g(){const{user:g,isAuthenticated:b,userProfile:j}=n(),u=i(),[f,p]=d.useState(!1),[N,y]=d.useState(""),[v,w]=d.useState(""),[_,C]=d.useState([]),[E,k]=d.useState([]),[S,q]=d.useState({name:(null==j?void 0:j.name)||"",address:(null==j?void 0:j.address)||"",isEditing:!1}),[I,D]=d.useState({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:[]});d.useEffect(()=>{b||u("/login")},[b,u]),d.useEffect(()=>{j&&q({name:j.name||"",address:j.address||"",isEditing:!1})},[j]);const O=e=>{const{name:s,value:a}=e.target;D(e=>({...e,[s]:a}))},P=async e=>{const s=Array.from(e.target.files||[]);if(0!==s.length)if(_.length+s.length>5)y("画像は最大5枚までアップロードできます");else{p(!0),y("");try{if(s.filter(e=>e.size>10485760).length>0)return y("画像ファイルのサイズは10MB以下にしてください"),void p(!1);const e=await Promise.all(s.map(e=>(e=>new Promise((s,a)=>{const l=document.createElement("canvas"),r=l.getContext("2d"),t=document.createElement("img");t.onload=()=>{let e=t.naturalWidth,a=t.naturalHeight;e>a?e>800&&(a=800*a/e,e=800):a>600&&(e=600*e/a,a=600),l.width=e,l.height=a,null==r||r.drawImage(t,0,0,e,a);const i=l.toDataURL("image/jpeg",.8);s(i)},t.onerror=a,t.src=URL.createObjectURL(e)}))(e))),a=s.slice(0,5-_.length);C(e=>[...e,...a]),k(s=>[...s,...e]),D(s=>({...s,images:[...s.images,...e]}))}catch(a){y(a instanceof Error?a.message:"画像の処理に失敗しました")}finally{p(!1)}}},B=async()=>{if(g)if(I.name&&I.category_id&&I.address){p(!0),y("");try{const e={owner_id:g.id,name:I.name,category_id:I.category_id,address:I.address,phone:I.phone,website:I.website,description:I.description,status:"pending",created_at:(new Date).toISOString()};0;const s=await x.from("pet_facilities").insert(e).select().single(),{data:a,error:l}=s;if(l)throw l;if(I.images.length>0&&a&&"object"==typeof a&&"id"in a){const e=I.images.map((e,s)=>({facility_id:a.id,image_data:e,is_primary:0===s,created_at:(new Date).toISOString()})),{error:s}=await x.from("facility_images").insert(e)}w("施設の掲載申請が完了しました！管理者の承認後、地図に掲載されます。"),setTimeout(()=>{u("/dashboard")},2e3)}catch(e){const s=e instanceof Error?e.message:"申請に失敗しました";y(s),e instanceof Error&&e.message.includes("アップロード")}finally{p(!1)}}else y("必須項目を入力してください");else y("ログインが必要です")},F=e=>{const{name:s,value:a}=e.target;q(e=>({...e,[s]:a}))},G=()=>{(async()=>{if(g)try{p(!0);const{error:e}=await x.from("profiles").update({name:S.name,address:S.address,updated_at:(new Date).toISOString()}).eq("id",g.id);if(e)throw new Error("ユーザー情報の更新に失敗しました");q(e=>({...e,isEditing:!1})),w("ユーザー情報を更新しました"),setTimeout(()=>w(""),3e3)}catch(e){y(e instanceof Error?e.message:"ユーザー情報の更新に失敗しました")}finally{p(!1)}})()},L=()=>{q({name:(null==j?void 0:j.name)||"",address:(null==j?void 0:j.address)||"",isEditing:!1})};return b?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ペット関連施設登録"}),e.jsx("p",{className:"text-gray-600",children:"ペット関連施設の掲載申請を行います。管理者の承認後、地図に表示されます。"})]}),N&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(s,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:N})]})}),v&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(a,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"text-green-700",children:v})]})}),e.jsxs("form",{onSubmit:e=>{e.preventDefault(),B()},className:"space-y-6",children:[e.jsx(c,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(l,{className:"w-6 h-6 mr-2"}),"基本情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設名 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(m,{label:"施設名",name:"name",value:I.name,onChange:O,placeholder:"施設名を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設カテゴリ ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"category_id",value:I.category_id,onChange:O,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"カテゴリを選択してください"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["住所 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(m,{label:"住所",name:"address",value:I.address,onChange:O,placeholder:"住所を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(m,{label:"電話番号",name:"phone",value:I.phone,onChange:O,placeholder:"電話番号を入力してください"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(m,{label:"ウェブサイト",name:"website",value:I.website,onChange:O,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設の説明"}),e.jsx("textarea",{name:"description",value:I.description,onChange:O,rows:4,placeholder:"施設の特徴やサービス内容を入力してください",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})]})}),e.jsx(c,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(l,{className:"w-6 h-6 mr-2"}),"ユーザー情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"名前"}),S.isEditing?e.jsx(m,{label:"名前",name:"name",value:S.name,onChange:F,placeholder:"名前を入力してください"}):e.jsx("p",{className:"text-gray-900",children:S.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),S.isEditing?e.jsx(m,{label:"住所",name:"address",value:S.address,onChange:F,placeholder:"住所を入力してください"}):e.jsx("p",{className:"text-gray-900",children:S.address})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:S.isEditing?e.jsxs(e.Fragment,{children:[e.jsx(o,{onClick:G,className:"mr-2",disabled:f,children:f?"保存中...":"保存"}),e.jsx(o,{onClick:L,disabled:f,children:"キャンセル"})]}):e.jsx(o,{onClick:()=>q(e=>({...e,isEditing:!0})),children:"編集"})})]})}),e.jsx(c,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(a,{className:"w-6 h-6 mr-2"}),"登録者情報の確認"]}),e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(s,{className:"w-5 h-5 text-blue-500 mr-2 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"登録者情報の確認"}),e.jsx("p",{className:"text-xs",children:"以下の情報をご確認ください。変更が必要な場合は編集できます。"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"氏名"}),S.isEditing?e.jsx(m,{label:"氏名",name:"name",value:S.name,onChange:F,placeholder:"氏名を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:S.name||"未設定"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),S.isEditing?e.jsx(m,{label:"住所",name:"address",value:S.address,onChange:F,placeholder:"住所を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:S.address||"未設定"})})]}),e.jsx("div",{className:"flex gap-2",children:S.isEditing?e.jsxs(e.Fragment,{children:[e.jsx(o,{type:"button",onClick:G,disabled:f,children:f?"保存中...":"保存"}),e.jsx(o,{type:"button",onClick:L,children:"キャンセル"})]}):e.jsx(o,{type:"button",onClick:()=>q(e=>({...e,isEditing:!0})),children:"編集"})})]})]})}),e.jsx(c,{className:"mb-6",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(r,{className:"w-6 h-6 mr-2"}),"施設画像 (最大5枚)"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"画像をアップロード"}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{P(e)},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:f||_.length>=5}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"JPG, PNG, GIF対応。1ファイル10MB以下。画像は自動的にリサイズ・圧縮されます。"})]}),E.length>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:E.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`施設画像 ${a+1}`,className:"w-full h-32 object-cover rounded-lg border border-gray-200"}),e.jsx("button",{type:"button",onClick:()=>(e=>{C(s=>s.filter((s,a)=>a!==e)),k(s=>s.filter((s,a)=>a!==e)),D(s=>({...s,images:s.images.filter((s,a)=>a!==e)}))})(a),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:e.jsx(t,{className:"w-4 h-4"})}),0===a&&e.jsx("div",{className:"absolute bottom-1 left-1 bg-blue-500 text-white text-xs px-2 py-1 rounded",children:"メイン"})]},a))})]})}),e.jsx(c,{className:"mb-6",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(a,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"font-medium text-green-800",children:"無料掲載期間実施中！"})]}),e.jsxs("p",{className:"text-green-700 mb-2",children:["現在、すべてのペット関連施設が",e.jsx("strong",{className:"text-lg",children:"無料"}),"で掲載できます。"]}),e.jsxs("ul",{className:"text-sm text-green-600 space-y-1",children:[e.jsx("li",{children:"• 本人確認手続きは不要です"}),e.jsx("li",{children:"• 月額料金は発生しません"}),e.jsx("li",{children:"• 申請後、管理者の承認を経て掲載開始となります"}),e.jsx("li",{children:"• 将来的に有料化する場合は事前にお知らせいたします"})]})]})})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(o,{type:"submit",disabled:f,children:f?"申請中...":"申請を送信する"})})]})]}):null}export{g as default};
