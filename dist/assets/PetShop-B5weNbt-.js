import{j as e,B as g,u as K,b as W,s as d,C as I}from"./index-fyCrE4_U.js";import{r as a,L}from"./react-vendor-Co5xHYdE.js";import{I as X}from"./Input-B2nqC8Ef.js";import{u as Y}from"./useStripe-BHXFZ89o.js";import{p as Z}from"./stripe-config-03sBkt-B.js";import{u as o,p as q,S as O,ar as ee,as as se,_ as D,m as te,G as re,n as U,at as ae,au as le}from"./ui-vendor-C9ptRAmi.js";import"./supabase-vendor-FDBaXLCh.js";function ie({hasSubscription:n=!1,className:m="",variant:v="primary",size:i="md"}){const{createCheckoutSession:y,loading:C,error:x}=Y(),[p,f]=a.useState(!1),h=async()=>{f(!1);const j=Z.find(b=>b.mode==="subscription");if(!j){console.error("Subscription product not found");return}try{await y({priceId:j.priceId,mode:"subscription",successUrl:`${window.location.origin}/dashboard?success=true`,cancelUrl:`${window.location.origin}/dashboard?canceled=true`})}catch{f(!0)}};return n?e.jsx(L,{to:"/subscription",children:e.jsxs(g,{variant:v,size:i,className:`flex items-center ${m}`,children:[e.jsx(o,{className:`${i==="sm"?"w-3 h-3":"w-4 h-4"} mr-1`}),"サブスク管理"]})}):e.jsxs("div",{children:[e.jsxs(g,{onClick:()=>void h(),isLoading:C,variant:"primary",size:i,className:`flex items-center bg-purple-600 hover:bg-purple-700 text-white ${m}`,children:[e.jsx(o,{className:`${i==="sm"?"w-3 h-3":"w-4 h-4"} mr-1`}),"サブスクに加入"]}),p&&x&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:x})]})}function ue(){const{user:n}=K(),[m,v]=a.useState([]),[i,y]=a.useState([]),[C,x]=a.useState(!0),[p,f]=a.useState(""),[h,j]=a.useState("all"),[b,z]=a.useState("name"),{isActive:u}=W(),w=a.useDeferredValue(p),S=a.useDeferredValue(h),P=a.useDeferredValue(b),T=[{value:"all",label:"すべて",icon:q},{value:"food",label:"ドッグフード",icon:D},{value:"treats",label:"おやつ",icon:te},{value:"toys",label:"おもちゃ",icon:re},{value:"accessories",label:"アクセサリー",icon:o},{value:"health",label:"ヘルスケア",icon:U},{value:"sheets",label:"ペットシーツ",icon:D}];a.useEffect(()=>{N()},[n]);const N=async()=>{x(!0);try{await Promise.all([M(),n?V():Promise.resolve()])}catch(s){console.error("データ取得エラー:",s)}finally{x(!1)}},M=async()=>{const{data:s,error:t}=await d.from("products").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(t)throw t;v(s||[])},V=async()=>{const{data:s,error:t}=await d.from("cart_items").select("*, product:products(*)").eq("user_id",n.id);if(t)throw t;y(s||[])},G=async(s,t=1)=>{if(n)try{const r=i.find(l=>l.product_id===s);if(r){const{error:l}=await d.from("cart_items").update({quantity:r.quantity+t}).eq("id",r.id);if(l)throw l}else{const{error:l}=await d.from("cart_items").insert([{user_id:n.id,product_id:s,quantity:t}]);if(l)throw l}await N()}catch(r){console.error("Error adding to cart:",r)}},E=async(s,t)=>{if(t<=0)try{const{error:r}=await d.from("cart_items").delete().eq("id",s);if(r)throw r;await N()}catch(r){console.error("Error removing from cart:",r)}else try{const{error:r}=await d.from("cart_items").update({quantity:t}).eq("id",s);if(r)throw r;await N()}catch(r){console.error("Error updating cart:",r)}},J=s=>{const t=i.find(r=>r.product_id===s);return t?t.quantity:0},_=s=>u?Math.round(s*.9):s,F=a.useMemo(()=>m.filter(t=>{const r=t.name.toLowerCase().includes(w.toLowerCase())||t.description.toLowerCase().includes(w.toLowerCase())||t.brand&&t.brand.toLowerCase().includes(w.toLowerCase()),l=S==="all"||t.category===S;return r&&l}).sort((t,r)=>{switch(P){case"name":return t.name.localeCompare(r.name);case"price":return _(t.price)-_(r.price);case"category":return t.category.localeCompare(r.category);default:return new Date(r.created_at).getTime()-new Date(t.created_at).getTime()}}),[m,w,S,P]),Q=s=>{if(!s)return"";try{const t=JSON.parse(s);if(Array.isArray(t)&&t.length>0)return t[0]}catch{}return s},$=s=>{if(!s)return[];try{const t=JSON.parse(s);if(Array.isArray(t))return t}catch{}return[s]},H=s=>{f(s),a.startTransition(()=>{})},A=s=>{a.startTransition(()=>{j(s)})},R=s=>{a.startTransition(()=>{z(s)})};return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(q,{className:"w-8 h-8 text-green-600 mr-3"}),"ペットショップ"]}),e.jsx("p",{className:"text-gray-600",children:"愛犬のための厳選商品をお届け"})]}),e.jsx(L,{to:"/cart",children:e.jsxs(g,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"カート (",i.reduce((s,t)=>s+t.quantity,0),")"]})})]}),e.jsx("div",{className:"relative overflow-hidden",children:u?e.jsxs("div",{className:"bg-gradient-to-r from-purple-600 via-pink-600 to-purple-700 text-white p-8 rounded-xl shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-white/20 p-3 rounded-full",children:e.jsx(o,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[e.jsx(ee,{className:"w-6 h-6 mr-2"}),"サブスクリプション会員特典適用中！"]}),e.jsx("p",{className:"text-lg opacity-90",children:"全商品10%OFF + 送料無料でお買い物をお楽しみください"})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"bg-white/20 px-6 py-3 rounded-lg",children:[e.jsx("p",{className:"text-sm opacity-80",children:"今月の節約額"}),e.jsx("p",{className:"text-2xl font-bold",children:"¥1,200+"})]})})]}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"})]}):e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white p-8 rounded-xl shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-white/20 p-3 rounded-full",children:e.jsx(se,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[e.jsx(o,{className:"w-6 h-6 mr-2"}),"サブスク会員は全品10％OFF & 送料無料！"]}),e.jsx("p",{className:"text-lg opacity-90",children:"月額3,800円でどこでも使い放題 + ドッグラン使い放題"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(ie,{hasSubscription:u,className:"bg-white text-purple-600 hover:bg-gray-100 font-bold px-6 py-3 text-lg"}),e.jsx("p",{className:"text-sm opacity-80 mt-2",children:"初月無料キャンペーン中"})]})]}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(X,{label:"",value:p,onChange:s=>H(s.target.value),placeholder:"商品名、ブランド名で検索..."})}),e.jsx("div",{children:e.jsx("select",{value:h,onChange:s=>A(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:T.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})}),e.jsx("div",{children:e.jsxs("select",{value:b,onChange:s=>R(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"popular",children:"人気順"}),e.jsx("option",{value:"name",children:"名前順"}),e.jsx("option",{value:"price",children:"価格の安い順"}),e.jsx("option",{value:"category",children:"カテゴリー順"})]})})]}),e.jsx("div",{className:"flex space-x-2 overflow-x-auto pb-2",children:T.map(s=>{const t=s.icon;return e.jsxs("button",{onClick:()=>A(s.value),className:`flex items-center space-x-2 px-4 py-2 rounded-lg whitespace-nowrap transition-colors ${h===s.value?"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(t,{className:"w-4 h-4"}),e.jsx("span",{children:s.label})]},s.value)})}),F.length===0?e.jsxs(I,{className:"text-center py-12",children:[e.jsx(q,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"該当する商品が見つかりませんでした"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:F.map(s=>{const t=J(s.id),r=s.price,l=_(r),B=u&&l<r;return e.jsxs(I,{className:"overflow-hidden hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"relative h-48 mb-4 -m-6 mb-4",children:[e.jsx("img",{src:Q(s.image_url),alt:s.name,className:"w-full h-full object-cover",onError:c=>{c.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),$(s.image_url).length>1&&e.jsxs("div",{className:"absolute top-3 right-3 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded",children:["📸 ",$(s.image_url).length,"枚"]}),B&&e.jsx("div",{className:"absolute top-3 left-3",children:e.jsxs("span",{className:"bg-purple-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(o,{className:"w-3 h-3 mr-1"}),"10%OFF"]})}),s.stock_quantity<=5&&e.jsx("div",{className:"absolute top-3 right-3",children:e.jsxs("span",{className:"bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium",children:["残り",s.stock_quantity,"個"]})})]}),e.jsxs("div",{className:"px-6 pb-6",children:[e.jsxs("div",{className:"mb-2",children:[s.brand&&e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:s.brand}),e.jsx("h3",{className:"text-lg font-semibold line-clamp-2",children:s.name})]}),e.jsx("p",{className:"text-gray-600 text-sm mb-3 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-500 mb-3",children:[s.weight&&e.jsxs("p",{children:["内容量: ",s.weight,"g"]}),s.size&&e.jsxs("p",{children:["サイズ: ",s.size]}),s.age_group&&s.age_group!=="all"&&e.jsxs("p",{children:["対象年齢: ",s.age_group==="puppy"?"子犬":s.age_group==="adult"?"成犬":"シニア犬"]}),s.dog_size&&s.dog_size!=="all"&&e.jsxs("p",{children:["対象サイズ: ",s.dog_size==="small"?"小型犬":s.dog_size==="medium"?"中型犬":"大型犬"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-xl font-bold text-green-600",children:["¥",l.toLocaleString()]}),B&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",r.toLocaleString()]})]}),u&&e.jsxs("p",{className:"text-xs text-purple-600 flex items-center",children:[e.jsx(o,{className:"w-3 h-3 mr-1"}),"サブスク会員価格"]})]}),e.jsxs("div",{className:"space-y-2",children:[t>0?e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-2",children:[e.jsx("button",{onClick:()=>{const c=i.find(k=>k.product_id===s.id);c&&E(c.id,t-1)},className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(ae,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium",children:t}),e.jsx("button",{onClick:()=>{const c=i.find(k=>k.product_id===s.id);c&&E(c.id,t+1)},className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(U,{className:"w-4 h-4"})})]}):e.jsx(g,{onClick:()=>G(s.id),className:"w-full bg-green-600 hover:bg-green-700",disabled:s.stock_quantity===0,children:s.stock_quantity===0?"在庫切れ":e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"カートに追加"]})}),e.jsx(L,{to:`/shop/product/${s.id}`,children:e.jsx(g,{variant:"secondary",className:"w-full",children:"詳細を見る"})})]})]})]},s.id)})}),e.jsx(I,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(le,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"})]})]})]})})]})}export{ue as PetShop};
