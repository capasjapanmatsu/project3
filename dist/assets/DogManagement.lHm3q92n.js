const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug.CBj0MSJP.js","assets/index.oOj2R_C7.js","assets/vendor.D1SiiUJb.js","assets/router.icJHpBzt.js","assets/supabase.CZ8ekJUM.js","assets/ui.UnEvinBv.js","assets/index.D_WX42ys.css","assets/directVaccineUpload.D5Zutvrd.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,r=Object.defineProperties,t=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(r,t,i)=>t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[t]=i,n=(e,r,t)=>new Promise(((i,o)=>{var s=e=>{try{n(t.next(e))}catch(r){o(r)}},a=e=>{try{n(t.throw(e))}catch(r){o(r)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,a);n((t=t.apply(e,r)).next())}));import{_ as l}from"./supabase.CZ8ekJUM.js";import{u as d,c,s as u,l as m,j as g,B as p,C as f}from"./index.oOj2R_C7.js";import{r as h,L as y}from"./router.icJHpBzt.js";import{D as b,a as v}from"./DogCard.BHDpAsxT.js";import{Y as x,p as j,P as _}from"./ui.UnEvinBv.js";import"./vendor.D1SiiUJb.js";import"./Input.DeZ8m3vP.js";import"./Select.Ccsc19kJ.js";import"./dogBreeds.6lxY8Uni.js";import"./VaccineBadge.DkGxiQDo.js";function w(){const{user:e}=d(),[w,E]=h.useState([]),[S,D]=h.useState(!0),[$,N]=h.useState(""),[I,C]=h.useState(!1),[P,O]=h.useState(null),[R,U]=h.useState(!1),[V,A]=h.useState(""),[L,T]=h.useState(""),[B,F]=h.useState(!1),[q,W]=h.useState({name:"",breed:"",gender:"",birthDate:""}),[z,k]=h.useState(null),[M,Y]=h.useState(null),[G,H]=h.useState(null),[J,K]=h.useState(null),[Q,X]=h.useState(""),[Z,ee]=h.useState("");h.useEffect((()=>{e&&re()}),[e]);const re=()=>n(null,null,(function*(){try{D(!0),N("");const r=yield c((()=>u.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",null==e?void 0:e.id).order("created_at",{ascending:!1})));if(r.error)return m("error","Error fetching dogs",{error:r.error,userId:null==e?void 0:e.id}),void N("ワンちゃんの情報を取得できませんでした。");E(r.data||[])}catch(r){m("error","Exception in fetchDogs",{error:r,userId:null==e?void 0:e.id}),N("ワンちゃんの情報を取得できませんでした。")}finally{D(!1)}})),te=e=>{var r;O(e),W({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date}),Y(e.image_url||null);const t=null==(r=e.vaccine_certifications)?void 0:r[0];t&&(X(t.rabies_expiry_date||""),ee(t.combo_expiry_date||"")),C(!0)};return S?g.jsxs("div",{className:"flex justify-center items-center h-64",children:[g.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),g.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):g.jsxs("div",{className:"space-y-6",children:[g.jsxs("div",{className:"flex justify-between items-center",children:[g.jsxs("div",{children:[g.jsxs(y,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[g.jsx(x,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),g.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),g.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),g.jsx(y,{to:"/register-dog",children:g.jsxs(p,{children:[g.jsx(j,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),$&&g.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:$}),L&&g.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:L}),g.jsxs(f,{children:[g.jsx("div",{className:"flex justify-between items-center mb-4",children:g.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[g.jsx(_,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",w.length,"匹)"]})}),0===w.length?g.jsxs("div",{className:"text-center py-12",children:[g.jsx(_,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),g.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),g.jsx(y,{to:"/register-dog",children:g.jsxs(p,{children:[g.jsx(j,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):g.jsx("div",{className:"space-y-4",children:w.map((e=>g.jsx(b,{dog:e,onEdit:te},e.id)))})]}),I&&P&&g.jsx(v,{dog:P,isUpdating:R||B,error:V,success:L,dogFormData:q,dogImagePreview:M,onClose:()=>C(!1),onSubmit:e=>n(null,null,(function*(){if(e.preventDefault(),P){U(!0),A(""),T("");try{const e={name:q.name,breed:q.breed,gender:q.gender,birth_date:q.birthDate};if(z){if(!z.type||!z.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${z.type}`);const r=`${P.id}/dog-photo.jpg`,t=`${""}/storage/v1/object/dog-images/${r}`,{data:{session:i}}=yield u.auth.getSession();if(!(null==i?void 0:i.access_token))throw new Error("認証されていません。ログインしてください。");const o=yield fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":z.type,"Cache-Control":"3600"},body:z});if(!o.ok){const e=yield o.text();throw m("error","❌ Direct upload failed",{error:e}),new Error(`直接アップロードに失敗しました: ${o.status} ${e}`)}yield o.json();const{data:{publicUrl:s}}=u.storage.from("dog-images").getPublicUrl(r);e.image_url=s}const{error:r}=yield u.from("dogs").update(e).eq("id",P.id);if(r)throw r;if(G&&J&&Q&&Z){const e=G.name.split(".").pop()||"jpg",r=J.name.split(".").pop()||"jpg",t=Date.now(),i=`temp/${P.id}/rabies_${t}.${e}`,o=`temp/${P.id}/combo_${t}.${r}`,{debugAuthStatus:s}=yield l((()=>n(null,null,(function*(){const{debugAuthStatus:e}=yield import("./authDebug.CBj0MSJP.js");return{debugAuthStatus:e}}))),__vite__mapDeps([0,1,2,3,4,5,6]));yield s();const{directVaccineUpload:a}=yield l((()=>n(null,null,(function*(){const{directVaccineUpload:e}=yield import("./directVaccineUpload.D5Zutvrd.js");return{directVaccineUpload:e}}))),__vite__mapDeps([7,1,2,3,4,5,6])),[d,c]=yield Promise.all([a(i,G),a(o,J)]);if(!d.success||!c.success){m("error","🚨 === VACCINE UPLOAD ERROR DETAILS ==="),d.success||m("error","❌ Rabies upload error",{error:d.error}),c.success||m("error","❌ Combo upload error",{error:c.error});const e=d.error||c.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${e}`)}const g=d.url,p=c.url,{error:f}=yield u.from("vaccine_certifications").upsert([{dog_id:P.id,rabies_vaccine_image:g,combo_vaccine_image:p,rabies_expiry_date:Q,combo_expiry_date:Z,status:"pending"}],{onConflict:"dog_id"});if(f)throw m("error","❌ Database save error",{error:f}),f.message&&f.message.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${f.message}`)}T("ワンちゃん情報を更新しました"),yield re(),setTimeout((()=>{C(!1),T(""),k(null),Y(null),H(null),K(null),X(""),ee("")}),2e3)}catch(r){m("error","Error updating dog",{error:r,dogId:null==P?void 0:P.id});let e="ワンちゃん情報の更新に失敗しました";r instanceof Error&&(e=r.message.includes("520")||r.message.includes("Cloudflare")?"ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":r.message.includes("アップロードに失敗しました")?r.message:`エラーが発生しました: ${r.message}`),A(e)}finally{U(!1)}}})),onDelete:e=>n(null,null,(function*(){var r;F(!0),A("");try{const{error:i}=yield u.from("vaccine_certifications").delete().eq("dog_id",e.id);if(i&&m("warn","Error deleting vaccine certifications",{error:i,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],i=`${e.id}/${t}`,{error:o}=yield u.storage.from("dog-images").remove([i])}catch(t){}const o=null==(r=e.vaccine_certifications)?void 0:r[0];if(o){const e=[];if(o.rabies_vaccine_image&&e.push(o.rabies_vaccine_image),o.combo_vaccine_image&&e.push(o.combo_vaccine_image),e.length>0){const{error:r}=yield u.storage.from("vaccine-certs").remove(e)}}const{error:s}=yield u.from("dogs").delete().eq("id",e.id);if(s)throw m("error","Error deleting dog",{error:s,dogId:e.id}),s;yield re(),C(!1),T(`${e.name}の情報を削除しました。`),setTimeout((()=>{T("")}),3e3)}catch(i){m("error","Error deleting dog",{error:i,dogId:null==e?void 0:e.id});const r=i.message||"ワンちゃんの削除に失敗しました";A(r)}finally{F(!1)}})),onFormChange:W,onImageSelect:e=>n(null,null,(function*(){var r;const t=null==(r=e.target.files)?void 0:r[0];if(t)try{if(!(t instanceof File))return void A("有効なファイルを選択してください。");if(t.size>10485760)return void A("画像ファイルは10MB以下にしてください。");if(!t.type||!t.type.startsWith("image/"))return void A(`画像ファイルを選択してください。選択されたファイルタイプ: ${t.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return void A(`サポートされていない画像形式です: ${t.type}`);k(t);const e=new FileReader;e.onload=e=>{var r;Y(null==(r=e.target)?void 0:r.result)},e.readAsDataURL(t)}catch(i){A("画像の処理に失敗しました。")}})),onImageRemove:()=>n(null,null,(function*(){var e;if(P&&P.image_url)try{U(!0),A("");try{const e=new URL(P.image_url).pathname.split("/"),r=e[e.length-1],t=`${P.id}/${r}`,{error:i}=yield u.storage.from("dog-images").remove([t])}catch(n){m("warn","Warning: Error processing image deletion",{error:n})}const l=yield c((()=>u.from("dogs").update({image_url:null}).eq("id",P.id)));if(l.error)return m("error","Error updating dog image_url",{error:l.error,dogId:P.id}),void A("画像の削除に失敗しました。");k(null),Y(null),O((e=((e,r)=>{for(var t in r||(r={}))o.call(r,t)&&a(e,t,r[t]);if(i)for(var t of i(r))s.call(r,t)&&a(e,t,r[t]);return e})({},P),r(e,t({image_url:void 0})))),yield re(),m("info","✅ Dog image removed successfully",{dogId:P.id}),T("画像を削除しました。"),setTimeout((()=>{T("")}),3e3)}catch(l){m("error","Error removing dog image",{error:l,dogId:null==P?void 0:P.id}),A("画像の削除に失敗しました。")}finally{U(!1)}})),rabiesVaccineFile:G,comboVaccineFile:J,rabiesExpiryDate:Q,comboExpiryDate:Z,onRabiesVaccineSelect:e=>n(null,null,(function*(){var r;const t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>10485760)return void A("ワクチン証明書ファイルは10MB以下にしてください。");if(!t.type.startsWith("image/"))return void A("画像ファイルを選択してください。");H(t)}else H(null)})),onComboVaccineSelect:e=>n(null,null,(function*(){var r;const t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>10485760)return void A("ワクチン証明書ファイルは10MB以下にしてください。");if(!t.type.startsWith("image/"))return void A("画像ファイルを選択してください。");K(t)}else K(null)})),onRabiesExpiryDateChange:X,onComboExpiryDateChange:ee})]})}export{w as DogManagement};
