import{s as e,j as s,C as a,B as t}from"./index-uQwv9uAE.js";import{i,r,L as n}from"./vendor-BHVjIt_u.js";import{I as c,A as l,s as d,au as x,i as m,ag as o,a as h,C as j,o as g,X as p}from"./ui-BLTQwnYp.js";import"./supabase-CKbzEL5D.js";function N(){const[N]=i(),[f,v]=r.useState({pendingVaccines:0,pendingParks:0,unreadMessages:0,pendingUsers:0}),[u,b]=r.useState([]),[w,y]=r.useState([]),[_,k]=r.useState(!0),[S,P]=r.useState(""),[C,D]=r.useState(""),[$,M]=r.useState("overview"),[V,z]=r.useState(!1);r.useEffect((()=>{const e=N.get("tab");e&&["overview","vaccines","parks","messages"].includes(e)&&M(e),L()}),[N]);const L=async()=>{try{k(!0);const{data:s,error:a}=await e.from("vaccine_certifications").select("\n          *,\n          dog:dogs(\n            *,\n            owner:profiles(*)\n          )\n        ").eq("status","pending").order("created_at",{ascending:!0});if(a)throw a;const{data:t,error:i}=await e.from("dog_parks").select("*").in("status",["pending","second_stage_review"]).order("created_at",{ascending:!0});if(i)throw i;b(s||[]),y(t||[]),v({pendingVaccines:s?.length||0,pendingParks:t?.length||0,unreadMessages:0,pendingUsers:0})}catch(s){P("タスクデータの取得に失敗しました")}finally{k(!1)}},q=async(s,a)=>{z(!0),P(""),D("");try{const t=u.find((e=>e.id===s));if(!t)throw new Error("ワクチン証明書が見つかりません");const{error:i}=await e.from("vaccine_certifications").update({status:a?"approved":"rejected",reviewed_at:(new Date).toISOString()}).eq("id",s);if(i)throw i;const{error:r}=await e.from("notifications").insert([{user_id:t.dog.owner.id,type:"vaccine_review",title:a?"ワクチン証明書が承認されました":"ワクチン証明書について",message:a?`${t.dog.name}のワクチン証明書が承認されました。ドッグランのご利用が可能になりました。`:`${t.dog.name}のワクチン証明書の確認が必要です。マイページから再度アップロードしてください。`,data:{vaccine_id:s,dog_id:t.dog_id}}]);if(r)throw r;D(`ワクチン証明書を${a?"承認":"却下"}しました`),await L()}catch(t){P("ワクチン証明書の処理に失敗しました")}finally{z(!1)}},J=async(s,a)=>{z(!0),P(""),D("");try{const t=w.find((e=>e.id===s));if(!t)throw new Error("ドッグランが見つかりません");let i="";i=a?"pending"===t.status?"first_stage_passed":"qr_testing":"rejected";const{error:r}=await e.from("dog_parks").update({status:i,reviewed_at:(new Date).toISOString()}).eq("id",s);if(r)throw r;const{error:n}=await e.from("notifications").insert([{user_id:t.owner_id,type:"park_review",title:a?"審査結果のお知らせ":"審査結果について",message:a?`${t.name}の審査が通過しました。${"pending"===t.status?"詳細情報の入力にお進みください。":"QRコード実証検査の準備に入ります。"}`:`${t.name}の審査が不通過となりました。詳細はダッシュボードをご確認ください。`,data:{park_id:s}}]);if(n)throw n;D(`ドッグランを${a?"承認":"却下"}しました`),await L()}catch(t){P("ドッグランの処理に失敗しました")}finally{z(!1)}},E=()=>f.pendingVaccines+f.pendingParks+f.unreadMessages+f.pendingUsers;return _?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs(n,{to:"/admin",className:"flex items-center text-blue-600 hover:text-blue-800",children:[s.jsx(c,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[s.jsx(l,{className:"w-8 h-8 text-red-600 mr-3"}),"緊急対応タスク"]}),s.jsx("p",{className:"text-gray-600",children:"承認待ちの項目を確認・処理してください"})]}),s.jsxs("div",{className:"text-sm text-gray-500",children:["合計タスク数: ",E(),"件"]})]}),S&&s.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[s.jsx(l,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{children:S})]}),C&&s.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 flex items-start",children:[s.jsx(d,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{children:C})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[s.jsx(a,{className:"p-6 cursor-pointer transition-all "+("vaccines"===$?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>M("vaccines"),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"ワクチン証明書"}),s.jsx("p",{className:"text-2xl font-bold text-red-600",children:f.pendingVaccines}),s.jsx("p",{className:"text-xs text-gray-500",children:"承認待ち"})]}),s.jsx(x,{className:"w-8 h-8 text-red-600"})]})}),s.jsx(a,{className:"p-6 cursor-pointer transition-all "+("parks"===$?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>M("parks"),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"ドッグラン審査"}),s.jsx("p",{className:"text-2xl font-bold text-orange-600",children:f.pendingParks}),s.jsx("p",{className:"text-xs text-gray-500",children:"審査待ち"})]}),s.jsx(m,{className:"w-8 h-8 text-orange-600"})]})}),s.jsx(a,{className:"p-6 cursor-pointer transition-all "+("messages"===$?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>M("messages"),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"お問い合わせ"}),s.jsx("p",{className:"text-2xl font-bold text-purple-600",children:f.unreadMessages}),s.jsx("p",{className:"text-xs text-gray-500",children:"未読"})]}),s.jsx(o,{className:"w-8 h-8 text-purple-600"})]})}),s.jsx(a,{className:"p-6 cursor-pointer transition-all "+("overview"===$?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>M("overview"),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"全体概要"}),s.jsx("p",{className:"text-2xl font-bold text-blue-600",children:E()}),s.jsx("p",{className:"text-xs text-gray-500",children:"総タスク数"})]}),s.jsx(h,{className:"w-8 h-8 text-blue-600"})]})})]}),"overview"===$&&s.jsx("div",{className:"space-y-6",children:s.jsxs(a,{className:"p-6",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"タスク概要"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-3",children:"優先度の高いタスク"}),s.jsxs("div",{className:"space-y-2",children:[f.pendingVaccines>0&&s.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(x,{className:"w-4 h-4 text-red-600"}),s.jsx("span",{className:"text-sm",children:"ワクチン証明書承認"})]}),s.jsxs("span",{className:"text-sm font-medium text-red-600",children:[f.pendingVaccines,"件"]})]}),f.pendingParks>0&&s.jsxs("div",{className:"flex items-center justify-between p-3 bg-orange-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(m,{className:"w-4 h-4 text-orange-600"}),s.jsx("span",{className:"text-sm",children:"ドッグラン審査"})]}),s.jsxs("span",{className:"text-sm font-medium text-orange-600",children:[f.pendingParks,"件"]})]}),f.unreadMessages>0&&s.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(o,{className:"w-4 h-4 text-purple-600"}),s.jsx("span",{className:"text-sm",children:"お問い合わせ対応"})]}),s.jsxs("span",{className:"text-sm font-medium text-purple-600",children:[f.unreadMessages,"件"]})]}),0===E()&&s.jsxs("div",{className:"text-center py-8",children:[s.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"すべてのタスクが完了しています"})]})]})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-3",children:"処理時間の目安"}),s.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{children:"ワクチン証明書: 2-3分/件"})]}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{children:"ドッグラン審査: 5-10分/件"})]}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{children:"お問い合わせ: 3-5分/件"})]})]})]})]})]})}),"vaccines"===$&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"ワクチン証明書承認待ち"}),s.jsxs("div",{className:"text-sm text-gray-500",children:[f.pendingVaccines,"件の承認待ち"]})]}),0===u.length?s.jsxs(a,{className:"text-center py-12",children:[s.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"承認待ちのワクチン証明書はありません"})]}):s.jsx("div",{className:"space-y-4",children:u.map((e=>s.jsx(a,{className:"p-6",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[s.jsx("h3",{className:"font-semibold",children:e.dog.name}),s.jsxs("span",{className:"text-sm text-gray-500",children:["飼い主: ",e.dog.owner.name]}),s.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full",children:"承認待ち"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsxs("p",{className:"text-gray-600",children:["犬種: ",e.dog.breed]}),s.jsxs("p",{className:"text-gray-600",children:["性別: ",e.dog.gender]}),s.jsxs("p",{className:"text-gray-600",children:["申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]})]}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-gray-600",children:["狂犬病ワクチン期限: ",e.rabies_expiry_date?new Date(e.rabies_expiry_date).toLocaleDateString("ja-JP"):"未設定"]}),s.jsxs("p",{className:"text-gray-600",children:["混合ワクチン期限: ",e.combo_expiry_date?new Date(e.combo_expiry_date).toLocaleDateString("ja-JP"):"未設定"]})]})]})]}),s.jsxs("div",{className:"flex space-x-2 ml-4",children:[s.jsx(n,{to:`/admin/management?tab=vaccines&vaccine=${e.id}`,children:s.jsxs(t,{size:"sm",variant:"secondary",children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"詳細"]})}),s.jsxs(t,{size:"sm",onClick:()=>q(e.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:V,children:[s.jsx(d,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsxs(t,{size:"sm",onClick:()=>q(e.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:V,children:[s.jsx(p,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]}),"parks"===$&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"ドッグラン審査待ち"}),s.jsxs("div",{className:"text-sm text-gray-500",children:[f.pendingParks,"件の審査待ち"]})]}),0===w.length?s.jsxs(a,{className:"text-center py-12",children:[s.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"審査待ちのドッグランはありません"})]}):s.jsx("div",{className:"space-y-4",children:w.map((e=>s.jsx(a,{className:"p-6",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[s.jsx("h3",{className:"font-semibold",children:e.name}),s.jsx("span",{className:"text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full",children:"pending"===e.status?"第一審査待ち":"第二審査待ち"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsxs("p",{className:"text-gray-600",children:["住所: ",e.address]}),s.jsxs("p",{className:"text-gray-600",children:["料金: ¥",e.price,"/時間"]})]}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-gray-600",children:["申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]}),s.jsxs("p",{className:"text-gray-600",children:["審査段階: ","pending"===e.status?"第一審査":"第二審査"]})]})]})]}),s.jsxs("div",{className:"flex space-x-2 ml-4",children:[s.jsx(n,{to:`/admin/management?tab=parks&park=${e.id}`,children:s.jsxs(t,{size:"sm",variant:"secondary",children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"詳細"]})}),s.jsxs(t,{size:"sm",onClick:()=>J(e.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:V,children:[s.jsx(d,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsxs(t,{size:"sm",onClick:()=>J(e.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:V,children:[s.jsx(p,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]}),"messages"===$&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"お問い合わせ対応"}),s.jsxs("div",{className:"text-sm text-gray-500",children:[f.unreadMessages,"件の未読"]})]}),s.jsxs(a,{className:"text-center py-12",children:[s.jsx(o,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"お問い合わせ機能は準備中です"}),s.jsx("p",{className:"text-sm text-gray-500",children:"現在はメールでのお問い合わせ対応となります"})]})]})]})}export{N as AdminTasks};
