import{j as e,C as g,B as ee,u as le,b as ne,s as K}from"./index-B2nIfDq6.js";import{h as ie,d as ce,r as m}from"./react-vendor-ClX3xUyT.js";import{I as de}from"./Input-_c6WZwIR.js";import{V as oe,g as me}from"./VaccineBadge-DlRPUcF1.js";import{M as xe,ag as L,I as pe,i as he,P as se,u as B,t as R,A as ue,Y as z,K as je,X as ge}from"./ui-vendor-Bbvw08tP.js";import{u as be}from"./useStripe-2eFyLpB5.js";import{p as D}from"./stripe-config-03sBkt-B.js";import"./supabase-vendor-CRpuwX9I.js";function ye({park:p,error:y,formData:a,setFormData:c,timeSlots:_,isDateTooSoon:F,selectedDogs:d,dogs:u,handleDogSelection:q,handleTimeSlotSelect:o,getEndTime:P,getSlotStatus:U,getSelectedDogNames:i,calculateDayPassPrice:O,calculateTotalPrice:I,hasSubscription:h,handleSubmit:Y,isLoading:W,checkoutLoading:f,MAX_DOGS:$}){return e.jsxs(g,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(xe,{className:"w-5 h-5 text-gray-500"}),e.jsx("p",{className:"text-gray-600",children:p.address})]}),e.jsx("p",{className:"text-gray-600 mb-4",children:p.description}),e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(L,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"font-semibold text-blue-900",children:"料金体系"})]}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 1日券: ¥800（24時間有効）"}),e.jsx("p",{children:"• 2頭目以降: +¥400/頭（半額）"}),e.jsx("p",{children:"• サブスク: 月額¥3,800（3頭まで使い放題）"}),e.jsx("p",{children:"• 施設貸し切り: ¥4,400/時間（サブスク会員20%OFF）"})]})]}),e.jsxs("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(pe,{className:"w-5 h-5 text-yellow-600"}),e.jsx("h3",{className:"font-semibold text-yellow-900",children:"施設貸し切りの注意事項"})]}),e.jsxs("div",{className:"text-sm text-yellow-800 space-y-1",children:[e.jsx("p",{children:"• 施設貸し切りは1時間単位で予約可能です"}),e.jsxs("p",{children:["• ",e.jsx("strong",{children:"2日前までの予約が必要です"}),"（当日・翌日の予約不可）"]}),e.jsx("p",{children:"• 貸し切り中は他のお客様は入場できません"}),e.jsx("p",{children:"• 友達にPINコードを共有して一緒に利用できます"})]})]})]}),e.jsxs("form",{onSubmit:Y,children:[y&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:y}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",$,"頭）"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[d.length,"/",$,"頭選択中"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:u.map(s=>{const j=d.includes(s.id),w=!j&&d.length>=$;return e.jsxs("div",{className:`p-4 border-2 rounded-lg cursor-pointer transition-colors relative ${j?"border-green-500 bg-green-50":w?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"}`,onClick:()=>!w&&q(s.id),children:[j&&e.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:e.jsx(he,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(se,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold",children:[s.name,"ちゃん"]}),e.jsx(oe,{status:me(s),size:"sm"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.breed," • ",s.gender]})]})]})]},s.id)})}),d.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),e.jsx("p",{className:"text-sm text-green-800",children:i()}),e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[d.length,"頭が同時入場できます"]})]})]}),e.jsx(de,{label:"日付",type:"date",value:a.date,onChange:s=>c({date:s.target.value,selectedTimeSlot:""}),min:new Date().toISOString().split("T")[0],required:!0}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"支払い方法"}),e.jsxs("div",{className:"space-y-4",children:[!h&&e.jsxs("label",{className:`flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors ${a.paymentType==="single"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("input",{type:"radio",value:"single",checked:a.paymentType==="single",onChange:s=>c({paymentType:s.target.value}),className:"form-radio text-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium",children:"1日券（段階的料金制）"})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"1頭目¥800 + 2頭目以降¥400/頭・24時間有効"}),d.length>0&&e.jsxs("p",{className:"text-sm text-blue-600 mt-1",children:[d.length,"頭選択中: ¥",O().toLocaleString()]})]})]}),e.jsxs("label",{className:`flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors ${a.paymentType==="subscription"?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("input",{type:"radio",value:"subscription",checked:a.paymentType==="subscription",onChange:s=>c({paymentType:s.target.value}),className:"form-radio text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium",children:"サブスクリプション（月額¥3,800）"}),h?e.jsx("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs",children:"ご利用中"}):e.jsx("span",{className:"bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs",children:"未加入"})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"3頭まで使い放題・施設貸し切り20%OFF"}),!h&&e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"※ サブスクリプションに加入していません"})]})]}),e.jsxs("label",{className:`flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors ${a.paymentType==="facility_rental"?"border-orange-500 bg-orange-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("input",{type:"radio",value:"facility_rental",checked:a.paymentType==="facility_rental",onChange:s=>c({paymentType:s.target.value,duration:"1"}),className:"form-radio text-orange-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{className:"w-5 h-5 text-orange-600"}),e.jsx("span",{className:"font-medium",children:"施設貸し切り"}),e.jsxs("span",{className:"bg-orange-200 text-orange-800 px-2 py-1 rounded-full text-xs",children:["1時間¥",h?"3,520":"4,400"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"施設全体を独占利用・人数制限なし・友達にPINコード共有可能"}),h&&e.jsx("p",{className:"text-sm text-purple-700 font-medium mt-1",children:"サブスク会員20%OFF適用済み！"})]})]})]})]}),a.paymentType==="facility_rental"&&a.date&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"利用開始時間を選択してください"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-sm text-gray-700",children:"利用時間:"}),e.jsx("select",{value:a.duration,onChange:s=>c({duration:s.target.value}),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[1,2,3,4].map(s=>e.jsxs("option",{value:s.toString(),children:[s,"時間"]},s))})]})]}),F&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(ue,{className:"w-5 h-5 mt-0.5 mr-2 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"施設貸し切りは2日前までの予約が必要です"}),e.jsx("p",{className:"text-sm",children:"2日後以降の日付を選択してください。"})]})]}),e.jsx("div",{className:"grid grid-cols-3 md:grid-cols-4 gap-3",children:_.map(s=>{const j=U(s),w=j.icon,M=a.selectedTimeSlot===s.time,k=s.isWholeFacilityAvailable&&!F,T=parseInt(a.duration);let C=!0;if(k&&T>1){const V=parseInt(s.time.split(":")[0]);for(let E=1;E<T;E++){const J=V+E,H=_.find(A=>parseInt(A.time.split(":")[0])===J);if(!H||!H.isWholeFacilityAvailable){C=!1;break}}}const N=k&&C;return e.jsx("button",{type:"button",onClick:()=>{N&&o(s.time)},disabled:!N,className:`p-3 rounded-lg border-2 transition-all ${M?"border-orange-500 bg-orange-50":N?"border-gray-200 hover:border-gray-300":"border-gray-200 opacity-50 cursor-not-allowed"}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.time}),e.jsxs("div",{className:`inline-flex items-center space-x-1 px-2 py-1 rounded-full text-xs mt-1 ${N?j.color:"bg-red-500 text-white"}`,children:[e.jsx(w,{className:"w-3 h-3"}),e.jsx("span",{children:N?j.label:"利用不可"})]}),!N&&k&&!C&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["連続",T,"時間予約不可"]})]})},s.time)})}),a.selectedTimeSlot&&e.jsxs("div",{className:"text-sm mt-3 p-3 rounded-lg bg-orange-50 text-orange-800 border border-orange-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium",children:["選択時間: ",a.selectedTimeSlot," ～ ",P(a.selectedTimeSlot,a.duration)]})]}),e.jsx("p",{className:"text-xs mt-1 flex items-center",children:"施設貸し切りは1時間単位での利用となります。"})]})]})}),e.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-blue-50 text-blue-700 border border-blue-200",children:[e.jsx("p",{className:"font-medium",children:"予約内容"}),e.jsxs("div",{className:"mt-1 space-y-1",children:[e.jsxs("p",{children:["選択ワンちゃん: ",d.length,"頭"]}),a.paymentType==="single"&&e.jsxs("div",{children:[e.jsxs("p",{children:["1日券料金: ¥",O().toLocaleString(),"（",d.length,"頭・段階的料金）"]}),e.jsx("p",{className:"text-xs",children:"24時間有効・全国のドッグランで利用可能"})]}),a.paymentType==="subscription"&&e.jsx("div",{children:h?e.jsxs("div",{children:[e.jsx("p",{className:"text-purple-700 font-medium",children:"サブスク会員: 3頭まで使い放題"}),e.jsx("p",{className:"text-xs",children:"追加料金なし・全国のドッグランで利用可能"})]}):e.jsxs("div",{children:[e.jsx("p",{className:"text-orange-700 font-medium",children:"サブスクリプション申し込み: 月額¥3,800"}),e.jsx("p",{className:"text-xs",children:"申し込み後、3頭まで使い放題・全国のドッグランで利用可能"})]})}),a.paymentType==="facility_rental"&&e.jsxs("div",{children:[e.jsxs("p",{children:["施設貸し切り料金: ¥",I().toLocaleString()]}),e.jsxs("p",{className:"text-xs",children:[a.duration,"時間利用・施設全体独占・友達にPINコード共有可能"]}),h&&e.jsx("p",{className:"text-purple-700 font-medium text-xs",children:"サブスク会員20%OFF適用済み"})]}),e.jsx("div",{className:"border-t border-blue-300 pt-2 mt-2",children:e.jsxs("p",{className:"font-bold",children:["合計料金: ¥",I().toLocaleString()]})})]}),e.jsxs("p",{className:"text-sm mt-2 flex items-center",children:[e.jsx(z,{className:"w-3 h-3 mr-1"}),"決済完了後、入場用PINコードが発行されます"]})]}),e.jsxs(ee,{type:"submit",isLoading:W||f,className:"w-full mt-4 bg-blue-600 hover:bg-blue-700",disabled:d.length===0||a.paymentType==="facility_rental"&&(!a.selectedTimeSlot||F),children:[a.paymentType==="subscription"&&!h?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"サブスクリプションに加入する"]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),h&&a.paymentType==="subscription"?"PINコードを発行する":"決済に進む"]}),d.length>0&&e.jsxs("span",{className:"ml-2 bg-blue-500 text-white px-2 py-1 rounded-full text-sm",children:[d.length,"頭・¥",I().toLocaleString()]})]})]})]})}function fe({hasSubscription:p}){return e.jsxs("div",{className:"space-y-6",children:[p?e.jsxs(g,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(B,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsx("p",{children:"• 3頭まで使い放題"}),e.jsx("p",{children:"• 施設貸し切り20%OFF"}),e.jsx("p",{children:"• ペットショップ10%OFF"})]})]}):e.jsxs(g,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(B,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスクリプションがお得！"})]}),e.jsxs("div",{className:"text-sm space-y-1 mb-3",children:[e.jsx("p",{children:"• 月額¥3,800で3頭まで使い放題"}),e.jsx("p",{children:"• 施設貸し切り20%OFF"}),e.jsx("p",{children:"• ペットショップ10%OFF"}),e.jsx("p",{children:"• 全国のドッグランで利用可能"})]}),e.jsx("p",{className:"text-xs",children:"サブスクリプションを選択して決済ページで申し込みできます"})]}),e.jsxs(g,{className:"p-4 bg-blue-50 border-blue-200",children:[e.jsxs("h3",{className:"font-semibold text-blue-900 mb-2 flex items-center",children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"料金体系"]}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-800",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"1日券（段階的料金制）"}),e.jsxs("div",{className:"ml-2 space-y-1",children:[e.jsx("p",{children:"• 1頭目: ¥800"}),e.jsx("p",{children:"• 2頭目: +¥400"}),e.jsx("p",{children:"• 3頭目: +¥400"}),e.jsx("p",{className:"font-medium",children:"3頭合計: ¥1,600"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"サブスク: 月額¥3,800"}),e.jsx("p",{className:"ml-2",children:"3頭まで使い放題"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(R,{className:"w-3 h-3 mr-1"}),"施設貸し切り"]}),e.jsxs("div",{className:"ml-2 space-y-1",children:[e.jsx("p",{children:"• 通常: ¥4,400/1時間"}),e.jsx("p",{className:"text-purple-700 font-medium",children:"• サブスク: ¥3,520/1時間（20%OFF）"}),e.jsx("p",{children:"• 1時間単位で予約可能"}),e.jsxs("p",{children:["• ",e.jsx("strong",{children:"2日前までの予約が必要"})]})]})]})]})]}),e.jsxs(g,{className:"p-4 bg-green-50 border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(z,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"決済について"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-green-800",children:[e.jsx("p",{children:"• 安全なクレジットカード決済"}),e.jsx("p",{children:"• 決済完了後、即座にPINコード発行"}),e.jsx("p",{children:"• 24時間有効（1日券の場合）"}),e.jsx("p",{children:"• 全国のドッグランで利用可能"}),e.jsx("p",{children:"• 最大3頭まで同時入場"})]})]}),e.jsxs(g,{className:"p-4 bg-green-50 border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(L,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"1日券の特徴"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-green-800",children:[e.jsx("p",{children:"• 24時間有効（発行から24時間後に失効）"}),e.jsx("p",{children:"• 最大3頭まで同時入場可能"}),e.jsx("p",{children:"• 段階的料金制でお得"}),e.jsx("p",{children:"• 全国のドッグランで利用可能"}),e.jsx("p",{className:"text-red-600 font-medium",children:"• 施設貸し切り中は入場できません"})]})]}),e.jsxs(g,{className:"p-4 bg-orange-50 border-orange-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(R,{className:"w-5 h-5 text-orange-600"}),e.jsx("h3",{className:"font-semibold text-orange-900",children:"施設貸し切り特典"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-orange-800",children:[e.jsx("p",{children:"• 施設全体を独占利用"}),e.jsx("p",{children:"• 人数制限なし"}),e.jsx("p",{children:"• 1時間単位での利用"}),e.jsx("p",{children:"• 最大3頭まで同時入場"}),e.jsx("p",{children:"• 友達にPINコード共有可能"}),e.jsx("p",{children:"• 他の利用者を一切気にせず自由に遊べます"}),e.jsx("p",{children:"• 大型犬・小型犬エリア両方利用可能"}),e.jsx("p",{className:"text-purple-700 font-medium",children:"• サブスク会員は20%OFF！"}),e.jsxs("p",{className:"text-red-600 font-medium",children:["• ",e.jsx("strong",{children:"2日前までの予約が必要"})]})]})]}),e.jsxs(g,{className:"p-4 bg-yellow-50 border-yellow-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(se,{className:"w-5 h-5 text-yellow-600"}),e.jsx("h3",{className:"font-semibold text-yellow-900",children:"入場時の犬選択"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-yellow-800",children:[e.jsx("p",{children:"• 最大3頭まで選択可能"}),e.jsx("p",{children:"• 選択した犬のみ入場可能"}),e.jsx("p",{children:"• 全ての犬のワクチン証明書が必要"}),e.jsx("p",{children:"• 後から犬の変更はできません"})]})]}),e.jsxs(g,{className:"p-4 bg-green-50 border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(je,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-900",children:"決済完了後の流れ"})]}),e.jsxs("div",{className:"text-xs text-green-800 space-y-1",children:[e.jsx("p",{children:"1. 決済完了と同時に入場用PINコードが発行されます"}),e.jsx("p",{children:"2. マイページの「入退場」からPINコードを確認"}),e.jsx("p",{children:"3. 予約日時にドッグラン入口でPINコードを入力"}),e.jsx("p",{children:"4. 選択した全ての犬と一緒に入場できます"}),e.jsx("p",{className:"text-orange-700 font-medium",children:"5. 施設貸し切りの場合、友達にPINコードを共有可能！"})]})]})]})}function Pe(){const{parkId:p}=ie(),y=ce(),{user:a}=le(),{isActive:c}=ne(),{createCheckoutSession:_,loading:F}=be(),[d,u]=m.useState(!1),[q,o]=m.useState(""),[P,U]=m.useState([]),[i,O]=m.useState(null),[I,h]=m.useState([]),[Y,W]=m.useState([]),[f,$]=m.useState([]),[s,j]=m.useState({date:"",selectedTimeSlot:"",duration:"1",reservationType:"whole_facility",paymentType:"single"}),w=r=>{j(t=>({...t,...r}))},[M,k]=m.useState(!1),T=3,C=m.useMemo(()=>{const r=[];for(let t=6;t<=21;t++){const l=`${t.toString().padStart(2,"0")}:00`;r.push({time:l,available:!0,reservationCount:0,maxCapacity:i?.max_capacity||10,isPrivateBoothAvailable:!0,isWholeFacilityAvailable:!0})}return r},[i?.max_capacity]);m.useEffect(()=>{if(!a){y("/login");return}async function r(){if(a)try{const[t,l]=await Promise.all([K.from("dogs").select(`
              *,
              vaccine_certifications(*)
            `).eq("owner_id",a.id),K.from("dog_parks").select("*").eq("id",p).single()]);if(t.error)throw t.error;if(l.error)throw l.error;const n=(t.data||[]).filter(x=>x.vaccine_certifications&&x.vaccine_certifications.some(b=>b.status==="approved"));U(n),O(l.data)}catch(t){console.error("Error fetching data:",t)}}r()},[a,p,y]),m.useEffect(()=>{c&&s.paymentType==="single"&&w({paymentType:"subscription"})},[c]),m.useEffect(()=>{s.date&&i&&N()},[s.date,i]),m.useEffect(()=>{if(s.date){const r=new Date(s.date),t=new Date;t.setHours(0,0,0,0);const l=new Date(t);l.setDate(t.getDate()+2);const n=s.paymentType==="facility_rental"&&r<l;k(n),o(n?"施設貸し切りは2日前までの予約が必要です。":"")}},[s.date,s.paymentType]);const N=async()=>{if(!(!s.date||!i))try{const{data:r,error:t}=await K.from("reservations").select("*").eq("park_id",p).eq("date",s.date).eq("status","confirmed");if(t)throw t;W(r||[]),V(r||[])}catch(r){console.error("Error fetching reservations:",r)}},V=r=>{const t=[...C];t.forEach(l=>{const n=parseInt(l.time.split(":")[0]);let x=0,b=0,S=0;r.forEach(v=>{const G=parseInt(v.start_time.split(":")[0]),ae=G+v.duration;n>=G&&n<ae&&(v.reservation_type==="whole_facility"||v.total_amount>=4400?S++:v.reservation_type==="private_booth"||v.total_amount===5e3?b++:x++)}),l.reservationCount=x,l.available=x<l.maxCapacity&&S===0,l.isPrivateBoothAvailable=b<(i?.private_booth_count||0)&&S===0,l.isWholeFacilityAvailable=x===0&&b===0&&S===0}),h(t)},E=r=>r.isWholeFacilityAvailable?{label:"施設貸し切り可能",color:"bg-orange-500 text-white hover:bg-orange-600",icon:R}:{label:"利用不可",color:"bg-red-500 text-white cursor-not-allowed",icon:ge},J=r=>{$(t=>t.includes(r)?t.filter(l=>l!==r):t.length>=T?(o(`最大${T}頭まで選択可能です。`),t):(o(""),[...t,r]))},H=r=>{j(t=>({...t,selectedTimeSlot:r}))},A=()=>{const r=parseInt(s.duration),t=4400;if(c){const l=t*r;return Math.round(l*.8)}return t*r},Q=()=>{const r=f.length;return r===0?0:r===1?800:800+(r-1)*400},X=()=>s.paymentType==="subscription"?c?0:3800:s.paymentType==="facility_rental"?A():Q(),Z=()=>f.map(r=>P.find(l=>l.id===r)?.name||"").filter(r=>r).join("、"),te=async r=>{if(r.preventDefault(),!(!a||!i)){u(!0),o("");try{if(s.paymentType==="facility_rental"&&!s.selectedTimeSlot){o("施設貸し切りの場合は時間を選択してください。"),u(!1);return}if(f.length===0){o("ワンちゃんを1頭以上選択してください。"),u(!1);return}if(s.paymentType==="facility_rental"){const n=I.find(v=>v.time===s.selectedTimeSlot);if(!n||!n.isWholeFacilityAvailable){o("選択された時間は施設貸し切りできません。他の予約が入っています。"),u(!1);return}const x=new Date(s.date),b=new Date;b.setHours(0,0,0,0);const S=new Date(b);if(S.setDate(b.getDate()+2),x<S){o("施設貸し切りは2日前までの予約が必要です。"),u(!1);return}}const t={parkId:p,parkName:i.name,selectedDogs:f,dogNames:Z(),date:s.date,selectedTimeSlot:s.selectedTimeSlot,duration:parseInt(s.duration),paymentType:s.paymentType,totalPrice:X(),reservationType:s.paymentType==="facility_rental"?"whole_facility":"regular"},l=`DP${Date.now()}${Math.floor(Math.random()*1e3)}`;if(s.paymentType==="single"){const n=D.find(x=>x.mode==="payment");if(!n){o("1日券商品が見つかりません。"),u(!1);return}await _({priceId:n.priceId,mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&type=day_pass&order_number=${l}`,cancelUrl:`${window.location.origin}/parks/${p}/reserve?canceled=true`,customParams:{reservation_data:JSON.stringify(t),order_number:l}});return}if(s.paymentType==="subscription"&&!c){const n=D.find(x=>x.mode==="subscription");if(!n){o("サブスクリプション商品が見つかりません。"),u(!1);return}await _({priceId:n.priceId,mode:"subscription",successUrl:`${window.location.origin}/payment-confirmation?success=true&type=subscription`,cancelUrl:`${window.location.origin}/parks/${p}/reserve?canceled=true`});return}if(s.paymentType==="subscription"&&c){y("/access-control");return}if(s.paymentType==="facility_rental"){console.log("Processing 施設貸し切り payment...",{customAmount:A(),customName:`${i.name} 施設貸し切り ${s.date} ${s.selectedTimeSlot}〜${parseInt(s.selectedTimeSlot)+parseInt(s.duration)}:00`}),await _({priceId:"price_placeholder",mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&order_number=${l}`,cancelUrl:`${window.location.origin}/parks/${p}/reserve`,customAmount:A(),customName:`${i.name} 施設貸し切り ${s.date} ${s.selectedTimeSlot}〜${parseInt(s.selectedTimeSlot)+parseInt(s.duration)}:00`,customParams:{reservation_data:JSON.stringify(t),order_number:l}});return}y("/checkout",{state:{reservationData:t}})}catch(t){console.error("Error processing reservation:",t),console.error("Error details:",{message:t.message,stack:t.stack,formData:s,selectedDogs:f}),o(`予約データの準備に失敗しました: ${t.message}`)}finally{u(!1)}}},re=(r,t)=>`${(parseInt(r.split(":")[0])+parseInt(t)).toString().padStart(2,"0")}:00`;return i?P.length===0?e.jsxs(g,{className:"max-w-2xl mx-auto text-center py-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ワクチン接種証明書が必要です"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ドッグランを利用するには、ワクチン接種証明書の承認が必要です。 まだ証明書を提出していない場合は、ワンちゃんの登録時に提出してください。"}),e.jsx(ee,{onClick:()=>y("/register-dog"),children:"ワンちゃんを登録する"})]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold text-center mb-8",children:[i.name,"の予約"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(ye,{park:i,error:q,formData:s,setFormData:w,timeSlots:I,isDateTooSoon:M,selectedDogs:f,dogs:P,handleDogSelection:J,handleTimeSlotSelect:H,getEndTime:re,getSlotStatus:E,getSelectedDogNames:Z,calculateDayPassPrice:Q,calculateTotalPrice:X,hasSubscription:c,handleSubmit:te,isLoading:d,checkoutLoading:F,MAX_DOGS:T})}),e.jsx(fe,{hasSubscription:c})]})]}):e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})}export{Pe as ParkReservation};
