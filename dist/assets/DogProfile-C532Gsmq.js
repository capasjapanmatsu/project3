import{j as e,P as N,J as D,g as E,i as Q,G as P,$ as V,b as W}from"./ui-vendor-w2MLOks7.js";import{h as X,u as Z,r as i,L as C}from"./react-vendor-_GyjDmDn.js";import{u as ee,s as l,C as f,B as y}from"./index-pj4YkVsE.js";import"./supabase-vendor-Df9iqQzW.js";function ie(){const{id:I,dogId:R}=X(),{user:a}=ee();Z();const[t,$]=i.useState(null),[F,w]=i.useState(!0),[v,d]=i.useState(""),[b,m]=i.useState(""),[T,k]=i.useState(!1),[A,_]=i.useState(!1),[q,H]=i.useState([]),[x,j]=i.useState(!1),[M,p]=i.useState(0),[S,L]=i.useState(!1),c=I||R;i.useEffect(()=>{c&&(B(),a&&(J(),Y()))},[c,a]);const B=async()=>{try{w(!0),d("");const{data:s,error:r}=await l.from("dogs").select("*").eq("id",c).single();if(r)throw r;$(s),p(s.like_count||0);const{data:n,error:h}=await l.from("reservations").select(`
          *,
          dog_park:dog_parks(*)
        `).eq("dog_id",c).eq("status","confirmed");if(h)throw h;const o={};(n||[]).forEach(g=>{const u=g.park_id;g.dog_park&&(o[u]||(o[u]={park:g.dog_park,visits:0}),o[u].visits++)});const K=Object.values(o).sort((g,u)=>u.visits-g.visits).slice(0,3);H(K)}catch(s){console.error("Error fetching dog profile:",s),d("ワンちゃんの情報を取得できませんでした。")}finally{w(!1)}},J=async()=>{if(!(!a||!c))try{const{data:s}=await l.from("dogs").select("owner_id").eq("id",c).single();if(!s)return;const{data:r,error:n}=await l.from("friend_requests").select("id, status").or(`and(requester_id.eq.${a.id},requested_id.eq.${s.owner_id}),and(requester_id.eq.${s.owner_id},requested_id.eq.${a.id})`).maybeSingle();!n&&r&&_(!0)}catch(s){console.error("Error checking friend request status:",s)}},Y=async()=>{if(!(!a||!c))try{const{data:s,error:r}=await l.from("dog_likes").select("id").eq("user_id",a.id).eq("dog_id",c).maybeSingle();!r&&s&&j(!0)}catch(s){console.error("Error checking like status:",s)}},z=async()=>{if(!(!a||!t||S)){L(!0);try{if(x){const{error:s}=await l.from("dog_likes").delete().eq("user_id",a.id).eq("dog_id",t.id);if(s)throw s;j(!1),p(r=>r-1),m("いいねを取り消しました")}else{const{error:s}=await l.from("dog_likes").insert({user_id:a.id,dog_id:t.id});if(s)throw s;j(!0),p(r=>r+1),m("いいねしました")}setTimeout(()=>m(""),2e3)}catch(s){console.error("Error handling like:",s),d("いいねの処理に失敗しました"),setTimeout(()=>d(""),3e3)}finally{L(!1)}}},G=async()=>{if(!(!a||!t)){k(!0);try{const{error:s}=await l.from("friend_requests").insert({requester_id:a.id,requested_id:t.owner_id,message:"ドッグランでお会いした際は、よろしくお願いします！"});if(s)throw s;_(!0),m("友達申請を送信しました"),setTimeout(()=>m(""),3e3)}catch(s){console.error("Error sending friend request:",s),d("友達申請の送信に失敗しました"),setTimeout(()=>d(""),3e3)}finally{k(!1)}}},O=s=>{const r=new Date,n=new Date(s);let h=r.getFullYear()-n.getFullYear();const o=r.getMonth()-n.getMonth();return(o<0||o===0&&r.getDate()<n.getDate())&&h--,h},U=s=>s==="オス"?"くん":"ちゃん";return F?e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):v||!t?e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsxs(f,{className:"p-8 text-center",children:[e.jsx(N,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"ワンちゃんが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:v||"ワンちゃんの情報が見つかりませんでした。"}),e.jsx(C,{to:"/",children:e.jsxs(y,{variant:"primary",children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})})]})}):e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(C,{to:"/",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})}),b&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(E,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:b})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(f,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-48 h-48 bg-gray-200 rounded-lg overflow-hidden",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover",onError:s=>{s.currentTarget.src="https://images.pexels.com/photos/58997/pexels-photo-58997.jpeg?auto=compress&cs=tinysrgb&w=300"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:e.jsx(N,{className:"w-12 h-12"})})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:[t.name,U(t.gender)]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Q,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsxs("span",{className:"text-lg text-gray-700",children:[O(t.birth_date),"歳"]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(N,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsx("span",{className:"text-lg text-gray-700",children:t.breed})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(P,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsx("span",{className:"text-lg text-gray-700",children:t.gender})]})]}),e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("span",{className:"text-sm text-gray-600",children:[M,"件のいいね"]})}),a&&e.jsxs(y,{onClick:z,disabled:S,variant:x?"primary":"secondary",size:"sm",className:`px-4 py-2 ${x?"bg-pink-500 hover:bg-pink-600 text-white":"bg-white hover:bg-pink-50 text-pink-600 border-pink-300"}`,children:[e.jsx(P,{className:`w-4 h-4 mr-1 ${x?"fill-current":""}`}),x?"いいね済み":"いいね"]})]})}),a&&t.owner_id!==a.id&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[e.jsx("div",{className:"text-center",children:A?e.jsxs("div",{className:"flex items-center justify-center text-green-600",children:[e.jsx(E,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:"友達申請済み"})]}):e.jsxs(y,{onClick:G,isLoading:T,className:"px-8 py-3",children:[e.jsx(V,{className:"w-5 h-5 mr-2"}),"友達申請を送る"]})}),e.jsx("div",{className:"mt-4 p-4 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"友達申請について"}),e.jsx("p",{children:"友達申請を送ると、相手の飼い主さんに通知が届きます。 承認されると、メッセージのやり取りができるようになります。"})]})})]})]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(f,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-4 flex items-center",children:[e.jsx(W,{className:"w-5 h-5 text-green-600 mr-2"}),"よく遊ぶドッグラン"]}),q.length>0?e.jsx("div",{className:"space-y-3",children:q.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-900",children:s.park.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.visits,"回利用"]})]}),e.jsx("div",{className:"text-2xl",children:r===0?"🥇":r===1?"🥈":"🥉"})]},s.park.id))}):e.jsx("p",{className:"text-gray-500",children:"まだドッグランの利用履歴がありません"})]}),e.jsxs(f,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"登録日"}),e.jsx("p",{className:"text-gray-700",children:new Date(t.created_at).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})})]})]})]})]})}export{ie as DogProfile};
