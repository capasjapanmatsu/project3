import{s as e}from"./index-CWMjoAp3.js";const r=async(r,s,c)=>{try{const t=r.name.split(".").pop()||"jpg",a=`${s}/${c}_${Date.now()}.${t}`;if(!(r instanceof File))throw new Error("Invalid file object: expected File, got "+typeof r);const{data:i,error:o}=await e.storage.from("vaccine-certs").upload(a,r,{cacheControl:"3600",upsert:!0,contentType:r.type});if(o)return{success:!1,error:`アップロードに失敗しました: ${o.message}`};const{data:{publicUrl:n}}=e.storage.from("vaccine-certs").getPublicUrl(a);return{success:!0,filePath:a}}catch(t){return{success:!1,error:t.message}}},s=async(s,c,t,a,i)=>{try{let o,n;if(c){const e=await r(c,s,"rabies");if(!e.success)return{success:!1,error:`狂犬病ワクチン証明書: ${e.error}`};o=e.filePath}if(t){const e=await r(t,s,"combo");if(!e.success)return{success:!1,error:`混合ワクチン証明書: ${e.error}`};n=e.filePath}const{data:u,error:f}=await e.from("vaccine_certifications").select("id").eq("dog_id",s).maybeSingle();if(f&&"PGRST116"!==f.code)return{success:!1,error:`データベース確認エラー: ${f.message}`};const m={status:"pending"};if(o&&(m.rabies_vaccine_image=o),n&&(m.combo_vaccine_image=n),a&&(m.rabies_expiry_date=a),i&&(m.combo_expiry_date=i),u){const{error:r}=await e.from("vaccine_certifications").update(m).eq("id",u.id);if(r)return{success:!1,error:`証明書更新エラー: ${r.message}`}}else{const{error:r}=await e.from("vaccine_certifications").insert([{dog_id:s,...m}]);if(r)return{success:!1,error:`証明書作成エラー: ${r.message}`}}return{success:!0}}catch(o){return{success:!1,error:o.message}}};export{s as h};
