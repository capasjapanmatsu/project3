var e=(e,r,a)=>new Promise(((t,n)=>{var i=e=>{try{d(a.next(e))}catch(r){n(r)}},o=e=>{try{d(a.throw(e))}catch(r){n(r)}},d=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,o);d((a=a.apply(e,r)).next())}));import{r}from"./router.BWT_vQps.js";import{s as a,l as t,h as n,b as i}from"./index.D9xag4tn.js";const o=o=>{const[d,s]=r.useState([]),[c,l]=r.useState([]),[_,u]=r.useState(!0),[f,g]=r.useState(""),[p,m]=r.useState(""),v=()=>e(null,null,(function*(){try{t("info","ðŸ” Fetching pending vaccines..."),yield e(null,null,(function*(){try{const{error:e}=yield a.storage.updateBucket("vaccine-certs",{public:!0});return!e}catch(f){return!1}}));const r=yield i((()=>a.from("vaccine_certifications").select("\n            id,\n            dog_id,\n            rabies_vaccine_image,\n            combo_vaccine_image,\n            rabies_expiry_date,\n            combo_expiry_date,\n            status,\n            created_at,\n            dog:dogs (\n              id,\n              name,\n              breed,\n              gender,\n              birth_date,\n              owner:profiles (\n                id,\n                name\n              )\n            )\n          ").eq("status","pending").order("created_at",{ascending:!1})));if(r.error)throw t("error","âŒ Vaccines fetch error:",r.error),r.error;const n=r.data||[];if(0===n.length)return t("info","â„¹ï¸ No pending vaccines found"),void l([]);t("info",`âœ… Found ${n.length} pending vaccines`);const o=n.map((e=>{const r=Array.isArray(e.dog)?e.dog[0]:e.dog,a=r?Array.isArray(r.owner)?r.owner[0]:r.owner:null;return r&&a?{id:e.id,dog_id:e.dog_id,rabies_vaccine_image:e.rabies_vaccine_image,combo_vaccine_image:e.combo_vaccine_image,rabies_expiry_date:e.rabies_expiry_date,combo_expiry_date:e.combo_expiry_date,status:e.status,created_at:e.created_at,dog:{id:r.id,name:r.name,breed:r.breed,gender:r.gender,birth_date:r.birth_date,owner:{id:a.id,name:a.name}}}:(t("warn","âŒ Invalid vaccine data:",{vaccine:e}),null)})).filter((e=>null!==e));l(o)}catch(r){t("error","âŒ Error fetching vaccines:",{error:n(r)}),g(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜Žæ›¸ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${n(r)}`)}})),h=()=>e(null,null,(function*(){try{u(!0),g(""),"parks"===o?yield e(null,null,(function*(){try{t("info","ðŸ” Fetching pending parks...");const e=yield i((()=>a.from("dog_parks").select("\n            id,\n            name,\n            address,\n            status,\n            created_at,\n            owner_id\n          ").in("status",["pending","first_stage_passed","second_stage_review"]).order("created_at",{ascending:!1})));if(e.error)throw t("error","âŒ Parks fetch error:",e.error),e.error;const r=e.data||[];if(0===r.length)return t("info","â„¹ï¸ No pending parks found"),void s([]);t("info",`âœ… Found ${r.length} pending parks`);const n=[...new Set(r.map((e=>e.owner_id)))],o=r.map((e=>e.id)),[d,c,l,_]=yield Promise.allSettled([n.length>0?a.from("profiles").select("id, name, postal_code, address, phone_number, email").in("id",n):Promise.resolve({data:[],error:null}),o.length>0?a.from("dog_park_review_stages").select("park_id, second_stage_submitted_at").in("park_id",o):Promise.resolve({data:[],error:null}),o.length>0?a.from("dog_park_facility_images").select("park_id, is_approved").in("park_id",o):Promise.resolve({data:[],error:null}),n.length>0?a.from("owner_verifications").select("user_id, verification_id, status, verification_data, created_at").in("user_id",n):Promise.resolve({data:[],error:null})]),u="fulfilled"===d.status&&d.value.data||[],f=new Map(u.map((e=>[e.id,e]))),g="fulfilled"===c.status&&c.value.data||[],p=new Map(g.map((e=>[e.park_id,e]))),m="fulfilled"===l.status&&l.value.data||[],v=new Map;m.forEach((e=>{v.has(e.park_id)||v.set(e.park_id,[]),v.get(e.park_id).push(e)}));const h="fulfilled"===_.status&&_.value.data||[],y=new Map(h.map((e=>[e.user_id,e]))),w=r.map((e=>{const r=f.get(e.owner_id),a=p.get(e.id),t=v.get(e.id)||[],n=y.get(e.owner_id),i=t.length,o=t.filter((e=>!0===e.is_approved)).length,d=t.filter((e=>!1===e.is_approved)).length,s=t.filter((e=>null===e.is_approved)).length;let c="",l="";return n&&n.verification_data&&"object"==typeof n.verification_data&&(c=n.verification_data.document_url||n.verification_data.file_path||"",l=n.verification_data.file_name||n.verification_data.filename||""),!c&&(null==n?void 0:n.verification_id)&&(c=n.verification_id),!l&&c&&(l=c.split("/").pop()||"identity_document"),{id:e.id,name:e.name,address:e.address,status:e.status,created_at:e.created_at,owner_id:e.owner_id,owner_name:(null==r?void 0:r.name)||"Unknown Owner",second_stage_submitted_at:(null==a?void 0:a.second_stage_submitted_at)||null,total_images:i,approved_images:o,rejected_images:d,pending_images:s,owner_postal_code:(null==r?void 0:r.postal_code)||"",owner_address:(null==r?void 0:r.address)||"",owner_phone_number:(null==r?void 0:r.phone_number)||"",owner_email:(null==r?void 0:r.email)||"",identity_document_url:c,identity_document_filename:l,identity_status:(null==n?void 0:n.status)||"not_submitted",identity_created_at:(null==n?void 0:n.created_at)||""}}));t("info",`âœ… Transformed ${w.length} parks with image data`),s(w)}catch(e){t("error","âŒ Error fetching parks:",{error:n(e)}),g(`ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${n(e)}`)}})):"vaccines"===o&&(yield v())}catch(r){t("error","âŒ Error in fetchData:",{error:n(r)}),g(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${n(r)}`)}finally{u(!1)}}));return r.useEffect((()=>{h()}),[o]),{pendingParks:d,pendingVaccines:c,isLoading:_,error:f,success:p,refetch:h}},d=o=>{const[d,s]=r.useState([]),[c,l]=r.useState(!1),[_,u]=r.useState(""),f=r=>e(null,null,(function*(){try{l(!0),u(""),t("info",`ðŸ” Fetching images for park: ${r}`);const e=yield i((()=>a.from("dog_park_facility_images").select("*").eq("park_id",r).order("created_at",{ascending:!1})));if(e.error)throw t("error","âŒ Images fetch error:",e.error),e.error;const n=e.data||[];t("info",`âœ… Found ${n.length} images for park ${r}`),s(n)}catch(e){t("error","âŒ Error fetching park images:",{error:n(e)}),u(`ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${n(e)}`)}finally{l(!1)}}));return r.useEffect((()=>{o&&f(o)}),[o]),{parkImages:d,isLoading:c,error:_,fetchParkImages:f}};export{d as a,o as u};
