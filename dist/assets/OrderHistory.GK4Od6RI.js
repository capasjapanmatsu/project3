/*! Build: 2025-07-17T07:59:15.523Z
Version: 0.0.0 */
import{aF as e,r as s,j as a,n as t,A as n,a2 as r,U as l,ac as c,aG as i,s as d,C as m,f as o,w as x,z as h,a as p,$ as j,X as u,a3 as g}from"./vendor-react.D8SVeCGP.js";import{u as f,B as N,C as b}from"./components-admin.GT3qRZg5.js";import{s as v}from"./utils.C9ZsMnW6.js";import"./vendor-misc.qnLj5toF.js";import"./hooks.CTtJlocA.js";import"./vendor-stripe.B5MJ2ewd.js";import"./pages-dog.BrfoFXaJ.js";import"./vendor-supabase.RBPF72ft.js";function _(){var _;const{user:y}=f(),w=e(),[S,k]=s.useState([]),[L,C]=s.useState(!0),[D,$]=s.useState(null),[z,T]=s.useState(!1),[E,J]=s.useState(!1),[P,q]=s.useState(null),[M,A]=s.useState(null),[I,U]=s.useState(null);s.useEffect((()=>{var e;if(y){B();const e=setInterval((()=>{F()}),6e4);return()=>clearInterval(e)}(null==(e=w.state)?void 0:e.orderSuccess)&&(T(!0),setTimeout((()=>T(!1)),5e3))}),[y,w]);const B=async()=>{try{const{data:e,error:s}=await v.from("orders").select("\n          *,\n          order_items (\n            *,\n            product:products (*)\n          )\n        ").eq("user_id",null==y?void 0:y.id).order("created_at",{ascending:!1});if(s)throw s;const a=(e||[]).map((e=>{const s=e.cancellable_until?new Date(e.cancellable_until):null,a=new Date,t=s&&a<s&&["pending","confirmed"].includes(e.status);let n;if(t&&s){const e=s.getTime()-a.getTime();n=`${Math.floor(e/6e4)}分${Math.floor(e%6e4/1e3)}秒`}return{...e,can_cancel:t,time_left:n}}));k(a)}catch(e){}finally{C(!1)}},F=()=>{const e=new Date;k((s=>s.map((s=>{const a=s.cancellable_until?new Date(s.cancellable_until):null,t=a&&e<a&&["pending","confirmed"].includes(s.status);let n;if(t&&a){const s=a.getTime()-e.getTime();n=`${Math.floor(s/6e4)}分${Math.floor(s%6e4/1e3)}秒`}return{...s,can_cancel:t,time_left:n}}))))},O=e=>{switch(e){case"pending":return a.jsx(h,{className:"w-5 h-5 text-yellow-600"});case"confirmed":return a.jsx(m,{className:"w-5 h-5 text-blue-600"});case"processing":return a.jsx(r,{className:"w-5 h-5 text-purple-600"});case"shipped":return a.jsx(g,{className:"w-5 h-5 text-orange-600"});case"delivered":return a.jsx(m,{className:"w-5 h-5 text-green-600"});case"cancelled":return a.jsx(u,{className:"w-5 h-5 text-red-600"});default:return a.jsx(h,{className:"w-5 h-5 text-gray-600"})}},R=e=>({pending:"注文受付中",confirmed:"注文確定",processing:"準備中",shipped:"発送済み",delivered:"配達完了",cancelled:"キャンセル"}[e]||e),G=e=>({credit_card:"クレジットカード",bank_transfer:"銀行振込",cod:"代金引換"}[e]||e);return L?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):a.jsxs("div",{className:"max-w-6xl mx-auto",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(t,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[a.jsx(n,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[a.jsx(r,{className:"w-8 h-8 text-green-600 mr-3"}),"注文履歴"]}),a.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[a.jsx(t,{to:"/profile-settings",children:a.jsxs(N,{variant:"secondary",size:"sm",children:[a.jsx(l,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),a.jsx(t,{to:"/payment-method-settings",children:a.jsxs(N,{variant:"secondary",size:"sm",children:[a.jsx(c,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),a.jsx(t,{to:"/dogpark-history",children:a.jsxs(N,{variant:"secondary",size:"sm",children:[a.jsx(i,{className:"w-4 h-4 mr-2"}),"ドッグラン利用履歴"]})}),a.jsx(t,{to:"/shop",children:a.jsxs(N,{variant:"secondary",size:"sm",children:[a.jsx(d,{className:"w-4 h-4 mr-2"}),"ショップに戻る"]})})]}),z&&(null==(_=w.state)?void 0:_.orderNumber)&&a.jsxs("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(m,{className:"w-5 h-5 text-green-600"}),a.jsx("span",{className:"font-semibold text-green-800",children:"ご注文ありがとうございます！"})]}),a.jsxs("p",{className:"text-green-700 mt-1",children:["注文番号: ",w.state.orderNumber," のご注文を承りました。"]})]}),M&&a.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(m,{className:"w-5 h-5 text-green-600"}),a.jsx("span",{className:"font-semibold text-green-800",children:M})]})}),P&&a.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(o,{className:"w-5 h-5 text-red-600"}),a.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),a.jsx("p",{className:"text-red-700 mt-1",children:P})]}),0===S.length?a.jsxs(b,{className:"text-center py-12",children:[a.jsx(r,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"注文履歴がありません"}),a.jsx("p",{className:"text-gray-500 mb-6",children:"まだ商品をご注文いただいていません"}),a.jsx(N,{onClick:()=>window.location.href="/shop",children:"ショッピングを始める"})]}):a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"flex justify-end mb-4",children:a.jsxs(N,{variant:"secondary",size:"sm",onClick:()=>{if(0===S.length)return;const e=["注文番号","注文日","ステータス","商品名","数量","単価","小計","割引","送料","合計金額","支払い方法","配送先氏名","配送先住所","配送先電話番号"].join(","),s=[];S.forEach((e=>{const a=new Date(e.created_at).toLocaleDateString("ja-JP"),t=R(e.status),n=G(e.payment_method);if(e.order_items&&e.order_items.length>0)e.order_items.forEach(((r,l)=>{const c=[e.order_number,a,t,`"${r.product.name.replace(/"/g,'""')}"`,r.quantity,r.unit_price,r.total_price,0===l?e.discount_amount:"",0===l?e.shipping_fee:"",0===l?e.final_amount:"",0===l?n:"",0===l?`"${e.shipping_name.replace(/"/g,'""')}"`:"",0===l?`"${e.shipping_address.replace(/"/g,'""')}"`:"",0===l?e.shipping_phone:""].join(",");s.push(c)}));else{const r=[e.order_number,a,t,"商品なし","","","",e.discount_amount,e.shipping_fee,e.final_amount,n,`"${e.shipping_name.replace(/"/g,'""')}"`,`"${e.shipping_address.replace(/"/g,'""')}"`,e.shipping_phone].join(",");s.push(r)}}));const a="\ufeff"+[e,...s].join("\n"),t=new Blob([a],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),r=document.createElement("a");r.setAttribute("href",n),r.setAttribute("download",`注文履歴_${(new Date).toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)},children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),S.map((e=>{return a.jsxs(b,{className:"p-6",children:[a.jsxs("div",{className:"flex justify-between items-start mb-4",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[a.jsxs("h3",{className:"text-lg font-semibold",children:["注文番号: ",e.order_number]}),a.jsxs("div",{className:`flex items-center space-x-1 px-2 py-1 rounded-full text-sm ${s=e.status,{pending:"text-yellow-600 bg-yellow-100",confirmed:"text-blue-600 bg-blue-100",processing:"text-purple-600 bg-purple-100",shipped:"text-orange-600 bg-orange-100",delivered:"text-green-600 bg-green-100",cancelled:"text-red-600 bg-red-100"}[s]||"text-gray-600 bg-gray-100"}`,children:[O(e.status),a.jsx("span",{children:R(e.status)})]}),e.can_cancel&&a.jsxs("div",{className:"text-xs text-orange-600 flex items-center",children:[a.jsx(h,{className:"w-3 h-3 mr-1"}),"キャンセル可能: あと",e.time_left]})]}),a.jsxs("p",{className:"text-gray-600 text-sm",children:["注文日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]}),e.estimated_delivery_date&&a.jsxs("p",{className:"text-gray-600 text-sm",children:["お届け予定日: ",new Date(e.estimated_delivery_date).toLocaleDateString("ja-JP")]})]}),a.jsxs("div",{className:"text-right",children:[a.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",e.final_amount.toLocaleString()]}),a.jsx("p",{className:"text-sm text-gray-500",children:G(e.payment_method)})]})]}),a.jsxs("div",{className:"space-y-3 mb-4",children:[e.order_items.slice(0,3).map((e=>a.jsxs("div",{className:"flex items-center space-x-4 bg-gray-50 p-3 rounded-lg",children:[a.jsx("img",{src:e.product.image_url,alt:e.product.name,className:"w-16 h-16 object-cover rounded",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h4",{className:"font-medium",children:e.product.name}),a.jsxs("p",{className:"text-sm text-gray-600",children:["数量: ",e.quantity," × ¥",e.unit_price.toLocaleString()]})]}),a.jsxs("p",{className:"font-medium",children:["¥",e.total_price.toLocaleString()]})]},e.id))),e.order_items.length>3&&a.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["他 ",e.order_items.length-3," 点"]})]}),a.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg mb-4",children:[a.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送先"}),a.jsxs("p",{className:"text-sm text-blue-800",children:[e.shipping_name,a.jsx("br",{}),"〒",e.shipping_postal_code,a.jsx("br",{}),e.shipping_address,a.jsx("br",{}),e.shipping_phone]})]}),e.tracking_number&&a.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg mb-4",children:[a.jsx("h4",{className:"font-semibold text-orange-900 mb-1",children:"配送追跡"}),a.jsxs("p",{className:"text-sm text-orange-800",children:["追跡番号: ",e.tracking_number]})]}),a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{className:"flex space-x-2",children:[a.jsxs(N,{variant:"secondary",size:"sm",onClick:()=>$(e),children:[a.jsx(p,{className:"w-4 h-4 mr-1"}),"詳細を見る"]}),"delivered"===e.status&&a.jsxs(N,{variant:"secondary",size:"sm",onClick:()=>{alert("レビュー機能は準備中です")},children:[a.jsx(j,{className:"w-4 h-4 mr-1"}),"レビューを書く"]})]}),e.can_cancel&&a.jsxs(N,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700",onClick:()=>U(e.id),children:[a.jsx(u,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]},e.id);var s}))]}),D&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:a.jsxs("div",{className:"p-6",children:[a.jsxs("div",{className:"flex justify-between items-center mb-6",children:[a.jsx("h2",{className:"text-xl font-bold",children:"注文詳細"}),a.jsx("button",{onClick:()=>$(null),className:"text-gray-500 hover:text-gray-700",children:a.jsx(u,{className:"w-6 h-6"})})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold mb-3",children:"注文情報"}),a.jsxs("div",{className:"space-y-2 text-sm",children:[a.jsxs("p",{children:[a.jsx("span",{className:"font-medium",children:"注文番号:"})," ",D.order_number]}),a.jsxs("p",{children:[a.jsx("span",{className:"font-medium",children:"注文日:"})," ",new Date(D.created_at).toLocaleDateString("ja-JP")]}),a.jsxs("p",{children:[a.jsx("span",{className:"font-medium",children:"ステータス:"})," ",R(D.status)]}),a.jsxs("p",{children:[a.jsx("span",{className:"font-medium",children:"支払い方法:"})," ",G(D.payment_method)]}),D.estimated_delivery_date&&a.jsxs("p",{children:[a.jsx("span",{className:"font-medium",children:"お届け予定日:"})," ",new Date(D.estimated_delivery_date).toLocaleDateString("ja-JP")]}),D.can_cancel&&a.jsxs("div",{className:"mt-2 p-2 bg-orange-50 rounded-lg",children:[a.jsxs("p",{className:"text-orange-800 flex items-center",children:[a.jsx(h,{className:"w-4 h-4 mr-1"}),a.jsxs("span",{children:["キャンセル可能時間: あと",D.time_left]})]}),a.jsx("p",{className:"text-xs text-orange-700 mt-1",children:"注文から15分以内はキャンセル可能です"})]})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold mb-3",children:"配送先"}),a.jsxs("div",{className:"text-sm",children:[a.jsx("p",{className:"font-medium",children:D.shipping_name}),a.jsxs("p",{children:["〒",D.shipping_postal_code]}),a.jsx("p",{children:D.shipping_address}),a.jsx("p",{children:D.shipping_phone})]})]})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("h3",{className:"font-semibold mb-3",children:"注文商品"}),a.jsx("div",{className:"space-y-3",children:D.order_items.map((e=>a.jsxs("div",{className:"flex items-center space-x-4 border-b pb-3",children:[a.jsx("img",{src:e.product.image_url,alt:e.product.name,className:"w-16 h-16 object-cover rounded"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h4",{className:"font-medium",children:e.product.name}),a.jsxs("p",{className:"text-sm text-gray-600",children:["¥",e.unit_price.toLocaleString()," × ",e.quantity]})]}),a.jsxs("p",{className:"font-medium",children:["¥",e.total_price.toLocaleString()]})]},e.id)))})]}),a.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[a.jsx("h3",{className:"font-semibold mb-3",children:"料金詳細"}),a.jsxs("div",{className:"space-y-2 text-sm",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"商品小計"}),a.jsxs("span",{children:["¥",D.total_amount.toLocaleString()]})]}),D.discount_amount>0&&a.jsxs("div",{className:"flex justify-between text-purple-600",children:[a.jsx("span",{children:"割引"}),a.jsxs("span",{children:["-¥",D.discount_amount.toLocaleString()]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"送料"}),a.jsx("span",{children:0===D.shipping_fee?"無料":`¥${D.shipping_fee.toLocaleString()}`})]}),a.jsx("hr",{className:"my-2"}),a.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[a.jsx("span",{children:"合計"}),a.jsxs("span",{className:"text-green-600",children:["¥",D.final_amount.toLocaleString()]})]})]})]}),a.jsxs("div",{className:"mt-6 flex justify-between",children:[a.jsx(N,{variant:"secondary",onClick:()=>$(null),children:"閉じる"}),D.can_cancel&&a.jsxs(N,{className:"bg-red-600 hover:bg-red-700",onClick:()=>{$(null),U(D.id)},children:[a.jsx(u,{className:"w-4 h-4 mr-2"}),"注文をキャンセル"]})]})]})})}),I&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[a.jsxs("div",{className:"text-center mb-6",children:[a.jsx(o,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"注文をキャンセルしますか？"}),a.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),a.jsxs("div",{className:"flex justify-end space-x-3",children:[a.jsx(N,{variant:"secondary",onClick:()=>U(null),children:"戻る"}),a.jsx(N,{className:"bg-red-600 hover:bg-red-700",isLoading:E,onClick:()=>(async e=>{try{J(!0),q(null),A(null);const{data:s,error:a}=await v.rpc("cancel_order",{order_id:e,user_id:null==y?void 0:y.id});if(a)throw a;if(!s.success)throw new Error(s.message||"キャンセルに失敗しました");A("注文をキャンセルしました"),U(null),await B(),setTimeout((()=>{A(null)}),3e3)}catch(s){q("注文のキャンセルに失敗しました。")}finally{J(!1)}})(I),children:"キャンセルする"})]})]})})]})}export{_ as OrderHistory};
