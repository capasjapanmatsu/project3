import{j as e,M as j,A as R,c as L,b as p,d as q,u as S,a as b,s as N}from"./ui-vendor-FlUr4cJt.js";import{u as B,r as m,L as O}from"./react-vendor-_GyjDmDn.js";import{I as o}from"./Input-wBkmcJUR.js";import{C as E,B as u,a as U,s as I}from"./index-BSYT0262.js";import{l as F,f as G}from"./postalCodeLookup-Dgm8Gdim.js";import"./supabase-vendor-Df9iqQzW.js";function V(){const y=B(),[v,l]=m.useState(!1),[h,r]=m.useState(""),[$,D]=m.useState(!1),[w,C]=m.useState(!1),[x,g]=m.useState(""),[f,k]=m.useState(!1),[s,n]=m.useState({email:"",password:"",confirmPassword:"",userType:"user",name:"",postalCode:"",address:"",phoneNumber:""}),M=a=>{const t=a.replace(/\D/g,"");return t.length<=7?t.length>3?t.slice(0,3)+"-"+t.slice(3):t:s.postalCode},T=a=>{const t=a.replace(/\D/g,"");return t.length<=11?t.length>7?t.slice(0,3)+"-"+t.slice(3,7)+"-"+t.slice(7):t.length>3?t.slice(0,3)+"-"+t.slice(3):t:s.phoneNumber},P=async a=>{const t=M(a);if(n({...s,postalCode:t}),t.replace(/-/g,"").length===7){C(!0),g("");try{const c=await F(t);if(c.success&&c.results&&c.results.length>0){const d=G(c.results[0]);n(i=>({...i,address:d}))}else g(c.message||"住所が見つかりませんでした")}catch(c){console.error("Error looking up postal code:",c),g("住所の検索中にエラーが発生しました")}finally{C(!1)}}},_=async a=>{if(a.preventDefault(),l(!0),r(""),!s.name.trim()){r("お名前を入力してください"),l(!1);return}if(!s.postalCode.trim()){r("郵便番号を入力してください"),l(!1);return}if(!s.address.trim()){r("住所を入力してください"),l(!1);return}if(!s.phoneNumber.trim()){r("電話番号を入力してください"),l(!1);return}if(!/^\d{3}-\d{4}$/.test(s.postalCode)){r("郵便番号は7桁の数字で入力してください（例：1234567）"),l(!1);return}if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(s.phoneNumber)){r("電話番号は正しい形式で入力してください（例：09012345678）"),l(!1);return}try{U("lastUsedEmail",s.email);const{error:d}=await I.auth.signInWithOtp({email:s.email,options:{emailRedirectTo:`${window.location.origin}/dashboard`,data:{user_type:s.userType,name:s.name,postal_code:s.postalCode,address:s.address,phone_number:s.phoneNumber}}});if(d)throw d;D(!0)}catch(d){const i=d.message||"";i.includes("already registered")||i.includes("already exists")||i.includes("User already")||i.includes("duplicate key")?r("このメールアドレスは既に登録されています"):r(i||"登録に失敗しました")}finally{l(!1)}},A=async a=>{if(a.preventDefault(),l(!0),r(""),!s.name.trim()){r("お名前を入力してください"),l(!1);return}if(!s.postalCode.trim()){r("郵便番号を入力してください"),l(!1);return}if(!s.address.trim()){r("住所を入力してください"),l(!1);return}if(!s.phoneNumber.trim()){r("電話番号を入力してください"),l(!1);return}if(!s.password){r("パスワードを入力してください"),l(!1);return}if(s.password.length<6){r("パスワードは6文字以上で入力してください"),l(!1);return}if(s.password!==s.confirmPassword){r("パスワードが一致しません"),l(!1);return}if(!/^\d{3}-\d{4}$/.test(s.postalCode)){r("郵便番号は7桁の数字で入力してください（例：1234567）"),l(!1);return}if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(s.phoneNumber)){r("電話番号は正しい形式で入力してください（例：09012345678）"),l(!1);return}try{U("lastUsedEmail",s.email);const{data:d,error:i}=await I.auth.signUp({email:s.email,password:s.password,options:{data:{user_type:s.userType,name:s.name,postal_code:s.postalCode,address:s.address,phone_number:s.phoneNumber}}});if(i)throw i;y("/two-factor-setup")}catch(d){const i=d.message||"";i.includes("already registered")||i.includes("already exists")||i.includes("User already")||i.includes("duplicate key")?r("このメールアドレスは既に登録されています"):r(i||"登録に失敗しました")}finally{l(!1)}};return $?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(E,{className:"text-center p-8",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(j,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"メールを確認してください"}),e.jsxs("p",{className:"text-gray-600 mb-4",children:[s.email,"にログインリンクを送信しました。メールを確認してリンクをクリックしてください。"]}),e.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"メールが届かない場合は、迷惑メールフォルダを確認するか、別のメールアドレスでお試しください。"}),e.jsx(u,{onClick:()=>y("/login"),children:"ログイン画面に戻る"})]})}):e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold text-center mb-8",children:"新規登録"}),e.jsxs(E,{children:[e.jsxs("div",{className:"flex justify-center mb-4 space-x-2",children:[e.jsx(u,{type:"button",onClick:()=>k(!1),variant:f?"secondary":"primary",children:"Magic Link"}),e.jsx(u,{type:"button",onClick:()=>k(!0),variant:f?"primary":"secondary",children:"パスワード"})]}),f?e.jsxs("form",{onSubmit:A,className:"p-6",children:[h&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(R,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:e.jsx("p",{children:h})})]}),e.jsx(o,{label:"お名前 *",value:s.name,onChange:a=>n({...s,name:a.target.value}),required:!0,placeholder:"山田太郎",icon:e.jsx(L,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(p,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:s.postalCode,onChange:a=>P(a.target.value),className:`w-full pl-10 pr-10 py-2 border ${x?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),w&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(q,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),x&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:x})]}),e.jsx(o,{label:"住所 *",value:s.address,onChange:a=>n({...s,address:a.target.value}),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(p,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"電話番号 *",type:"tel",value:s.phoneNumber,onChange:a=>{const t=T(a.target.value);n({...s,phoneNumber:t})},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:e.jsx(S,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"メールアドレス *",type:"email",value:s.email,onChange:a=>n({...s,email:a.target.value}),required:!0,placeholder:"example@email.com",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"パスワード *",type:"password",value:s.password,onChange:a=>n({...s,password:a.target.value}),required:!0,placeholder:"6文字以上",helperText:"6文字以上で入力してください",icon:e.jsx(N,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"パスワード確認 *",type:"password",value:s.confirmPassword,onChange:a=>n({...s,confirmPassword:a.target.value}),required:!0,placeholder:"パスワードを再入力",helperText:"パスワードを再入力してください",icon:e.jsx(N,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"user",checked:s.userType==="user",onChange:a=>n({...s,userType:a.target.value}),className:"mr-2"}),"利用者"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"owner",checked:s.userType==="owner",onChange:a=>n({...s,userType:a.target.value}),className:"mr-2"}),"施設オーナー"]})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(b,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-green-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"セキュリティ強化"}),e.jsx("p",{children:"パスワード登録後、2ファクタ認証（TOTP）の設定をお勧めします。Google Authenticatorなどの認証アプリでQRコードをスキャンするだけで簡単に設定できます。"})]})]})}),e.jsxs(u,{type:"submit",isLoading:v,className:"w-full",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"登録する"]})]}):e.jsxs("form",{onSubmit:_,className:"p-6",children:[h&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(R,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:e.jsx("p",{children:h})})]}),e.jsx(o,{label:"お名前 *",value:s.name,onChange:a=>n({...s,name:a.target.value}),required:!0,placeholder:"山田太郎",icon:e.jsx(L,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(p,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:s.postalCode,onChange:a=>P(a.target.value),className:`w-full pl-10 pr-10 py-2 border ${x?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),w&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(q,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),x&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:x})]}),e.jsx(o,{label:"住所 *",value:s.address,onChange:a=>n({...s,address:a.target.value}),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(p,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"電話番号 *",type:"tel",value:s.phoneNumber,onChange:a=>{const t=T(a.target.value);n({...s,phoneNumber:t})},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:e.jsx(S,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"メールアドレス *",type:"email",value:s.email,onChange:a=>n({...s,email:a.target.value}),required:!0,placeholder:"example@email.com",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"user",checked:s.userType==="user",onChange:a=>n({...s,userType:a.target.value}),className:"mr-2"}),"利用者"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"owner",checked:s.userType==="owner",onChange:a=>n({...s,userType:a.target.value}),className:"mr-2"}),"施設オーナー"]})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(b,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Magic Linkについて"}),e.jsx("p",{children:"登録後、入力したメールアドレスにログイン用のリンクが送信されます。リンクをクリックするだけで簡単にログインできます。"})]})]})}),e.jsxs(u,{type:"submit",isLoading:v,className:"w-full",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"登録する"]})]}),e.jsx("div",{className:"mt-4 text-center p-6",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["すでにアカウントをお持ちの方は",e.jsx(O,{to:"/login",className:"text-blue-600 hover:underline ml-1",children:"こちらからログイン"})]})})]})]})}export{V as Register};
