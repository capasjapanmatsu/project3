/*! Build: 2025-07-17T07:59:15.523Z
Version: 0.0.0 */
import{r as e}from"./vendor-react.D8SVeCGP.js";import{s as r,c as t,l as a,h as i,b as n,e as s}from"./utils.C9ZsMnW6.js";import{u as o}from"./components-admin.GT3qRZg5.js";import{l as c}from"./vendor-stripe.B5MJ2ewd.js";function d(){const{user:t}=o(),[a,i]=e.useState(null),[n,s]=e.useState(!0),[c,d]=e.useState(null),[l,u]=e.useState(!1);e.useEffect((()=>{t?m():(i(null),s(!1),u(!1))}),[t]);const m=async()=>{try{s(!0),d(null);const{data:e,error:t}=await r.from("stripe_user_subscriptions").select("*").maybeSingle();if(t)throw t;e?(i(e),u("paused"===e.status)):(i(null),u(!1))}catch(e){d(e.message||"サブスクリプションの取得に失敗しました")}finally{s(!1)}},_=e=>e?new Date(1e3*e).toLocaleDateString("ja-JP"):null;return{subscription:a,isActive:"active"===(null==a?void 0:a.status)||"trialing"===(null==a?void 0:a.status),isPaused:l,loading:n,error:c,refresh:m,currentPeriodEnd:_((null==a?void 0:a.current_period_end)??null),currentPeriodStart:_((null==a?void 0:a.current_period_start)??null),paymentMethod:(null==a?void 0:a.payment_method_last4)?`${a.payment_method_brand} **** ${a.payment_method_last4}`:null,willCancel:null==a?void 0:a.cancel_at_period_end}}const l={xs:0,sm:640,md:768,lg:1024,xl:1280,"2xl":1536};function u(r){const t=e.useMemo((()=>({...l,...r})),[r]),[a,i]=e.useState({width:"undefined"!=typeof window?window.innerWidth:1024,height:"undefined"!=typeof window?window.innerHeight:768}),[n,s]=e.useState("md");e.useEffect((()=>{const e=()=>{const e=window.innerWidth;i({width:e,height:window.innerHeight}),e>=t["2xl"]?s("2xl"):e>=t.xl?s("xl"):e>=t.lg?s("lg"):e>=t.md?s("md"):e>=t.sm?s("sm"):s("xs")};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]);const o=e=>a.width>=t[e],c=e=>a.width<t[e],d=(e,r)=>a.width>=t[e]&&a.width<t[r],u=c("md"),m=d("md","lg"),_=o("lg"),g="ontouchstart"in window||navigator.maxTouchPoints>0,p="undefined"!=typeof window&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,f="undefined"!=typeof window&&window.matchMedia("(prefers-color-scheme: dark)").matches;return{windowSize:a,currentBreakpoint:n,breakpoints:t,isAbove:o,isBelow:c,isBetween:d,isMobile:u,isTablet:m,isDesktop:_,isTouchDevice:g,prefersReducedMotion:p,prefersDarkMode:f}}function m(){const[t,a]=e.useState(!1),[i,n]=e.useState(null);return{createCheckoutSession:e.useCallback((async({priceId:e,mode:t,successUrl:i=`${window.location.origin}/payment-confirmation?success=true`,cancelUrl:s=`${window.location.origin}/payment-confirmation?canceled=true`,customAmount:o,customName:d,customParams:l,cartItems:u})=>{a(!0),n(null);try{const{data:{session:a}}=await r.auth.getSession();if(!(null==a?void 0:a.access_token))throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:a.user.id,user_email:a.user.email,timestamp:Date.now(),return_url:window.location.href}));const n={mode:t,success_url:i,cancel_url:s};e&&(n.price_id=e),o&&d&&(n.custom_amount=o,n.custom_name=d),u&&u.length>0&&(n.cart_items=u),l&&Object.entries(l).forEach((([e,r])=>{n[e]=r}));const m=await fetch("/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`},body:JSON.stringify(n)});if(!m.ok){const e=await m.json();throw new Error(e.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:_,url:g}=await m.json();if(g)return void(window.location.href=g);if(!_)throw new Error("チェックアウトURLが取得できませんでした");{const e="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",r=await c(e);if(!r)throw new Error("Stripeの読み込みに失敗しました");const{error:t}=await r.redirectToCheckout({sessionId:_});if(t)throw t}}catch(m){throw n(m.message||"チェックアウトに失敗しました"),m}finally{a(!1)}}),[]),loading:t,error:i}}function _(){const[r,a]=e.useState(null),[i,n]=e.useState(!1),[s,o]=e.useState(null),c=e.useCallback((()=>{a(null),o(null)}),[]),d=e.useCallback((e=>{if(e instanceof Error){const r=e.message.toLowerCase();if(r.includes("network")||r.includes("fetch")||r.includes("connection"))return{type:"network",severity:"medium",message:e.message,originalError:e,userMessage:"ネットワーク接続に問題があります。インターネット接続を確認してください。",recoverable:!0,retryable:!0};if(r.includes("timeout")||r.includes("timed out")||"AbortError"===e.name)return{type:"timeout",severity:"medium",message:e.message,originalError:e,userMessage:"リクエストがタイムアウトしました。もう一度お試しください。",recoverable:!0,retryable:!0};if(r.includes("jwt")||r.includes("unauthorized")||r.includes("refresh_token"))return{type:"authentication",severity:"high",message:e.message,originalError:e,userMessage:"セッションが期限切れです。再度ログインしてください。",recoverable:!0,retryable:!1};if(r.includes("forbidden")||r.includes("permission")||r.includes("row-level security"))return{type:"authorization",severity:"high",message:e.message,originalError:e,userMessage:"この操作を実行する権限がありません。",recoverable:!1,retryable:!1};if(r.includes("validation")||r.includes("invalid")||r.includes("required"))return{type:"validation",severity:"low",message:e.message,originalError:e,userMessage:"入力内容に問題があります。確認してください。",recoverable:!0,retryable:!1};if(r.includes("storage")||r.includes("bucket")||r.includes("file"))return{type:"storage",severity:"medium",message:e.message,originalError:e,userMessage:"ファイルの処理中にエラーが発生しました。しばらく待ってから再度お試しください。",recoverable:!0,retryable:!0};if(r.includes("payment")||r.includes("stripe")||r.includes("subscription"))return{type:"payment",severity:"high",message:e.message,originalError:e,userMessage:"決済処理中にエラーが発生しました。カード情報を確認してください。",recoverable:!0,retryable:!0};if(r.includes("500")||r.includes("502")||r.includes("503")||r.includes("520"))return{type:"server",severity:"high",message:e.message,originalError:e,userMessage:"サーバーで一時的な問題が発生しています。しばらく待ってから再度お試しください。",recoverable:!0,retryable:!0};if(r.includes("404")||r.includes("not found"))return{type:"not_found",severity:"medium",message:e.message,originalError:e,userMessage:"要求されたリソースが見つかりません。",recoverable:!1,retryable:!1}}if("object"==typeof e&&null!==e&&"code"in e){const r=t(e);return{type:"server",severity:"medium",message:r,originalError:e,userMessage:r,recoverable:!0,retryable:!0}}return{type:"unknown",severity:"medium",message:e instanceof Error?e.message:String(e),originalError:e,userMessage:"予期しないエラーが発生しました。しばらく待ってから再度お試しください。",recoverable:!0,retryable:!0}}),[]),l=e.useCallback((e=>{e.severity}),[]),u=e.useCallback(((e,r)=>{const t={...d(e),timestamp:new Date,...r&&{context:r}};l(t),a(t)}),[d,l]),m=e.useCallback((async(e,r)=>{n(!0),c();try{const r=await e();return n(!1),r}catch(t){return u(t,r),n(!1),d(t).retryable&&o((()=>async()=>{await m(e,r)})),null}}),[u,c,d]);return{error:r,isLoading:i,clearError:c,handleError:u,retryAction:s,executeWithErrorHandling:m}}const g={maxAttempts:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2,retryableErrors:["network","timeout","server","storage"],autoRetry:!0};function p(r={}){const t={...g,...r},[a,i]=e.useState({attempts:0,isRetrying:!1,lastError:null,nextRetryIn:0}),n=e.useRef(),s=e.useRef(),o=e.useCallback((()=>{n.current&&clearTimeout(n.current),s.current&&clearInterval(s.current),i({attempts:0,isRetrying:!1,lastError:null,nextRetryIn:0})}),[]),c=e.useCallback((()=>{n.current&&clearTimeout(n.current),s.current&&clearInterval(s.current),i((e=>({...e,isRetrying:!1,nextRetryIn:0})))}),[]),d=e.useCallback((e=>{const r=t.baseDelay*Math.pow(t.backoffFactor,e);return Math.min(r,t.maxDelay)}),[t]),l=e.useCallback((e=>{const r=e.message.toLowerCase();return!!(t.retryableErrors.includes("network")&&(r.includes("network")||r.includes("fetch")||r.includes("connection"))||t.retryableErrors.includes("timeout")&&(r.includes("timeout")||r.includes("timed out")||"AbortError"===e.name)||t.retryableErrors.includes("server")&&(r.includes("500")||r.includes("502")||r.includes("503")||r.includes("520"))||t.retryableErrors.includes("storage")&&(r.includes("storage")||r.includes("bucket")))}),[t.retryableErrors]),u=e.useCallback(((e,r)=>{let t=Math.ceil(e/1e3);i((e=>({...e,nextRetryIn:t}))),s.current=setInterval((()=>{t--,i((e=>({...e,nextRetryIn:t}))),t<=0&&(s.current&&clearInterval(s.current),r())}),1e3)}),[]),m=e.useCallback((async(e,r=0)=>{try{i((e=>({...e,attempts:r,lastError:null})));const t=await e();return o(),t}catch(a){const s=a instanceof Error?a:new Error(String(a));if(i((e=>({...e,lastError:s}))),r>=t.maxAttempts-1)throw i((e=>({...e,isRetrying:!1}))),s;if(!l(s))throw i((e=>({...e,isRetrying:!1}))),s;if(!t.autoRetry)throw i((e=>({...e,isRetrying:!1}))),s;const o=d(r);return i((e=>({...e,isRetrying:!0}))),new Promise(((t,a)=>{u(o,(()=>{n.current=setTimeout((()=>{m(e,r+1).then(t).catch(a)}),0)}))}))}}),[t,l,d,o,u]);return{execute:e.useCallback((e=>m(e,0)),[m]),state:a,reset:o,cancelRetry:c}}const f={api:{maxAttempts:3,baseDelay:1e3,maxDelay:5e3,backoffFactor:1.5,retryableErrors:["network","timeout","server"],autoRetry:!0}},w=()=>{const[t,a]=e.useState(!1);return{isProcessing:t,handleVaccineApproval:async(e,t,i)=>{try{a(!0);const{data:n,error:s}=await r.from("vaccine_certifications").select("*, dog:dogs(name, owner_id)").eq("id",e).single();if(s)throw s;const o=n,c={status:t?"approved":"rejected"};t&&(c.approved_at=(new Date).toISOString());const{error:d}=await r.from("vaccine_certifications").update(c).eq("id",e);if(d)throw new Error(`ワクチン証明書の更新に失敗しました: ${d.message}`);const l=o.rabies_vaccine_image,u=o.combo_vaccine_image;return((null==l?void 0:l.includes("/temp/"))||(null==u?void 0:u.includes("/temp/")))&&await(async e=>{const t=[];if(e.rabies_vaccine_image){let r="";if(e.rabies_vaccine_image.includes("/temp/")){const t=e.rabies_vaccine_image.match(/temp\/[^\/]+\/[^\/\?]+/);t&&(r=t[0])}r&&t.push(r)}if(e.combo_vaccine_image){let r="";if(e.combo_vaccine_image.includes("/temp/")){const t=e.combo_vaccine_image.match(/temp\/[^\/]+\/[^\/\?]+/);t&&(r=t[0])}r&&t.push(r)}if(t.length>0)try{const{error:e}=await r.storage.from("vaccine-certs").remove(t)}catch(a){}})(o),await(async(e,t,a)=>{const{error:i}=await r.from("notifications").insert([{user_id:e.dog.owner_id,type:"vaccine_approval_required",title:t?"ワクチン証明書承認のお知らせ":"ワクチン証明書却下のお知らせ",message:t?`${e.dog.name}ちゃんのワクチン証明書が承認されました。ドッグランを利用できるようになりました。`:`${e.dog.name}ちゃんのワクチン証明書が却下されました。${a?`理由: ${a}`:"詳細はマイページをご確認ください。"}`,data:{dog_id:e.dog_id}}]);if(i)throw new Error(`通知の作成に失敗しました: ${i.message}`)})(o,t,i),{success:!0,message:`ワクチン証明書を${t?"承認":"却下"}しました`}}catch(n){return{success:!1,message:`承認処理に失敗しました: ${n.message}`}}finally{a(!1)}},handleParkApproval:async(e,t,i)=>{try{a(!0);const n={status:t?"approved":"rejected"};t&&(n.approved_at=(new Date).toISOString());const{error:s}=await r.from("dog_parks").update(n).eq("id",e);if(s)throw s;return await(async(e,t,a)=>{let i={};const{data:n,error:s}=await r.from("dog_park_review_stages").select("id").eq("park_id",e).maybeSingle();if(s)throw s;if(n){t?i.first_stage_passed_at=(new Date).toISOString():(i.rejected_at=(new Date).toISOString(),(null==a?void 0:a.trim())&&(i.rejection_reason=a.trim()));const{error:n}=await r.from("dog_park_review_stages").update(i).eq("park_id",e);if(n)throw n}else{i={park_id:e,first_stage_passed_at:(new Date).toISOString()},t?i.first_stage_passed_at=(new Date).toISOString():(i.rejected_at=(new Date).toISOString(),(null==a?void 0:a.trim())&&(i.rejection_reason=a.trim()));const{error:n}=await r.from("dog_park_review_stages").insert([i]);if(n)throw n}})(e,t,i),await(async(e,t,a)=>{const{data:i,error:n}=await r.from("dog_parks").select("id, name, owner_id").eq("id",e).single();if(n)throw n;const{error:s}=await r.from("notifications").insert([{user_id:i.owner_id,type:"park_approval_required",title:t?"施設承認のお知らせ":"審査結果のお知らせ",message:t?`${i.name}の審査が完了し、承認されました。おめでとうございます！`:`${i.name}の審査結果をお知らせします。${a?`理由: ${a}`:"詳細はオーナーダッシュボードをご確認ください。"}`,data:{park_id:i.id}}]);if(s)throw new Error(`施設通知の作成に失敗しました: ${s.message}`)})(e,t,i),{success:!0,message:`施設を${t?"承認":"却下"}しました`}}catch(n){return{success:!1,message:"承認処理に失敗しました"}}finally{a(!1)}},handleImageApproval:async(e,t,i)=>{try{a(!0);const n={is_approved:t};!t&&(null==i?void 0:i.trim())?n.admin_notes=i.trim():n.admin_notes=null;const{error:s}=await r.from("dog_park_facility_images").update(n).eq("id",e.id);if(s)throw s;return{success:!0,message:`画像を${t?"承認":"却下"}しました`}}catch(n){return{success:!1,message:"画像の承認処理に失敗しました"}}finally{a(!1)}},handleVaccineExpiryUpdate:async(e,t,i)=>{try{a(!0);const n={};void 0!==t&&(n.rabies_expiry_date=t),void 0!==i&&(n.combo_expiry_date=i);const{error:s}=await r.from("vaccine_certifications").update(n).eq("id",e);if(s)throw new Error(`有効期限の更新に失敗しました: ${s.message}`);return{success:!0,message:"有効期限を更新しました"}}catch(n){return{success:!1,message:`有効期限の更新に失敗しました: ${n.message}`}}finally{a(!1)}}}},y=t=>{const[o,c]=e.useState([]),[d,l]=e.useState([]),[u,m]=e.useState(!0),[_,g]=e.useState(""),[p,f]=e.useState(""),w=async()=>{try{m(!0),g(""),"parks"===t?await(async()=>{try{a("info","🔍 Fetching pending parks...");const e=await n((()=>r.from("dog_parks").select("\n            id,\n            name,\n            address,\n            status,\n            created_at,\n            owner_id,\n            description,\n            price,\n            max_capacity,\n            large_dog_area,\n            small_dog_area,\n            private_booths,\n            private_booth_count,\n            facilities,\n            facility_details,\n            image_url,\n            cover_image_url,\n            average_rating,\n            review_count\n          ").in("status",["pending","first_stage_passed","second_stage_review"]).order("created_at",{ascending:!1})));if(e.error)throw a("error","❌ Parks fetch error:",e.error),e.error;const t=e.data||[];if(0===t.length)return a("info","ℹ️ No pending parks found"),void c([]);a("info",`✅ Found ${t.length} pending parks`);const i=[...new Set(t.map((e=>e.owner_id)))],s=t.map((e=>e.id)),[o,d,l,u]=await Promise.allSettled([i.length>0?r.from("profiles").select("id, name, postal_code, address, phone_number, email").in("id",i):Promise.resolve({data:[],error:null}),s.length>0?r.from("dog_park_review_stages").select("park_id, second_stage_submitted_at").in("park_id",s):Promise.resolve({data:[],error:null}),s.length>0?r.from("dog_park_facility_images").select("id, park_id, image_type, image_url, is_approved, admin_notes, created_at, updated_at").in("park_id",s):Promise.resolve({data:[],error:null}),i.length>0?r.from("owner_verifications").select("user_id, verification_id, status, verification_data, created_at").in("user_id",i):Promise.resolve({data:[],error:null})]),m="fulfilled"===o.status&&o.value.data||[],_=new Map(m.map((e=>[e.id,e]))),g="fulfilled"===d.status&&d.value.data||[],p=new Map(g.map((e=>[e.park_id,e]))),f="fulfilled"===l.status&&l.value.data||[],w=new Map;f.forEach((e=>{w.has(e.park_id)||w.set(e.park_id,[]),w.get(e.park_id).push(e)}));const y="fulfilled"===u.status&&u.value.data||[],v=new Map(y.map((e=>[e.user_id,e]))),h=t.map((e=>{const r=_.get(e.owner_id),t=p.get(e.id),a=w.get(e.id)||[],i=v.get(e.owner_id),n=a.length,s=a.filter((e=>!0===e.is_approved)).length,o=a.filter((e=>!1===e.is_approved)).length,c=a.filter((e=>null===e.is_approved)).length;let d="",l="";return i&&i.verification_data&&"object"==typeof i.verification_data&&(d=i.verification_data.document_url||i.verification_data.file_path||"",l=i.verification_data.file_name||i.verification_data.filename||""),!d&&(null==i?void 0:i.verification_id)&&(d=i.verification_id),!l&&d&&(l=d.split("/").pop()||"identity_document"),{id:e.id,name:e.name,address:e.address,status:e.status,created_at:e.created_at,owner_id:e.owner_id,owner_name:(null==r?void 0:r.name)||"Unknown Owner",second_stage_submitted_at:(null==t?void 0:t.second_stage_submitted_at)||null,total_images:n,approved_images:s,rejected_images:o,pending_images:c,owner_postal_code:(null==r?void 0:r.postal_code)||"",owner_address:(null==r?void 0:r.address)||"",owner_phone_number:(null==r?void 0:r.phone_number)||"",owner_email:(null==r?void 0:r.email)||"",identity_document_url:d,identity_document_filename:l,identity_status:(null==i?void 0:i.status)||"not_submitted",identity_created_at:(null==i?void 0:i.created_at)||"",description:e.description||"",price:e.price||0,max_capacity:e.max_capacity||0,large_dog_area:e.large_dog_area||!1,small_dog_area:e.small_dog_area||!1,private_booths:e.private_booths||!1,private_booth_count:e.private_booth_count||0,facilities:e.facilities||{parking:!1,shower:!1,restroom:!1,agility:!1,rest_area:!1,water_station:!1},facility_details:e.facility_details||"",image_url:e.image_url||"",cover_image_url:e.cover_image_url||"",average_rating:e.average_rating||0,review_count:e.review_count||0,facility_images:a}}));a("info",`✅ Transformed ${h.length} parks with image data`),c(h)}catch(e){a("error","❌ Error fetching parks:",{error:i(e)}),g(`ドッグラン申請データの取得に失敗しました: ${i(e)}`)}})():"vaccines"===t&&await(async()=>{try{a("info","🔍 Fetching pending vaccines..."),await s();const e=await n((()=>r.from("vaccine_certifications").select("\n            id,\n            dog_id,\n            rabies_vaccine_image,\n            combo_vaccine_image,\n            rabies_expiry_date,\n            combo_expiry_date,\n            status,\n            created_at,\n            dog:dogs (\n              id,\n              name,\n              breed,\n              gender,\n              birth_date,\n              owner:profiles (\n                id,\n                name\n              )\n            )\n          ").eq("status","pending").order("created_at",{ascending:!1})));if(e.error)throw a("error","❌ Vaccines fetch error:",e.error),e.error;const t=e.data||[];if(0===t.length)return a("info","ℹ️ No pending vaccines found"),void l([]);a("info",`✅ Found ${t.length} pending vaccines`);const i=t.map((e=>{const r=Array.isArray(e.dog)?e.dog[0]:e.dog,t=r?Array.isArray(r.owner)?r.owner[0]:r.owner:null;return r&&t?{id:e.id,dog_id:e.dog_id,rabies_vaccine_image:e.rabies_vaccine_image,combo_vaccine_image:e.combo_vaccine_image,rabies_expiry_date:e.rabies_expiry_date,combo_expiry_date:e.combo_expiry_date,status:e.status,created_at:e.created_at,dog:{id:r.id,name:r.name,breed:r.breed,gender:r.gender,birth_date:r.birth_date,owner:{id:t.id,name:t.name}}}:(a("warn","❌ Invalid vaccine data:",{vaccine:e}),null)})).filter((e=>null!==e));l(i)}catch(e){a("error","❌ Error fetching vaccines:",{error:i(e)}),g(`ワクチン証明書データの取得に失敗しました: ${i(e)}`)}})()}catch(e){a("error","❌ Error in fetchData:",{error:i(e)}),g(`データの取得に失敗しました: ${i(e)}`)}finally{m(!1)}};return e.useEffect((()=>{w()}),[t]),{pendingParks:o,pendingVaccines:d,isLoading:u,error:_,success:p,refetch:w}},v=t=>{const[s,o]=e.useState([]),[c,d]=e.useState(!1),[l,u]=e.useState(""),m=async e=>{try{d(!0),u(""),a("info",`🔍 Fetching images for park: ${e}`);const t=await n((()=>r.from("dog_park_facility_images").select("*").eq("park_id",e).order("created_at",{ascending:!1})));if(t.error)throw a("error","❌ Images fetch error:",t.error),t.error;const i=t.data||[];a("info",`✅ Found ${i.length} images for park ${e}`),o(i)}catch(t){a("error","❌ Error fetching park images:",{error:i(t)}),u(`画像データの取得に失敗しました: ${i(t)}`)}finally{d(!1)}};return e.useEffect((()=>{t&&m(t)}),[t]),{parkImages:s,isLoading:c,error:l,fetchParkImages:m}};export{v as a,y as b,d as c,m as d,_ as e,p as f,u as g,f as r,w as u};
