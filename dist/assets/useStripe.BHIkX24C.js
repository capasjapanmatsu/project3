import{r as e}from"./vendor.CKEClKZl.js";import{s as t}from"./index.CQlxbczY.js";import{l as r}from"./stripe.CcgPsVUa.js";function o(){const[o,s]=e.useState(!1),[n,i]=e.useState(null);return{createCheckoutSession:e.useCallback(e=>{return o=this,n=[e],c=function*({priceId:e,mode:o,successUrl:n=`${window.location.origin}/payment-confirmation?success=true`,cancelUrl:c=`${window.location.origin}/payment-confirmation?canceled=true`,customAmount:a,customName:u,customParams:l,cartItems:m}){s(!0),i(null);try{const{data:{session:s}}=yield t.auth.getSession();if(!(null==s?void 0:s.access_token))throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:s.user.id,user_email:s.user.email,timestamp:Date.now(),return_url:window.location.href}));const i={mode:o,success_url:n,cancel_url:c};e&&(i.price_id=e),a&&u&&(i.custom_amount=a,i.custom_name=u),m&&m.length>0&&(i.cart_items=m),l&&Object.entries(l).forEach(([e,t])=>{i[e]=t});const d=yield fetch("/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify(i)});if(!d.ok){const e=yield d.json();throw new Error(e.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:h,url:p}=yield d.json();if(p)return void(window.location.href=p);if(!h)throw new Error("チェックアウトURLが取得できませんでした");{const e="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",t=yield r(e);if(!t)throw new Error("Stripeの読み込みに失敗しました");const{error:o}=yield t.redirectToCheckout({sessionId:h});if(o)throw o}}catch(d){throw i(d.message||"チェックアウトに失敗しました"),d}finally{s(!1)}},new Promise((e,t)=>{var r=e=>{try{i(c.next(e))}catch(r){t(r)}},s=e=>{try{i(c.throw(e))}catch(r){t(r)}},i=t=>t.done?e(t.value):Promise.resolve(t.value).then(r,s);i((c=c.apply(o,n)).next())});var o,n,c},[]),loading:o,error:n}}export{o as u};
