var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,l=(e,t)=>{for(var s in t||(t={}))a.call(t,s)&&i(e,s,t[s]);if(r)for(var s of r(t))n.call(t,s)&&i(e,s,t[s]);return e},o=(e,r)=>t(e,s(r)),c=(e,t,s)=>new Promise((r,a)=>{var n=e=>{try{l(s.next(e))}catch(t){a(t)}},i=e=>{try{l(s.throw(e))}catch(t){a(t)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,i);l((s=s.apply(e,t)).next())});import{u as d,s as m,l as x,E as u,k as f,j as h,C as p,B as g}from"./index.CQlxbczY.js";import{r as j}from"./vendor.CKEClKZl.js";import{u as y,L as b}from"./router.B_7Atevv.js";import{I as w}from"./Input.DMWrIIWM.js";import{S as v}from"./Select.DfMWSl4f.js";import{B as N,p as _,A as k,g as S,w as E,X as P,T as C,m as O,F as q,z as D}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";function I(){const{user:e}=d(),[t,s]=j.useState([]),[r,a]=j.useState({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),[n,i]=j.useState(null),[y,b]=j.useState(!1),[D,I]=j.useState(!1),[T,A]=j.useState(""),[L,$]=j.useState("");j.useEffect(()=>{F(),z()},[]);const z=()=>c(this,null,function*(){if(e)try{const{data:t,error:s}=yield m.from("profiles").select("*").eq("id",e.id).single();if(s&&"PGRST116"===s.code){const{data:t,error:s}=yield m.from("profiles").insert([{id:e.id,user_type:"admin",name:e.email||"Admin User",email:e.email}]).select().single();s?(x("error","Error creating admin profile:",{createError:s}),A("管理者プロファイルの作成に失敗しました。")):(x("info","Admin profile created successfully:",{newProfile:t}),$("管理者プロファイルを作成しました。"),setTimeout(()=>$(""),3e3))}else if(s)x("error","Error fetching user profile:",{error:s}),A("ユーザープロファイルの取得に失敗しました。");else if(!t||"admin"!==t.user_type){x("info","Updating user to admin...");const{error:t}=yield m.from("profiles").update({user_type:"admin"}).eq("id",e.id);t?(x("error","Error updating user to admin:",{updateError:t}),A("管理者権限の設定に失敗しました。")):(x("info","User updated to admin successfully"),$("管理者権限を設定しました。ページを手動でリロードしてください。"),setTimeout(()=>$(""),5e3))}}catch(t){x("error","Error checking user profile:",{error:u(t)}),A("ユーザープロファイルの確認に失敗しました。")}}),F=()=>c(this,null,function*(){try{const e=yield f(()=>m.from("news_announcements").select("*").order("created_at",{ascending:!1}));if(e.error)throw e.error;s(e.data||[]),A("")}catch(e){x("error","Error fetching news:",{error:u(e)}),A("新着情報の取得に失敗しました。")}}),J=e=>c(this,null,function*(){if(confirm("この新着情報を削除してもよろしいですか？"))try{I(!0),A("");const{error:t}=yield m.from("news_announcements").delete().eq("id",e);if(t)throw t;$("新着情報を削除しました。"),yield F(),setTimeout(()=>{$("")},3e3)}catch(t){x("error","Error deleting news:",{error:u(t)}),A("新着情報の削除に失敗しました。")}finally{I(!1)}}),U=e=>({news:"お知らせ",announcement:"重要なお知らせ",sale:"セール情報"}[e]||e),B=e=>{switch(e){case"news":return h.jsx(q,{className:"w-4 h-4"});case"announcement":return h.jsx(O,{className:"w-4 h-4"});case"sale":return h.jsx(C,{className:"w-4 h-4"});default:return h.jsx(N,{className:"w-4 h-4"})}};return h.jsxs(h.Fragment,{children:[h.jsxs(p,{className:"p-6",children:[h.jsxs("div",{className:"flex justify-between items-center mb-4",children:[h.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[h.jsx(N,{className:"w-5 h-5 text-blue-600 mr-2"}),"新着情報管理"]}),h.jsxs(g,{onClick:()=>{i(null),a({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),b(!0)},children:[h.jsx(_,{className:"w-4 h-4 mr-2"}),"新着情報を追加"]})]}),T&&h.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start",children:[h.jsx(k,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),h.jsx("p",{className:"text-red-800",children:T})]}),L&&h.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start",children:[h.jsx(S,{className:"w-5 h-5 text-green-600 mt-0.5 mr-2 flex-shrink-0"}),h.jsx("p",{className:"text-green-800",children:L})]}),h.jsx("div",{className:"space-y-4",children:0===t.length?h.jsx("div",{className:"text-center py-8 text-gray-500",children:"新着情報がありません"}):t.map(e=>{return h.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:h.jsxs("div",{className:"flex justify-between items-start",children:[h.jsxs("div",{className:"flex-1",children:[h.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[h.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${t=e.category,{news:"bg-blue-100 text-blue-800",announcement:"bg-red-100 text-red-800",sale:"bg-green-100 text-green-800"}[t]||"bg-gray-100 text-gray-800"}`,children:[B(e.category),h.jsx("span",{children:U(e.category)})]}),e.is_important&&h.jsx("span",{className:"bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium",children:"重要"})]}),h.jsx("h3",{className:"font-bold text-lg mb-2",children:e.title}),h.jsx("p",{className:"text-sm text-gray-700 mb-2 line-clamp-2",children:e.content}),h.jsxs("div",{className:"text-xs text-gray-500",children:["作成日: ",new Date(e.created_at).toLocaleString("ja-JP"),e.updated_at!==e.created_at&&h.jsxs("span",{children:[" / 更新日: ",new Date(e.updated_at).toLocaleString("ja-JP")]})]})]}),h.jsxs("div",{className:"flex space-x-2 ml-4",children:[h.jsxs(g,{variant:"secondary",size:"sm",onClick:()=>(e=>{i(e),a({title:e.title,content:e.content,category:e.category,is_important:e.is_important||!1,image_url:"",link_url:""}),b(!0)})(e),disabled:D,children:[h.jsx(E,{className:"w-4 h-4 mr-1"}),"編集"]}),h.jsxs(g,{variant:"danger",size:"sm",onClick:()=>J(e.id),disabled:D,children:[h.jsx(P,{className:"w-4 h-4 mr-1"}),"削除"]})]})]})},e.id);var t})})]}),y&&h.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:h.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:h.jsxs("div",{className:"p-6",children:[h.jsxs("div",{className:"flex justify-between items-center mb-6",children:[h.jsx("h2",{className:"text-xl font-bold",children:n?"新着情報を編集":"新着情報を追加"}),h.jsx("button",{onClick:()=>b(!1),className:"text-gray-500 hover:text-gray-700",disabled:D,children:h.jsx(P,{className:"w-6 h-6"})})]}),h.jsxs("form",{onSubmit:t=>c(this,null,function*(){if(t.preventDefault(),r.title.trim())if(r.content.trim())if(e)try{I(!0),A(""),$("");const{data:t,error:s}=yield m.from("profiles").select("*").eq("id",e.id).single(),l={title:r.title,content:r.content,category:r.category,is_important:r.is_important,created_by:null==e?void 0:e.id};if(n){const{error:e}=yield m.from("news_announcements").update({title:r.title,content:r.content,category:r.category,is_important:r.is_important,updated_at:(new Date).toISOString()}).eq("id",n.id);if(e)throw e;$("新着情報を更新しました。")}else{x("info","Attempting to insert new announcement...");const{data:e,error:t}=yield m.from("news_announcements").insert([l]).select();if(x("info","Insert result:",{insertResult:e}),t)throw x("error","Insert error details:",{message:t.message,details:t.details,hint:t.hint,code:t.code}),t;$("新着情報を追加しました。")}a({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),i(null),b(!1),yield F(),setTimeout(()=>{$("")},3e3)}catch(s){x("error"),x("error","Error saving news:",{error:u(s)});let e="新着情報の保存に失敗しました。";s&&"object"==typeof s&&("message"in s&&"string"==typeof s.message&&(e+=` エラー詳細: ${s.message}`),"details"in s&&"string"==typeof s.details&&(e+=` 詳細: ${s.details}`),"hint"in s&&"string"==typeof s.hint&&(e+=` ヒント: ${s.hint}`),"code"in s&&(e+=` コード: ${s.code}`)),A(e)}finally{I(!1)}else A("ユーザーが認証されていません。ログインしてください。");else A("内容を入力してください。");else A("タイトルを入力してください。")}),children:[h.jsxs("div",{className:"space-y-4",children:[h.jsx(w,{label:"タイトル *",value:r.title,onChange:e=>a(o(l({},r),{title:e.target.value})),required:!0,disabled:D}),h.jsxs("div",{children:[h.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容 *"}),h.jsx("textarea",{value:r.content,onChange:e=>a(o(l({},r),{content:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:6,required:!0,disabled:D})]}),h.jsx(v,{label:"カテゴリー *",options:[{value:"news",label:"お知らせ"},{value:"announcement",label:"重要なお知らせ"},{value:"sale",label:"セール情報"}],value:r.category,onChange:e=>a(o(l({},r),{category:e.target.value})),required:!0,disabled:D}),h.jsxs("div",{className:"flex items-center space-x-2",children:[h.jsx("input",{type:"checkbox",id:"is_important",checked:r.is_important,onChange:e=>a(o(l({},r),{is_important:e.target.checked})),className:"rounded text-blue-600",disabled:D}),h.jsx("label",{htmlFor:"is_important",className:"text-sm text-gray-700",children:"重要なお知らせとして表示する"})]})]}),h.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[h.jsx(g,{type:"button",variant:"secondary",onClick:()=>b(!1),disabled:D,children:"キャンセル"}),h.jsx(g,{type:"submit",isLoading:D,children:n?"更新する":"追加する"})]})]})]})})})]})}function T(){const{user:e,isAdmin:t}=d(),s=y();return j.useEffect(()=>{t||s("/")},[t,s]),h.jsxs("div",{className:"space-y-6",children:[h.jsxs("div",{className:"flex items-center justify-between",children:[h.jsxs("div",{className:"flex items-center space-x-4",children:[h.jsx(b,{to:"/admin",children:h.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:h.jsx(D,{className:"w-5 h-5"})})}),h.jsxs("div",{children:[h.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[h.jsx(N,{className:"w-8 h-8 text-yellow-600 mr-3"}),"新着情報管理"]}),h.jsx("p",{className:"text-gray-600",children:"サイトの新着情報を管理します"})]})]}),h.jsxs("div",{className:"text-sm text-gray-500",children:["最終更新: ",(new Date).toLocaleString("ja-JP")]})]}),h.jsx(I,{})]})}export{T as AdminNewsManagement};
