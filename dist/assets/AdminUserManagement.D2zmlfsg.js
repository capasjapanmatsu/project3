var e=(e,s,t)=>new Promise(((a,r)=>{var n=e=>{try{c(t.next(e))}catch(s){r(s)}},l=e=>{try{c(t.throw(e))}catch(s){r(s)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,l);c((t=t.apply(e,s)).next())}));import{u as s,s as t,j as a,C as r,B as n}from"./index.D9xag4tn.js";import{u as l,r as c,L as i}from"./router.BWT_vQps.js";import{I as d}from"./Input.tFQgyGuP.js";import{A as x,aa as o,ab as m,C as u,c as h,a4 as p,i as j,M as g,P as f,D as v,o as y,ac as N}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function w(){const{isAdmin:w}=s(),_=l(),[b,S]=c.useState([]),[k,D]=c.useState([]),[C,L]=c.useState(!0),[P,$]=c.useState(""),[E,I]=c.useState(""),[U,q]=c.useState("all"),[J,M]=c.useState("created_at"),[O,z]=c.useState("desc");c.useEffect((()=>{w?A():_("/")}),[w,_]),c.useEffect((()=>{B()}),[b,E,U,J,O]);const A=()=>e(null,null,(function*(){try{L(!0),$("");const{data:s,error:a}=yield t.from("profiles").select("\n          id,\n          name,\n          user_type,\n          postal_code,\n          address,\n          phone_number,\n          created_at\n        ");if(a)throw new Error("プロファイル情報の取得に失敗しました");if(!s||0===s.length)return void S([]);const r=s.map((s=>e(null,null,(function*(){try{const{count:e}=yield t.from("dogs").select("id",{count:"exact"}).eq("owner_id",s.id),a=new Date;a.setDate(1),a.setHours(0,0,0,0);const{count:r}=yield t.from("reservations").select("id",{count:"exact"}).eq("user_id",s.id).gte("created_at",a.toISOString()),{data:n}=yield t.from("reservations").select("total_amount").eq("user_id",s.id).not("total_amount","is",null),l=(n||[]).reduce(((e,s)=>e+(s.total_amount||0)),0),c=`user_${s.id.slice(0,8)}@unknown.com`;return{id:s.id,name:s.name||"Unknown",email:c,phone:s.phone_number||"",created_at:s.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:e||0,reservation_count:r||0,total_spent:l}}catch(e){return{id:s.id,name:s.name||"Unknown",email:`user_${s.id.slice(0,8)}@unknown.com`,phone:s.phone_number||"",created_at:s.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:0,reservation_count:0,total_spent:0}}})))),n=yield Promise.all(r);S(n)}catch(s){$(s instanceof Error?s.message:"ユーザー情報の取得に失敗しました")}finally{L(!1)}})),B=()=>{let e=[...b];E&&(e=e.filter((e=>e.name.toLowerCase().includes(E.toLowerCase())||e.email.toLowerCase().includes(E.toLowerCase())))),"all"!==U&&(e=e.filter((e=>{switch(U){case"active":return e.is_active;case"inactive":return!e.is_active;case"subscribers":return"active"===e.subscription_status;default:return!0}}))),e.sort(((e,s)=>{const t=e[J]||"",a=s[J]||"";return"asc"===O?t>a?1:-1:t<a?1:-1})),D(e)},F=e=>"active"===e.subscription_status?a.jsxs("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[a.jsx(u,{className:"w-3 h-3 mr-1"}),"サブスク"]}):e.is_active?a.jsxs("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[a.jsx(m,{className:"w-3 h-3 mr-1"}),"アクティブ"]}):a.jsxs("span",{className:"bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[a.jsx(N,{className:"w-3 h-3 mr-1"}),"非アクティブ"]});return C?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(i,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[a.jsx(o,{className:"w-8 h-8 text-blue-600 mr-3"}),"ユーザー管理"]}),a.jsx("p",{className:"text-gray-600",children:"登録ユーザーの詳細情報と管理"})]}),a.jsxs("div",{className:"text-sm text-gray-500",children:["総ユーザー数: ",b.length,"人"]})]}),P&&a.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:P}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"総ユーザー数"}),a.jsx("p",{className:"text-xl font-bold text-blue-600",children:b.length})]}),a.jsx(o,{className:"w-6 h-6 text-blue-600"})]})}),a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"アクティブユーザー"}),a.jsx("p",{className:"text-xl font-bold text-green-600",children:b.filter((e=>e.is_active)).length})]}),a.jsx(m,{className:"w-6 h-6 text-green-600"})]})}),a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"サブスク会員"}),a.jsx("p",{className:"text-xl font-bold text-purple-600",children:b.filter((e=>"active"===e.subscription_status)).length})]}),a.jsx(u,{className:"w-6 h-6 text-purple-600"})]})}),a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"今月新規登録"}),a.jsx("p",{className:"text-xl font-bold text-orange-600",children:b.filter((e=>{const s=new Date(e.created_at),t=new Date;return s.getMonth()===t.getMonth()&&s.getFullYear()===t.getFullYear()})).length})]}),a.jsx(h,{className:"w-6 h-6 text-orange-600"})]})})]}),a.jsxs(r,{className:"p-6",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsx("div",{className:"md:col-span-2",children:a.jsx(d,{label:"検索",placeholder:"名前またはメールアドレスで検索...",value:E,onChange:e=>I(e.target.value),icon:a.jsx(p,{className:"w-4 h-4 text-gray-500"})})}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),a.jsxs("select",{value:U,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"all",children:"すべて"}),a.jsx("option",{value:"active",children:"アクティブ"}),a.jsx("option",{value:"inactive",children:"非アクティブ"}),a.jsx("option",{value:"subscribers",children:"サブスク会員"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),a.jsxs("select",{value:`${J}-${O}`,onChange:e=>{const[s,t]=e.target.value.split("-");M(s),z(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),a.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),a.jsx("option",{value:"name-asc",children:"名前（昇順）"}),a.jsx("option",{value:"name-desc",children:"名前（降順）"}),a.jsx("option",{value:"total_spent-desc",children:"支払額（高い順）"}),a.jsx("option",{value:"total_spent-asc",children:"支払額（低い順）"})]})]})]}),a.jsxs("div",{className:"flex justify-between items-center mt-4",children:[a.jsxs("p",{className:"text-sm text-gray-600",children:[k.length,"件のユーザーが見つかりました"]}),a.jsxs(n,{variant:"secondary",size:"sm",onClick:()=>{const e=[["名前","メールアドレス","電話番号","登録日","犬数","予約数","支払額","サブスクリプション"].join(","),...k.map((e=>[e.name,e.email,e.phone||"",new Date(e.created_at).toLocaleDateString("ja-JP"),e.dog_count,e.reservation_count,e.total_spent,e.subscription_status].join(",")))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`users-${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[a.jsx(j,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),a.jsx(r,{children:a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"w-full",children:[a.jsx("thead",{className:"bg-gray-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"連絡先"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"最終ログイン"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"統計"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:k.map((e=>a.jsxs("tr",{className:"hover:bg-gray-50",children:[a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{children:[a.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),a.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",e.id.slice(0,8),"..."]})]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center text-sm text-gray-900",children:[a.jsx(g,{className:"w-4 h-4 mr-2 text-gray-400"}),e.email]}),e.phone&&a.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[a.jsx(f,{className:"w-4 h-4 mr-2 text-gray-400"}),e.phone]})]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.last_sign_in_at?new Date(e.last_sign_in_at).toLocaleDateString("ja-JP"):"未ログイン"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:F(e)}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{className:"space-y-1 text-sm",children:[a.jsxs("div",{className:"flex items-center text-gray-900",children:[a.jsx(v,{className:"w-4 h-4 mr-1 text-gray-400"}),"犬: ",e.dog_count,"匹"]}),a.jsxs("div",{className:"text-gray-500",children:["予約: ",e.reservation_count,"件"]}),a.jsxs("div",{className:"text-gray-500",children:["支払: ¥",e.total_spent.toLocaleString()]})]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:a.jsx("div",{className:"flex items-center space-x-2",children:a.jsx(n,{size:"sm",variant:"secondary",onClick:()=>_(`/admin/users/${e.id}`),children:a.jsx(y,{className:"w-4 h-4"})})})})]},e.id)))})]})})})]})}export{w as AdminUserManagement};
