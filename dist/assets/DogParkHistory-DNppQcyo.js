import{u as e,s,j as a,C as t,B as l}from"./index-BFgW40ku.js";import{u as r,r as n,L as i}from"./vendor-BHVjIt_u.js";import{I as c}from"./Input-BoeHj-kf.js";import{J as d,m as o,j as x,d as m,I as h,ay as u,aq as g,C as j,a as p,z as b,X as f,U as N,A as v,t as y}from"./ui-Qz4g1iz4.js";import"./supabase-CKbzEL5D.js";function w(){const{user:w}=e(),_=r(),[k,S]=n.useState([]),[C,D]=n.useState(!0),[L,$]=n.useState(""),[z,I]=n.useState("all"),[q,M]=n.useState((new Date).getFullYear().toString()),[F,Y]=n.useState("all"),[A,E]=n.useState([]),[J,O]=n.useState(0),[P,U]=n.useState(0),[B,R]=n.useState(""),[T,V]=n.useState([]),[W,G]=n.useState(null),[H,K]=n.useState(null),[Q,X]=n.useState(null),[Z,ee]=n.useState(null);n.useEffect((()=>{w?se():_("/login")}),[w,_]);const se=async()=>{try{D(!0);const{data:e,error:a}=await s.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("user_id",w?.id).order("date",{ascending:!1}).limit(50);if(a)throw a;const{data:t,error:l}=await s.from("dogs").select("*").eq("owner_id",w?.id);if(l)throw l;if(S(e||[]),E(t||[]),e){O(e.length);const s=new Set(e.map((e=>e.park_id)));U(s.size);const a={};e.forEach((e=>{const s=e.park_id;a[s]||(a[s]={count:0,name:e.dog_park.name,id:s}),a[s].count++}));const t=Object.values(a).sort(((e,s)=>s.count-e.count)).slice(0,3).map((e=>({id:e.id,name:e.name,visits:e.count})));V(t),t.length>0&&R(t[0].name)}}catch(e){}finally{D(!1)}},ae=e=>["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"][e-1],te=n.useMemo((()=>k.filter((e=>{const s=e.dog_park.name.toLowerCase().includes(L.toLowerCase())||e.dog_park.address.toLowerCase().includes(L.toLowerCase())||e.dog.name.toLowerCase().includes(L.toLowerCase()),a="all"===z||e.dog_id===z,t=new Date(e.date),l="all"===q||t.getFullYear().toString()===q,r="all"===F||(t.getMonth()+1).toString()===F;return s&&a&&l&&r}))),[k,L,z,q,F]);return C?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(i,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[a.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[a.jsx(o,{className:"w-8 h-8 text-blue-600 mr-3"}),"ドッグラン利用履歴"]}),a.jsx("p",{className:"text-lg text-gray-600",children:"これまでのドッグラン利用記録を確認できます"})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[a.jsxs(t,{className:"p-6 text-center",children:[a.jsx(o,{className:"w-12 h-12 text-blue-600 mx-auto mb-2"}),a.jsx("p",{className:"text-3xl font-bold text-gray-900",children:J}),a.jsx("p",{className:"text-gray-600",children:"総利用回数"})]}),a.jsxs(t,{className:"p-6 text-center",children:[a.jsx(x,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),a.jsx("p",{className:"text-3xl font-bold text-gray-900",children:P}),a.jsx("p",{className:"text-gray-600",children:"訪問したドッグラン数"})]}),a.jsxs(t,{className:"p-6 text-center",children:[a.jsx(m,{className:"w-12 h-12 text-purple-600 mx-auto mb-2"}),a.jsx("p",{className:"text-xl font-bold text-gray-900 mb-1",children:B||"-"}),a.jsx("p",{className:"text-gray-600",children:"最も訪問したドッグラン"})]})]}),T.length>0&&a.jsxs(t,{className:"p-6",children:[a.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[a.jsx(h,{className:"w-6 h-6 text-pink-600 mr-2"}),"よく行くドッグラン"]}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:T.map(((e,s)=>a.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[a.jsx("div",{className:"w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-600 font-bold",children:s+1}),a.jsx("h3",{className:"font-semibold",children:e.name})]}),a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx(o,{className:"w-4 h-4 text-gray-500 mr-1"}),a.jsxs("span",{className:"text-sm text-gray-600",children:[e.visits,"回利用"]})]}),a.jsx(i,{to:`/parks/${e.id}`,children:a.jsx(l,{size:"sm",variant:"secondary",children:"詳細"})})]})]},e.id)))})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsx("div",{className:"md:col-span-2",children:a.jsx(c,{label:"",value:L,onChange:e=>$(e.target.value),placeholder:"ドッグラン名、住所で検索...",icon:a.jsx(u,{className:"w-4 h-4 text-gray-500"})})}),a.jsx("div",{children:a.jsxs("select",{value:z,onChange:e=>I(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"all",children:"すべてのワンちゃん"}),A.map((e=>a.jsxs("option",{value:e.id,children:[e.name,"ちゃん"]},e.id)))]})}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsxs("select",{value:q,onChange:e=>M(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"all",children:"すべての年"}),(()=>{const e=(new Date).getFullYear(),s=[];for(let a=e;a>=e-2;a--)s.push({value:a.toString(),label:`${a}年`});return s})().map((e=>a.jsx("option",{value:e.value,children:e.label},e.value)))]}),a.jsx("select",{value:F,onChange:e=>Y(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:(()=>{const e=[{value:"all",label:"すべての月"}];for(let s=1;s<=12;s++)e.push({value:s.toString(),label:ae(s)});return e})().map((e=>a.jsx("option",{value:e.value,children:e.label},e.value)))})]})]}),a.jsx("div",{className:"flex justify-end",children:a.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{if(0===te.length)return;const e="\ufeff"+[["日付","時間","ドッグラン名","住所","ワンちゃん","料金","予約タイプ"].join(","),...te.map((e=>[new Date(e.date).toLocaleDateString("ja-JP"),`${e.start_time}〜${parseInt(e.start_time)+e.duration}:00`,`"${e.dog_park.name.replace(/"/g,'""')}"`,`"${e.dog_park.address.replace(/"/g,'""')}"`,`"${e.dog.name.replace(/"/g,'""')}"`,`¥${e.total_amount}`,"regular"===e.reservation_type?"通常利用":"private_booth"===e.reservation_type?"プライベートブース":"施設貸し切り"].join(",")))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(s),t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("download",`dogpark_history_${(new Date).toISOString().split("T")[0]}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)},children:[a.jsx(g,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),0===te.length?a.jsxs(t,{className:"text-center py-12",children:[a.jsx(o,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"利用履歴がありません"}),a.jsx("p",{className:"text-gray-500 mb-6",children:"まだドッグランを利用していないようです"}),a.jsx(i,{to:"/parks",children:a.jsx(l,{children:"ドッグランを予約する"})})]}):a.jsx("div",{className:"space-y-6",children:te.map((e=>{const r=new Date(e.date),n=r.toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),c=e.start_time,d=`${parseInt(c)+e.duration}:00`,h="regular"===e.reservation_type?"通常利用":"private_booth"===e.reservation_type?"プライベートブース":"施設貸し切り";return a.jsxs(t,{className:"p-6 hover:shadow-lg transition-shadow",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start gap-4",children:[a.jsxs("div",{className:"flex items-start space-x-4",children:[a.jsxs("div",{className:"bg-blue-100 rounded-lg p-3 text-center min-w-[80px]",children:[a.jsx("p",{className:"text-sm text-blue-800",children:r.getFullYear()}),a.jsx("p",{className:"text-xl font-bold text-blue-600",children:r.getDate()}),a.jsx("p",{className:"text-sm text-blue-800",children:ae(r.getMonth()+1)})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold",children:e.dog_park.name}),a.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[a.jsx(m,{className:"w-4 h-4 mr-1 flex-shrink-0"}),a.jsx("span",{className:"text-sm",children:e.dog_park.address})]}),a.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[a.jsx(j,{className:"w-4 h-4 mr-1 flex-shrink-0"}),a.jsxs("span",{className:"text-sm",children:[c," 〜 ",d]})]}),a.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[a.jsx(p,{className:"w-4 h-4 mr-1 flex-shrink-0"}),a.jsxs("span",{className:"text-sm",children:[e.dog.name,"ちゃん（",e.dog.breed,"）"]})]}),Math.random()>.5&&a.jsx("div",{className:"flex items-center mt-2",children:[1,2,3,4,5].map((e=>a.jsx(b,{className:"w-4 h-4 "+(e<=Math.floor(3+2*Math.random())?"text-yellow-400 fill-current":"text-gray-300")},e)))})]})]}),a.jsxs("div",{className:"flex flex-col items-end",children:[a.jsx("div",{className:"text-right",children:a.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",e.total_amount.toLocaleString()]})}),a.jsx("div",{className:"mt-2",children:a.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("regular"===e.reservation_type?"bg-blue-100 text-blue-800":"private_booth"===e.reservation_type?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"),children:h})}),a.jsx("div",{className:"mt-2",children:a.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("confirmed"===e.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:"confirmed"===e.status?"利用済み":"キャンセル"})})]})]}),a.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 flex justify-between items-center",children:[a.jsx("div",{className:"text-sm text-gray-500",children:n}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsx(i,{to:`/parks/${e.park_id}`,children:a.jsxs(l,{size:"sm",variant:"secondary",children:[a.jsx(x,{className:"w-4 h-4 mr-1"}),"施設詳細"]})}),a.jsx(i,{to:`/parks/${e.park_id}/reserve`,children:a.jsxs(l,{size:"sm",children:[a.jsx(o,{className:"w-4 h-4 mr-1"}),"再予約"]})}),"confirmed"===e.status&&a.jsxs(l,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",isLoading:W===e.id,onClick:async()=>{const a=await(async e=>{const a="whole_facility"===e.reservation_type,t=new Date,l=new Date(e.date),r=new Date(l);if(r.setDate(l.getDate()-1),a)return t<r;{const{data:a}=await s.from("user_entry_exit_logs").select("*").eq("user_id",e.user_id).eq("park_id",e.park_id).eq("action","entry").gte("timestamp",e.date);return!a||0===a.length}})(e);a?K(e.id):X("この予約はキャンセルできません（貸し切りは1日前まで、通常予約はPIN未使用時のみ）")},children:[a.jsx(f,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]})]},e.id)}))}),te.length>0&&a.jsx(t,{className:"p-6 bg-blue-50 border-blue-200",children:a.jsxs("div",{className:"flex items-start space-x-3",children:[a.jsx(N,{className:"w-6 h-6 text-blue-600 mt-1"}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"コミュニティ機能"}),a.jsx("p",{className:"text-sm text-blue-800 mb-3",children:"同じドッグランを利用した他のワンちゃんとの出会いを「コミュニティ」ページで確認できます。 友達申請を送ったり、次回の予約を調整したりして、ワンちゃん同士の交流を深めましょう。"}),a.jsx(i,{to:"/community",children:a.jsxs(l,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:[a.jsx(N,{className:"w-4 h-4 mr-2"}),"コミュニティを見る"]})})]})]})}),H&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[a.jsxs("div",{className:"text-center mb-6",children:[a.jsx(v,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"予約をキャンセルしますか？"}),a.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),a.jsxs("div",{className:"flex justify-end space-x-3",children:[a.jsx(l,{variant:"secondary",onClick:()=>K(null),children:"戻る"}),a.jsx(l,{className:"bg-red-600 hover:bg-red-700",isLoading:W===H,onClick:()=>{const e=te.find((e=>e.id===H));e&&(async e=>{G(e.id),X(null),ee(null);try{const{data:a,error:t}=await s.rpc("cancel_reservation",{p_reservation_id:e.id,p_user_id:e.user_id});if(t||!a?.success)return void X(a&&a.message||t?.message||"キャンセルに失敗しました");ee("予約をキャンセルしました"),K(null),await se(),setTimeout((()=>ee(null)),3e3)}catch(a){X(a.message||"キャンセルに失敗しました")}finally{G(null)}})(e)},children:"キャンセルする"})]})]})}),Z&&a.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(y,{className:"w-5 h-5 text-green-600"}),a.jsx("span",{className:"font-semibold text-green-800",children:Z})]})}),Q&&a.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(v,{className:"w-5 h-5 text-red-600"}),a.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),a.jsx("p",{className:"text-red-700 mt-1",children:Q})]})]})}export{w as DogParkHistory};
