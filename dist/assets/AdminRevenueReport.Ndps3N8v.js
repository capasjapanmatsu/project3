import{u as e,s as a,j as t,B as s,C as l}from"./index.CQlxbczY.js";import{r}from"./vendor.CKEClKZl.js";import{u as n,L as c}from"./router.B_7Atevv.js";import{I as i}from"./Input.DMWrIIWM.js";import{d as o}from"./csvExport.CWWwNDcn.js";import{z as d,ag as x,D as m,A as u,a6 as h,a7 as p,_ as j,n as b,aB as f,i as v}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";function y(){const{user:y,isAdmin:g}=e(),w=n(),[N,_]=r.useState(!0),[k,S]=r.useState(""),[C,L]=r.useState([]),[D,P]=r.useState([]),[F,$]=r.useState(""),[M,O]=r.useState((new Date).getFullYear()),[I,Y]=r.useState((new Date).getMonth()),[z,A]=r.useState(0),[E,R]=r.useState(0),[B,T]=r.useState(0),V=Array.from({length:4},(e,a)=>{const t=(new Date).getFullYear()-a;return{value:t,label:`${t}年`}});r.useEffect(()=>{g?q():w("/")},[g,w,M,I]),r.useEffect(()=>{C.length>0&&G()},[C,F]);const q=()=>{return e=this,t=null,s=function*(){try{_(!0),S("");const e=new Date(M,I,1),t=new Date(M,I+1,0),s=e.toISOString().split("T")[0],l=t.toISOString().split("T")[0],{data:r,error:n}=yield a.rpc("get_monthly_revenue_by_park",{start_date_param:s,end_date_param:l});if(n)throw n;const c=(r||[]).map(e=>({owner_id:e.owner_id,owner_name:e.owner_name,park_id:e.park_id,park_name:e.park_name,total_revenue:e.total_revenue,platform_fee:Math.round(.2*e.total_revenue),owner_payout:Math.round(.8*e.total_revenue),bank_name:e.bank_name||"未設定",bank_code:e.bank_code||"未設定",branch_name:e.branch_name||"未設定",branch_code:e.branch_code||"未設定",account_type:e.account_type||"ordinary",account_number:e.account_number||"未設定",month:I+1,year:M}));L(c);const i=c.reduce((e,a)=>(e.totalRevenue+=a.total_revenue,e.totalPlatformFee+=a.platform_fee,e.totalOwnerPayout+=a.owner_payout,e),{totalRevenue:0,totalPlatformFee:0,totalOwnerPayout:0});A(i.totalRevenue),R(i.totalPlatformFee),T(i.totalOwnerPayout),G()}catch(e){S("売上データの取得に失敗しました。")}finally{_(!1)}},new Promise((a,l)=>{var r=e=>{try{c(s.next(e))}catch(a){l(a)}},n=e=>{try{c(s.throw(e))}catch(a){l(a)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,n);c((s=s.apply(e,t)).next())});var e,t,s},G=()=>{if(!F.trim())return void P(C);const e=C.filter(e=>e.owner_name.toLowerCase().includes(F.toLowerCase())||e.park_name.toLowerCase().includes(F.toLowerCase()));P(e)};return N?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):t.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[t.jsx("div",{className:"flex items-center space-x-4 mb-6",children:t.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[t.jsx(x,{className:"w-8 h-8 text-green-600 mr-3"}),"ドッグラン売上レポート"]}),t.jsxs(s,{onClick:()=>{const e=D.map(e=>[e.owner_name,e.park_name,e.total_revenue,e.platform_fee,e.owner_payout,e.bank_name,e.bank_code,e.branch_name,e.branch_code,"ordinary"===e.account_type?"普通":"当座",e.account_number,e.year,e.month]);o(["オーナー名","ドッグラン名","売上合計額","プラットフォーム手数料（20%）","振込金額（80%）","銀行名","銀行コード","支店名","支店コード","口座種別","口座番号","年","月"],e,`ドッグラン売上_${M}年${I+1}月.csv`)},disabled:0===D.length,children:[t.jsx(m,{className:"w-4 h-4 mr-2"}),"CSV出力"]})]}),k&&t.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[t.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),t.jsx("p",{children:k})]}),t.jsx(l,{className:"p-6",children:t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0",children:[t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx(s,{variant:"secondary",size:"sm",onClick:()=>{0===I?(O(M-1),Y(11)):Y(I-1)},children:t.jsx(h,{className:"w-4 h-4"})}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("select",{value:M,onChange:e=>O(Number(e.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:V.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))}),t.jsx("select",{value:I,onChange:e=>Y(Number(e.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[{value:0,label:"1月"},{value:1,label:"2月"},{value:2,label:"3月"},{value:3,label:"4月"},{value:4,label:"5月"},{value:5,label:"6月"},{value:6,label:"7月"},{value:7,label:"8月"},{value:8,label:"9月"},{value:9,label:"10月"},{value:10,label:"11月"},{value:11,label:"12月"}].map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsx(s,{variant:"secondary",size:"sm",onClick:()=>{const e=new Date,a=e.getFullYear(),t=e.getMonth();M===a&&I===t||(11===I?(O(M+1),Y(0)):Y(I+1))},disabled:M===(new Date).getFullYear()&&I===(new Date).getMonth(),children:t.jsx(p,{className:"w-4 h-4"})})]}),t.jsx("div",{className:"w-full md:w-64",children:t.jsx(i,{label:"",value:F,onChange:e=>$(e.target.value),placeholder:"オーナー名・ドッグラン名で検索...",icon:t.jsx(j,{className:"w-4 h-4 text-gray-500"})})})]})}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[t.jsx(l,{className:"p-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"総売上"}),t.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",z.toLocaleString()]})]}),t.jsx(x,{className:"w-8 h-8 text-green-600"})]})}),t.jsx(l,{className:"p-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"プラットフォーム手数料（20%）"}),t.jsxs("p",{className:"text-2xl font-bold text-blue-600",children:["¥",E.toLocaleString()]})]}),t.jsx(b,{className:"w-8 h-8 text-blue-600"})]})}),t.jsx(l,{className:"p-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"オーナー振込額（80%）"}),t.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:["¥",B.toLocaleString()]})]}),t.jsx(f,{className:"w-8 h-8 text-purple-600"})]})})]}),t.jsxs(l,{className:"p-6",children:[t.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ドッグラン別売上"}),0===D.length?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(v,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"この月の売上データはありません"})]}):t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full bg-white",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"オーナー名"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン名"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"売上合計"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料（20%）"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込金額（80%）"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込先"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-200",children:D.map(e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.owner_name}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.park_name}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:["¥",e.total_revenue.toLocaleString()]}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:["¥",e.platform_fee.toLocaleString()]}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600",children:["¥",e.owner_payout.toLocaleString()]}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:"未設定"!==e.bank_name?t.jsxs("div",{children:[t.jsxs("p",{children:[e.bank_name,"（",e.bank_code,"）"]}),t.jsxs("p",{children:[e.branch_name,"（",e.branch_code,"）"]}),t.jsxs("p",{children:["ordinary"===e.account_type?"普通":"当座"," ",e.account_number]})]}):t.jsx("span",{className:"text-red-600",children:"未設定"})})]},`${e.park_id}-${e.month}-${e.year}`))})]})})]}),t.jsx(l,{className:"p-6 bg-blue-50 border-blue-200",children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx(f,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"振込情報について"}),t.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[t.jsx("p",{children:"• 振込は毎月15日に前月分を一括で行います"}),t.jsx("p",{children:"• 振込手数料は当社負担です"}),t.jsx("p",{children:"• 振込先情報が未設定のオーナーには振込ができません"}),t.jsx("p",{children:"• 振込金額が5,000円未満の場合は翌月に繰り越されます"}),t.jsx("p",{children:"• 振込完了後、オーナーに自動でメールが送信されます"})]})]})]})})]})}export{y as AdminRevenueReport};
