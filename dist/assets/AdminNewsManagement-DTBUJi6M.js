import{u as P,s as m,l as a,E as w,k as M,j as e,C as $,B as p}from"./index-BB1ywuBb.js";import{r as d,u as B,L as z}from"./react-vendor-Co5xHYdE.js";import{I as J}from"./Input-Bmh34ZUQ.js";import{S as R}from"./Select-i_XUFhFt.js";import{B as S,x as Q,A as G,i as O,Q as X,X as E,t as H,u as K,F as V,_ as W}from"./ui-vendor-B2-VOB5s.js";import"./supabase-vendor-FDBaXLCh.js";function Y(){const{user:l}=P(),[f,j]=d.useState([]),[r,u]=d.useState({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),[y,v]=d.useState(null),[L,g]=d.useState(!1),[c,b]=d.useState(!1),[k,n]=d.useState(""),[C,o]=d.useState("");d.useEffect(()=>{_(),q()},[]);const q=async()=>{if(l)try{const{data:t,error:s}=await m.from("profiles").select("*").eq("id",l.id).single();if(console.log("Current user profile:",t),console.log("User type:",t?.user_type),s&&s.code==="PGRST116"){console.log("Profile not found, creating admin profile...");const{data:i,error:h}=await m.from("profiles").insert([{id:l.id,user_type:"admin",name:l.email||"Admin User",email:l.email}]).select().single();h?(a("error","Error creating admin profile:",{createError:h}),n("管理者プロファイルの作成に失敗しました。")):(a("info","Admin profile created successfully:",{newProfile:i}),o("管理者プロファイルを作成しました。"),setTimeout(()=>o(""),3e3))}else if(s)a("error","Error fetching user profile:",{error:s}),n("ユーザープロファイルの取得に失敗しました。");else if(!t||t.user_type!=="admin"){a("info","Updating user to admin...");const{error:i}=await m.from("profiles").update({user_type:"admin"}).eq("id",l.id);i?(a("error","Error updating user to admin:",{updateError:i}),n("管理者権限の設定に失敗しました。")):(a("info","User updated to admin successfully"),o("管理者権限を設定しました。ページを手動でリロードしてください。"),setTimeout(()=>o(""),5e3))}}catch(t){a("error","Error checking user profile:",{error:w(t)}),n("ユーザープロファイルの確認に失敗しました。")}},_=async()=>{try{const t=await M(()=>m.from("news_announcements").select("*").order("created_at",{ascending:!1}));if(t.error)throw t.error;j(t.data||[]),n("")}catch(t){a("error","Error fetching news:",{error:w(t)}),n("新着情報の取得に失敗しました。")}},A=async t=>{if(t.preventDefault(),!r.title.trim()){n("タイトルを入力してください。");return}if(!r.content.trim()){n("内容を入力してください。");return}if(!l){n("ユーザーが認証されていません。ログインしてください。");return}try{b(!0),n(""),o(""),console.log("=== 保存開始 ==="),console.log("Current user:",l);const{data:s,error:i}=await m.from("profiles").select("*").eq("id",l.id).single();console.log("Current profile:",s),console.log("Profile error:",i);const h={title:r.title,content:r.content,category:r.category,is_important:r.is_important,created_by:l?.id};if(console.log("Insert data:",h),y){const{error:N}=await m.from("news_announcements").update({title:r.title,content:r.content,category:r.category,is_important:r.is_important,updated_at:new Date().toISOString()}).eq("id",y.id);if(N)throw N;o("新着情報を更新しました。")}else{a("info","Attempting to insert new announcement...");const{data:N,error:x}=await m.from("news_announcements").insert([h]).select();if(a("info","Insert result:",{insertResult:N}),x)throw a("error","Insert error details:",{message:x.message,details:x.details,hint:x.hint,code:x.code}),x;o("新着情報を追加しました。")}u({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),v(null),g(!1),await _(),setTimeout(()=>{o("")},3e3)}catch(s){a("error","=== エラー詳細 ==="),a("error","Error saving news:",{error:w(s)});let i="新着情報の保存に失敗しました。";s&&typeof s=="object"&&("message"in s&&typeof s.message=="string"&&(i+=` エラー詳細: ${s.message}`),"details"in s&&typeof s.details=="string"&&(i+=` 詳細: ${s.details}`),"hint"in s&&typeof s.hint=="string"&&(i+=` ヒント: ${s.hint}`),"code"in s&&(i+=` コード: ${s.code}`)),n(i)}finally{b(!1)}},D=async t=>{if(confirm("この新着情報を削除してもよろしいですか？"))try{b(!0),n("");const{error:s}=await m.from("news_announcements").delete().eq("id",t);if(s)throw s;o("新着情報を削除しました。"),await _(),setTimeout(()=>{o("")},3e3)}catch(s){a("error","Error deleting news:",{error:w(s)}),n("新着情報の削除に失敗しました。")}finally{b(!1)}},I=t=>{v(t),u({title:t.title,content:t.content,category:t.category,is_important:t.is_important||!1,image_url:"",link_url:""}),g(!0)},T=t=>({news:"お知らせ",announcement:"重要なお知らせ",sale:"セール情報"})[t]||t,U=t=>({news:"bg-blue-100 text-blue-800",announcement:"bg-red-100 text-red-800",sale:"bg-green-100 text-green-800"})[t]||"bg-gray-100 text-gray-800",F=t=>{switch(t){case"news":return e.jsx(V,{className:"w-4 h-4"});case"announcement":return e.jsx(K,{className:"w-4 h-4"});case"sale":return e.jsx(H,{className:"w-4 h-4"});default:return e.jsx(S,{className:"w-4 h-4"})}};return e.jsxs(e.Fragment,{children:[e.jsxs($,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(S,{className:"w-5 h-5 text-blue-600 mr-2"}),"新着情報管理"]}),e.jsxs(p,{onClick:()=>{v(null),u({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),g(!0)},children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"新着情報を追加"]})]}),k&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start",children:[e.jsx(G,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:k})]}),C&&e.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start",children:[e.jsx(O,{className:"w-5 h-5 text-green-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:C})]}),e.jsx("div",{className:"space-y-4",children:f.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"新着情報がありません"}):f.map(t=>e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${U(t.category)}`,children:[F(t.category),e.jsx("span",{children:T(t.category)})]}),t.is_important&&e.jsx("span",{className:"bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium",children:"重要"})]}),e.jsx("h3",{className:"font-bold text-lg mb-2",children:t.title}),e.jsx("p",{className:"text-sm text-gray-700 mb-2 line-clamp-2",children:t.content}),e.jsxs("div",{className:"text-xs text-gray-500",children:["作成日: ",new Date(t.created_at).toLocaleString("ja-JP"),t.updated_at!==t.created_at&&e.jsxs("span",{children:[" / 更新日: ",new Date(t.updated_at).toLocaleString("ja-JP")]})]})]}),e.jsxs("div",{className:"flex space-x-2 ml-4",children:[e.jsxs(p,{variant:"secondary",size:"sm",onClick:()=>I(t),disabled:c,children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"編集"]}),e.jsxs(p,{variant:"danger",size:"sm",onClick:()=>D(t.id),disabled:c,children:[e.jsx(E,{className:"w-4 h-4 mr-1"}),"削除"]})]})]})},t.id))})]}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:y?"新着情報を編集":"新着情報を追加"}),e.jsx("button",{onClick:()=>g(!1),className:"text-gray-500 hover:text-gray-700",disabled:c,children:e.jsx(E,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:A,children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(J,{label:"タイトル *",value:r.title,onChange:t=>u({...r,title:t.target.value}),required:!0,disabled:c}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容 *"}),e.jsx("textarea",{value:r.content,onChange:t=>u({...r,content:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:6,required:!0,disabled:c})]}),e.jsx(R,{label:"カテゴリー *",options:[{value:"news",label:"お知らせ"},{value:"announcement",label:"重要なお知らせ"},{value:"sale",label:"セール情報"}],value:r.category,onChange:t=>u({...r,category:t.target.value}),required:!0,disabled:c}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_important",checked:r.is_important,onChange:t=>u({...r,is_important:t.target.checked}),className:"rounded text-blue-600",disabled:c}),e.jsx("label",{htmlFor:"is_important",className:"text-sm text-gray-700",children:"重要なお知らせとして表示する"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx(p,{type:"button",variant:"secondary",onClick:()=>g(!1),disabled:c,children:"キャンセル"}),e.jsx(p,{type:"submit",isLoading:c,children:y?"更新する":"追加する"})]})]})]})})})]})}function ne(){const{user:l,isAdmin:f}=P(),j=B();return d.useEffect(()=>{if(!f){j("/");return}},[f,j]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(z,{to:"/admin",children:e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:e.jsx(W,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(S,{className:"w-8 h-8 text-yellow-600 mr-3"}),"新着情報管理"]}),e.jsx("p",{className:"text-gray-600",children:"サイトの新着情報を管理します"})]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["最終更新: ",new Date().toLocaleString("ja-JP")]})]}),e.jsx(Y,{})]})}export{ne as AdminNewsManagement};
