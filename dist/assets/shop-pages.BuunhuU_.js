import{j as e,$ as s,h as t,a0 as a,a1 as r,a2 as l,a3 as i,Q as c,s as n,P as d,a4 as o,a5 as m,T as x,A as h,z as u,a6 as p,C as j,a7 as g,r as b,v as N,M as f,_ as v,S as w}from"./ui-vendor.5lywbznV.js";import{r as y,L as _,u as S,b as C}from"./react-vendor.C7ykWfwV.js";import{B as q,u as k,s as L,I as F,C as I,l as z,a as E}from"./admin-pages.BuCPNRRu.js";import{u as P,p as $,a as O}from"./park-pages.DqtvJl8J.js";function A({hasSubscription:t=!1,className:a="",variant:r="primary",size:l="md"}){const{createCheckoutSession:i,loading:c,error:n}=P(),[d,o]=y.useState(!1);return t?e.jsx(_,{to:"/subscription",children:e.jsxs(q,{variant:r,size:l,className:`flex items-center ${a}`,children:[e.jsx(s,{className:("sm"===l?"w-3 h-3":"w-4 h-4")+" mr-1"}),"サブスク管理"]})}):e.jsxs("div",{children:[e.jsxs(q,{onClick:()=>{(async()=>{o(!1);const e=$.find(e=>"subscription"===e.mode);if(e)try{await i({priceId:e.priceId,mode:"subscription",successUrl:`${window.location.origin}/dashboard?success=true`,cancelUrl:`${window.location.origin}/dashboard?canceled=true`})}catch{o(!0)}})()},isLoading:c,variant:"primary",size:l,className:`flex items-center bg-purple-600 hover:bg-purple-700 text-white ${a}`,children:[e.jsx(s,{className:("sm"===l?"w-3 h-3":"w-4 h-4")+" mr-1"}),"サブスクに加入"]}),d&&n&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:n})]})}const T=Object.freeze(Object.defineProperty({__proto__:null,PetShop:function(){const{user:x}=k(),[h,u]=y.useState([]),[p,j]=y.useState([]),[g,b]=y.useState(!0),[N,f]=y.useState(""),[v,w]=y.useState("all"),[S,C]=y.useState("name"),{isActive:z}=O(),E=[{value:"all",label:"すべて",icon:t},{value:"food",label:"ドッグフード",icon:i},{value:"treats",label:"おやつ",icon:c},{value:"toys",label:"おもちゃ",icon:n},{value:"accessories",label:"アクセサリー",icon:s},{value:"health",label:"ヘルスケア",icon:d},{value:"sheets",label:"ペットシーツ",icon:i}];y.useEffect(()=>{P()},[x]);const P=async()=>{try{const[e,s]=await Promise.all([L.from("products").select("*").eq("is_active",!0).order("created_at",{ascending:!1}),x?L.from("cart_items").select("*, product:products(*)").eq("user_id",x.id):Promise.resolve({data:[]})]);if(e.error)throw e.error;u(e.data||[]),j(s.data||[])}catch(e){}finally{b(!1)}},$=async(e,s)=>{if(s<=0)try{const{error:s}=await L.from("cart_items").delete().eq("id",e);if(s)throw s;await P()}catch(t){}else try{const{error:t}=await L.from("cart_items").update({quantity:s}).eq("id",e);if(t)throw t;await P()}catch(t){}},T=e=>z?Math.round(.9*e):e,M=h.filter(e=>{const s=e.name.toLowerCase().includes(N.toLowerCase())||e.description.toLowerCase().includes(N.toLowerCase())||e.brand&&e.brand.toLowerCase().includes(N.toLowerCase()),t="all"===v||e.category===v;return s&&t}).sort((e,s)=>{switch(S){case"name":return e.name.localeCompare(s.name);case"price":return T(e.price)-T(s.price);case"category":return e.category.localeCompare(s.category);default:return new Date(s.created_at).getTime()-new Date(e.created_at).getTime()}});return g?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(t,{className:"w-8 h-8 text-green-600 mr-3"}),"ペットショップ"]}),e.jsx("p",{className:"text-gray-600",children:"愛犬のための厳選商品をお届け"})]}),e.jsx(_,{to:"/cart",children:e.jsxs(q,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(a,{className:"w-4 h-4 mr-2"}),"カート (",p.reduce((e,s)=>e+s.quantity,0),")"]})})]}),e.jsx("div",{className:"relative overflow-hidden",children:z?e.jsxs("div",{className:"bg-gradient-to-r from-purple-600 via-pink-600 to-purple-700 text-white p-8 rounded-xl shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-white/20 p-3 rounded-full",children:e.jsx(s,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[e.jsx(r,{className:"w-6 h-6 mr-2"}),"サブスクリプション会員特典適用中！"]}),e.jsx("p",{className:"text-lg opacity-90",children:"全商品10%OFF + 送料無料でお買い物をお楽しみください"})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"bg-white/20 px-6 py-3 rounded-lg",children:[e.jsx("p",{className:"text-sm opacity-80",children:"今月の節約額"}),e.jsx("p",{className:"text-2xl font-bold",children:"¥1,200+"})]})})]}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"})]}):e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white p-8 rounded-xl shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-white/20 p-3 rounded-full",children:e.jsx(l,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[e.jsx(s,{className:"w-6 h-6 mr-2"}),"サブスク会員は全品10％OFF & 送料無料！"]}),e.jsx("p",{className:"text-lg opacity-90",children:"月額3,800円でどこでも使い放題 + ドッグラン使い放題"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(A,{hasSubscription:z,className:"bg-white text-purple-600 hover:bg-gray-100 font-bold px-6 py-3 text-lg"}),e.jsx("p",{className:"text-sm opacity-80 mt-2",children:"初月無料キャンペーン中"})]})]}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(F,{label:"",value:N,onChange:e=>f(e.target.value),placeholder:"商品名、ブランド名で検索..."})}),e.jsx("div",{children:e.jsx("select",{value:v,onChange:e=>w(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:E.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})}),e.jsx("div",{children:e.jsxs("select",{value:S,onChange:e=>C(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"popular",children:"人気順"}),e.jsx("option",{value:"name",children:"名前順"}),e.jsx("option",{value:"price",children:"価格の安い順"}),e.jsx("option",{value:"category",children:"カテゴリー順"})]})})]}),e.jsx("div",{className:"flex space-x-2 overflow-x-auto pb-2",children:E.map(s=>{const t=s.icon;return e.jsxs("button",{onClick:()=>w(s.value),className:"flex items-center space-x-2 px-4 py-2 rounded-lg whitespace-nowrap transition-colors "+(v===s.value?"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:[e.jsx(t,{className:"w-4 h-4"}),e.jsx("span",{children:s.label})]},s.value)})}),0===M.length?e.jsxs(I,{className:"text-center py-12",children:[e.jsx(t,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"該当する商品が見つかりませんでした"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:M.map(t=>{const r=(e=>{const s=p.find(s=>s.product_id===e);return s?s.quantity:0})(t.id),l=t.price,i=T(l),c=z&&i<l;return e.jsxs(I,{className:"overflow-hidden hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"relative h-48 mb-4 -m-6 mb-4",children:[e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),c&&e.jsx("div",{className:"absolute top-3 left-3",children:e.jsxs("span",{className:"bg-purple-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(s,{className:"w-3 h-3 mr-1"}),"10%OFF"]})}),t.stock_quantity<=5&&e.jsx("div",{className:"absolute top-3 right-3",children:e.jsxs("span",{className:"bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium",children:["残り",t.stock_quantity,"個"]})})]}),e.jsxs("div",{className:"px-6 pb-6",children:[e.jsxs("div",{className:"mb-2",children:[t.brand&&e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:t.brand}),e.jsx("h3",{className:"text-lg font-semibold line-clamp-2",children:t.name})]}),e.jsx("p",{className:"text-gray-600 text-sm mb-3 line-clamp-2",children:t.description}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-500 mb-3",children:[t.weight&&e.jsxs("p",{children:["内容量: ",t.weight,"g"]}),t.size&&e.jsxs("p",{children:["サイズ: ",t.size]}),t.age_group&&"all"!==t.age_group&&e.jsxs("p",{children:["対象年齢: ","puppy"===t.age_group?"子犬":"adult"===t.age_group?"成犬":"シニア犬"]}),t.dog_size&&"all"!==t.dog_size&&e.jsxs("p",{children:["対象サイズ: ","small"===t.dog_size?"小型犬":"medium"===t.dog_size?"中型犬":"大型犬"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-xl font-bold text-green-600",children:["¥",i.toLocaleString()]}),c&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",l.toLocaleString()]})]}),z&&e.jsxs("p",{className:"text-xs text-purple-600 flex items-center",children:[e.jsx(s,{className:"w-3 h-3 mr-1"}),"サブスク会員価格"]})]}),e.jsxs("div",{className:"space-y-2",children:[r>0?e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-2",children:[e.jsx("button",{onClick:()=>{const e=p.find(e=>e.product_id===t.id);e&&$(e.id,r-1)},className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(o,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium",children:r}),e.jsx("button",{onClick:()=>{const e=p.find(e=>e.product_id===t.id);e&&$(e.id,r+1)},className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(d,{className:"w-4 h-4"})})]}):e.jsx(q,{onClick:()=>(async(e,s=1)=>{if(x)try{const t=p.find(s=>s.product_id===e);if(t){const{error:e}=await L.from("cart_items").update({quantity:t.quantity+s}).eq("id",t.id);if(e)throw e}else{const{error:t}=await L.from("cart_items").insert([{user_id:x.id,product_id:e,quantity:s}]);if(t)throw t}await P()}catch(t){}})(t.id),className:"w-full bg-green-600 hover:bg-green-700",disabled:0===t.stock_quantity,children:0===t.stock_quantity?"在庫切れ":e.jsxs(e.Fragment,{children:[e.jsx(a,{className:"w-4 h-4 mr-2"}),"カートに追加"]})}),e.jsx(_,{to:`/shop/product/${t.id}`,children:e.jsx(q,{variant:"secondary",className:"w-full",children:"詳細を見る"})})]})]})]},t.id)})}),e.jsx(I,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(m,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"})]})]})]})})]})}},Symbol.toStringTag,{value:"Module"}));const M=Object.freeze(Object.defineProperty({__proto__:null,Cart:function(){const{user:t}=k(),r=S(),[l,i]=y.useState([]),[c,n]=y.useState(!0),{isActive:j}=O(),[g,b]=y.useState(null);y.useEffect(()=>{t&&N();if("true"===new URLSearchParams(window.location.search).get("canceled")){b("決済がキャンセルされました。カートから商品を確認できます。"),window.history.replaceState({},document.title,window.location.pathname);const s=localStorage.getItem("pre_payment_auth_state");if(s)try{const e=JSON.parse(s);z("info","🛒 Cart: Pre-payment auth state found",{authState:e}),t&&t.id===e.user_id||(b("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{r("/login")},3e3)),localStorage.removeItem("pre_payment_auth_state")}catch(e){z("error","Failed to parse pre-payment auth state",{error:e})}}},[t,r]);const N=async()=>{try{const{data:e,error:s}=await L.from("cart_items").select("*, product:products(*)").eq("user_id",null==t?void 0:t.id).order("created_at",{ascending:!1});if(s)throw s;i(e||[])}catch(e){b(e.message||"カート情報の取得に失敗しました")}finally{n(!1)}},f=async(e,s)=>{if(s<=0)await v(e);else try{const t=await E(()=>L.from("cart_items").update({quantity:s}).eq("id",e));if(t.error)throw t.error;await N()}catch(t){z("error","Error updating quantity",{error:t,cartItemId:e,newQuantity:s}),b("数量の更新に失敗しました。再度お試しください。")}},v=async e=>{try{const s=await E(()=>L.from("cart_items").delete().eq("id",e));if(s.error)throw s.error;await N()}catch(s){z("error","Error removing item",{error:s,cartItemId:e}),b("商品の削除に失敗しました。再度お試しください。")}},w=e=>j?Math.round(.9*e):e,C=()=>{const e=l.reduce((e,s)=>e+w(s.product.price)*s.quantity,0),s=l.reduce((e,s)=>e+s.product.price*s.quantity,0),t=e>=5e3||j?0:690;return{subtotal:e,originalSubtotal:s,discountAmount:s-e,shippingFee:t,total:e+t}};return c?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):0===l.length?e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(a,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート"]}),e.jsxs(I,{className:"text-center py-12",children:[e.jsx(a,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"カートは空です"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"お気に入りの商品をカートに追加してください"}),e.jsx(_,{to:"/shop",children:e.jsx(q,{className:"bg-green-600 hover:bg-green-700",children:"ショッピングを続ける"})})]})]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(a,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート (",l.length,"点)"]}),e.jsxs(q,{variant:"secondary",onClick:async()=>{try{const e=await E(()=>L.from("cart_items").delete().eq("user_id",null==t?void 0:t.id));if(e.error)throw e.error;await N()}catch(e){z("error","Error clearing cart",{error:e,userId:null==t?void 0:t.id}),b("カートの削除に失敗しました。再度お試しください。")}},className:"text-red-600 hover:text-red-700",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"カートを空にする"]})]}),g&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(h,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:g})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-4",children:l.map(s=>{const t=s.product.price,a=w(t),r=j&&a<t;return e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-20 h-20 object-cover rounded-lg",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.product.name}),s.product.brand&&e.jsx("p",{className:"text-sm text-gray-500",children:s.product.brand}),e.jsxs("div",{className:"mt-1 space-y-1 text-xs text-gray-500",children:[s.product.weight&&e.jsxs("p",{children:["内容量: ",s.product.weight,"g"]}),s.product.size&&e.jsxs("p",{children:["サイズ: ",s.product.size]})]})]}),e.jsx("button",{onClick:()=>v(s.id),className:"text-red-500 hover:text-red-700 p-1",children:e.jsx(x,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",a.toLocaleString()]}),r&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",t.toLocaleString()]})]}),j&&e.jsx("p",{className:"text-xs text-purple-600",children:"サブスク会員価格"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>f(s.id,s.quantity-1),className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(o,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium w-8 text-center",children:s.quantity}),e.jsx("button",{onClick:()=>f(s.id,s.quantity+1),className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(d,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsxs("span",{className:"text-lg font-semibold",children:["小計: ¥",(a*s.quantity).toLocaleString()]})})]})]})},s.id)})}),e.jsxs("div",{className:"space-y-6",children:[j?e.jsxs(I,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(s,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),e.jsx("p",{className:"text-sm",children:"全商品10%OFF + 送料無料"})]}):e.jsxs(I,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(s,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスクリプションでもっとお得に！"})]}),e.jsx("p",{className:"text-sm mb-3",children:"全商品10%OFF + 送料無料"}),e.jsx(_,{to:"/subscription",children:e.jsx(q,{size:"sm",className:"bg-white text-purple-600 hover:bg-gray-100",children:"詳細を見る"})})]}),e.jsxs(I,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文サマリー"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",C().originalSubtotal.toLocaleString()]})]}),C().discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsx("span",{children:"サブスク割引 (10%)"}),e.jsxs("span",{children:["-¥",C().discountAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"送料"]}),e.jsx("span",{children:0===C().shippingFee?e.jsx("span",{className:"text-green-600",children:"無料"}):`¥${C().shippingFee.toLocaleString()}`})]}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",C().total.toLocaleString()]})]})]}),!j&&C().subtotal<5e3&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["あと¥",(5e3-C().subtotal).toLocaleString(),"で送料無料！"]})}),e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsxs(q,{onClick:()=>{0!==l.length?r("/checkout",{state:{cartItems:l.map(e=>e.id),totals:C()}}):b("カートに商品がありません。")},className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",children:[e.jsx(u,{className:"w-5 h-5 mr-2"}),"レジに進む",e.jsx(p,{className:"w-5 h-5 ml-2"})]}),e.jsx(_,{to:"/shop",children:e.jsx(q,{variant:"secondary",className:"w-full",children:"ショッピングを続ける"})})]})]}),e.jsx(I,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(m,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"}),e.jsx("p",{children:"• 時間指定配送も可能です"})]})]})]})})]})]})]})}},Symbol.toStringTag,{value:"Module"}));const U=Object.freeze(Object.defineProperty({__proto__:null,Checkout:function(){const{user:s}=k(),a=S(),r=C(),{createCheckoutSession:l,loading:i,error:c}=P(),[n,d]=y.useState(!0),[o,x]=y.useState(null),[p,z]=y.useState([]),[E,$]=y.useState(!1),[O,A]=y.useState(null),[T,M]=y.useState(!1),[U,D]=y.useState(!1),[B,J]=y.useState({name:"",postalCode:"",address:"",phoneNumber:"",email:"",notes:""}),[Q,R]=y.useState({subtotal:0,originalSubtotal:0,discountAmount:0,shippingFee:0,total:0});y.useEffect(()=>{if(!s)return void a("/login");const e=r.state;e?(e.totals&&R(e.totals),V(e)):a("/cart")},[s,a,r]);const V=async e=>{try{d(!0);const{data:t,error:r}=await L.from("profiles").select("*").eq("id",null==s?void 0:s.id).single();if(r)throw r;if(J({name:t.name||"",postalCode:t.postal_code||"",address:t.address||"",phoneNumber:t.phone_number||"",email:(null==s?void 0:s.email)||"",notes:""}),e.cartItems&&e.cartItems.length>0){const{data:t,error:a}=await L.from("cart_items").select("*, product:products(*)").in("id",e.cartItems).eq("user_id",null==s?void 0:s.id);if(a)throw a;z(t||[])}else{const{data:e,error:t}=await L.from("cart_items").select("*, product:products(*)").eq("user_id",null==s?void 0:s.id);if(t)throw t;z(e||[])}const l=new URLSearchParams(window.location.search);if("true"===l.get("success"))M(!0),A(l.get("order_number")||X());else if("true"===l.get("canceled")){D(!0),x("決済がキャンセルされました。必要に応じて再度お試しください。");const{data:{user:e}}=await L.auth.getUser();if(!e){localStorage.getItem("pre_payment_auth_state")&&(x("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{a("/login")},3e3))}window.history.replaceState({},document.title,window.location.pathname)}}catch(t){x(t.message||"データの取得に失敗しました。もう一度お試しください。")}finally{d(!1)}},X=()=>`DP${Date.now()}${Math.floor(1e3*Math.random())}`;return n?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):T&&O?e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs(I,{className:"p-8 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(j,{className:"w-12 h-12 text-green-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"ご注文ありがとうございます！"}),e.jsxs("p",{className:"text-lg text-gray-600 mb-6",children:["注文番号: ",e.jsx("span",{className:"font-semibold",children:O})]}),e.jsx("div",{className:"bg-blue-50 p-6 rounded-lg mb-8 max-w-xl mx-auto",children:e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(t,{className:"w-6 h-6 text-blue-600 mr-3"}),e.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"ショッピング注文"})]}),e.jsx("p",{className:"text-blue-800 mb-2",children:"ご注文ありがとうございます。商品の発送準備を進めています。"}),e.jsx("p",{className:"text-blue-800",children:"注文の詳細は「注文履歴」ページでご確認いただけます。"})]})}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx(_,{to:"/orders",children:e.jsx(q,{children:"注文履歴を見る"})}),e.jsx(_,{to:"/shop",children:e.jsx(q,{variant:"secondary",children:"ショッピングを続ける"})})]})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(_,{to:"/cart",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"カートに戻る"]})}),e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(t,{className:"w-8 h-8 text-green-600 mr-3"}),"お支払い情報"]}),(o||c)&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(h,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800",children:"エラーが発生しました"}),e.jsx("p",{className:"text-red-700",children:o||c}),U&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-red-700",children:"支払い処理に失敗しました。以下をご確認ください："}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-red-700 mt-1",children:[e.jsx("li",{children:"カード情報が正しいか確認してください"}),e.jsx("li",{children:"別の支払い方法をお試しください"}),e.jsx("li",{children:"しばらく経ってから再度お試しください"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(I,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),0!==p.length)try{if($(!0),x(null),!B.name.trim())throw new Error("お名前を入力してください");if(!B.postalCode.trim())throw new Error("郵便番号を入力してください");if(!B.address.trim())throw new Error("住所を入力してください");if(!B.phoneNumber.trim())throw new Error("電話番号を入力してください");const e=X();A(e),await l({priceId:"price_placeholder",mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&order_number=${e}`,cancelUrl:`${window.location.origin}/checkout?canceled=true`,cartItems:p.map(e=>e.id),customParams:{shipping_name:B.name,shipping_address:B.address,shipping_postal_code:B.postalCode,shipping_phone:B.phoneNumber,notes:B.notes,order_number:e}})}catch(s){x(s.message||"エラーが発生しました"),$(!1)}else x("カートに商品がありません。")},children:[e.jsx("h2",{className:"text-xl font-semibold mb-6",children:"配送情報"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsx(F,{label:"お名前 *",value:B.name,onChange:e=>J({...B,name:e.target.value}),required:!0,icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})}),e.jsx(F,{label:"電話番号 *",value:B.phoneNumber,onChange:e=>J({...B,phoneNumber:e.target.value}),required:!0,icon:e.jsx(N,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(F,{label:"郵便番号 *",value:B.postalCode,onChange:e=>J({...B,postalCode:e.target.value}),required:!0,icon:e.jsx(f,{className:"w-4 h-4 text-gray-500"}),placeholder:"123-4567"})}),e.jsx("div",{className:"mb-6",children:e.jsx(F,{label:"住所 *",value:B.address,onChange:e=>J({...B,address:e.target.value}),required:!0,icon:e.jsx(f,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{className:"mb-6",children:[e.jsx(F,{label:"メールアドレス *",type:"email",value:B.email,onChange:e=>J({...B,email:e.target.value}),required:!0,disabled:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"注文確認メールがこのアドレスに送信されます"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"備考"}),e.jsx("textarea",{value:B.notes,onChange:e=>J({...B,notes:e.target.value}),placeholder:"配送に関する特記事項があればご記入ください",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",rows:3})]}),e.jsx("h2",{className:"text-xl font-semibold mb-4 mt-8",children:"支払い方法"}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(u,{className:"w-5 h-5 text-gray-600"}),e.jsx("span",{className:"font-medium",children:"クレジットカード"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1 ml-7",children:"VISA, Mastercard, JCB, AMEX"})]}),e.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(v,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"支払い処理について"}),e.jsx("p",{children:"「注文を確定する」ボタンをクリックすると、選択した支払い方法の決済画面に移動します。決済が完了すると、自動的に注文が確定します。"})]})]})}),e.jsx("div",{className:"p-4 bg-blue-50 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(w,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"安全な決済"}),e.jsx("p",{children:"すべての支払い情報は暗号化されて安全に処理されます。当サイトでは実際のカード情報を保存しません。"})]})]})}),e.jsxs(q,{type:"submit",isLoading:E||i,className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",disabled:0===p.length,children:[e.jsx(u,{className:"w-5 h-5 mr-2"}),"注文を確定する (¥",Q.total.toLocaleString(),")"]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(I,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文内容"}),e.jsx("div",{className:"space-y-4 max-h-80 overflow-y-auto mb-4",children:p.map(s=>e.jsxs("div",{className:"flex items-center space-x-3 pb-3 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0",children:e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm",children:s.product.name}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["数量: ",s.quantity]}),e.jsxs("span",{className:"text-sm font-medium",children:["¥",(s.product.price*s.quantity).toLocaleString()]})]})]})]},s.id))}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",Q.originalSubtotal.toLocaleString()]})]}),Q.discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm text-purple-600",children:[e.jsx("span",{children:"サブスク割引 (10%)"}),e.jsxs("span",{children:["-¥",Q.discountAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"送料"}),e.jsx("span",{children:0===Q.shippingFee?e.jsx("span",{className:"text-green-600",children:"無料"}):`¥${Q.shippingFee.toLocaleString()}`})]}),e.jsxs("div",{className:"flex justify-between font-bold text-base pt-2 border-t border-gray-200 mt-2",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",Q.total.toLocaleString()]})]})]})]}),e.jsx(I,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(m,{className:"w-5 h-5 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"}),e.jsx("p",{children:"• 配送状況はメールでお知らせします"})]})]})]})}),e.jsx(I,{className:"p-4 bg-gray-50 border-gray-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(w,{className:"w-5 h-5 text-gray-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:"セキュリティ"}),e.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[e.jsx("p",{children:"• SSL暗号化通信で個人情報を保護"}),e.jsx("p",{children:"• クレジットカード情報は保存されません"}),e.jsx("p",{children:"• 第三者認証のセキュリティ対策"})]})]})]})})]})]})]})}},Symbol.toStringTag,{value:"Module"}));export{M as C,T as P,U as a};
