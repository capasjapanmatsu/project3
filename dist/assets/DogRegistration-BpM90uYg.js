import{u as e,j as r,B as a,C as t,s}from"./index-CG6tuKmC.js";import{r as l,L as i}from"./vendor-BHVjIt_u.js";import{I as n}from"./Input-BcmoGOeA.js";import{S as o}from"./Select-DolRxLmx.js";import{d}from"./dogBreeds-6lxY8Uni.js";import{v as c,h as m}from"./vaccineUploadFixed-DH_m9P-8.js";import{I as u,X as b,J as h}from"./ui-BlUB7fmN.js";import"./supabase-CKbzEL5D.js";function g(){const{user:g}=e(),[x,p]=l.useState(!1),[f,j]=l.useState(""),[y,v]=l.useState(null),[N,w]=l.useState(null),[D,I]=l.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),S=(new Date).getFullYear(),C=Array.from({length:21},((e,r)=>{const a=S-r;return{value:a.toString(),label:`${a}年`}})),E=Array.from({length:12},((e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}})),Y=()=>{if(!D.birthYear||!D.birthMonth||!D.birthDay)return!1;const e=parseInt(D.birthYear),r=parseInt(D.birthMonth),a=parseInt(D.birthDay),t=new Date(e,r-1,a);if(t>new Date)return!1;const s=new Date;return s.setFullYear(s.getFullYear()-20),!(t<s)},M=d.map((e=>({value:e,label:e})));return r.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[r.jsxs("div",{children:[r.jsxs(i,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[r.jsx(u,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),r.jsx("h1",{className:"text-2xl font-bold",children:"ワンちゃん登録"}),r.jsx("p",{className:"text-gray-600",children:"新しいワンちゃんを登録して、ドッグランを利用しましょう"})]}),r.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"font-medium text-blue-900",children:"既に登録済みのワンちゃんがいますか？"}),r.jsx("p",{className:"text-sm text-blue-700",children:"登録済みのワンちゃんの情報を確認・編集できます"})]}),r.jsx(i,{to:"/dog-management",children:r.jsx(a,{variant:"secondary",size:"sm",children:"ワンちゃん管理"})})]})}),r.jsx(t,{children:r.jsxs("form",{onSubmit:async e=>{e.preventDefault(),p(!0),j("");try{if(!Y())return j("正しい生年月日を選択してください。"),void p(!1);if(!D.rabiesExpiryDate||!D.comboExpiryDate)return j("ワクチンの有効期限を入力してください。"),void p(!1);const e=new Date,a=new Date(D.rabiesExpiryDate),t=new Date(D.comboExpiryDate);if(a<=e||t<=e)return j("ワクチンの有効期限は今日より後の日付を入力してください。"),void p(!1);const l=`${D.birthYear}-${D.birthMonth}-${D.birthDay}`;let i;if("オス"===D.gender||"male"===D.gender||"male"===D.gender.toLowerCase())i="オス";else{if("メス"!==D.gender&&"female"!==D.gender&&"female"!==D.gender.toLowerCase())return j("性別を正しく選択してください。"),void p(!1);i="メス"}const{data:n,error:o}=await s.from("profiles").select("id, name, user_type").eq("id",g?.id).maybeSingle();if(o&&"PGRST116"!==o.code)throw o;if(!n){const e=g?.user_metadata?.name||g?.email?.split("@")[0]||"ユーザー",{data:r,error:a}=await s.from("profiles").upsert([{id:g?.id,user_type:"user",name:e,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(a)throw a}const{data:d,error:c}=await s.from("dogs").insert([{name:D.name,breed:D.breed,birth_date:l,gender:i,owner_id:g?.id}]).select().single();if(c)throw c;let u=null;if(y)try{const e=y.name.split(".").pop()||"jpg",r=Date.now(),a=`${d.id}/profile_${r}.${e}`,{error:t}=await s.storage.from("dog-images").upload(a,y,{cacheControl:"3600",upsert:!0,contentType:y.type});if(t)throw new Error(`画像のアップロードに失敗しました: ${t.message}`);const{data:{publicUrl:l}}=s.storage.from("dog-images").getPublicUrl(a);u=l;const{error:i}=await s.from("dogs").update({image_url:u}).eq("id",d.id);if(i)throw new Error("画像URLの更新に失敗しました")}catch(r){j("画像のアップロードに失敗しましたが、ワンちゃんの登録は完了しました。後でマイページから画像を追加できます。")}if(D.rabiesVaccineImage&&D.comboVaccineImage){const e=await m(d.id,D.rabiesVaccineImage,D.comboVaccineImage,D.rabiesExpiryDate,D.comboExpiryDate);e.success||j(`ワクチン証明書のアップロードに失敗しました: ${e.error}`)}alert("ワンちゃんの登録が完了しました！"),I({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),v(null),w(null)}catch(a){j("ワンちゃんの登録に失敗しました。もう一度お試しください。")}finally{p(!1)}},children:[f&&r.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:f}),r.jsxs("div",{className:"mb-6",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ワンちゃんの写真（任意）"}),N?r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:N,alt:"ワンちゃんのプレビュー",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),r.jsx("button",{type:"button",onClick:()=>{v(null),w(null)},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:r.jsx(b,{className:"w-4 h-4"})}),y&&r.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:y.name})]}):r.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void j("画像ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void j("画像ファイルを選択してください。");v(r);const e=new FileReader;e.onload=e=>{w(e.target?.result)},e.readAsDataURL(r),j("")}},className:"hidden",id:"dog-image"}),r.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[r.jsx(h,{className:"w-12 h-12 text-gray-400 mb-2"}),r.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"}),r.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (最大10MB)"})]})]})]}),r.jsx(n,{label:"名前",value:D.name,onChange:e=>I({...D,name:e.target.value}),required:!0}),r.jsx(o,{label:"犬種",options:M,value:D.breed,onChange:e=>I({...D,breed:e.target.value}),required:!0}),r.jsxs("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"生年月日 *"}),r.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[r.jsx("div",{children:r.jsxs("select",{value:D.birthYear,onChange:e=>{I({...D,birthYear:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[r.jsx("option",{value:"",children:"年"}),C.map((e=>r.jsx("option",{value:e.value,children:e.label},e.value)))]})}),r.jsx("div",{children:r.jsxs("select",{value:D.birthMonth,onChange:e=>{I({...D,birthMonth:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[r.jsx("option",{value:"",children:"月"}),E.map((e=>r.jsx("option",{value:e.value,children:e.label},e.value)))]})}),r.jsx("div",{children:r.jsxs("select",{value:D.birthDay,onChange:e=>I({...D,birthDay:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!D.birthYear||!D.birthMonth,children:[r.jsx("option",{value:"",children:"日"}),(()=>{if(!D.birthYear||!D.birthMonth)return Array.from({length:31},((e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}}));const e=parseInt(D.birthYear),r=parseInt(D.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},((e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}}))})().map((e=>r.jsx("option",{value:e.value,children:e.label},e.value)))]})})]}),D.birthYear&&D.birthMonth&&!D.birthDay&&r.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"日を選択してください"}),D.birthYear&&D.birthMonth&&D.birthDay&&!Y()&&r.jsx("p",{className:"mt-1 text-sm text-red-500",children:"正しい生年月日を選択してください（未来の日付や20年以上前の日付は選択できません）"})]}),r.jsx(o,{label:"性別",options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],value:D.gender,onChange:e=>I({...D,gender:e.target.value}),required:!0}),r.jsxs("div",{className:"space-y-4",children:[r.jsx("h3",{className:"text-lg font-semibold",children:"ワクチン証明書"}),r.jsxs("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン接種証明書 *"}),r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){const e=c(r);if(!e.isValid)return void j(e.error||"ファイルの検証に失敗しました");j("")}I({...D,rabiesVaccineImage:r||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),r.jsxs("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン有効期限 *"}),r.jsx("input",{type:"date",value:D.rabiesExpiryDate,onChange:e=>I({...D,rabiesExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]}),r.jsxs("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン接種証明書 *"}),r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){const e=c(r);if(!e.isValid)return void j(e.error||"ファイルの検証に失敗しました");j("")}I({...D,comboVaccineImage:r||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),r.jsxs("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン有効期限 *"}),r.jsx("input",{type:"date",value:D.comboExpiryDate,onChange:e=>I({...D,comboExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:r.jsx("p",{className:"text-sm text-yellow-800",children:"※ ワクチン接種証明書は運営による確認後に承認されます。承認されるまでドッグランの利用はできません。"})}),r.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:r.jsxs("p",{className:"text-sm text-blue-800",children:[r.jsx("span",{className:"font-medium",children:"ワクチン証明書について:"}),r.jsx("br",{}),"• 管理者が確認しやすい形で保存されます",r.jsx("br",{}),"• 承認されると正式にワクチン情報として登録されます",r.jsx("br",{}),"• 承認後、全国のドッグランをご利用いただけます"]})})]}),r.jsx(a,{type:"submit",isLoading:x,className:"w-full",children:"ワンちゃんを登録する"})]})})]})}export{g as DogRegistration};
