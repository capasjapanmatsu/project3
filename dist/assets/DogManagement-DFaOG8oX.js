const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug-Ymqf7hl2.js","assets/index-CG6tuKmC.js","assets/vendor-BHVjIt_u.js","assets/supabase-CKbzEL5D.js","assets/ui-BlUB7fmN.js","assets/index-CVDs5KN3.css","assets/directVaccineUpload-JYSqZ-xJ.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-CKbzEL5D.js";import{u as t,s as a,j as s,B as r,C as i}from"./index-CG6tuKmC.js";import{r as o,L as n}from"./vendor-BHVjIt_u.js";import{D as c,a as d}from"./DogCard-BHaQpVX6.js";import{I as l,k as m,P as u}from"./ui-BlUB7fmN.js";import"./Input-BcmoGOeA.js";import"./Select-DolRxLmx.js";import"./dogBreeds-6lxY8Uni.js";import"./VaccineBadge-CsM-icNY.js";function g(){const{user:g}=t(),[p,h]=o.useState([]),[f,b]=o.useState(!0),[x,_]=o.useState(""),[y,j]=o.useState(!1),[w,v]=o.useState(null),[S,$]=o.useState(!1),[N,D]=o.useState(""),[E,C]=o.useState(""),[U,V]=o.useState(!1),[R,A]=o.useState({name:"",breed:"",gender:"",birthDate:""}),[B,I]=o.useState(null),[P,T]=o.useState(null),[F,L]=o.useState(null),[q,W]=o.useState(null),[k,z]=o.useState(""),[M,O]=o.useState("");o.useEffect((()=>{g&&X()}),[g]);const X=async()=>{try{b(!0),_("");const{data:e,error:t}=await a.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",g?.id).order("created_at",{ascending:!1});if(t)return void _("ワンちゃんの情報を取得できませんでした。");h(e||[])}catch(e){_("ワンちゃんの情報を取得できませんでした。")}finally{b(!1)}},Y=e=>{v(e),A({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date}),T(e.image_url||null);const t=e.vaccine_certifications?.[0];t&&(z(t.rabies_expiry_date||""),O(t.combo_expiry_date||"")),j(!0)};return f?s.jsxs("div",{className:"flex justify-center items-center h-64",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),s.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("div",{children:[s.jsxs(n,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[s.jsx(l,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),s.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),s.jsx(n,{to:"/register-dog",children:s.jsxs(r,{children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),x&&s.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:x}),E&&s.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:E}),s.jsxs(i,{children:[s.jsx("div",{className:"flex justify-between items-center mb-4",children:s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(u,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",p.length,"匹)"]})}),0===p.length?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(u,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),s.jsx(n,{to:"/register-dog",children:s.jsxs(r,{children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):s.jsx("div",{className:"space-y-4",children:p.map((e=>s.jsx(c,{dog:e,onEdit:Y},e.id)))})]}),y&&w&&s.jsx(d,{dog:w,isUpdating:S||U,error:N,success:E,dogFormData:R,dogImagePreview:P,onClose:()=>j(!1),onSubmit:async t=>{if(t.preventDefault(),w){$(!0),D(""),C("");try{const t={name:R.name,breed:R.breed,gender:R.gender,birth_date:R.birthDate};if(B){if(!B.type||!B.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${B.type}`);const e=`${w.id}/dog-photo.jpg`,s=`${""}/storage/v1/object/dog-images/${e}`,{data:{session:r}}=await a.auth.getSession();if(!r?.access_token)throw new Error("認証されていません。ログインしてください。");const i=await fetch(s,{method:"PUT",headers:{Authorization:`Bearer ${r.access_token}`,"Content-Type":B.type,"Cache-Control":"3600"},body:B});if(!i.ok){const e=await i.text();throw new Error(`直接アップロードに失敗しました: ${i.status} ${e}`)}await i.json();const{data:{publicUrl:o}}=a.storage.from("dog-images").getPublicUrl(e);t.image_url=o}const{error:s}=await a.from("dogs").update(t).eq("id",w.id);if(s)throw s;if(F&&q&&k&&M){const t=F.name.split(".").pop()||"jpg",s=q.name.split(".").pop()||"jpg",r=Date.now(),i=`temp/${w.id}/rabies_${r}.${t}`,o=`temp/${w.id}/combo_${r}.${s}`,{debugAuthStatus:n}=await e((async()=>{const{debugAuthStatus:e}=await import("./authDebug-Ymqf7hl2.js");return{debugAuthStatus:e}}),__vite__mapDeps([0,1,2,3,4,5]));await n();const{directVaccineUpload:c}=await e((async()=>{const{directVaccineUpload:e}=await import("./directVaccineUpload-JYSqZ-xJ.js");return{directVaccineUpload:e}}),__vite__mapDeps([6,1,2,3,4,5])),[d,l]=await Promise.all([c(i,F),c(o,q)]);if(!d.success||!l.success){d.success,l.success;const e=d.error||l.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${e}`)}const m=d.url,u=l.url,{error:g}=await a.from("vaccine_certifications").upsert([{dog_id:w.id,rabies_vaccine_image:m,combo_vaccine_image:u,rabies_expiry_date:k,combo_expiry_date:M,status:"pending"}],{onConflict:"dog_id"});if(g)throw g.message&&g.message.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${g.message}`)}C("ワンちゃん情報を更新しました"),await X(),setTimeout((()=>{j(!1),C(""),I(null),T(null),L(null),W(null),z(""),O("")}),2e3)}catch(s){let e="ワンちゃん情報の更新に失敗しました";s instanceof Error&&(e=s.message.includes("520")||s.message.includes("Cloudflare")?"ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":s.message.includes("アップロードに失敗しました")?s.message:`エラーが発生しました: ${s.message}`),D(e)}finally{$(!1)}}},onDelete:async e=>{V(!0),D("");try{const{error:s}=await a.from("vaccine_certifications").delete().eq("dog_id",e.id);if(e.image_url)try{const t=new URL(e.image_url).pathname.split("/"),s=t[t.length-1],r=`${e.id}/${s}`,{error:i}=await a.storage.from("dog-images").remove([r])}catch(t){}const r=e.vaccine_certifications?.[0];if(r){const e=[];if(r.rabies_vaccine_image&&e.push(r.rabies_vaccine_image),r.combo_vaccine_image&&e.push(r.combo_vaccine_image),e.length>0){const{error:t}=await a.storage.from("vaccine-certs").remove(e)}}const{error:i}=await a.from("dogs").delete().eq("id",e.id);if(i)throw i;await X(),j(!1),C(`${e.name}の情報を削除しました。`),setTimeout((()=>{C("")}),3e3)}catch(s){const e=s.message||"ワンちゃんの削除に失敗しました";D(e)}finally{V(!1)}},onFormChange:A,onImageSelect:async e=>{const t=e.target.files?.[0];if(t)try{if(!(t instanceof File))return void D("有効なファイルを選択してください。");if(t.size>10485760)return void D("画像ファイルは10MB以下にしてください。");if(!t.type||!t.type.startsWith("image/"))return void D(`画像ファイルを選択してください。選択されたファイルタイプ: ${t.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return void D(`サポートされていない画像形式です: ${t.type}`);I(t);const e=new FileReader;e.onload=e=>{T(e.target?.result)},e.readAsDataURL(t)}catch(a){D("画像の処理に失敗しました。")}},onImageRemove:async()=>{if(w&&w.image_url)try{$(!0),D("");try{const e=new URL(w.image_url).pathname.split("/"),t=e[e.length-1],s=`${w.id}/${t}`,{error:r}=await a.storage.from("dog-images").remove([s])}catch(e){}const{error:t}=await a.from("dogs").update({image_url:null}).eq("id",w.id);if(t)return void D("画像の削除に失敗しました。");I(null),T(null),v({...w,image_url:void 0}),await X(),C("画像を削除しました。"),setTimeout((()=>{C("")}),3e3)}catch(t){D("画像の削除に失敗しました。")}finally{$(!1)}},rabiesVaccineFile:F,comboVaccineFile:q,rabiesExpiryDate:k,comboExpiryDate:M,onRabiesVaccineSelect:async e=>{const t=e.target.files?.[0];if(t){if(t.size>10485760)return void D("ワクチン証明書ファイルは10MB以下にしてください。");if(!t.type.startsWith("image/"))return void D("画像ファイルを選択してください。");L(t)}else L(null)},onComboVaccineSelect:async e=>{const t=e.target.files?.[0];if(t){if(t.size>10485760)return void D("ワクチン証明書ファイルは10MB以下にしてください。");if(!t.type.startsWith("image/"))return void D("画像ファイルを選択してください。");W(t)}else W(null)},onRabiesExpiryDateChange:z,onComboExpiryDateChange:O})]})}export{g as DogManagement};
