import{u as e,j as s,B as a,C as t}from"./index.oOj2R_C7.js";import{u as l,e as c,r}from"./router.icJHpBzt.js";import{Y as n,h as i,K as m,A as x,P as o}from"./ui.UnEvinBv.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function d(){const d=l(),[u]=c(),{user:h}=e(),[j,N]=r.useState(!1),[b,p]=r.useState("processing"),[f,g]=r.useState(5);r.useEffect((()=>{const e=setTimeout((()=>{return e=null,s=null,a=function*(){const e=u.get("status"),s=u.get("session_id"),a=u.get("canceled");p("success"===e&&s?"success":"cancel"===e||"true"===a?"failed":"processing");const t=localStorage.getItem("pre_payment_auth_state");if(t)try{const e=JSON.parse(t);h&&h.id===e.user_id||"true"===a&&(p("failed"),setTimeout((()=>{d("/login")}),5e3)),localStorage.removeItem("pre_payment_auth_state")}catch(l){}N(!1)},new Promise(((t,l)=>{var c=e=>{try{n(a.next(e))}catch(s){l(s)}},r=e=>{try{n(a.throw(e))}catch(s){l(s)}},n=e=>e.done?t(e.value):Promise.resolve(e.value).then(c,r);n((a=a.apply(e,s)).next())}));var e,s,a}),100);return()=>clearTimeout(e)}),[u,h,d]),r.useEffect((()=>{if("success"===b&&f>0){const e=setTimeout((()=>{g(f-1)}),1e3);return()=>clearTimeout(e)}"success"===b&&0===f&&d("/access-control")}),[b,f,d]);return j?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"max-w-2xl mx-auto",children:[s.jsxs("div",{className:"flex items-center mb-6",children:[s.jsxs(a,{variant:"primary",size:"sm",onClick:()=>d(-1),className:"mr-3",children:[s.jsx(n,{className:"w-4 h-4 mr-2"}),"戻る"]}),s.jsx("h1",{className:"text-2xl font-bold",children:"決済確認"})]}),"success"===b&&s.jsxs(t,{className:"text-center p-8",children:[s.jsx(i,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),s.jsx("h2",{className:"text-2xl font-bold text-green-800 mb-4",children:"決済が完了しました！"}),s.jsx("p",{className:"text-gray-600 mb-6",children:"ありがとうございます。決済が正常に処理されました。"}),s.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg mb-6",children:[s.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[s.jsx(m,{className:"w-5 h-5 text-blue-600"}),s.jsx("span",{className:"font-semibold text-blue-900",children:"次のステップ"})]}),s.jsx("p",{className:"text-sm text-blue-800",children:"入場にはPINコードが必要です。下のボタンからPINコードを生成してください。"})]}),s.jsxs(a,{onClick:()=>{d("/access-control")},className:"w-full bg-blue-600 hover:bg-blue-700 mb-4",children:[s.jsx(m,{className:"w-5 h-5 mr-2"}),"PINコードを生成する"]}),s.jsx("p",{className:"text-sm text-gray-500",children:f>0&&`${f}秒後に自動的にPINコード生成画面に移動します...`})]}),"failed"===b&&s.jsxs(t,{className:"text-center p-8",children:[s.jsx(x,{className:"w-16 h-16 text-red-600 mx-auto mb-4"}),s.jsx("h2",{className:"text-2xl font-bold text-red-800 mb-4",children:"決済がキャンセルされました"}),s.jsxs("p",{className:"text-gray-600 mb-6",children:["決済がキャンセルまたは失敗しました。",h?"":"認証状態を確認してから","再度お試しください。"]}),!h&&s.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg mb-6",children:[s.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[s.jsx(x,{className:"w-5 h-5 text-orange-600"}),s.jsx("span",{className:"font-semibold text-orange-900",children:"認証状態が失われました"})]}),s.jsx("p",{className:"text-sm text-orange-800",children:"セッションが切断されました。3秒後にログインページに移動します。"})]}),s.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg mb-6",children:[s.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[s.jsx(o,{className:"w-5 h-5 text-yellow-600"}),s.jsx("span",{className:"font-semibold text-yellow-900",children:"ドッグランを利用するには"})]}),s.jsx("p",{className:"text-sm text-yellow-800",children:"入場にはPINコードが必要です。決済完了後にPINコードを生成できます。"})]}),s.jsx("div",{className:"space-y-3",children:h?s.jsxs(s.Fragment,{children:[s.jsx(a,{onClick:()=>d("/parks"),className:"w-full",children:"ドッグラン一覧に戻る"}),s.jsx(a,{variant:"secondary",onClick:()=>d("/subscription"),className:"w-full",children:"サブスクリプションを検討する"}),s.jsx(a,{variant:"secondary",onClick:()=>d("/cart"),className:"w-full",children:"カートを確認する"})]}):s.jsx(a,{onClick:()=>d("/login"),className:"w-full",children:"ログインする"})})]}),"processing"===b&&s.jsxs(t,{className:"text-center p-8",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),s.jsx("h2",{className:"text-xl font-bold mb-4",children:"決済を処理中..."}),s.jsx("p",{className:"text-gray-600",children:"しばらくお待ちください。決済の処理が完了するまでお時間をいただく場合があります。"})]})]})}export{d as PaymentConfirmation};
