var e=(e,s,a)=>new Promise((t,r)=>{var l=e=>{try{i(a.next(e))}catch(s){r(s)}},d=e=>{try{i(a.throw(e))}catch(s){r(s)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(l,d);i((a=a.apply(e,s)).next())});import{u as s,s as a,j as t,F as r}from"./index.CQlxbczY.js";import{r as l,d}from"./vendor.CKEClKZl.js";import{u as i}from"./router.B_7Atevv.js";import{C as n,n as c,X as o,F as m,_ as x,aM as h,aN as u,A as g,b as p,s as j,aC as f,i as b,t as y,Q as N}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";const v={dog_park:"ドッグパーク",veterinary:"動物病院",pet_hotel:"ペットホテル",pet_shop:"ペットショップ",grooming:"トリミングサロン",pet_cafe:"ペットカフェ",training:"ドッグトレーニング",other:"その他"},w=()=>{const w=i(),{user:_,isAdmin:C}=s(),[k,S]=l.useState("pending"),[q,L]=l.useState([]),[D,P]=l.useState(!0),[F,M]=l.useState(""),[T,A]=l.useState(""),[E,G]=l.useState("created_at"),[J,O]=l.useState("desc"),Q=l.useCallback(()=>e(void 0,null,function*(){if(_&&C){P(!0);try{const{data:e,error:s}=yield a.from("facilities").select("*").order("created_at",{ascending:!1});if(s)throw s;if(null==e||e.length,null==e||e.slice(0,3),!e)return L([]),void P(!1);const t=(e=>e.map(e=>({id:e.id,name:e.name,category_id:e.category_id,address:e.address,phone:e.phone,website:e.website,description:e.description,status:e.status,created_at:e.created_at,owner_id:e.owner_id,category_name:v[e.category_id]||e.category_id})))(e);t.length,t.filter(e=>"pending"===e.status).length,t.filter(e=>"approved"===e.status).length,t.filter(e=>"rejected"===e.status).length,L(t)}catch(e){}finally{P(!1)}}}),[_,C]);l.useEffect(()=>{_?C?Q():w("/"):w("/login")},[C,w,_,Q]);const R=l.useCallback((s,t,r)=>e(void 0,null,function*(){if(null==_?void 0:_.id)try{const{error:e}=yield a.from("facilities").update({status:t}).eq("id",s);if(e)throw e;yield Q()}catch(e){}}),[_,Q]),$=l.useCallback((s,t)=>e(void 0,null,function*(){if(null==_||_.id,!(null==_?void 0:_.id))return;if(!s)return;if(window.confirm(`「${t}」を完全に削除しますか？\n\nこの操作は取り消せません。`))try{_.id;const e=yield a.from("facilities").select("*").eq("id",s).single(),t=(e.data,e.error);if(t){if("PGRST116"===t.code)return void(yield Q());throw t}const{data:r,error:l}=yield a.from("facility_images").select("image_url").eq("facility_id",s);if(!l&&r){const{error:e}=yield a.from("facility_images").delete().eq("facility_id",s);e||null==r||r.length}const{error:d}=yield a.from("facilities").delete().eq("id",s);if(d)throw d;yield Q()}catch(e){}}),[_,Q]),z=d.useMemo(()=>{const e=q.filter(e=>{const s=e.status===k,a=""===F||e.name.toLowerCase().includes(F.toLowerCase())||e.address.toLowerCase().includes(F.toLowerCase()),t=""===T||e.category_id===T;return s&&a&&t});return e.sort((e,s)=>{let a=0;switch(E){case"name":a=e.name.localeCompare(s.name);break;case"created_at":a=new Date(e.created_at).getTime()-new Date(s.created_at).getTime();break;case"category":a=(e.category_name||"").localeCompare(s.category_name||"");break;default:a=0}return"asc"===J?a:-a}),e},[q,k,F,T,E,J]),B=d.useMemo(()=>({pending:q.filter(e=>"pending"===e.status).length,approved:q.filter(e=>"approved"===e.status).length,rejected:q.filter(e=>"rejected"===e.status).length,total:q.length}),[q]);return _&&C?t.jsx(r,{children:t.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[t.jsxs("div",{className:"mb-8",children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"施設申請管理"}),t.jsx("p",{className:"text-gray-600",children:"ペット関連施設の申請を確認・承認します"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[t.jsx("div",{className:"bg-white p-6 rounded-lg shadow",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("div",{className:"p-2 bg-yellow-100 rounded-lg",children:t.jsx(n,{className:"h-6 w-6 text-yellow-600"})}),t.jsxs("div",{className:"ml-4",children:[t.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"承認待ち"}),t.jsx("p",{className:"text-2xl font-bold text-gray-900",children:B.pending})]})]})}),t.jsx("div",{className:"bg-white p-6 rounded-lg shadow",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:t.jsx(c,{className:"h-6 w-6 text-green-600"})}),t.jsxs("div",{className:"ml-4",children:[t.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"承認済み"}),t.jsx("p",{className:"text-2xl font-bold text-gray-900",children:B.approved})]})]})}),t.jsx("div",{className:"bg-white p-6 rounded-lg shadow",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:t.jsx(o,{className:"h-6 w-6 text-red-600"})}),t.jsxs("div",{className:"ml-4",children:[t.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"却下済み"}),t.jsx("p",{className:"text-2xl font-bold text-gray-900",children:B.rejected})]})]})}),t.jsx("div",{className:"bg-white p-6 rounded-lg shadow",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:t.jsx(m,{className:"h-6 w-6 text-blue-600"})}),t.jsxs("div",{className:"ml-4",children:[t.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"総申請数"}),t.jsx("p",{className:"text-2xl font-bold text-gray-900",children:B.total})]})]})})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow mb-6",children:[t.jsx("div",{className:"border-b border-gray-200",children:t.jsxs("nav",{className:"-mb-px flex",children:[t.jsxs("button",{onClick:()=>S("pending"),className:"py-4 px-6 text-sm font-medium border-b-2 "+("pending"===k?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:["承認待ち (",B.pending,")"]}),t.jsxs("button",{onClick:()=>S("approved"),className:"py-4 px-6 text-sm font-medium border-b-2 "+("approved"===k?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:["承認済み (",B.approved,")"]})]})}),t.jsx("div",{className:"p-6 border-b border-gray-200",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsxs("div",{className:"relative",children:[t.jsx(x,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5"}),t.jsx("input",{type:"text",placeholder:"施設名・住所で検索...",value:F,onChange:e=>M(e.target.value),className:"pl-10 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),t.jsxs("select",{value:T,onChange:e=>A(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"",children:"全カテゴリー"}),Object.entries(v).map(([e,s])=>t.jsx("option",{value:e,children:s},e))]}),t.jsxs("select",{value:E,onChange:e=>G(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"created_at",children:"申請日時"}),t.jsx("option",{value:"name",children:"施設名"}),t.jsx("option",{value:"category",children:"カテゴリー"})]}),t.jsxs("button",{onClick:()=>O("asc"===J?"desc":"asc"),className:"flex items-center justify-center px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500",children:["asc"===J?t.jsx(h,{className:"h-5 w-5"}):t.jsx(u,{className:"h-5 w-5"}),t.jsx("span",{className:"ml-2",children:"asc"===J?"昇順":"降順"})]})]})}),t.jsx("div",{className:"p-6",children:D?t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),t.jsx("p",{className:"mt-2 text-gray-500",children:"読み込み中..."})]}):0===z.length?t.jsxs("div",{className:"text-center py-12",children:[t.jsx(g,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"申請がありません"}),t.jsx("p",{className:"text-gray-500",children:"pending"===k?"承認待ちの申請はありません":"承認済みの申請はありません"})]}):t.jsx("div",{className:"space-y-4",children:z.map(e=>t.jsx("div",{className:"bg-gray-50 rounded-lg p-6 border border-gray-200",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center mb-2",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:e.name}),t.jsx("span",{className:"ml-3 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full",children:e.category_name})]}),t.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx(p,{className:"h-4 w-4 mr-2"}),e.address]}),e.phone&&t.jsxs("div",{className:"flex items-center",children:[t.jsx(j,{className:"h-4 w-4 mr-2"}),e.phone]}),e.website&&t.jsxs("div",{className:"flex items-center",children:[t.jsx(f,{className:"h-4 w-4 mr-2"}),t.jsx("a",{href:e.website,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:e.website})]}),e.description&&t.jsxs("div",{className:"mt-3",children:[t.jsx("h4",{className:"font-medium text-gray-700 mb-1",children:"説明"}),t.jsx("p",{className:"text-gray-600",children:e.description})]}),t.jsxs("div",{className:"flex items-center text-xs text-gray-500 mt-3",children:[t.jsx(b,{className:"h-4 w-4 mr-1"}),"申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]})]})]}),t.jsxs("div",{className:"ml-6 flex flex-col space-y-2",children:["pending"===k&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:()=>{R(e.id,"approved",e.name)},className:"flex items-center px-3 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md",children:[t.jsx(y,{className:"h-4 w-4 mr-1"}),"承認"]}),t.jsxs("button",{onClick:()=>{R(e.id,"rejected",e.name)},className:"flex items-center px-3 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md",children:[t.jsx(o,{className:"h-4 w-4 mr-1"}),"却下"]})]}),t.jsxs("button",{onClick:()=>{$(e.id,e.name)},className:"flex items-center px-3 py-2 text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-md",children:[t.jsx(N,{className:"h-4 w-4 mr-1"}),"削除"]})]})]})},e.id))})})]})]})})}):null};export{w as default};
