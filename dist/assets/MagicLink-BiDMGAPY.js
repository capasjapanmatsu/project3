import{j as e,d as y,A as L,g as E}from"./ui-vendor-w2MLOks7.js";import{u as S,d as C,r as o}from"./react-vendor-_GyjDmDn.js";import{C as l,B as b,s as n,a as M}from"./index-pj4YkVsE.js";import"./supabase-vendor-Df9iqQzW.js";function B(){const a=S(),j=C(),[k,m]=o.useState(!0),[d,i]=o.useState(null),[w,N]=o.useState(!1);return o.useEffect(()=>{(async()=>{try{m(!0);const r=window.location.hash;if(!r||!r.includes("access_token")){i("無効なMagic Linkです。もう一度ログインしてください。");return}const u=new URLSearchParams(r.substring(1)),x=u.get("access_token"),h=u.get("refresh_token");if(!x||!h){i("認証トークンが見つかりません。もう一度ログインしてください。");return}const{error:f}=await n.auth.setSession({access_token:x,refresh_token:h});if(f)throw f;const{data:{user:s},error:g}=await n.auth.getUser();if(g||!s)throw g||new Error("ユーザー情報の取得に失敗しました");const{data:_,error:c}=await n.from("profiles").select("id").eq("id",s.id).maybeSingle();if(c&&c.code!=="PGRST116"&&console.error("Profile check error:",c),!_){const t=s.user_metadata||{},{error:p}=await n.from("profiles").upsert([{id:s.id,user_type:t.user_type||"user",name:t.name||s.email?.split("@")[0]||"ユーザー",postal_code:t.postal_code||"",address:t.address||"",phone_number:t.phone_number||""}],{onConflict:"id"});p&&console.error("Profile creation error:",p)}s&&M(`trusted_device_${s.id}`,"true"),N(!0),setTimeout(()=>{a("/dashboard")},2e3)}catch(r){console.error("Magic Link authentication error:",r),i(r.message||"マジックリンクの送信に失敗しました")}finally{m(!1)}})()},[a,j]),k?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(l,{className:"text-center p-8",children:[e.jsx(y,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):d?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(l,{className:"text-center p-8",children:[e.jsx(L,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:d}),e.jsx(b,{onClick:()=>a("/login"),children:"ログインページに戻る"})]})}):w?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(l,{className:"text-center p-8",children:[e.jsx(E,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(b,{onClick:()=>a("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{B as MagicLink};
