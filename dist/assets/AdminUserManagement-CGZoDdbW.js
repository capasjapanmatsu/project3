import{j as e,J as V,U as _,av as b,q as S,i as R,a0 as z,D as Y,M as H,u as K,aJ as X,t as G,aK as Q}from"./ui-vendor-w2MLOks7.js";import{u as W,r as c,L as Z}from"./react-vendor-_GyjDmDn.js";import{u as ee,s as m,C as l,B as k}from"./index-pj4YkVsE.js";import{I as te}from"./Input-BBFNs-Kh.js";import"./supabase-vendor-Df9iqQzW.js";function ie(){const{isAdmin:f}=ee(),h=W(),[i,v]=c.useState([]),[u,C]=c.useState([]),[D,N]=c.useState(!0),[y,w]=c.useState(""),[o,L]=c.useState(""),[d,E]=c.useState("all"),[x,U]=c.useState("created_at"),[p,P]=c.useState("desc");c.useEffect(()=>{if(!f){h("/");return}$()},[f,h]),c.useEffect(()=>{B()},[i,o,d,x,p]);const $=async()=>{try{N(!0),w("");const{data:t,error:s}=await m.from("profiles").select(`
          id,
          name,
          user_type,
          postal_code,
          address,
          phone_number,
          created_at
        `);if(s)throw console.error("Profiles error:",s),new Error("プロファイル情報の取得に失敗しました");if(!t||t.length===0){v([]);return}const n=t.map(async a=>{try{const{count:j}=await m.from("dogs").select("id",{count:"exact"}).eq("owner_id",a.id),g=new Date;g.setDate(1),g.setHours(0,0,0,0);const{count:O}=await m.from("reservations").select("id",{count:"exact"}).eq("user_id",a.id).gte("created_at",g.toISOString()),{data:A}=await m.from("reservations").select("total_amount").eq("user_id",a.id).not("total_amount","is",null),J=(A||[]).reduce((q,F)=>q+(F.total_amount||0),0),T=`user_${a.id.slice(0,8)}@unknown.com`;return{id:a.id,name:a.name||"Unknown",email:T,phone:a.phone_number||"",created_at:a.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:j||0,reservation_count:O||0,total_spent:J}}catch(j){return console.error(`Error fetching data for user ${a.id}:`,j),{id:a.id,name:a.name||"Unknown",email:`user_${a.id.slice(0,8)}@unknown.com`,phone:a.phone_number||"",created_at:a.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:0,reservation_count:0,total_spent:0}}}),r=await Promise.all(n);v(r)}catch(t){console.error("Error fetching users:",t),w(t instanceof Error?t.message:"ユーザー情報の取得に失敗しました")}finally{N(!1)}},B=()=>{let t=[...i];o&&(t=t.filter(s=>s.name.toLowerCase().includes(o.toLowerCase())||s.email.toLowerCase().includes(o.toLowerCase()))),d!=="all"&&(t=t.filter(s=>{switch(d){case"active":return s.is_active;case"inactive":return!s.is_active;case"subscribers":return s.subscription_status==="active";default:return!0}})),t.sort((s,n)=>{const r=s[x]||"",a=n[x]||"";return p==="asc"?r>a?1:-1:r<a?1:-1}),C(t)},I=()=>{const t=[["名前","メールアドレス","電話番号","登録日","犬数","予約数","支払額","サブスクリプション"].join(","),...u.map(r=>[r.name,r.email,r.phone||"",new Date(r.created_at).toLocaleDateString("ja-JP"),r.dog_count,r.reservation_count,r.total_spent,r.subscription_status].join(","))].join(`
`),s=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a");n.href=URL.createObjectURL(s),n.download=`users-${new Date().toISOString().split("T")[0]}.csv`,n.click()},M=t=>t.subscription_status==="active"?e.jsxs("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(S,{className:"w-3 h-3 mr-1"}),"サブスク"]}):t.is_active?e.jsxs("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(b,{className:"w-3 h-3 mr-1"}),"アクティブ"]}):e.jsxs("span",{className:"bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(Q,{className:"w-3 h-3 mr-1"}),"非アクティブ"]});return D?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(Z,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(_,{className:"w-8 h-8 text-blue-600 mr-3"}),"ユーザー管理"]}),e.jsx("p",{className:"text-gray-600",children:"登録ユーザーの詳細情報と管理"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["総ユーザー数: ",i.length,"人"]})]}),y&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:y}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"総ユーザー数"}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:i.length})]}),e.jsx(_,{className:"w-6 h-6 text-blue-600"})]})}),e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"アクティブユーザー"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:i.filter(t=>t.is_active).length})]}),e.jsx(b,{className:"w-6 h-6 text-green-600"})]})}),e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"サブスク会員"}),e.jsx("p",{className:"text-xl font-bold text-purple-600",children:i.filter(t=>t.subscription_status==="active").length})]}),e.jsx(S,{className:"w-6 h-6 text-purple-600"})]})}),e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"今月新規登録"}),e.jsx("p",{className:"text-xl font-bold text-orange-600",children:i.filter(t=>{const s=new Date(t.created_at),n=new Date;return s.getMonth()===n.getMonth()&&s.getFullYear()===n.getFullYear()}).length})]}),e.jsx(R,{className:"w-6 h-6 text-orange-600"})]})})]}),e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(te,{label:"検索",placeholder:"名前またはメールアドレスで検索...",value:o,onChange:t=>L(t.target.value),icon:e.jsx(z,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),e.jsxs("select",{value:d,onChange:t=>E(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"active",children:"アクティブ"}),e.jsx("option",{value:"inactive",children:"非アクティブ"}),e.jsx("option",{value:"subscribers",children:"サブスク会員"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),e.jsxs("select",{value:`${x}-${p}`,onChange:t=>{const[s,n]=t.target.value.split("-");U(s),P(n)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),e.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),e.jsx("option",{value:"name-asc",children:"名前（昇順）"}),e.jsx("option",{value:"name-desc",children:"名前（降順）"}),e.jsx("option",{value:"total_spent-desc",children:"支払額（高い順）"}),e.jsx("option",{value:"total_spent-asc",children:"支払額（低い順）"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[u.length,"件のユーザーが見つかりました"]}),e.jsxs(k,{variant:"secondary",size:"sm",onClick:I,children:[e.jsx(Y,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),e.jsx(l,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"連絡先"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"最終ログイン"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"統計"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:u.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",t.id.slice(0,8),"..."]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm text-gray-900",children:[e.jsx(H,{className:"w-4 h-4 mr-2 text-gray-400"}),t.email]}),t.phone&&e.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[e.jsx(K,{className:"w-4 h-4 mr-2 text-gray-400"}),t.phone]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(t.created_at).toLocaleDateString("ja-JP")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.last_sign_in_at?new Date(t.last_sign_in_at).toLocaleDateString("ja-JP"):"未ログイン"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:M(t)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex items-center text-gray-900",children:[e.jsx(X,{className:"w-4 h-4 mr-1 text-gray-400"}),"犬: ",t.dog_count,"匹"]}),e.jsxs("div",{className:"text-gray-500",children:["予約: ",t.reservation_count,"件"]}),e.jsxs("div",{className:"text-gray-500",children:["支払: ¥",t.total_spent.toLocaleString()]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx(k,{size:"sm",variant:"secondary",onClick:()=>h(`/admin/users/${t.id}`),children:e.jsx(G,{className:"w-4 h-4"})})})})]},t.id))})]})})})]})}export{ie as AdminUserManagement};
