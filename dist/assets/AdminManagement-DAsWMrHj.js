import{s as e,j as s,B as a,g as r,u as t}from"./index-T-nty6Ge.js";import{r as i,u as c,L as n}from"./vendor-BHVjIt_u.js";import{C as l}from"./Card-DW8Xk96S.js";import{an as d,D as m,R as o,X as x,q as g,m as h,e as p,b as u,a as j,k as b}from"./ui-srxHNTHo.js";import"./supabase-CKbzEL5D.js";const N=async s=>{try{const{data:{user:s},error:a}=await e.auth.getUser();if(a)return{success:!1,error:a.message};if(!s)return{success:!1,error:"No user found"};const{data:r,error:t}=await e.from("profiles").select("*").eq("id",s.id).maybeSingle();if(t)return{success:!1,error:t.message};if(!r){const a={id:s.id,name:s.email?.split("@")[0]||"Unknown",user_type:"capasjapan@gmail.com"===s.email?"admin":"user",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{error:r}=await e.from("profiles").insert([a]);return r?{success:!1,error:r.message}:{success:!0,message:"Profile created successfully"}}if("capasjapan@gmail.com"===s.email&&"admin"!==r.user_type){const{error:a}=await e.from("profiles").update({user_type:"admin",updated_at:(new Date).toISOString()}).eq("id",s.id);return a?{success:!1,error:a.message}:{success:!0,message:"User type updated to admin"}}return{success:!0,message:"Profile already exists and is correct"}}catch(a){return{success:!1,error:a.message}}},f=s=>{const[a,r]=i.useState([]),[t,c]=i.useState([]),[n,l]=i.useState(!0),[d,m]=i.useState(""),[o,x]=i.useState("");return{pendingParks:a,pendingVaccines:t,isLoading:n,error:d,success:o,fetchData:async()=>{try{l(!0),m(""),x(""),await(async()=>{try{const{error:s}=await e.storage.updateBucket("vaccine-certs",{public:!0});return!s}catch(d){return!1}})(),"parks"===s?await(async()=>{try{const{data:s,error:a}=await e.from("admin_pending_parks_view").select("*").order("created_at",{ascending:!1});if(a)throw a;r(s||[])}catch(s){throw s}})():await(async()=>{try{const{data:s,error:a}=await e.from("vaccine_certifications").select("\n          *,\n          dog:dogs(*, owner:profiles(*))\n        ").eq("status","pending").order("created_at",{ascending:!1});if(a)throw a;c(s||[])}catch(s){throw s}})()}catch(a){m(a.message||"エラーが発生しました")}finally{l(!1)}},clearMessages:()=>{m(""),x("")},showSuccess:e=>{x(e),setTimeout((()=>x("")),3e3)},showError:e=>{m(e)},setPendingParks:r,setPendingVaccines:c}},v=()=>{const[s,a]=i.useState(!1),r=async s=>{const a=[];if(s.rabies_vaccine_image){let e="";if(s.rabies_vaccine_image.includes("/temp/")){const a=s.rabies_vaccine_image.match(/temp\/[^\/]+\/[^\/\?]+/);a&&(e=a[0])}e&&a.push(e)}if(s.combo_vaccine_image){let e="";if(s.combo_vaccine_image.includes("/temp/")){const a=s.combo_vaccine_image.match(/temp\/[^\/]+\/[^\/\?]+/);a&&(e=a[0])}e&&a.push(e)}if(a.length>0)try{const{error:s}=await e.storage.from("vaccine-certs").remove(a)}catch(r){}},t=async(s,a,r)=>{const{error:t}=await e.from("notifications").insert([{user_id:s.dog.owner_id,type:"vaccine_approval_required",title:a?"ワクチン証明書承認のお知らせ":"ワクチン証明書却下のお知らせ",message:a?`${s.dog.name}ちゃんのワクチン証明書が承認されました。ドッグランを利用できるようになりました。`:`${s.dog.name}ちゃんのワクチン証明書が却下されました。${r?`理由: ${r}`:"詳細はマイページをご確認ください。"}`,data:{dog_id:s.dog_id}}]);if(t)throw new Error(`通知の作成に失敗しました: ${t.message}`)},c=async(s,a,r)=>{let t={};const{data:i,error:c}=await e.from("dog_park_review_stages").select("id").eq("park_id",s).maybeSingle();if(c)throw c;if(i){a?t.first_stage_passed_at=(new Date).toISOString():(t.rejected_at=(new Date).toISOString(),r?.trim()&&(t.rejection_reason=r.trim()));const{error:i}=await e.from("dog_park_review_stages").update(t).eq("park_id",s);if(i)throw i}else{t={park_id:s,first_stage_passed_at:(new Date).toISOString()},a?t.first_stage_passed_at=(new Date).toISOString():(t.rejected_at=(new Date).toISOString(),r?.trim()&&(t.rejection_reason=r.trim()));const{error:i}=await e.from("dog_park_review_stages").insert([t]);if(i)throw i}},n=async(s,a,r)=>{const{data:t,error:i}=await e.from("dog_parks").select("id, name, owner_id").eq("id",s).single();if(i)throw i;const{error:c}=await e.from("notifications").insert([{user_id:t.owner_id,type:"park_approval_required",title:a?"施設承認のお知らせ":"審査結果のお知らせ",message:a?`${t.name}の審査が完了し、承認されました。おめでとうございます！`:`${t.name}の審査結果をお知らせします。${r?`理由: ${r}`:"詳細はオーナーダッシュボードをご確認ください。"}`,data:{park_id:t.id}}]);if(c)throw new Error(`施設通知の作成に失敗しました: ${c.message}`)};return{isProcessing:s,handleVaccineApproval:async(s,i,c)=>{try{a(!0);const{data:n,error:l}=await e.from("vaccine_certifications").select("*, dog:dogs(name, owner_id)").eq("id",s).single();if(l)throw l;const d={status:i?"approved":"rejected"};i&&(d.approved_at=(new Date).toISOString());const{error:m}=await e.from("vaccine_certifications").update(d).eq("id",s);if(m)throw new Error(`ワクチン証明書の更新に失敗しました: ${m.message}`);return(n.rabies_vaccine_image?.includes("/temp/")||n.combo_vaccine_image?.includes("/temp/"))&&await r(n),await t(n,i,c),{success:!0,message:`ワクチン証明書を${i?"承認":"却下"}しました`}}catch(n){return{success:!1,message:`承認処理に失敗しました: ${n.message}`}}finally{a(!1)}},handleParkApproval:async(s,r,t)=>{try{a(!0);const i={status:r?"approved":"rejected"};r&&(i.approved_at=(new Date).toISOString());const{error:l}=await e.from("dog_parks").update(i).eq("id",s);if(l)throw l;return await c(s,r,t),await n(s,r,t),{success:!0,message:`施設を${r?"承認":"却下"}しました`}}catch(i){return{success:!1,message:"承認処理に失敗しました"}}finally{a(!1)}},handleImageApproval:async(s,r,t)=>{try{a(!0);const i={is_approved:r};!r&&t?.trim()?i.admin_notes=t.trim():i.admin_notes=null;const{error:c}=await e.from("dog_park_facility_images").update(i).eq("id",s.id);if(c)throw c;return{success:!0,message:`画像を${r?"承認":"却下"}しました`}}catch(i){return{success:!1,message:"画像の承認処理に失敗しました"}}finally{a(!1)}}}},w=({pendingVaccines:e,isLoading:t,onApprovalComplete:c,onError:n})=>{const[p,u]=i.useState(null),[j,b]=i.useState(""),[N,f]=i.useState({}),[w,y]=i.useState({}),_=v(),I=async(e,s)=>{try{const a=await _.handleVaccineApproval(e,s,j);a.success?(c(a.message),u(null),b("")):n(a.message)}catch(a){n(`処理中にエラーが発生しました: ${a.message}`)}},S=e=>{f((s=>({...s,[e]:!1})))},k=e=>{f((s=>({...s,[e]:!1}))),y((s=>({...s,[e]:!0})))},C=e=>{f((s=>({...s,[e]:!0}))),y((s=>({...s,[e]:!1})))};return t?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):p?s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(d,{className:"w-6 h-6 text-blue-600 mr-2"}),p.dog.name,"のワクチン証明書審査"]}),s.jsxs(a,{variant:"secondary",onClick:()=>u(null),children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"一覧に戻る"]})]}),s.jsxs(l,{className:"p-4",children:[s.jsx("h3",{className:"font-semibold mb-3",children:"犬の基本情報"}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"名前"}),s.jsx("p",{className:"font-medium",children:p.dog.name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"犬種"}),s.jsx("p",{className:"font-medium",children:p.dog.breed})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"性別"}),s.jsx("p",{className:"font-medium",children:p.dog.gender})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"飼い主"}),s.jsx("p",{className:"font-medium",children:p.dog.owner.name})]})]})]}),s.jsxs(l,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"ワクチン証明書"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"狂犬病ワクチン"}),p.rabies_vaccine_image?s.jsxs("div",{className:"border rounded-lg overflow-hidden relative",children:[N[`rabies-${p.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 z-10",children:s.jsx(o,{className:"w-6 h-6 animate-spin text-gray-600"})}),s.jsx("img",{src:r(p.rabies_vaccine_image)||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4=",alt:"狂犬病ワクチン証明書",className:"w-full h-64 object-contain",onLoadStart:()=>C(`rabies-${p.id}`),onLoad:()=>S(`rabies-${p.id}`),onError:()=>k(`rabies-${p.id}`)}),w[`rabies-${p.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-50 bg-opacity-90",children:s.jsxs("div",{className:"text-center",children:[s.jsx(x,{className:"w-12 h-12 text-red-500 mx-auto mb-2"}),s.jsx("p",{className:"text-red-700 font-medium",children:"画像が読み込めませんでした"})]})})]}):s.jsx("div",{className:"h-64 bg-gray-100 rounded-lg flex items-center justify-center",children:s.jsx("p",{className:"text-gray-500",children:"画像なし"})})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"混合ワクチン"}),p.combo_vaccine_image?s.jsxs("div",{className:"border rounded-lg overflow-hidden relative",children:[N[`combo-${p.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 z-10",children:s.jsx(o,{className:"w-6 h-6 animate-spin text-gray-600"})}),s.jsx("img",{src:r(p.combo_vaccine_image)||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4=",alt:"混合ワクチン証明書",className:"w-full h-64 object-contain",onLoadStart:()=>C(`combo-${p.id}`),onLoad:()=>S(`combo-${p.id}`),onError:()=>k(`combo-${p.id}`)}),w[`combo-${p.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-50 bg-opacity-90",children:s.jsxs("div",{className:"text-center",children:[s.jsx(x,{className:"w-12 h-12 text-red-500 mx-auto mb-2"}),s.jsx("p",{className:"text-red-700 font-medium",children:"画像が読み込めませんでした"})]})})]}):s.jsx("div",{className:"h-64 bg-gray-100 rounded-lg flex items-center justify-center",children:s.jsx("p",{className:"text-gray-500",children:"画像なし"})})]})]})]}),s.jsxs(l,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"審査結果"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"却下理由（却下する場合のみ入力）"}),s.jsx("textarea",{value:j,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:"例: ワクチン証明書の有効期限が切れています。最新の証明書をアップロードしてください。"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsxs(a,{onClick:()=>I(p.id,!1),isLoading:_.isProcessing,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"却下"]}),s.jsxs(a,{onClick:()=>I(p.id,!0),isLoading:_.isProcessing,className:"bg-green-600 hover:bg-green-700",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"承認"]})]})]})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(d,{className:"w-6 h-6 text-blue-600 mr-2"}),"審査待ちワクチン証明書"]}),0===e.length?s.jsxs(l,{className:"text-center py-12",children:[s.jsx(g,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"審査待ちのワクチン証明書はありません"})]}):s.jsx("div",{className:"space-y-4",children:e.map((e=>s.jsx(l,{className:"p-6 hover:shadow-lg transition-shadow",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-2",children:[e.dog.name,"のワクチン証明書"]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"犬種"}),s.jsx("p",{className:"font-medium",children:e.dog.breed})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"性別"}),s.jsx("p",{className:"font-medium",children:e.dog.gender})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"飼い主"}),s.jsx("p",{className:"font-medium",children:e.dog.owner.name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"申請日"}),s.jsx("p",{className:"font-medium",children:new Date(e.created_at).toLocaleDateString("ja-JP")})]})]})]}),s.jsxs("div",{className:"flex space-x-2 ml-4",children:[s.jsxs(a,{size:"sm",variant:"secondary",onClick:()=>u(e),children:[s.jsx(h,{className:"w-4 h-4 mr-1"}),"詳細"]}),s.jsxs(a,{size:"sm",onClick:()=>I(e.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:_.isProcessing,children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsxs(a,{size:"sm",onClick:()=>{u(e),I(e.id,!1)},className:"bg-red-600 hover:bg-red-700",disabled:_.isProcessing,children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]})},y=({pendingParks:r,isLoading:t,onApprovalComplete:c,onError:n})=>{const[d,o]=i.useState(null),[j,b]=i.useState(""),[N,f]=i.useState(null),[w,y]=i.useState(!1),_=v(),I=(s=>{const[a,r]=i.useState([]),[t,c]=i.useState(!1),[n,l]=i.useState(!1),[d,m]=i.useState(""),o=async s=>{try{l(!0),m("");const{data:a,error:t}=await e.from("dog_park_facility_images").select("*").eq("park_id",s).order("created_at",{ascending:!1});if(t)throw t;r(a||[]);const i=a&&a.length>0&&a.every((e=>!0===e.is_approved));c(i)}catch(a){m(a.message||"施設画像の取得に失敗しました")}finally{l(!1)}};return i.useEffect((()=>{s?o(s):(r([]),c(!1))}),[s]),{parkImages:a,allImagesApproved:t,isLoading:n,error:d,fetchParkImages:o,setParkImages:r}})(d?.id||null),S=async(e,s)=>{try{if(s){if(I.parkImages.filter((e=>null===e.is_approved||!1===e.is_approved)).length>0)return void n("すべての画像を承認してから施設を承認してください")}const a=await _.handleParkApproval(e,s,j);a.success?(c(a.message),o(null),b("")):n(a.message)}catch(a){n(`処理中にエラーが発生しました: ${a.message}`)}},k=async e=>{if(N)try{const s=await _.handleImageApproval(N,e,j);s.success?(c(s.message),await I.fetchParkImages(d.id),y(!1),f(null),b("")):n(s.message)}catch(s){n(`処理中にエラーが発生しました: ${s.message}`)}},C=e=>({exterior:"外観",interior:"内装",equipment:"設備",area:"エリア",other:"その他"}[e]||e);return t?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):w&&N?s.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs("button",{onClick:()=>{y(!1),f(null),b("")},className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"画像一覧に戻る"]})}),s.jsxs(l,{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsxs("h2",{className:"text-xl font-bold",children:["画像レビュー: ",C(N.image_type)]}),s.jsx("div",{className:"flex space-x-2",children:s.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+(!0===N.is_approved?"bg-green-100 text-green-800":!1===N.is_approved?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:!0===N.is_approved?"承認済み":!1===N.is_approved?"却下":"審査待ち"})})]}),s.jsx("div",{className:"mb-6",children:s.jsx("div",{className:"w-full h-96 bg-gray-100 rounded-lg overflow-hidden",children:s.jsx("img",{src:N.image_url,alt:C(N.image_type),className:"w-full h-full object-contain",onError:e=>{e.currentTarget.src="https://via.placeholder.com/800x600?text=Image+Not+Available"}})})}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"却下理由（却下する場合のみ入力）"}),s.jsx("textarea",{value:j,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:"例: 画像が不鮮明です。より明るく鮮明な画像を再アップロードしてください。"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsx(a,{variant:"secondary",onClick:()=>{y(!1),f(null),b("")},children:"キャンセル"}),s.jsxs(a,{onClick:()=>k(!1),isLoading:_.isProcessing,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"却下"]}),s.jsxs(a,{onClick:()=>k(!0),isLoading:_.isProcessing,className:"bg-green-600 hover:bg-green-700",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"承認"]})]})]})]}):d?s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(p,{className:"w-6 h-6 text-blue-600 mr-2"}),d.name,"の審査"]}),s.jsxs(a,{variant:"secondary",onClick:()=>o(null),children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"一覧に戻る"]})]}),s.jsxs(l,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"施設情報"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"施設名"}),s.jsx("p",{className:"font-medium",children:d.name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"住所"}),s.jsx("p",{className:"font-medium",children:d.address})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"オーナー"}),s.jsx("p",{className:"font-medium",children:d.owner_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"申請日"}),s.jsx("p",{className:"font-medium",children:new Date(d.created_at).toLocaleDateString("ja-JP")})]})]})]}),"second_stage_review"===d.status&&s.jsxs(l,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"施設画像"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[s.jsxs("div",{className:"bg-blue-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-blue-800",children:"全画像"}),s.jsxs("p",{className:"text-blue-600",children:[d.total_images,"枚"]})]}),s.jsxs("div",{className:"bg-yellow-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-yellow-800",children:"審査待ち"}),s.jsxs("p",{className:"text-yellow-600",children:[d.pending_images,"枚"]})]}),s.jsxs("div",{className:"bg-green-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-green-800",children:"承認済み"}),s.jsxs("p",{className:"text-green-600",children:[d.approved_images,"枚"]})]}),s.jsxs("div",{className:"bg-red-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-red-800",children:"却下"}),s.jsxs("p",{className:"text-red-600",children:[d.rejected_images,"枚"]})]})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:I.parkImages.map((e=>s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:e.image_url,alt:C(e.image_type),className:"w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>(e=>{f(e),y(!0),b(e.admin_notes||"")})(e)}),s.jsx("div",{className:"absolute top-2 right-2",children:s.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+(!0===e.is_approved?"bg-green-100 text-green-800":!1===e.is_approved?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:!0===e.is_approved?"承認済み":!1===e.is_approved?"却下":"審査待ち"})}),s.jsx("div",{className:"absolute bottom-2 left-2",children:s.jsx("span",{className:"px-2 py-1 bg-black bg-opacity-50 text-white text-xs rounded",children:C(e.image_type)})})]},e.id)))})]}),s.jsxs(l,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"審査結果"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"却下理由（却下する場合のみ入力）"}),s.jsx("textarea",{value:j,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:"例: 施設の安全性に問題があります。安全対策を講じてから再度申請してください。"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsxs(a,{onClick:()=>S(d.id,!1),isLoading:_.isProcessing,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"却下"]}),s.jsxs(a,{onClick:()=>S(d.id,!0),isLoading:_.isProcessing,className:"bg-green-600 hover:bg-green-700",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"承認"]})]})]})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(u,{className:"w-6 h-6 text-blue-600 mr-2"}),"審査待ちドッグラン"]}),0===r.length?s.jsxs(l,{className:"text-center py-12",children:[s.jsx(g,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"審査待ちのドッグランはありません"})]}):s.jsx("div",{className:"space-y-4",children:r.map((e=>s.jsx(l,{className:"p-6 hover:shadow-lg transition-shadow",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[s.jsx("h3",{className:"text-lg font-semibold",children:e.name}),s.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+("first_stage_passed"===e.status?"bg-blue-100 text-blue-800":"second_stage_review"===e.status?"bg-purple-100 text-purple-800":"bg-yellow-100 text-yellow-800"),children:"first_stage_passed"===e.status?"第一審査通過":"second_stage_review"===e.status?"第二審査中":"審査待ち"})]}),s.jsx("p",{className:"text-gray-600 mb-2",children:e.address}),s.jsxs("div",{className:"text-sm text-gray-500",children:[s.jsxs("p",{children:["オーナー: ",e.owner_name]}),s.jsxs("p",{children:["申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]}),e.second_stage_submitted_at&&s.jsxs("p",{children:["第二審査申請日: ",new Date(e.second_stage_submitted_at).toLocaleDateString("ja-JP")]})]}),"second_stage_review"===e.status&&s.jsxs("div",{className:"mt-3 grid grid-cols-4 gap-2 text-sm",children:[s.jsxs("div",{className:"bg-blue-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-blue-800",children:"全画像"}),s.jsxs("p",{className:"text-blue-600",children:[e.total_images,"枚"]})]}),s.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-yellow-800",children:"審査待ち"}),s.jsxs("p",{className:"text-yellow-600",children:[e.pending_images,"枚"]})]}),s.jsxs("div",{className:"bg-green-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-green-800",children:"承認済み"}),s.jsxs("p",{className:"text-green-600",children:[e.approved_images,"枚"]})]}),s.jsxs("div",{className:"bg-red-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-red-800",children:"却下"}),s.jsxs("p",{className:"text-red-600",children:[e.rejected_images,"枚"]})]})]})]}),s.jsxs("div",{className:"flex flex-col space-y-2",children:[s.jsxs(a,{onClick:()=>o(e),variant:"secondary",children:[s.jsx(h,{className:"w-4 h-4 mr-2"}),"詳細を見る"]}),s.jsxs(a,{onClick:()=>S(e.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:_.isProcessing,children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsxs(a,{onClick:()=>S(e.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:_.isProcessing,children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]})};function _(){const{user:r,isAdmin:o,userProfile:x}=t(),h=c(),[p,v]=i.useState("vaccines"),[_,I]=i.useState(""),[S,k]=i.useState(""),C=f(p),P=e=>{k(e),I(""),setTimeout((()=>k("")),5e3)},D=e=>{I(e),k(""),setTimeout((()=>I("")),8e3)},O=()=>{I(""),k("")};i.useEffect((()=>{r&&!o&&(async()=>{if("capasjapan@gmail.com"===r?.email&&!o)try{(await N(r.email)).success&&(P("管理者権限を設定しました。ページを再読み込みします..."),setTimeout((()=>window.location.reload()),1500))}catch(e){}})()}),[r,o]),i.useEffect((()=>{o?C.fetchData():h("/")}),[o,h,p]);const $=async e=>{P(e),await C.fetchData()},L=e=>{D(e)};return s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs(n,{to:"/admin",className:"flex items-center text-blue-600 hover:text-blue-800",children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),s.jsx("div",{className:"flex justify-between items-center",children:s.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[s.jsx(j,{className:"w-8 h-8 text-red-600 mr-3"}),"管理者審査ページ"]})}),_&&s.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[s.jsx(b,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{className:"text-red-800",children:_})]}),S&&s.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[s.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{className:"text-green-800",children:S})]}),!o&&s.jsxs(l,{className:"p-4 bg-red-50 border-l-4 border-red-500",children:[s.jsx("h3",{className:"font-semibold mb-3 text-red-900",children:"❌ 管理者権限が必要です"}),s.jsxs("div",{className:"text-sm text-red-800 space-y-2",children:[s.jsx("p",{children:s.jsx("strong",{children:"ユーザー情報:"})}),s.jsxs("p",{children:["• Email: ",r?.email||"なし"]}),s.jsxs("p",{children:["• User Type: ",x?.user_type||"undefined"]}),s.jsxs("p",{children:["• Is Admin: ",o?"true":"false"]}),"capasjapan@gmail.com"===r?.email&&s.jsxs("div",{className:"mt-4 space-x-2",children:[s.jsx(a,{size:"sm",onClick:async()=>{O();try{const e=await N(r.email);e.success?(P("管理者権限を設定しました。ページを再読み込みします..."),setTimeout((()=>window.location.reload()),1500)):D(`管理者権限の設定に失敗: ${e.error}`)}catch(e){D(`エラーが発生しました: ${e.message}`)}},className:"bg-blue-600 hover:bg-blue-700",children:"管理者権限を設定"}),s.jsx(a,{size:"sm",onClick:async()=>{if(O(),r?.id)try{const s=await(async s=>{try{const{error:a}=await e.from("profiles").update({user_type:"admin"}).eq("id",s);return a?{success:!1,error:a.message}:{success:!0,message:"User type updated successfully"}}catch(_){return{success:!1,error:_.message}}})(r.id);s.success?(P("プロファイルを更新しました。ページを再読み込みします..."),setTimeout((()=>window.location.reload()),1500)):D(`プロファイル更新に失敗: ${s.error}`)}catch(s){D(`エラーが発生しました: ${s.message}`)}else D("ユーザーIDが見つかりません")},className:"bg-orange-600 hover:bg-orange-700",children:"直接更新"})]})]})]}),o&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex space-x-4 border-b",children:[s.jsxs("button",{className:"px-4 py-2 font-medium "+("parks"===p?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>v("parks"),children:[s.jsx(u,{className:"w-4 h-4 inline mr-2"}),"ドッグラン審査"]}),s.jsxs("button",{className:"px-4 py-2 font-medium "+("vaccines"===p?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>v("vaccines"),children:[s.jsx(d,{className:"w-4 h-4 inline mr-2"}),"ワクチン証明書審査"]})]}),s.jsxs("div",{className:"mt-6",children:["parks"===p&&s.jsx(y,{pendingParks:C.pendingParks,isLoading:C.isLoading,onApprovalComplete:$,onError:L}),"vaccines"===p&&s.jsx(w,{pendingVaccines:C.pendingVaccines,isLoading:C.isLoading,onApprovalComplete:$,onError:L})]})]})]})}export{_ as AdminManagement};
