import{u as e,b as s,j as r,B as a}from"./index-Dp3tQatg.js";import{u as t,r as l,L as i}from"./vendor-Cwmn0chA.js";import{C as c}from"./Card-CPEZwr97.js";import{I as n}from"./Input-BBpqNzSy.js";import{O as d,v as x,U as m,H as o,w as h,h as u,X as j,e as p,l as f,i as g,o as b,x as y,a3 as N}from"./ui-BHmKMuva.js";import"./supabase-Dzr8oIt2.js";function v(){const{user:v}=e(),w=t(),[_,S]=l.useState(!0),[C,k]=l.useState(""),[D,M]=l.useState(""),[Y,q]=l.useState([]),[A,I]=l.useState(!1),[z,H]=l.useState(!1),[F,L]=l.useState({cardNumber:"",cardHolder:"",expiryMonth:"",expiryYear:"",cvv:"",isDefault:!1});l.useEffect((()=>{v?V():w("/login")}),[v,w]);const V=async()=>{try{S(!0);const{data:e,error:r}=await s.from("payment_cards").select("*").eq("user_id",null==v?void 0:v.id).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(r)throw r;q(e||[])}catch(e){k("支払い方法の取得に失敗しました。")}finally{S(!1)}},W=e=>{switch(e){case"visa":return r.jsx("span",{className:"text-blue-600 font-bold",children:"VISA"});case"mastercard":return r.jsx("span",{className:"text-red-600 font-bold",children:"Mastercard"});case"amex":return r.jsx("span",{className:"text-blue-800 font-bold",children:"AMEX"});case"jcb":return r.jsx("span",{className:"text-green-600 font-bold",children:"JCB"});default:return r.jsx(x,{className:"w-5 h-5 text-gray-600"})}};return _?r.jsx("div",{className:"flex justify-center items-center h-64",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):r.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[r.jsx("div",{className:"flex items-center space-x-4 mb-6",children:r.jsxs(i,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[r.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),r.jsxs("div",{className:"text-center mb-8",children:[r.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[r.jsx(x,{className:"w-8 h-8 text-blue-600 mr-3"}),"支払い方法の管理"]}),r.jsx("p",{className:"text-lg text-gray-600",children:"クレジットカード情報を管理します"})]}),r.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[r.jsx(i,{to:"/profile-settings",children:r.jsxs(a,{variant:"secondary",size:"sm",children:[r.jsx(m,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),r.jsx(i,{to:"/dogpark-history",children:r.jsxs(a,{variant:"secondary",size:"sm",children:[r.jsx(o,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),r.jsx(i,{to:"/orders",children:r.jsxs(a,{variant:"secondary",size:"sm",children:[r.jsx(h,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),r.jsx(i,{to:"/shop",children:r.jsxs(a,{variant:"secondary",size:"sm",children:[r.jsx(u,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),r.jsxs(c,{className:"p-6",children:[r.jsxs("div",{className:"flex justify-between items-center mb-6",children:[r.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[r.jsx(x,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みのカード"]}),r.jsx(a,{onClick:()=>I(!A),size:"sm",children:A?r.jsxs(r.Fragment,{children:[r.jsx(j,{className:"w-4 h-4 mr-1"}),"キャンセル"]}):r.jsxs(r.Fragment,{children:[r.jsx(p,{className:"w-4 h-4 mr-1"}),"カードを追加"]})})]}),C&&r.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[r.jsx(f,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),r.jsx("p",{className:"text-red-800",children:C})]}),D&&r.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[r.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),r.jsx("p",{className:"text-green-800",children:D})]}),A&&r.jsxs("div",{className:"mb-6 p-6 bg-gray-50 rounded-lg border border-gray-200",children:[r.jsx("h3",{className:"font-semibold mb-4",children:"新しいカードを追加"}),r.jsx("form",{onSubmit:async e=>{if(e.preventDefault(),k(""),M(""),(()=>{if(16!==F.cardNumber.replace(/\s/g,"").length)return k("カード番号は16桁で入力してください。"),!1;if(!F.cardHolder.trim())return k("カード名義人を入力してください。"),!1;if(!F.expiryMonth||!F.expiryYear)return k("有効期限を選択してください。"),!1;if(F.cvv.length<3)return k("CVVを正しく入力してください。"),!1;const e=new Date,s=e.getFullYear()%100,r=e.getMonth()+1,a=parseInt(F.expiryYear),t=parseInt(F.expiryMonth);return!(a<s||a===s&&t<r)||(k("有効期限が過去の日付です。"),!1)})()){H(!0);try{const e=F.cardNumber.replace(/\s/g,""),r="**** **** **** "+e.slice(-4),a=(e=>{const s=e.replace(/\s/g,"");return s.startsWith("4")?"visa":s.startsWith("5")||s.startsWith("2")?"mastercard":s.startsWith("3")?"amex":s.startsWith("35")?"jcb":"visa"})(e),{error:t}=await s.from("payment_cards").insert([{user_id:null==v?void 0:v.id,card_number_masked:r,card_holder_name:F.cardHolder,expiry_month:parseInt(F.expiryMonth),expiry_year:parseInt(F.expiryYear),card_brand:a,is_default:F.isDefault||0===Y.length}]);if(t)throw t;M("クレジットカードを登録しました"),I(!1),L({cardNumber:"",cardHolder:"",expiryMonth:"",expiryYear:"",cvv:"",isDefault:!1}),await V(),setTimeout((()=>{M("")}),3e3)}catch(r){k("クレジットカードの登録に失敗しました。もう一度お試しください。")}finally{H(!1)}}},children:r.jsxs("div",{className:"space-y-4",children:[r.jsx(n,{label:"カード番号 *",value:F.cardNumber,onChange:e=>{const s=e.target.value.replace(/\D/g,"").replace(/(.{4})/g,"$1 ").trim().slice(0,19);L({...F,cardNumber:s})},placeholder:"1234 5678 9012 3456",maxLength:19,required:!0}),r.jsx(n,{label:"カード名義人 *",value:F.cardHolder,onChange:e=>L({...F,cardHolder:e.target.value.toUpperCase()}),placeholder:"TARO YAMADA",required:!0}),r.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"有効期限（月） *"}),r.jsxs("select",{value:F.expiryMonth,onChange:e=>L({...F,expiryMonth:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[r.jsx("option",{value:"",children:"月"}),Array.from({length:12},((e,s)=>r.jsx("option",{value:String(s+1).padStart(2,"0"),children:String(s+1).padStart(2,"0")},s+1)))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"有効期限（年） *"}),r.jsxs("select",{value:F.expiryYear,onChange:e=>L({...F,expiryYear:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[r.jsx("option",{value:"",children:"年"}),Array.from({length:10},((e,s)=>{const a=(new Date).getFullYear()+s;return r.jsx("option",{value:String(a).slice(-2),children:a},a)}))]})]}),r.jsx(n,{label:"CVV *",value:F.cvv,onChange:e=>L({...F,cvv:e.target.value.replace(/\D/g,"")}),placeholder:"123",maxLength:4,required:!0})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("input",{type:"checkbox",id:"isDefault",checked:F.isDefault,onChange:e=>L({...F,isDefault:e.target.checked}),className:"rounded text-blue-600"}),r.jsx("label",{htmlFor:"isDefault",className:"text-sm text-gray-700",children:"デフォルトの支払い方法として設定"})]}),r.jsxs("div",{className:"flex justify-end space-x-3 mt-2",children:[r.jsx(a,{type:"button",variant:"secondary",onClick:()=>I(!1),children:"キャンセル"}),r.jsx(a,{type:"submit",isLoading:z,children:"カードを追加"})]})]})})]}),0===Y.length?r.jsxs("div",{className:"text-center py-8",children:[r.jsx(x,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 mb-4",children:"登録されているカードはありません"}),r.jsxs(a,{onClick:()=>I(!0),children:[r.jsx(p,{className:"w-4 h-4 mr-2"}),"カードを追加する"]})]}):r.jsx("div",{className:"space-y-4",children:Y.map((e=>r.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("div",{className:"w-12 h-12 bg-white rounded-lg flex items-center justify-center border border-gray-300",children:W(e.card_brand)}),r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("h3",{className:"font-semibold",children:e.card_number_masked}),e.is_default&&r.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full flex items-center",children:[r.jsx(b,{className:"w-3 h-3 mr-1"}),"デフォルト"]})]}),r.jsx("p",{className:"text-sm text-gray-600",children:e.card_holder_name}),r.jsxs("p",{className:"text-xs text-gray-500",children:["有効期限: ",e.expiry_month.toString().padStart(2,"0"),"/",e.expiry_year.toString().padStart(2,"0")]})]})]}),r.jsxs("div",{className:"flex space-x-2",children:[!e.is_default&&r.jsxs(a,{size:"sm",variant:"secondary",onClick:()=>(async e=>{try{k(""),M("");const{error:r}=await s.from("payment_cards").update({is_default:!1}).eq("user_id",null==v?void 0:v.id);if(r)throw r;const{error:a}=await s.from("payment_cards").update({is_default:!0}).eq("id",e);if(a)throw a;M("デフォルトの支払い方法を変更しました"),await V(),setTimeout((()=>{M("")}),3e3)}catch(r){k("デフォルト設定の変更に失敗しました。")}})(e.id),children:[r.jsx(b,{className:"w-4 h-4 mr-1"}),"デフォルトに設定"]}),r.jsx(a,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>(async e=>{if(confirm("このカードを削除してもよろしいですか？"))try{k(""),M("");const{error:r}=await s.from("payment_cards").delete().eq("id",e);if(r)throw r;M("クレジットカードを削除しました"),await V(),setTimeout((()=>{M("")}),3e3)}catch(r){k(r.message||"決済方法の削除に失敗しました")}})(e.id),children:r.jsx(y,{className:"w-4 h-4"})})]})]})},e.id)))})]}),r.jsx(c,{className:"p-6 bg-blue-50 border-blue-200",children:r.jsxs("div",{className:"flex items-start space-x-3",children:[r.jsx(N,{className:"w-6 h-6 text-blue-600 mt-1"}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"セキュリティ情報"}),r.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[r.jsx("p",{children:"• カード情報は暗号化して安全に保存されます"}),r.jsx("p",{children:"• 実際のカード番号は保存されません"}),r.jsx("p",{children:"• 決済処理はSSL暗号化通信で行われます"}),r.jsx("p",{children:"• PCI DSS準拠のセキュリティ基準を満たしています"})]})]})]})})]})}export{v as PaymentMethodSettings};
