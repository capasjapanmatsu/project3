import{u as W,s as q,j as e,B as j,C as d}from"./index-BB1ywuBb.js";import{u as G,r as n,L as J}from"./react-vendor-Co5xHYdE.js";import{I as K}from"./Input-Bmh34ZUQ.js";import{d as Q}from"./csvExport-Dyv5iYoT.js";import{_ as U,ao as D,D as X,A as Z,ae as ee,af as ae,a7 as te,v as se,aH as C,p as re}from"./ui-vendor-B2-VOB5s.js";import"./supabase-vendor-FDBaXLCh.js";function ue(){const{user:ne,isAdmin:b}=W(),g=G(),[L,v]=n.useState(!0),[w,y]=n.useState(""),[u,M]=n.useState([]),[m,N]=n.useState([]),[i,P]=n.useState(""),[l,h]=n.useState(new Date().getFullYear()),[r,x]=n.useState(new Date().getMonth()),[R,F]=n.useState(0),[O,T]=n.useState(0),[A,Y]=n.useState(0),E=[{value:0,label:"1月"},{value:1,label:"2月"},{value:2,label:"3月"},{value:3,label:"4月"},{value:4,label:"5月"},{value:5,label:"6月"},{value:6,label:"7月"},{value:7,label:"8月"},{value:8,label:"9月"},{value:9,label:"10月"},{value:10,label:"11月"},{value:11,label:"12月"}],$=Array.from({length:4},(a,c)=>{const o=new Date().getFullYear()-c;return{value:o,label:`${o}年`}});n.useEffect(()=>{if(!b){g("/");return}B()},[b,g,l,r]),n.useEffect(()=>{u.length>0&&_()},[u,i]);const B=async()=>{try{v(!0),y("");const a=new Date(l,r,1),c=new Date(l,r+1,0),o=a.toISOString().split("T")[0],s=c.toISOString().split("T")[0],{data:H,error:k}=await q.rpc("get_monthly_revenue_by_park",{start_date_param:o,end_date_param:s});if(k)throw k;const S=(H||[]).map(t=>({owner_id:t.owner_id,owner_name:t.owner_name,park_id:t.park_id,park_name:t.park_name,total_revenue:t.total_revenue,platform_fee:Math.round(t.total_revenue*.2),owner_payout:Math.round(t.total_revenue*.8),bank_name:t.bank_name||"未設定",bank_code:t.bank_code||"未設定",branch_name:t.branch_name||"未設定",branch_code:t.branch_code||"未設定",account_type:t.account_type||"ordinary",account_number:t.account_number||"未設定",month:r+1,year:l}));M(S);const p=S.reduce((t,f)=>(t.totalRevenue+=f.total_revenue,t.totalPlatformFee+=f.platform_fee,t.totalOwnerPayout+=f.owner_payout,t),{totalRevenue:0,totalPlatformFee:0,totalOwnerPayout:0});F(p.totalRevenue),T(p.totalPlatformFee),Y(p.totalOwnerPayout),_()}catch(a){console.error("Error fetching revenue data:",a),y("売上データの取得に失敗しました。")}finally{v(!1)}},_=()=>{if(!i.trim()){N(u);return}const a=u.filter(c=>c.owner_name.toLowerCase().includes(i.toLowerCase())||c.park_name.toLowerCase().includes(i.toLowerCase()));N(a)},I=()=>{r===0?(h(l-1),x(11)):x(r-1)},V=()=>{const a=new Date,c=a.getFullYear(),o=a.getMonth();l===c&&r===o||(r===11?(h(l+1),x(0)):x(r+1))},z=()=>{const a=["オーナー名","ドッグラン名","売上合計額","プラットフォーム手数料（20%）","振込金額（80%）","銀行名","銀行コード","支店名","支店コード","口座種別","口座番号","年","月"],c=m.map(s=>[s.owner_name,s.park_name,s.total_revenue,s.platform_fee,s.owner_payout,s.bank_name,s.bank_code,s.branch_name,s.branch_code,s.account_type==="ordinary"?"普通":"当座",s.account_number,s.year,s.month]),o=`ドッグラン売上_${l}年${r+1}月.csv`;Q(a,c,o)};return L?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(J,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(D,{className:"w-8 h-8 text-green-600 mr-3"}),"ドッグラン売上レポート"]}),e.jsxs(j,{onClick:z,disabled:m.length===0,children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"CSV出力"]})]}),w&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[e.jsx(Z,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:w})]}),e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(j,{variant:"secondary",size:"sm",onClick:I,children:e.jsx(ee,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("select",{value:l,onChange:a=>h(Number(a.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:$.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),e.jsx("select",{value:r,onChange:a=>x(Number(a.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:E.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsx(j,{variant:"secondary",size:"sm",onClick:V,disabled:l===new Date().getFullYear()&&r===new Date().getMonth(),children:e.jsx(ae,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"w-full md:w-64",children:e.jsx(K,{label:"",value:i,onChange:a=>P(a.target.value),placeholder:"オーナー名・ドッグラン名で検索...",icon:e.jsx(te,{className:"w-4 h-4 text-gray-500"})})})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"総売上"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",R.toLocaleString()]})]}),e.jsx(D,{className:"w-8 h-8 text-green-600"})]})}),e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"プラットフォーム手数料（20%）"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600",children:["¥",O.toLocaleString()]})]}),e.jsx(se,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"オーナー振込額（80%）"}),e.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:["¥",A.toLocaleString()]})]}),e.jsx(C,{className:"w-8 h-8 text-purple-600"})]})})]}),e.jsxs(d,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ドッグラン別売上"}),m.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(re,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"この月の売上データはありません"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"オーナー名"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン名"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"売上合計"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料（20%）"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込金額（80%）"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込先"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:m.map(a=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:a.owner_name}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:a.park_name}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:["¥",a.total_revenue.toLocaleString()]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:["¥",a.platform_fee.toLocaleString()]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600",children:["¥",a.owner_payout.toLocaleString()]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:a.bank_name!=="未設定"?e.jsxs("div",{children:[e.jsxs("p",{children:[a.bank_name,"（",a.bank_code,"）"]}),e.jsxs("p",{children:[a.branch_name,"（",a.branch_code,"）"]}),e.jsxs("p",{children:[a.account_type==="ordinary"?"普通":"当座"," ",a.account_number]})]}):e.jsx("span",{className:"text-red-600",children:"未設定"})})]},`${a.park_id}-${a.month}-${a.year}`))})]})})]}),e.jsx(d,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(C,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"振込情報について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 振込は毎月15日に前月分を一括で行います"}),e.jsx("p",{children:"• 振込手数料は当社負担です"}),e.jsx("p",{children:"• 振込先情報が未設定のオーナーには振込ができません"}),e.jsx("p",{children:"• 振込金額が5,000円未満の場合は翌月に繰り越されます"}),e.jsx("p",{children:"• 振込完了後、オーナーに自動でメールが送信されます"})]})]})]})})]})}export{ue as AdminRevenueReport};
