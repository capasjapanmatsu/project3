var e=(e,s,t)=>new Promise((l,r)=>{var a=e=>{try{i(t.next(e))}catch(s){r(s)}},n=e=>{try{i(t.throw(e))}catch(s){r(s)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(a,n);i((t=t.apply(e,s)).next())});import{j as s,C as t,B as l,u as r,b as a,s as n}from"./index.CQlxbczY.js";import{r as i}from"./vendor.CKEClKZl.js";import{K as c,A as d,g as x,d as m,z as o,P as h,b as u}from"./ui.C72fRZ1L.js";import{V as j,g}from"./VaccineBadge.RvE4iloV.js";import{u as N}from"./router.B_7Atevv.js";import"./supabase.X3H3st79.js";function f({lockId:r,parkName:a="ドッグパーク",purpose:n="entry",className:o="",onSuccess:h,onError:u}){const[j,g]=i.useState(""),[N,f]=i.useState(!1),[b,p]=i.useState(null),[y,v]=i.useState(null),w=()=>e(this,null,function*(){if(6===j.length){f(!0),p(null),v(null);try{const e=yield fetch("/functions/v1/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lock_id:r,pin:j,purpose:n})});if(!e.ok){const s=yield e.json();throw new Error(s.error||"PINコードの検証に失敗しました")}const s=yield e.json();if(!s.success)throw new Error(s.error||"PINコードが無効です");v(s.message||"PINコードが確認されました"),g(""),h&&h(s),setTimeout(()=>{v(null)},3e3)}catch(e){const s=e.message||"PINコードの検証に失敗しました";p(s),u&&u(s)}finally{f(!1)}}else p("PINコードは6桁で入力してください")});return s.jsx(t,{className:`p-4 ${o}`,children:s.jsxs("div",{className:"text-center",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-center",children:[s.jsx(c,{className:"w-5 h-5 text-blue-600 mr-2"}),a,"の","entry"===n?"入口":"出口"]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("p",{className:"text-gray-600 mb-4",children:["entry"===n?"入場":"退場","用のPINコードを入力してください"]}),s.jsx("div",{className:"flex justify-center",children:s.jsx("input",{type:"text",value:j,onChange:e=>{const s=e.target.value.replace(/\D/g,"");s.length<=6&&g(s)},placeholder:"6桁のPINコード",className:"px-4 py-2 text-center text-2xl tracking-widest w-48 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:6,inputMode:"numeric",pattern:"[0-9]*"})}),b&&s.jsxs("div",{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",children:[s.jsx(d,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:b})]}),y&&s.jsxs("div",{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:y})]}),s.jsxs(l,{onClick:()=>{w()},isLoading:N,disabled:6!==j.length,className:"w-full",children:[s.jsx(c,{className:"w-4 h-4 mr-2"}),N?s.jsx(m,{className:"w-4 h-4 animate-spin"}):"PINコードを確認"]}),s.jsxs("p",{className:"text-xs text-gray-500",children:["entry"===n?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]})]})})}function b(){var m;const{user:b}=r(),p=N();a();const[y,v]=i.useState([]),[w,k]=i.useState([]),[P,I]=i.useState([]),[S,_]=i.useState([]),[C,E]=i.useState(null),[T,q]=i.useState(!1),[z,B]=i.useState(""),[$,L]=i.useState("");i.useEffect(()=>{(()=>{e(this,null,function*(){if(b)try{const{data:e,error:s}=yield n.from("dogs").select("\n            *,\n            vaccine_certifications (\n              id,\n              status,\n              rabies_expiry_date,\n              combo_expiry_date,\n              approved_at\n            )\n          ").eq("owner_id",b.id);if(s)throw s;const t=(e||[]).filter(e=>"approved"===g(e));v(t),e&&e.length>0&&0===t.length&&B("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")}catch(e){B("ワンちゃんの情報を取得できませんでした。")}})})(),(()=>{e(this,null,function*(){try{q(!0);const{data:e,error:s}=yield n.from("dog_parks").select("*").eq("status","approved");if(s)throw s;I(e||[]);const{data:t,error:l}=yield n.from("smart_locks").select("*").eq("status","active");if(l)throw l;k(t||[]),t&&t.length>0&&E(t[0])}catch(e){B("データの取得に失敗しました。")}finally{q(!1)}})})()},[b]);const O=e=>"オス"===e?"くん":"ちゃん";return T?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"max-w-4xl mx-auto",children:[s.jsxs("div",{className:"flex items-center mb-6",children:[s.jsxs(l,{variant:"primary",size:"sm",onClick:()=>p(-1),className:"mr-3",children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),"戻る"]}),s.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),z&&s.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:z}),$&&s.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:$}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"space-y-6",children:[s.jsxs(t,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(h,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),0===y.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(d,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),s.jsx(l,{onClick:()=>p("/register-dog"),children:"ワンちゃんを登録する"})]}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-3",children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",3,"頭）"]}),s.jsxs("div",{className:"text-sm text-gray-600",children:[S.length,"/",3,"頭選択中"]})]}),s.jsx("div",{className:"grid grid-cols-1 gap-4",children:y.map(e=>{const t=S.includes(e.id),l=!t&&S.length>=3;return s.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(t?"border-green-500 bg-green-50":l?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>{return!l&&(s=e.id,void _(e=>e.includes(s)?e.filter(e=>e!==s):e.length<3?[...e,s]:e));var s},children:[t&&s.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:s.jsx(x,{className:"w-4 h-4"})}),s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?s.jsx("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover"}):s.jsx(h,{className:"w-6 h-6 text-gray-500"})}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[s.jsxs("h3",{className:"font-semibold",children:[e.name,O(e.gender)]}),s.jsx(j,{status:g(e),size:"sm"})]}),s.jsxs("p",{className:"text-sm text-gray-600",children:[e.breed," • ",e.gender]})]})]})]},e.id)})}),S.length>0&&s.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[s.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),s.jsx("p",{className:"text-sm text-green-800",children:S.map(e=>{const s=y.find(s=>s.id===e);return s?`${s.name}${O(s.gender)}`:""}).filter(Boolean).join("、")}),s.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[S.length,"頭が同時入場できます"]})]})]})})]}),s.jsxs(t,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(u,{className:"w-5 h-5 text-blue-600 mr-2"}),"施設を選択"]}),0===w.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(c,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"利用可能な施設がありません"})]}):s.jsx("div",{className:"space-y-3",children:w.map(e=>{const t=P.find(s=>s.id===e.park_id),l=(null==C?void 0:C.id)===e.id;return s.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+(l?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>E(e),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold",children:(null==t?void 0:t.name)||"Unknown Park"}),s.jsx("p",{className:"text-sm text-gray-600",children:e.lock_name}),s.jsx("p",{className:"text-xs text-gray-500",children:null==t?void 0:t.address})]}),l&&s.jsx(x,{className:"w-5 h-5 text-blue-600"})]})},e.id)})})]})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsxs(t,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(c,{className:"w-5 h-5 text-blue-600 mr-2"}),"PINコード生成"]}),C&&S.length>0?s.jsx(f,{lockId:C.lock_id,parkName:(null==(m=P.find(e=>e.id===C.park_id))?void 0:m.name)||"ドッグパーク",purpose:"entry",onSuccess:e=>{L("PINコードを生成しました"),setTimeout(()=>{L("")},3e3)},onError:e=>{B(e),setTimeout(()=>{B("")},5e3)}}):s.jsxs("div",{className:"text-center py-8",children:[s.jsx(d,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-2",children:"PINコードを生成するには："}),s.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[s.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),s.jsx("li",{children:"• 施設を選択"})]})]})]}),s.jsxs(t,{className:"p-6 bg-blue-50 border-blue-200",children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"PINコードの使い方"}),s.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"1"}),s.jsx("p",{children:"ワンちゃんと施設を選択してPINコードを生成します"})]}),s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"2"}),s.jsx("p",{children:"ドッグランの入口にあるスマートロックのキーパッドにPINコードを入力します"})]}),s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"3"}),s.jsx("p",{children:"PINコードは5分間有効です"})]}),s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"4"}),s.jsx("p",{children:"退場時も同様にPINコードを生成して使用します"})]})]})]})]})]})]})}export{b as AccessControl};
