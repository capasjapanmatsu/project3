import{u as e,b as r,j as a,B as t}from"./index-Dp3tQatg.js";import{r as i}from"./vendor-Cwmn0chA.js";import{I as s}from"./Input-BBpqNzSy.js";import{S as l}from"./Select-vo9_bICo.js";import{C as n}from"./Card-CPEZwr97.js";import{d as o}from"./dogBreeds-6lxY8Uni.js";import{P as c,p as d,X as m,y as u,l as b}from"./ui-BHmKMuva.js";import"./supabase-Dzr8oIt2.js";function g(){const{user:g}=e(),[x,h]=i.useState(!1),[p,f]=i.useState(""),[v,j]=i.useState(null),[y,w]=i.useState(null),[N,D]=i.useState([]),[_,I]=i.useState(!0),[S,$]=i.useState(null),[C,E]=i.useState(!1),[V,M]=i.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""});i.useEffect((()=>{g&&Y()}),[g]);const Y=async()=>{try{I(!0);const{data:e,error:a}=await r.from("dogs").select("\n          *,\n          vaccine_certifications(*)\n        ").eq("owner_id",null==g?void 0:g.id).order("created_at",{ascending:!1});if(a)throw a;D(e||[])}catch(e){}finally{I(!1)}},q=(new Date).getFullYear(),k=Array.from({length:21},((e,r)=>{const a=q-r;return{value:a.toString(),label:`${a}年`}})),F=Array.from({length:12},((e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}})),P=()=>{if(!V.birthYear||!V.birthMonth||!V.birthDay)return!1;const e=parseInt(V.birthYear),r=parseInt(V.birthMonth),a=parseInt(V.birthDay),t=new Date(e,r-1,a);if(t>new Date)return!1;const i=new Date;return i.setFullYear(i.getFullYear()-20),!(t<i)},G=o.map((e=>({value:e,label:e})));return a.jsxs("div",{className:"max-w-2xl mx-auto",children:[a.jsx("h1",{className:"text-2xl font-bold text-center mb-8",children:"ワンちゃん登録"}),_?a.jsx("div",{className:"flex justify-center items-center h-16 mb-6",children:a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})}):N.length>0&&a.jsxs(n,{className:"mb-8",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[a.jsx(c,{className:"w-5 h-5 text-blue-600 mr-2"}),"登録済みのワンちゃん"]}),a.jsx("div",{className:"space-y-4",children:N.map((e=>{const r=(e=>{var r;const a=null==(r=e.vaccine_certifications)?void 0:r[0];if(!a)return{status:"none",label:"未提出",color:"text-red-600 bg-red-100"};switch(a.status){case"approved":return{status:"approved",label:"承認済み",color:"text-green-600 bg-green-100"};case"pending":return{status:"pending",label:"承認待ち",color:"text-yellow-600 bg-yellow-100"};case"rejected":return{status:"rejected",label:"却下",color:"text-red-600 bg-red-100"};default:return{status:"none",label:"未提出",color:"text-red-600 bg-red-100"}}})(e),i="オス"===e.gender?"くん":"ちゃん";return a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?a.jsx("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover"}):a.jsx(c,{className:"w-6 h-6 text-gray-500"})}),a.jsxs("div",{children:[a.jsxs("h3",{className:"font-semibold",children:[e.name,i]}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.breed," • ",e.gender]}),a.jsx("div",{className:"flex items-center mt-1",children:a.jsxs("span",{className:`text-xs px-2 py-0.5 rounded-full ${r.color}`,children:["ワクチン: ",r.label]})})]})]}),a.jsx(t,{size:"sm",variant:"secondary",onClick:()=>(e=>{var r,a,t,i;$(e);const s=new Date(e.birth_date),l=s.getFullYear().toString(),n=(s.getMonth()+1).toString().padStart(2,"0"),o=s.getDate().toString().padStart(2,"0");M({name:e.name,breed:e.breed,birthYear:l,birthMonth:n,birthDay:o,gender:e.gender,rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:(null==(a=null==(r=e.vaccine_certifications)?void 0:r[0])?void 0:a.rabies_expiry_date)||"",comboExpiryDate:(null==(i=null==(t=e.vaccine_certifications)?void 0:t[0])?void 0:i.combo_expiry_date)||""}),w(e.image_url||null),E(!0)})(e),children:a.jsx(d,{className:"w-4 h-4"})})]},e.id)}))})]}),a.jsx(n,{children:a.jsxs("form",{onSubmit:C?async e=>{var a,t,i,s;if(e.preventDefault(),S){h(!0),f("");try{if(!P())return f("正しい生年月日を選択してください。"),void h(!1);const e=`${V.birthYear}-${V.birthMonth}-${V.birthDay}`;let o;if("オス"===V.gender||"male"===V.gender||"male"===V.gender.toLowerCase())o="オス";else{if("メス"!==V.gender&&"female"!==V.gender&&"female"!==V.gender.toLowerCase())return f("性別を正しく選択してください。"),void h(!1);o="メス"}let c=S.image_url;if(v)try{const e=v.name.split(".").pop()||"jpg",a=Date.now(),t=`${S.id}/profile_${a}.${e}`,{error:i}=await r.storage.from("dog-images").upload(t,v,{cacheControl:"3600",upsert:!0});if(i)throw new Error(`画像のアップロードに失敗しました: ${i.message}`);const{data:{publicUrl:s}}=r.storage.from("dog-images").getPublicUrl(t);c=s}catch(l){f("画像のアップロードに失敗しましたが、ワンちゃんの情報は更新されました。")}const{error:d}=await r.from("dogs").update({name:V.name,breed:V.breed,birth_date:e,gender:o,image_url:c}).eq("id",S.id);if(d)throw d;if(V.rabiesVaccineImage||V.comboVaccineImage)try{const{data:e,error:l}=await r.from("vaccine_certifications").select("id").eq("dog_id",S.id).maybeSingle();if(l&&"PGRST116"!==l.code)throw l;let n=(null==(t=null==(a=S.vaccine_certifications)?void 0:a[0])?void 0:t.rabies_vaccine_image)||null,o=(null==(s=null==(i=S.vaccine_certifications)?void 0:i[0])?void 0:s.combo_vaccine_image)||null;if(V.rabiesVaccineImage){const e=V.rabiesVaccineImage.name.split(".").pop()||"jpg",a=Date.now();n=`${S.id}/rabies_${a}.${e}`;const{error:t}=await r.storage.from("vaccine-certs").upload(n,V.rabiesVaccineImage,{cacheControl:"3600",upsert:!0});if(t)throw t}if(V.comboVaccineImage){const e=V.comboVaccineImage.name.split(".").pop()||"jpg",a=Date.now();o=`${S.id}/combo_${a}.${e}`;const{error:t}=await r.storage.from("vaccine-certs").upload(o,V.comboVaccineImage,{cacheControl:"3600",upsert:!0});if(t)throw t}const c={status:"pending"};if(n&&(c.rabies_vaccine_image=n),o&&(c.combo_vaccine_image=o),V.rabiesExpiryDate&&(c.rabies_expiry_date=V.rabiesExpiryDate),V.comboExpiryDate&&(c.combo_expiry_date=V.comboExpiryDate),e){const{error:a}=await r.from("vaccine_certifications").update(c).eq("id",e.id);if(a)throw a}}catch(n){f("ワクチン証明書の更新に失敗しました。後でマイページから再試行してください。")}await Y(),M({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),j(null),w(null),$(null),E(!1),alert("ワンちゃんの情報を更新しました！")}catch(o){f("ワンちゃんの情報更新に失敗しました。もう一度お試しください。")}finally{h(!1)}}}:async e=>{var a,t;e.preventDefault(),h(!0),f("");try{if(!P())return f("正しい生年月日を選択してください。"),void h(!1);if(!V.rabiesExpiryDate||!V.comboExpiryDate)return f("ワクチンの有効期限を入力してください。"),void h(!1);const e=new Date,l=new Date(V.rabiesExpiryDate),n=new Date(V.comboExpiryDate);if(l<=e||n<=e)return f("ワクチンの有効期限は今日より後の日付を入力してください。"),void h(!1);const o=`${V.birthYear}-${V.birthMonth}-${V.birthDay}`;let c;if("オス"===V.gender||"male"===V.gender||"male"===V.gender.toLowerCase())c="オス";else{if("メス"!==V.gender&&"female"!==V.gender&&"female"!==V.gender.toLowerCase())return f("性別を正しく選択してください。"),void h(!1);c="メス"}const{data:d,error:m}=await r.from("profiles").select("id, name, user_type").eq("id",null==g?void 0:g.id).maybeSingle();if(m&&"PGRST116"!==m.code)throw m;if(!d){const e=(null==(a=null==g?void 0:g.user_metadata)?void 0:a.name)||(null==(t=null==g?void 0:g.email)?void 0:t.split("@")[0])||"ユーザー",{data:i,error:s}=await r.from("profiles").upsert([{id:null==g?void 0:g.id,user_type:"user",name:e,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(s)throw s}const{data:u,error:b}=await r.from("dogs").insert([{name:V.name,breed:V.breed,birth_date:o,gender:c,owner_id:null==g?void 0:g.id}]).select().single();if(b)throw b;let x=null;if(v)try{const e=v.name.split(".").pop()||"jpg",a=Date.now(),t=`${u.id}/profile_${a}.${e}`,{error:i}=await r.storage.from("dog-images").upload(t,v,{cacheControl:"3600",upsert:!0});if(i)throw new Error(`画像のアップロードに失敗しました: ${i.message}`);const{data:{publicUrl:s}}=r.storage.from("dog-images").getPublicUrl(t);x=s;const{error:l}=await r.from("dogs").update({image_url:x}).eq("id",u.id);if(l)throw new Error("画像URLの更新に失敗しました")}catch(i){f("画像のアップロードに失敗しましたが、ワンちゃんの登録は完了しました。後でマイページから画像を追加できます。")}if(V.rabiesVaccineImage&&V.comboVaccineImage)try{const e=V.rabiesVaccineImage.name.split(".").pop()||"jpg",a=V.comboVaccineImage.name.split(".").pop()||"jpg",t=Date.now(),i=`${u.id}/rabies_${t}.${e}`,s=`${u.id}/combo_${t}.${a}`,[l,n]=await Promise.all([r.storage.from("vaccine-certs").upload(i,V.rabiesVaccineImage,{cacheControl:"3600",upsert:!0}),r.storage.from("vaccine-certs").upload(s,V.comboVaccineImage,{cacheControl:"3600",upsert:!0})]);if(l.error)throw l.error;if(n.error)throw n.error;const{error:o}=await r.from("vaccine_certifications").insert([{dog_id:u.id,rabies_vaccine_image:i,combo_vaccine_image:s,rabies_expiry_date:V.rabiesExpiryDate,combo_expiry_date:V.comboExpiryDate}]);if(o)throw o}catch(s){f("ワクチン証明書のアップロードに失敗しました。後でマイページから追加してください。")}await Y(),M({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),j(null),w(null),E(!1),alert("ワンちゃんの登録が完了しました！")}catch(l){f("ワンちゃんの登録に失敗しました。もう一度お試しください。")}finally{h(!1)}},children:[p&&a.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:p}),a.jsxs("div",{className:"mb-6",children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["ワンちゃんの写真",C?"":"（任意）"]}),y?a.jsxs("div",{className:"relative",children:[a.jsx("img",{src:y,alt:"ワンちゃんのプレビュー",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),a.jsx("button",{type:"button",onClick:()=>{j(null),w(null)},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:a.jsx(m,{className:"w-4 h-4"})})]}):a.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){if(a.size>10485760)return void f("画像ファイルは10MB以下にしてください。");if(!a.type.startsWith("image/"))return void f("画像ファイルを選択してください。");j(a);const e=new FileReader;e.onload=e=>{var r;w(null==(r=e.target)?void 0:r.result)},e.readAsDataURL(a),f("")}},className:"hidden",id:"dog-image"}),a.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[a.jsx(u,{className:"w-12 h-12 text-gray-400 mb-2"}),a.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"}),a.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (最大10MB)"})]})]})]}),a.jsx(s,{label:"名前",value:V.name,onChange:e=>M({...V,name:e.target.value}),required:!0}),a.jsx(l,{label:"犬種",options:G,value:V.breed,onChange:e=>M({...V,breed:e.target.value}),required:!0}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"生年月日 *"}),a.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[a.jsx("div",{children:a.jsxs("select",{value:V.birthYear,onChange:e=>{M({...V,birthYear:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[a.jsx("option",{value:"",children:"年"}),k.map((e=>a.jsx("option",{value:e.value,children:e.label},e.value)))]})}),a.jsx("div",{children:a.jsxs("select",{value:V.birthMonth,onChange:e=>{M({...V,birthMonth:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[a.jsx("option",{value:"",children:"月"}),F.map((e=>a.jsx("option",{value:e.value,children:e.label},e.value)))]})}),a.jsx("div",{children:a.jsxs("select",{value:V.birthDay,onChange:e=>M({...V,birthDay:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!V.birthYear||!V.birthMonth,children:[a.jsx("option",{value:"",children:"日"}),(()=>{if(!V.birthYear||!V.birthMonth)return Array.from({length:31},((e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}}));const e=parseInt(V.birthYear),r=parseInt(V.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},((e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}}))})().map((e=>a.jsx("option",{value:e.value,children:e.label},e.value)))]})})]}),V.birthYear&&V.birthMonth&&!V.birthDay&&a.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"日を選択してください"}),V.birthYear&&V.birthMonth&&V.birthDay&&!P()&&a.jsx("p",{className:"mt-1 text-sm text-red-500",children:"正しい生年月日を選択してください（未来の日付や20年以上前の日付は選択できません）"})]}),a.jsx(l,{label:"性別",options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],value:V.gender,onChange:e=>M({...V,gender:e.target.value}),required:!0}),C?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"狂犬病ワクチン接種証明書（更新する場合のみ）"}),a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;return M({...V,rabiesVaccineImage:(null==(r=e.target.files)?void 0:r[0])||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"混合ワクチン接種証明書（更新する場合のみ）"}),a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;return M({...V,comboVaccineImage:(null==(r=e.target.files)?void 0:r[0])||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),a.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg mb-4",children:a.jsxs("div",{className:"flex items-start space-x-2",children:[a.jsx(b,{className:"w-5 h-5 text-yellow-600 mt-0.5"}),a.jsxs("div",{className:"text-sm text-yellow-800",children:[a.jsx("p",{className:"font-medium mb-1",children:"ワクチン証明書の更新について"}),a.jsx("p",{children:"新しいワクチン証明書をアップロードすると、再度審査が必要になります。審査完了までドッグランの利用ができなくなる場合があります。"})]})]})})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"狂犬病ワクチン接種証明書"}),a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;return M({...V,rabiesVaccineImage:(null==(r=e.target.files)?void 0:r[0])||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"狂犬病ワクチン有効期限 *"}),a.jsx("input",{type:"date",value:V.rabiesExpiryDate,onChange:e=>M({...V,rabiesExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"混合ワクチン接種証明書"}),a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;return M({...V,comboVaccineImage:(null==(r=e.target.files)?void 0:r[0])||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"混合ワクチン有効期限 *"}),a.jsx("input",{type:"date",value:V.comboExpiryDate,onChange:e=>M({...V,comboExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]})]}),!C&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:a.jsx("p",{className:"text-sm text-yellow-800",children:"※ ワクチン接種証明書は運営による確認後に承認されます。承認されるまでドッグランの利用はできません。"})}),a.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:a.jsxs("p",{className:"text-sm text-blue-800",children:[a.jsx("span",{className:"font-medium",children:"生年月日について:"}),a.jsx("br",{}),"• 年、月、日をそれぞれ選択してください",a.jsx("br",{}),"• 未来の日付は選択できません",a.jsx("br",{}),"• 20年以上前の日付は選択できません",a.jsx("br",{}),"• 月を変更すると、その月の日数に応じて日の選択肢が更新されます"]})}),a.jsx("div",{className:"mt-4 p-3 bg-green-50 rounded-lg",children:a.jsxs("p",{className:"text-sm text-green-800",children:[a.jsx("span",{className:"font-medium",children:"写真について:"}),a.jsx("br",{}),"• ワンちゃんの写真は任意ですが、コミュニティで他の飼い主さんに見てもらえます",a.jsx("br",{}),"• JPG、PNG、GIF形式で最大10MBまでアップロード可能",a.jsx("br",{}),"• 後からマイページで変更することもできます"]})}),a.jsx("div",{className:"mt-4 p-3 bg-orange-50 rounded-lg",children:a.jsxs("p",{className:"text-sm text-orange-800",children:[a.jsx("span",{className:"font-medium",children:"ワクチン有効期限について:"}),a.jsx("br",{}),"• 狂犬病ワクチンと混合ワクチンの有効期限を正確に入力してください",a.jsx("br",{}),"• 有効期限が切れると自動的に再承認待ちになります",a.jsx("br",{}),"• 期限切れ30日前に通知をお送りします",a.jsx("br",{}),"• 新しいワクチン証明書は期限切れ前にアップロードしてください"]})})]}),a.jsxs("div",{className:"flex justify-between mt-4",children:[C&&a.jsx(t,{type:"button",variant:"secondary",onClick:()=>{E(!1),$(null),M({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),j(null),w(null)},children:"キャンセル"}),a.jsx(t,{type:"submit",isLoading:x,className:C?"":"w-full",children:C?"更新する":"登録する"})]})]})})]})}export{g as DogRegistration};
