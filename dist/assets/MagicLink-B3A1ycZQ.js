import{j as e,C as s,B as a,s as t,b as r}from"./index-CG6tuKmC.js";import{u as i,d as n,r as o}from"./vendor-BHVjIt_u.js";import{p as c,A as m,s as l}from"./ui-BlUB7fmN.js";import"./supabase-CKbzEL5D.js";function d(){const d=i(),x=n(),[u,h]=o.useState(!0),[p,f]=o.useState(null),[j,b]=o.useState(!1);return o.useEffect((()=>{(async()=>{try{h(!0);const e=window.location.hash;if(!e||!e.includes("access_token"))return void f("無効なMagic Linkです。もう一度ログインしてください。");const s=new URLSearchParams(e.substring(1)),a=s.get("access_token"),i=s.get("refresh_token");if(!a||!i)return void f("認証トークンが見つかりません。もう一度ログインしてください。");const{error:n}=await t.auth.setSession({access_token:a,refresh_token:i});if(n)throw n;const{data:{user:o},error:c}=await t.auth.getUser();if(c||!o)throw c||new Error("ユーザー情報の取得に失敗しました");const{data:m,error:l}=await t.from("profiles").select("id").eq("id",o.id).maybeSingle();if(l&&l.code,!m){const e=o.user_metadata||{},{error:s}=await t.from("profiles").upsert([{id:o.id,user_type:e.user_type||"user",name:e.name||o.email?.split("@")[0]||"ユーザー",postal_code:e.postal_code||"",address:e.address||"",phone_number:e.phone_number||""}],{onConflict:"id"})}o&&r(`trusted_device_${o.id}`,"true"),b(!0),setTimeout((()=>{d("/dashboard")}),2e3)}catch(e){f(e.message||"マジックリンクの送信に失敗しました")}finally{h(!1)}})()}),[d,x]),u?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(s,{className:"text-center p-8",children:[e.jsx(c,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(s,{className:"text-center p-8",children:[e.jsx(m,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p}),e.jsx(a,{onClick:()=>d("/login"),children:"ログインページに戻る"})]})}):j?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(s,{className:"text-center p-8",children:[e.jsx(l,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(a,{onClick:()=>d("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{d as MagicLink};
