import{b as e,j as s,B as t}from"./index-Dp3tQatg.js";import{u as a,b as r,r as l,L as c}from"./vendor-Cwmn0chA.js";import{C as n}from"./Card-CPEZwr97.js";import{X as i,l as m,i as x,h as d,g as o,d as h,b as j,q as u,$ as N,A as f}from"./ui-BHmKMuva.js";import"./supabase-Dzr8oIt2.js";function p(){const p=a(),b=r(),[g,v]=l.useState(null),[w,y]=l.useState("shop"),[_,S]=l.useState(null),[k,R]=l.useState(5),[q,C]=l.useState(!0),[P,Q]=l.useState(null),[$,E]=l.useState(!1);l.useEffect((()=>{const e=new URLSearchParams(window.location.search),s=e.get("session_id"),t=e.get("success"),a=e.get("canceled"),r=e.get("order_number");if("true"===a)return E(!0),Q("支払いがキャンセルされました。もう一度お試しください。"),void C(!1);if("true"===t||s){r&&v(r),s?I(s):z();const e=setInterval((()=>{R((s=>s<=1?(clearInterval(e),"shop"===w?p("/orders",{state:{orderSuccess:!0,orderNumber:r}}):p("/entrance-qr"),0):s-1))}),1e3);return()=>clearInterval(e)}p("/")}),[b,p]);const I=async s=>{var t;try{C(!0);const{data:{session:a}}=await e.auth.getSession();if(!(null==a?void 0:a.access_token))throw new Error("認証が必要です");const r=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-session-details",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`},body:JSON.stringify({session_id:s})});if(!r.ok)throw new Error("セッション情報の取得に失敗しました");const l=await r.json();"subscription"===l.mode?y("reservation"):l.custom_name&&l.custom_name.includes("施設貸し切り")?(y("facility_rental"),S({parkName:l.custom_name.split(" 施設貸し切り ")[0],date:l.custom_name.split(" 施設貸し切り ")[1].split(" ")[0],time:l.custom_name.split(" 施設貸し切り ")[1].split(" ")[1],totalPrice:l.amount_total/100})):(y("shop"),v(l.client_reference_id||(null==(t=l.metadata)?void 0:t.order_number)||"DP"+Date.now()))}catch(a){Q(a.message||"エラーが発生しました")}finally{C(!1)}},z=async()=>{try{C(!0);const{data:s,error:t}=await e.from("orders").select("order_number").order("created_at",{ascending:!1}).limit(1).single();if(t)throw t;s&&(v(s.order_number),y("shop"))}catch(s){Q(s.message||"エラーが発生しました")}finally{C(!1)}};return q?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):$||P?s.jsx("div",{className:"max-w-3xl mx-auto py-8",children:s.jsxs(n,{className:"p-8 text-center",children:[s.jsx("div",{className:"w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6",children:s.jsx(i,{className:"w-12 h-12 text-red-600"})}),s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"支払いに失敗しました"}),s.jsx("div",{className:"bg-red-50 p-6 rounded-lg mb-8 max-w-xl mx-auto",children:s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx(m,{className:"w-6 h-6 text-red-600 mt-1 flex-shrink-0"}),s.jsxs("div",{className:"text-left",children:[s.jsx("p",{className:"text-red-800 font-medium mb-2",children:P||"支払い処理中にエラーが発生しました。"}),s.jsx("p",{className:"text-red-700 text-sm",children:"以下をご確認ください："}),s.jsxs("ul",{className:"text-sm text-red-700 list-disc list-inside mt-1 space-y-1",children:[s.jsx("li",{children:"カード情報が正しいか確認してください"}),s.jsx("li",{children:"別の支払い方法をお試しください"}),s.jsx("li",{children:"しばらく経ってから再度お試しください"})]})]})]})}),s.jsxs("div",{className:"flex justify-center space-x-4",children:[s.jsx(c,{to:"/checkout",children:s.jsx(t,{children:"支払いをやり直す"})}),s.jsx(c,{to:"/cart",children:s.jsx(t,{variant:"secondary",children:"カートに戻る"})})]})]})}):s.jsx("div",{className:"max-w-3xl mx-auto py-8",children:s.jsxs(n,{className:"p-8 text-center",children:[s.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6",children:s.jsx(x,{className:"w-12 h-12 text-green-600"})}),s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"決済が完了しました！"}),g&&s.jsxs("p",{className:"text-lg text-gray-600 mb-6",children:["注文番号: ",s.jsx("span",{className:"font-semibold",children:g})]}),s.jsxs("div",{className:"bg-blue-50 p-6 rounded-lg mb-8 max-w-xl mx-auto",children:["shop"===w&&s.jsxs("div",{className:"text-left",children:[s.jsxs("div",{className:"flex items-center mb-4",children:[s.jsx(d,{className:"w-6 h-6 text-blue-600 mr-3"}),s.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"ショッピング注文"})]}),s.jsx("p",{className:"text-blue-800 mb-2",children:"ご注文ありがとうございます。商品の発送準備を進めています。"}),s.jsx("p",{className:"text-blue-800",children:"注文の詳細は「注文履歴」ページでご確認いただけます。"})]}),"reservation"===w&&s.jsxs("div",{className:"text-left",children:[s.jsxs("div",{className:"flex items-center mb-4",children:[s.jsx(o,{className:"w-6 h-6 text-blue-600 mr-3"}),s.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"ドッグラン予約"})]}),s.jsx("p",{className:"text-blue-800 mb-2",children:"ご予約ありがとうございます。予約が確定しました。"}),s.jsx("p",{className:"text-blue-800",children:"入場には入場QRコードが必要です。下のボタンから発行してください。"})]}),"facility_rental"===w&&_&&s.jsxs("div",{className:"text-left",children:[s.jsxs("div",{className:"flex items-center mb-4",children:[s.jsx(h,{className:"w-6 h-6 text-orange-600 mr-3"}),s.jsx("h2",{className:"text-xl font-semibold text-orange-900",children:"施設貸し切り予約"})]}),s.jsxs("div",{className:"space-y-2 mb-4",children:[s.jsxs("div",{className:"flex items-start",children:[s.jsx(j,{className:"w-5 h-5 text-orange-600 mt-0.5 mr-2 flex-shrink-0"}),s.jsx("p",{className:"text-orange-800",children:String(_.parkName)})]}),s.jsxs("div",{className:"flex items-start",children:[s.jsx(o,{className:"w-5 h-5 text-orange-600 mt-0.5 mr-2 flex-shrink-0"}),s.jsx("p",{className:"text-orange-800",children:String(_.date)})]}),s.jsxs("div",{className:"flex items-start",children:[s.jsx(u,{className:"w-5 h-5 text-orange-600 mt-0.5 mr-2 flex-shrink-0"}),s.jsx("p",{className:"text-orange-800",children:String(_.time)})]})]}),s.jsx("p",{className:"text-orange-800 font-medium",children:"入場には入場QRコードが必要です。下のボタンから発行してください。"})]})]}),s.jsxs("div",{className:"space-y-4",children:["shop"!==w&&s.jsxs(t,{onClick:()=>{p("/entrance-qr")},className:"bg-green-600 hover:bg-green-700 text-lg py-3 px-8",children:[s.jsx(N,{className:"w-5 h-5 mr-2"}),"入場QRコードを発行する",s.jsx(f,{className:"w-5 h-5 ml-2"})]}),s.jsx("p",{className:"text-sm text-gray-500",children:"shop"!==w?`${k}秒後に自動的に入場QRコード発行画面に移動します...`:`${k}秒後に自動的に注文履歴画面に移動します...`}),s.jsxs("div",{className:"flex justify-center space-x-4 mt-6",children:[s.jsx(c,{to:"/dashboard",children:s.jsx(t,{variant:"secondary",children:"ダッシュボードに戻る"})}),"shop"===w&&s.jsx(c,{to:"/orders",children:s.jsx(t,{variant:"secondary",children:"注文履歴を見る"})})]})]})]})})}export{p as PaymentConfirmation};
