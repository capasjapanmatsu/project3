import{j as e,B as s,s as a,b as t}from"./index-T-nty6Ge.js";import{u as r,d as i,r as n}from"./vendor-BHVjIt_u.js";import{C as o}from"./Card-DW8Xk96S.js";import{n as c,k as m,q as l}from"./ui-srxHNTHo.js";import"./supabase-CKbzEL5D.js";function d(){const d=r(),x=i(),[u,h]=n.useState(!0),[p,f]=n.useState(null),[j,b]=n.useState(!1);return n.useEffect((()=>{(async()=>{try{h(!0);const e=window.location.hash;if(!e||!e.includes("access_token"))return void f("無効なMagic Linkです。もう一度ログインしてください。");const s=new URLSearchParams(e.substring(1)),r=s.get("access_token"),i=s.get("refresh_token");if(!r||!i)return void f("認証トークンが見つかりません。もう一度ログインしてください。");const{error:n}=await a.auth.setSession({access_token:r,refresh_token:i});if(n)throw n;const{data:{user:o},error:c}=await a.auth.getUser();if(c||!o)throw c||new Error("ユーザー情報の取得に失敗しました");const{data:m,error:l}=await a.from("profiles").select("id").eq("id",o.id).maybeSingle();if(l&&l.code,!m){const e=o.user_metadata||{},{error:s}=await a.from("profiles").upsert([{id:o.id,user_type:e.user_type||"user",name:e.name||o.email?.split("@")[0]||"ユーザー",postal_code:e.postal_code||"",address:e.address||"",phone_number:e.phone_number||""}],{onConflict:"id"})}o&&t(`trusted_device_${o.id}`,"true"),b(!0),setTimeout((()=>{d("/dashboard")}),2e3)}catch(e){f(e.message||"マジックリンクの送信に失敗しました")}finally{h(!1)}})()}),[d,x]),u?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"text-center p-8",children:[e.jsx(c,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"text-center p-8",children:[e.jsx(m,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p}),e.jsx(s,{onClick:()=>d("/login"),children:"ログインページに戻る"})]})}):j?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"text-center p-8",children:[e.jsx(l,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(s,{onClick:()=>d("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{d as MagicLink};
