var e=Object.defineProperty,r=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,l=(r,a,t)=>a in r?e(r,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[a]=t,o=(e,r)=>{for(var a in r||(r={}))s.call(r,a)&&l(e,a,r[a]);if(t)for(var a of t(r))i.call(r,a)&&l(e,a,r[a]);return e},n=(e,t)=>r(e,a(t)),d=(e,r,a)=>new Promise((t,s)=>{var i=e=>{try{o(a.next(e))}catch(r){s(r)}},l=e=>{try{o(a.throw(e))}catch(r){s(r)}},o=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,l);o((a=a.apply(e,r)).next())});import{s as c,u,j as m,B as g,C as b,n as p}from"./index.Drgpoyph.js";import{r as h}from"./vendor.CKEClKZl.js";import{L as f}from"./router.B_7Atevv.js";import{I as x}from"./Input.CUuxlVXM.js";import{S as y}from"./Select.CxVKDZ1_.js";import{d as v}from"./dogBreeds.6lxY8Uni.js";import{l as j}from"./logger.X2WpaG9g.js";import{z as w,X as N,V as D}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";const I=e=>{if(!e)return{isValid:!1,error:"ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"};if(e.size>10485760)return{isValid:!1,error:"ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${e.type}`}},S=(e,r)=>d(void 0,null,function*(){try{const a=I(e);if(!a.isValid)return{success:!1,error:a.error};const t=Date.now(),s=e.name.split(".").pop()||"jpg",i=`${r.dogId}/${r.imageType}_${t}.${s}`,{data:l,error:o}=yield c.storage.from("vaccine-certs").upload(i,e,{cacheControl:"3600",upsert:!0,contentType:e.type});return o?{success:!1,error:`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${o.message}`,errorCode:o.message}:{success:!0,filePath:i}}catch(a){return{success:!1,error:`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${a.message}`}}});function C(){const{user:e}=u(),[r,a]=h.useState(!1),[t,s]=h.useState(""),[i,l]=h.useState(null),[C,V]=h.useState(null),[$,E]=h.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),P=(new Date).getFullYear(),M=Array.from({length:21},(e,r)=>{const a=P-r;return{value:a.toString(),label:`${a}å¹´`}}),Y=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}æœˆ`}}),O=()=>{if(!$.birthYear||!$.birthMonth||!$.birthDay)return!1;const e=parseInt($.birthYear),r=parseInt($.birthMonth),a=parseInt($.birthDay),t=new Date(e,r-1,a);if(t>new Date)return!1;const s=new Date;return s.setFullYear(s.getFullYear()-20),!(t<s)},T=v.map(e=>({value:e,label:e}));return m.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[m.jsxs("div",{children:[m.jsxs(f,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[m.jsx(w,{className:"w-4 h-4 mr-1"}),"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹"]}),m.jsx("h1",{className:"text-2xl font-bold",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç™»éŒ²"}),m.jsx("p",{className:"text-gray-600",children:"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã—ã¦ã€ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã—ã‚‡ã†"})]}),m.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:m.jsxs("div",{className:"flex items-center justify-between",children:[m.jsxs("div",{children:[m.jsx("h3",{className:"font-medium text-blue-900",children:"æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒã„ã¾ã™ã‹ï¼Ÿ"}),m.jsx("p",{className:"text-sm text-blue-700",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™"})]}),m.jsx(f,{to:"/dog-management",children:m.jsx(g,{variant:"secondary",size:"sm",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"})})]})}),m.jsx(b,{children:m.jsxs("form",{onSubmit:r=>d(this,null,function*(){var t,o;r.preventDefault(),a(!0),s("");try{if(j.info("=== DOG REGISTRATION START ==="),j.info("Starting dog registration for user:",null==e?void 0:e.id),!O())return s("æ­£ã—ã„ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"),void a(!1);if(!$.rabiesExpiryDate||!$.comboExpiryDate)return s("ãƒ¯ã‚¯ãƒãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"),void a(!1);const r=new Date,d=new Date($.rabiesExpiryDate),u=new Date($.comboExpiryDate);if(d<=r||u<=r)return s("ãƒ¯ã‚¯ãƒãƒ³ã®æœ‰åŠ¹æœŸé™ã¯ä»Šæ—¥ã‚ˆã‚Šå¾Œã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"),void a(!1);const m=`${$.birthYear}-${$.birthMonth}-${$.birthDay}`;let g;if("ã‚ªã‚¹"===$.gender||"male"===$.gender||"male"===$.gender.toLowerCase())g="ã‚ªã‚¹";else{if("ãƒ¡ã‚¹"!==$.gender&&"female"!==$.gender&&"female"!==$.gender.toLowerCase())return s("æ€§åˆ¥ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„ã€‚"),void a(!1);g="ãƒ¡ã‚¹"}j.info("Original gender:",$.gender,"Normalized gender:",g);const{data:b,error:h}=yield c.from("profiles").select("id, name, user_type").eq("id",null==e?void 0:e.id).maybeSingle();if(j.info("Profile check result:",b,h),h&&"PGRST116"!==h.code)throw j.error("Profile error:",h),h;if(b)j.info("Profile exists:",b);else{j.info("Creating profile for dog registration using upsert");const r=(null==(t=null==e?void 0:e.user_metadata)?void 0:t.name)||(null==(o=null==e?void 0:e.email)?void 0:o.split("@")[0])||"ãƒ¦ãƒ¼ã‚¶ãƒ¼",{data:a,error:s}=yield c.from("profiles").upsert([{id:null==e?void 0:e.id,user_type:"user",name:r,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(s)throw j.error("Profile upsert error:",s),s;j.info("Profile upserted successfully:",a)}j.info("Registering dog with data:",{name:$.name,breed:$.breed,birth_date:m,gender:g,owner_id:null==e?void 0:e.id});const{data:f,error:x}=yield c.from("dogs").insert([{name:$.name,breed:$.breed,birth_date:m,gender:g,owner_id:null==e?void 0:e.id}]).select().single();if(x)throw j.error("ğŸš¨ Dog registration error:",x),j.error("ğŸš¨ Error details:",{message:x.message,code:x.code,details:x.details,hint:x.hint}),x;j.info("âœ… Dog registered successfully:",f),j.info("âœ… Dog ID generated:",f.id);let y=null;if(i){j.info("Uploading dog image...");try{const e=i.name.split(".").pop()||"jpg",r=Date.now(),a=`${f.id}/profile_${r}.${e}`;j.info("Uploading to path:",a),j.info("ğŸ”§ Uploading dog image with Content-Type:",i.type);const{error:t}=yield c.storage.from("dog-images").upload(a,i,{cacheControl:"3600",upsert:!0,contentType:i.type});if(t)throw j.error("Image upload error:",t),new Error(`ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${t.message}`);j.info("Upload successful");const{data:{publicUrl:s}}=c.storage.from("dog-images").getPublicUrl(a);y=s,j.info("Public URL generated:",y);const{error:l}=yield c.from("dogs").update({image_url:y}).eq("id",f.id);if(l)throw j.error("Error updating dog image URL:",l),new Error("ç”»åƒURLã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");j.info("Dog image URL updated successfully")}catch(n){j.error("Image processing error:",n),s("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ç™»éŒ²ã¯å®Œäº†ã—ã¾ã—ãŸã€‚å¾Œã§ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã‚’è¿½åŠ ã§ãã¾ã™ã€‚")}}if($.rabiesVaccineImage&&$.comboVaccineImage){j.info("ğŸ§ª Starting vaccine certificates upload using utility...");const e=yield S($.rabiesVaccineImage,{dogId:f.id,imageType:"rabies"});yield S($.comboVaccineImage,{dogId:f.id,imageType:"combo"});e.success?j.info("âœ… Vaccine certificates uploaded successfully"):(j.error("Vaccine upload failed:",e.error),s(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.error}`))}j.info("Dog registration completed successfully"),p.success("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼"),E({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),l(null),V(null)}catch(d){j.error("Registration error:",d),s("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")}finally{a(!1)}}),children:[t&&m.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:t}),m.jsxs("div",{className:"mb-6",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å†™çœŸï¼ˆä»»æ„ï¼‰"}),C?m.jsxs("div",{className:"relative",children:[m.jsx("img",{src:C,alt:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),m.jsx("button",{type:"button",onClick:()=>{l(null),V(null)},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:m.jsx(N,{className:"w-4 h-4"})}),i&&m.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:i.name})]}):m.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[m.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){if(j.info("Selected file:",a.name,a.size,a.type),a.size>10485760)return void s("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!a.type.startsWith("image/"))return void s("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");l(a);const e=new FileReader;e.onload=e=>{var r;V(null==(r=e.target)?void 0:r.result),j.info("Image preview created")},e.readAsDataURL(a),s("")}},className:"hidden",id:"dog-image"}),m.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[m.jsx(D,{className:"w-12 h-12 text-gray-400 mb-2"}),m.jsx("span",{className:"text-sm text-gray-600",children:"ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ"}),m.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (æœ€å¤§10MB)"})]})]})]}),m.jsx(x,{label:"åå‰",value:$.name,onChange:e=>E(n(o({},$),{name:e.target.value})),required:!0}),m.jsx(y,{label:"çŠ¬ç¨®",options:T,value:$.breed,onChange:e=>E(n(o({},$),{breed:e.target.value})),required:!0}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ç”Ÿå¹´æœˆæ—¥ *"}),m.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[m.jsx("div",{children:m.jsxs("select",{value:$.birthYear,onChange:e=>{E(n(o({},$),{birthYear:e.target.value,birthDay:""}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[m.jsx("option",{value:"",children:"å¹´"}),M.map(e=>m.jsx("option",{value:e.value,children:e.label},e.value))]})}),m.jsx("div",{children:m.jsxs("select",{value:$.birthMonth,onChange:e=>{E(n(o({},$),{birthMonth:e.target.value,birthDay:""}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[m.jsx("option",{value:"",children:"æœˆ"}),Y.map(e=>m.jsx("option",{value:e.value,children:e.label},e.value))]})}),m.jsx("div",{children:m.jsxs("select",{value:$.birthDay,onChange:e=>E(n(o({},$),{birthDay:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!$.birthYear||!$.birthMonth,children:[m.jsx("option",{value:"",children:"æ—¥"}),(()=>{if(!$.birthYear||!$.birthMonth)return Array.from({length:31},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}æ—¥`}});const e=parseInt($.birthYear),r=parseInt($.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}æ—¥`}})})().map(e=>m.jsx("option",{value:e.value,children:e.label},e.value))]})})]}),$.birthYear&&$.birthMonth&&!$.birthDay&&m.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„"}),$.birthYear&&$.birthMonth&&$.birthDay&&!O()&&m.jsx("p",{className:"mt-1 text-sm text-red-500",children:"æ­£ã—ã„ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆæœªæ¥ã®æ—¥ä»˜ã‚„20å¹´ä»¥ä¸Šå‰ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“ï¼‰"})]}),m.jsx(y,{label:"æ€§åˆ¥",options:[{value:"",label:"æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„"},{value:"ã‚ªã‚¹",label:"ã‚ªã‚¹"},{value:"ãƒ¡ã‚¹",label:"ãƒ¡ã‚¹"}],value:$.gender,onChange:e=>E(n(o({},$),{gender:e.target.value})),required:!0}),m.jsxs("div",{className:"space-y-4",children:[m.jsx("h3",{className:"text-lg font-semibold",children:"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸"}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ç‹‚çŠ¬ç—…ãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è¨¼æ˜æ›¸ *"}),m.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){const e=I(a);if(!e.isValid)return void s(e.error||"ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");s("")}E(n(o({},$),{rabiesVaccineImage:a||null}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ç‹‚çŠ¬ç—…ãƒ¯ã‚¯ãƒãƒ³æœ‰åŠ¹æœŸé™ *"}),m.jsx("input",{type:"date",value:$.rabiesExpiryDate,onChange:e=>E(n(o({},$),{rabiesExpiryDate:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"æ··åˆãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è¨¼æ˜æ›¸ *"}),m.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){const e=I(a);if(!e.isValid)return void s(e.error||"ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");s("")}E(n(o({},$),{comboVaccineImage:a||null}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"æ··åˆãƒ¯ã‚¯ãƒãƒ³æœ‰åŠ¹æœŸé™ *"}),m.jsx("input",{type:"date",value:$.comboExpiryDate,onChange:e=>E(n(o({},$),{comboExpiryDate:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]})]}),m.jsxs("div",{className:"space-y-3",children:[m.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:m.jsx("p",{className:"text-sm text-yellow-800",children:"â€» ãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è¨¼æ˜æ›¸ã¯é‹å–¶ã«ã‚ˆã‚‹ç¢ºèªå¾Œã«æ‰¿èªã•ã‚Œã¾ã™ã€‚æ‰¿èªã•ã‚Œã‚‹ã¾ã§ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã®åˆ©ç”¨ã¯ã§ãã¾ã›ã‚“ã€‚"})}),m.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:m.jsxs("p",{className:"text-sm text-blue-800",children:[m.jsx("span",{className:"font-medium",children:"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã«ã¤ã„ã¦:"}),m.jsx("br",{}),"â€¢ ç®¡ç†è€…ãŒç¢ºèªã—ã‚„ã™ã„å½¢ã§ä¿å­˜ã•ã‚Œã¾ã™",m.jsx("br",{}),"â€¢ æ‰¿èªã•ã‚Œã‚‹ã¨æ­£å¼ã«ãƒ¯ã‚¯ãƒãƒ³æƒ…å ±ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™",m.jsx("br",{}),"â€¢ æ‰¿èªå¾Œã€å…¨å›½ã®ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™"]})})]}),m.jsx(g,{type:"submit",isLoading:r,className:"w-full",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"})]})})]})}export{C as DogRegistration};
