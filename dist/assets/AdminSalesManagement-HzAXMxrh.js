import{j as e,J as ge,ad as B,az as Y,aO as fe,aN as _e,aP as je,b as V,k as J,q as I,a0 as ye,D as we}from"./ui-vendor-w2MLOks7.js";import{u as Ne,r as l,L as ve}from"./react-vendor-_GyjDmDn.js";import{u as be,s as d,C as p,B as Se}from"./index-pj4YkVsE.js";import{I as De}from"./Input-BBFNs-Kh.js";import"./supabase-vendor-Df9iqQzW.js";function Re(){const{isAdmin:O}=be(),R=Ne(),[m,z]=l.useState([]),[x,G]=l.useState([]),[ke,H]=l.useState(null),[K,U]=l.useState(!0),[$,P]=l.useState(""),[g,Q]=l.useState(""),[N,W]=l.useState("all"),[v,X]=l.useState(""),[w,Z]=l.useState("transaction_date"),[k,ee]=l.useState("desc");l.useEffect(()=>{if(!O){R("/");return}te(),se()},[O,R]),l.useEffect(()=>{ae()},[m,g,N,v,w,k]);const te=async()=>{try{U(!0),P("");const{data:t,error:s}=await d.from("reservations").select(`
          id,
          user_id,
          park_id,
          total_amount,
          status,
          reservation_type,
          created_at
        `).not("total_amount","is",null).order("created_at",{ascending:!1});if(s)throw console.error("Reservations error:",s),new Error("予約売上データの取得に失敗しました");let r=null,c=null;try{const{data:a,error:n}=await d.from("stripe_subscriptions").select(`
            id,
            customer_id,
            status,
            current_period_start,
            current_period_end,
            created_at
          `).in("status",["active","trialing","past_due","canceled"]).not("deleted_at","is",null);r=a,c=n}catch(a){console.warn("Stripe subscriptions table not available:",a),r=[],c=null}let i=null;try{const{data:a,error:n}=await d.auth.admin.listUsers();n?console.warn("Auth users fetch failed for sales:",n):(i=a,console.log("Successfully fetched auth users for sales"))}catch(a){console.warn("Auth admin API not available for sales:",a)}const o=await Promise.all((t||[]).map(async a=>{try{const{data:n}=await d.from("profiles").select("name").eq("id",a.user_id).single(),{data:j}=await d.from("dog_parks").select("name").eq("id",a.park_id).single(),h=a.total_amount||0,u=Math.round(h*.2),f=h-u,_=i?.users?.find(y=>y.id===a.user_id)?.email;return{id:a.id,user_name:n?.name||"Unknown",user_email:_||`user_${a.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:a.created_at,amount:h,commission:u,commission_rate:.2,net_amount:f,payment_method:"card",payment_status:a.status==="confirmed"?"paid":"pending",description:`${j?.name||"Unknown Park"} - 予約料金`,is_subscription_user:a.reservation_type==="subscription",created_at:a.created_at}}catch(n){return console.error(`Error processing reservation ${a.id}:`,n),{id:a.id,user_name:"Unknown",user_email:`user_${a.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:a.created_at,amount:a.total_amount||0,commission:0,commission_rate:.2,net_amount:a.total_amount||0,payment_method:"card",payment_status:"pending",description:"予約料金",is_subscription_user:!1,created_at:a.created_at}}})),S=await Promise.all((r||[]).map(async a=>{try{let n=null;if("user_id"in a)n=a.user_id;else{const{data:y}=await d.from("stripe_customers").select("user_id").eq("customer_id",a.customer_id).not("deleted_at","is",null).single();n=y?.user_id}if(!n)throw new Error("User ID not found for subscription");const{data:j}=await d.from("profiles").select("name").eq("id",n).single(),h=2980,u=Math.round(h*.1),f=h-u,_=i?.users?.find(y=>y.id===n)?.email;return{id:a.id,user_name:j?.name||"Unknown",user_email:_||`user_${n.slice(0,8)}@unknown.com`,transaction_type:"subscription",transaction_date:a.created_at,amount:h,commission:u,commission_rate:.1,net_amount:f,payment_method:"card",payment_status:a.status==="active"?"paid":"pending",description:`月額サブスクリプション - ${a.status}`,is_subscription_user:!0,created_at:a.created_at}}catch(n){return console.error(`Error processing subscription ${a.id}:`,n),{id:a.id,user_name:"Unknown",user_email:"unknown@unknown.com",transaction_type:"subscription",transaction_date:a.created_at,amount:2980,commission:298,commission_rate:.1,net_amount:2682,payment_method:"card",payment_status:"pending",description:"月額サブスクリプション",is_subscription_user:!0,created_at:a.created_at}}})),D=[...o,...S];D.sort((a,n)=>new Date(n.transaction_date).getTime()-new Date(a.transaction_date).getTime()),z(D)}catch(t){console.error("Error fetching sales data:",t),P(`売上データの取得に失敗しました: ${t instanceof Error?t.message:"不明なエラー"}`)}finally{U(!1)}},se=async()=>{try{const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()-1,1),c=new Date(t.getFullYear(),t.getMonth(),0),{data:i}=await d.from("reservations").select("total_amount").gte("created_at",s.toISOString()).not("total_amount","is",null),{data:o}=await d.from("reservations").select("total_amount").gte("created_at",r.toISOString()).lt("created_at",c.toISOString()).not("total_amount","is",null),{count:S}=await d.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",s.toISOString()),{count:D}=await d.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",r.toISOString()).lt("created_at",c.toISOString()),a=(i||[]).reduce((E,T)=>E+(T.total_amount||0),0),n=(o||[]).reduce((E,T)=>E+(T.total_amount||0),0),j=(S||0)*2980,h=(D||0)*2980,u=a+j,f=n+h,{count:C}=await d.from("reservations").select("id",{count:"exact"}).gte("created_at",s.toISOString()),_=(C||0)+(S||0),y=_>0?Math.round(u/_):0,pe=Math.round(a*.2+j*.1),Le=u-pe,Me=f>0?(u-f)/f*100:0;H({daily_revenue:[],top_products:[],top_parks:[],payment_methods:[{method:"card",count:_,total_amount:u}]})}catch(t){console.error("Error fetching sales stats:",t)}},ae=()=>{let t=[...m];if(g&&(t=t.filter(s=>s.user_name.toLowerCase().includes(g.toLowerCase())||s.user_email.toLowerCase().includes(g.toLowerCase())||s.park_name&&s.park_name.toLowerCase().includes(g.toLowerCase())||s.product_name&&s.product_name.toLowerCase().includes(g.toLowerCase()))),N!=="all"&&(t=t.filter(s=>s.transaction_type===N)),v){const s=new Date(v);t=t.filter(r=>new Date(r.transaction_date).toDateString()===s.toDateString())}t.sort((s,r)=>{let c=s[w],i=r[w];return w==="transaction_date"&&(c=new Date(c).getTime(),i=new Date(i).getTime()),k==="asc"?c>i?1:-1:c<i?1:-1}),G(t)},ne=()=>{const t=["取引ID","タイプ","ユーザー名","メール","商品/施設","金額","手数料","純売上","決済方法","取引日"],s=x.map(o=>[o.id,F(o.transaction_type),o.user_name,o.user_email,o.park_name||o.product_name||"-",`¥${o.amount.toLocaleString()}`,`${(o.commission_rate*100).toFixed(1)}%`,`¥${o.net_amount.toLocaleString()}`,o.payment_method,new Date(o.transaction_date).toLocaleDateString("ja-JP")]),r=[t,...s].map(o=>o.join(",")).join(`
`),c=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.href=URL.createObjectURL(c),i.download=`sales_${new Date().toISOString().split("T")[0]}.csv`,i.click()},F=t=>({reservation:"ドッグラン予約",shop_order:"ショップ注文",subscription:"サブスクリプション"})[t]||t,re=t=>{const s={reservation:{color:"bg-blue-100 text-blue-800",icon:V},shop_order:{color:"bg-green-100 text-green-800",icon:J},subscription:{color:"bg-purple-100 text-purple-800",icon:I}},r=s[t]||s.reservation,c=r.icon;return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(c,{className:"w-4 h-4"}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${r.color}`,children:F(t)})]})},oe=(t,s)=>s===0?0:(t-s)/s*100;if(K)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})});const A=x.reduce((t,s)=>t+s.amount,0),ce=x.reduce((t,s)=>t+(s.amount-s.net_amount),0),ie=x.reduce((t,s)=>t+s.net_amount,0),le=x.length>0?A/x.length:0,b=new Date().getMonth(),L=new Date().getFullYear(),de=m.filter(t=>{const s=new Date(t.transaction_date);return s.getMonth()===b&&s.getFullYear()===L}),me=b===0?11:b-1,ue=b===0?L-1:L,xe=m.filter(t=>{const s=new Date(t.transaction_date);return s.getMonth()===me&&s.getFullYear()===ue}),q=de.reduce((t,s)=>t+s.amount,0),he=xe.reduce((t,s)=>t+s.amount,0),M=oe(q,he);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(ve,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(B,{className:"w-8 h-8 text-orange-600 mr-3"}),"売上管理"]}),e.jsx("p",{className:"text-gray-600",children:"売上の詳細分析と収益レポート"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["総取引数: ",m.length,"件"]})]}),$&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:$}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"今月の売上"}),e.jsxs("p",{className:"text-xl font-bold text-orange-600",children:["¥",q.toLocaleString()]}),e.jsxs("div",{className:"flex items-center mt-1",children:[M>=0?e.jsx(Y,{className:"w-4 h-4 text-green-600 mr-1"}):e.jsx(fe,{className:"w-4 h-4 text-red-600 mr-1"}),e.jsxs("span",{className:`text-xs ${M>=0?"text-green-600":"text-red-600"}`,children:[Math.abs(M).toFixed(1),"% vs 前月"]})]})]}),e.jsx(B,{className:"w-6 h-6 text-orange-600"})]})}),e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均取引額"}),e.jsxs("p",{className:"text-xl font-bold text-blue-600",children:["¥",Math.round(le).toLocaleString()]})]}),e.jsx(_e,{className:"w-6 h-6 text-blue-600"})]})}),e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"手数料収入"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",ce.toLocaleString()]})]}),e.jsx(je,{className:"w-6 h-6 text-green-600"})]})}),e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"純売上"}),e.jsxs("p",{className:"text-xl font-bold text-purple-600",children:["¥",ie.toLocaleString()]})]}),e.jsx(Y,{className:"w-6 h-6 text-purple-600"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(p,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(V,{className:"w-5 h-5 text-blue-600 mr-2"}),"ドッグラン予約"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),e.jsxs("span",{className:"font-medium",children:[m.filter(t=>t.transaction_type==="reservation").length,"件"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),e.jsxs("span",{className:"font-medium text-blue-600",children:["¥",m.filter(t=>t.transaction_type==="reservation").reduce((t,s)=>t+s.amount,0).toLocaleString()]})]})]})]}),e.jsxs(p,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(J,{className:"w-5 h-5 text-green-600 mr-2"}),"ショップ注文"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),e.jsxs("span",{className:"font-medium",children:[m.filter(t=>t.transaction_type==="shop_order").length,"件"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["¥",m.filter(t=>t.transaction_type==="shop_order").reduce((t,s)=>t+s.amount,0).toLocaleString()]})]})]})]}),e.jsxs(p,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(I,{className:"w-5 h-5 text-purple-600 mr-2"}),"サブスクリプション"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),e.jsxs("span",{className:"font-medium",children:[m.filter(t=>t.transaction_type==="subscription").length,"件"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),e.jsxs("span",{className:"font-medium text-purple-600",children:["¥",m.filter(t=>t.transaction_type==="subscription").reduce((t,s)=>t+s.amount,0).toLocaleString()]})]})]})]})]}),e.jsxs(p,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(De,{label:"検索",placeholder:"ユーザー名、メール、商品名、施設名で検索...",value:g,onChange:t=>Q(t.target.value),icon:e.jsx(ye,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引タイプ"}),e.jsxs("select",{value:N,onChange:t=>W(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"reservation",children:"ドッグラン予約"}),e.jsx("option",{value:"shop_order",children:"ショップ注文"}),e.jsx("option",{value:"subscription",children:"サブスクリプション"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引日"}),e.jsx("input",{type:"date",value:v,onChange:t=>X(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),e.jsxs("select",{value:`${w}-${k}`,onChange:t=>{const[s,r]=t.target.value.split("-");Z(s),ee(r)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"transaction_date-desc",children:"取引日（新しい順）"}),e.jsx("option",{value:"transaction_date-asc",children:"取引日（古い順）"}),e.jsx("option",{value:"amount-desc",children:"金額（高い順）"}),e.jsx("option",{value:"amount-asc",children:"金額（低い順）"}),e.jsx("option",{value:"net_amount-desc",children:"純売上（高い順）"}),e.jsx("option",{value:"net_amount-asc",children:"純売上（低い順）"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[x.length,"件の取引が見つかりました",x.length>0&&e.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",A.toLocaleString(),"）"]})]}),e.jsxs(Se,{variant:"secondary",size:"sm",onClick:ne,children:[e.jsx(we,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),e.jsx(p,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引タイプ"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"商品/施設"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引日"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"金額"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料・純売上"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"決済方法"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:x.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.user_name}),t.is_subscription_user&&e.jsx(I,{className:"w-4 h-4 text-purple-600 ml-2"})]}),e.jsx("div",{className:"text-sm text-gray-500",children:t.user_email})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:re(t.transaction_type)}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.park_name||t.product_name||"-"}),t.quantity&&e.jsxs("div",{className:"text-sm text-gray-500",children:["数量: ",t.quantity]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(t.transaction_date).toLocaleDateString("ja-JP")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",t.amount.toLocaleString()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"text-gray-500",children:["手数料: ",(t.commission_rate*100).toFixed(1),"%"]}),e.jsxs("div",{className:"font-medium text-green-600",children:["純売上: ¥",t.net_amount.toLocaleString()]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.payment_method})]},t.id))})]})})})]})}export{Re as AdminSalesManagement};
