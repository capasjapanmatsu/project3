var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,n=(s,a,l)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[a]=l,i=(e,s)=>{for(var a in s||(s={}))r.call(s,a)&&n(e,a,s[a]);if(l)for(var a of l(s))t.call(s,a)&&n(e,a,s[a]);return e},d=(e,l)=>s(e,a(l)),c=(e,s,a)=>new Promise(((l,r)=>{var t=e=>{try{i(a.next(e))}catch(s){r(s)}},n=e=>{try{i(a.throw(e))}catch(s){r(s)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(t,n);i((a=a.apply(e,s)).next())}));import{j as o,C as m,B as x,a as u,s as h}from"./index.oOj2R_C7.js";import{u as p,r as j,L as b}from"./router.icJHpBzt.js";import{I as g}from"./Input.DeZ8m3vP.js";import{l as v,f as N}from"./postalCodeLookup.D1TGEcrd.js";import{d as f,A as y,f as w,e as C,u as k,v as T,c as q,s as P}from"./ui.UnEvinBv.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function O(){const e=p(),[s,a]=j.useState(!1),[l,r]=j.useState(""),[t,n]=j.useState(!1),[O,L]=j.useState(!1),[S,$]=j.useState(""),[_,D]=j.useState(!1),[U,I]=j.useState({email:"",password:"",confirmPassword:"",userType:"user",name:"",postalCode:"",address:"",phoneNumber:""}),E=e=>{const s=e.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:U.phoneNumber},A=e=>c(null,null,(function*(){const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:U.postalCode})(e);if(I(d(i({},U),{postalCode:s})),7===s.replace(/-/g,"").length){L(!0),$("");try{const e=yield v(s);if(e.success&&e.results&&e.results.length>0){const s=N(e.results[0]);I((e=>d(i({},e),{address:s})))}else $(e.message||"住所が見つかりませんでした")}catch(a){$("住所の検索中にエラーが発生しました")}finally{L(!1)}}}));return t?o.jsx("div",{className:"max-w-md mx-auto",children:o.jsxs(m,{className:"text-center p-8",children:[o.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:o.jsx(f,{className:"w-8 h-8 text-green-600"})}),o.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"メールを確認してください"}),o.jsxs("p",{className:"text-gray-600 mb-4",children:[U.email,"にログインリンクを送信しました。メールを確認してリンクをクリックしてください。"]}),o.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"メールが届かない場合は、迷惑メールフォルダを確認するか、別のメールアドレスでお試しください。"}),o.jsx(x,{onClick:()=>e("/login"),children:"ログイン画面に戻る"})]})}):o.jsxs("div",{className:"max-w-md mx-auto",children:[o.jsx("h1",{className:"text-2xl font-bold text-center mb-8",children:"新規登録"}),o.jsxs(m,{children:[o.jsxs("div",{className:"flex justify-center mb-4 space-x-2",children:[o.jsx(x,{type:"button",onClick:()=>D(!1),variant:_?"secondary":"primary",children:"Magic Link"}),o.jsx(x,{type:"button",onClick:()=>D(!0),variant:_?"primary":"secondary",children:"パスワード"})]}),_?o.jsxs("form",{onSubmit:s=>c(null,null,(function*(){if(s.preventDefault(),a(!0),r(""),!U.name.trim())return r("お名前を入力してください"),void a(!1);if(!U.postalCode.trim())return r("郵便番号を入力してください"),void a(!1);if(!U.address.trim())return r("住所を入力してください"),void a(!1);if(!U.phoneNumber.trim())return r("電話番号を入力してください"),void a(!1);if(!U.password)return r("パスワードを入力してください"),void a(!1);if(U.password.length<6)return r("パスワードは6文字以上で入力してください"),void a(!1);if(U.password!==U.confirmPassword)return r("パスワードが一致しません"),void a(!1);if(!/^\d{3}-\d{4}$/.test(U.postalCode))return r("郵便番号は7桁の数字で入力してください（例：1234567）"),void a(!1);if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(U.phoneNumber))return r("電話番号は正しい形式で入力してください（例：09012345678）"),void a(!1);try{u("lastUsedEmail",U.email);const{data:s,error:a}=yield h.auth.signUp({email:U.email,password:U.password,options:{data:{user_type:U.userType,name:U.name,postal_code:U.postalCode,address:U.address,phone_number:U.phoneNumber}}});if(a)throw a;e("/two-factor-setup")}catch(l){const e=l.message||"";e.includes("already registered")||e.includes("already exists")||e.includes("User already")||e.includes("duplicate key")?r("このメールアドレスは既に登録されています"):r(e||"登録に失敗しました")}finally{a(!1)}})),className:"p-6",children:[l&&o.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[o.jsx(y,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),o.jsx("div",{children:o.jsx("p",{children:l})})]}),o.jsx(g,{label:"お名前 *",value:U.name,onChange:e=>I(d(i({},U),{name:e.target.value})),required:!0,placeholder:"山田太郎",icon:o.jsx(w,{className:"w-4 h-4 text-gray-500"})}),o.jsxs("div",{className:"mb-4 relative",children:[o.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",o.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),o.jsxs("div",{className:"relative",children:[o.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:o.jsx(C,{className:"h-4 w-4 text-gray-500"})}),o.jsx("input",{type:"text",value:U.postalCode,onChange:e=>A(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${S?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),O&&o.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:o.jsx(k,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),S&&o.jsx("p",{className:"mt-1 text-sm text-red-600",children:S})]}),o.jsx(g,{label:"住所 *",value:U.address,onChange:e=>I(d(i({},U),{address:e.target.value})),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:o.jsx(C,{className:"w-4 h-4 text-gray-500"})}),o.jsx(g,{label:"電話番号 *",type:"tel",value:U.phoneNumber,onChange:e=>{const s=E(e.target.value);I(d(i({},U),{phoneNumber:s}))},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:o.jsx(T,{className:"w-4 h-4 text-gray-500"})}),o.jsx(g,{label:"メールアドレス *",type:"email",value:U.email,onChange:e=>I(d(i({},U),{email:e.target.value})),required:!0,placeholder:"example@email.com",icon:o.jsx(f,{className:"w-4 h-4 text-gray-500"})}),o.jsx(g,{label:"パスワード *",type:"password",value:U.password,onChange:e=>I(d(i({},U),{password:e.target.value})),required:!0,placeholder:"6文字以上",helperText:"6文字以上で入力してください",icon:o.jsx(P,{className:"w-4 h-4 text-gray-500"})}),o.jsx(g,{label:"パスワード確認 *",type:"password",value:U.confirmPassword,onChange:e=>I(d(i({},U),{confirmPassword:e.target.value})),required:!0,placeholder:"パスワードを再入力",helperText:"パスワードを再入力してください",icon:o.jsx(P,{className:"w-4 h-4 text-gray-500"})}),o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),o.jsxs("div",{className:"flex space-x-4",children:[o.jsxs("label",{className:"flex items-center",children:[o.jsx("input",{type:"radio",value:"user",checked:"user"===U.userType,onChange:e=>I(d(i({},U),{userType:e.target.value})),className:"mr-2"}),"利用者"]}),o.jsxs("label",{className:"flex items-center",children:[o.jsx("input",{type:"radio",value:"owner",checked:"owner"===U.userType,onChange:e=>I(d(i({},U),{userType:e.target.value})),className:"mr-2"}),"施設オーナー"]})]})]}),o.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:o.jsxs("p",{className:"text-sm text-blue-800",children:[o.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),o.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",o.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",o.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),o.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:o.jsxs("div",{className:"flex items-start space-x-3",children:[o.jsx(q,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),o.jsxs("div",{className:"text-sm text-green-800",children:[o.jsx("p",{className:"font-medium mb-1",children:"セキュリティ強化"}),o.jsx("p",{children:"パスワード登録後、2ファクタ認証（TOTP）の設定をお勧めします。Google Authenticatorなどの認証アプリでQRコードをスキャンするだけで簡単に設定できます。"})]})]})}),o.jsxs(x,{type:"submit",isLoading:s,className:"w-full",children:[o.jsx(P,{className:"w-4 h-4 mr-2"}),"登録する"]})]}):o.jsxs("form",{onSubmit:e=>c(null,null,(function*(){if(e.preventDefault(),a(!0),r(""),!U.name.trim())return r("お名前を入力してください"),void a(!1);if(!U.postalCode.trim())return r("郵便番号を入力してください"),void a(!1);if(!U.address.trim())return r("住所を入力してください"),void a(!1);if(!U.phoneNumber.trim())return r("電話番号を入力してください"),void a(!1);if(!/^\d{3}-\d{4}$/.test(U.postalCode))return r("郵便番号は7桁の数字で入力してください（例：1234567）"),void a(!1);if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(U.phoneNumber))return r("電話番号は正しい形式で入力してください（例：09012345678）"),void a(!1);try{u("lastUsedEmail",U.email);const{error:e}=yield h.auth.signInWithOtp({email:U.email,options:{emailRedirectTo:`${window.location.origin}/dashboard`,data:{user_type:U.userType,name:U.name,postal_code:U.postalCode,address:U.address,phone_number:U.phoneNumber}}});if(e)throw e;n(!0)}catch(s){const e=s.message||"";e.includes("already registered")||e.includes("already exists")||e.includes("User already")||e.includes("duplicate key")?r("このメールアドレスは既に登録されています"):r(e||"登録に失敗しました")}finally{a(!1)}})),className:"p-6",children:[l&&o.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[o.jsx(y,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),o.jsx("div",{children:o.jsx("p",{children:l})})]}),o.jsx(g,{label:"お名前 *",value:U.name,onChange:e=>I(d(i({},U),{name:e.target.value})),required:!0,placeholder:"山田太郎",icon:o.jsx(w,{className:"w-4 h-4 text-gray-500"})}),o.jsxs("div",{className:"mb-4 relative",children:[o.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",o.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),o.jsxs("div",{className:"relative",children:[o.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:o.jsx(C,{className:"h-4 w-4 text-gray-500"})}),o.jsx("input",{type:"text",value:U.postalCode,onChange:e=>A(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${S?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),O&&o.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:o.jsx(k,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),S&&o.jsx("p",{className:"mt-1 text-sm text-red-600",children:S})]}),o.jsx(g,{label:"住所 *",value:U.address,onChange:e=>I(d(i({},U),{address:e.target.value})),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:o.jsx(C,{className:"w-4 h-4 text-gray-500"})}),o.jsx(g,{label:"電話番号 *",type:"tel",value:U.phoneNumber,onChange:e=>{const s=E(e.target.value);I(d(i({},U),{phoneNumber:s}))},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:o.jsx(T,{className:"w-4 h-4 text-gray-500"})}),o.jsx(g,{label:"メールアドレス *",type:"email",value:U.email,onChange:e=>I(d(i({},U),{email:e.target.value})),required:!0,placeholder:"example@email.com",icon:o.jsx(f,{className:"w-4 h-4 text-gray-500"})}),o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),o.jsxs("div",{className:"flex space-x-4",children:[o.jsxs("label",{className:"flex items-center",children:[o.jsx("input",{type:"radio",value:"user",checked:"user"===U.userType,onChange:e=>I(d(i({},U),{userType:e.target.value})),className:"mr-2"}),"利用者"]}),o.jsxs("label",{className:"flex items-center",children:[o.jsx("input",{type:"radio",value:"owner",checked:"owner"===U.userType,onChange:e=>I(d(i({},U),{userType:e.target.value})),className:"mr-2"}),"施設オーナー"]})]})]}),o.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:o.jsxs("p",{className:"text-sm text-blue-800",children:[o.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),o.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",o.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",o.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),o.jsx("div",{className:"mb-4 p-3 bg-yellow-50 rounded-lg",children:o.jsxs("div",{className:"flex items-start space-x-3",children:[o.jsx(q,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),o.jsxs("div",{className:"text-sm text-yellow-800",children:[o.jsx("p",{className:"font-medium mb-1",children:"Magic Linkについて"}),o.jsx("p",{children:"登録後、入力したメールアドレスにログイン用のリンクが送信されます。リンクをクリックするだけで簡単にログインできます。"})]})]})}),o.jsxs(x,{type:"submit",isLoading:s,className:"w-full",children:[o.jsx(q,{className:"w-4 h-4 mr-2"}),"登録する"]})]}),o.jsx("div",{className:"mt-4 text-center p-6",children:o.jsxs("p",{className:"text-sm text-gray-600",children:["すでにアカウントをお持ちの方は",o.jsx(b,{to:"/login",className:"text-blue-600 hover:underline ml-1",children:"こちらからログイン"})]})})]})]})}export{O as Register};
