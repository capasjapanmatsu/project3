import{j as e,d as s,A as a,g as t}from"./ui-vendor-B03FHkej.js";import{u as r,d as i,r as n}from"./react-vendor-BBLDtDmh.js";import{C as o,B as c,s as m,a as d}from"./index-CWMjoAp3.js";import"./query-vendor-Cy2yKKks.js";import"./supabase-vendor-BcfcqyaE.js";function l(){const l=r(),x=i(),[u,h]=n.useState(!0),[p,j]=n.useState(null),[f,b]=n.useState(!1);return n.useEffect(()=>{(async()=>{try{h(!0);const e=window.location.hash;if(!e||!e.includes("access_token"))return void j("無効なMagic Linkです。もう一度ログインしてください。");const s=new URLSearchParams(e.substring(1)),a=s.get("access_token"),t=s.get("refresh_token");if(!a||!t)return void j("認証トークンが見つかりません。もう一度ログインしてください。");const{error:r}=await m.auth.setSession({access_token:a,refresh_token:t});if(r)throw r;const{data:{user:i},error:n}=await m.auth.getUser();if(n||!i)throw n||new Error("ユーザー情報の取得に失敗しました");const{data:o,error:c}=await m.from("profiles").select("id").eq("id",i.id).maybeSingle();if(c&&c.code,!o){const e=i.user_metadata||{},{error:s}=await m.from("profiles").upsert([{id:i.id,user_type:e.user_type||"user",name:e.name||i.email?.split("@")[0]||"ユーザー",postal_code:e.postal_code||"",address:e.address||"",phone_number:e.phone_number||""}],{onConflict:"id"})}i&&d(`trusted_device_${i.id}`,"true"),b(!0),setTimeout(()=>{l("/dashboard")},2e3)}catch(e){j(e.message||"マジックリンクの送信に失敗しました")}finally{h(!1)}})()},[l,x]),u?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"text-center p-8",children:[e.jsx(s,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"text-center p-8",children:[e.jsx(a,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p}),e.jsx(c,{onClick:()=>l("/login"),children:"ログインページに戻る"})]})}):f?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"text-center p-8",children:[e.jsx(t,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(c,{onClick:()=>l("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{l as MagicLink};
