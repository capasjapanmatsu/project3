var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,i=(s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a,n=(e,s)=>{for(var t in s||(s={}))l.call(s,t)&&i(e,t,s[t]);if(a)for(var t of a(s))r.call(s,t)&&i(e,t,s[t]);return e},c=(e,a)=>s(e,t(a)),d=(e,s,t)=>new Promise((a,l)=>{var r=e=>{try{n(t.next(e))}catch(s){l(s)}},i=e=>{try{n(t.throw(e))}catch(s){l(s)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,i);n((t=t.apply(e,s)).next())});import{u as o,s as m,j as x,C as h,B as u}from"./index.CQlxbczY.js";import{r as p}from"./vendor.CKEClKZl.js";import{u as j,a as b,L as g}from"./router.B_7Atevv.js";import{I as f}from"./Input.DMWrIIWM.js";import{u as N}from"./useStripe.BHIkX24C.js";import{g as v,j as y,z as w,A as S,c as _,s as C,b as q,G as I,I as k,a as L,aq as P}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";import"./stripe.CcgPsVUa.js";function O(){const{user:e}=o(),s=j(),t=b(),{createCheckoutSession:a,loading:l,error:r}=N(),[i,O]=p.useState(!0),[E,A]=p.useState(null),[$,D]=p.useState([]),[M,U]=p.useState(!1),[F,B]=p.useState(null),[T,z]=p.useState(!1),[G,J]=p.useState(!1),[R,V]=p.useState({name:"",postalCode:"",address:"",phoneNumber:"",email:"",notes:""}),[X,H]=p.useState({subtotal:0,originalSubtotal:0,discountAmount:0,shippingFee:0,total:0});p.useEffect(()=>{if(!e)return void s("/login");const a=t.state;a?(a.totals&&H(a.totals),K(a)):s("/cart")},[e,s,t]);const K=t=>d(this,null,function*(){try{O(!0);const{data:a,error:l}=yield m.from("profiles").select("*").eq("id",null==e?void 0:e.id).single();if(l)throw l;if(V({name:a.name||"",postalCode:a.postal_code||"",address:a.address||"",phoneNumber:a.phone_number||"",email:(null==e?void 0:e.email)||"",notes:""}),t.cartItems&&t.cartItems.length>0){const{data:s,error:a}=yield m.from("cart_items").select("*, product:products(*)").in("id",t.cartItems).eq("user_id",null==e?void 0:e.id);if(a)throw a;D(s||[])}else{const{data:s,error:t}=yield m.from("cart_items").select("*, product:products(*)").eq("user_id",null==e?void 0:e.id);if(t)throw t;D(s||[])}const r=new URLSearchParams(window.location.search);if("true"===r.get("success"))z(!0),B(r.get("order_number")||Q());else if("true"===r.get("canceled")){J(!0),A("決済がキャンセルされました。必要に応じて再度お試しください。");const{data:{user:e}}=yield m.auth.getUser();if(!e){localStorage.getItem("pre_payment_auth_state")&&(A("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{s("/login")},3e3))}window.history.replaceState({},document.title,window.location.pathname)}}catch(a){A(a.message||"データの取得に失敗しました。もう一度お試しください。")}finally{O(!1)}}),Q=()=>`DP${Date.now()}${Math.floor(1e3*Math.random())}`;return i?x.jsx("div",{className:"flex justify-center items-center h-64",children:x.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):T&&F?x.jsx("div",{className:"max-w-4xl mx-auto",children:x.jsxs(h,{className:"p-8 text-center",children:[x.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6",children:x.jsx(v,{className:"w-12 h-12 text-green-600"})}),x.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"ご注文ありがとうございます！"}),x.jsxs("p",{className:"text-lg text-gray-600 mb-6",children:["注文番号: ",x.jsx("span",{className:"font-semibold",children:F})]}),x.jsx("div",{className:"bg-blue-50 p-6 rounded-lg mb-8 max-w-xl mx-auto",children:x.jsxs("div",{className:"text-left",children:[x.jsxs("div",{className:"flex items-center mb-4",children:[x.jsx(y,{className:"w-6 h-6 text-blue-600 mr-3"}),x.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"ショッピング注文"})]}),x.jsx("p",{className:"text-blue-800 mb-2",children:"ご注文ありがとうございます。商品の発送準備を進めています。"}),x.jsx("p",{className:"text-blue-800",children:"注文の詳細は「注文履歴」ページでご確認いただけます。"})]})}),x.jsxs("div",{className:"flex justify-center space-x-4",children:[x.jsx(g,{to:"/orders",children:x.jsx(u,{children:"注文履歴を見る"})}),x.jsx(g,{to:"/shop",children:x.jsx(u,{variant:"secondary",children:"ショッピングを続ける"})})]})]})}):x.jsxs("div",{className:"max-w-6xl mx-auto",children:[x.jsx("div",{className:"flex items-center space-x-4 mb-6",children:x.jsxs(g,{to:"/cart",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[x.jsx(w,{className:"w-4 h-4 mr-2"}),"カートに戻る"]})}),x.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[x.jsx(y,{className:"w-8 h-8 text-green-600 mr-3"}),"お支払い情報"]}),(E||r)&&x.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[x.jsx(S,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),x.jsxs("div",{children:[x.jsx("p",{className:"font-medium text-red-800",children:"エラーが発生しました"}),x.jsx("p",{className:"text-red-700",children:E||r}),G&&x.jsxs("div",{className:"mt-2",children:[x.jsx("p",{className:"text-sm text-red-700",children:"支払い処理に失敗しました。以下をご確認ください："}),x.jsxs("ul",{className:"list-disc list-inside text-sm text-red-700 mt-1",children:[x.jsx("li",{children:"カード情報が正しいか確認してください"}),x.jsx("li",{children:"別の支払い方法をお試しください"}),x.jsx("li",{children:"しばらく経ってから再度お試しください"})]})]})]})]}),x.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[x.jsx("div",{className:"lg:col-span-2",children:x.jsx(h,{className:"p-6",children:x.jsxs("form",{onSubmit:e=>d(this,null,function*(){if(e.preventDefault(),0!==$.length)try{if(U(!0),A(null),!R.name.trim())throw new Error("お名前を入力してください");if(!R.postalCode.trim())throw new Error("郵便番号を入力してください");if(!R.address.trim())throw new Error("住所を入力してください");if(!R.phoneNumber.trim())throw new Error("電話番号を入力してください");const e=Q();B(e),yield a({priceId:"price_placeholder",mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&order_number=${e}`,cancelUrl:`${window.location.origin}/checkout?canceled=true`,cartItems:$.map(e=>e.id),customParams:{shipping_name:R.name,shipping_address:R.address,shipping_postal_code:R.postalCode,shipping_phone:R.phoneNumber,notes:R.notes,order_number:e}})}catch(s){A(s.message||"エラーが発生しました"),U(!1)}else A("カートに商品がありません。")}),children:[x.jsx("h2",{className:"text-xl font-semibold mb-6",children:"配送情報"}),x.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[x.jsx(f,{label:"お名前 *",value:R.name,onChange:e=>V(c(n({},R),{name:e.target.value})),required:!0,icon:x.jsx(_,{className:"w-4 h-4 text-gray-500"})}),x.jsx(f,{label:"電話番号 *",value:R.phoneNumber,onChange:e=>V(c(n({},R),{phoneNumber:e.target.value})),required:!0,icon:x.jsx(C,{className:"w-4 h-4 text-gray-500"})})]}),x.jsx("div",{className:"mb-6",children:x.jsx(f,{label:"郵便番号 *",value:R.postalCode,onChange:e=>V(c(n({},R),{postalCode:e.target.value})),required:!0,icon:x.jsx(q,{className:"w-4 h-4 text-gray-500"}),placeholder:"123-4567"})}),x.jsx("div",{className:"mb-6",children:x.jsx(f,{label:"住所 *",value:R.address,onChange:e=>V(c(n({},R),{address:e.target.value})),required:!0,icon:x.jsx(q,{className:"w-4 h-4 text-gray-500"})})}),x.jsxs("div",{className:"mb-6",children:[x.jsx(f,{label:"メールアドレス *",type:"email",value:R.email,onChange:e=>V(c(n({},R),{email:e.target.value})),required:!0,disabled:!0}),x.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"注文確認メールがこのアドレスに送信されます"})]}),x.jsxs("div",{className:"mb-6",children:[x.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"備考"}),x.jsx("textarea",{value:R.notes,onChange:e=>V(c(n({},R),{notes:e.target.value})),placeholder:"配送に関する特記事項があればご記入ください",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",rows:3})]}),x.jsx("h2",{className:"text-xl font-semibold mb-4 mt-8",children:"支払い方法"}),x.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(I,{className:"w-5 h-5 text-gray-600"}),x.jsx("span",{className:"font-medium",children:"クレジットカード"})]}),x.jsx("p",{className:"text-sm text-gray-600 mt-1 ml-7",children:"VISA, Mastercard, JCB, AMEX"})]}),x.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg mb-6",children:x.jsxs("div",{className:"flex items-start space-x-3",children:[x.jsx(k,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),x.jsxs("div",{className:"text-sm text-yellow-800",children:[x.jsx("p",{className:"font-medium mb-1",children:"支払い処理について"}),x.jsx("p",{children:"「注文を確定する」ボタンをクリックすると、選択した支払い方法の決済画面に移動します。決済が完了すると、自動的に注文が確定します。"})]})]})}),x.jsx("div",{className:"p-4 bg-blue-50 rounded-lg mb-6",children:x.jsxs("div",{className:"flex items-start space-x-3",children:[x.jsx(L,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),x.jsxs("div",{className:"text-sm text-blue-800",children:[x.jsx("p",{className:"font-medium mb-1",children:"安全な決済"}),x.jsx("p",{children:"すべての支払い情報は暗号化されて安全に処理されます。当サイトでは実際のカード情報を保存しません。"})]})]})}),x.jsxs(u,{type:"submit",isLoading:M||l,className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",disabled:0===$.length,children:[x.jsx(I,{className:"w-5 h-5 mr-2"}),"注文を確定する (¥",X.total.toLocaleString(),")"]})]})})}),x.jsxs("div",{className:"space-y-6",children:[x.jsxs(h,{className:"p-6",children:[x.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文内容"}),x.jsx("div",{className:"space-y-4 max-h-80 overflow-y-auto mb-4",children:$.map(e=>x.jsxs("div",{className:"flex items-center space-x-3 pb-3 border-b border-gray-100 last:border-b-0",children:[x.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0",children:x.jsx("img",{src:e.product.image_url,alt:e.product.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),x.jsxs("div",{className:"flex-1",children:[x.jsx("h4",{className:"font-medium text-sm",children:e.product.name}),x.jsxs("div",{className:"flex justify-between items-center mt-1",children:[x.jsxs("span",{className:"text-xs text-gray-500",children:["数量: ",e.quantity]}),x.jsxs("span",{className:"text-sm font-medium",children:["¥",(e.product.price*e.quantity).toLocaleString()]})]})]})]},e.id))}),x.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200",children:[x.jsxs("div",{className:"flex justify-between text-sm",children:[x.jsx("span",{children:"商品小計"}),x.jsxs("span",{children:["¥",X.originalSubtotal.toLocaleString()]})]}),X.discountAmount>0&&x.jsxs("div",{className:"flex justify-between text-sm text-purple-600",children:[x.jsx("span",{children:"サブスク割引 (10%)"}),x.jsxs("span",{children:["-¥",X.discountAmount.toLocaleString()]})]}),x.jsxs("div",{className:"flex justify-between text-sm",children:[x.jsx("span",{children:"送料"}),x.jsx("span",{children:0===X.shippingFee?x.jsx("span",{className:"text-green-600",children:"無料"}):`¥${X.shippingFee.toLocaleString()}`})]}),x.jsxs("div",{className:"flex justify-between font-bold text-base pt-2 border-t border-gray-200 mt-2",children:[x.jsx("span",{children:"合計"}),x.jsxs("span",{className:"text-green-600",children:["¥",X.total.toLocaleString()]})]})]})]}),x.jsx(h,{className:"p-4 bg-blue-50 border-blue-200",children:x.jsxs("div",{className:"flex items-start space-x-3",children:[x.jsx(P,{className:"w-5 h-5 text-blue-600 mt-1 flex-shrink-0"}),x.jsxs("div",{children:[x.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),x.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[x.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),x.jsx("p",{children:"• 土日祝日も配送いたします"}),x.jsx("p",{children:"• 配送状況はメールでお知らせします"})]})]})]})}),x.jsx(h,{className:"p-4 bg-gray-50 border-gray-200",children:x.jsxs("div",{className:"flex items-start space-x-3",children:[x.jsx(L,{className:"w-5 h-5 text-gray-600 mt-1 flex-shrink-0"}),x.jsxs("div",{children:[x.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:"セキュリティ"}),x.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[x.jsx("p",{children:"• SSL暗号化通信で個人情報を保護"}),x.jsx("p",{children:"• クレジットカード情報は保存されません"}),x.jsx("p",{children:"• 第三者認証のセキュリティ対策"})]})]})]})})]})]})]})}export{O as Checkout};
