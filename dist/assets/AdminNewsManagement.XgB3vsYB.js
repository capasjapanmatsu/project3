var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,l=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,i=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&l(e,s,t[s]);if(a)for(var s of a(t))n.call(t,s)&&l(e,s,t[s]);return e},c=(e,a)=>t(e,s(a)),o=(e,t,s)=>new Promise(((a,r)=>{var n=e=>{try{i(s.next(e))}catch(t){r(t)}},l=e=>{try{i(s.throw(e))}catch(t){r(t)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,l);i((s=s.apply(e,t)).next())}));import{u as d,s as m,j as x,C as u,B as h}from"./index.oOj2R_C7.js";import{r as f,u as p,L as j}from"./router.icJHpBzt.js";import{I as g}from"./Input.DeZ8m3vP.js";import{S as y}from"./Select.Ccsc19kJ.js";import{B as b,p as v,A as w,h as N,O as _,X as S,l as k,m as O,F as P,Y as C}from"./ui.UnEvinBv.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function q(){const{user:e}=d(),[t,s]=f.useState([]),[a,r]=f.useState({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),[n,l]=f.useState(null),[p,j]=f.useState(!1),[C,q]=f.useState(!1),[D,L]=f.useState(""),[T,$]=f.useState("");f.useEffect((()=>{z(),I()}),[]);const I=()=>o(null,null,(function*(){if(e)try{const{data:t,error:s}=yield m.from("profiles").select("*").eq("id",e.id).single();if(s&&"PGRST116"===s.code){const{data:t,error:s}=yield m.from("profiles").insert([{id:e.id,user_type:"admin",name:e.email||"Admin User",email:e.email}]).select().single();s?L("管理者プロファイルの作成に失敗しました。"):($("管理者プロファイルを作成しました。"),setTimeout((()=>$("")),3e3))}else if(s)L("ユーザープロファイルの取得に失敗しました。");else if(!t||"admin"!==t.user_type){const{error:t}=yield m.from("profiles").update({user_type:"admin"}).eq("id",e.id);t?L("管理者権限の設定に失敗しました。"):($("管理者権限を設定しました。ページを手動でリロードしてください。"),setTimeout((()=>$("")),5e3))}}catch(t){L("ユーザープロファイルの確認に失敗しました。")}})),z=()=>o(null,null,(function*(){try{const{data:e,error:t}=yield m.from("news_announcements").select("*").order("created_at",{ascending:!1});if(t)throw t;s(e||[]),L("")}catch(e){L("新着情報の取得に失敗しました。")}})),A=e=>({news:"お知らせ",announcement:"重要なお知らせ",sale:"セール情報"}[e]||e),E=e=>{switch(e){case"news":return x.jsx(P,{className:"w-4 h-4"});case"announcement":return x.jsx(O,{className:"w-4 h-4"});case"sale":return x.jsx(k,{className:"w-4 h-4"});default:return x.jsx(b,{className:"w-4 h-4"})}};return x.jsxs(x.Fragment,{children:[x.jsxs(u,{className:"p-6",children:[x.jsxs("div",{className:"flex justify-between items-center mb-4",children:[x.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[x.jsx(b,{className:"w-5 h-5 text-blue-600 mr-2"}),"新着情報管理"]}),x.jsxs(h,{onClick:()=>{l(null),r({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),j(!0)},children:[x.jsx(v,{className:"w-4 h-4 mr-2"}),"新着情報を追加"]})]}),D&&x.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start",children:[x.jsx(w,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),x.jsx("p",{className:"text-red-800",children:D})]}),T&&x.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start",children:[x.jsx(N,{className:"w-5 h-5 text-green-600 mt-0.5 mr-2 flex-shrink-0"}),x.jsx("p",{className:"text-green-800",children:T})]}),x.jsx("div",{className:"space-y-4",children:0===t.length?x.jsx("div",{className:"text-center py-8 text-gray-500",children:"新着情報がありません"}):t.map((e=>{return x.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:x.jsxs("div",{className:"flex justify-between items-start",children:[x.jsxs("div",{className:"flex-1",children:[x.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[x.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${t=e.category,{news:"bg-blue-100 text-blue-800",announcement:"bg-red-100 text-red-800",sale:"bg-green-100 text-green-800"}[t]||"bg-gray-100 text-gray-800"}`,children:[E(e.category),x.jsx("span",{children:A(e.category)})]}),e.is_important&&x.jsx("span",{className:"bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium",children:"重要"})]}),x.jsx("h3",{className:"font-bold text-lg mb-2",children:e.title}),x.jsx("p",{className:"text-sm text-gray-700 mb-2 line-clamp-2",children:e.content}),x.jsxs("div",{className:"text-xs text-gray-500",children:["作成日: ",new Date(e.created_at).toLocaleString("ja-JP"),e.updated_at!==e.created_at&&x.jsxs("span",{children:[" / 更新日: ",new Date(e.updated_at).toLocaleString("ja-JP")]})]})]}),x.jsxs("div",{className:"flex space-x-2 ml-4",children:[x.jsxs(h,{variant:"secondary",size:"sm",onClick:()=>(e=>{l(e),r({title:e.title,content:e.content,category:e.category,is_important:e.is_important||!1,image_url:"",link_url:""}),j(!0)})(e),disabled:C,children:[x.jsx(_,{className:"w-4 h-4 mr-1"}),"編集"]}),x.jsxs(h,{variant:"danger",size:"sm",onClick:()=>{return t=e.id,o(null,null,(function*(){if(confirm("この新着情報を削除してもよろしいですか？"))try{q(!0),L("");const{error:e}=yield m.from("news_announcements").delete().eq("id",t);if(e)throw e;$("新着情報を削除しました。"),yield z(),setTimeout((()=>{$("")}),3e3)}catch(e){L("新着情報の削除に失敗しました。")}finally{q(!1)}}));var t},disabled:C,children:[x.jsx(S,{className:"w-4 h-4 mr-1"}),"削除"]})]})]})},e.id);var t}))})]}),p&&x.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:x.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:x.jsxs("div",{className:"p-6",children:[x.jsxs("div",{className:"flex justify-between items-center mb-6",children:[x.jsx("h2",{className:"text-xl font-bold",children:n?"新着情報を編集":"新着情報を追加"}),x.jsx("button",{onClick:()=>j(!1),className:"text-gray-500 hover:text-gray-700",disabled:C,children:x.jsx(S,{className:"w-6 h-6"})})]}),x.jsxs("form",{onSubmit:t=>o(null,null,(function*(){if(t.preventDefault(),a.title.trim())if(a.content.trim())if(e)try{q(!0),L(""),$("");const{data:t,error:s}=yield m.from("profiles").select("*").eq("id",e.id).single(),i={title:a.title,content:a.content,category:a.category,is_important:a.is_important,created_by:null==e?void 0:e.id};if(n){const{error:e}=yield m.from("news_announcements").update({title:a.title,content:a.content,category:a.category,is_important:a.is_important,updated_at:(new Date).toISOString()}).eq("id",n.id);if(e)throw e;$("新着情報を更新しました。")}else{const{data:e,error:t}=yield m.from("news_announcements").insert([i]).select();if(t)throw t;$("新着情報を追加しました。")}r({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),l(null),j(!1),yield z(),setTimeout((()=>{$("")}),3e3)}catch(s){let e="新着情報の保存に失敗しました。";s&&"object"==typeof s&&("message"in s&&"string"==typeof s.message&&(e+=` エラー詳細: ${s.message}`),"details"in s&&"string"==typeof s.details&&(e+=` 詳細: ${s.details}`),"hint"in s&&"string"==typeof s.hint&&(e+=` ヒント: ${s.hint}`),"code"in s&&(e+=` コード: ${s.code}`)),L(e)}finally{q(!1)}else L("ユーザーが認証されていません。ログインしてください。");else L("内容を入力してください。");else L("タイトルを入力してください。")})),children:[x.jsxs("div",{className:"space-y-4",children:[x.jsx(g,{label:"タイトル *",value:a.title,onChange:e=>r(c(i({},a),{title:e.target.value})),required:!0,disabled:C}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容 *"}),x.jsx("textarea",{value:a.content,onChange:e=>r(c(i({},a),{content:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:6,required:!0,disabled:C})]}),x.jsx(y,{label:"カテゴリー *",options:[{value:"news",label:"お知らせ"},{value:"announcement",label:"重要なお知らせ"},{value:"sale",label:"セール情報"}],value:a.category,onChange:e=>r(c(i({},a),{category:e.target.value})),required:!0,disabled:C}),x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx("input",{type:"checkbox",id:"is_important",checked:a.is_important,onChange:e=>r(c(i({},a),{is_important:e.target.checked})),className:"rounded text-blue-600",disabled:C}),x.jsx("label",{htmlFor:"is_important",className:"text-sm text-gray-700",children:"重要なお知らせとして表示する"})]})]}),x.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[x.jsx(h,{type:"button",variant:"secondary",onClick:()=>j(!1),disabled:C,children:"キャンセル"}),x.jsx(h,{type:"submit",isLoading:C,children:n?"更新する":"追加する"})]})]})]})})})]})}function D(){const{user:e,isAdmin:t}=d(),s=p();return f.useEffect((()=>{t||s("/")}),[t,s]),x.jsxs("div",{className:"space-y-6",children:[x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{className:"flex items-center space-x-4",children:[x.jsx(j,{to:"/admin",children:x.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:x.jsx(C,{className:"w-5 h-5"})})}),x.jsxs("div",{children:[x.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[x.jsx(b,{className:"w-8 h-8 text-yellow-600 mr-3"}),"新着情報管理"]}),x.jsx("p",{className:"text-gray-600",children:"サイトの新着情報を管理します"})]})]}),x.jsxs("div",{className:"text-sm text-gray-500",children:["最終更新: ",(new Date).toLocaleString("ja-JP")]})]}),x.jsx(q,{})]})}export{D as AdminNewsManagement};
