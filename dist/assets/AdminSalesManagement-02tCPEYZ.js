import{u as e,s as t,j as s,C as a,B as n}from"./index-uQwv9uAE.js";import{u as r,r as i,L as c}from"./vendor-BHVjIt_u.js";import{I as l}from"./Input-Bg5E4HX5.js";import{I as o,a3 as d,Q as m,V as x,aA as u,aB as p,b as h,m as g,j as _,ax as j,ap as f}from"./ui-BLTQwnYp.js";import"./supabase-CKbzEL5D.js";function y(){const{isAdmin:y}=e(),N=r(),[w,v]=i.useState([]),[b,S]=i.useState([]),[k,L]=i.useState(null),[D,C]=i.useState(!0),[I,$]=i.useState(""),[M,F]=i.useState(""),[O,U]=i.useState("all"),[q,E]=i.useState(""),[Y,P]=i.useState("transaction_date"),[T,B]=i.useState("desc");i.useEffect((()=>{y?(V(),A()):N("/")}),[y,N]),i.useEffect((()=>{J()}),[w,M,O,q,Y,T]);const V=async()=>{try{C(!0),$("");const{data:a,error:n}=await t.from("reservations").select("\n          id,\n          user_id,\n          park_id,\n          total_amount,\n          status,\n          reservation_type,\n          created_at\n        ").not("total_amount","is",null).order("created_at",{ascending:!1});if(n)throw new Error("予約売上データの取得に失敗しました");let r=null,i=null;try{const{data:e,error:s}=await t.from("subscriptions").select("\n            id,\n            user_id,\n            status,\n            start_date,\n            end_date,\n            created_at\n          ").in("status",["active","trialing"]);s||(r=e)}catch(e){}if(!r){const{data:e,error:s}=await t.from("stripe_subscriptions").select("\n            id,\n            customer_id,\n            status,\n            current_period_start,\n            current_period_end,\n            created_at\n          ").in("status",["active","trialing","past_due","canceled"]).not("deleted_at","is",null);r=e,i=s}if(i)throw new Error("サブスクリプション売上データの取得に失敗しました");let c=null;try{const{data:e,error:s}=await t.auth.admin.listUsers();s||(c=e)}catch(s){}const l=await Promise.all((a||[]).map((async s=>{try{const{data:e}=await t.from("profiles").select("name").eq("id",s.user_id).single(),{data:a}=await t.from("dog_parks").select("name").eq("id",s.park_id).single(),n=s.total_amount||0,r=Math.round(.2*n),i=n-r,l=c?.users?.find((e=>e.id===s.user_id)),o=l?.email;return{id:s.id,user_name:e?.name||"Unknown",user_email:o||`user_${s.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:s.created_at,amount:n,commission:r,commission_rate:.2,net_amount:i,payment_method:"card",payment_status:"confirmed"===s.status?"paid":"pending",description:`${a?.name||"Unknown Park"} - 予約料金`,is_subscription_user:"subscription"===s.reservation_type,created_at:s.created_at}}catch(e){return{id:s.id,user_name:"Unknown",user_email:`user_${s.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:s.created_at,amount:s.total_amount||0,commission:0,commission_rate:.2,net_amount:s.total_amount||0,payment_method:"card",payment_status:"pending",description:"予約料金",is_subscription_user:!1,created_at:s.created_at}}}))),o=await Promise.all((r||[]).map((async s=>{try{let e=null;if("user_id"in s)e=s.user_id;else{const{data:a}=await t.from("stripe_customers").select("user_id").eq("customer_id",s.customer_id).not("deleted_at","is",null).single();e=a?.user_id}if(!e)throw new Error("User ID not found for subscription");const{data:a}=await t.from("profiles").select("name").eq("id",e).single(),n=2980,r=Math.round(.1*n),i=n-r,l=c?.users?.find((t=>t.id===e)),o=l?.email;return{id:s.id,user_name:a?.name||"Unknown",user_email:o||`user_${e.slice(0,8)}@unknown.com`,transaction_type:"subscription",transaction_date:s.created_at,amount:n,commission:r,commission_rate:.1,net_amount:i,payment_method:"card",payment_status:"active"===s.status?"paid":"pending",description:`月額サブスクリプション - ${s.status}`,is_subscription_user:!0,created_at:s.created_at}}catch(e){return{id:s.id,user_name:"Unknown",user_email:"unknown@unknown.com",transaction_type:"subscription",transaction_date:s.created_at,amount:2980,commission:298,commission_rate:.1,net_amount:2682,payment_method:"card",payment_status:"pending",description:"月額サブスクリプション",is_subscription_user:!0,created_at:s.created_at}}}))),d=[...l,...o];d.sort(((e,t)=>new Date(t.transaction_date).getTime()-new Date(e.transaction_date).getTime())),v(d)}catch(e){$(`売上データの取得に失敗しました: ${e instanceof Error?e.message:"不明なエラー"}`)}finally{C(!1)}},A=async()=>{try{const e=new Date,s=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()-1,1),n=new Date(e.getFullYear(),e.getMonth(),0),{data:r}=await t.from("reservations").select("total_amount").gte("created_at",s.toISOString()).not("total_amount","is",null),{data:i}=await t.from("reservations").select("total_amount").gte("created_at",a.toISOString()).lt("created_at",n.toISOString()).not("total_amount","is",null),{count:c}=await t.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",s.toISOString()),{count:l}=await t.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",a.toISOString()).lt("created_at",n.toISOString()),o=(r||[]).reduce(((e,t)=>e+(t.total_amount||0)),0),d=((i||[]).reduce(((e,t)=>e+(t.total_amount||0)),0),2980*(c||0)),m=o+d,{count:x}=await t.from("reservations").select("id",{count:"exact"}).gte("created_at",s.toISOString()),u=(x||0)+(c||0);u>0&&Math.round(m/u),Math.round(.2*o+.1*d);L({daily_revenue:[],top_products:[],top_parks:[],payment_methods:[{method:"card",count:u,total_amount:m}]})}catch(e){}},J=()=>{let e=[...w];if(M&&(e=e.filter((e=>e.user_name.toLowerCase().includes(M.toLowerCase())||e.user_email.toLowerCase().includes(M.toLowerCase())||e.park_name&&e.park_name.toLowerCase().includes(M.toLowerCase())||e.product_name&&e.product_name.toLowerCase().includes(M.toLowerCase())))),"all"!==O&&(e=e.filter((e=>e.transaction_type===O))),q){const t=new Date(q);e=e.filter((e=>new Date(e.transaction_date).toDateString()===t.toDateString()))}e.sort(((e,t)=>{let s=e[Y],a=t[Y];return"transaction_date"===Y&&(s=new Date(s).getTime(),a=new Date(a).getTime()),"asc"===T?s>a?1:-1:s<a?1:-1})),S(e)},R=e=>({reservation:"ドッグラン予約",shop_order:"ショップ注文",subscription:"サブスクリプション"}[e]||e),z=e=>{const t={reservation:{color:"bg-blue-100 text-blue-800",icon:h},shop_order:{color:"bg-green-100 text-green-800",icon:g},subscription:{color:"bg-purple-100 text-purple-800",icon:_}},a=t[e]||t.reservation,n=a.icon;return s.jsxs("div",{className:"flex items-center space-x-1",children:[s.jsx(n,{className:"w-4 h-4"}),s.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${a.color}`,children:R(e)})]})};if(D)return s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})});const Q=b.reduce(((e,t)=>e+t.amount),0),G=b.reduce(((e,t)=>e+(t.amount-t.net_amount)),0),H=b.reduce(((e,t)=>e+t.net_amount),0),K=b.length>0?Q/b.length:0,W=(new Date).getMonth(),X=(new Date).getFullYear(),Z=w.filter((e=>{const t=new Date(e.transaction_date);return t.getMonth()===W&&t.getFullYear()===X})),ee=0===W?11:W-1,te=0===W?X-1:X,se=w.filter((e=>{const t=new Date(e.transaction_date);return t.getMonth()===ee&&t.getFullYear()===te})),ae=Z.reduce(((e,t)=>e+t.amount),0),ne=se.reduce(((e,t)=>e+t.amount),0),re=(ie=ae,0===(ce=ne)?0:(ie-ce)/ce*100);var ie,ce;return s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[s.jsx(d,{className:"w-8 h-8 text-orange-600 mr-3"}),"売上管理"]}),s.jsx("p",{className:"text-gray-600",children:"売上の詳細分析と収益レポート"})]}),s.jsxs("div",{className:"text-sm text-gray-500",children:["総取引数: ",w.length,"件"]})]}),I&&s.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:I}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"今月の売上"}),s.jsxs("p",{className:"text-xl font-bold text-orange-600",children:["¥",ae.toLocaleString()]}),s.jsxs("div",{className:"flex items-center mt-1",children:[re>=0?s.jsx(m,{className:"w-4 h-4 text-green-600 mr-1"}):s.jsx(x,{className:"w-4 h-4 text-red-600 mr-1"}),s.jsxs("span",{className:"text-xs "+(re>=0?"text-green-600":"text-red-600"),children:[Math.abs(re).toFixed(1),"% vs 前月"]})]})]}),s.jsx(d,{className:"w-6 h-6 text-orange-600"})]})}),s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"平均取引額"}),s.jsxs("p",{className:"text-xl font-bold text-blue-600",children:["¥",Math.round(K).toLocaleString()]})]}),s.jsx(u,{className:"w-6 h-6 text-blue-600"})]})}),s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"手数料収入"}),s.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",G.toLocaleString()]})]}),s.jsx(p,{className:"w-6 h-6 text-green-600"})]})}),s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"純売上"}),s.jsxs("p",{className:"text-xl font-bold text-purple-600",children:["¥",H.toLocaleString()]})]}),s.jsx(m,{className:"w-6 h-6 text-purple-600"})]})})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs(a,{className:"p-4",children:[s.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[s.jsx(h,{className:"w-5 h-5 text-blue-600 mr-2"}),"ドッグラン予約"]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),s.jsxs("span",{className:"font-medium",children:[w.filter((e=>"reservation"===e.transaction_type)).length,"件"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),s.jsxs("span",{className:"font-medium text-blue-600",children:["¥",w.filter((e=>"reservation"===e.transaction_type)).reduce(((e,t)=>e+t.amount),0).toLocaleString()]})]})]})]}),s.jsxs(a,{className:"p-4",children:[s.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[s.jsx(g,{className:"w-5 h-5 text-green-600 mr-2"}),"ショップ注文"]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),s.jsxs("span",{className:"font-medium",children:[w.filter((e=>"shop_order"===e.transaction_type)).length,"件"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),s.jsxs("span",{className:"font-medium text-green-600",children:["¥",w.filter((e=>"shop_order"===e.transaction_type)).reduce(((e,t)=>e+t.amount),0).toLocaleString()]})]})]})]}),s.jsxs(a,{className:"p-4",children:[s.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[s.jsx(_,{className:"w-5 h-5 text-purple-600 mr-2"}),"サブスクリプション"]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),s.jsxs("span",{className:"font-medium",children:[w.filter((e=>"subscription"===e.transaction_type)).length,"件"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),s.jsxs("span",{className:"font-medium text-purple-600",children:["¥",w.filter((e=>"subscription"===e.transaction_type)).reduce(((e,t)=>e+t.amount),0).toLocaleString()]})]})]})]})]}),s.jsxs(a,{className:"p-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[s.jsx("div",{className:"md:col-span-2",children:s.jsx(l,{label:"検索",placeholder:"ユーザー名、メール、商品名、施設名で検索...",value:M,onChange:e=>F(e.target.value),icon:s.jsx(j,{className:"w-4 h-4 text-gray-500"})})}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引タイプ"}),s.jsxs("select",{value:O,onChange:e=>U(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[s.jsx("option",{value:"all",children:"すべて"}),s.jsx("option",{value:"reservation",children:"ドッグラン予約"}),s.jsx("option",{value:"shop_order",children:"ショップ注文"}),s.jsx("option",{value:"subscription",children:"サブスクリプション"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引日"}),s.jsx("input",{type:"date",value:q,onChange:e=>E(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),s.jsxs("select",{value:`${Y}-${T}`,onChange:e=>{const[t,s]=e.target.value.split("-");P(t),B(s)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[s.jsx("option",{value:"transaction_date-desc",children:"取引日（新しい順）"}),s.jsx("option",{value:"transaction_date-asc",children:"取引日（古い順）"}),s.jsx("option",{value:"amount-desc",children:"金額（高い順）"}),s.jsx("option",{value:"amount-asc",children:"金額（低い順）"}),s.jsx("option",{value:"net_amount-desc",children:"純売上（高い順）"}),s.jsx("option",{value:"net_amount-asc",children:"純売上（低い順）"})]})]})]}),s.jsxs("div",{className:"flex justify-between items-center mt-4",children:[s.jsxs("p",{className:"text-sm text-gray-600",children:[b.length,"件の取引が見つかりました",b.length>0&&s.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",Q.toLocaleString(),"）"]})]}),s.jsxs(n,{variant:"secondary",size:"sm",onClick:()=>{const e=[["取引ID","タイプ","ユーザー名","メール","商品/施設","金額","手数料","純売上","決済方法","取引日"],...b.map((e=>[e.id,R(e.transaction_type),e.user_name,e.user_email,e.park_name||e.product_name||"-",`¥${e.amount.toLocaleString()}`,`${(100*e.commission_rate).toFixed(1)}%`,`¥${e.net_amount.toLocaleString()}`,e.payment_method,new Date(e.transaction_date).toLocaleDateString("ja-JP")]))].map((e=>e.join(","))).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`sales_${(new Date).toISOString().split("T")[0]}.csv`,s.click()},children:[s.jsx(f,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),s.jsx(a,{children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引タイプ"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"商品/施設"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引日"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"金額"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料・純売上"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"決済方法"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map((e=>s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.user_name}),e.is_subscription_user&&s.jsx(_,{className:"w-4 h-4 text-purple-600 ml-2"})]}),s.jsx("div",{className:"text-sm text-gray-500",children:e.user_email})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:z(e.transaction_type)}),s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.park_name||e.product_name||"-"}),e.quantity&&s.jsxs("div",{className:"text-sm text-gray-500",children:["数量: ",e.quantity]})]}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.transaction_date).toLocaleDateString("ja-JP")}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",e.amount.toLocaleString()]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"text-gray-500",children:["手数料: ",(100*e.commission_rate).toFixed(1),"%"]}),s.jsxs("div",{className:"font-medium text-green-600",children:["純売上: ¥",e.net_amount.toLocaleString()]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.payment_method})]},e.id)))})]})})})]})}export{y as AdminSalesManagement};
