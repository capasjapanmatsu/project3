import{j as e,C as l,B as b,s as o,a as L}from"./index-B2nIfDq6.js";import{d as y,u as E,r as i}from"./react-vendor-ClX3xUyT.js";import{L as S,A as C,i as M}from"./ui-vendor-Bbvw08tP.js";import"./supabase-vendor-CRpuwX9I.js";function B(){const a=y(),j=E(),[k,m]=i.useState(!0),[d,n]=i.useState(null),[w,N]=i.useState(!1);return i.useEffect(()=>{(async()=>{try{m(!0);const r=window.location.hash;if(!r||!r.includes("access_token")){n("無効なMagic Linkです。もう一度ログインしてください。");return}const u=new URLSearchParams(r.substring(1)),x=u.get("access_token"),h=u.get("refresh_token");if(!x||!h){n("認証トークンが見つかりません。もう一度ログインしてください。");return}const{error:f}=await o.auth.setSession({access_token:x,refresh_token:h});if(f)throw f;const{data:{user:s},error:p}=await o.auth.getUser();if(p||!s)throw p||new Error("ユーザー情報の取得に失敗しました");const{data:_,error:c}=await o.from("profiles").select("id").eq("id",s.id).maybeSingle();if(c&&c.code!=="PGRST116"&&console.error("Profile check error:",c),!_){const t=s.user_metadata||{},{error:g}=await o.from("profiles").upsert([{id:s.id,user_type:t.user_type||"user",name:t.name||s.email?.split("@")[0]||"ユーザー",postal_code:t.postal_code||"",address:t.address||"",phone_number:t.phone_number||""}],{onConflict:"id"});g&&console.error("Profile creation error:",g)}s&&L(`trusted_device_${s.id}`,"true"),N(!0),setTimeout(()=>{a("/dashboard")},2e3)}catch(r){console.error("Magic Link authentication error:",r),n(r.message||"マジックリンクの送信に失敗しました")}finally{m(!1)}})()},[a,j]),k?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(l,{className:"text-center p-8",children:[e.jsx(S,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):d?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(l,{className:"text-center p-8",children:[e.jsx(C,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:d}),e.jsx(b,{onClick:()=>a("/login"),children:"ログインページに戻る"})]})}):w?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(l,{className:"text-center p-8",children:[e.jsx(M,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(b,{onClick:()=>a("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{B as MagicLink};
