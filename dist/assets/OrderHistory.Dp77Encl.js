var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,l=(s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a,c=(e,s)=>{for(var t in s||(s={}))r.call(s,t)&&l(e,t,s[t]);if(a)for(var t of a(s))n.call(s,t)&&l(e,t,s[t]);return e},i=(e,a)=>s(e,t(a)),d=(e,s,t)=>new Promise((a,r)=>{var n=e=>{try{c(t.next(e))}catch(s){r(s)}},l=e=>{try{c(t.throw(e))}catch(s){r(s)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,l);c((t=t.apply(e,s)).next())});import{u as m,s as o,j as x,B as h,C as p}from"./index.CQlxbczY.js";import{r as j}from"./vendor.CKEClKZl.js";import{a as u,L as g}from"./router.B_7Atevv.js";import{z as b,N as f,c as N,G as v,J as y,j as _,g as w,A as S,D as L,C as k,r as D,v as C,X as P,aq as $}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";function z(){var e;const{user:s}=m(),t=u(),[a,r]=j.useState([]),[n,l]=j.useState(!0),[z,O]=j.useState(null),[T,E]=j.useState(!1),[J,q]=j.useState(!1),[I,M]=j.useState(null),[A,B]=j.useState(null),[R,U]=j.useState(null);j.useEffect(()=>{var e;if(s){G();const e=setInterval(()=>{V()},6e4);return()=>clearInterval(e)}(null==(e=t.state)?void 0:e.orderSuccess)&&(E(!0),setTimeout(()=>E(!1),5e3))},[s,t]);const G=()=>d(this,null,function*(){try{const{data:e,error:t}=yield o.from("orders").select("\n          *,\n          order_items (\n            *,\n            product:products (*)\n          )\n        ").eq("user_id",null==s?void 0:s.id).order("created_at",{ascending:!1});if(t)throw t;const a=(e||[]).map(e=>{const s=e.cancellable_until?new Date(e.cancellable_until):null,t=new Date,a=s&&t<s&&["pending","confirmed"].includes(e.status);let r;if(a&&s){const e=s.getTime()-t.getTime();r=`${Math.floor(e/6e4)}分${Math.floor(e%6e4/1e3)}秒`}return i(c({},e),{can_cancel:a,time_left:r})});r(a)}catch(e){}finally{l(!1)}}),V=()=>{const e=new Date;r(s=>s.map(s=>{const t=s.cancellable_until?new Date(s.cancellable_until):null,a=t&&e<t&&["pending","confirmed"].includes(s.status);let r;if(a&&t){const s=t.getTime()-e.getTime();r=`${Math.floor(s/6e4)}分${Math.floor(s%6e4/1e3)}秒`}return i(c({},s),{can_cancel:a,time_left:r})}))},F=e=>{switch(e){case"pending":return x.jsx(k,{className:"w-5 h-5 text-yellow-600"});case"confirmed":return x.jsx(w,{className:"w-5 h-5 text-blue-600"});case"processing":return x.jsx(f,{className:"w-5 h-5 text-purple-600"});case"shipped":return x.jsx($,{className:"w-5 h-5 text-orange-600"});case"delivered":return x.jsx(w,{className:"w-5 h-5 text-green-600"});case"cancelled":return x.jsx(P,{className:"w-5 h-5 text-red-600"});default:return x.jsx(k,{className:"w-5 h-5 text-gray-600"})}},H=e=>({pending:"注文受付中",confirmed:"注文確定",processing:"準備中",shipped:"発送済み",delivered:"配達完了",cancelled:"キャンセル"}[e]||e),K=e=>({credit_card:"クレジットカード",bank_transfer:"銀行振込",cod:"代金引換"}[e]||e),Q=e=>d(this,null,function*(){try{q(!0),M(null),B(null);const{data:t,error:a}=yield o.rpc("cancel_order",{order_id:e,user_id:null==s?void 0:s.id});if(a)throw a;if(!t.success)throw new Error(t.message||"キャンセルに失敗しました");B("注文をキャンセルしました"),U(null),yield G(),setTimeout(()=>{B(null)},3e3)}catch(t){M("注文のキャンセルに失敗しました。")}finally{q(!1)}});return n?x.jsx("div",{className:"flex justify-center items-center h-64",children:x.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):x.jsxs("div",{className:"max-w-6xl mx-auto",children:[x.jsx("div",{className:"flex items-center space-x-4 mb-6",children:x.jsxs(g,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[x.jsx(b,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),x.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[x.jsx(f,{className:"w-8 h-8 text-green-600 mr-3"}),"注文履歴"]}),x.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[x.jsx(g,{to:"/profile-settings",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(N,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),x.jsx(g,{to:"/payment-method-settings",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(v,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),x.jsx(g,{to:"/dogpark-history",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(y,{className:"w-4 h-4 mr-2"}),"ドッグラン利用履歴"]})}),x.jsx(g,{to:"/shop",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(_,{className:"w-4 h-4 mr-2"}),"ショップに戻る"]})})]}),T&&(null==(e=t.state)?void 0:e.orderNumber)&&x.jsxs("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(w,{className:"w-5 h-5 text-green-600"}),x.jsx("span",{className:"font-semibold text-green-800",children:"ご注文ありがとうございます！"})]}),x.jsxs("p",{className:"text-green-700 mt-1",children:["注文番号: ",t.state.orderNumber," のご注文を承りました。"]})]}),A&&x.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(w,{className:"w-5 h-5 text-green-600"}),x.jsx("span",{className:"font-semibold text-green-800",children:A})]})}),I&&x.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(S,{className:"w-5 h-5 text-red-600"}),x.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),x.jsx("p",{className:"text-red-700 mt-1",children:I})]}),0===a.length?x.jsxs(p,{className:"text-center py-12",children:[x.jsx(f,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),x.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"注文履歴がありません"}),x.jsx("p",{className:"text-gray-500 mb-6",children:"まだ商品をご注文いただいていません"}),x.jsx(h,{onClick:()=>window.location.href="/shop",children:"ショッピングを始める"})]}):x.jsxs("div",{className:"space-y-6",children:[x.jsx("div",{className:"flex justify-end mb-4",children:x.jsxs(h,{variant:"secondary",size:"sm",onClick:()=>{if(0===a.length)return;const e=["注文番号","注文日","ステータス","商品名","数量","単価","小計","割引","送料","合計金額","支払い方法","配送先氏名","配送先住所","配送先電話番号"].join(","),s=[];a.forEach(e=>{const t=new Date(e.created_at).toLocaleDateString("ja-JP"),a=H(e.status),r=K(e.payment_method);if(e.order_items&&e.order_items.length>0)e.order_items.forEach((n,l)=>{const c=[e.order_number,t,a,`"${n.product.name.replace(/"/g,'""')}"`,n.quantity,n.unit_price,n.total_price,0===l?e.discount_amount:"",0===l?e.shipping_fee:"",0===l?e.final_amount:"",0===l?r:"",0===l?`"${e.shipping_name.replace(/"/g,'""')}"`:"",0===l?`"${e.shipping_address.replace(/"/g,'""')}"`:"",0===l?e.shipping_phone:""].join(",");s.push(c)});else{const n=[e.order_number,t,a,"商品なし","","","",e.discount_amount,e.shipping_fee,e.final_amount,r,`"${e.shipping_name.replace(/"/g,'""')}"`,`"${e.shipping_address.replace(/"/g,'""')}"`,e.shipping_phone].join(",");s.push(n)}});const t="\ufeff"+[e,...s].join("\n"),r=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),l=document.createElement("a");l.setAttribute("href",n),l.setAttribute("download",`注文履歴_${(new Date).toISOString().split("T")[0]}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)},children:[x.jsx(L,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),a.map(e=>{return x.jsxs(p,{className:"p-6",children:[x.jsxs("div",{className:"flex justify-between items-start mb-4",children:[x.jsxs("div",{children:[x.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[x.jsxs("h3",{className:"text-lg font-semibold",children:["注文番号: ",e.order_number]}),x.jsxs("div",{className:`flex items-center space-x-1 px-2 py-1 rounded-full text-sm ${s=e.status,{pending:"text-yellow-600 bg-yellow-100",confirmed:"text-blue-600 bg-blue-100",processing:"text-purple-600 bg-purple-100",shipped:"text-orange-600 bg-orange-100",delivered:"text-green-600 bg-green-100",cancelled:"text-red-600 bg-red-100"}[s]||"text-gray-600 bg-gray-100"}`,children:[F(e.status),x.jsx("span",{children:H(e.status)})]}),e.can_cancel&&x.jsxs("div",{className:"text-xs text-orange-600 flex items-center",children:[x.jsx(k,{className:"w-3 h-3 mr-1"}),"キャンセル可能: あと",e.time_left]})]}),x.jsxs("p",{className:"text-gray-600 text-sm",children:["注文日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]}),e.estimated_delivery_date&&x.jsxs("p",{className:"text-gray-600 text-sm",children:["お届け予定日: ",new Date(e.estimated_delivery_date).toLocaleDateString("ja-JP")]})]}),x.jsxs("div",{className:"text-right",children:[x.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",e.final_amount.toLocaleString()]}),x.jsx("p",{className:"text-sm text-gray-500",children:K(e.payment_method)})]})]}),x.jsxs("div",{className:"space-y-3 mb-4",children:[e.order_items.slice(0,3).map(e=>x.jsxs("div",{className:"flex items-center space-x-4 bg-gray-50 p-3 rounded-lg",children:[x.jsx("img",{src:e.product.image_url,alt:e.product.name,className:"w-16 h-16 object-cover rounded",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),x.jsxs("div",{className:"flex-1",children:[x.jsx("h4",{className:"font-medium",children:e.product.name}),x.jsxs("p",{className:"text-sm text-gray-600",children:["数量: ",e.quantity," × ¥",e.unit_price.toLocaleString()]})]}),x.jsxs("p",{className:"font-medium",children:["¥",e.total_price.toLocaleString()]})]},e.id)),e.order_items.length>3&&x.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["他 ",e.order_items.length-3," 点"]})]}),x.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg mb-4",children:[x.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送先"}),x.jsxs("p",{className:"text-sm text-blue-800",children:[e.shipping_name,x.jsx("br",{}),"〒",e.shipping_postal_code,x.jsx("br",{}),e.shipping_address,x.jsx("br",{}),e.shipping_phone]})]}),e.tracking_number&&x.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg mb-4",children:[x.jsx("h4",{className:"font-semibold text-orange-900 mb-1",children:"配送追跡"}),x.jsxs("p",{className:"text-sm text-orange-800",children:["追跡番号: ",e.tracking_number]})]}),x.jsxs("div",{className:"flex justify-between items-center",children:[x.jsxs("div",{className:"flex space-x-2",children:[x.jsxs(h,{variant:"secondary",size:"sm",onClick:()=>O(e),children:[x.jsx(D,{className:"w-4 h-4 mr-1"}),"詳細を見る"]}),"delivered"===e.status&&x.jsxs(h,{variant:"secondary",size:"sm",onClick:()=>{alert("レビュー機能は準備中です")},children:[x.jsx(C,{className:"w-4 h-4 mr-1"}),"レビューを書く"]})]}),e.can_cancel&&x.jsxs(h,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700",onClick:()=>U(e.id),children:[x.jsx(P,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]},e.id);var s})]}),z&&x.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:x.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:x.jsxs("div",{className:"p-6",children:[x.jsxs("div",{className:"flex justify-between items-center mb-6",children:[x.jsx("h2",{className:"text-xl font-bold",children:"注文詳細"}),x.jsx("button",{onClick:()=>O(null),className:"text-gray-500 hover:text-gray-700",children:x.jsx(P,{className:"w-6 h-6"})})]}),x.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[x.jsxs("div",{children:[x.jsx("h3",{className:"font-semibold mb-3",children:"注文情報"}),x.jsxs("div",{className:"space-y-2 text-sm",children:[x.jsxs("p",{children:[x.jsx("span",{className:"font-medium",children:"注文番号:"})," ",z.order_number]}),x.jsxs("p",{children:[x.jsx("span",{className:"font-medium",children:"注文日:"})," ",new Date(z.created_at).toLocaleDateString("ja-JP")]}),x.jsxs("p",{children:[x.jsx("span",{className:"font-medium",children:"ステータス:"})," ",H(z.status)]}),x.jsxs("p",{children:[x.jsx("span",{className:"font-medium",children:"支払い方法:"})," ",K(z.payment_method)]}),z.estimated_delivery_date&&x.jsxs("p",{children:[x.jsx("span",{className:"font-medium",children:"お届け予定日:"})," ",new Date(z.estimated_delivery_date).toLocaleDateString("ja-JP")]}),z.can_cancel&&x.jsxs("div",{className:"mt-2 p-2 bg-orange-50 rounded-lg",children:[x.jsxs("p",{className:"text-orange-800 flex items-center",children:[x.jsx(k,{className:"w-4 h-4 mr-1"}),x.jsxs("span",{children:["キャンセル可能時間: あと",z.time_left]})]}),x.jsx("p",{className:"text-xs text-orange-700 mt-1",children:"注文から15分以内はキャンセル可能です"})]})]})]}),x.jsxs("div",{children:[x.jsx("h3",{className:"font-semibold mb-3",children:"配送先"}),x.jsxs("div",{className:"text-sm",children:[x.jsx("p",{className:"font-medium",children:z.shipping_name}),x.jsxs("p",{children:["〒",z.shipping_postal_code]}),x.jsx("p",{children:z.shipping_address}),x.jsx("p",{children:z.shipping_phone})]})]})]}),x.jsxs("div",{className:"mb-6",children:[x.jsx("h3",{className:"font-semibold mb-3",children:"注文商品"}),x.jsx("div",{className:"space-y-3",children:z.order_items.map(e=>x.jsxs("div",{className:"flex items-center space-x-4 border-b pb-3",children:[x.jsx("img",{src:e.product.image_url,alt:e.product.name,className:"w-16 h-16 object-cover rounded"}),x.jsxs("div",{className:"flex-1",children:[x.jsx("h4",{className:"font-medium",children:e.product.name}),x.jsxs("p",{className:"text-sm text-gray-600",children:["¥",e.unit_price.toLocaleString()," × ",e.quantity]})]}),x.jsxs("p",{className:"font-medium",children:["¥",e.total_price.toLocaleString()]})]},e.id))})]}),x.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[x.jsx("h3",{className:"font-semibold mb-3",children:"料金詳細"}),x.jsxs("div",{className:"space-y-2 text-sm",children:[x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{children:"商品小計"}),x.jsxs("span",{children:["¥",z.total_amount.toLocaleString()]})]}),z.discount_amount>0&&x.jsxs("div",{className:"flex justify-between text-purple-600",children:[x.jsx("span",{children:"割引"}),x.jsxs("span",{children:["-¥",z.discount_amount.toLocaleString()]})]}),x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{children:"送料"}),x.jsx("span",{children:0===z.shipping_fee?"無料":`¥${z.shipping_fee.toLocaleString()}`})]}),x.jsx("hr",{className:"my-2"}),x.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[x.jsx("span",{children:"合計"}),x.jsxs("span",{className:"text-green-600",children:["¥",z.final_amount.toLocaleString()]})]})]})]}),x.jsxs("div",{className:"mt-6 flex justify-between",children:[x.jsx(h,{variant:"secondary",onClick:()=>O(null),children:"閉じる"}),z.can_cancel&&x.jsxs(h,{className:"bg-red-600 hover:bg-red-700",onClick:()=>{O(null),U(z.id)},children:[x.jsx(P,{className:"w-4 h-4 mr-2"}),"注文をキャンセル"]})]})]})})}),R&&x.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:x.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[x.jsxs("div",{className:"text-center mb-6",children:[x.jsx(S,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),x.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"注文をキャンセルしますか？"}),x.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),x.jsxs("div",{className:"flex justify-end space-x-3",children:[x.jsx(h,{variant:"secondary",onClick:()=>U(null),children:"戻る"}),x.jsx(h,{className:"bg-red-600 hover:bg-red-700",isLoading:J,onClick:()=>Q(R),children:"キャンセルする"})]})]})})]})}export{z as OrderHistory};
