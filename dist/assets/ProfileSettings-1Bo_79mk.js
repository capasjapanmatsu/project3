import{j as e,V as ge,c as A,Y as pe,Z as je,_ as we,k as be,A as P,g as F,M as Ne,H as W,b as ve,d as X,u as ye,$ as Pe,s as Se,K as Ce,a0 as Ee,h as _e,a as ke,X as Y}from"./ui-vendor-FlUr4cJt.js";import{u as De,r as l,L as p}from"./react-vendor-_GyjDmDn.js";import{u as Le,s as o,B as i,C as Z}from"./index-BSYT0262.js";import{I as x}from"./Input-wBkmcJUR.js";import{l as Ae,f as Fe}from"./postalCodeLookup-Dgm8Gdim.js";import"./supabase-vendor-Df9iqQzW.js";function Re(){const{user:c}=Le(),j=De(),[J,q]=l.useState(!0),[Q,M]=l.useState(!1),[z,w]=l.useState(""),[I,S]=l.useState(""),[a,d]=l.useState({name:"",postal_code:"",address:"",phone_number:"",email:""}),[U,T]=l.useState({name:"",postal_code:"",address:"",phone_number:"",email:""}),[ee,b]=l.useState(!1),[se,C]=l.useState(!1),[n,h]=l.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[E,_]=l.useState(""),[re,R]=l.useState(!1),[ae,$]=l.useState(!1),[B,N]=l.useState(""),[H,g]=l.useState(""),[O,v]=l.useState(""),[te,K]=l.useState(!1),[k,D]=l.useState(""),[le,ne]=l.useState([]),[V,L]=l.useState("loading");l.useEffect(()=>{c?(ie(),G()):j("/login")},[c,j]);const ie=async()=>{try{q(!0);const{data:r,error:s}=await o.from("profiles").select("*").eq("id",c?.id).single();if(s)throw s;const t={name:r.name||"",postal_code:r.postal_code||"",address:r.address||"",phone_number:r.phone_number||"",email:c?.email||""};d(t),T(t)}catch(r){console.error("Error fetching profile:",r),w(r.message||"プロフィールの取得に失敗しました。")}finally{q(!1)}},G=async()=>{try{L("loading");const{data:r,error:s}=await o.auth.mfa.listFactors();if(s)throw s;const t=r.totp.filter(u=>u.status==="verified");ne(t),L(t.length>0?"enabled":"disabled")}catch(r){console.error("Error fetching MFA status:",r),L("disabled")}},oe=()=>{j("/two-factor-setup")},ce=async r=>{if(confirm("2ファクタ認証を無効にしますか？セキュリティが低下します。"))try{const{error:s}=await o.auth.mfa.unenroll({factorId:r});if(s)throw s;await G()}catch(s){console.error("Error disabling 2FA:",s),w("2FAの無効化に失敗しました")}},de=r=>{const s=r.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:a.postal_code},me=async r=>{const s=de(r);if(d({...a,postal_code:s}),s.replace(/-/g,"").length===7){K(!0),D("");try{const t=await Ae(s);if(t.success&&t.results&&t.results.length>0){const u=Fe(t.results[0]);d(y=>({...y,address:u}))}else D(t.message||"住所が見つかりませんでした")}catch(t){console.error("Error looking up postal code:",t),D("住所の検索中にエラーが発生しました")}finally{K(!1)}}},xe=r=>{const s=r.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:a.phone_number},he=async r=>{r.preventDefault(),M(!0),w(""),S("");try{if(!a.name.trim())throw new Error("お名前を入力してください");if(a.postal_code&&!a.postal_code.match(/^\d{3}-\d{4}$/))throw new Error("郵便番号は正しい形式で入力してください（例：123-4567）");if(a.phone_number&&!a.phone_number.match(/^0\d{2,3}-\d{1,4}-\d{4}$/))throw new Error("電話番号は正しい形式で入力してください（例：090-1234-5678）");const s=U.postal_code!==a.postal_code||U.address!==a.address;let t=!1;if(s){const{data:m,error:f}=await o.from("owner_verifications").select("id, status").eq("user_id",c?.id).eq("status","verified").single();f&&f.code!=="PGRST116"&&console.error("Error checking owner verification:",f),m&&(t=!0)}const{error:u}=await o.from("profiles").update({name:a.name,postal_code:a.postal_code,address:a.address,phone_number:a.phone_number}).eq("id",c?.id);if(u)throw u;if(t){const{error:m}=await o.from("owner_verifications").update({status:"pending",updated_at:new Date().toISOString()}).eq("user_id",c?.id);m&&console.error("Error resetting identity verification:",m);const{error:f}=await o.from("notifications").insert([{user_id:c?.id,type:"identity_verification",title:"住所変更により本人確認が必要です",message:"住所を変更されたため、本人確認書類を再度提出する必要があります。ドッグラン施設の登録を継続される場合は、本人確認書類をアップロードしてください。",data:{reason:"address_change"}}]);f&&console.error("Error creating notification:",f)}if(c?.email!==a.email){const{error:m}=await o.auth.updateUser({email:a.email});if(m)throw m}T(a);let y="プロフィールを更新しました";t&&(y+=`

住所変更により本人確認が必要になりました。ドッグラン施設の登録を継続される場合は、本人確認書類を再度アップロードしてください。`),S(y),setTimeout(()=>{S("")},3e3)}catch(s){console.error("Error updating profile:",s),w(s.message||"プロフィールの更新に失敗しました")}finally{M(!1)}},ue=async r=>{r.preventDefault(),R(!0),N(""),g("");try{if(!n.currentPassword)throw new Error("現在のパスワードを入力してください");if(!n.newPassword)throw new Error("新しいパスワードを入力してください");if(n.newPassword.length<6)throw new Error("パスワードは6文字以上で入力してください");if(n.newPassword!==n.confirmPassword)throw new Error("新しいパスワードと確認用パスワードが一致しません");const{error:s}=await o.auth.signInWithPassword({email:c?.email||"",password:n.currentPassword});if(s)throw new Error("現在のパスワードが正しくありません");const{error:t}=await o.auth.updateUser({password:n.newPassword});if(t)throw t;g("パスワードを変更しました"),h({currentPassword:"",newPassword:"",confirmPassword:""}),setTimeout(()=>{b(!1),g("")},3e3)}catch(s){console.error("Error changing password:",s),N(s.message||"パスワードの変更に失敗しました")}finally{R(!1)}},fe=async r=>{r.preventDefault(),$(!0),v("");try{if(E!=="delete")throw new Error("確認のため「delete」と入力してください");const{error:s}=await o.auth.admin.deleteUser(c?.id||"");if(s)throw s;await o.auth.signOut(),j("/",{replace:!0})}catch(s){console.error("Error deleting account:",s),v(s.message||"アカウントの削除に失敗しました")}finally{$(!1)}};return J?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(p,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(A,{className:"w-8 h-8 text-blue-600 mr-3"}),"プロフィール設定"]}),e.jsx("p",{className:"text-lg text-gray-600",children:"アカウント情報を管理します"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[e.jsx(p,{to:"/payment-method-settings",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),e.jsx(p,{to:"/dogpark-history",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),e.jsx(p,{to:"/orders",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),e.jsx(p,{to:"/shop",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),e.jsx(Z,{className:"p-6",children:e.jsxs("form",{onSubmit:he,children:[z&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(P,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:z})]}),I&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(F,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:I})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(A,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"基本情報"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(x,{label:"お名前 *",value:a.name,onChange:r=>d({...a,name:r.target.value}),required:!0,icon:e.jsx(A,{className:"w-4 h-4 text-gray-500"})}),e.jsx(x,{label:"メールアドレス *",type:"email",value:a.email,onChange:r=>d({...a,email:r.target.value}),required:!0,icon:e.jsx(Ne,{className:"w-4 h-4 text-gray-500"})})]}),e.jsxs("div",{className:"flex items-center space-x-3 mb-6 mt-8",children:[e.jsx(W,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"住所情報"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ve,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:a.postal_code,onChange:r=>me(r.target.value),className:`w-full pl-10 pr-10 py-2 border ${k?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8}),te&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(X,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),k&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:k})]}),e.jsx(x,{label:"電話番号",value:a.phone_number,onChange:r=>{const s=xe(r.target.value);d({...a,phone_number:s})},placeholder:"090-1234-5678",maxLength:13,icon:e.jsx(ye,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(x,{label:"住所",value:a.address,onChange:r=>d({...a,address:r.target.value}),placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(W,{className:"w-4 h-4 text-gray-500"})})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(i,{type:"submit",isLoading:Q,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Pe,{className:"w-4 h-4 mr-2"}),"保存する"]})})]})]})}),e.jsxs(Z,{className:"p-6 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(Se,{className:"w-6 h-6 text-yellow-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"アカウント設定"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"パスワード変更"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを保つため、定期的にパスワードを変更することをおすすめします。"}),e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>b(!0),children:[e.jsx(Ce,{className:"w-4 h-4 mr-2"}),"パスワードを変更"]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"アカウント削除"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントを削除すると、すべてのデータが完全に削除され、復元できなくなります。"}),e.jsxs(i,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>C(!0),children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"アカウントを削除"]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"2ファクタ認証（2FA）"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを強化するため、2ファクタ認証の設定をおすすめします。"}),V==="loading"?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-sm text-gray-600",children:"読み込み中..."})]}):V==="enabled"?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"2FAが有効です"})]}),le.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-green-50 rounded border border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm",children:r.friendly_name||"認証アプリ"})]}),e.jsx(i,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>ce(r.id),children:"無効化"})]},r.id))]}):e.jsxs(i,{variant:"secondary",size:"sm",onClick:oe,children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"2FAを有効化"]})]})]})]}),ee&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"パスワード変更"}),e.jsx("button",{onClick:()=>{b(!1),N(""),g(""),h({currentPassword:"",newPassword:"",confirmPassword:""})},className:"text-gray-500 hover:text-gray-700",children:e.jsx(Y,{className:"w-6 h-6"})})]}),B&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(P,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:B})]})}),H&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(F,{className:"w-5 h-5 text-green-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-green-800",children:H})]})}),e.jsx("form",{onSubmit:ue,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(x,{label:"現在のパスワード *",type:"password",value:n.currentPassword,onChange:r=>h({...n,currentPassword:r.target.value}),required:!0}),e.jsx(x,{label:"新しいパスワード *",type:"password",value:n.newPassword,onChange:r=>h({...n,newPassword:r.target.value}),required:!0,minLength:6}),e.jsx(x,{label:"新しいパスワード（確認） *",type:"password",value:n.confirmPassword,onChange:r=>h({...n,confirmPassword:r.target.value}),required:!0,minLength:6}),e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"パスワードの要件"}),e.jsx("br",{}),"• 6文字以上",e.jsx("br",{}),"• 英数字を含めることをおすすめします",e.jsx("br",{}),"• 以前使用したパスワードと異なるものを使用してください"]})}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(i,{type:"button",variant:"secondary",onClick:()=>{b(!1),N(""),g(""),h({currentPassword:"",newPassword:"",confirmPassword:""})},children:"キャンセル"}),e.jsx(i,{type:"submit",isLoading:re,children:"パスワードを変更"})]})]})})]})}),se&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-red-600",children:"アカウント削除"}),e.jsx("button",{onClick:()=>{C(!1),v(""),_("")},className:"text-gray-500 hover:text-gray-700",children:e.jsx(Y,{className:"w-6 h-6"})})]}),O&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(P,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:O})]})}),e.jsx("div",{className:"p-4 bg-red-50 rounded-lg mb-4",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(P,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 mb-1",children:"警告: この操作は取り消せません"}),e.jsx("p",{className:"text-sm text-red-700",children:"アカウントを削除すると、以下のデータがすべて完全に削除されます："}),e.jsxs("ul",{className:"text-sm text-red-700 list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"プロフィール情報"}),e.jsx("li",{children:"登録したワンちゃんの情報"}),e.jsx("li",{children:"予約履歴"}),e.jsx("li",{children:"支払い情報"}),e.jsx("li",{children:"友達リストとメッセージ"})]})]})]})}),e.jsx("form",{onSubmit:fe,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"確認のため「delete」と入力してください *"}),e.jsx("input",{type:"text",value:E,onChange:r=>_(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(i,{type:"button",variant:"secondary",onClick:()=>{C(!1),v(""),_("")},children:"キャンセル"}),e.jsx(i,{type:"submit",isLoading:ae,className:"bg-red-600 hover:bg-red-700",disabled:E!=="delete",children:"アカウントを削除"})]})]})})]})})]})}export{Re as ProfileSettings};
