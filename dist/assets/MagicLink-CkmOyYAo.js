import{j as e,B as s,b as a,d as t}from"./index-rzoKNnex.js";import{u as r,b as i,r as o}from"./vendor-Cwmn0chA.js";import{C as n}from"./Card-CRM3w0N8.js";import{o as c,l as m,i as l}from"./ui-CMSAjam7.js";import"./supabase-Dzr8oIt2.js";function d(){const d=r(),x=i(),[u,h]=o.useState(!0),[p,f]=o.useState(null),[j,b]=o.useState(!1);return o.useEffect((()=>{(async()=>{var e;try{h(!0);const s=window.location.hash;if(!s||!s.includes("access_token"))return void f("無効なMagic Linkです。もう一度ログインしてください。");const r=new URLSearchParams(s.substring(1)),i=r.get("access_token"),o=r.get("refresh_token");if(!i||!o)return void f("認証トークンが見つかりません。もう一度ログインしてください。");const{error:n}=await a.auth.setSession({access_token:i,refresh_token:o});if(n)throw n;const{data:{user:c},error:m}=await a.auth.getUser();if(m||!c)throw m||new Error("ユーザー情報の取得に失敗しました");const{data:l,error:x}=await a.from("profiles").select("id").eq("id",c.id).maybeSingle();if(x&&x.code,!l){const s=c.user_metadata||{},{error:t}=await a.from("profiles").upsert([{id:c.id,user_type:s.user_type||"user",name:s.name||(null==(e=c.email)?void 0:e.split("@")[0])||"ユーザー",postal_code:s.postal_code||"",address:s.address||"",phone_number:s.phone_number||""}],{onConflict:"id"})}c&&t(`trusted_device_${c.id}`,"true"),b(!0),setTimeout((()=>{d("/dashboard")}),2e3)}catch(s){f(s.message||"マジックリンクの送信に失敗しました")}finally{h(!1)}})()}),[d,x]),u?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(n,{className:"text-center p-8",children:[e.jsx(c,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(n,{className:"text-center p-8",children:[e.jsx(m,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p}),e.jsx(s,{onClick:()=>d("/login"),children:"ログインページに戻る"})]})}):j?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(n,{className:"text-center p-8",children:[e.jsx(l,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(s,{onClick:()=>d("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{d as MagicLink};
