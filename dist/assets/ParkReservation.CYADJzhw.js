var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,i=(s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a,n=(e,s)=>{for(var t in s||(s={}))r.call(s,t)&&i(e,t,s[t]);if(a)for(var t of a(s))l.call(s,t)&&i(e,t,s[t]);return e},c=(e,s,t)=>new Promise(((a,r)=>{var l=e=>{try{n(t.next(e))}catch(s){r(s)}},i=e=>{try{n(t.throw(e))}catch(s){r(s)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,i);n((t=t.apply(e,s)).next())}));import{j as d,C as o,B as m,u as x,b as p,s as h}from"./index.oOj2R_C7.js";import{d as u,u as j,r as g}from"./router.icJHpBzt.js";import{u as b}from"./useStripe.C7uENATF.js";import{p as y}from"./stripe-config.03sBkt-B.js";import{I as f}from"./Input.DeZ8m3vP.js";import{V as N,g as v}from"./VaccineBadge.DkGxiQDo.js";import{e as w,ag as S,I as T,h as _,P as I,o as D,n as P,A as F,a2 as k,K as O,X as $}from"./ui.UnEvinBv.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";import"./stripe.ONZxK9h-.js";function C({park:e,error:s,formData:t,setFormData:a,timeSlots:r,isDateTooSoon:l,selectedDogs:i,dogs:n,handleDogSelection:c,handleTimeSlotSelect:x,getEndTime:p,getSlotStatus:h,getSelectedDogNames:u,calculateDayPassPrice:j,calculateTotalPrice:g,hasSubscription:b,handleSubmit:y,isLoading:O,checkoutLoading:$,MAX_DOGS:C}){return d.jsxs(o,{children:[d.jsxs("div",{className:"mb-6",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[d.jsx(w,{className:"w-5 h-5 text-gray-500"}),d.jsx("p",{className:"text-gray-600",children:e.address})]}),d.jsx("p",{className:"text-gray-600 mb-4",children:e.description}),d.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(S,{className:"w-5 h-5 text-blue-600"}),d.jsx("h3",{className:"font-semibold text-blue-900",children:"料金体系"})]}),d.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[d.jsx("p",{children:"• 1日券: ¥800（24時間有効）"}),d.jsx("p",{children:"• 2頭目以降: +¥400/頭（半額）"}),d.jsx("p",{children:"• サブスク: 月額¥3,800（3頭まで使い放題）"}),d.jsx("p",{children:"• 施設貸し切り: ¥4,400/時間（サブスク会員20%OFF）"})]})]}),d.jsxs("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(T,{className:"w-5 h-5 text-yellow-600"}),d.jsx("h3",{className:"font-semibold text-yellow-900",children:"施設貸し切りの注意事項"})]}),d.jsxs("div",{className:"text-sm text-yellow-800 space-y-1",children:[d.jsx("p",{children:"• 施設貸し切りは1時間単位で予約可能です"}),d.jsxs("p",{children:["• ",d.jsx("strong",{children:"2日前までの予約が必要です"}),"（当日・翌日の予約不可）"]}),d.jsx("p",{children:"• 貸し切り中は他のお客様は入場できません"}),d.jsx("p",{children:"• 友達にPINコードを共有して一緒に利用できます"})]})]})]}),d.jsxs("form",{onSubmit:y,children:[s&&d.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:s}),d.jsxs("div",{className:"mb-4",children:[d.jsxs("div",{className:"flex justify-between items-center mb-3",children:[d.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",C,"頭）"]}),d.jsxs("div",{className:"text-sm text-gray-600",children:[i.length,"/",C,"頭選択中"]})]}),d.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:n.map((e=>{const s=i.includes(e.id),t=!s&&i.length>=C;return d.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(s?"border-green-500 bg-green-50":t?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>!t&&c(e.id),children:[s&&d.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:d.jsx(_,{className:"w-4 h-4"})}),d.jsxs("div",{className:"flex items-center space-x-3",children:[d.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?d.jsx("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover"}):d.jsx(I,{className:"w-6 h-6 text-gray-500"})}),d.jsxs("div",{children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[d.jsxs("h3",{className:"font-semibold",children:[e.name,"ちゃん"]}),d.jsx(N,{status:v(e),size:"sm"})]}),d.jsxs("p",{className:"text-sm text-gray-600",children:[e.breed," • ",e.gender]})]})]})]},e.id)}))}),i.length>0&&d.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[d.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),d.jsx("p",{className:"text-sm text-green-800",children:u()}),d.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[i.length,"頭が同時入場できます"]})]})]}),d.jsx(f,{label:"日付",type:"date",value:t.date,onChange:e=>a({date:e.target.value,selectedTimeSlot:""}),min:(new Date).toISOString().split("T")[0],required:!0}),d.jsxs("div",{className:"mb-4",children:[d.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"支払い方法"}),d.jsxs("div",{className:"space-y-4",children:[!b&&d.jsxs("label",{className:"flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors "+("single"===t.paymentType?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:[d.jsx("input",{type:"radio",value:"single",checked:"single"===t.paymentType,onChange:e=>a({paymentType:e.target.value}),className:"form-radio text-blue-600"}),d.jsxs("div",{className:"flex-1",children:[d.jsxs("div",{className:"flex items-center space-x-2",children:[d.jsx(S,{className:"w-5 h-5 text-blue-600"}),d.jsx("span",{className:"font-medium",children:"1日券（段階的料金制）"})]}),d.jsx("p",{className:"text-sm text-gray-600",children:"1頭目¥800 + 2頭目以降¥400/頭・24時間有効"}),i.length>0&&d.jsxs("p",{className:"text-sm text-blue-600 mt-1",children:[i.length,"頭選択中: ¥",j().toLocaleString()]})]})]}),d.jsxs("label",{className:"flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors "+("subscription"===t.paymentType?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-gray-300"),children:[d.jsx("input",{type:"radio",value:"subscription",checked:"subscription"===t.paymentType,onChange:e=>a({paymentType:e.target.value}),className:"form-radio text-purple-600"}),d.jsxs("div",{className:"flex-1",children:[d.jsxs("div",{className:"flex items-center space-x-2",children:[d.jsx(D,{className:"w-5 h-5 text-purple-600"}),d.jsx("span",{className:"font-medium",children:"サブスクリプション（月額¥3,800）"}),b?d.jsx("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs",children:"ご利用中"}):d.jsx("span",{className:"bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs",children:"未加入"})]}),d.jsx("p",{className:"text-sm text-gray-600",children:"3頭まで使い放題・施設貸し切り20%OFF"}),!b&&d.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"※ サブスクリプションに加入していません"})]})]}),d.jsxs("label",{className:"flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors "+("facility_rental"===t.paymentType?"border-orange-500 bg-orange-50":"border-gray-200 hover:border-gray-300"),children:[d.jsx("input",{type:"radio",value:"facility_rental",checked:"facility_rental"===t.paymentType,onChange:e=>a({paymentType:e.target.value,duration:"1"}),className:"form-radio text-orange-600"}),d.jsxs("div",{className:"flex-1",children:[d.jsxs("div",{className:"flex items-center space-x-2",children:[d.jsx(P,{className:"w-5 h-5 text-orange-600"}),d.jsx("span",{className:"font-medium",children:"施設貸し切り"}),d.jsxs("span",{className:"bg-orange-200 text-orange-800 px-2 py-1 rounded-full text-xs",children:["1時間¥",b?"3,520":"4,400"]})]}),d.jsx("p",{className:"text-sm text-gray-600",children:"施設全体を独占利用・人数制限なし・友達にPINコード共有可能"}),b&&d.jsx("p",{className:"text-sm text-purple-700 font-medium mt-1",children:"サブスク会員20%OFF適用済み！"})]})]})]})]}),"facility_rental"===t.paymentType&&t.date&&d.jsx(d.Fragment,{children:d.jsxs("div",{className:"mb-4",children:[d.jsxs("div",{className:"flex justify-between items-center mb-3",children:[d.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"利用開始時間を選択してください"}),d.jsxs("div",{className:"flex items-center space-x-2",children:[d.jsx("label",{className:"text-sm text-gray-700",children:"利用時間:"}),d.jsx("select",{value:t.duration,onChange:e=>a({duration:e.target.value}),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[1,2,3,4].map((e=>d.jsxs("option",{value:e.toString(),children:[e,"時間"]},e)))})]})]}),l&&d.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[d.jsx(F,{className:"w-5 h-5 mt-0.5 mr-2 flex-shrink-0"}),d.jsxs("div",{children:[d.jsx("p",{className:"font-medium",children:"施設貸し切りは2日前までの予約が必要です"}),d.jsx("p",{className:"text-sm",children:"2日後以降の日付を選択してください。"})]})]}),d.jsx("div",{className:"grid grid-cols-3 md:grid-cols-4 gap-3",children:r.map((e=>{const s=h(e),a=s.icon,i=t.selectedTimeSlot===e.time,n=e.isWholeFacilityAvailable&&!l,c=parseInt(t.duration);let o=!0;if(n&&c>1){const s=parseInt(e.time.split(":")[0]);for(let e=1;e<c;e++){const t=s+e,a=r.find((e=>parseInt(e.time.split(":")[0])===t));if(!a||!a.isWholeFacilityAvailable){o=!1;break}}}const m=n&&o;return d.jsx("button",{type:"button",onClick:()=>{m&&x(e.time)},disabled:!m,className:"p-3 rounded-lg border-2 transition-all "+(i?"border-orange-500 bg-orange-50":m?"border-gray-200 hover:border-gray-300":"border-gray-200 opacity-50 cursor-not-allowed"),children:d.jsxs("div",{className:"text-center",children:[d.jsx("div",{className:"font-medium text-gray-900",children:e.time}),d.jsxs("div",{className:`inline-flex items-center space-x-1 px-2 py-1 rounded-full text-xs mt-1 ${m?s.color:"bg-red-500 text-white"}`,children:[d.jsx(a,{className:"w-3 h-3"}),d.jsx("span",{children:m?s.label:"利用不可"})]}),!m&&n&&!o&&d.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["連続",c,"時間予約不可"]})]})},e.time)}))}),t.selectedTimeSlot&&d.jsxs("div",{className:"text-sm mt-3 p-3 rounded-lg bg-orange-50 text-orange-800 border border-orange-200",children:[d.jsxs("div",{className:"flex items-center space-x-2",children:[d.jsx(P,{className:"w-4 h-4"}),d.jsxs("span",{className:"font-medium",children:["選択時間: ",t.selectedTimeSlot," ～ ",p(t.selectedTimeSlot,t.duration)]})]}),d.jsx("p",{className:"text-xs mt-1 flex items-center",children:"施設貸し切りは1時間単位での利用となります。"})]})]})}),d.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-blue-50 text-blue-700 border border-blue-200",children:[d.jsx("p",{className:"font-medium",children:"予約内容"}),d.jsxs("div",{className:"mt-1 space-y-1",children:[d.jsxs("p",{children:["選択ワンちゃん: ",i.length,"頭"]}),"single"===t.paymentType&&d.jsxs("div",{children:[d.jsxs("p",{children:["1日券料金: ¥",j().toLocaleString(),"（",i.length,"頭・段階的料金）"]}),d.jsx("p",{className:"text-xs",children:"24時間有効・全国のドッグランで利用可能"})]}),"subscription"===t.paymentType&&d.jsx("div",{children:b?d.jsxs("div",{children:[d.jsx("p",{className:"text-purple-700 font-medium",children:"サブスク会員: 3頭まで使い放題"}),d.jsx("p",{className:"text-xs",children:"追加料金なし・全国のドッグランで利用可能"})]}):d.jsxs("div",{children:[d.jsx("p",{className:"text-orange-700 font-medium",children:"サブスクリプション申し込み: 月額¥3,800"}),d.jsx("p",{className:"text-xs",children:"申し込み後、3頭まで使い放題・全国のドッグランで利用可能"})]})}),"facility_rental"===t.paymentType&&d.jsxs("div",{children:[d.jsxs("p",{children:["施設貸し切り料金: ¥",g().toLocaleString()]}),d.jsxs("p",{className:"text-xs",children:[t.duration,"時間利用・施設全体独占・友達にPINコード共有可能"]}),b&&d.jsx("p",{className:"text-purple-700 font-medium text-xs",children:"サブスク会員20%OFF適用済み"})]}),d.jsx("div",{className:"border-t border-blue-300 pt-2 mt-2",children:d.jsxs("p",{className:"font-bold",children:["合計料金: ¥",g().toLocaleString()]})})]}),d.jsxs("p",{className:"text-sm mt-2 flex items-center",children:[d.jsx(k,{className:"w-3 h-3 mr-1"}),"決済完了後、入場用PINコードが発行されます"]})]}),d.jsxs(m,{type:"submit",isLoading:O||$,className:"w-full mt-4 bg-blue-600 hover:bg-blue-700",disabled:0===i.length||"facility_rental"===t.paymentType&&(!t.selectedTimeSlot||l),children:["subscription"!==t.paymentType||b?d.jsxs(d.Fragment,{children:[d.jsx(k,{className:"w-4 h-4 mr-2"}),b&&"subscription"===t.paymentType?"PINコードを発行する":"決済に進む"]}):d.jsxs(d.Fragment,{children:[d.jsx(D,{className:"w-4 h-4 mr-2"}),"サブスクリプションに加入する"]}),i.length>0&&d.jsxs("span",{className:"ml-2 bg-blue-500 text-white px-2 py-1 rounded-full text-sm",children:[i.length,"頭・¥",g().toLocaleString()]})]})]})]})}function A({hasSubscription:e}){return d.jsxs("div",{className:"space-y-6",children:[e?d.jsxs(o,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(D,{className:"w-5 h-5"}),d.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),d.jsxs("div",{className:"text-sm space-y-1",children:[d.jsx("p",{children:"• 3頭まで使い放題"}),d.jsx("p",{children:"• 施設貸し切り20%OFF"}),d.jsx("p",{children:"• ペットショップ10%OFF"})]})]}):d.jsxs(o,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(D,{className:"w-5 h-5"}),d.jsx("span",{className:"font-semibold",children:"サブスクリプションがお得！"})]}),d.jsxs("div",{className:"text-sm space-y-1 mb-3",children:[d.jsx("p",{children:"• 月額¥3,800で3頭まで使い放題"}),d.jsx("p",{children:"• 施設貸し切り20%OFF"}),d.jsx("p",{children:"• ペットショップ10%OFF"}),d.jsx("p",{children:"• 全国のドッグランで利用可能"})]}),d.jsx("p",{className:"text-xs",children:"サブスクリプションを選択して決済ページで申し込みできます"})]}),d.jsxs(o,{className:"p-4 bg-blue-50 border-blue-200",children:[d.jsxs("h3",{className:"font-semibold text-blue-900 mb-2 flex items-center",children:[d.jsx(S,{className:"w-4 h-4 mr-2"}),"料金体系"]}),d.jsxs("div",{className:"space-y-2 text-sm text-blue-800",children:[d.jsxs("div",{children:[d.jsx("p",{className:"font-medium",children:"1日券（段階的料金制）"}),d.jsxs("div",{className:"ml-2 space-y-1",children:[d.jsx("p",{children:"• 1頭目: ¥800"}),d.jsx("p",{children:"• 2頭目: +¥400"}),d.jsx("p",{children:"• 3頭目: +¥400"}),d.jsx("p",{className:"font-medium",children:"3頭合計: ¥1,600"})]})]}),d.jsxs("div",{children:[d.jsx("p",{className:"font-medium",children:"サブスク: 月額¥3,800"}),d.jsx("p",{className:"ml-2",children:"3頭まで使い放題"})]}),d.jsxs("div",{children:[d.jsxs("p",{className:"font-medium flex items-center",children:[d.jsx(P,{className:"w-3 h-3 mr-1"}),"施設貸し切り"]}),d.jsxs("div",{className:"ml-2 space-y-1",children:[d.jsx("p",{children:"• 通常: ¥4,400/1時間"}),d.jsx("p",{className:"text-purple-700 font-medium",children:"• サブスク: ¥3,520/1時間（20%OFF）"}),d.jsx("p",{children:"• 1時間単位で予約可能"}),d.jsxs("p",{children:["• ",d.jsx("strong",{children:"2日前までの予約が必要"})]})]})]})]})]}),d.jsxs(o,{className:"p-4 bg-green-50 border-green-200",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(k,{className:"w-5 h-5 text-green-600"}),d.jsx("h3",{className:"font-semibold text-green-900",children:"決済について"})]}),d.jsxs("div",{className:"space-y-1 text-sm text-green-800",children:[d.jsx("p",{children:"• 安全なクレジットカード決済"}),d.jsx("p",{children:"• 決済完了後、即座にPINコード発行"}),d.jsx("p",{children:"• 24時間有効（1日券の場合）"}),d.jsx("p",{children:"• 全国のドッグランで利用可能"}),d.jsx("p",{children:"• 最大3頭まで同時入場"})]})]}),d.jsxs(o,{className:"p-4 bg-green-50 border-green-200",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(S,{className:"w-5 h-5 text-green-600"}),d.jsx("h3",{className:"font-semibold text-green-900",children:"1日券の特徴"})]}),d.jsxs("div",{className:"space-y-1 text-sm text-green-800",children:[d.jsx("p",{children:"• 24時間有効（発行から24時間後に失効）"}),d.jsx("p",{children:"• 最大3頭まで同時入場可能"}),d.jsx("p",{children:"• 段階的料金制でお得"}),d.jsx("p",{children:"• 全国のドッグランで利用可能"}),d.jsx("p",{className:"text-red-600 font-medium",children:"• 施設貸し切り中は入場できません"})]})]}),d.jsxs(o,{className:"p-4 bg-orange-50 border-orange-200",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(P,{className:"w-5 h-5 text-orange-600"}),d.jsx("h3",{className:"font-semibold text-orange-900",children:"施設貸し切り特典"})]}),d.jsxs("div",{className:"space-y-1 text-sm text-orange-800",children:[d.jsx("p",{children:"• 施設全体を独占利用"}),d.jsx("p",{children:"• 人数制限なし"}),d.jsx("p",{children:"• 1時間単位での利用"}),d.jsx("p",{children:"• 最大3頭まで同時入場"}),d.jsx("p",{children:"• 友達にPINコード共有可能"}),d.jsx("p",{children:"• 他の利用者を一切気にせず自由に遊べます"}),d.jsx("p",{children:"• 大型犬・小型犬エリア両方利用可能"}),d.jsx("p",{className:"text-purple-700 font-medium",children:"• サブスク会員は20%OFF！"}),d.jsxs("p",{className:"text-red-600 font-medium",children:["• ",d.jsx("strong",{children:"2日前までの予約が必要"})]})]})]}),d.jsxs(o,{className:"p-4 bg-yellow-50 border-yellow-200",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(I,{className:"w-5 h-5 text-yellow-600"}),d.jsx("h3",{className:"font-semibold text-yellow-900",children:"入場時の犬選択"})]}),d.jsxs("div",{className:"space-y-1 text-sm text-yellow-800",children:[d.jsx("p",{children:"• 最大3頭まで選択可能"}),d.jsx("p",{children:"• 選択した犬のみ入場可能"}),d.jsx("p",{children:"• 全ての犬のワクチン証明書が必要"}),d.jsx("p",{children:"• 後から犬の変更はできません"})]})]}),d.jsxs(o,{className:"p-4 bg-green-50 border-green-200",children:[d.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[d.jsx(O,{className:"w-4 h-4 text-green-600"}),d.jsx("span",{className:"text-sm font-medium text-green-900",children:"決済完了後の流れ"})]}),d.jsxs("div",{className:"text-xs text-green-800 space-y-1",children:[d.jsx("p",{children:"1. 決済完了と同時に入場用PINコードが発行されます"}),d.jsx("p",{children:"2. マイページの「入退場」からPINコードを確認"}),d.jsx("p",{children:"3. 予約日時にドッグラン入口でPINコードを入力"}),d.jsx("p",{children:"4. 選択した全ての犬と一緒に入場できます"}),d.jsx("p",{className:"text-orange-700 font-medium",children:"5. 施設貸し切りの場合、友達にPINコードを共有可能！"})]})]})]})}function L(){const{parkId:e}=u(),a=j(),{user:r}=x(),{isActive:l}=p(),{createCheckoutSession:i,loading:f}=b(),[N,v]=g.useState(!1),[w,S]=g.useState(""),[T,_]=g.useState([]),[I,D]=g.useState(null),[F,k]=g.useState([]),[O,L]=g.useState([]),[E,q]=g.useState([]),[M,U]=g.useState({date:"",selectedTimeSlot:"",duration:"1",reservationType:"whole_facility",paymentType:"single"}),W=e=>{U((s=>n(n({},s),e)))},[B,G]=g.useState(!1),H=g.useMemo((()=>{const e=[];for(let s=6;s<=21;s++){const t=`${s.toString().padStart(2,"0")}:00`;e.push({time:t,available:!0,reservationCount:0,maxCapacity:(null==I?void 0:I.max_capacity)||10,isPrivateBoothAvailable:!0,isWholeFacilityAvailable:!0})}return e}),[null==I?void 0:I.max_capacity]);g.useEffect((()=>{r?function(){c(this,null,(function*(){if(r)try{const[s,t]=yield Promise.all([h.from("dogs").select("\n              *,\n              vaccine_certifications(*)\n            ").eq("owner_id",r.id),h.from("dog_parks").select("*").eq("id",e).single()]);if(s.error)throw s.error;if(t.error)throw t.error;const a=(s.data||[]).filter((e=>e.vaccine_certifications&&e.vaccine_certifications.some((e=>"approved"===e.status))));_(a),D(t.data)}catch(s){}}))}():a("/login")}),[r,e,a]),g.useEffect((()=>{l&&"single"===M.paymentType&&W({paymentType:"subscription"})}),[l]),g.useEffect((()=>{M.date&&I&&J()}),[M.date,I]),g.useEffect((()=>{if(M.date){const e=new Date(M.date),s=new Date;s.setHours(0,0,0,0);const t=new Date(s);t.setDate(s.getDate()+2);const a="facility_rental"===M.paymentType&&e<t;G(a),S(a?"施設貸し切りは2日前までの予約が必要です。":"")}}),[M.date,M.paymentType]);const J=()=>c(null,null,(function*(){if(M.date&&I)try{const{data:s,error:t}=yield h.from("reservations").select("*").eq("park_id",e).eq("date",M.date).eq("status","confirmed");if(t)throw t;L(s||[]),V(s||[])}catch(s){}})),V=e=>{const s=[...H];s.forEach((s=>{const t=parseInt(s.time.split(":")[0]);let a=0,r=0,l=0;e.forEach((e=>{const s=parseInt(e.start_time.split(":")[0]),i=s+e.duration;t>=s&&t<i&&("whole_facility"===e.reservation_type||e.total_amount>=4400?l++:"private_booth"===e.reservation_type||5e3===e.total_amount?r++:a++)})),s.reservationCount=a,s.available=a<s.maxCapacity&&0===l,s.isPrivateBoothAvailable=r<((null==I?void 0:I.private_booth_count)||0)&&0===l,s.isWholeFacilityAvailable=0===a&&0===r&&0===l})),k(s)},X=()=>{const e=parseInt(M.duration);if(l){const s=4400*e;return Math.round(.8*s)}return 4400*e},z=()=>{const e=E.length;return 0===e?0:1===e?800:800+400*(e-1)},K=()=>"subscription"===M.paymentType?l?0:3800:"facility_rental"===M.paymentType?X():z(),Q=()=>E.map((e=>{const s=T.find((s=>s.id===e));return(null==s?void 0:s.name)||""})).filter((e=>e)).join("、");return I?0===T.length?d.jsxs(o,{className:"max-w-2xl mx-auto text-center py-8",children:[d.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ワクチン接種証明書が必要です"}),d.jsx("p",{className:"text-gray-600 mb-4",children:"ドッグランを利用するには、ワクチン接種証明書の承認が必要です。 まだ証明書を提出していない場合は、ワンちゃんの登録時に提出してください。"}),d.jsx(m,{onClick:()=>a("/register-dog"),children:"ワンちゃんを登録する"})]}):d.jsxs("div",{className:"max-w-6xl mx-auto",children:[d.jsxs("h1",{className:"text-2xl font-bold text-center mb-8",children:[I.name,"の予約"]}),d.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[d.jsx("div",{className:"lg:col-span-2",children:d.jsx(C,{park:I,error:w,formData:M,setFormData:W,timeSlots:F,isDateTooSoon:B,selectedDogs:E,dogs:T,handleDogSelection:e=>{q((s=>s.includes(e)?s.filter((s=>s!==e)):s.length>=3?(S("最大3頭まで選択可能です。"),s):(S(""),[...s,e])))},handleTimeSlotSelect:e=>{U((a=>{return r=n({},a),s(r,t({selectedTimeSlot:e}));var r}))},getEndTime:(e,s)=>`${(parseInt(e.split(":")[0])+parseInt(s)).toString().padStart(2,"0")}:00`,getSlotStatus:e=>e.isWholeFacilityAvailable?{label:"施設貸し切り可能",color:"bg-orange-500 text-white hover:bg-orange-600",icon:P}:{label:"利用不可",color:"bg-red-500 text-white cursor-not-allowed",icon:$},getSelectedDogNames:Q,calculateDayPassPrice:z,calculateTotalPrice:K,hasSubscription:l,handleSubmit:s=>c(null,null,(function*(){if(s.preventDefault(),r&&I){v(!0),S("");try{if("facility_rental"===M.paymentType&&!M.selectedTimeSlot)return S("施設貸し切りの場合は時間を選択してください。"),void v(!1);if(0===E.length)return S("ワンちゃんを1頭以上選択してください。"),void v(!1);if("facility_rental"===M.paymentType){const e=F.find((e=>e.time===M.selectedTimeSlot));if(!e||!e.isWholeFacilityAvailable)return S("選択された時間は施設貸し切りできません。他の予約が入っています。"),void v(!1);const s=new Date(M.date),t=new Date;t.setHours(0,0,0,0);const a=new Date(t);if(a.setDate(t.getDate()+2),s<a)return S("施設貸し切りは2日前までの予約が必要です。"),void v(!1)}const s={parkId:e,parkName:I.name,selectedDogs:E,dogNames:Q(),date:M.date,selectedTimeSlot:M.selectedTimeSlot,duration:parseInt(M.duration),paymentType:M.paymentType,totalPrice:K(),reservationType:"facility_rental"===M.paymentType?"whole_facility":"regular"},t=`DP${Date.now()}${Math.floor(1e3*Math.random())}`;if("single"===M.paymentType){const a=y.find((e=>"payment"===e.mode));return a?void(yield i({priceId:a.priceId,mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&type=day_pass&order_number=${t}`,cancelUrl:`${window.location.origin}/parks/${e}/reserve?canceled=true`,customParams:{reservation_data:JSON.stringify(s),order_number:t}})):(S("1日券商品が見つかりません。"),void v(!1))}if("subscription"===M.paymentType&&!l){const s=y.find((e=>"subscription"===e.mode));return s?void(yield i({priceId:s.priceId,mode:"subscription",successUrl:`${window.location.origin}/payment-confirmation?success=true&type=subscription`,cancelUrl:`${window.location.origin}/parks/${e}/reserve?canceled=true`})):(S("サブスクリプション商品が見つかりません。"),void v(!1))}if("subscription"===M.paymentType&&l)return void a("/access-control");if("facility_rental"===M.paymentType)return void(yield i({priceId:"price_placeholder",mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&order_number=${t}`,cancelUrl:`${window.location.origin}/parks/${e}/reserve`,customAmount:X(),customName:`${I.name} 施設貸し切り ${M.date} ${M.selectedTimeSlot}〜${parseInt(M.selectedTimeSlot)+parseInt(M.duration)}:00`,customParams:{reservation_data:JSON.stringify(s),order_number:t}}));a("/checkout",{state:{reservationData:s}})}catch(t){S(`予約データの準備に失敗しました: ${t.message}`)}finally{v(!1)}}})),isLoading:N,checkoutLoading:f,MAX_DOGS:3})}),d.jsx(A,{hasSubscription:l})]})]}):d.jsx("div",{className:"flex justify-center items-center h-64",children:d.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})}export{L as ParkReservation};
