var e=(e,s,a)=>new Promise((t,r)=>{var l=e=>{try{c(a.next(e))}catch(s){r(s)}},i=e=>{try{c(a.throw(e))}catch(s){r(s)}},c=e=>e.done?t(e.value):Promise.resolve(e.value).then(l,i);c((a=a.apply(e,s)).next())});import{u as s,j as a,C as t,B as r}from"./index.Drgpoyph.js";import{c as l}from"./supabase.X3H3st79.js";import{r as i}from"./vendor.CKEClKZl.js";import{I as c}from"./Input.CUuxlVXM.js";import{S as n}from"./Select.CxVKDZ1_.js";import{u as d}from"./router.B_7Atevv.js";import{A as m,t as x,F as o,n as h,_ as j,aM as g,aN as p,c as u,i as b,b as f,s as N,r as y,Q as v,aC as w,X as _}from"./ui.C72fRZ1L.js";const k=l("",""),C={pet_hotel:"ペットホテル",pet_salon:"ペットサロン",veterinary:"動物病院",pet_cafe:"ペットカフェ",pet_restaurant:"ペット同伴レストラン",pet_shop:"ペットショップ",pet_accommodation:"ペット同伴宿泊"};function S(){const{user:l,isAdmin:S}=s(),E=d(),[$,L]=i.useState("applications"),[q,z]=i.useState([]),[A,F]=i.useState([]),[D,I]=i.useState([]),[P,T]=i.useState([]),[U,B]=i.useState(!0),[J,M]=i.useState(""),[O,Q]=i.useState(""),[G,H]=i.useState(null),[K,R]=i.useState(null),[V,W]=i.useState(null),[X,Y]=i.useState(""),[Z,ee]=i.useState("all"),[se,ae]=i.useState("created_at"),[te,re]=i.useState("desc");i.useEffect(()=>{S?ce():E("/")},[S,E,l]);const le=e=>{Q(e),M(""),setTimeout(()=>Q(""),5e3)},ie=e=>{M(e),Q(""),setTimeout(()=>M(""),8e3)},ce=()=>e(this,null,function*(){try{B(!0),M("");const{data:e,error:s}=yield k.from("pet_facilities").select("*").eq("status","pending").order("created_at",{ascending:!1});if(s)throw s;const{data:a,error:t}=yield k.from("pet_facilities").select("*").eq("status","approved").order("created_at",{ascending:!1});if(t)throw t;const r=e=>e&&Array.isArray(e)?e.map(e=>({id:e.id,name:e.name,category_id:e.category_id,address:e.address,phone:e.phone,website:e.website,description:e.description,status:e.status,created_at:e.created_at,owner_id:e.owner_id,owner_name:"取得中...",owner_email:"取得中...",category_name:C[e.category_id]||e.category_id})):[],l=r(e||[]),i=r(a||[]);z(l),F(i),I(l),T(i)}catch(e){const s=e instanceof Error?e.message:"申請データの取得に失敗しました";ie(s)}finally{B(!1)}}),ne=(s,a)=>e(this,null,function*(){try{R(s),M("");const{error:e}=yield k.from("pet_facilities").update({status:a?"approved":"rejected",updated_at:(new Date).toISOString()}).eq("id",s);if(e)throw e;le(`施設申請を${a?"承認":"拒否"}しました`),H(null),yield ce()}catch(e){ie(e instanceof Error?e.message:"申請の処理に失敗しました")}finally{R(null)}}),de=(s,a)=>e(this,null,function*(){if(window.confirm(`「${a}」を完全に削除してもよろしいですか？\n\nこの操作は取り消せません。関連する以下のデータも削除されます：\n• 施設画像\n• 関連通知\n• その他の関連データ`))try{W(s),M(""),Q("");const{data:t,error:r}=yield k.from("pet_facilities").select("id, name, owner_id").eq("id",s).single();if(r)throw new Error(`施設の確認に失敗しました: ${r.message}`);if(!t)throw new Error("指定された施設が見つかりません");try{const{error:e}=yield k.from("facility_images").delete().eq("facility_id",s);e&&e.code}catch(e){}const{data:l,error:i}=yield k.from("pet_facilities").delete().eq("id",s).select();if(i)throw new Error(`施設の削除に失敗しました: ${i.message}`);if(!l||0===l.length){const{data:e,error:a}=yield k.from("pet_facilities").select("id").eq("id",s);if(a)throw new Error(`削除の確認に失敗しました: ${a.message}`);if(e&&e.length>0)throw new Error("削除に失敗しました。施設がまだ存在しています。")}le(`施設「${a}」を削除しました`),H(null),yield ce()}catch(e){const s=e instanceof Error?e.message:"施設の削除に失敗しました";ie(`削除エラー: ${s}`)}finally{W(null)}});i.useEffect(()=>{ee("all")},[$]);const me=i.useCallback(e=>{let s=e.filter(e=>{var s,a;const t=!X||e.name.toLowerCase().includes(X.toLowerCase())||e.address.toLowerCase().includes(X.toLowerCase())||(null==(s=e.owner_name)?void 0:s.toLowerCase().includes(X.toLowerCase()))||(null==(a=e.category_name)?void 0:a.toLowerCase().includes(X.toLowerCase())),r="all"===Z||e.status===Z;return t&&r});return s=s.sort((e,s)=>{let a,t;switch(se){case"name":a=e.name,t=s.name;break;case"category_id":a=e.category_name||"",t=s.category_name||"";break;default:a=e.created_at,t=s.created_at}return"asc"===te?a>t?1:-1:a<t?1:-1}),s},[X,Z,se,te]);i.useEffect(()=>{"applications"===$?I(me(q)):T(me(A))},[X,Z,se,te,q,A,$]);const xe=e=>new Date(e).toLocaleDateString("ja-JP",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),oe=e=>{switch(e){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},he=e=>{switch(e){case"pending":return"承認待ち";case"approved":return"承認済み";case"rejected":return"却下";default:return"不明"}};return S?U?a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:"申請データを読み込み中..."})]})}):a.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:a.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[J&&a.jsx("div",{className:"mb-6 px-6 py-4 bg-red-50 border-l-4 border-red-400 rounded-lg",children:a.jsxs("div",{className:"flex",children:[a.jsx(m,{className:"h-5 w-5 text-red-400 mr-2"}),a.jsx("p",{className:"text-sm text-red-700",children:J})]})}),O&&a.jsx("div",{className:"mb-6 px-6 py-4 bg-green-50 border-l-4 border-green-400 rounded-lg",children:a.jsxs("div",{className:"flex",children:[a.jsx(x,{className:"h-5 w-5 text-green-400 mr-2"}),a.jsx("p",{className:"text-sm text-green-700",children:O})]})}),a.jsx("div",{className:"bg-white shadow rounded-lg mb-8",children:a.jsx("div",{className:"px-6",children:a.jsxs("nav",{className:"flex space-x-8","aria-label":"Tabs",children:[a.jsxs("button",{onClick:()=>L("applications"),className:"whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm "+("applications"===$?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[a.jsx(o,{className:"w-5 h-5 inline mr-2"}),"施設申請",a.jsx("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:q.length})]}),a.jsxs("button",{onClick:()=>L("facilities"),className:"whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm "+("facilities"===$?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[a.jsx(h,{className:"w-5 h-5 inline mr-2"}),"施設一覧",a.jsx("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:A.length})]})]})})}),a.jsxs("div",{className:"space-y-6",children:[a.jsx(t,{className:"p-6",children:a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"relative",children:[a.jsx(j,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),a.jsx(c,{label:"",placeholder:"施設名、住所、オーナー名で検索...",value:X,onChange:e=>Y(e.target.value),className:"pl-10"})]}),a.jsx(n,{label:"",options:[{value:"all",label:"全ステータス"},..."applications"===$?[{value:"pending",label:"承認待ち"}]:[{value:"approved",label:"承認済み"}]],value:Z,onChange:e=>ee(e.target.value)}),a.jsx(n,{label:"",options:[{value:"created_at",label:"作成日時"},{value:"name",label:"施設名"},{value:"category_id",label:"カテゴリ"}],value:se,onChange:e=>ae(e.target.value)}),a.jsxs(r,{variant:"secondary",onClick:()=>re("asc"===te?"desc":"asc"),className:"flex items-center justify-center",children:["asc"===te?a.jsx(g,{className:"w-4 h-4 mr-2"}):a.jsx(p,{className:"w-4 h-4 mr-2"}),"asc"===te?"昇順":"降順"]})]})}),"applications"===$&&a.jsx(a.Fragment,{children:0===D.length?a.jsxs(t,{className:"text-center py-12",children:[a.jsx(o,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:X||"all"!==Z?"条件に一致する申請が見つかりません":"承認待ちの申請がありません"})]}):a.jsx("div",{className:"grid grid-cols-1 gap-6",children:D.map(e=>a.jsx(t,{className:"p-6",children:a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:e.name}),a.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${oe(e.status)}`,children:he(e.status)})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-4",children:[a.jsxs("div",{children:[a.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"申請者情報"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(u,{className:"w-4 h-4 mr-2"}),e.owner_name]}),a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(b,{className:"w-4 h-4 mr-2"}),"申請日: ",xe(e.created_at)]})]})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"施設情報"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(h,{className:"w-4 h-4 mr-2"}),e.category_name]}),a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(f,{className:"w-4 h-4 mr-2"}),e.address]}),e.phone&&a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(N,{className:"w-4 h-4 mr-2"}),e.phone]})]})]})]}),e.description&&a.jsxs("div",{className:"mb-4",children:[a.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"施設説明"}),a.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.description})]})]}),a.jsxs("div",{className:"flex flex-col space-y-2 ml-4",children:[a.jsxs(r,{size:"sm",variant:"secondary",onClick:()=>H(e),className:"flex items-center",children:[a.jsx(y,{className:"w-4 h-4 mr-2"}),"詳細確認"]}),a.jsxs(r,{size:"sm",variant:"secondary",onClick:()=>de(e.id,e.name),disabled:V===e.id,className:"flex items-center bg-red-100 hover:bg-red-200 text-red-800 border-red-200",children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),V===e.id?"削除中...":"削除"]})]})]})},e.id))})}),"facilities"===$&&a.jsx(a.Fragment,{children:0===P.length?a.jsxs(t,{className:"text-center py-12",children:[a.jsx(h,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:X||"all"!==Z?"条件に一致する施設が見つかりません":"承認済みの施設がありません"})]}):a.jsx("div",{className:"grid grid-cols-1 gap-6",children:P.map(e=>a.jsx(t,{className:"p-6",children:a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:e.name}),a.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${oe(e.status)}`,children:he(e.status)})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center text-sm text-gray-600 mb-1",children:[a.jsx(h,{className:"w-4 h-4 mr-1"}),e.category_name]}),a.jsxs("div",{className:"flex items-center text-sm text-gray-600 mb-1",children:[a.jsx(f,{className:"w-4 h-4 mr-1"}),e.address]}),e.phone&&a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(N,{className:"w-4 h-4 mr-1"}),e.phone]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center text-sm text-gray-600 mb-1",children:[a.jsx(u,{className:"w-4 h-4 mr-1"}),e.owner_name]}),a.jsxs("div",{className:"flex items-center text-sm text-gray-600 mb-1",children:[a.jsx(b,{className:"w-4 h-4 mr-1"}),xe(e.created_at)]}),e.website&&a.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[a.jsx(w,{className:"w-4 h-4 mr-1"}),a.jsx("a",{href:e.website,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline",children:"ウェブサイト"})]})]})]}),e.description&&a.jsx("div",{className:"mb-4",children:a.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.description})})]}),a.jsxs("div",{className:"flex flex-col space-y-2 ml-4",children:[a.jsxs(r,{size:"sm",variant:"secondary",onClick:()=>H(e),className:"flex items-center",children:[a.jsx(y,{className:"w-4 h-4 mr-2"}),"詳細確認"]}),a.jsxs(r,{size:"sm",variant:"secondary",onClick:()=>de(e.id,e.name),disabled:V===e.id,className:"flex items-center bg-red-100 hover:bg-red-200 text-red-800 border-red-200",children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),V===e.id?"削除中...":"削除"]})]})]})},e.id))})})]}),G&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-lg max-w-4xl max-h-[90vh] w-full overflow-y-auto",children:[a.jsxs("div",{className:"sticky top-0 bg-white border-b p-6 flex justify-between items-center",children:[a.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:G.name}),a.jsx("button",{onClick:()=>H(null),className:"p-2 hover:bg-gray-100 rounded-full",children:a.jsx(_,{className:"w-6 h-6 text-gray-500"})})]}),a.jsxs("div",{className:"p-6 space-y-6",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold mb-4",children:"基本情報"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"施設名"}),a.jsx("p",{className:"text-gray-900",children:G.name})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"カテゴリ"}),a.jsx("p",{className:"text-gray-900",children:G.category_name})]}),a.jsxs("div",{className:"md:col-span-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"住所"}),a.jsx("p",{className:"text-gray-900",children:G.address})]}),G.phone&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"電話番号"}),a.jsx("p",{className:"text-gray-900",children:G.phone})]}),G.website&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ウェブサイト"}),a.jsx("a",{href:G.website,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline",children:G.website})]})]}),G.description&&a.jsxs("div",{className:"mt-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"施設の説明"}),a.jsx("p",{className:"text-gray-900 whitespace-pre-wrap",children:G.description})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold mb-4",children:"申請者情報"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"申請者名"}),a.jsx("p",{className:"text-gray-900",children:G.owner_name||"Unknown"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"メールアドレス"}),a.jsx("p",{className:"text-gray-900",children:G.owner_email||"Unknown"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"申請日時"}),a.jsx("p",{className:"text-gray-900",children:xe(G.created_at)})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ステータス"}),a.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${oe(G.status)}`,children:he(G.status)})]})]})]}),a.jsxs("div",{className:"flex space-x-4 pt-6 border-t",children:[a.jsxs(r,{onClick:()=>de(G.id,G.name),disabled:V===G.id,variant:"secondary",className:"bg-red-100 hover:bg-red-200 text-red-800 border-red-200",children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),V===G.id?"削除中...":"削除"]}),"pending"===G.status&&a.jsxs(a.Fragment,{children:[a.jsxs(r,{onClick:()=>ne(G.id,!1),disabled:K===G.id,variant:"secondary",className:"bg-orange-100 hover:bg-orange-200 text-orange-800 border-orange-200",children:[a.jsx(_,{className:"w-4 h-4 mr-2"}),K===G.id?"処理中...":"拒否"]}),a.jsxs(r,{onClick:()=>ne(G.id,!0),disabled:K===G.id,className:"bg-green-600 hover:bg-green-700",children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),K===G.id?"処理中...":"承認"]})]})]})]})]})})]})}):a.jsx("div",{className:"max-w-4xl mx-auto p-4",children:a.jsx(t,{className:"p-6",children:a.jsxs("div",{className:"flex items-center justify-center",children:[a.jsx(m,{className:"w-12 h-12 text-red-500 mr-4"}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-semibold text-red-700",children:"アクセス権限がありません"}),a.jsx("p",{className:"text-red-600",children:"このページは管理者のみアクセス可能です。"})]})]})})})}export{S as default,k as supabase};
