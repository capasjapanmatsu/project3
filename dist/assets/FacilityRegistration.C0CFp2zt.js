var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,i=(s,a,l)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[a]=l,n=(e,s)=>{for(var a in s||(s={}))r.call(s,a)&&i(e,a,s[a]);if(l)for(var a of l(s))t.call(s,a)&&i(e,a,s[a]);return e},d=(e,l)=>s(e,a(l)),c=(e,s,a)=>new Promise((l,r)=>{var t=e=>{try{n(a.next(e))}catch(s){r(s)}},i=e=>{try{n(a.throw(e))}catch(s){r(s)}},n=e=>e.done?l(e.value):Promise.resolve(e.value).then(t,i);n((a=a.apply(e,s)).next())});import{u as m,j as o,C as x,B as h,s as g}from"./index.Drgpoyph.js";import{r as b}from"./vendor.CKEClKZl.js";import{I as u}from"./Input.CUuxlVXM.js";import{u as j}from"./router.B_7Atevv.js";import{k as p,g as f,n as y,ak as N,X as v}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";const w=[{id:"pet_hotel",name:"ペットホテル",monthly_fee:5e3,is_free:!0},{id:"pet_salon",name:"ペットサロン",monthly_fee:3e3,is_free:!0},{id:"veterinary",name:"動物病院",monthly_fee:8e3,is_free:!0},{id:"pet_cafe",name:"ペットカフェ",monthly_fee:4e3,is_free:!0},{id:"pet_restaurant",name:"ペット同伴レストラン",monthly_fee:6e3,is_free:!0},{id:"pet_shop",name:"ペットショップ",monthly_fee:7e3,is_free:!0},{id:"pet_accommodation",name:"ペット同伴宿泊",monthly_fee:1e4,is_free:!0}];function _(){const{user:e,isAuthenticated:s,userProfile:a}=m(),l=j(),[r,t]=b.useState(!1),[i,_]=b.useState(""),[E,k]=b.useState(""),[C,S]=b.useState([]),[O,P]=b.useState([]),[I,q]=b.useState({name:(null==a?void 0:a.name)||"",address:(null==a?void 0:a.address)||"",isEditing:!1}),[D,B]=b.useState({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:[]});b.useEffect(()=>{s||l("/login")},[s,l]),b.useEffect(()=>{a&&q({name:a.name||"",address:a.address||"",isEditing:!1})},[a]);const F=e=>{const{name:s,value:a}=e.target;B(e=>d(n({},e),{[s]:a}))},G=e=>c(this,null,function*(){const s=Array.from(e.target.files||[]);if(0!==s.length)if(C.length+s.length>5)_("画像は最大5枚までアップロードできます");else{t(!0),_("");try{if(s.filter(e=>e.size>10485760).length>0)return _("画像ファイルのサイズは10MB以下にしてください"),void t(!1);const e=yield Promise.all(s.map(e=>(e=>new Promise((s,a)=>{const l=document.createElement("canvas"),r=l.getContext("2d"),t=document.createElement("img");t.onload=()=>{let e=t.naturalWidth,a=t.naturalHeight;e>a?e>800&&(a=800*a/e,e=800):a>600&&(e=600*e/a,a=600),l.width=e,l.height=a,null==r||r.drawImage(t,0,0,e,a);const i=l.toDataURL("image/jpeg",.8);s(i)},t.onerror=a,t.src=URL.createObjectURL(e)}))(e))),a=s.slice(0,5-C.length);S(e=>[...e,...a]),P(s=>[...s,...e]),B(s=>d(n({},s),{images:[...s.images,...e]}))}catch(a){_(a instanceof Error?a.message:"画像の処理に失敗しました")}finally{t(!1)}}}),L=()=>c(this,null,function*(){if(e)if(D.name&&D.category_id&&D.address){t(!0),_("");try{const s={owner_id:e.id,name:D.name,category_id:D.category_id,address:D.address,phone:D.phone,website:D.website,description:D.description,status:"pending",created_at:(new Date).toISOString()};0;const a=yield g.from("pet_facilities").insert(s).select().single(),{data:r,error:t}=a;if(t)throw t;if(D.images.length>0&&r&&"object"==typeof r&&"id"in r){const e=D.images.map((e,s)=>({facility_id:r.id,image_data:e,image_type:"image/jpeg",display_order:s,created_at:(new Date).toISOString()})),{error:s}=yield g.from("facility_images").insert(e)}k("施設の掲載申請が完了しました！管理者の承認後、地図に掲載されます。"),setTimeout(()=>{l("/dashboard")},2e3)}catch(s){const e=s instanceof Error?s.message:"申請に失敗しました";_(e),s instanceof Error&&s.message.includes("アップロード")}finally{t(!1)}}else _("必須項目を入力してください");else _("ログインが必要です")}),R=e=>{const{name:s,value:a}=e.target;q(e=>d(n({},e),{[s]:a}))},U=()=>c(this,null,function*(){if(e)try{t(!0);const{error:s}=yield g.from("profiles").update({name:I.name,address:I.address,updated_at:(new Date).toISOString()}).eq("id",e.id);if(s)throw new Error("ユーザー情報の更新に失敗しました");q(e=>d(n({},e),{isEditing:!1})),k("ユーザー情報を更新しました"),setTimeout(()=>k(""),3e3)}catch(s){_(s instanceof Error?s.message:"ユーザー情報の更新に失敗しました")}finally{t(!1)}}),A=()=>{U()},M=()=>{q({name:(null==a?void 0:a.name)||"",address:(null==a?void 0:a.address)||"",isEditing:!1})};return s?o.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[o.jsxs("div",{className:"mb-8",children:[o.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ペット関連施設登録"}),o.jsx("p",{className:"text-gray-600",children:"ペット関連施設の掲載申請を行います。管理者の承認後、地図に表示されます。"})]}),i&&o.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:o.jsxs("div",{className:"flex items-center",children:[o.jsx(p,{className:"w-5 h-5 text-red-500 mr-2"}),o.jsx("span",{className:"text-red-700",children:i})]})}),E&&o.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:o.jsxs("div",{className:"flex items-center",children:[o.jsx(f,{className:"w-5 h-5 text-green-500 mr-2"}),o.jsx("span",{className:"text-green-700",children:E})]})}),o.jsxs("form",{onSubmit:e=>{e.preventDefault(),L()},className:"space-y-6",children:[o.jsx(x,{children:o.jsxs("div",{className:"p-6",children:[o.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[o.jsx(y,{className:"w-6 h-6 mr-2"}),"基本情報"]}),o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{children:[o.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設名 ",o.jsx("span",{className:"text-red-500",children:"*"})]}),o.jsx(u,{label:"施設名",name:"name",value:D.name,onChange:F,placeholder:"施設名を入力してください",required:!0})]}),o.jsxs("div",{children:[o.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設カテゴリ ",o.jsx("span",{className:"text-red-500",children:"*"})]}),o.jsxs("select",{name:"category_id",value:D.category_id,onChange:F,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[o.jsx("option",{value:"",children:"カテゴリを選択してください"}),w.map(e=>o.jsx("option",{value:e.id,children:e.name},e.id))]})]}),o.jsxs("div",{children:[o.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["住所 ",o.jsx("span",{className:"text-red-500",children:"*"})]}),o.jsx(u,{label:"住所",name:"address",value:D.address,onChange:F,placeholder:"住所を入力してください",required:!0})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),o.jsx(u,{label:"電話番号",name:"phone",value:D.phone,onChange:F,placeholder:"電話番号を入力してください"})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),o.jsx(u,{label:"ウェブサイト",name:"website",value:D.website,onChange:F,placeholder:"https://example.com"})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設の説明"}),o.jsx("textarea",{name:"description",value:D.description,onChange:F,rows:4,placeholder:"施設の特徴やサービス内容を入力してください",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})]})}),o.jsx(x,{children:o.jsxs("div",{className:"p-6",children:[o.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[o.jsx(y,{className:"w-6 h-6 mr-2"}),"ユーザー情報"]}),o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"名前"}),I.isEditing?o.jsx(u,{label:"名前",name:"name",value:I.name,onChange:R,placeholder:"名前を入力してください"}):o.jsx("p",{className:"text-gray-900",children:I.name})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),I.isEditing?o.jsx(u,{label:"住所",name:"address",value:I.address,onChange:R,placeholder:"住所を入力してください"}):o.jsx("p",{className:"text-gray-900",children:I.address})]})]}),o.jsx("div",{className:"flex justify-end mt-4",children:I.isEditing?o.jsxs(o.Fragment,{children:[o.jsx(h,{onClick:A,className:"mr-2",disabled:r,children:r?"保存中...":"保存"}),o.jsx(h,{onClick:M,disabled:r,children:"キャンセル"})]}):o.jsx(h,{onClick:()=>q(e=>d(n({},e),{isEditing:!0})),children:"編集"})})]})}),o.jsx(x,{children:o.jsxs("div",{className:"p-6",children:[o.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[o.jsx(f,{className:"w-6 h-6 mr-2"}),"登録者情報の確認"]}),o.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:o.jsxs("div",{className:"flex items-start",children:[o.jsx(p,{className:"w-5 h-5 text-blue-500 mr-2 mt-0.5"}),o.jsxs("div",{className:"text-sm text-blue-800",children:[o.jsx("p",{className:"font-medium mb-1",children:"登録者情報の確認"}),o.jsx("p",{className:"text-xs",children:"以下の情報をご確認ください。変更が必要な場合は編集できます。"})]})]})}),o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"氏名"}),I.isEditing?o.jsx(u,{label:"氏名",name:"name",value:I.name,onChange:R,placeholder:"氏名を入力してください",required:!0}):o.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:o.jsx("p",{className:"text-gray-900",children:I.name||"未設定"})})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),I.isEditing?o.jsx(u,{label:"住所",name:"address",value:I.address,onChange:R,placeholder:"住所を入力してください",required:!0}):o.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:o.jsx("p",{className:"text-gray-900",children:I.address||"未設定"})})]}),o.jsx("div",{className:"flex gap-2",children:I.isEditing?o.jsxs(o.Fragment,{children:[o.jsx(h,{type:"button",onClick:A,disabled:r,children:r?"保存中...":"保存"}),o.jsx(h,{type:"button",onClick:M,children:"キャンセル"})]}):o.jsx(h,{type:"button",onClick:()=>q(e=>d(n({},e),{isEditing:!0})),children:"編集"})})]})]})}),o.jsx(x,{className:"mb-6",children:o.jsxs("div",{className:"p-6",children:[o.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[o.jsx(N,{className:"w-6 h-6 mr-2"}),"施設画像 (最大5枚)"]}),o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"画像をアップロード"}),o.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{G(e)},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:r||C.length>=5}),o.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"JPG, PNG, GIF対応。1ファイル10MB以下。画像は自動的にリサイズ・圧縮されます。"})]}),O.length>0&&o.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:O.map((e,s)=>o.jsxs("div",{className:"relative",children:[o.jsx("img",{src:e,alt:`施設画像 ${s+1}`,className:"w-full h-32 object-cover rounded-lg border border-gray-200"}),o.jsx("button",{type:"button",onClick:()=>(e=>{S(s=>s.filter((s,a)=>a!==e)),P(s=>s.filter((s,a)=>a!==e)),B(s=>d(n({},s),{images:s.images.filter((s,a)=>a!==e)}))})(s),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:o.jsx(v,{className:"w-4 h-4"})}),0===s&&o.jsx("div",{className:"absolute bottom-1 left-1 bg-blue-500 text-white text-xs px-2 py-1 rounded",children:"メイン"})]},s))})]})}),o.jsx(x,{className:"mb-6",children:o.jsx("div",{className:"p-6",children:o.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[o.jsxs("div",{className:"flex items-center mb-2",children:[o.jsx(f,{className:"w-5 h-5 text-green-500 mr-2"}),o.jsx("span",{className:"font-medium text-green-800",children:"無料掲載期間実施中！"})]}),o.jsxs("p",{className:"text-green-700 mb-2",children:["現在、すべてのペット関連施設が",o.jsx("strong",{className:"text-lg",children:"無料"}),"で掲載できます。"]}),o.jsxs("ul",{className:"text-sm text-green-600 space-y-1",children:[o.jsx("li",{children:"• 本人確認手続きは不要です"}),o.jsx("li",{children:"• 月額料金は発生しません"}),o.jsx("li",{children:"• 申請後、管理者の承認を経て掲載開始となります"}),o.jsx("li",{children:"• 将来的に有料化する場合は事前にお知らせいたします"})]})]})})}),o.jsx("div",{className:"flex justify-end",children:o.jsx(h,{type:"submit",disabled:r,children:r?"申請中...":"申請を送信する"})})]})]}):null}export{_ as default};
