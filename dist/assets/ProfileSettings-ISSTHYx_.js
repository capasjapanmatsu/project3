import{u as oe,s as c,j as e,B as i,C as O}from"./index-BB1ywuBb.js";import{u as ce,r as l,L as g}from"./react-vendor-Co5xHYdE.js";import{I as m}from"./Input-Bmh34ZUQ.js";import{l as de,f as me}from"./postalCodeLookup-Dgm8Gdim.js";import{_ as xe,c as y,$ as he,a0 as ue,a1 as fe,q as ge,A as p,i as G,M as pe,H as K,b as je,e as we,G as be,a2 as Ne,y as ve,K as ye,a3 as Pe,a as Ce,X as V}from"./ui-vendor-B2-VOB5s.js";import"./supabase-vendor-FDBaXLCh.js";function qe(){const{user:o}=oe(),P=ce(),[W,q]=l.useState(!0),[X,I]=l.useState(!1),[z,C]=l.useState(""),[A,S]=l.useState(""),[a,d]=l.useState({name:"",nickname:"",postal_code:"",address:"",phone_number:"",email:""}),[M,U]=l.useState({name:"",nickname:"",postal_code:"",address:"",phone_number:"",email:""}),[J,j]=l.useState(!1),[Q,E]=l.useState(!1),[n,h]=l.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[_,k]=l.useState(""),[Y,T]=l.useState(!1),[Z,R]=l.useState(!1),[$,w]=l.useState(""),[B,f]=l.useState(""),[F,b]=l.useState(""),[ee,H]=l.useState(!1),[D,L]=l.useState("");l.useEffect(()=>{o?se():P("/login")},[o,P]);const se=async()=>{try{q(!0);const{data:s,error:r}=await c.from("profiles").select("*").eq("id",o?.id).single();if(r)throw r;const t={name:s.name||"",nickname:s.nickname||"",postal_code:s.postal_code||"",address:s.address||"",phone_number:s.phone_number||"",email:o?.email||""};d(t),U(t)}catch(s){console.error("Error fetching profile:",s),C(s.message||"プロフィールの取得に失敗しました。")}finally{q(!1)}},re=s=>{const r=s.replace(/\D/g,"");return r.length<=7?r.length>3?r.slice(0,3)+"-"+r.slice(3):r:a.postal_code},ae=async s=>{const r=re(s);if(d({...a,postal_code:r}),r.replace(/-/g,"").length===7){H(!0),L("");try{const t=await de(r);if(t.success&&t.results&&t.results.length>0&&t.results[0]){const N=me(t.results[0]);d(v=>({...v,address:N}))}else L(t.message||"住所が見つかりませんでした")}catch(t){console.error("Error looking up postal code:",t),L("住所の検索中にエラーが発生しました")}finally{H(!1)}}},te=s=>{const r=s.replace(/\D/g,"");return r.length<=11?r.length>7?r.slice(0,3)+"-"+r.slice(3,7)+"-"+r.slice(7):r.length>3?r.slice(0,3)+"-"+r.slice(3):r:a.phone_number},le=async s=>{s.preventDefault(),I(!0),C(""),S("");try{if(!a.name.trim())throw new Error("お名前を入力してください");if(a.postal_code&&!a.postal_code.match(/^\d{3}-\d{4}$/))throw new Error("郵便番号は正しい形式で入力してください（例：123-4567）");if(a.phone_number&&!a.phone_number.match(/^0\d{2,3}-\d{1,4}-\d{4}$/))throw new Error("電話番号は正しい形式で入力してください（例：090-1234-5678）");const r=M.postal_code!==a.postal_code||M.address!==a.address;let t=!1;if(r){const{data:x,error:u}=await c.from("owner_verifications").select("id, status").eq("user_id",o?.id).eq("status","verified").single();u&&u.code!=="PGRST116"&&console.error("Error checking owner verification:",u),x&&(t=!0)}const{error:N}=await c.from("profiles").update({name:a.name,nickname:a.nickname,postal_code:a.postal_code,address:a.address,phone_number:a.phone_number}).eq("id",o?.id);if(N)throw N;if(t){const{error:x}=await c.from("owner_verifications").update({status:"pending",updated_at:new Date().toISOString()}).eq("user_id",o?.id);x&&console.error("Error resetting identity verification:",x);const{error:u}=await c.from("notifications").insert([{user_id:o?.id,type:"identity_verification",title:"住所変更により本人確認が必要です",message:"住所を変更されたため、本人確認書類を再度提出する必要があります。ドッグラン施設の登録を継続される場合は、本人確認書類をアップロードしてください。",data:{reason:"address_change"}}]);u&&console.error("Error creating notification:",u)}if(o?.email!==a.email){const{error:x}=await c.auth.updateUser({email:a.email});if(x)throw x}U(a);let v="プロフィールを更新しました";t&&(v+=`

住所変更により本人確認が必要になりました。ドッグラン施設の登録を継続される場合は、本人確認書類を再度アップロードしてください。`),S(v),setTimeout(()=>{S("")},3e3)}catch(r){console.error("Error updating profile:",r),C(r.message||"プロフィールの更新に失敗しました")}finally{I(!1)}},ne=async s=>{s.preventDefault(),T(!0),w(""),f("");try{if(!n.currentPassword)throw new Error("現在のパスワードを入力してください");if(!n.newPassword)throw new Error("新しいパスワードを入力してください");if(n.newPassword.length<6)throw new Error("パスワードは6文字以上で入力してください");if(n.newPassword!==n.confirmPassword)throw new Error("新しいパスワードと確認用パスワードが一致しません");const{error:r}=await c.auth.signInWithPassword({email:o?.email||"",password:n.currentPassword});if(r)throw new Error("現在のパスワードが正しくありません");const{error:t}=await c.auth.updateUser({password:n.newPassword});if(t)throw t;f("パスワードを変更しました"),h({currentPassword:"",newPassword:"",confirmPassword:""}),setTimeout(()=>{j(!1),f("")},3e3)}catch(r){console.error("Error changing password:",r),w(r.message||"パスワードの変更に失敗しました")}finally{T(!1)}},ie=async s=>{s.preventDefault(),R(!0),b("");try{if(_!=="delete")throw new Error("確認のため「delete」と入力してください");const{error:r}=await c.auth.admin.deleteUser(o?.id||"");if(r)throw r;await c.auth.signOut(),P("/",{replace:!0})}catch(r){console.error("Error deleting account:",r),b(r.message||"アカウントの削除に失敗しました")}finally{R(!1)}};return W?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(g,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(y,{className:"w-8 h-8 text-blue-600 mr-3"}),"プロフィール設定"]}),e.jsx("p",{className:"text-lg text-gray-600",children:"アカウント情報を管理します"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[e.jsx(g,{to:"/payment-method-settings",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),e.jsx(g,{to:"/dogpark-history",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),e.jsx(g,{to:"/orders",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),e.jsx(g,{to:"/shop",children:e.jsxs(i,{variant:"secondary",size:"sm",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),e.jsx(O,{className:"p-6",children:e.jsxs("form",{onSubmit:le,children:[z&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(p,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:z})]}),A&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(G,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:A})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(y,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"基本情報"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(m,{label:"お名前 *",value:a.name,onChange:s=>d({...a,name:s.target.value}),required:!0,icon:e.jsx(y,{className:"w-4 h-4 text-gray-500"})}),e.jsx(m,{label:"ニックネーム",value:a.nickname,onChange:s=>d({...a,nickname:s.target.value}),placeholder:"表示名やニックネームを入力（任意）",icon:e.jsx(y,{className:"w-4 h-4 text-gray-500"})}),e.jsx(m,{label:"メールアドレス *",type:"email",value:a.email,onChange:s=>d({...a,email:s.target.value}),required:!0,icon:e.jsx(pe,{className:"w-4 h-4 text-gray-500"})})]}),e.jsxs("div",{className:"flex items-center space-x-3 mb-6 mt-8",children:[e.jsx(K,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"住所情報"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(je,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:a.postal_code,onChange:s=>ae(s.target.value),className:`w-full pl-10 pr-10 py-2 border ${D?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8}),ee&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(we,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),D&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:D})]}),e.jsx(m,{label:"電話番号",value:a.phone_number,onChange:s=>{const r=te(s.target.value);d({...a,phone_number:r})},placeholder:"090-1234-5678",maxLength:13,icon:e.jsx(be,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(m,{label:"住所",value:a.address,onChange:s=>d({...a,address:s.target.value}),placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(K,{className:"w-4 h-4 text-gray-500"})})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(i,{type:"submit",isLoading:X,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"保存する"]})})]})]})}),e.jsxs(O,{className:"p-6 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(ve,{className:"w-6 h-6 text-yellow-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"アカウント設定"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"パスワード変更"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを保つため、定期的にパスワードを変更することをおすすめします。"}),e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>j(!0),children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"パスワードを変更"]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"アカウント削除"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントを削除すると、すべてのデータが完全に削除され、復元できなくなります。"}),e.jsxs(i,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>E(!0),children:[e.jsx(Pe,{className:"w-4 h-4 mr-2"}),"アカウントを削除"]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2 text-gray-600",children:"2ファクタ認証（2FA）"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"2ファクタ認証機能は現在メンテナンス中です。しばらくお待ちください。"}),e.jsxs("div",{className:"flex items-center space-x-2 text-amber-600",children:[e.jsx(p,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"サービス準備中"})]}),e.jsxs(i,{variant:"secondary",size:"sm",disabled:!0,className:"mt-3 opacity-50 cursor-not-allowed",children:[e.jsx(Ce,{className:"w-4 h-4 mr-2"}),"2FAを有効化（準備中）"]})]})]})]}),J&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"パスワード変更"}),e.jsx("button",{onClick:()=>{j(!1),w(""),f(""),h({currentPassword:"",newPassword:"",confirmPassword:""})},className:"text-gray-500 hover:text-gray-700",children:e.jsx(V,{className:"w-6 h-6"})})]}),$&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(p,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:$})]})}),B&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(G,{className:"w-5 h-5 text-green-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-green-800",children:B})]})}),e.jsx("form",{onSubmit:ne,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{label:"現在のパスワード *",type:"password",value:n.currentPassword,onChange:s=>h({...n,currentPassword:s.target.value}),required:!0}),e.jsx(m,{label:"新しいパスワード *",type:"password",value:n.newPassword,onChange:s=>h({...n,newPassword:s.target.value}),required:!0,minLength:6}),e.jsx(m,{label:"新しいパスワード（確認） *",type:"password",value:n.confirmPassword,onChange:s=>h({...n,confirmPassword:s.target.value}),required:!0,minLength:6}),e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"パスワードの要件"}),e.jsx("br",{}),"• 6文字以上",e.jsx("br",{}),"• 英数字を含めることをおすすめします",e.jsx("br",{}),"• 以前使用したパスワードと異なるものを使用してください"]})}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(i,{type:"button",variant:"secondary",onClick:()=>{j(!1),w(""),f(""),h({currentPassword:"",newPassword:"",confirmPassword:""})},children:"キャンセル"}),e.jsx(i,{type:"submit",isLoading:Y,children:"パスワードを変更"})]})]})})]})}),Q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-red-600",children:"アカウント削除"}),e.jsx("button",{onClick:()=>{E(!1),b(""),k("")},className:"text-gray-500 hover:text-gray-700",children:e.jsx(V,{className:"w-6 h-6"})})]}),F&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(p,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:F})]})}),e.jsx("div",{className:"p-4 bg-red-50 rounded-lg mb-4",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(p,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 mb-1",children:"警告: この操作は取り消せません"}),e.jsx("p",{className:"text-sm text-red-700",children:"アカウントを削除すると、以下のデータがすべて完全に削除されます："}),e.jsxs("ul",{className:"text-sm text-red-700 list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"プロフィール情報"}),e.jsx("li",{children:"登録したワンちゃんの情報"}),e.jsx("li",{children:"予約履歴"}),e.jsx("li",{children:"支払い情報"}),e.jsx("li",{children:"友達リストとメッセージ"})]})]})]})}),e.jsx("form",{onSubmit:ie,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"確認のため「delete」と入力してください *"}),e.jsx("input",{type:"text",value:_,onChange:s=>k(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(i,{type:"button",variant:"secondary",onClick:()=>{E(!1),b(""),k("")},children:"キャンセル"}),e.jsx(i,{type:"submit",isLoading:Z,className:"bg-red-600 hover:bg-red-700",disabled:_!=="delete",children:"アカウントを削除"})]})]})})]})})]})}export{qe as ProfileSettings};
