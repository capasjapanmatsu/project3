import{u as e,s,j as t,C as a,B as r}from"./index-uQwv9uAE.js";import{u as n,r as i,L as c}from"./vendor-BHVjIt_u.js";import{I as l}from"./Input-Bg5E4HX5.js";import{I as d,b as o,i as x,s as m,y as p,a3 as h,ax as g,ap as u,o as j,Q as w,az as v,C as y}from"./ui-BLTQwnYp.js";import"./supabase-CKbzEL5D.js";function _(){const{isAdmin:_}=e(),f=n(),[N,b]=i.useState([]),[k,S]=i.useState([]),[L,C]=i.useState(!0),[$,D]=i.useState(""),[q,U]=i.useState(""),[I,E]=i.useState("all"),[F,O]=i.useState("created_at"),[z,P]=i.useState("desc");i.useEffect((()=>{_?R():f("/")}),[_,f]),i.useEffect((()=>{T()}),[N,q,I,F,z]);const R=async()=>{try{C(!0),D("");const{data:t,error:a}=await s.from("dog_parks").select("\n          id,\n          name,\n          address,\n          created_at,\n          status,\n          owner_id,\n          price,\n          max_capacity,\n          description,\n          facilities,\n          image_url,\n          cover_image_url\n        ");if(a)throw new Error("ドッグラン情報の取得に失敗しました");if(!t||0===t.length)return void b([]);let r=null;try{const{data:e,error:t}=await s.auth.admin.listUsers();t||(r=e)}catch(e){}const n=t.map((async e=>{try{const{data:t}=await s.from("profiles").select("name, user_type").eq("id",e.owner_id).single(),a=new Date;a.setDate(1),a.setHours(0,0,0,0);const{count:n}=await s.from("reservations").select("id",{count:"exact"}).eq("park_id",e.id).gte("created_at",a.toISOString()),{data:i}=await s.from("reservations").select("total_amount").eq("park_id",e.id).gte("created_at",a.toISOString()).not("total_amount","is",null),c=(i||[]).reduce(((e,s)=>e+(s.total_amount||0)),0),{data:l}=await s.from("reservations").select("total_amount").eq("park_id",e.id).not("total_amount","is",null),d=(l||[]).reduce(((e,s)=>e+(s.total_amount||0)),0),{data:o}=await s.from("dog_park_reviews").select("rating").eq("park_id",e.id),x=o?.length||0,m=x>0?(o||[]).reduce(((e,s)=>e+s.rating),0)/x:0,p=r?.users?.find((s=>s.id===e.owner_id)),h=p?.email;return{id:e.id,name:e.name,address:e.address,created_at:e.created_at,status:e.status,owner_name:t?.name||"Unknown",owner_email:h||`owner_${e.owner_id.slice(0,8)}@unknown.com`,price:e.price||0,max_capacity:e.max_capacity||0,average_rating:parseFloat(m.toFixed(1)),review_count:x,monthly_revenue:c,monthly_reservations:n||0,total_revenue:d,facilities:e.facilities||{parking:!1,shower:!1,restroom:!1,agility:!1,rest_area:!1,water_station:!1}}}catch(t){return{id:e.id,name:e.name||"Unknown Park",address:e.address||"Unknown Address",created_at:e.created_at,status:e.status||"pending",owner_name:"Unknown",owner_email:`owner_${e.owner_id.slice(0,8)}@unknown.com`,price:e.price||0,max_capacity:e.max_capacity||0,average_rating:0,review_count:0,monthly_revenue:0,monthly_reservations:0,total_revenue:0,facilities:{parking:!1,shower:!1,restroom:!1,agility:!1,rest_area:!1,water_station:!1}}}})),i=await Promise.all(n);b(i)}catch(t){D(`ドッグランデータの取得に失敗しました: ${t instanceof Error?t.message:"不明なエラー"}`)}finally{C(!1)}},T=()=>{let e=[...N];switch(q&&(e=e.filter((e=>e.name.toLowerCase().includes(q.toLowerCase())||e.address.toLowerCase().includes(q.toLowerCase())||e.owner_name.toLowerCase().includes(q.toLowerCase())))),I){case"pending":e=e.filter((e=>["pending","first_stage_passed","second_stage_review","qr_testing"].includes(e.status)));break;case"approved":e=e.filter((e=>"approved"===e.status));break;case"rejected":e=e.filter((e=>"rejected"===e.status))}e.sort(((e,s)=>{let t=e[F],a=s[F];return"created_at"===F&&(t=new Date(t).getTime(),a=new Date(a).getTime()),"asc"===z?t>a?1:-1:t<a?1:-1})),S(e)},A=e=>({pending:"第一審査待ち",first_stage_passed:"第二審査準備中",second_stage_review:"第二審査中",qr_testing:"QR実証検査中",approved:"承認済み",rejected:"却下"}[e]||e),B=e=>{const s={pending:{color:"bg-yellow-100 text-yellow-800",icon:y},first_stage_passed:{color:"bg-blue-100 text-blue-800",icon:y},second_stage_review:{color:"bg-purple-100 text-purple-800",icon:y},qr_testing:{color:"bg-orange-100 text-orange-800",icon:y},approved:{color:"bg-green-100 text-green-800",icon:m},rejected:{color:"bg-red-100 text-red-800",icon:v}},a=s[e]||s.pending,r=a.icon;return t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(r,{className:"w-4 h-4"}),t.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${a.color}`,children:A(e)})]})},J=e=>{const s={parking:"駐車場",shower:"シャワー",restroom:"トイレ",agility:"アジリティ",rest_area:"休憩所",water_station:"給水所"},t=Object.entries(e).filter((([e,s])=>s)).map((([e,t])=>s[e]));return t.slice(0,3).join(", ")+(t.length>3?" +"+(t.length-3):"")};if(L)return t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})});const Q=N.reduce(((e,s)=>e+s.monthly_revenue),0),V=N.length>0?N.reduce(((e,s)=>e+s.average_rating),0)/N.length:0;return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"flex items-center space-x-4 mb-6",children:t.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[t.jsx(o,{className:"w-8 h-8 text-green-600 mr-3"}),"ドッグラン管理"]}),t.jsx("p",{className:"text-gray-600",children:"ドッグラン施設の詳細情報と管理"})]}),t.jsxs("div",{className:"text-sm text-gray-500",children:["総施設数: ",N.length,"施設"]})]}),$&&t.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:$}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"総施設数"}),t.jsx("p",{className:"text-xl font-bold text-green-600",children:N.length})]}),t.jsx(x,{className:"w-6 h-6 text-green-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"承認済み"}),t.jsx("p",{className:"text-xl font-bold text-blue-600",children:N.filter((e=>"approved"===e.status)).length})]}),t.jsx(m,{className:"w-6 h-6 text-blue-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"平均評価"}),t.jsx("p",{className:"text-xl font-bold text-yellow-600",children:V.toFixed(1)})]}),t.jsx(p,{className:"w-6 h-6 text-yellow-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"月間総売上"}),t.jsxs("p",{className:"text-xl font-bold text-orange-600",children:["¥",Q.toLocaleString()]})]}),t.jsx(h,{className:"w-6 h-6 text-orange-600"})]})})]}),t.jsxs(a,{className:"p-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsx("div",{className:"md:col-span-2",children:t.jsx(l,{label:"検索",placeholder:"施設名、住所、オーナー名で検索...",value:q,onChange:e=>U(e.target.value),icon:t.jsx(g,{className:"w-4 h-4 text-gray-500"})})}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),t.jsxs("select",{value:I,onChange:e=>E(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[t.jsx("option",{value:"all",children:"すべて"}),t.jsx("option",{value:"pending",children:"審査中"}),t.jsx("option",{value:"approved",children:"承認済み"}),t.jsx("option",{value:"rejected",children:"却下"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),t.jsxs("select",{value:`${F}-${z}`,onChange:e=>{const[s,t]=e.target.value.split("-");O(s),P(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[t.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),t.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),t.jsx("option",{value:"name-asc",children:"施設名（昇順）"}),t.jsx("option",{value:"name-desc",children:"施設名（降順）"}),t.jsx("option",{value:"monthly_revenue-desc",children:"売上（高い順）"}),t.jsx("option",{value:"monthly_revenue-asc",children:"売上（低い順）"}),t.jsx("option",{value:"average_rating-desc",children:"評価（高い順）"}),t.jsx("option",{value:"average_rating-asc",children:"評価（低い順）"})]})]})]}),t.jsxs("div",{className:"flex justify-between items-center mt-4",children:[t.jsxs("p",{className:"text-sm text-gray-600",children:[k.length,"件の施設が見つかりました"]}),t.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{const e=[["施設名","住所","オーナー","ステータス","登録日","料金","定員","評価","月間売上","月間予約数"],...k.map((e=>[e.name,e.address,e.owner_name,A(e.status),new Date(e.created_at).toLocaleDateString("ja-JP"),`¥${e.price.toLocaleString()}`,`${e.max_capacity}人`,`${e.average_rating.toFixed(1)} (${e.review_count}件)`,`¥${e.monthly_revenue.toLocaleString()}`,`${e.monthly_reservations}件`]))].map((e=>e.join(","))).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`parks_${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[t.jsx(u,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),t.jsx(a,{children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"施設情報"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"オーナー"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"料金・定員"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"評価・売上"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:k.map((e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),t.jsx("div",{className:"text-sm text-gray-500",children:e.address}),t.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["設備: ",J(e.facilities)]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.owner_name}),t.jsx("div",{className:"text-sm text-gray-500",children:e.owner_email})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:B(e.status)}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{className:"space-y-1 text-sm",children:[t.jsxs("div",{className:"text-gray-900",children:["¥",e.price.toLocaleString(),"/日"]}),t.jsxs("div",{className:"text-gray-500",children:["定員: ",e.max_capacity,"人"]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{className:"space-y-1 text-sm",children:[t.jsxs("div",{className:"flex items-center text-gray-900",children:[t.jsx(p,{className:"w-4 h-4 mr-1 text-yellow-400 fill-current"}),e.average_rating.toFixed(1)," (",e.review_count,"件)"]}),t.jsxs("div",{className:"text-gray-500",children:["売上: ¥",e.monthly_revenue.toLocaleString(),"/月"]}),t.jsxs("div",{className:"text-gray-500",children:["予約: ",e.monthly_reservations,"件/月"]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(r,{size:"sm",variant:"secondary",onClick:()=>f(`/parks/${e.id}`),children:t.jsx(j,{className:"w-4 h-4"})}),t.jsx(r,{size:"sm",variant:"secondary",onClick:()=>f(`/admin/parks/${e.id}/analytics`),children:t.jsx(w,{className:"w-4 h-4"})})]})})]},e.id)))})]})})})]})}export{_ as AdminParkManagement};
