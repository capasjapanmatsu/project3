import{r as S}from"./react-vendor-Co5xHYdE.js";import{s as T}from"./index-fyCrE4_U.js";var b="https://js.stripe.com/v3",k=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/;var J=function(){for(var r=document.querySelectorAll('script[src^="'.concat(b,'"]')),e=0;e<r.length;e++){var t=r[e];if(k.test(t.src))return t}return null},_=function(r){var e="",t=document.createElement("script");t.src="".concat(b).concat(e);var n=document.head||document.body;if(!n)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return n.appendChild(t),t},U=function(r,e){!r||!r._registerWrapper||r._registerWrapper({name:"stripe-js",version:"2.4.0",startTime:e})},c=null,f=null,p=null,q=function(r){return function(){r(new Error("Failed to load Stripe.js"))}},O=function(r,e){return function(){window.Stripe?r(window.Stripe):e(new Error("Stripe.js not available"))}},W=function(r){return c!==null?c:(c=new Promise(function(e,t){if(typeof window>"u"||typeof document>"u"){e(null);return}if(window.Stripe){e(window.Stripe);return}try{var n=J();if(!(n&&r)){if(!n)n=_(r);else if(n&&p!==null&&f!==null){var i;n.removeEventListener("load",p),n.removeEventListener("error",f),(i=n.parentNode)===null||i===void 0||i.removeChild(n),n=_(r)}}p=O(e,t),f=q(t),n.addEventListener("load",p),n.addEventListener("error",f)}catch(w){t(w);return}}),c.catch(function(e){return c=null,Promise.reject(e)}))},A=function(r,e,t){if(r===null)return null;var n=r.apply(void 0,e);return U(n,t),n},l,P=!1,x=function(){return l||(l=W(null).catch(function(r){return l=null,Promise.reject(r)}),l)};Promise.resolve().then(function(){return x()}).catch(function(o){P||console.warn(o)});var D=function(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];P=!0;var n=Date.now();return x().then(function(i){return A(i,e,n)})};function $(){const[o,r]=S.useState(!1),[e,t]=S.useState(null);return{createCheckoutSession:S.useCallback(async({priceId:i,mode:w,successUrl:C=`${window.location.origin}/payment-confirmation?success=true`,cancelUrl:R=`${window.location.origin}/payment-confirmation?canceled=true`,customAmount:h,customName:E,customParams:g,cartItems:v})=>{r(!0),t(null);try{const{data:{session:a}}=await T.auth.getSession();if(!a?.access_token)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:a.user.id,user_email:a.user.email,timestamp:Date.now(),return_url:window.location.href}));const s={mode:w,success_url:C,cancel_url:R};i&&(s.price_id=i),h&&E&&(s.custom_amount=h,s.custom_name=E),v&&v.length>0&&(s.cart_items=v),g&&Object.entries(g).forEach(([u,d])=>{s[u]=d});const m=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`},body:JSON.stringify(s)});if(!m.ok){const u=await m.json();throw new Error(u.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:y,url:j}=await m.json();if(j){window.location.href=j;return}else if(y){const u="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",d=await D(u);if(!d)throw new Error("Stripeの読み込みに失敗しました");const{error:L}=await d.redirectToCheckout({sessionId:y});if(L)throw L}else throw new Error("チェックアウトURLが取得できませんでした")}catch(a){throw t(a.message||"チェックアウトに失敗しました"),a}finally{r(!1)}},[]),loading:o,error:e}}export{$ as u};
