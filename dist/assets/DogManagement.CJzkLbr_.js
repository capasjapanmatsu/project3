const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug.CWrMBERj.js","assets/index.Drgpoyph.js","assets/vendor.CKEClKZl.js","assets/router.B_7Atevv.js","assets/supabase.X3H3st79.js","assets/ui.C72fRZ1L.js","assets/index.Dzq9CoXB.css","assets/directVaccineUpload.Ce95D2n5.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,r=Object.defineProperties,i=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(r,i,t)=>i in r?e(r,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[i]=t,n=(e,r)=>{for(var i in r||(r={}))o.call(r,i)&&a(e,i,r[i]);if(t)for(var i of t(r))s.call(r,i)&&a(e,i,r[i]);return e},l=(e,r,i)=>new Promise((t,o)=>{var s=e=>{try{n(i.next(e))}catch(r){o(r)}},a=e=>{try{n(i.throw(e))}catch(r){o(r)}},n=e=>e.done?t(e.value):Promise.resolve(e.value).then(s,a);n((i=i.apply(e,r)).next())});import{_ as c}from"./supabase.X3H3st79.js";import{u as d,s as u,l as m,j as g,B as f,C as p}from"./index.Drgpoyph.js";import{r as h}from"./vendor.CKEClKZl.js";import{L as b}from"./router.B_7Atevv.js";import{D as y,a as v}from"./DogCard.CuTyCKjl.js";import{z as x,p as j,P as _}from"./ui.C72fRZ1L.js";import"./dogBreeds.6lxY8Uni.js";import"./Input.CUuxlVXM.js";import"./Select.CxVKDZ1_.js";import"./VaccineBadge.YARC9pB3.js";function w(e){return l(this,null,function*(){try{const r=yield e();return{data:r.data,error:r.error}}catch(r){return{data:null,error:r}}})}function D(){const{user:e}=d(),[t,o]=h.useState([]),[s,a]=h.useState(!0),[D,E]=h.useState(""),[S,N]=h.useState(!1),[U,$]=h.useState(null),[P,I]=h.useState(!1),[C,R]=h.useState(""),[O,V]=h.useState(""),[z,A]=h.useState(!1),[T,F]=h.useState({name:"",breed:"",gender:"",birthDate:"",microchipNumber:""}),[L,B]=h.useState(null),[k,M]=h.useState(null),[q,W]=h.useState(null),[J,K]=h.useState(null),[G,H]=h.useState(""),[Q,X]=h.useState(""),Y=h.useCallback(()=>l(this,null,function*(){try{a(!0),E("");const r=yield w(()=>u.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",null==e?void 0:e.id).order("created_at",{ascending:!1}));if(r.error)return m("error","Error fetching dogs",{error:r.error,userId:null==e?void 0:e.id}),void E("ワンちゃんの情報を取得できませんでした。");o(r.data||[])}catch(r){m("error","Exception in fetchDogs",{userId:null==e?void 0:e.id}),E("ワンちゃんの情報を取得できませんでした。")}finally{a(!1)}}),[null==e?void 0:e.id]);h.useEffect(()=>{e&&Y()},[e,Y]);const Z=e=>{var r;$(e),F({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date,microchipNumber:e.microchip_number||""}),M(e.image_url||null);const i=null==(r=e.vaccine_certifications)?void 0:r[0];i&&(H(i.rabies_expiry_date||""),X(i.combo_expiry_date||"")),N(!0)},ee=()=>l(this,null,function*(){var e;if(U&&U.image_url)try{I(!0),R("");try{const e=new URL(U.image_url).pathname.split("/"),r=e[e.length-1],i=`${U.id}/${r}`,{error:t}=yield u.storage.from("dog-images").remove([i])}catch(t){m("warn","Warning: Error processing image deletion",{error:t})}const o=yield w(()=>u.from("dogs").update({image_url:null}).eq("id",U.id));if(o.error)return m("error","Error updating dog image_url",{error:o.error,dogId:U.id}),void R("画像の削除に失敗しました。");B(null),M(null),$((e=n({},U),r(e,i({image_url:""})))),yield Y(),m("info","✅ Dog image removed successfully",{dogId:U.id}),V("画像を削除しました。"),setTimeout(()=>{V("")},3e3)}catch(o){m("error","Error removing dog image",{dogId:null==U?void 0:U.id}),R("画像の削除に失敗しました。")}finally{I(!1)}}),re=e=>l(this,null,function*(){if(e.preventDefault(),U){I(!0),R(""),V("");try{const e=n({name:T.name,breed:T.breed,gender:T.gender,birth_date:T.birthDate},T.microchipNumber&&{microchip_number:T.microchipNumber});if(L){if(m("info","Uploading dog image",{name:L.name,type:L.type,size:L.size,lastModified:L.lastModified,isFileObject:L instanceof File}),!L.type||!L.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${L.type}`);const r=`${U.id}/dog-photo.jpg`;m("info","File path",{fileName:r}),m("info","Using direct fetch API to bypass SDK");const i=`${""}/storage/v1/object/dog-images/${r}`,{data:{session:t}}=yield u.auth.getSession();if(!(null==t?void 0:t.access_token))throw new Error("認証されていません。ログインしてください。");m("info","Direct upload URL",{uploadUrl:i}),m("info","Using user access token for authentication"),m("info","Using PUT method for Supabase Storage API"),m("info","Upload options",{method:"PUT",contentType:L.type,authorization:"Bearer [token]",cacheControl:"3600"});const o=yield fetch(i,{method:"PUT",headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":L.type,"Cache-Control":"3600"},body:L});if(m("info","Response status",{status:o.status}),m("info","Response headers",{headers:Object.fromEntries(o.headers.entries())}),!o.ok){const e=yield o.text();throw m("error","Direct upload failed",{error:e}),new Error(`直接アップロードに失敗しました: ${o.status} ${e}`)}const s=yield o.json();m("info","Direct upload success",{responseData:s});const{data:{publicUrl:a}}=u.storage.from("dog-images").getPublicUrl(r);e.image_url=a}const{error:r}=yield u.from("dogs").update(e).eq("id",U.id);if(r)throw r;if(q&&J&&G&&Q){const e=q.name.split(".").pop()||"jpg",r=J.name.split(".").pop()||"jpg",i=Date.now(),t=`temp/${U.id}/rabies_${i}.${e}`,o=`temp/${U.id}/combo_${i}.${r}`;m("info","Uploading vaccine certificates with direct method");const{debugAuthStatus:s}=yield c(()=>l(this,null,function*(){const{debugAuthStatus:e}=yield import("./authDebug.CWrMBERj.js");return{debugAuthStatus:e}}),__vite__mapDeps([0,1,2,3,4,5,6]));yield s();const{directVaccineUpload:a}=yield c(()=>l(this,null,function*(){const{directVaccineUpload:e}=yield import("./directVaccineUpload.Ce95D2n5.js");return{directVaccineUpload:e}}),__vite__mapDeps([7,1,2,3,4,5,6]));m("info","Direct upload function imported successfully");const[n,d]=yield Promise.all([a(t,q),a(o,J)]);if(m("info","Upload results",{rabiesUpload:n,comboUpload:d}),!n.success||!d.success){m("error","VACCINE UPLOAD ERROR DETAILS"),n.success||m("error","Rabies upload error",{error:n.error}),d.success||m("error","Combo upload error",{error:d.error});const e=n.error||d.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${e}`)}m("info","Vaccine certificates uploaded successfully"),m("info","Rabies upload result",{url:n.url}),m("info","Combo upload result",{url:d.url});const g=n.url,f=d.url;m("info","Public URLs obtained",{rabiesPublicUrl:g,comboPublicUrl:f}),m("info","Saving vaccine certificates to database");const p=yield w(()=>u.from("vaccine_certifications").upsert([{dog_id:U.id,rabies_vaccine_image:g,combo_vaccine_image:f,rabies_expiry_date:G,combo_expiry_date:Q,status:"pending"}],{onConflict:"dog_id"}));if(p.error){m("error","Database save error",{error:p.error});const e=p.error instanceof Error?p.error.message:JSON.stringify(p.error);throw e.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${e}`)}m("info","Vaccine certificates saved to database successfully")}V("ワンちゃん情報を更新しました"),yield Y(),setTimeout(()=>{N(!1),V(""),B(null),M(null),W(null),K(null),H(""),X("")},2e3)}catch(r){m("error","Error updating dog",{dogId:null==U?void 0:U.id});let e="ワンちゃん情報の更新に失敗しました";r instanceof Error&&(e=r.message.includes("520")||r.message.includes("Cloudflare")?"ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":r.message.includes("アップロードに失敗しました")?r.message:`エラーが発生しました: ${r.message}`),R(e)}finally{I(!1)}}}),ie=e=>l(this,null,function*(){var r;A(!0),R("");try{m("info","Deleting dog:",{name:e.name,id:e.id});const{error:t}=yield u.from("vaccine_certifications").delete().eq("dog_id",e.id);if(t&&m("warn","Error deleting vaccine certifications",{error:t,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),i=r[r.length-1],t=`${e.id}/${i}`,{error:o}=yield u.storage.from("dog-images").remove([t])}catch(i){}const o=null==(r=e.vaccine_certifications)?void 0:r[0];if(o){const e=[];if(o.rabies_vaccine_image&&e.push(o.rabies_vaccine_image),o.combo_vaccine_image&&e.push(o.combo_vaccine_image),e.length>0){const{error:r}=yield u.storage.from("vaccine-certs").remove(e)}}const{error:s}=yield u.from("dogs").delete().eq("id",e.id);if(s)throw m("error","Error deleting dog",{error:s,dogId:e.id}),s;m("info","Dog deleted successfully",{dogName:e.name}),yield Y(),N(!1),V(`${e.name}の情報を削除しました。`),setTimeout(()=>{V("")},3e3)}catch(t){m("error","Error deleting dog",{dogId:null==e?void 0:e.id});const r=t.message||"ワンちゃんの削除に失敗しました";R(r)}finally{A(!1)}});return s?g.jsxs("div",{className:"flex justify-center items-center h-64",children:[g.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),g.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):g.jsxs("div",{className:"space-y-6",children:[g.jsxs("div",{className:"flex justify-between items-center",children:[g.jsxs("div",{children:[g.jsxs(b,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[g.jsx(x,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),g.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),g.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),g.jsx(b,{to:"/register-dog",children:g.jsxs(f,{children:[g.jsx(j,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),D&&g.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:D}),O&&g.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:O}),g.jsxs(p,{children:[g.jsx("div",{className:"flex justify-between items-center mb-4",children:g.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[g.jsx(_,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",t.length,"匹)"]})}),0===t.length?g.jsxs("div",{className:"text-center py-12",children:[g.jsx(_,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),g.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),g.jsx(b,{to:"/register-dog",children:g.jsxs(f,{children:[g.jsx(j,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):g.jsx("div",{className:"space-y-4",children:t.map(e=>g.jsx(y,{dog:e,onEdit:Z},e.id))})]}),S&&U&&g.jsx(v,{dog:U,isUpdating:P||z,error:C,success:O,dogFormData:T,dogImagePreview:k,onClose:()=>N(!1),onSubmit:e=>{re(e)},onDelete:e=>{ie(e)},onFormChange:F,onImageSelect:e=>{var r;const i=null==(r=e.target.files)?void 0:r[0];if(m("info","🔍 File selected:",i?{name:i.name,type:i.type,size:i.size,lastModified:i.lastModified}:{}),i)try{if(!(i instanceof File))return void R("有効なファイルを選択してください。");if(i.size>10485760)return void R("画像ファイルは10MB以下にしてください。");if(!i.type||!i.type.startsWith("image/"))return void R(`画像ファイルを選択してください。選択されたファイルタイプ: ${i.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(i.type))return void R(`サポートされていない画像形式です: ${i.type}`);B(i),m("info","✅ Dog image file set successfully:",{name:i.name,type:i.type,size:i.size});const e=new FileReader;e.onload=e=>{var r;M(null==(r=e.target)?void 0:r.result)},e.readAsDataURL(i)}catch(t){R("画像の処理に失敗しました。")}},onImageRemove:()=>{ee()},rabiesVaccineFile:q,comboVaccineFile:J,rabiesExpiryDate:G,comboExpiryDate:Q,onRabiesVaccineSelect:e=>{var r;const i=null==(r=e.target.files)?void 0:r[0];if(i){if(i.size>10485760)return void R("ワクチン証明書ファイルは10MB以下にしてください。");if(!i.type.startsWith("image/"))return void R("画像ファイルを選択してください。");W(i)}else W(null)},onComboVaccineSelect:e=>{var r;const i=null==(r=e.target.files)?void 0:r[0];if(i){if(i.size>10485760)return void R("ワクチン証明書ファイルは10MB以下にしてください。");if(!i.type.startsWith("image/"))return void R("画像ファイルを選択してください。");K(i)}else K(null)},onRabiesExpiryDateChange:H,onComboExpiryDateChange:X})]})}export{D as DogManagement};
