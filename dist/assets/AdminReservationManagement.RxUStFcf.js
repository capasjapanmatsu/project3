var e=(e,s,t)=>new Promise(((a,r)=>{var l=e=>{try{i(t.next(e))}catch(s){r(s)}},n=e=>{try{i(t.throw(e))}catch(s){r(s)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,n);i((t=t.apply(e,s)).next())}));import{u as s,s as t,j as a,C as r,B as l}from"./index.D9xag4tn.js";import{u as n,r as i,L as c}from"./router.BWT_vQps.js";import{I as d}from"./Input.tFQgyGuP.js";import{A as o,c as x,C as m,ag as p,ah as u,a4 as h,i as g,o as j,a as f,X as y,p as _,d as v}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function N(){const{isAdmin:N}=s(),w=n(),[b,k]=i.useState([]),[S,L]=i.useState([]),[D,C]=i.useState(null),[U,$]=i.useState(!0),[P,q]=i.useState(""),[E,A]=i.useState(""),[B,I]=i.useState("all"),[M,J]=i.useState(""),[T,z]=i.useState("reservation_date"),[F,O]=i.useState("desc");i.useEffect((()=>{N?(R(),V()):w("/")}),[N,w]),i.useEffect((()=>{X()}),[b,E,B,M,T,F]);const R=()=>e(null,null,(function*(){try{$(!0),q("");const{data:a,error:r}=yield t.from("reservations").select("\n          id,\n          user_id,\n          park_id,\n          dog_id,\n          date,\n          start_time,\n          duration,\n          status,\n          total_amount,\n          reservation_type,\n          created_at,\n          updated_at\n        ").order("created_at",{ascending:!1});if(r)throw new Error("予約情報の取得に失敗しました");if(!a||0===a.length)return void k([]);let l=null;try{const{data:e,error:s}=yield t.auth.admin.listUsers();s||(l=e)}catch(s){}const n=a.map((s=>e(null,null,(function*(){var e;try{const{data:r}=yield t.from("profiles").select("name, user_type").eq("id",s.user_id).single(),{data:n}=yield t.from("dog_parks").select("name, address").eq("id",s.park_id).single(),{data:i}=yield t.from("dogs").select("name, breed").eq("id",s.dog_id).single();let c=null;try{const{data:e}=yield t.from("stripe_subscriptions").select("status").eq("user_id",s.user_id).eq("status","active").maybeSingle();c=e}catch(a){}const d=null==(e=null==l?void 0:l.users)?void 0:e.find((e=>e.id===s.user_id)),o=null==d?void 0:d.email;return{id:s.id,user_name:(null==r?void 0:r.name)||"Unknown",user_email:o||`user_${s.user_id.slice(0,8)}@unknown.com`,park_id:s.park_id,park_name:(null==n?void 0:n.name)||"Unknown Park",park_address:(null==n?void 0:n.address)||"Unknown Address",dog_name:(null==i?void 0:i.name)||"Unknown Dog",dog_breed:(null==i?void 0:i.breed)||"Unknown Breed",dog_count:1,reservation_date:s.date,start_time:s.start_time,duration:s.duration||1,total_price:s.total_amount||0,status:s.status,reservation_type:s.reservation_type,is_subscription:!!c,payment_status:s.total_amount>0?"paid":"pending",created_at:s.created_at,updated_at:s.updated_at}}catch(r){return{id:s.id,user_name:"Unknown",user_email:`user_${s.user_id.slice(0,8)}@unknown.com`,park_id:s.park_id,park_name:"Unknown Park",park_address:"Unknown Address",dog_name:"Unknown Dog",dog_breed:"Unknown Breed",dog_count:1,reservation_date:s.date,start_time:s.start_time,duration:s.duration||1,total_price:s.total_amount||0,status:s.status,reservation_type:s.reservation_type,is_subscription:!1,payment_status:"pending",created_at:s.created_at,updated_at:s.updated_at}}})))),i=yield Promise.all(n);k(i)}catch(a){q(`予約データの取得に失敗しました: ${a instanceof Error?a.message:"不明なエラー"}`)}finally{$(!1)}})),V=()=>e(null,null,(function*(){try{const{data:e,error:s}=yield t.rpc("get_admin_reservation_stats");if(s)throw s;C(e)}catch(e){}})),X=()=>{let e=[...b];if(E&&(e=e.filter((e=>e.user_name.toLowerCase().includes(E.toLowerCase())||e.user_email.toLowerCase().includes(E.toLowerCase())||e.park_name.toLowerCase().includes(E.toLowerCase())))),"all"!==B&&(e=e.filter((e=>e.status===B))),M){const s=new Date(M);e=e.filter((e=>new Date(e.reservation_date).toDateString()===s.toDateString()))}e.sort(((e,s)=>{let t=e[T],a=s[T];return"reservation_date"!==T&&"created_at"!==T||(t=new Date(t).getTime(),a=new Date(a).getTime()),"asc"===F?t>a?1:-1:t<a?1:-1})),L(e)},G=e=>({confirmed:"確定",cancelled:"キャンセル",completed:"完了"}[e]||e),H=e=>({pending:"未払い",paid:"支払済み",refunded:"返金済み"}[e]||e),K=e=>{const s={confirmed:{color:"bg-green-100 text-green-800",icon:f},cancelled:{color:"bg-red-100 text-red-800",icon:y},completed:{color:"bg-blue-100 text-blue-800",icon:f}},t=s[e]||s.confirmed,r=t.icon;return a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(r,{className:"w-4 h-4"}),a.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${t.color}`,children:G(e)})]})},Q=e=>{const s={pending:{color:"bg-yellow-100 text-yellow-800",icon:v},paid:{color:"bg-green-100 text-green-800",icon:f},refunded:{color:"bg-gray-100 text-gray-800",icon:_}},t=s[e]||s.pending,r=t.icon;return a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(r,{className:"w-4 h-4"}),a.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${t.color}`,children:H(e)})]})};if(U)return a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"})});const W=S.reduce(((e,s)=>e+s.total_price),0),Y=S.length>0?W/S.length:0,Z=S.filter((e=>e.is_subscription)).length,ee=b.length>0?b.filter((e=>"cancelled"===e.status)).length/b.length*100:0;return a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[a.jsx(o,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[a.jsx(x,{className:"w-8 h-8 text-purple-600 mr-3"}),"予約管理"]}),a.jsx("p",{className:"text-gray-600",children:"予約の詳細情報と統計分析"})]}),a.jsxs("div",{className:"text-sm text-gray-500",children:["総予約数: ",b.length,"件"]})]}),P&&a.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:P}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"総予約数"}),a.jsx("p",{className:"text-xl font-bold text-purple-600",children:b.length})]}),a.jsx(x,{className:"w-6 h-6 text-purple-600"})]})}),a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"サブスク予約"}),a.jsx("p",{className:"text-xl font-bold text-blue-600",children:Z}),a.jsxs("p",{className:"text-xs text-gray-500",children:[b.length>0?Math.round(Z/b.length*100):0,"%"]})]}),a.jsx(m,{className:"w-6 h-6 text-blue-600"})]})}),a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"平均単価"}),a.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",Math.round(Y).toLocaleString()]})]}),a.jsx(p,{className:"w-6 h-6 text-green-600"})]})}),a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"キャンセル率"}),a.jsxs("p",{className:"text-xl font-bold text-orange-600",children:[ee.toFixed(1),"%"]})]}),a.jsx(u,{className:"w-6 h-6 text-orange-600"})]})})]}),D&&D.daily_stats.length>0&&a.jsxs(r,{className:"p-6",children:[a.jsx("h3",{className:"text-lg font-semibold mb-4",children:"日別予約統計（直近30日）"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-sm text-gray-600",children:"平均日次予約数"}),a.jsx("p",{className:"text-2xl font-bold text-purple-600",children:Math.round(D.daily_stats.reduce(((e,s)=>e+s.count),0)/D.daily_stats.length)})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-sm text-gray-600",children:"平均日次売上"}),a.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",Math.round(D.daily_stats.reduce(((e,s)=>e+s.revenue),0)/D.daily_stats.length).toLocaleString()]})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-sm text-gray-600",children:"平均キャンセル率"}),a.jsxs("p",{className:"text-2xl font-bold text-orange-600",children:[(D.daily_stats.reduce(((e,s)=>e+s.cancellation_rate),0)/D.daily_stats.length).toFixed(1),"%"]})]})]})]}),D&&D.top_parks.length>0&&a.jsxs(r,{className:"p-6",children:[a.jsx("h3",{className:"text-lg font-semibold mb-4",children:"人気ドッグランランキング"}),a.jsx("div",{className:"space-y-3",children:D.top_parks.slice(0,5).map(((e,s)=>a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold "+(0===s?"bg-yellow-500":1===s?"bg-gray-400":2===s?"bg-orange-600":"bg-blue-500"),children:s+1}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium",children:e.park_name}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.reservation_count,"件の予約"]})]})]}),a.jsxs("div",{className:"text-right",children:[a.jsxs("p",{className:"font-bold text-green-600",children:["¥",e.revenue.toLocaleString()]}),a.jsx("p",{className:"text-sm text-gray-600",children:"売上"})]})]},e.park_name)))})]}),a.jsxs(r,{className:"p-6",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[a.jsx("div",{className:"md:col-span-2",children:a.jsx(d,{label:"検索",placeholder:"ユーザー名、メール、ドッグラン名で検索...",value:E,onChange:e=>A(e.target.value),icon:a.jsx(h,{className:"w-4 h-4 text-gray-500"})})}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),a.jsxs("select",{value:B,onChange:e=>I(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",children:[a.jsx("option",{value:"all",children:"すべて"}),a.jsx("option",{value:"confirmed",children:"確定"}),a.jsx("option",{value:"cancelled",children:"キャンセル"}),a.jsx("option",{value:"completed",children:"完了"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"予約日"}),a.jsx("input",{type:"date",value:M,onChange:e=>J(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),a.jsxs("select",{value:`${T}-${F}`,onChange:e=>{const[s,t]=e.target.value.split("-");z(s),O(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",children:[a.jsx("option",{value:"reservation_date-desc",children:"予約日（新しい順）"}),a.jsx("option",{value:"reservation_date-asc",children:"予約日（古い順）"}),a.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),a.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),a.jsx("option",{value:"total_price-desc",children:"料金（高い順）"}),a.jsx("option",{value:"total_price-asc",children:"料金（低い順）"})]})]})]}),a.jsxs("div",{className:"flex justify-between items-center mt-4",children:[a.jsxs("p",{className:"text-sm text-gray-600",children:[S.length,"件の予約が見つかりました",S.length>0&&a.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",W.toLocaleString(),"）"]})]}),a.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{const e=[["予約ID","ユーザー名","メール","ドッグラン","予約日","開始時間","時間","料金","ステータス","支払状況","登録日"],...S.map((e=>[e.id,e.user_name,e.user_email,e.park_name,new Date(e.reservation_date).toLocaleDateString("ja-JP"),`${e.start_time}:00`,`${e.duration}時間`,`¥${e.total_price.toLocaleString()}`,G(e.status),H(e.payment_status),new Date(e.created_at).toLocaleDateString("ja-JP")]))].map((e=>e.join(","))).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`reservations_${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[a.jsx(g,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),a.jsx(r,{children:a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"w-full",children:[a.jsx("thead",{className:"bg-gray-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"予約日時"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"料金"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"支払状況"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.map((e=>a.jsxs("tr",{className:"hover:bg-gray-50",children:[a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.user_name}),e.is_subscription&&a.jsx(m,{className:"w-4 h-4 text-purple-600 ml-2"})]}),a.jsx("div",{className:"text-sm text-gray-500",children:e.user_email}),a.jsxs("div",{className:"text-xs text-gray-400",children:["犬: ",e.dog_count,"匹"]})]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.park_name})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{className:"space-y-1 text-sm",children:[a.jsx("div",{className:"text-gray-900",children:new Date(e.reservation_date).toLocaleDateString("ja-JP")}),a.jsxs("div",{className:"text-gray-500",children:[e.start_time,":00 (",e.duration,"時間)"]})]})}),a.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[a.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",e.total_price.toLocaleString()]}),e.is_subscription&&a.jsx("div",{className:"text-xs text-purple-600",children:"サブスク割引適用"})]}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:K(e.status)}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:Q(e.payment_status)}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:a.jsx("div",{className:"flex items-center space-x-2",children:a.jsx(l,{size:"sm",variant:"secondary",onClick:()=>w(`/parks/${e.park_id}`),children:a.jsx(j,{className:"w-4 h-4"})})})})]},e.id)))})]})})})]})}export{N as AdminReservationManagement};
