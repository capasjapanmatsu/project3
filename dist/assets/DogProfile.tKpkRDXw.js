var e=(e,s,t)=>new Promise(((a,r)=>{var l=e=>{try{c(t.next(e))}catch(s){r(s)}},i=e=>{try{c(t.throw(e))}catch(s){r(s)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,i);c((t=t.apply(e,s)).next())}));import{u as s,s as t,j as a,C as r,B as l}from"./index.D9xag4tn.js";import{a as i,u as c,r as n,L as d}from"./router.BWT_vQps.js";import{u as m,A as x,a as o,c as h,Y as u,ax as g,b as j}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function f(){const{id:f,dogId:p}=i(),{user:N}=s();c();const[y,v]=n.useState(null),[b,w]=n.useState(!0),[_,k]=n.useState(""),[q,S]=n.useState(""),[D,T]=n.useState(!1),[$,C]=n.useState(!1),[E,L]=n.useState([]),[P,Y]=n.useState(!1),[F,M]=n.useState(0),[z,A]=n.useState(!1),B=f||p;n.useEffect((()=>{B&&(I(),N&&(J(),O()))}),[B,N]);const I=()=>e(null,null,(function*(){try{w(!0),k("");const{data:e,error:s}=yield t.from("dogs").select("*").eq("id",B).single();if(s)throw s;v(e),M(e.like_count||0);const{data:a,error:r}=yield t.from("reservations").select("\n          *,\n          dog_park:dog_parks(*)\n        ").eq("dog_id",B).eq("status","confirmed");if(r)throw r;const l={};(a||[]).forEach((e=>{const s=e.park_id;e.dog_park&&(l[s]||(l[s]={park:e.dog_park,visits:0}),l[s].visits++)}));const i=Object.values(l).sort(((e,s)=>s.visits-e.visits)).slice(0,3);L(i)}catch(e){k("ワンちゃんの情報を取得できませんでした。")}finally{w(!1)}})),J=()=>e(null,null,(function*(){if(N&&B)try{const{data:e}=yield t.from("dogs").select("owner_id").eq("id",B).single();if(!e)return;const{data:s,error:a}=yield t.from("friend_requests").select("id, status").or(`and(requester_id.eq.${N.id},requested_id.eq.${e.owner_id}),and(requester_id.eq.${e.owner_id},requested_id.eq.${N.id})`).maybeSingle();!a&&s&&C(!0)}catch(e){}})),O=()=>e(null,null,(function*(){if(N&&B)try{const{data:e,error:s}=yield t.from("dog_likes").select("id").eq("user_id",N.id).eq("dog_id",B).maybeSingle();!s&&e&&Y(!0)}catch(e){}}));return b?a.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:a.jsx("div",{className:"flex items-center justify-center py-20",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):_||!y?a.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:a.jsxs(r,{className:"p-8 text-center",children:[a.jsx(m,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),a.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"ワンちゃんが見つかりません"}),a.jsx("p",{className:"text-gray-600 mb-6",children:_||"ワンちゃんの情報が見つかりませんでした。"}),a.jsx(d,{to:"/",children:a.jsxs(l,{variant:"primary",children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})})]})}):a.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[a.jsx("div",{className:"mb-6",children:a.jsxs(d,{to:"/",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})}),q&&a.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[a.jsx(o,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),a.jsx("p",{className:"text-green-800",children:q})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[a.jsx("div",{className:"lg:col-span-2",children:a.jsx(r,{className:"p-6",children:a.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx("div",{className:"w-48 h-48 bg-gray-200 rounded-lg overflow-hidden",children:y.image_url?a.jsx("img",{src:y.image_url,alt:y.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/58997/pexels-photo-58997.jpeg?auto=compress&cs=tinysrgb&w=300"}}):a.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:a.jsx(m,{className:"w-12 h-12"})})})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:[y.name,(G=y.gender,"オス"===G?"くん":"ちゃん")]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx(h,{className:"w-5 h-5 text-gray-500 mr-3"}),a.jsxs("span",{className:"text-lg text-gray-700",children:[(e=>{const s=new Date,t=new Date(e);let a=s.getFullYear()-t.getFullYear();const r=s.getMonth()-t.getMonth();return(r<0||0===r&&s.getDate()<t.getDate())&&a--,a})(y.birth_date),"歳"]})]}),a.jsxs("div",{className:"flex items-center",children:[a.jsx(m,{className:"w-5 h-5 text-gray-500 mr-3"}),a.jsx("span",{className:"text-lg text-gray-700",children:y.breed})]}),a.jsxs("div",{className:"flex items-center",children:[a.jsx(u,{className:"w-5 h-5 text-gray-500 mr-3"}),a.jsx("span",{className:"text-lg text-gray-700",children:y.gender})]})]}),a.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"flex items-center space-x-2",children:a.jsxs("span",{className:"text-sm text-gray-600",children:[F,"件のいいね"]})}),N&&a.jsxs(l,{onClick:()=>e(null,null,(function*(){if(N&&y&&!z){A(!0);try{if(P){const{error:e}=yield t.from("dog_likes").delete().eq("user_id",N.id).eq("dog_id",y.id);if(e)throw e;Y(!1),M((e=>e-1)),S("いいねを取り消しました")}else{const{error:e}=yield t.from("dog_likes").insert({user_id:N.id,dog_id:y.id});if(e)throw e;Y(!0),M((e=>e+1)),S("いいねしました")}setTimeout((()=>S("")),2e3)}catch(e){k("いいねの処理に失敗しました"),setTimeout((()=>k("")),3e3)}finally{A(!1)}}})),disabled:z,variant:P?"primary":"secondary",size:"sm",className:"px-4 py-2 "+(P?"bg-pink-500 hover:bg-pink-600 text-white":"bg-white hover:bg-pink-50 text-pink-600 border-pink-300"),children:[a.jsx(u,{className:"w-4 h-4 mr-1 "+(P?"fill-current":"")}),P?"いいね済み":"いいね"]})]})}),N&&y.owner_id!==N.id&&a.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[a.jsx("div",{className:"text-center",children:$?a.jsxs("div",{className:"flex items-center justify-center text-green-600",children:[a.jsx(o,{className:"w-5 h-5 mr-2"}),a.jsx("span",{className:"font-medium",children:"友達申請済み"})]}):a.jsxs(l,{onClick:()=>e(null,null,(function*(){if(N&&y){T(!0);try{const{error:e}=yield t.from("friend_requests").insert({requester_id:N.id,requested_id:y.owner_id,message:"ドッグランでお会いした際は、よろしくお願いします！"});if(e)throw e;C(!0),S("友達申請を送信しました"),setTimeout((()=>S("")),3e3)}catch(e){k("友達申請の送信に失敗しました"),setTimeout((()=>k("")),3e3)}finally{T(!1)}}})),isLoading:D,className:"px-8 py-3",children:[a.jsx(g,{className:"w-5 h-5 mr-2"}),"友達申請を送る"]})}),a.jsx("div",{className:"mt-4 p-4 bg-blue-50 rounded-lg",children:a.jsxs("div",{className:"text-sm text-blue-800",children:[a.jsx("p",{className:"font-medium mb-1",children:"友達申請について"}),a.jsx("p",{children:"友達申請を送ると、相手の飼い主さんに通知が届きます。 承認されると、メッセージのやり取りができるようになります。"})]})})]})]})]})})}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs(r,{className:"p-6",children:[a.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-4 flex items-center",children:[a.jsx(j,{className:"w-5 h-5 text-green-600 mr-2"}),"よく遊ぶドッグラン"]}),E.length>0?a.jsx("div",{className:"space-y-3",children:E.map(((e,s)=>a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-medium text-gray-900",children:e.park.name}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.visits,"回利用"]})]}),a.jsx("div",{className:"text-2xl",children:0===s?"🥇":1===s?"🥈":"🥉"})]},e.park.id)))}):a.jsx("p",{className:"text-gray-500",children:"まだドッグランの利用履歴がありません"})]}),a.jsxs(r,{className:"p-6",children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"登録日"}),a.jsx("p",{className:"text-gray-700",children:new Date(y.created_at).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})})]})]})]})]});var G}export{f as DogProfile};
