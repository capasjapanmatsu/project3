var e=(e,s,t)=>new Promise((a,l)=>{var r=e=>{try{i(t.next(e))}catch(s){l(s)}},n=e=>{try{i(t.throw(e))}catch(s){l(s)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,n);i((t=t.apply(e,s)).next())});import{u as s,s as t,j as a,C as l,B as r}from"./index.CQlxbczY.js";import{r as n}from"./vendor.CKEClKZl.js";import{u as i,L as c}from"./router.B_7Atevv.js";import{I as d}from"./Input.DMWrIIWM.js";import{z as o,i as x,n as m,b as u,y as h,_ as g,D as j,C as p,P as f,v as b,X as N,U as v,A as y,g as w}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";function _(){const{user:_}=s(),k=i(),[S,C]=n.useState([]),[D,L]=n.useState(!0),[$,z]=n.useState(""),[I,M]=n.useState("all"),[P,q]=n.useState((new Date).getFullYear().toString()),[F,Y]=n.useState("all"),[A,E]=n.useState([]),[O,U]=n.useState(0),[B,J]=n.useState(0),[R,T]=n.useState(""),[V,G]=n.useState([]),[H,K]=n.useState(null),[Q,W]=n.useState(null),[X,Z]=n.useState(null),[ee,se]=n.useState(null);n.useEffect(()=>{_?te():k("/login")},[_,k]);const te=()=>e(this,null,function*(){try{L(!0);const{data:e,error:s}=yield t.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("user_id",null==_?void 0:_.id).order("date",{ascending:!1}).limit(50);if(s)throw s;const{data:a,error:l}=yield t.from("dogs").select("*").eq("owner_id",null==_?void 0:_.id);if(l)throw l;if(C(e||[]),E(a||[]),e){U(e.length);const s=new Set(e.map(e=>e.park_id));J(s.size);const t={};e.forEach(e=>{const s=e.park_id;t[s]||(t[s]={count:0,name:e.dog_park.name,id:s}),t[s].count++});const a=Object.values(t).sort((e,s)=>s.count-e.count).slice(0,3).map(e=>({id:e.id,name:e.name,visits:e.count}));G(a),a.length>0&&T(a[0].name)}}catch(e){}finally{L(!1)}}),ae=e=>["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"][e-1],le=n.useMemo(()=>S.filter(e=>{const s=e.dog_park.name.toLowerCase().includes($.toLowerCase())||e.dog_park.address.toLowerCase().includes($.toLowerCase())||e.dog.name.toLowerCase().includes($.toLowerCase()),t="all"===I||e.dog_id===I,a=new Date(e.date),l="all"===P||a.getFullYear().toString()===P,r="all"===F||(a.getMonth()+1).toString()===F;return s&&t&&l&&r}),[S,$,I,P,F]),re=s=>e(this,null,function*(){const e="whole_facility"===s.reservation_type,a=new Date,l=new Date(s.date),r=new Date(l);if(r.setDate(l.getDate()-1),e)return a<r;{const{data:e}=yield t.from("user_entry_exit_logs").select("*").eq("user_id",s.user_id).eq("park_id",s.park_id).eq("action","entry").gte("timestamp",s.date);return!e||0===e.length}}),ne=s=>e(this,null,function*(){K(s.id),Z(null),se(null);try{const{data:e,error:a}=yield t.rpc("cancel_reservation",{p_reservation_id:s.id,p_user_id:s.user_id});if(a||!(null==e?void 0:e.success))return void Z(e&&e.message||(null==a?void 0:a.message)||"キャンセルに失敗しました");se("予約をキャンセルしました"),W(null),yield te(),setTimeout(()=>se(null),3e3)}catch(e){Z(e.message||"キャンセルに失敗しました")}finally{K(null)}});return D?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(c,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[a.jsx(o,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[a.jsx(x,{className:"w-8 h-8 text-blue-600 mr-3"}),"ドッグラン利用履歴"]}),a.jsx("p",{className:"text-lg text-gray-600",children:"これまでのドッグラン利用記録を確認できます"})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[a.jsxs(l,{className:"p-6 text-center",children:[a.jsx(x,{className:"w-12 h-12 text-blue-600 mx-auto mb-2"}),a.jsx("p",{className:"text-3xl font-bold text-gray-900",children:O}),a.jsx("p",{className:"text-gray-600",children:"総利用回数"})]}),a.jsxs(l,{className:"p-6 text-center",children:[a.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),a.jsx("p",{className:"text-3xl font-bold text-gray-900",children:B}),a.jsx("p",{className:"text-gray-600",children:"訪問したドッグラン数"})]}),a.jsxs(l,{className:"p-6 text-center",children:[a.jsx(u,{className:"w-12 h-12 text-purple-600 mx-auto mb-2"}),a.jsx("p",{className:"text-xl font-bold text-gray-900 mb-1",children:R||"-"}),a.jsx("p",{className:"text-gray-600",children:"最も訪問したドッグラン"})]})]}),V.length>0&&a.jsxs(l,{className:"p-6",children:[a.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[a.jsx(h,{className:"w-6 h-6 text-pink-600 mr-2"}),"よく行くドッグラン"]}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:V.map((e,s)=>a.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[a.jsx("div",{className:"w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-600 font-bold",children:s+1}),a.jsx("h3",{className:"font-semibold",children:e.name})]}),a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx(x,{className:"w-4 h-4 text-gray-500 mr-1"}),a.jsxs("span",{className:"text-sm text-gray-600",children:[e.visits,"回利用"]})]}),a.jsx(c,{to:`/parks/${e.id}`,children:a.jsx(r,{size:"sm",variant:"secondary",children:"詳細"})})]})]},e.id))})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsx("div",{className:"md:col-span-2",children:a.jsx(d,{label:"",value:$,onChange:e=>z(e.target.value),placeholder:"ドッグラン名、住所で検索...",icon:a.jsx(g,{className:"w-4 h-4 text-gray-500"})})}),a.jsx("div",{children:a.jsxs("select",{value:I,onChange:e=>M(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"all",children:"すべてのワンちゃん"}),A.map(e=>a.jsxs("option",{value:e.id,children:[e.name,"ちゃん"]},e.id))]})}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsxs("select",{value:P,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"all",children:"すべての年"}),(()=>{const e=(new Date).getFullYear(),s=[];for(let t=e;t>=e-2;t--)s.push({value:t.toString(),label:`${t}年`});return s})().map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))]}),a.jsx("select",{value:F,onChange:e=>Y(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:(()=>{const e=[{value:"all",label:"すべての月"}];for(let s=1;s<=12;s++)e.push({value:s.toString(),label:ae(s)});return e})().map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]})]}),a.jsx("div",{className:"flex justify-end",children:a.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{if(0===le.length)return;const e="\ufeff"+[["日付","時間","ドッグラン名","住所","ワンちゃん","料金","予約タイプ"].join(","),...le.map(e=>[new Date(e.date).toLocaleDateString("ja-JP"),`${e.start_time}〜${parseInt(e.start_time)+e.duration}:00`,`"${e.dog_park.name.replace(/"/g,'""')}"`,`"${e.dog_park.address.replace(/"/g,'""')}"`,`"${e.dog.name.replace(/"/g,'""')}"`,`¥${e.total_amount}`,"regular"===e.reservation_type?"通常利用":"private_booth"===e.reservation_type?"プライベートブース":"施設貸し切り"].join(","))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(s),a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("download",`dogpark_history_${(new Date).toISOString().split("T")[0]}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},children:[a.jsx(j,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),0===le.length?a.jsxs(l,{className:"text-center py-12",children:[a.jsx(x,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"利用履歴がありません"}),a.jsx("p",{className:"text-gray-500 mb-6",children:"まだドッグランを利用していないようです"}),a.jsx(c,{to:"/parks",children:a.jsx(r,{children:"ドッグランを予約する"})})]}):a.jsx("div",{className:"space-y-6",children:le.map(s=>{const t=new Date(s.date),n=t.toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),i=s.start_time,d=`${parseInt(i)+s.duration}:00`,o="regular"===s.reservation_type?"通常利用":"private_booth"===s.reservation_type?"プライベートブース":"施設貸し切り";return a.jsxs(l,{className:"p-6 hover:shadow-lg transition-shadow",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start gap-4",children:[a.jsxs("div",{className:"flex items-start space-x-4",children:[a.jsxs("div",{className:"bg-blue-100 rounded-lg p-3 text-center min-w-[80px]",children:[a.jsx("p",{className:"text-sm text-blue-800",children:t.getFullYear()}),a.jsx("p",{className:"text-xl font-bold text-blue-600",children:t.getDate()}),a.jsx("p",{className:"text-sm text-blue-800",children:ae(t.getMonth()+1)})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold",children:s.dog_park.name}),a.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[a.jsx(u,{className:"w-4 h-4 mr-1 flex-shrink-0"}),a.jsx("span",{className:"text-sm",children:s.dog_park.address})]}),a.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[a.jsx(p,{className:"w-4 h-4 mr-1 flex-shrink-0"}),a.jsxs("span",{className:"text-sm",children:[i," 〜 ",d]})]}),a.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[a.jsx(f,{className:"w-4 h-4 mr-1 flex-shrink-0"}),a.jsxs("span",{className:"text-sm",children:[s.dog.name,"ちゃん（",s.dog.breed,"）"]})]}),Math.random()>.5&&a.jsx("div",{className:"flex items-center mt-2",children:[1,2,3,4,5].map(e=>a.jsx(b,{className:"w-4 h-4 "+(e<=Math.floor(3+2*Math.random())?"text-yellow-400 fill-current":"text-gray-300")},e))})]})]}),a.jsxs("div",{className:"flex flex-col items-end",children:[a.jsx("div",{className:"text-right",children:a.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",s.total_amount.toLocaleString()]})}),a.jsx("div",{className:"mt-2",children:a.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("regular"===s.reservation_type?"bg-blue-100 text-blue-800":"private_booth"===s.reservation_type?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"),children:o})}),a.jsx("div",{className:"mt-2",children:a.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("confirmed"===s.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:"confirmed"===s.status?"利用済み":"キャンセル"})})]})]}),a.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 flex justify-between items-center",children:[a.jsx("div",{className:"text-sm text-gray-500",children:n}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsx(c,{to:`/parks/${s.park_id}`,children:a.jsxs(r,{size:"sm",variant:"secondary",children:[a.jsx(m,{className:"w-4 h-4 mr-1"}),"施設詳細"]})}),a.jsx(c,{to:`/parks/${s.park_id}/reserve`,children:a.jsxs(r,{size:"sm",children:[a.jsx(x,{className:"w-4 h-4 mr-1"}),"再予約"]})}),"confirmed"===s.status&&a.jsxs(r,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",isLoading:H===s.id,onClick:()=>e(this,null,function*(){(yield re(s))?W(s.id):Z("この予約はキャンセルできません（貸し切りは1日前まで、通常予約はPIN未使用時のみ）")}),children:[a.jsx(N,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]})]},s.id)})}),le.length>0&&a.jsx(l,{className:"p-6 bg-blue-50 border-blue-200",children:a.jsxs("div",{className:"flex items-start space-x-3",children:[a.jsx(v,{className:"w-6 h-6 text-blue-600 mt-1"}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"コミュニティ機能"}),a.jsx("p",{className:"text-sm text-blue-800 mb-3",children:"同じドッグランを利用した他のワンちゃんとの出会いを「コミュニティ」ページで確認できます。 友達申請を送ったり、次回の予約を調整したりして、ワンちゃん同士の交流を深めましょう。"}),a.jsx(c,{to:"/community",children:a.jsxs(r,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),"コミュニティを見る"]})})]})]})}),Q&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[a.jsxs("div",{className:"text-center mb-6",children:[a.jsx(y,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"予約をキャンセルしますか？"}),a.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),a.jsxs("div",{className:"flex justify-end space-x-3",children:[a.jsx(r,{variant:"secondary",onClick:()=>W(null),children:"戻る"}),a.jsx(r,{className:"bg-red-600 hover:bg-red-700",isLoading:H===Q,onClick:()=>{const e=le.find(e=>e.id===Q);e&&ne(e)},children:"キャンセルする"})]})]})}),ee&&a.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(w,{className:"w-5 h-5 text-green-600"}),a.jsx("span",{className:"font-semibold text-green-800",children:ee})]})}),X&&a.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(y,{className:"w-5 h-5 text-red-600"}),a.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),a.jsx("p",{className:"text-red-700 mt-1",children:X})]})]})}export{_ as DogParkHistory};
