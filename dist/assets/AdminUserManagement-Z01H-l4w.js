import{u as e,s,j as t,C as a,B as r}from"./index-CG6tuKmC.js";import{u as n,r as c,L as i}from"./vendor-BHVjIt_u.js";import{I as l}from"./Input-BcmoGOeA.js";import{I as d,U as x,ak as o,j as m,l as u,ax as h,ap as p,M as j,q as g,ay as f,o as N,az as v}from"./ui-BlUB7fmN.js";import"./supabase-CKbzEL5D.js";function y(){const{isAdmin:y}=e(),w=n(),[_,b]=c.useState([]),[k,S]=c.useState([]),[D,C]=c.useState(!0),[L,I]=c.useState(""),[$,E]=c.useState(""),[U,q]=c.useState("all"),[P,z]=c.useState("created_at"),[J,M]=c.useState("desc");c.useEffect((()=>{y?O():w("/")}),[y,w]),c.useEffect((()=>{B()}),[_,$,U,P,J]);const O=async()=>{try{C(!0),I("");const{data:e,error:t}=await s.from("profiles").select("\n          id,\n          name,\n          user_type,\n          postal_code,\n          address,\n          phone_number,\n          created_at\n        ");if(t)throw new Error("プロファイル情報の取得に失敗しました");if(!e||0===e.length)return void b([]);const a=e.map((async e=>{try{const{count:t}=await s.from("dogs").select("id",{count:"exact"}).eq("owner_id",e.id),a=new Date;a.setDate(1),a.setHours(0,0,0,0);const{count:r}=await s.from("reservations").select("id",{count:"exact"}).eq("user_id",e.id).gte("created_at",a.toISOString()),{data:n}=await s.from("reservations").select("total_amount").eq("user_id",e.id).not("total_amount","is",null),c=(n||[]).reduce(((e,s)=>e+(s.total_amount||0)),0),i=`user_${e.id.slice(0,8)}@unknown.com`;return{id:e.id,name:e.name||"Unknown",email:i,phone:e.phone_number||"",created_at:e.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:t||0,reservation_count:r||0,total_spent:c}}catch(t){return{id:e.id,name:e.name||"Unknown",email:`user_${e.id.slice(0,8)}@unknown.com`,phone:e.phone_number||"",created_at:e.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:0,reservation_count:0,total_spent:0}}})),r=await Promise.all(a);b(r)}catch(e){I(e instanceof Error?e.message:"ユーザー情報の取得に失敗しました")}finally{C(!1)}},B=()=>{let e=[..._];$&&(e=e.filter((e=>e.name.toLowerCase().includes($.toLowerCase())||e.email.toLowerCase().includes($.toLowerCase())))),"all"!==U&&(e=e.filter((e=>{switch(U){case"active":return e.is_active;case"inactive":return!e.is_active;case"subscribers":return"active"===e.subscription_status;default:return!0}}))),e.sort(((e,s)=>{const t=e[P]||"",a=s[P]||"";return"asc"===J?t>a?1:-1:t<a?1:-1})),S(e)},F=e=>"active"===e.subscription_status?t.jsxs("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[t.jsx(m,{className:"w-3 h-3 mr-1"}),"サブスク"]}):e.is_active?t.jsxs("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[t.jsx(o,{className:"w-3 h-3 mr-1"}),"アクティブ"]}):t.jsxs("span",{className:"bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[t.jsx(v,{className:"w-3 h-3 mr-1"}),"非アクティブ"]});return D?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"flex items-center space-x-4 mb-6",children:t.jsxs(i,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[t.jsx(x,{className:"w-8 h-8 text-blue-600 mr-3"}),"ユーザー管理"]}),t.jsx("p",{className:"text-gray-600",children:"登録ユーザーの詳細情報と管理"})]}),t.jsxs("div",{className:"text-sm text-gray-500",children:["総ユーザー数: ",_.length,"人"]})]}),L&&t.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:L}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"総ユーザー数"}),t.jsx("p",{className:"text-xl font-bold text-blue-600",children:_.length})]}),t.jsx(x,{className:"w-6 h-6 text-blue-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"アクティブユーザー"}),t.jsx("p",{className:"text-xl font-bold text-green-600",children:_.filter((e=>e.is_active)).length})]}),t.jsx(o,{className:"w-6 h-6 text-green-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"サブスク会員"}),t.jsx("p",{className:"text-xl font-bold text-purple-600",children:_.filter((e=>"active"===e.subscription_status)).length})]}),t.jsx(m,{className:"w-6 h-6 text-purple-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"今月新規登録"}),t.jsx("p",{className:"text-xl font-bold text-orange-600",children:_.filter((e=>{const s=new Date(e.created_at),t=new Date;return s.getMonth()===t.getMonth()&&s.getFullYear()===t.getFullYear()})).length})]}),t.jsx(u,{className:"w-6 h-6 text-orange-600"})]})})]}),t.jsxs(a,{className:"p-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsx("div",{className:"md:col-span-2",children:t.jsx(l,{label:"検索",placeholder:"名前またはメールアドレスで検索...",value:$,onChange:e=>E(e.target.value),icon:t.jsx(h,{className:"w-4 h-4 text-gray-500"})})}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),t.jsxs("select",{value:U,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"all",children:"すべて"}),t.jsx("option",{value:"active",children:"アクティブ"}),t.jsx("option",{value:"inactive",children:"非アクティブ"}),t.jsx("option",{value:"subscribers",children:"サブスク会員"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),t.jsxs("select",{value:`${P}-${J}`,onChange:e=>{const[s,t]=e.target.value.split("-");z(s),M(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),t.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),t.jsx("option",{value:"name-asc",children:"名前（昇順）"}),t.jsx("option",{value:"name-desc",children:"名前（降順）"}),t.jsx("option",{value:"total_spent-desc",children:"支払額（高い順）"}),t.jsx("option",{value:"total_spent-asc",children:"支払額（低い順）"})]})]})]}),t.jsxs("div",{className:"flex justify-between items-center mt-4",children:[t.jsxs("p",{className:"text-sm text-gray-600",children:[k.length,"件のユーザーが見つかりました"]}),t.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{const e=[["名前","メールアドレス","電話番号","登録日","犬数","予約数","支払額","サブスクリプション"].join(","),...k.map((e=>[e.name,e.email,e.phone||"",new Date(e.created_at).toLocaleDateString("ja-JP"),e.dog_count,e.reservation_count,e.total_spent,e.subscription_status].join(",")))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`users-${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[t.jsx(p,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),t.jsx(a,{children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"連絡先"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"最終ログイン"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"統計"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:k.map((e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),t.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",e.id.slice(0,8),"..."]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"flex items-center text-sm text-gray-900",children:[t.jsx(j,{className:"w-4 h-4 mr-2 text-gray-400"}),e.email]}),e.phone&&t.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[t.jsx(g,{className:"w-4 h-4 mr-2 text-gray-400"}),e.phone]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.last_sign_in_at?new Date(e.last_sign_in_at).toLocaleDateString("ja-JP"):"未ログイン"}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:F(e)}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{className:"space-y-1 text-sm",children:[t.jsxs("div",{className:"flex items-center text-gray-900",children:[t.jsx(f,{className:"w-4 h-4 mr-1 text-gray-400"}),"犬: ",e.dog_count,"匹"]}),t.jsxs("div",{className:"text-gray-500",children:["予約: ",e.reservation_count,"件"]}),t.jsxs("div",{className:"text-gray-500",children:["支払: ¥",e.total_spent.toLocaleString()]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:t.jsx("div",{className:"flex items-center space-x-2",children:t.jsx(r,{size:"sm",variant:"secondary",onClick:()=>w(`/admin/users/${e.id}`),children:t.jsx(N,{className:"w-4 h-4"})})})})]},e.id)))})]})})})]})}export{y as AdminUserManagement};
