import{s as u}from"./index-BSYT0262.js";const d=async(e,n,i)=>{try{console.log("ğŸ”§ Fixed vaccine upload - starting...",{dogId:n,imageType:i,fileName:e.name,fileSize:e.size,fileType:e.type});const c=e.name.split(".").pop()||"jpg",p=Date.now(),o=`${n}/${i}_${p}.${c}`;if(console.log("Generated file name:",o),!(e instanceof File))throw console.error("âŒ File validation failed:",{isFile:!1,actualType:typeof e,hasName:"name"in e,hasType:"type"in e}),new Error(`Invalid file object: expected File, got ${typeof e}`);console.log("âœ… File validation passed:",{isFile:!0,name:e.name,type:e.type,size:e.size}),console.log("ğŸ” === UPLOAD DEBUG INFO ==="),console.log("ğŸ“ Bucket: vaccine-certs"),console.log("ğŸ“„ File name:",o),console.log("ğŸ“‹ File details:",{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified,instanceof_File:e instanceof File}),console.log("âš™ï¸ Upload options:",{cacheControl:"3600",upsert:!0,contentType:e.type});const{data:a,error:s}=await u.storage.from("vaccine-certs").upload(o,e,{cacheControl:"3600",upsert:!0,contentType:e.type});if(s)return console.error("ğŸš¨ === UPLOAD ERROR DETAILS ==="),console.error("âŒ Error message:",s.message),console.error("âŒ Error details:",s),console.error("âŒ Error code:",s.name||"N/A"),console.error("âŒ File type:",e.type),console.error("âŒ Content-Type sent:",e.type),console.error("âŒ File size:",e.size),console.error("âŒ Bucket:","vaccine-certs"),console.error("âŒ File path:",o),{success:!1,error:`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${s.message}`};console.log("Fixed upload successful:",a);const{data:{publicUrl:l}}=u.storage.from("vaccine-certs").getPublicUrl(o);return console.log("Generated public URL:",l),{success:!0,filePath:o}}catch(c){return console.error("Fixed upload exception:",c),{success:!1,error:c.message}}},g=async(e,n,i,c,p)=>{try{console.log("ğŸ”§ Fixed complete vaccine upload starting...");let o,a;if(n){console.log("Uploading rabies vaccine...");const r=await d(n,e,"rabies");if(!r.success)return{success:!1,error:`ç‹‚çŠ¬ç—…ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸: ${r.error}`};o=r.filePath,console.log("Rabies upload successful:",o)}if(i){console.log("Uploading combo vaccine...");const r=await d(i,e,"combo");if(!r.success)return{success:!1,error:`æ··åˆãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸: ${r.error}`};a=r.filePath,console.log("Combo upload successful:",a)}console.log("Updating database...");const{data:s,error:l}=await u.from("vaccine_certifications").select("id").eq("dog_id",e).maybeSingle();if(l&&l.code!=="PGRST116")return{success:!1,error:`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${l.message}`};const t={status:"pending"};if(o&&(t.rabies_vaccine_image=o),a&&(t.combo_vaccine_image=a),c&&(t.rabies_expiry_date=c),p&&(t.combo_expiry_date=p),s){const{error:r}=await u.from("vaccine_certifications").update(t).eq("id",s.id);if(r)return{success:!1,error:`è¨¼æ˜æ›¸æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${r.message}`}}else{const{error:r}=await u.from("vaccine_certifications").insert([{dog_id:e,...t}]);if(r)return{success:!1,error:`è¨¼æ˜æ›¸ä½œæˆã‚¨ãƒ©ãƒ¼: ${r.message}`}}return console.log("âœ… Fixed vaccine upload completed successfully"),{success:!0}}catch(o){return console.error("Fixed complete upload error:",o),{success:!1,error:o.message}}};export{g as h};
