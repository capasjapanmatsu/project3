import{s as u}from"./index-BSYT0262.js";const d=async(e,n,i)=>{try{console.log("🔧 Fixed vaccine upload - starting...",{dogId:n,imageType:i,fileName:e.name,fileSize:e.size,fileType:e.type});const c=e.name.split(".").pop()||"jpg",p=Date.now(),o=`${n}/${i}_${p}.${c}`;if(console.log("Generated file name:",o),!(e instanceof File))throw console.error("❌ File validation failed:",{isFile:!1,actualType:typeof e,hasName:"name"in e,hasType:"type"in e}),new Error(`Invalid file object: expected File, got ${typeof e}`);console.log("✅ File validation passed:",{isFile:!0,name:e.name,type:e.type,size:e.size}),console.log("🔍 === UPLOAD DEBUG INFO ==="),console.log("📁 Bucket: vaccine-certs"),console.log("📄 File name:",o),console.log("📋 File details:",{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified,instanceof_File:e instanceof File}),console.log("⚙️ Upload options:",{cacheControl:"3600",upsert:!0,contentType:e.type});const{data:a,error:s}=await u.storage.from("vaccine-certs").upload(o,e,{cacheControl:"3600",upsert:!0,contentType:e.type});if(s)return console.error("🚨 === UPLOAD ERROR DETAILS ==="),console.error("❌ Error message:",s.message),console.error("❌ Error details:",s),console.error("❌ Error code:",s.name||"N/A"),console.error("❌ File type:",e.type),console.error("❌ Content-Type sent:",e.type),console.error("❌ File size:",e.size),console.error("❌ Bucket:","vaccine-certs"),console.error("❌ File path:",o),{success:!1,error:`アップロードに失敗しました: ${s.message}`};console.log("Fixed upload successful:",a);const{data:{publicUrl:l}}=u.storage.from("vaccine-certs").getPublicUrl(o);return console.log("Generated public URL:",l),{success:!0,filePath:o}}catch(c){return console.error("Fixed upload exception:",c),{success:!1,error:c.message}}},g=async(e,n,i,c,p)=>{try{console.log("🔧 Fixed complete vaccine upload starting...");let o,a;if(n){console.log("Uploading rabies vaccine...");const r=await d(n,e,"rabies");if(!r.success)return{success:!1,error:`狂犬病ワクチン証明書: ${r.error}`};o=r.filePath,console.log("Rabies upload successful:",o)}if(i){console.log("Uploading combo vaccine...");const r=await d(i,e,"combo");if(!r.success)return{success:!1,error:`混合ワクチン証明書: ${r.error}`};a=r.filePath,console.log("Combo upload successful:",a)}console.log("Updating database...");const{data:s,error:l}=await u.from("vaccine_certifications").select("id").eq("dog_id",e).maybeSingle();if(l&&l.code!=="PGRST116")return{success:!1,error:`データベース確認エラー: ${l.message}`};const t={status:"pending"};if(o&&(t.rabies_vaccine_image=o),a&&(t.combo_vaccine_image=a),c&&(t.rabies_expiry_date=c),p&&(t.combo_expiry_date=p),s){const{error:r}=await u.from("vaccine_certifications").update(t).eq("id",s.id);if(r)return{success:!1,error:`証明書更新エラー: ${r.message}`}}else{const{error:r}=await u.from("vaccine_certifications").insert([{dog_id:e,...t}]);if(r)return{success:!1,error:`証明書作成エラー: ${r.message}`}}return console.log("✅ Fixed vaccine upload completed successfully"),{success:!0}}catch(o){return console.error("Fixed complete upload error:",o),{success:!1,error:o.message}}};export{g as h};
