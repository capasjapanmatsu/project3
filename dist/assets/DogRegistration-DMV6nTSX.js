import{s as y,u as J,j as e,B as M,C as W,n as X}from"./index-B2nIfDq6.js";import{r as N,L as R}from"./react-vendor-ClX3xUyT.js";import{I as H}from"./Input-_c6WZwIR.js";import{S as _}from"./Select-DMnQLiAJ.js";import{d as K}from"./dogBreeds-CaddeN4P.js";import{l as t}from"./logger-C8dD4C56.js";import{V as Q,X as Z,a1 as ee}from"./ui-vendor-Bbvw08tP.js";import"./supabase-vendor-CRpuwX9I.js";const $=o=>{if(!o)return{isValid:!1,error:"ファイルが選択されていません"};const g=10*1024*1024;return o.size>g?{isValid:!1,error:"ファイルサイズは10MB以下にしてください"}:["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(o.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${o.type}`}},P=async(o,g)=>{try{const c=$(o);if(!c.isValid)return{success:!1,error:c.error};const D=Date.now(),n=o.name.split(".").pop()||"jpg",d=`${g.dogId}/${g.imageType}_${D}.${n}`;console.log("🧪 Starting vaccine image upload:",{dogId:g.dogId,imageType:g.imageType,fileName:d,fileSize:o.size,fileType:o.type});const{data:v,error:p}=await y.storage.from("vaccine-certs").upload(d,o,{cacheControl:"3600",upsert:!0,contentType:o.type});return p?(console.error("❌ Vaccine upload error:",p),{success:!1,error:`アップロードに失敗しました: ${p.message}`,errorCode:p.message}):(console.log("✅ Vaccine upload successful:",{fileName:d,data:v}),{success:!0,filePath:d})}catch(c){return console.error("❌ Vaccine upload exception:",c),{success:!1,error:`アップロード中にエラーが発生しました: ${c.message}`}}};function ce(){const{user:o}=J(),[g,c]=N.useState(!1),[D,n]=N.useState(""),[d,v]=N.useState(null),[p,S]=N.useState(null),[r,u]=N.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),U=new Date().getFullYear(),q=Array.from({length:21},(a,s)=>{const i=U-s;return{value:i.toString(),label:`${i}年`}}),L=Array.from({length:12},(a,s)=>{const i=s+1;return{value:i.toString().padStart(2,"0"),label:`${i}月`}}),A=()=>{if(!r.birthYear||!r.birthMonth)return Array.from({length:31},(b,f)=>{const l=f+1;return{value:l.toString().padStart(2,"0"),label:`${l}日`}});const a=parseInt(r.birthYear),s=parseInt(r.birthMonth),i=new Date(a,s,0).getDate();return Array.from({length:i},(b,f)=>{const l=f+1;return{value:l.toString().padStart(2,"0"),label:`${l}日`}})},T=()=>{if(!r.birthYear||!r.birthMonth||!r.birthDay)return!1;const a=parseInt(r.birthYear),s=parseInt(r.birthMonth),i=parseInt(r.birthDay),b=new Date(a,s-1,i);if(b>new Date)return!1;const l=new Date;return l.setFullYear(l.getFullYear()-20),!(b<l)},F=a=>{const s=a.target.files?.[0];if(s){if(t.info("Selected file:",s.name,s.size,s.type),s.size>10*1024*1024){n("画像ファイルは10MB以下にしてください。");return}if(!s.type.startsWith("image/")){n("画像ファイルを選択してください。");return}v(s);const i=new FileReader;i.onload=b=>{S(b.target?.result),t.info("Image preview created")},i.readAsDataURL(s),n("")}},O=()=>{v(null),S(null)},k=async a=>{a.preventDefault(),c(!0),n("");try{if(t.info("=== DOG REGISTRATION START ==="),t.info("Starting dog registration for user:",o?.id),!T()){n("正しい生年月日を選択してください。"),c(!1);return}if(!r.rabiesExpiryDate||!r.comboExpiryDate){n("ワクチンの有効期限を入力してください。"),c(!1);return}const s=new Date,i=new Date(r.rabiesExpiryDate),b=new Date(r.comboExpiryDate);if(i<=s||b<=s){n("ワクチンの有効期限は今日より後の日付を入力してください。"),c(!1);return}const f=`${r.birthYear}-${r.birthMonth}-${r.birthDay}`;let l;if(r.gender==="オス"||r.gender==="male"||r.gender.toLowerCase()==="male")l="オス";else if(r.gender==="メス"||r.gender==="female"||r.gender.toLowerCase()==="female")l="メス";else{n("性別を正しく選択してください。"),c(!1);return}t.info("Original gender:",r.gender,"Normalized gender:",l);const{data:E,error:w}=await y.from("profiles").select("id, name, user_type").eq("id",o?.id).maybeSingle();if(t.info("Profile check result:",E,w),w&&w.code!=="PGRST116")throw t.error("Profile error:",w),w;if(E)t.info("Profile exists:",E);else{t.info("Creating profile for dog registration using upsert");const m=o?.user_metadata?.name||o?.email?.split("@")[0]||"ユーザー",{data:I,error:x}=await y.from("profiles").upsert([{id:o?.id,user_type:"user",name:m,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(x)throw t.error("Profile upsert error:",x),x;t.info("Profile upserted successfully:",I)}t.info("Registering dog with data:",{name:r.name,breed:r.breed,birth_date:f,gender:l,owner_id:o?.id});const{data:j,error:h}=await y.from("dogs").insert([{name:r.name,breed:r.breed,birth_date:f,gender:l,owner_id:o?.id}]).select().single();if(h)throw t.error("🚨 Dog registration error:",h),t.error("🚨 Error details:",{message:h.message,code:h.code,details:h.details,hint:h.hint}),h;t.info("✅ Dog registered successfully:",j),t.info("✅ Dog ID generated:",j.id);let V=null;if(d){t.info("Uploading dog image...");try{const m=d.name.split(".").pop()||"jpg",I=Date.now(),x=`${j.id}/profile_${I}.${m}`;t.info("Uploading to path:",x),t.info("🔧 Uploading dog image with Content-Type:",d.type);const{error:C}=await y.storage.from("dog-images").upload(x,d,{cacheControl:"3600",upsert:!0,contentType:d.type});if(C)throw t.error("Image upload error:",C),new Error(`画像のアップロードに失敗しました: ${C.message}`);t.info("Upload successful");const{data:{publicUrl:G}}=y.storage.from("dog-images").getPublicUrl(x);V=G,t.info("Public URL generated:",V);const{error:Y}=await y.from("dogs").update({image_url:V}).eq("id",j.id);if(Y)throw t.error("Error updating dog image URL:",Y),new Error("画像URLの更新に失敗しました");t.info("Dog image URL updated successfully")}catch(m){t.error("Image processing error:",m),n("画像のアップロードに失敗しましたが、ワンちゃんの登録は完了しました。後でマイページから画像を追加できます。")}}if(r.rabiesVaccineImage&&r.comboVaccineImage){t.info("🧪 Starting vaccine certificates upload using utility...");const m=await P(r.rabiesVaccineImage,{dogId:j.id,imageType:"rabies"}),I=await P(r.comboVaccineImage,{dogId:j.id,imageType:"combo"});m.success?t.info("✅ Vaccine certificates uploaded successfully"):(t.error("Vaccine upload failed:",m.error),n(`ワクチン証明書のアップロードに失敗しました: ${m.error}`))}t.info("Dog registration completed successfully"),X.success("ワンちゃんの登録が完了しました！"),u({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),v(null),S(null)}catch(s){t.error("Registration error:",s),n("ワンちゃんの登録に失敗しました。もう一度お試しください。")}finally{c(!1)}},z=K.map(a=>({value:a,label:a})),B=[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}];return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[e.jsxs("div",{children:[e.jsxs(R,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[e.jsx(Q,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"新しいワンちゃんを登録して、ドッグランを利用しましょう"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-900",children:"既に登録済みのワンちゃんがいますか？"}),e.jsx("p",{className:"text-sm text-blue-700",children:"登録済みのワンちゃんの情報を確認・編集できます"})]}),e.jsx(R,{to:"/dog-management",children:e.jsx(M,{variant:"secondary",size:"sm",children:"ワンちゃん管理"})})]})}),e.jsx(W,{children:e.jsxs("form",{onSubmit:k,children:[D&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:D}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ワンちゃんの写真（任意）"}),p?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:p,alt:"ワンちゃんのプレビュー",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:O,className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(Z,{className:"w-4 h-4"})}),d&&e.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:d.name})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:F,className:"hidden",id:"dog-image"}),e.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[e.jsx(ee,{className:"w-12 h-12 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (最大10MB)"})]})]})]}),e.jsx(H,{label:"名前",value:r.name,onChange:a=>u({...r,name:a.target.value}),required:!0}),e.jsx(_,{label:"犬種",options:z,value:r.breed,onChange:a=>u({...r,breed:a.target.value}),required:!0}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"生年月日 *"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx("div",{children:e.jsxs("select",{value:r.birthYear,onChange:a=>{u({...r,birthYear:a.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"年"}),q.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:r.birthMonth,onChange:a=>{u({...r,birthMonth:a.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"月"}),L.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:r.birthDay,onChange:a=>u({...r,birthDay:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!r.birthYear||!r.birthMonth,children:[e.jsx("option",{value:"",children:"日"}),A().map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})})]}),r.birthYear&&r.birthMonth&&!r.birthDay&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"日を選択してください"}),r.birthYear&&r.birthMonth&&r.birthDay&&!T()&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:"正しい生年月日を選択してください（未来の日付や20年以上前の日付は選択できません）"})]}),e.jsx(_,{label:"性別",options:B,value:r.gender,onChange:a=>u({...r,gender:a.target.value}),required:!0}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ワクチン証明書"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン接種証明書 *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:a=>{const s=a.target.files?.[0];if(s){const i=$(s);if(!i.isValid){n(i.error||"ファイルの検証に失敗しました");return}n("")}u({...r,rabiesVaccineImage:s||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン有効期限 *"}),e.jsx("input",{type:"date",value:r.rabiesExpiryDate,onChange:a=>u({...r,rabiesExpiryDate:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン接種証明書 *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:a=>{const s=a.target.files?.[0];if(s){const i=$(s);if(!i.isValid){n(i.error||"ファイルの検証に失敗しました");return}n("")}u({...r,comboVaccineImage:s||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン有効期限 *"}),e.jsx("input",{type:"date",value:r.comboExpiryDate,onChange:a=>u({...r,comboExpiryDate:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800",children:"※ ワクチン接種証明書は運営による確認後に承認されます。承認されるまでドッグランの利用はできません。"})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"ワクチン証明書について:"}),e.jsx("br",{}),"• 管理者が確認しやすい形で保存されます",e.jsx("br",{}),"• 承認されると正式にワクチン情報として登録されます",e.jsx("br",{}),"• 承認後、全国のドッグランをご利用いただけます"]})})]}),e.jsx(M,{type:"submit",isLoading:g,className:"w-full",children:"ワンちゃんを登録する"})]})})]})}export{ce as DogRegistration};
