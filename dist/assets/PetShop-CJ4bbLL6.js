import{j as e,q as o,k as q,S as B,ap as J,aq as R,_ as z,Q as K,x as W,r as M,J as X,ar as Y}from"./ui-vendor-FlUr4cJt.js";import{r,L as P}from"./react-vendor-_GyjDmDn.js";import{B as g,u as Z,b as ee,s as m,C as L}from"./index-BSYT0262.js";import{I as se}from"./Input-wBkmcJUR.js";import{u as te}from"./useStripe-CyE4J3Un.js";import{p as ae}from"./stripe-config-03sBkt-B.js";import"./supabase-vendor-Df9iqQzW.js";function re({hasSubscription:n=!1,className:d="",variant:N="primary",size:i="md"}){const{createCheckoutSession:y,loading:C,error:x}=te(),[p,f]=r.useState(!1),h=async()=>{f(!1);const j=ae.find(b=>b.mode==="subscription");if(!j){console.error("Subscription product not found");return}try{await y({priceId:j.priceId,mode:"subscription",successUrl:`${window.location.origin}/dashboard?success=true`,cancelUrl:`${window.location.origin}/dashboard?canceled=true`})}catch{f(!0)}};return n?e.jsx(P,{to:"/subscription",children:e.jsxs(g,{variant:N,size:i,className:`flex items-center ${d}`,children:[e.jsx(o,{className:`${i==="sm"?"w-3 h-3":"w-4 h-4"} mr-1`}),"サブスク管理"]})}):e.jsxs("div",{children:[e.jsxs(g,{onClick:()=>void h(),isLoading:C,variant:"primary",size:i,className:`flex items-center bg-purple-600 hover:bg-purple-700 text-white ${d}`,children:[e.jsx(o,{className:`${i==="sm"?"w-3 h-3":"w-4 h-4"} mr-1`}),"サブスクに加入"]}),p&&x&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:x})]})}function xe(){const{user:n}=Z(),[d,N]=r.useState([]),[i,y]=r.useState([]),[C,x]=r.useState(!0),[p,f]=r.useState(""),[h,j]=r.useState("all"),[b,O]=r.useState("name"),{isActive:u}=ee(),w=r.useDeferredValue(p),S=r.useDeferredValue(h),T=r.useDeferredValue(b),I=[{value:"all",label:"すべて",icon:q},{value:"food",label:"ドッグフード",icon:z},{value:"treats",label:"おやつ",icon:K},{value:"toys",label:"おもちゃ",icon:W},{value:"accessories",label:"アクセサリー",icon:o},{value:"health",label:"ヘルスケア",icon:M},{value:"sheets",label:"ペットシーツ",icon:z}];r.useEffect(()=>{v()},[n]);const v=async()=>{x(!0);try{await Promise.all([Q(),n?V():Promise.resolve()])}catch(s){console.error("データ取得エラー:",s)}finally{x(!1)}},Q=async()=>{const{data:s,error:t}=await m.from("products").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(t)throw t;N(s||[])},V=async()=>{const{data:s,error:t}=await m.from("cart_items").select("*, product:products(*)").eq("user_id",n.id);if(t)throw t;y(s||[])},A=async(s,t=1)=>{if(n)try{const a=i.find(l=>l.product_id===s);if(a){const{error:l}=await m.from("cart_items").update({quantity:a.quantity+t}).eq("id",a.id);if(l)throw l}else{const{error:l}=await m.from("cart_items").insert([{user_id:n.id,product_id:s,quantity:t}]);if(l)throw l}await v()}catch(a){console.error("Error adding to cart:",a)}},$=async(s,t)=>{if(t<=0)try{const{error:a}=await m.from("cart_items").delete().eq("id",s);if(a)throw a;await v()}catch(a){console.error("Error removing from cart:",a)}else try{const{error:a}=await m.from("cart_items").update({quantity:t}).eq("id",s);if(a)throw a;await v()}catch(a){console.error("Error updating cart:",a)}},U=s=>{const t=i.find(a=>a.product_id===s);return t?t.quantity:0},_=s=>u?Math.round(s*.9):s,E=r.useMemo(()=>d.filter(t=>{const a=t.name.toLowerCase().includes(w.toLowerCase())||t.description.toLowerCase().includes(w.toLowerCase())||t.brand&&t.brand.toLowerCase().includes(w.toLowerCase()),l=S==="all"||t.category===S;return a&&l}).sort((t,a)=>{switch(T){case"name":return t.name.localeCompare(a.name);case"price":return _(t.price)-_(a.price);case"category":return t.category.localeCompare(a.category);default:return new Date(a.created_at).getTime()-new Date(t.created_at).getTime()}}),[d,w,S,T]),G=s=>{f(s),r.startTransition(()=>{console.log(`🔍 Filtering ${d.length} products for "${s}"`)})},D=s=>{r.startTransition(()=>{j(s)})},H=s=>{r.startTransition(()=>{O(s)})};return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(q,{className:"w-8 h-8 text-green-600 mr-3"}),"ペットショップ"]}),e.jsx("p",{className:"text-gray-600",children:"愛犬のための厳選商品をお届け"})]}),e.jsx(P,{to:"/cart",children:e.jsxs(g,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"カート (",i.reduce((s,t)=>s+t.quantity,0),")"]})})]}),e.jsx("div",{className:"relative overflow-hidden",children:u?e.jsxs("div",{className:"bg-gradient-to-r from-purple-600 via-pink-600 to-purple-700 text-white p-8 rounded-xl shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-white/20 p-3 rounded-full",children:e.jsx(o,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[e.jsx(J,{className:"w-6 h-6 mr-2"}),"サブスクリプション会員特典適用中！"]}),e.jsx("p",{className:"text-lg opacity-90",children:"全商品10%OFF + 送料無料でお買い物をお楽しみください"})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"bg-white/20 px-6 py-3 rounded-lg",children:[e.jsx("p",{className:"text-sm opacity-80",children:"今月の節約額"}),e.jsx("p",{className:"text-2xl font-bold",children:"¥1,200+"})]})})]}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"})]}):e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white p-8 rounded-xl shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-white/20 p-3 rounded-full",children:e.jsx(R,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[e.jsx(o,{className:"w-6 h-6 mr-2"}),"サブスク会員は全品10％OFF & 送料無料！"]}),e.jsx("p",{className:"text-lg opacity-90",children:"月額3,800円でどこでも使い放題 + ドッグラン使い放題"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(re,{hasSubscription:u,className:"bg-white text-purple-600 hover:bg-gray-100 font-bold px-6 py-3 text-lg"}),e.jsx("p",{className:"text-sm opacity-80 mt-2",children:"初月無料キャンペーン中"})]})]}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(se,{label:"",value:p,onChange:s=>G(s.target.value),placeholder:"商品名、ブランド名で検索..."})}),e.jsx("div",{children:e.jsx("select",{value:h,onChange:s=>D(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:I.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})}),e.jsx("div",{children:e.jsxs("select",{value:b,onChange:s=>H(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"popular",children:"人気順"}),e.jsx("option",{value:"name",children:"名前順"}),e.jsx("option",{value:"price",children:"価格の安い順"}),e.jsx("option",{value:"category",children:"カテゴリー順"})]})})]}),e.jsx("div",{className:"flex space-x-2 overflow-x-auto pb-2",children:I.map(s=>{const t=s.icon;return e.jsxs("button",{onClick:()=>D(s.value),className:`flex items-center space-x-2 px-4 py-2 rounded-lg whitespace-nowrap transition-colors ${h===s.value?"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(t,{className:"w-4 h-4"}),e.jsx("span",{children:s.label})]},s.value)})}),E.length===0?e.jsxs(L,{className:"text-center py-12",children:[e.jsx(q,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"該当する商品が見つかりませんでした"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:E.map(s=>{const t=U(s.id),a=s.price,l=_(a),F=u&&l<a;return e.jsxs(L,{className:"overflow-hidden hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"relative h-48 mb-4 -m-6 mb-4",children:[e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover",onError:c=>{c.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),F&&e.jsx("div",{className:"absolute top-3 left-3",children:e.jsxs("span",{className:"bg-purple-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(o,{className:"w-3 h-3 mr-1"}),"10%OFF"]})}),s.stock_quantity<=5&&e.jsx("div",{className:"absolute top-3 right-3",children:e.jsxs("span",{className:"bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium",children:["残り",s.stock_quantity,"個"]})})]}),e.jsxs("div",{className:"px-6 pb-6",children:[e.jsxs("div",{className:"mb-2",children:[s.brand&&e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:s.brand}),e.jsx("h3",{className:"text-lg font-semibold line-clamp-2",children:s.name})]}),e.jsx("p",{className:"text-gray-600 text-sm mb-3 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-500 mb-3",children:[s.weight&&e.jsxs("p",{children:["内容量: ",s.weight,"g"]}),s.size&&e.jsxs("p",{children:["サイズ: ",s.size]}),s.age_group&&s.age_group!=="all"&&e.jsxs("p",{children:["対象年齢: ",s.age_group==="puppy"?"子犬":s.age_group==="adult"?"成犬":"シニア犬"]}),s.dog_size&&s.dog_size!=="all"&&e.jsxs("p",{children:["対象サイズ: ",s.dog_size==="small"?"小型犬":s.dog_size==="medium"?"中型犬":"大型犬"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-xl font-bold text-green-600",children:["¥",l.toLocaleString()]}),F&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",a.toLocaleString()]})]}),u&&e.jsxs("p",{className:"text-xs text-purple-600 flex items-center",children:[e.jsx(o,{className:"w-3 h-3 mr-1"}),"サブスク会員価格"]})]}),e.jsxs("div",{className:"space-y-2",children:[t>0?e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-2",children:[e.jsx("button",{onClick:()=>{const c=i.find(k=>k.product_id===s.id);c&&$(c.id,t-1)},className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(X,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium",children:t}),e.jsx("button",{onClick:()=>{const c=i.find(k=>k.product_id===s.id);c&&$(c.id,t+1)},className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(M,{className:"w-4 h-4"})})]}):e.jsx(g,{onClick:()=>A(s.id),className:"w-full bg-green-600 hover:bg-green-700",disabled:s.stock_quantity===0,children:s.stock_quantity===0?"在庫切れ":e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"カートに追加"]})}),e.jsx(P,{to:`/shop/product/${s.id}`,children:e.jsx(g,{variant:"secondary",className:"w-full",children:"詳細を見る"})})]})]})]},s.id)})}),e.jsx(L,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(Y,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"})]})]})]})})]})}export{xe as PetShop};
