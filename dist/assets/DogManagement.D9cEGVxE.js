const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug.BonbA7Oa.js","assets/index.D9xag4tn.js","assets/vendor.D1SiiUJb.js","assets/router.BWT_vQps.js","assets/supabase.CZ8ekJUM.js","assets/ui.BPlS2KKq.js","assets/index.Cz27AGZu.css","assets/directVaccineUpload.0ECuwNvN.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,r=Object.defineProperties,t=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(r,t,i)=>t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[t]=i,n=(e,r,t)=>new Promise(((i,o)=>{var s=e=>{try{n(t.next(e))}catch(r){o(r)}},a=e=>{try{n(t.throw(e))}catch(r){o(r)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,a);n((t=t.apply(e,r)).next())}));import{_ as l}from"./supabase.CZ8ekJUM.js";import{u as d,b as c,s as u,l as m,j as g,B as f,C as p}from"./index.D9xag4tn.js";import{r as h,L as y}from"./router.BWT_vQps.js";import{D as b,a as v}from"./DogCard.DW-LSdTa.js";import{A as x,t as j,u as _}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./Input.tFQgyGuP.js";import"./Select.BO4O17RR.js";import"./dogBreeds.6lxY8Uni.js";import"./VaccineBadge.DLhIwHr_.js";function w(){const{user:e}=d(),[w,E]=h.useState([]),[S,D]=h.useState(!0),[$,N]=h.useState(""),[I,C]=h.useState(!1),[O,P]=h.useState(null),[R,U]=h.useState(!1),[V,A]=h.useState(""),[F,z]=h.useState(""),[L,T]=h.useState(!1),[B,q]=h.useState({name:"",breed:"",gender:"",birthDate:""}),[M,W]=h.useState(null),[k,G]=h.useState(null),[H,J]=h.useState(null),[K,Q]=h.useState(null),[X,Y]=h.useState(""),[Z,ee]=h.useState("");h.useEffect((()=>{e&&re()}),[e]);const re=()=>n(null,null,(function*(){try{D(!0),N("");const r=yield c((()=>u.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",null==e?void 0:e.id).order("created_at",{ascending:!1})));if(r.error)return m("error","Error fetching dogs",{error:r.error,userId:null==e?void 0:e.id}),void N("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");E(r.data||[])}catch(r){m("error","Exception in fetchDogs",{error:r,userId:null==e?void 0:e.id}),N("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")}finally{D(!1)}})),te=e=>{var r;P(e),q({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date}),G(e.image_url||null);const t=null==(r=e.vaccine_certifications)?void 0:r[0];t&&(Y(t.rabies_expiry_date||""),ee(t.combo_expiry_date||"")),C(!0)};return S?g.jsxs("div",{className:"flex justify-center items-center h-64",children:[g.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),g.jsx("p",{className:"ml-3 text-gray-600",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­..."})]}):g.jsxs("div",{className:"space-y-6",children:[g.jsxs("div",{className:"flex justify-between items-center",children:[g.jsxs("div",{children:[g.jsxs(y,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[g.jsx(x,{className:"w-4 h-4 mr-1"}),"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹"]}),g.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"}),g.jsx("p",{className:"text-gray-600",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™"})]}),g.jsx(y,{to:"/register-dog",children:g.jsxs(f,{children:[g.jsx(j,{className:"w-4 h-4 mr-2"}),"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²"]})})]}),$&&g.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:$}),F&&g.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:F}),g.jsxs(p,{children:[g.jsx("div",{className:"flex justify-between items-center mb-4",children:g.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[g.jsx(_,{className:"w-6 h-6 text-blue-600 mr-2"}),"ç™»éŒ²æ¸ˆã¿ãƒ¯ãƒ³ã¡ã‚ƒã‚“ (",w.length,"åŒ¹)"]})}),0===w.length?g.jsxs("div",{className:"text-center py-12",children:[g.jsx(_,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),g.jsx("p",{className:"text-gray-600 mb-4",children:"ã¾ã ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),g.jsx(y,{to:"/register-dog",children:g.jsxs(f,{children:[g.jsx(j,{className:"w-4 h-4 mr-2"}),"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"]})})]}):g.jsx("div",{className:"space-y-4",children:w.map((e=>g.jsx(b,{dog:e,onEdit:te},e.id)))})]}),I&&O&&g.jsx(v,{dog:O,isUpdating:R||L,error:V,success:F,dogFormData:B,dogImagePreview:k,onClose:()=>C(!1),onSubmit:e=>n(null,null,(function*(){if(e.preventDefault(),O){U(!0),A(""),z("");try{const e={name:B.name,breed:B.breed,gender:B.gender,birth_date:B.birthDate};if(M){if(!M.type||!M.type.startsWith("image/"))throw new Error(`ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${M.type}`);const r=`${O.id}/dog-photo.jpg`,t=`${""}/storage/v1/object/dog-images/${r}`,{data:{session:i}}=yield u.auth.getSession();if(!(null==i?void 0:i.access_token))throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");const o=yield fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":M.type,"Cache-Control":"3600"},body:M});if(!o.ok){const e=yield o.text();throw m("error","âŒ Direct upload failed",{error:e}),new Error(`ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${o.status} ${e}`)}yield o.json();const{data:{publicUrl:s}}=u.storage.from("dog-images").getPublicUrl(r);e.image_url=s}const{error:r}=yield u.from("dogs").update(e).eq("id",O.id);if(r)throw r;if(H&&K&&X&&Z){const e=H.name.split(".").pop()||"jpg",r=K.name.split(".").pop()||"jpg",t=Date.now(),i=`temp/${O.id}/rabies_${t}.${e}`,o=`temp/${O.id}/combo_${t}.${r}`,{debugAuthStatus:s}=yield l((()=>n(null,null,(function*(){const{debugAuthStatus:e}=yield import("./authDebug.BonbA7Oa.js");return{debugAuthStatus:e}}))),__vite__mapDeps([0,1,2,3,4,5,6]));yield s();const{directVaccineUpload:a}=yield l((()=>n(null,null,(function*(){const{directVaccineUpload:e}=yield import("./directVaccineUpload.0ECuwNvN.js");return{directVaccineUpload:e}}))),__vite__mapDeps([7,1,2,3,4,5,6])),[d,c]=yield Promise.all([a(i,H),a(o,K)]);if(!d.success||!c.success){m("error","ğŸš¨ === VACCINE UPLOAD ERROR DETAILS ==="),d.success||m("error","âŒ Rabies upload error",{error:d.error}),c.success||m("error","âŒ Combo upload error",{error:c.error});const e=d.error||c.error||"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";throw new Error(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e}`)}const g=d.url,f=c.url,{error:p}=yield u.from("vaccine_certifications").upsert([{dog_id:O.id,rabies_vaccine_image:g,combo_vaccine_image:f,rabies_expiry_date:X,combo_expiry_date:Z,status:"pending"}],{onConflict:"dog_id"});if(p)throw m("error","âŒ Database save error",{error:p}),p.message&&p.message.includes("520")?new Error("ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"):new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${p.message}`)}z("ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),yield re(),setTimeout((()=>{C(!1),z(""),W(null),G(null),J(null),Q(null),Y(""),ee("")}),2e3)}catch(r){m("error","Error updating dog",{error:r,dogId:null==O?void 0:O.id});let e="ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";r instanceof Error&&(e=r.message.includes("520")||r.message.includes("Cloudflare")?"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚":r.message.includes("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")?r.message:`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${r.message}`),A(e)}finally{U(!1)}}})),onDelete:e=>n(null,null,(function*(){var r;T(!0),A("");try{const{error:i}=yield u.from("vaccine_certifications").delete().eq("dog_id",e.id);if(i&&m("warn","Error deleting vaccine certifications",{error:i,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],i=`${e.id}/${t}`,{error:o}=yield u.storage.from("dog-images").remove([i])}catch(t){}const o=null==(r=e.vaccine_certifications)?void 0:r[0];if(o){const e=[];if(o.rabies_vaccine_image&&e.push(o.rabies_vaccine_image),o.combo_vaccine_image&&e.push(o.combo_vaccine_image),e.length>0){const{error:r}=yield u.storage.from("vaccine-certs").remove(e)}}const{error:s}=yield u.from("dogs").delete().eq("id",e.id);if(s)throw m("error","Error deleting dog",{error:s,dogId:e.id}),s;yield re(),C(!1),z(`${e.name}ã®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`),setTimeout((()=>{z("")}),3e3)}catch(i){m("error","Error deleting dog",{error:i,dogId:null==e?void 0:e.id});const r=i.message||"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ";A(r)}finally{T(!1)}})),onFormChange:q,onImageSelect:e=>n(null,null,(function*(){var r;const t=null==(r=e.target.files)?void 0:r[0];if(m("info","ğŸ” File selected:",t?{name:t.name,type:t.type,size:t.size,lastModified:t.lastModified,isFileObject:t instanceof File}:{message:"No file selected"}),t)try{if(!(t instanceof File))return void A("æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");if(t.size>10485760)return void A("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type||!t.type.startsWith("image/"))return void A(`ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${t.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return void A(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${t.type}`);W(t),m("info","âœ… Dog image file set successfully:",{name:t.name,type:t.type,size:t.size});const e=new FileReader;e.onload=e=>{var r;G(null==(r=e.target)?void 0:r.result)},e.readAsDataURL(t)}catch(i){A("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}})),onImageRemove:()=>n(null,null,(function*(){var e;if(O&&O.image_url)try{U(!0),A("");try{const e=new URL(O.image_url).pathname.split("/"),r=e[e.length-1],t=`${O.id}/${r}`,{error:i}=yield u.storage.from("dog-images").remove([t])}catch(n){m("warn","Warning: Error processing image deletion",{error:n})}const l=yield c((()=>u.from("dogs").update({image_url:null}).eq("id",O.id)));if(l.error)return m("error","Error updating dog image_url",{error:l.error,dogId:O.id}),void A("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");W(null),G(null),P((e=((e,r)=>{for(var t in r||(r={}))o.call(r,t)&&a(e,t,r[t]);if(i)for(var t of i(r))s.call(r,t)&&a(e,t,r[t]);return e})({},O),r(e,t({image_url:void 0})))),yield re(),m("info","âœ… Dog image removed successfully",{dogId:O.id}),z("ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"),setTimeout((()=>{z("")}),3e3)}catch(l){m("error","Error removing dog image",{error:l,dogId:null==O?void 0:O.id}),A("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{U(!1)}})),rabiesVaccineFile:H,comboVaccineFile:K,rabiesExpiryDate:X,comboExpiryDate:Z,onRabiesVaccineSelect:e=>n(null,null,(function*(){var r;const t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>10485760)return void A("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type.startsWith("image/"))return void A("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");J(t)}else J(null)})),onComboVaccineSelect:e=>n(null,null,(function*(){var r;const t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>10485760)return void A("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type.startsWith("image/"))return void A("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");Q(t)}else Q(null)})),onRabiesExpiryDateChange:Y,onComboExpiryDateChange:ee})]})}export{w as DogManagement};
