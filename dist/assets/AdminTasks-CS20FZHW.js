import{j as e,V as R,A as L,g as d,aK as M,p as A,au as y,a as F,C as _,t as T,X as z}from"./ui-vendor-FlUr4cJt.js";import{i as K,r as c,L as k}from"./react-vendor-_GyjDmDn.js";import{s as x,l as S,C as i,B as m}from"./index-BSYT0262.js";import"./supabase-vendor-Df9iqQzW.js";function I(){const[P]=K(),[t,q]=c.useState({pendingVaccines:0,pendingParks:0,unreadMessages:0,pendingUsers:0}),[u,J]=c.useState([]),[b,B]=c.useState([]),[U,E]=c.useState(!0),[C,o]=c.useState(""),[D,j]=c.useState(""),[l,h]=c.useState("overview"),[p,N]=c.useState(!1);c.useEffect(()=>{const s=P.get("tab");s&&["overview","vaccines","parks","messages"].includes(s)&&h(s),w()},[P]);const w=async()=>{try{E(!0);const{data:s,error:r}=await x.from("vaccine_certifications").select(`
          *,
          dog:dogs(
            *,
            owner:profiles(*)
          )
        `).eq("status","pending").order("created_at",{ascending:!0});if(r)throw r;const{data:a,error:n}=await x.from("dog_parks").select("*").in("status",["pending","second_stage_review"]).order("created_at",{ascending:!0});if(n)throw n;J(s||[]),B(a||[]),q({pendingVaccines:s?.length||0,pendingParks:a?.length||0,unreadMessages:0,pendingUsers:0})}catch(s){S("error","Error fetching task data",{error:s}),o("タスクデータの取得に失敗しました")}finally{E(!1)}},$=async(s,r)=>{N(!0),o(""),j("");try{const a=u.find(f=>f.id===s);if(!a)throw new Error("ワクチン証明書が見つかりません");const{error:n}=await x.from("vaccine_certifications").update({status:r?"approved":"rejected",reviewed_at:new Date().toISOString()}).eq("id",s);if(n)throw n;const{error:g}=await x.from("notifications").insert([{user_id:a.dog.owner.id,type:"vaccine_review",title:r?"ワクチン証明書が承認されました":"ワクチン証明書について",message:r?`${a.dog.name}のワクチン証明書が承認されました。ドッグランのご利用が可能になりました。`:`${a.dog.name}のワクチン証明書の確認が必要です。マイページから再度アップロードしてください。`,data:{vaccine_id:s,dog_id:a.dog_id}}]);if(g)throw g;j(`ワクチン証明書を${r?"承認":"却下"}しました`),await w()}catch(a){S("error","Error processing vaccine",{error:a}),o("ワクチン証明書の処理に失敗しました")}finally{N(!1)}},V=async(s,r)=>{N(!0),o(""),j("");try{const a=b.find(O=>O.id===s);if(!a)throw new Error("ドッグランが見つかりません");let n="";r?n=a.status==="pending"?"first_stage_passed":"qr_testing":n="rejected";const{error:g}=await x.from("dog_parks").update({status:n,reviewed_at:new Date().toISOString()}).eq("id",s);if(g)throw g;const{error:f}=await x.from("notifications").insert([{user_id:a.owner_id,type:"park_review",title:r?"審査結果のお知らせ":"審査結果について",message:r?`${a.name}の審査が通過しました。${a.status==="pending"?"詳細情報の入力にお進みください。":"QRコード実証検査の準備に入ります。"}`:`${a.name}の審査が不通過となりました。詳細はダッシュボードをご確認ください。`,data:{park_id:s}}]);if(f)throw f;j(`ドッグランを${r?"承認":"却下"}しました`),await w()}catch(a){S("error","Error processing park",{error:a}),o("ドッグランの処理に失敗しました")}finally{N(!1)}},v=()=>t.pendingVaccines+t.pendingParks+t.unreadMessages+t.pendingUsers;return U?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(k,{to:"/admin",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(L,{className:"w-8 h-8 text-red-600 mr-3"}),"緊急対応タスク"]}),e.jsx("p",{className:"text-gray-600",children:"承認待ちの項目を確認・処理してください"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["合計タスク数: ",v(),"件"]})]}),C&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[e.jsx(L,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:C})]}),D&&e.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 flex items-start",children:[e.jsx(d,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:D})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(i,{className:`p-6 cursor-pointer transition-all ${l==="vaccines"?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"}`,onClick:()=>h("vaccines"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"ワクチン証明書"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:t.pendingVaccines}),e.jsx("p",{className:"text-xs text-gray-500",children:"承認待ち"})]}),e.jsx(M,{className:"w-8 h-8 text-red-600"})]})}),e.jsx(i,{className:`p-6 cursor-pointer transition-all ${l==="parks"?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"}`,onClick:()=>h("parks"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"ドッグラン審査"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:t.pendingParks}),e.jsx("p",{className:"text-xs text-gray-500",children:"審査待ち"})]}),e.jsx(A,{className:"w-8 h-8 text-orange-600"})]})}),e.jsx(i,{className:`p-6 cursor-pointer transition-all ${l==="messages"?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"}`,onClick:()=>h("messages"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"お問い合わせ"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:t.unreadMessages}),e.jsx("p",{className:"text-xs text-gray-500",children:"未読"})]}),e.jsx(y,{className:"w-8 h-8 text-purple-600"})]})}),e.jsx(i,{className:`p-6 cursor-pointer transition-all ${l==="overview"?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"}`,onClick:()=>h("overview"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"全体概要"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:v()}),e.jsx("p",{className:"text-xs text-gray-500",children:"総タスク数"})]}),e.jsx(F,{className:"w-8 h-8 text-blue-600"})]})})]}),l==="overview"&&e.jsx("div",{className:"space-y-6",children:e.jsxs(i,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"タスク概要"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-3",children:"優先度の高いタスク"}),e.jsxs("div",{className:"space-y-2",children:[t.pendingVaccines>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"text-sm",children:"ワクチン証明書承認"})]}),e.jsxs("span",{className:"text-sm font-medium text-red-600",children:[t.pendingVaccines,"件"]})]}),t.pendingParks>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-orange-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"w-4 h-4 text-orange-600"}),e.jsx("span",{className:"text-sm",children:"ドッグラン審査"})]}),e.jsxs("span",{className:"text-sm font-medium text-orange-600",children:[t.pendingParks,"件"]})]}),t.unreadMessages>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{className:"w-4 h-4 text-purple-600"}),e.jsx("span",{className:"text-sm",children:"お問い合わせ対応"})]}),e.jsxs("span",{className:"text-sm font-medium text-purple-600",children:[t.unreadMessages,"件"]})]}),v()===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"すべてのタスクが完了しています"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-3",children:"処理時間の目安"}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:"ワクチン証明書: 2-3分/件"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:"ドッグラン審査: 5-10分/件"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:"お問い合わせ: 3-5分/件"})]})]})]})]})]})}),l==="vaccines"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"ワクチン証明書承認待ち"}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t.pendingVaccines,"件の承認待ち"]})]}),u.length===0?e.jsxs(i,{className:"text-center py-12",children:[e.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"承認待ちのワクチン証明書はありません"})]}):e.jsx("div",{className:"space-y-4",children:u.map(s=>e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("h3",{className:"font-semibold",children:s.dog.name}),e.jsxs("span",{className:"text-sm text-gray-500",children:["飼い主: ",s.dog.owner.name]}),e.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full",children:"承認待ち"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-600",children:["犬種: ",s.dog.breed]}),e.jsxs("p",{className:"text-gray-600",children:["性別: ",s.dog.gender]}),e.jsxs("p",{className:"text-gray-600",children:["申請日: ",new Date(s.created_at).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-600",children:["狂犬病ワクチン期限: ",s.rabies_expiry_date?new Date(s.rabies_expiry_date).toLocaleDateString("ja-JP"):"未設定"]}),e.jsxs("p",{className:"text-gray-600",children:["混合ワクチン期限: ",s.combo_expiry_date?new Date(s.combo_expiry_date).toLocaleDateString("ja-JP"):"未設定"]})]})]})]}),e.jsxs("div",{className:"flex space-x-2 ml-4",children:[e.jsx(k,{to:`/admin/management?tab=vaccines&vaccine=${s.id}`,children:e.jsxs(m,{size:"sm",variant:"secondary",children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),"詳細"]})}),e.jsxs(m,{size:"sm",onClick:()=>$(s.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:p,children:[e.jsx(d,{className:"w-4 h-4 mr-1"}),"承認"]}),e.jsxs(m,{size:"sm",onClick:()=>$(s.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:p,children:[e.jsx(z,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},s.id))})]}),l==="parks"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"ドッグラン審査待ち"}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t.pendingParks,"件の審査待ち"]})]}),b.length===0?e.jsxs(i,{className:"text-center py-12",children:[e.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"審査待ちのドッグランはありません"})]}):e.jsx("div",{className:"space-y-4",children:b.map(s=>e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("h3",{className:"font-semibold",children:s.name}),e.jsx("span",{className:"text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full",children:s.status==="pending"?"第一審査待ち":"第二審査待ち"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-600",children:["住所: ",s.address]}),e.jsxs("p",{className:"text-gray-600",children:["料金: ¥",s.price,"/時間"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-600",children:["申請日: ",new Date(s.created_at).toLocaleDateString("ja-JP")]}),e.jsxs("p",{className:"text-gray-600",children:["審査段階: ",s.status==="pending"?"第一審査":"第二審査"]})]})]})]}),e.jsxs("div",{className:"flex space-x-2 ml-4",children:[e.jsx(k,{to:`/admin/management?tab=parks&park=${s.id}`,children:e.jsxs(m,{size:"sm",variant:"secondary",children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),"詳細"]})}),e.jsxs(m,{size:"sm",onClick:()=>V(s.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:p,children:[e.jsx(d,{className:"w-4 h-4 mr-1"}),"承認"]}),e.jsxs(m,{size:"sm",onClick:()=>V(s.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:p,children:[e.jsx(z,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},s.id))})]}),l==="messages"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"お問い合わせ対応"}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t.unreadMessages,"件の未読"]})]}),e.jsxs(i,{className:"text-center py-12",children:[e.jsx(y,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"お問い合わせ機能は準備中です"}),e.jsx("p",{className:"text-sm text-gray-500",children:"現在はメールでのお問い合わせ対応となります"})]})]})]})}export{I as AdminTasks};
