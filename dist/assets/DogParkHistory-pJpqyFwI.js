import{j as e,J as ne,i as p,p as T,b as Y,G as ce,a0 as ie,D as de,C as oe,P as me,x as xe,X as he,U as z,A as q,g as ue}from"./ui-vendor-w2MLOks7.js";import{u as ge,r,L as u}from"./react-vendor-_GyjDmDn.js";import{u as pe,s as v,C as m,B as o}from"./index-pj4YkVsE.js";import{I as je}from"./Input-BBFNs-Kh.js";import"./supabase-vendor-Df9iqQzW.js";function we(){const{user:j}=pe(),C=ge(),[S,R]=r.useState([]),[A,D]=r.useState(!0),[g,B]=r.useState(""),[f,O]=r.useState("all"),[b,U]=r.useState(new Date().getFullYear().toString()),[N,V]=r.useState("all"),[J,H]=r.useState([]),[G,X]=r.useState(0),[K,Q]=r.useState(0),[W,Z]=r.useState(""),[L,ee]=r.useState([]),[P,$]=r.useState(null),[w,_]=r.useState(null),[M,y]=r.useState(null),[E,k]=r.useState(null);r.useEffect(()=>{j?I():C("/login")},[j,C]);const I=async()=>{try{D(!0);const{data:s,error:t}=await v.from("reservations").select(`
          *,
          dog_park:dog_parks(*),
          dog:dogs(*)
        `).eq("user_id",j?.id).order("date",{ascending:!1}).limit(50);if(t)throw t;const{data:l,error:c}=await v.from("dogs").select("*").eq("owner_id",j?.id);if(c)throw c;if(R(s||[]),H(l||[]),s){X(s.length);const d=new Set(s.map(a=>a.park_id));Q(d.size);const i={};s.forEach(a=>{const h=a.park_id;i[h]||(i[h]={count:0,name:a.dog_park.name,id:h}),i[h].count++});const n=Object.values(i).sort((a,h)=>h.count-a.count).slice(0,3).map(a=>({id:a.id,name:a.name,visits:a.count}));ee(n),n.length>0&&Z(n[0].name)}}catch(s){console.error("Error fetching reservation history:",s)}finally{D(!1)}},F=s=>["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"][s-1],se=()=>{const s=new Date().getFullYear(),t=[];for(let l=s;l>=s-2;l--)t.push({value:l.toString(),label:`${l}年`});return t},te=()=>{const s=[{value:"all",label:"すべての月"}];for(let t=1;t<=12;t++)s.push({value:t.toString(),label:F(t)});return s},x=r.useMemo(()=>S.filter(s=>{const t=s.dog_park.name.toLowerCase().includes(g.toLowerCase())||s.dog_park.address.toLowerCase().includes(g.toLowerCase())||s.dog.name.toLowerCase().includes(g.toLowerCase()),l=f==="all"||s.dog_id===f,c=new Date(s.date),d=b==="all"||c.getFullYear().toString()===b,i=N==="all"||(c.getMonth()+1).toString()===N;return t&&l&&d&&i}),[S,g,f,b,N]),ae=()=>{if(x.length===0)return;const s="\uFEFF",t=["日付","時間","ドッグラン名","住所","ワンちゃん","料金","予約タイプ"].join(","),l=x.map(a=>[new Date(a.date).toLocaleDateString("ja-JP"),`${a.start_time}〜${parseInt(a.start_time)+a.duration}:00`,`"${a.dog_park.name.replace(/"/g,'""')}"`,`"${a.dog_park.address.replace(/"/g,'""')}"`,`"${a.dog.name.replace(/"/g,'""')}"`,`¥${a.total_amount}`,a.reservation_type==="regular"?"通常利用":a.reservation_type==="private_booth"?"プライベートブース":"施設貸し切り"].join(",")),c=s+[t,...l].join(`
`),d=new Blob([c],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(d),n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download",`dogpark_history_${new Date().toISOString().split("T")[0]}.csv`),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)},le=async s=>{const t=s.reservation_type==="whole_facility",l=new Date,c=new Date(s.date),d=new Date(c);if(d.setDate(c.getDate()-1),t)return l<d;{const{data:i}=await v.from("user_entry_exit_logs").select("*").eq("user_id",s.user_id).eq("park_id",s.park_id).eq("action","entry").gte("timestamp",s.date);return!i||i.length===0}},re=async s=>{$(s.id),y(null),k(null);try{const{data:t,error:l}=await v.rpc("cancel_reservation",{p_reservation_id:s.id,p_user_id:s.user_id});if(l||!t?.success){y(t&&t.message||l?.message||"キャンセルに失敗しました");return}k("予約をキャンセルしました"),_(null),await I(),setTimeout(()=>k(null),3e3)}catch(t){y(t.message||"キャンセルに失敗しました")}finally{$(null)}};return A?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(u,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(p,{className:"w-8 h-8 text-blue-600 mr-3"}),"ドッグラン利用履歴"]}),e.jsx("p",{className:"text-lg text-gray-600",children:"これまでのドッグラン利用記録を確認できます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(m,{className:"p-6 text-center",children:[e.jsx(p,{className:"w-12 h-12 text-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:G}),e.jsx("p",{className:"text-gray-600",children:"総利用回数"})]}),e.jsxs(m,{className:"p-6 text-center",children:[e.jsx(T,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:K}),e.jsx("p",{className:"text-gray-600",children:"訪問したドッグラン数"})]}),e.jsxs(m,{className:"p-6 text-center",children:[e.jsx(Y,{className:"w-12 h-12 text-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-xl font-bold text-gray-900 mb-1",children:W||"-"}),e.jsx("p",{className:"text-gray-600",children:"最も訪問したドッグラン"})]})]}),L.length>0&&e.jsxs(m,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(ce,{className:"w-6 h-6 text-pink-600 mr-2"}),"よく行くドッグラン"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:L.map((s,t)=>e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-600 font-bold",children:t+1}),e.jsx("h3",{className:"font-semibold",children:s.name})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"w-4 h-4 text-gray-500 mr-1"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[s.visits,"回利用"]})]}),e.jsx(u,{to:`/parks/${s.id}`,children:e.jsx(o,{size:"sm",variant:"secondary",children:"詳細"})})]})]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(je,{label:"",value:g,onChange:s=>B(s.target.value),placeholder:"ドッグラン名、住所で検索...",icon:e.jsx(ie,{className:"w-4 h-4 text-gray-500"})})}),e.jsx("div",{children:e.jsxs("select",{value:f,onChange:s=>O(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべてのワンちゃん"}),J.map(s=>e.jsxs("option",{value:s.id,children:[s.name,"ちゃん"]},s.id))]})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("select",{value:b,onChange:s=>U(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべての年"}),se().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx("select",{value:N,onChange:s=>V(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:te().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(o,{variant:"secondary",size:"sm",onClick:ae,children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),x.length===0?e.jsxs(m,{className:"text-center py-12",children:[e.jsx(p,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"利用履歴がありません"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"まだドッグランを利用していないようです"}),e.jsx(u,{to:"/parks",children:e.jsx(o,{children:"ドッグランを予約する"})})]}):e.jsx("div",{className:"space-y-6",children:x.map(s=>{const t=new Date(s.date),l=t.toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),c=s.start_time,d=`${parseInt(c)+s.duration}:00`,i=s.reservation_type==="regular"?"通常利用":s.reservation_type==="private_booth"?"プライベートブース":"施設貸し切り";return e.jsxs(m,{className:"p-6 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start gap-4",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsxs("div",{className:"bg-blue-100 rounded-lg p-3 text-center min-w-[80px]",children:[e.jsx("p",{className:"text-sm text-blue-800",children:t.getFullYear()}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:t.getDate()}),e.jsx("p",{className:"text-sm text-blue-800",children:F(t.getMonth()+1)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:s.dog_park.name}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(Y,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:s.dog_park.address})]}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(oe,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-sm",children:[c," 〜 ",d]})]}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(me,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-sm",children:[s.dog.name,"ちゃん（",s.dog.breed,"）"]})]}),Math.random()>.5&&e.jsx("div",{className:"flex items-center mt-2",children:[1,2,3,4,5].map(n=>e.jsx(xe,{className:`w-4 h-4 ${n<=Math.floor(3+Math.random()*2)?"text-yellow-400 fill-current":"text-gray-300"}`},n))})]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",s.total_amount.toLocaleString()]})}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${s.reservation_type==="regular"?"bg-blue-100 text-blue-800":s.reservation_type==="private_booth"?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"}`,children:i})}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${s.status==="confirmed"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.status==="confirmed"?"利用済み":"キャンセル"})})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 flex justify-between items-center",children:[e.jsx("div",{className:"text-sm text-gray-500",children:l}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(u,{to:`/parks/${s.park_id}`,children:e.jsxs(o,{size:"sm",variant:"secondary",children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),"施設詳細"]})}),e.jsx(u,{to:`/parks/${s.park_id}/reserve`,children:e.jsxs(o,{size:"sm",children:[e.jsx(p,{className:"w-4 h-4 mr-1"}),"再予約"]})}),s.status==="confirmed"&&e.jsxs(o,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",isLoading:P===s.id,onClick:async()=>{await le(s)?_(s.id):y("この予約はキャンセルできません（貸し切りは1日前まで、通常予約はPIN未使用時のみ）")},children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]})]},s.id)})}),x.length>0&&e.jsx(m,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(z,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"コミュニティ機能"}),e.jsx("p",{className:"text-sm text-blue-800 mb-3",children:"同じドッグランを利用した他のワンちゃんとの出会いを「コミュニティ」ページで確認できます。 友達申請を送ったり、次回の予約を調整したりして、ワンちゃん同士の交流を深めましょう。"}),e.jsx(u,{to:"/community",children:e.jsxs(o,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"コミュニティを見る"]})})]})]})}),w&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(q,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"予約をキャンセルしますか？"}),e.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(o,{variant:"secondary",onClick:()=>_(null),children:"戻る"}),e.jsx(o,{className:"bg-red-600 hover:bg-red-700",isLoading:P===w,onClick:()=>{const s=x.find(t=>t.id===w);s&&re(s)},children:"キャンセルする"})]})]})}),E&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:E})]})}),M&&e.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),e.jsx("p",{className:"text-red-700 mt-1",children:M})]})]})}export{we as DogParkHistory};
