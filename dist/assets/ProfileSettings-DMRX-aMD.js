import{u as e,b as s,j as a,B as r}from"./index-rzoKNnex.js";import{u as t,r as l,L as n}from"./vendor-Cwmn0chA.js";import{C as i}from"./Card-CRM3w0N8.js";import{I as d}from"./Input-DdOgOQvG.js";import{l as c,f as m}from"./postalCodeLookup-BVBMVLy5.js";import{V as o,U as x,x as h,H as j,y as u,h as p,l as b,i as g,M as f,c as w,b as N,o as v,p as y,ak as P,m as S,K as _,z as C,al as k,a as z,X as E}from"./ui-CMSAjam7.js";import"./supabase-Dzr8oIt2.js";function L(){const{user:L}=e(),q=t(),[D,F]=l.useState(!0),[A,I]=l.useState(!1),[U,T]=l.useState(""),[$,O]=l.useState(""),[W,B]=l.useState({name:"",postal_code:"",address:"",phone_number:"",email:""}),[H,K]=l.useState(!1),[M,V]=l.useState(!1),[G,J]=l.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[Q,R]=l.useState(""),[X,Y]=l.useState(!1),[Z,ee]=l.useState(!1),[se,ae]=l.useState(""),[re,te]=l.useState(""),[le,ne]=l.useState(""),[ie,de]=l.useState(!1),[ce,me]=l.useState(""),[oe,xe]=l.useState([]),[he,je]=l.useState("loading");l.useEffect((()=>{L?(ue(),pe()):q("/login")}),[L,q]);const ue=async()=>{try{F(!0);const{data:e,error:a}=await s.from("profiles").select("*").eq("id",null==L?void 0:L.id).single();if(a)throw a;B({name:e.name||"",postal_code:e.postal_code||"",address:e.address||"",phone_number:e.phone_number||"",email:(null==L?void 0:L.email)||""})}catch(e){T(e.message||"プロフィールの取得に失敗しました。")}finally{F(!1)}},pe=async()=>{try{je("loading");const{data:e,error:a}=await s.auth.mfa.listFactors();if(a)throw a;const r=e.totp.filter((e=>"verified"===e.status));xe(r),je(r.length>0?"enabled":"disabled")}catch(e){je("disabled")}},be=async e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:W.postal_code})(e);if(B({...W,postal_code:s}),7===s.replace(/-/g,"").length){de(!0),me("");try{const e=await c(s);if(e.success&&e.results&&e.results.length>0){const s=m(e.results[0]);B((e=>({...e,address:s})))}else me(e.message||"住所が見つかりませんでした")}catch(a){me("住所の検索中にエラーが発生しました")}finally{de(!1)}}};return D?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(n,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[a.jsx(o,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[a.jsx(x,{className:"w-8 h-8 text-blue-600 mr-3"}),"プロフィール設定"]}),a.jsx("p",{className:"text-lg text-gray-600",children:"アカウント情報を管理します"})]}),a.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[a.jsx(n,{to:"/payment-method-settings",children:a.jsxs(r,{variant:"secondary",size:"sm",children:[a.jsx(h,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),a.jsx(n,{to:"/dogpark-history",children:a.jsxs(r,{variant:"secondary",size:"sm",children:[a.jsx(j,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),a.jsx(n,{to:"/orders",children:a.jsxs(r,{variant:"secondary",size:"sm",children:[a.jsx(u,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),a.jsx(n,{to:"/shop",children:a.jsxs(r,{variant:"secondary",size:"sm",children:[a.jsx(p,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),a.jsx(i,{className:"p-6",children:a.jsxs("form",{onSubmit:async e=>{e.preventDefault(),I(!0),T(""),O("");try{if(!W.name.trim())throw new Error("お名前を入力してください");if(W.postal_code&&!W.postal_code.match(/^\d{3}-\d{4}$/))throw new Error("郵便番号は正しい形式で入力してください（例：123-4567）");if(W.phone_number&&!W.phone_number.match(/^0\d{2,3}-\d{1,4}-\d{4}$/))throw new Error("電話番号は正しい形式で入力してください（例：090-1234-5678）");const{error:e}=await s.from("profiles").update({name:W.name,postal_code:W.postal_code,address:W.address,phone_number:W.phone_number}).eq("id",null==L?void 0:L.id);if(e)throw e;if((null==L?void 0:L.email)!==W.email){const{error:e}=await s.auth.updateUser({email:W.email});if(e)throw e}O("プロフィールを更新しました"),setTimeout((()=>{O("")}),3e3)}catch(a){T(a.message||"プロフィールの更新に失敗しました")}finally{I(!1)}},children:[U&&a.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[a.jsx(b,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),a.jsx("p",{className:"text-red-800",children:U})]}),$&&a.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[a.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),a.jsx("p",{className:"text-green-800",children:$})]}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[a.jsx(x,{className:"w-6 h-6 text-blue-600"}),a.jsx("h2",{className:"text-xl font-semibold",children:"基本情報"})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[a.jsx(d,{label:"お名前 *",value:W.name,onChange:e=>B({...W,name:e.target.value}),required:!0,icon:a.jsx(x,{className:"w-4 h-4 text-gray-500"})}),a.jsx(d,{label:"メールアドレス *",type:"email",value:W.email,onChange:e=>B({...W,email:e.target.value}),required:!0,icon:a.jsx(f,{className:"w-4 h-4 text-gray-500"})})]}),a.jsxs("div",{className:"flex items-center space-x-3 mb-6 mt-8",children:[a.jsx(w,{className:"w-6 h-6 text-blue-600"}),a.jsx("h2",{className:"text-xl font-semibold",children:"住所情報"})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"mb-4 relative",children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 ",a.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:a.jsx(N,{className:"h-4 w-4 text-gray-500"})}),a.jsx("input",{type:"text",value:W.postal_code,onChange:e=>be(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${ce?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8}),ie&&a.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:a.jsx(v,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),ce&&a.jsx("p",{className:"mt-1 text-sm text-red-600",children:ce})]}),a.jsx(d,{label:"電話番号",value:W.phone_number,onChange:e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:W.phone_number})(e.target.value);B({...W,phone_number:s})},placeholder:"090-1234-5678",maxLength:13,icon:a.jsx(y,{className:"w-4 h-4 text-gray-500"})})]}),a.jsx("div",{className:"col-span-2",children:a.jsx(d,{label:"住所",value:W.address,onChange:e=>B({...W,address:e.target.value}),placeholder:"東京都渋谷区渋谷1-1-1",icon:a.jsx(w,{className:"w-4 h-4 text-gray-500"})})}),a.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:a.jsxs("p",{className:"text-sm text-blue-800",children:[a.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),a.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",a.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",a.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),a.jsx("div",{className:"flex justify-end",children:a.jsxs(r,{type:"submit",isLoading:A,className:"bg-blue-600 hover:bg-blue-700",children:[a.jsx(P,{className:"w-4 h-4 mr-2"}),"保存する"]})})]})]})}),a.jsxs(i,{className:"p-6 bg-gray-50",children:[a.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[a.jsx(S,{className:"w-6 h-6 text-yellow-600"}),a.jsx("h2",{className:"text-xl font-semibold",children:"アカウント設定"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[a.jsx("h3",{className:"font-semibold mb-2",children:"パスワード変更"}),a.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを保つため、定期的にパスワードを変更することをおすすめします。"}),a.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>K(!0),children:[a.jsx(_,{className:"w-4 h-4 mr-2"}),"パスワードを変更"]})]}),a.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[a.jsx("h3",{className:"font-semibold mb-2",children:"アカウント削除"}),a.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントを削除すると、すべてのデータが完全に削除され、復元できなくなります。"}),a.jsxs(r,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>V(!0),children:[a.jsx(C,{className:"w-4 h-4 mr-2"}),"アカウントを削除"]})]}),a.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[a.jsx("h3",{className:"font-semibold mb-2",children:"2ファクタ認証（2FA）"}),a.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを強化するため、2ファクタ認証の設定をおすすめします。"}),"loading"===he?a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(v,{className:"w-4 h-4 animate-spin"}),a.jsx("span",{className:"text-sm text-gray-600",children:"読み込み中..."})]}):"enabled"===he?a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[a.jsx(g,{className:"w-4 h-4"}),a.jsx("span",{className:"text-sm font-medium",children:"2FAが有効です"})]}),oe.map((e=>a.jsxs("div",{className:"flex items-center justify-between p-2 bg-green-50 rounded border border-green-200",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(k,{className:"w-4 h-4 text-green-600"}),a.jsx("span",{className:"text-sm",children:e.friendly_name||"認証アプリ"})]}),a.jsx(r,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>(async e=>{if(confirm("2ファクタ認証を無効にしますか？セキュリティが低下します。"))try{const{error:a}=await s.auth.mfa.unenroll({factorId:e});if(a)throw a;await pe()}catch(a){T("2FAの無効化に失敗しました")}})(e.id),children:"無効化"})]},e.id)))]}):a.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{q("/two-factor-setup")},children:[a.jsx(z,{className:"w-4 h-4 mr-2"}),"2FAを有効化"]})]})]})]}),H&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h3",{className:"text-xl font-bold",children:"パスワード変更"}),a.jsx("button",{onClick:()=>{K(!1),ae(""),te(""),J({currentPassword:"",newPassword:"",confirmPassword:""})},className:"text-gray-500 hover:text-gray-700",children:a.jsx(E,{className:"w-6 h-6"})})]}),se&&a.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:a.jsxs("div",{className:"flex items-start space-x-2",children:[a.jsx(b,{className:"w-5 h-5 text-red-600 mt-0.5"}),a.jsx("p",{className:"text-sm text-red-800",children:se})]})}),re&&a.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:a.jsxs("div",{className:"flex items-start space-x-2",children:[a.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5"}),a.jsx("p",{className:"text-sm text-green-800",children:re})]})}),a.jsx("form",{onSubmit:async e=>{e.preventDefault(),Y(!0),ae(""),te("");try{if(!G.currentPassword)throw new Error("現在のパスワードを入力してください");if(!G.newPassword)throw new Error("新しいパスワードを入力してください");if(G.newPassword.length<6)throw new Error("パスワードは6文字以上で入力してください");if(G.newPassword!==G.confirmPassword)throw new Error("新しいパスワードと確認用パスワードが一致しません");const{error:e}=await s.auth.signInWithPassword({email:(null==L?void 0:L.email)||"",password:G.currentPassword});if(e)throw new Error("現在のパスワードが正しくありません");const{error:a}=await s.auth.updateUser({password:G.newPassword});if(a)throw a;te("パスワードを変更しました"),J({currentPassword:"",newPassword:"",confirmPassword:""}),setTimeout((()=>{K(!1),te("")}),3e3)}catch(a){ae(a.message||"パスワードの変更に失敗しました")}finally{Y(!1)}},children:a.jsxs("div",{className:"space-y-4",children:[a.jsx(d,{label:"現在のパスワード *",type:"password",value:G.currentPassword,onChange:e=>J({...G,currentPassword:e.target.value}),required:!0}),a.jsx(d,{label:"新しいパスワード *",type:"password",value:G.newPassword,onChange:e=>J({...G,newPassword:e.target.value}),required:!0,minLength:6}),a.jsx(d,{label:"新しいパスワード（確認） *",type:"password",value:G.confirmPassword,onChange:e=>J({...G,confirmPassword:e.target.value}),required:!0,minLength:6}),a.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:a.jsxs("p",{className:"text-sm text-blue-800",children:[a.jsx("span",{className:"font-medium",children:"パスワードの要件"}),a.jsx("br",{}),"• 6文字以上",a.jsx("br",{}),"• 英数字を含めることをおすすめします",a.jsx("br",{}),"• 以前使用したパスワードと異なるものを使用してください"]})}),a.jsxs("div",{className:"flex justify-end space-x-3",children:[a.jsx(r,{type:"button",variant:"secondary",onClick:()=>{K(!1),ae(""),te(""),J({currentPassword:"",newPassword:"",confirmPassword:""})},children:"キャンセル"}),a.jsx(r,{type:"submit",isLoading:X,children:"パスワードを変更"})]})]})})]})}),M&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h3",{className:"text-xl font-bold text-red-600",children:"アカウント削除"}),a.jsx("button",{onClick:()=>{V(!1),ne(""),R("")},className:"text-gray-500 hover:text-gray-700",children:a.jsx(E,{className:"w-6 h-6"})})]}),le&&a.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:a.jsxs("div",{className:"flex items-start space-x-2",children:[a.jsx(b,{className:"w-5 h-5 text-red-600 mt-0.5"}),a.jsx("p",{className:"text-sm text-red-800",children:le})]})}),a.jsx("div",{className:"p-4 bg-red-50 rounded-lg mb-4",children:a.jsxs("div",{className:"flex items-start space-x-2",children:[a.jsx(b,{className:"w-5 h-5 text-red-600 mt-0.5"}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium text-red-800 mb-1",children:"警告: この操作は取り消せません"}),a.jsx("p",{className:"text-sm text-red-700",children:"アカウントを削除すると、以下のデータがすべて完全に削除されます："}),a.jsxs("ul",{className:"text-sm text-red-700 list-disc list-inside mt-2 space-y-1",children:[a.jsx("li",{children:"プロフィール情報"}),a.jsx("li",{children:"登録したワンちゃんの情報"}),a.jsx("li",{children:"予約履歴"}),a.jsx("li",{children:"支払い情報"}),a.jsx("li",{children:"友達リストとメッセージ"})]})]})]})}),a.jsx("form",{onSubmit:async e=>{e.preventDefault(),ee(!0),ne("");try{if("delete"!==Q)throw new Error("確認のため「delete」と入力してください");const{error:e}=await s.auth.admin.deleteUser((null==L?void 0:L.id)||"");if(e)throw e;await s.auth.signOut(),q("/",{replace:!0})}catch(a){ne(a.message||"アカウントの削除に失敗しました")}finally{ee(!1)}},children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"確認のため「delete」と入力してください *"}),a.jsx("input",{type:"text",value:Q,onChange:e=>R(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),a.jsxs("div",{className:"flex justify-end space-x-3",children:[a.jsx(r,{type:"button",variant:"secondary",onClick:()=>{V(!1),ne(""),R("")},children:"キャンセル"}),a.jsx(r,{type:"submit",isLoading:Z,className:"bg-red-600 hover:bg-red-700",disabled:"delete"!==Q,children:"アカウントを削除"})]})]})})]})})]})}export{L as ProfileSettings};
