import{u as e,j as s,B as a,s as t}from"./index-T-nty6Ge.js";import{r,h as l,u as i,L as c}from"./vendor-BHVjIt_u.js";import{C as n}from"./Card-DW8Xk96S.js";import{n as d,K as o,q as m,k as x,Y as h,i as p,r as u,z as g,g as j,N as f,I as N,P as b,s as v,R as w,b as y,h as _,V as k,a as S,t as I,X as C,Z as D,_ as q}from"./ui-srxHNTHo.js";import{I as R}from"./Input-B9o2mE6T.js";import{S as $}from"./Select-vQESp9mw.js";import"./supabase-CKbzEL5D.js";function T({lockId:l,className:i="",variant:c="primary",size:n="md",label:u="ドアを開ける",showStatus:g=!0,onSuccess:j,onError:f,reservationId:N}){const{user:b}=e(),[v,w]=r.useState(!1),[y,_]=r.useState(null),[k,S]=r.useState(null),[I,C]=r.useState(!1),[D,q]=r.useState("");r.useEffect((()=>{if(k){const e=setTimeout((()=>{S(null)}),3e3);return()=>clearTimeout(e)}}),[k]),r.useEffect((()=>{if(y){const e=setTimeout((()=>{_(null)}),5e3);return()=>clearTimeout(e)}}),[y]);return s.jsxs("div",{className:"space-y-2",children:[s.jsxs(a,{onClick:async()=>{if(b){w(!0),_(null),S(null);try{const{data:{session:e}}=await t.auth.getSession();if(!e?.access_token)throw new Error("認証が必要です");let s=5,a=null;if(N){const e=await(async e=>{try{const{data:s,error:a}=await t.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("id",e).single();return a?null:s}catch(s){return null}})(N);if(e&&"whole_facility"===e.reservation_type&&(a=(e=>{try{const s=new Date(e.date),[a,t]=e.start_time.split(":").map(Number);return s.setHours(a,t,0,0),new Date(s.getTime()+60*e.duration*60*1e3)}catch(s){return null}})(e),a)){const e=new Date,t=a.getTime()-e.getTime();s=Math.max(1,Math.ceil(t/6e4))}}const r=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/generate-pin",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({lock_id:l,purpose:"entry",expiry_minutes:s,reservation_id:N||void 0})});if(!r.ok){const e=await r.json();throw new Error(e.error||"PINコードの生成に失敗しました")}const{pin:i}=await r.json();alert(`PINコード: ${i}\n\nこのPINコードをスマートロックのキーパッドに入力してください。`),S(i),j&&j()}catch(e){if(e.message&&e.message.startsWith("PAYMENT_REQUIRED:")){const s=e.message.replace("PAYMENT_REQUIRED:","").trim();q(s),C(!0),_(null)}else _(e.message||"PINコードの生成に失敗しました"),C(!1);f&&f(e.message||"PINコードの生成に失敗しました")}finally{w(!1)}}},isLoading:v,variant:c,size:n,className:`flex items-center ${i}`,children:[v?s.jsx(d,{className:"w-4 h-4 mr-2 animate-spin"}):s.jsx(o,{className:"w-4 h-4 mr-2"}),u]}),g&&s.jsxs(s.Fragment,{children:[k&&s.jsxs("div",{className:"flex items-center text-green-600 text-sm mt-1",children:[s.jsx(m,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:"PINコードを生成しました"})]}),y&&s.jsxs("div",{className:"flex items-center text-red-600 text-sm mt-1",children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:y})]}),I&&s.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200 mt-2",children:[s.jsxs("div",{className:"flex items-start space-x-2 mb-3",children:[s.jsx(h,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-blue-900 mb-1",children:"決済が必要です"}),s.jsx("p",{className:"text-sm text-blue-800",children:D})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(a,{onClick:()=>window.location.href="/subscription",size:"sm",className:"w-full bg-purple-600 hover:bg-purple-700",children:[s.jsx(h,{className:"w-3 h-3 mr-1"}),"サブスク加入"]}),s.jsxs(a,{onClick:()=>window.location.href="/parks",size:"sm",variant:"secondary",className:"w-full",children:[s.jsx(p,{className:"w-3 h-3 mr-1"}),"1日券購入"]})]})]})]})]})}function P({park:e,parkImages:a,todayRentals:t,onImageClick:r}){const l=function(e,s){const a=e/s*100;return a<25?{text:"空いています",color:"text-green-600 bg-green-100"}:a<50?{text:"やや空いています",color:"text-blue-600 bg-blue-100"}:a<75?{text:"やや混んでいます",color:"text-yellow-600 bg-yellow-100"}:{text:"混んでいます",color:"text-red-600 bg-red-100"}}(e.current_occupancy,e.max_capacity);return s.jsx(s.Fragment,{children:a.length>0&&s.jsxs("div",{className:"relative h-64 rounded-lg overflow-hidden",children:[s.jsx("img",{src:a[0].url,alt:e.name,className:"w-full h-full object-cover cursor-pointer",onClick:()=>r(0),onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),s.jsx("div",{className:"absolute top-4 right-4",children:s.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${l.color}`,children:l.text})}),t.length>0&&s.jsx("div",{className:"absolute top-4 left-4",children:s.jsx("span",{className:"px-3 py-1 rounded-full text-sm font-medium bg-orange-500 text-white",children:"本日貸し切りあり"})})]})})}function E({parkImages:e,onImageClick:a}){return e.length<=1?null:s.jsxs("div",{className:"grid grid-cols-5 gap-2",children:[e.slice(1,6).map(((e,t)=>s.jsx("div",{className:"h-20 rounded-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>a(t+1),children:s.jsx("img",{src:e.url,alt:e.caption||`画像 ${t+2}`,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})},e.id))),e.length>6&&s.jsxs("div",{className:"h-20 rounded-lg overflow-hidden cursor-pointer relative bg-gray-200 flex items-center justify-center",onClick:()=>a(6),children:[s.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:s.jsxs("span",{className:"text-white font-medium",children:["+",e.length-6]})}),s.jsx("img",{src:e[6].url,alt:"その他の画像",className:"w-full h-full object-cover opacity-60"})]})]})}function F({park:e}){return s.jsxs(n,{className:"p-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"設備・サービス"}),s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:Object.entries({parking:"駐車場",shower:"シャワー設備",restroom:"トイレ",agility:"アジリティ設備",rest_area:"休憩スペース",water_station:"給水設備"}).map((([a,t])=>s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("div",{className:"w-4 h-4 rounded "+(e.facilities[a]?"bg-green-500":"bg-gray-300")}),s.jsx("span",{className:"text-sm",children:t})]},a)))}),e.facility_details&&s.jsx("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg",children:s.jsx("p",{className:"text-sm text-gray-700",children:e.facility_details})})]})}function z({park:e,reviews:t,userReview:r,canReview:l,user:i,userDogs:c,showReviewForm:d,setShowReviewForm:o,reviewFormData:m,setReviewFormData:x,isSubmitting:h,handleReviewSubmit:p,handleDeleteReview:v}){return s.jsxs(n,{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(u,{className:"w-6 h-6 mr-2"}),"レビュー (",e.review_count,")"]}),i&&l&&s.jsx(a,{onClick:()=>o(!d),variant:r?"secondary":"primary",size:"sm",children:r?s.jsxs(s.Fragment,{children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"レビューを編集"]}):s.jsxs(s.Fragment,{children:[s.jsx(j,{className:"w-4 h-4 mr-2"}),"レビューを書く"]})})]}),d&&s.jsxs("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-4",children:r?"レビューを編集":"レビューを投稿"}),s.jsxs("form",{onSubmit:p,className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"評価 *"}),s.jsxs("div",{className:"flex items-center space-x-2",children:[[1,2,3,4,5].map((e=>s.jsx("button",{type:"button",onClick:()=>x({...m,rating:e}),className:"focus:outline-none",children:s.jsx(f,{className:`w-8 h-8 ${e<=m.rating?"text-yellow-400 fill-current":"text-gray-300 hover:text-yellow-300"} transition-colors`})},e))),s.jsxs("span",{className:"ml-2 text-sm text-gray-600",children:[m.rating,"つ星"]})]})]}),s.jsx($,{label:"レビューするワンちゃん *",options:c.map((e=>({value:e.id,label:e.name}))),value:m.dog_id,onChange:e=>x({...m,dog_id:e.target.value}),required:!0}),s.jsx(R,{label:"訪問日 *",type:"date",value:m.visit_date,onChange:e=>x({...m,visit_date:e.target.value}),max:(new Date).toISOString().split("T")[0],required:!0}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"レビュー内容"}),s.jsx("textarea",{value:m.review_text,onChange:e=>x({...m,review_text:e.target.value}),placeholder:"ドッグランの感想をお聞かせください...",rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("div",{className:"flex space-x-2",children:[s.jsx(a,{type:"button",variant:"secondary",onClick:()=>o(!1),children:"キャンセル"}),r&&s.jsxs(a,{type:"button",onClick:v,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(N,{className:"w-4 h-4 mr-2"}),"削除"]})]}),s.jsx(a,{type:"submit",isLoading:h,disabled:!m.dog_id||!m.visit_date,children:r?"更新する":"投稿する"})]})]})]}),0===t.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(u,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"まだレビューがありません"}),i&&l&&s.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"最初のレビューを投稿してみませんか？"})]}):s.jsx("div",{className:"space-y-6",children:t.map((e=>s.jsx("div",{className:"border-b border-gray-200 pb-6 last:border-b-0",children:s.jsxs("div",{className:"flex items-start space-x-4",children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.dog_image_url?s.jsx("img",{src:e.dog_image_url,alt:e.dog_name,className:"w-full h-full object-cover"}):s.jsx(b,{className:"w-6 h-6 text-gray-500"})})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("h4",{className:"font-semibold text-gray-900",children:e.user_name}),s.jsx("span",{className:"text-sm text-gray-500",children:"と"}),s.jsxs("span",{className:"font-medium text-blue-600",children:[e.dog_name,"ちゃん"]}),s.jsxs("span",{className:"text-xs text-gray-400",children:["(",e.dog_breed,")"]})]}),s.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[s.jsx("div",{className:"flex items-center space-x-1",children:[1,2,3,4,5].map((a=>s.jsx(f,{className:"w-4 h-4 "+(a<=e.rating?"text-yellow-400 fill-current":"text-gray-300")},a)))}),s.jsxs("span",{className:"text-sm text-gray-600",children:[new Date(e.visit_date).toLocaleDateString("ja-JP")," に訪問"]})]})]}),s.jsx("span",{className:"text-xs text-gray-400",children:new Date(e.created_at).toLocaleDateString("ja-JP")})]}),e.review_text&&s.jsx("p",{className:"text-gray-700 leading-relaxed",children:e.review_text})]})]})},e.id)))}),i&&!l&&s.jsx("div",{className:"mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:s.jsx("p",{className:"text-sm text-yellow-800",children:"レビューを投稿するには、このドッグランを実際に利用する必要があります。"})})]})}function O({rentalInfo:e}){return s.jsx(n,{className:"p-6 bg-orange-50 border-orange-200",children:s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx(x,{className:"w-6 h-6 text-orange-600 mt-1 flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-orange-900 mb-3",children:"施設貸し切り予約あり"}),s.jsx("p",{className:"text-sm text-orange-800 mb-4",children:"以下の日時は施設貸し切りのため、通常利用（1日券・サブスク）での入場はできません。"}),s.jsx("div",{className:"space-y-4",children:e.map(((e,a)=>s.jsxs("div",{className:"bg-white p-3 rounded-lg border border-orange-200",children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[s.jsx(p,{className:"w-5 h-5 text-orange-600"}),s.jsx("span",{className:"font-medium text-orange-900",children:new Date(e.date).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"})})]}),s.jsx("div",{className:"space-y-1",children:e.slots.map(((e,a)=>s.jsxs("div",{className:"flex items-center text-sm text-orange-800",children:[s.jsx(v,{className:"w-4 h-4 mr-2"}),s.jsxs("span",{children:[e.start," 〜 ",e.end]})]},a)))})]},a)))})]})]})})}function M(){const{parkId:d}=l(),{user:h}=e(),p=i(),[u,g]=r.useState(null),[j,N]=r.useState([]),[b,R]=r.useState(null),[$,M]=r.useState([]),[J,A]=r.useState(!1),[K,Q]=r.useState(!0),[U,Y]=r.useState(!1),[B,G]=r.useState(!1),[H,V]=r.useState([]),[W,Z]=r.useState([]),[X,ee]=r.useState(null),[se,ae]=r.useState({rating:5,review_text:"",visit_date:"",dog_id:""}),[te,re]=r.useState([]),[le,ie]=r.useState(!1),[ce,ne]=r.useState(0),[de,oe]=r.useState([]),[me,xe]=r.useState(!1),[he,pe]=r.useState(!1),[ue,ge]=r.useState(new Date),[je,fe]=r.useState(null);r.useEffect((()=>{d&&Ne()}),[d,h]);const Ne=async()=>{try{const{data:e,error:s}=await t.from("dog_parks").select("*").eq("id",d).eq("status","approved").single();if(s)return void p("/parks");g(e);const{data:a,error:r}=await t.from("dog_park_images").select("*").eq("park_id",d).order("display_order",{ascending:!0});if(!r&&a){const s=[];e.image_url&&s.push({id:"main",url:e.image_url,caption:`${e.name} - メイン画像`}),e.cover_image_url&&s.push({id:"cover",url:e.cover_image_url,caption:`${e.name} - カバー画像`}),a.forEach((a=>{s.push({id:a.id,url:a.image_url,caption:a.caption||`${e.name} - 施設画像`})})),re(s)}const{data:l,error:i}=await t.rpc("get_park_reviews",{park_id_param:d});i||N(l||[]);const{data:c,error:n}=await t.from("reservations").select("*").eq("park_id",d).eq("reservation_type","whole_facility").eq("status","confirmed").gte("date",(new Date).toISOString().split("T")[0]);if(n);else{V(c||[]);const e=(new Date).toISOString().split("T")[0],s=c?.filter((s=>s.date===e))||[];Z(s)}const{data:o,error:m}=await t.from("smart_locks").select("id, lock_id, lock_name, park_id").eq("park_id",d).eq("status","active");if(m||oe(o||[]),h){const{data:e,error:s}=await t.from("dogs").select("\n            *,\n            vaccine_certifications!inner(*)\n          ").eq("owner_id",h.id).eq("vaccine_certifications.status","approved");s||M(e||[]);const{data:a,error:r}=await t.rpc("can_user_review_park",{user_id_param:h.id,park_id_param:d});r||A(a);const{data:l,error:i}=await t.rpc("get_user_park_review",{user_id_param:h.id,park_id_param:d});if(!i&&l&&l.length>0&&(R(l[0]),ae({rating:l[0].rating,review_text:l[0].review_text||"",visit_date:l[0].visit_date,dog_id:l[0].dog_id})),de.length>0){const{data:e,error:s}=await t.rpc("check_user_park_access",{p_user_id:h.id,p_lock_id:de[0].lock_id});!s&&e&&e.has_access&&xe(!0)}const c=(new Date).toISOString().split("T")[0],{data:n,error:o}=await t.from("reservations").select("\n            *,\n            dog_park:dog_parks(*),\n            dog:dogs(*)\n          ").eq("park_id",d).eq("user_id",h.id).eq("status","confirmed").eq("date",c).order("start_time",{ascending:!0}).limit(1).single();!o&&n&&ee(n)}}catch(e){fe(e.message||"エラーが発生しました"),p("/parks")}finally{Q(!1)}},be=e=>{ne(e),ie(!0)},ve=()=>{alert("PINコードを生成しました！")},we=e=>{alert(`PINコードの生成に失敗しました: ${e}`)};if(K)return s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});if(!u)return s.jsxs("div",{className:"text-center py-12",children:[s.jsx("p",{className:"text-gray-600",children:"ドッグランが見つかりませんでした"}),s.jsx(a,{onClick:()=>p("/parks"),className:"mt-4",children:"ドッグラン一覧に戻る"})]});const ye=(()=>{if(0===H.length)return[];const e={};return H.forEach((s=>{const a=s.date;e[a]||(e[a]={date:a,slots:[]});const t=parseInt(s.start_time),r=t+s.duration;e[a].slots.push({start:`${t.toString().padStart(2,"0")}:00`,end:`${r.toString().padStart(2,"0")}:00`})})),Object.values(e).sort(((e,s)=>new Date(e.date).getTime()-new Date(s.date).getTime()))})();return s.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[je&&s.jsx("div",{className:"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg",children:je}),u&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex justify-between items-start mb-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:u.name}),s.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-600",children:[s.jsx("span",{children:u.address}),s.jsx("span",{children:"•"}),s.jsxs("span",{children:["¥",u.price,"/日"]})]})]}),s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsxs("div",{className:"text-sm text-gray-600",children:["最終更新: ",ue.toLocaleTimeString("ja-JP")]}),s.jsxs("button",{onClick:()=>{(async()=>{if(d)try{pe(!0);const{data:e,error:s}=await t.from("dog_parks").select("*").eq("id",d).single();if(s)return;g(e),ge(new Date)}catch(e){}finally{pe(!1)}})()},disabled:he,className:"flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors "+(he?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-blue-100 text-blue-700 hover:bg-blue-200"),children:[s.jsx(w,{className:"w-4 h-4 "+(he?"animate-spin":"")}),s.jsx("span",{children:he?"更新中...":"更新"})]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[s.jsx(P,{park:u,parkImages:te,todayRentals:W,onImageClick:be}),s.jsx(E,{parkImages:te,onImageClick:be}),s.jsxs(n,{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-start mb-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:u.name}),s.jsx("div",{className:"flex items-center space-x-4 mb-4",children:s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("div",{className:"flex items-center space-x-1",children:[1,2,3,4,5].map((e=>s.jsx(f,{className:"w-5 h-5 "+(e<=Math.round(u.average_rating)?"text-yellow-400 fill-current":"text-gray-300")},e)))}),s.jsx("span",{className:"text-lg font-semibold text-gray-900",children:u.average_rating.toFixed(1)}),s.jsxs("span",{className:"text-sm text-gray-600",children:["(",u.review_count,"件のレビュー)"]})]})})]}),s.jsx(c,{to:`/parks/${u.id}/reserve`,children:s.jsx(a,{className:"bg-blue-600 hover:bg-blue-700",children:"予約する"})})]}),s.jsx("p",{className:"text-gray-700 mb-6",children:u.description}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center text-gray-600",children:[s.jsx(y,{className:"w-5 h-5 mr-3"}),s.jsx("span",{children:u.address})]}),s.jsxs("div",{className:"flex items-center text-gray-600",children:[s.jsx(_,{className:"w-5 h-5 mr-3"}),s.jsxs("span",{children:["現在の利用者: ",u.current_occupancy,"/",u.max_capacity,"人"]})]}),s.jsxs("div",{className:"flex items-center text-gray-600",children:[s.jsx(k,{className:"w-5 h-5 mr-3"}),s.jsxs("span",{children:["料金: ¥",u.price,"/日"]})]})]}),s.jsxs("div",{className:"space-y-3",children:[u.large_dog_area&&s.jsxs("div",{className:"flex items-center text-blue-600",children:[s.jsx(S,{className:"w-5 h-5 mr-3"}),s.jsx("span",{children:"大型犬OK"})]}),u.small_dog_area&&s.jsxs("div",{className:"flex items-center text-pink-600",children:[s.jsx(I,{className:"w-5 h-5 mr-3"}),s.jsx("span",{children:"小型犬OK"})]}),u.private_booths&&s.jsxs("div",{className:"flex items-center text-purple-600",children:[s.jsx(m,{className:"w-5 h-5 mr-3"}),s.jsxs("span",{children:["プライベートブース ",u.private_booth_count,"室"]})]})]})]})]}),de.length>0&&me&&s.jsxs(n,{className:"p-6 bg-blue-50 border-blue-200",children:[s.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[s.jsx(o,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-blue-900 mb-2",children:"入口ドアの開錠"}),s.jsx("p",{className:"text-sm text-blue-800 mb-4",children:"PINコードを生成して入口のスマートロックを開錠できます。"})]})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:de.map((e=>s.jsx(T,{lockId:e.lock_id,label:`${e.lock_name}のPINコードを生成`,className:"w-full",onSuccess:ve,onError:we,reservationId:X?.id},e.id)))})]}),W.length>0&&s.jsx(n,{className:"p-6 bg-orange-50 border-orange-200",children:s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx(x,{className:"w-6 h-6 text-orange-600 mt-1 flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-orange-900 mb-3",children:"本日の貸し切り時間"}),s.jsx("p",{className:"text-sm text-orange-800 mb-4",children:"以下の時間帯は施設貸し切りのため、通常利用（1日券・サブスク）での入場はできません。"}),s.jsx("div",{className:"space-y-3",children:W.map(((e,a)=>{const t=parseInt(e.start_time),r=t+e.duration;return s.jsx("div",{className:"bg-white p-3 rounded-lg border border-orange-200",children:s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(v,{className:"w-5 h-5 text-orange-600"}),s.jsxs("span",{className:"font-medium text-orange-900",children:[t,":00 〜 ",r,":00"]})]})},a)}))})]})]})}),ye.length>0&&s.jsx(O,{rentalInfo:ye}),s.jsx(F,{park:u}),s.jsx(z,{park:u,reviews:j,userReview:b,canReview:J,user:h,userDogs:$,showReviewForm:U,setShowReviewForm:Y,reviewFormData:se,setReviewFormData:ae,isSubmitting:B,handleReviewSubmit:async e=>{if(e.preventDefault(),h&&u){G(!0);try{if(b){const{error:e}=await t.from("dog_park_reviews").update({rating:se.rating,review_text:se.review_text,visit_date:se.visit_date,dog_id:se.dog_id,updated_at:(new Date).toISOString()}).eq("id",b.id);if(e)throw e}else{const{error:e}=await t.from("dog_park_reviews").insert([{park_id:d,user_id:h.id,dog_id:se.dog_id,rating:se.rating,review_text:se.review_text,visit_date:se.visit_date}]);if(e)throw e}await Ne(),Y(!1),alert(b?"レビューを更新しました！":"レビューを投稿しました！")}catch(s){alert("レビューの投稿に失敗しました。もう一度お試しください。")}finally{G(!1)}}},handleDeleteReview:async()=>{if(b&&confirm("レビューを削除しますか？"))try{const{error:e}=await t.from("dog_park_reviews").delete().eq("id",b.id);if(e)throw e;await Ne(),R(null),ae({rating:5,review_text:"",visit_date:"",dog_id:""}),alert("レビューを削除しました。")}catch(e){alert("レビューの削除に失敗しました。")}}})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsx(n,{className:"p-4",children:s.jsx(c,{to:`/parks/${u.id}/reserve`,children:s.jsx(a,{className:"w-full bg-blue-600 hover:bg-blue-700 text-lg py-3",children:"予約する"})})}),de.length>0&&me&&s.jsxs(n,{className:"p-4 bg-blue-50 border-blue-200",children:[s.jsxs("h3",{className:"font-semibold text-blue-900 mb-3 flex items-center",children:[s.jsx(o,{className:"w-5 h-5 text-blue-600 mr-2"}),"入口ドアを開ける"]}),s.jsx("div",{className:"space-y-3",children:de.map((e=>s.jsx(T,{lockId:e.lock_id,label:`${e.lock_name}のPINコードを生成`,className:"w-full",onSuccess:ve,onError:we,reservationId:X?.id},e.id)))})]}),s.jsxs(n,{className:"p-4",children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"料金情報"}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"通常利用"}),s.jsxs("span",{className:"font-medium",children:["¥",u.price,"/日"]})]}),u.private_booths&&s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"プライベートブース"}),s.jsxs("span",{className:"font-medium",children:["¥",u.private_booth_price,"/2時間"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"施設貸し切り"}),s.jsx("span",{className:"font-medium",children:"¥4,400/時間"})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"サブスクリプション"}),s.jsx("span",{className:"font-medium",children:"¥3,800/月"})]})]})]}),s.jsxs(n,{className:"p-4",children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"現在の状況"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"text-sm",children:"利用者数"}),s.jsxs("span",{className:"font-medium",children:[u.current_occupancy,"/",u.max_capacity,"人"]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[s.jsxs("span",{children:[u.current_occupancy,"人"]}),s.jsxs("span",{children:[Math.round(u.current_occupancy/u.max_capacity*100),"%"]}),s.jsxs("span",{children:[u.max_capacity,"人"]})]}),s.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:s.jsx("div",{className:`h-3 rounded-full transition-all duration-300 ${L(u.current_occupancy,u.max_capacity).barColor}`,style:{width:u.current_occupancy/u.max_capacity*100+"%"}})})]}),s.jsxs("div",{className:"text-center",children:[s.jsxs("span",{className:`px-3 py-1 rounded-full text-sm font-medium flex items-center justify-center space-x-1 ${L(u.current_occupancy,u.max_capacity).color}`,children:[s.jsx("span",{children:L(u.current_occupancy,u.max_capacity).emoji}),s.jsx("span",{children:L(u.current_occupancy,u.max_capacity).text})]}),s.jsx("p",{className:"text-xs text-gray-600 mt-1",children:L(u.current_occupancy,u.max_capacity).description})]}),s.jsxs("div",{className:"flex items-center justify-center space-x-2 text-xs text-gray-500",children:[s.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),s.jsx("span",{children:"リアルタイム更新中"})]})]})]}),s.jsxs(n,{className:"p-4",children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"評価"}),s.jsxs("div",{className:"text-center mb-4",children:[s.jsx("div",{className:"text-3xl font-bold text-gray-900 mb-1",children:u.average_rating.toFixed(1)}),s.jsx("div",{className:"flex items-center justify-center space-x-1",children:[1,2,3,4,5].map((e=>s.jsx(f,{className:"w-6 h-6 "+(e<=Math.round(u.average_rating)?"text-yellow-400 fill-current":"text-gray-300")},e)))}),s.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[u.review_count,"件のレビュー"]})]}),u.review_count>0&&s.jsx("div",{className:"space-y-2",children:[5,4,3,2,1].map((e=>{const a=j.filter((s=>s.rating===e)).length,t=u.review_count>0?a/u.review_count*100:0;return s.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[s.jsx("span",{className:"w-3",children:e}),s.jsx(f,{className:"w-3 h-3 text-yellow-400 fill-current"}),s.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:s.jsx("div",{className:"bg-yellow-400 h-2 rounded-full",style:{width:`${t}%`}})}),s.jsx("span",{className:"w-8 text-right",children:a})]},e)}))})]}),s.jsxs(n,{className:"p-4",children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"アクセス"}),s.jsxs("div",{className:"text-sm text-gray-700 space-y-2",children:[s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx(y,{className:"w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0"}),s.jsx("span",{children:u.address})]}),s.jsx("div",{className:"mt-3",children:s.jsx(a,{variant:"secondary",size:"sm",className:"w-full",onClick:()=>{const e=encodeURIComponent(u.address);window.open(`https://maps.google.com/maps?q=${e}`,"_blank")},children:"Google Mapsで開く"})})]})]})]})]}),le&&te.length>0&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4",children:s.jsxs("div",{className:"relative w-full max-w-4xl",children:[s.jsx("button",{onClick:()=>{ie(!1)},className:"absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-70 transition-colors z-10",children:s.jsx(C,{className:"w-6 h-6"})}),s.jsx("button",{onClick:()=>{ne((e=>(e-1+te.length)%te.length))},className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-70 transition-opacity z-10",children:s.jsx(D,{className:"w-6 h-6"})}),s.jsx("button",{onClick:()=>{ne((e=>(e+1)%te.length))},className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-70 transition-opacity z-10",children:s.jsx(q,{className:"w-6 h-6"})}),s.jsx("div",{className:"flex items-center justify-center h-[80vh]",children:s.jsx("img",{src:te[ce].url,alt:te[ce].caption||`${u.name} - 画像 ${ce+1}`,className:"max-h-full max-w-full object-contain"})}),s.jsxs("div",{className:"absolute bottom-4 left-0 right-0 text-center text-white",children:[s.jsx("p",{className:"text-sm mb-2",children:te[ce].caption}),s.jsxs("p",{className:"text-xs",children:[ce+1," / ",te.length]})]})]})})]})]})}const L=(e,s)=>{const a=e/s*100;return a<25?{text:"空いています",color:"text-green-600 bg-green-100",barColor:"bg-green-500",description:"快適に利用できます",emoji:"😊"}:a<50?{text:"やや空いています",color:"text-blue-600 bg-blue-100",barColor:"bg-blue-500",description:"適度な混雑です",emoji:"🙂"}:a<75?{text:"やや混んでいます",color:"text-yellow-600 bg-yellow-100",barColor:"bg-yellow-500",description:"少し混雑しています",emoji:"😐"}:{text:"混んでいます",color:"text-red-600 bg-red-100",barColor:"bg-red-500",description:"大変混雑しています",emoji:"😰"}};export{M as DogParkDetail};
