var e=Object.defineProperty,s=Object.defineProperties,r=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,i=(s,r,a)=>r in s?e(s,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[r]=a,n=(e,s)=>{for(var r in s||(s={}))t.call(s,r)&&i(e,r,s[r]);if(a)for(var r of a(s))l.call(s,r)&&i(e,r,s[r]);return e},c=(e,a)=>s(e,r(a)),d=(e,s,r)=>new Promise(((a,t)=>{var l=e=>{try{n(r.next(e))}catch(s){t(s)}},i=e=>{try{n(r.throw(e))}catch(s){t(s)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,i);n((r=r.apply(e,s)).next())}));import{u as o,s as x,j as m,B as h,C as u}from"./index.D9xag4tn.js";import{u as p,r as j,L as f}from"./router.BWT_vQps.js";import{I as b}from"./Input.tFQgyGuP.js";import{A as y,e as g,U as v,H as N,I as w,J as _,x as S,t as C,p as k,a as D,a2 as M,w as I,L as O}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function Y(){const{user:e}=o(),s=p(),[r,a]=j.useState(!0),[t,l]=j.useState(""),[i,Y]=j.useState(""),[q,A]=j.useState([]),[P,z]=j.useState(!1),[H,L]=j.useState(!1),[F,V]=j.useState({cardNumber:"",cardHolder:"",expiryMonth:"",expiryYear:"",cvv:"",isDefault:!1});j.useEffect((()=>{e?W():s("/login")}),[e,s]);const W=()=>d(null,null,(function*(){try{a(!0);const{data:s,error:r}=yield x.from("payment_cards").select("*").eq("user_id",null==e?void 0:e.id).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(r)throw r;A(s||[])}catch(s){l("支払い方法の取得に失敗しました。")}finally{a(!1)}})),T=e=>{switch(e){case"visa":return m.jsx("span",{className:"text-blue-600 font-bold",children:"VISA"});case"mastercard":return m.jsx("span",{className:"text-red-600 font-bold",children:"Mastercard"});case"amex":return m.jsx("span",{className:"text-blue-800 font-bold",children:"AMEX"});case"jcb":return m.jsx("span",{className:"text-green-600 font-bold",children:"JCB"});default:return m.jsx(g,{className:"w-5 h-5 text-gray-600"})}};return r?m.jsx("div",{className:"flex justify-center items-center h-64",children:m.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):m.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[m.jsx("div",{className:"flex items-center space-x-4 mb-6",children:m.jsxs(f,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[m.jsx(y,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),m.jsxs("div",{className:"text-center mb-8",children:[m.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[m.jsx(g,{className:"w-8 h-8 text-blue-600 mr-3"}),"支払い方法の管理"]}),m.jsx("p",{className:"text-lg text-gray-600",children:"クレジットカード情報を管理します"})]}),m.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[m.jsx(f,{to:"/profile-settings",children:m.jsxs(h,{variant:"secondary",size:"sm",children:[m.jsx(v,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),m.jsx(f,{to:"/dogpark-history",children:m.jsxs(h,{variant:"secondary",size:"sm",children:[m.jsx(N,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),m.jsx(f,{to:"/orders",children:m.jsxs(h,{variant:"secondary",size:"sm",children:[m.jsx(w,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),m.jsx(f,{to:"/shop",children:m.jsxs(h,{variant:"secondary",size:"sm",children:[m.jsx(_,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),m.jsxs(u,{className:"p-6",children:[m.jsxs("div",{className:"flex justify-between items-center mb-6",children:[m.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[m.jsx(g,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みのカード"]}),m.jsx(h,{onClick:()=>z(!P),size:"sm",children:P?m.jsxs(m.Fragment,{children:[m.jsx(S,{className:"w-4 h-4 mr-1"}),"キャンセル"]}):m.jsxs(m.Fragment,{children:[m.jsx(C,{className:"w-4 h-4 mr-1"}),"カードを追加"]})})]}),t&&m.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[m.jsx(k,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),m.jsx("p",{className:"text-red-800",children:t})]}),i&&m.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[m.jsx(D,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),m.jsx("p",{className:"text-green-800",children:i})]}),P&&m.jsxs("div",{className:"mb-6 p-6 bg-gray-50 rounded-lg border border-gray-200",children:[m.jsx("h3",{className:"font-semibold mb-4",children:"新しいカードを追加"}),m.jsx("form",{onSubmit:s=>d(null,null,(function*(){if(s.preventDefault(),l(""),Y(""),(()=>{if(16!==F.cardNumber.replace(/\s/g,"").length)return l("カード番号は16桁で入力してください。"),!1;if(!F.cardHolder.trim())return l("カード名義人を入力してください。"),!1;if(!F.expiryMonth||!F.expiryYear)return l("有効期限を選択してください。"),!1;if(F.cvv.length<3)return l("CVVを正しく入力してください。"),!1;const e=new Date,s=e.getFullYear()%100,r=e.getMonth()+1,a=parseInt(F.expiryYear),t=parseInt(F.expiryMonth);return!(a<s||a===s&&t<r)||(l("有効期限が過去の日付です。"),!1)})()){L(!0);try{const s=F.cardNumber.replace(/\s/g,""),r="**** **** **** "+s.slice(-4),a=(e=>{const s=e.replace(/\s/g,"");return s.startsWith("4")?"visa":s.startsWith("5")||s.startsWith("2")?"mastercard":s.startsWith("3")?"amex":s.startsWith("35")?"jcb":"visa"})(s),{error:t}=yield x.from("payment_cards").insert([{user_id:null==e?void 0:e.id,card_number_masked:r,card_holder_name:F.cardHolder,expiry_month:parseInt(F.expiryMonth),expiry_year:parseInt(F.expiryYear),card_brand:a,is_default:F.isDefault||0===q.length}]);if(t)throw t;Y("クレジットカードを登録しました"),z(!1),V({cardNumber:"",cardHolder:"",expiryMonth:"",expiryYear:"",cvv:"",isDefault:!1}),yield W(),setTimeout((()=>{Y("")}),3e3)}catch(r){l("クレジットカードの登録に失敗しました。もう一度お試しください。")}finally{L(!1)}}})),children:m.jsxs("div",{className:"space-y-4",children:[m.jsx(b,{label:"カード番号 *",value:F.cardNumber,onChange:e=>{const s=e.target.value.replace(/\D/g,"").replace(/(.{4})/g,"$1 ").trim().slice(0,19);V(c(n({},F),{cardNumber:s}))},placeholder:"1234 5678 9012 3456",maxLength:19,required:!0}),m.jsx(b,{label:"カード名義人 *",value:F.cardHolder,onChange:e=>V(c(n({},F),{cardHolder:e.target.value.toUpperCase()})),placeholder:"TARO YAMADA",required:!0}),m.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"有効期限（月） *"}),m.jsxs("select",{value:F.expiryMonth,onChange:e=>V(c(n({},F),{expiryMonth:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[m.jsx("option",{value:"",children:"月"}),Array.from({length:12},((e,s)=>m.jsx("option",{value:String(s+1).padStart(2,"0"),children:String(s+1).padStart(2,"0")},s+1)))]})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"有効期限（年） *"}),m.jsxs("select",{value:F.expiryYear,onChange:e=>V(c(n({},F),{expiryYear:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[m.jsx("option",{value:"",children:"年"}),Array.from({length:10},((e,s)=>{const r=(new Date).getFullYear()+s;return m.jsx("option",{value:String(r).slice(-2),children:r},r)}))]})]}),m.jsx(b,{label:"CVV *",value:F.cvv,onChange:e=>V(c(n({},F),{cvv:e.target.value.replace(/\D/g,"")})),placeholder:"123",maxLength:4,required:!0})]}),m.jsxs("div",{className:"flex items-center space-x-2",children:[m.jsx("input",{type:"checkbox",id:"isDefault",checked:F.isDefault,onChange:e=>V(c(n({},F),{isDefault:e.target.checked})),className:"rounded text-blue-600"}),m.jsx("label",{htmlFor:"isDefault",className:"text-sm text-gray-700",children:"デフォルトの支払い方法として設定"})]}),m.jsxs("div",{className:"flex justify-end space-x-3 mt-2",children:[m.jsx(h,{type:"button",variant:"secondary",onClick:()=>z(!1),children:"キャンセル"}),m.jsx(h,{type:"submit",isLoading:H,children:"カードを追加"})]})]})})]}),0===q.length?m.jsxs("div",{className:"text-center py-8",children:[m.jsx(g,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),m.jsx("p",{className:"text-gray-600 mb-4",children:"登録されているカードはありません"}),m.jsxs(h,{onClick:()=>z(!0),children:[m.jsx(C,{className:"w-4 h-4 mr-2"}),"カードを追加する"]})]}):m.jsx("div",{className:"space-y-4",children:q.map((s=>m.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:m.jsxs("div",{className:"flex justify-between items-center",children:[m.jsxs("div",{className:"flex items-center space-x-3",children:[m.jsx("div",{className:"w-12 h-12 bg-white rounded-lg flex items-center justify-center border border-gray-300",children:T(s.card_brand)}),m.jsxs("div",{children:[m.jsxs("div",{className:"flex items-center space-x-2",children:[m.jsx("h3",{className:"font-semibold",children:s.card_number_masked}),s.is_default&&m.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full flex items-center",children:[m.jsx(M,{className:"w-3 h-3 mr-1"}),"デフォルト"]})]}),m.jsx("p",{className:"text-sm text-gray-600",children:s.card_holder_name}),m.jsxs("p",{className:"text-xs text-gray-500",children:["有効期限: ",s.expiry_month.toString().padStart(2,"0"),"/",s.expiry_year.toString().padStart(2,"0")]})]})]}),m.jsxs("div",{className:"flex space-x-2",children:[!s.is_default&&m.jsxs(h,{size:"sm",variant:"secondary",onClick:()=>{return r=s.id,d(null,null,(function*(){try{l(""),Y("");const{error:s}=yield x.from("payment_cards").update({is_default:!1}).eq("user_id",null==e?void 0:e.id);if(s)throw s;const{error:a}=yield x.from("payment_cards").update({is_default:!0}).eq("id",r);if(a)throw a;Y("デフォルトの支払い方法を変更しました"),yield W(),setTimeout((()=>{Y("")}),3e3)}catch(s){l("デフォルト設定の変更に失敗しました。")}}));var r},children:[m.jsx(M,{className:"w-4 h-4 mr-1"}),"デフォルトに設定"]}),m.jsx(h,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>{return e=s.id,d(null,null,(function*(){if(confirm("このカードを削除してもよろしいですか？"))try{l(""),Y("");const{error:s}=yield x.from("payment_cards").delete().eq("id",e);if(s)throw s;Y("クレジットカードを削除しました"),yield W(),setTimeout((()=>{Y("")}),3e3)}catch(s){l(s.message||"決済方法の削除に失敗しました")}}));var e},children:m.jsx(I,{className:"w-4 h-4"})})]})]})},s.id)))})]}),m.jsx(u,{className:"p-6 bg-blue-50 border-blue-200",children:m.jsxs("div",{className:"flex items-start space-x-3",children:[m.jsx(O,{className:"w-6 h-6 text-blue-600 mt-1"}),m.jsxs("div",{children:[m.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"セキュリティ情報"}),m.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[m.jsx("p",{children:"• カード情報は暗号化して安全に保存されます"}),m.jsx("p",{children:"• 実際のカード番号は保存されません"}),m.jsx("p",{children:"• 決済処理はSSL暗号化通信で行われます"}),m.jsx("p",{children:"• PCI DSS準拠のセキュリティ基準を満たしています"})]})]})]})})]})}export{Y as PaymentMethodSettings};
