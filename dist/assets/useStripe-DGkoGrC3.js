import{r as t}from"./react-vendor-BBLDtDmh.js";import{s as e}from"./index-BbveZyU8.js";import{l as o}from"./stripe-vendor-CcgPsVUa.js";function r(){const[r,s]=t.useState(!1),[n,a]=t.useState(null);return{createCheckoutSession:t.useCallback(async({priceId:t,mode:r,successUrl:n=`${window.location.origin}/payment-confirmation?success=true`,cancelUrl:i=`${window.location.origin}/payment-confirmation?canceled=true`,customAmount:c,customName:u,customParams:m,cartItems:l})=>{s(!0),a(null);try{const{data:{session:s}}=await e.auth.getSession();if(!s?.access_token)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:s.user.id,user_email:s.user.email,timestamp:Date.now(),return_url:window.location.href}));const a={mode:r,success_url:n,cancel_url:i};t&&(a.price_id=t),c&&u&&(a.custom_amount=c,a.custom_name=u),l&&l.length>0&&(a.cart_items=l),m&&Object.entries(m).forEach(([t,e])=>{a[t]=e});const w=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify(a)});if(!w.ok){const t=await w.json();throw new Error(t.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:p,url:d}=await w.json();if(d)return void(window.location.href=d);if(!p)throw new Error("チェックアウトURLが取得できませんでした");{const t="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",e=await o(t);if(!e)throw new Error("Stripeの読み込みに失敗しました");const{error:r}=await e.redirectToCheckout({sessionId:p});if(r)throw r}}catch(w){throw a(w.message||"チェックアウトに失敗しました"),w}finally{s(!1)}},[]),loading:r,error:n}}export{r as u};
