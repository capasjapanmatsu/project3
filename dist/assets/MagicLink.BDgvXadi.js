import{j as e,L as s,A as a,C as t}from"./ui-vendor.5lywbznV.js";import{u as r,b as i,r as o}from"./react-vendor.C7ykWfwV.js";import{C as n,B as c,s as m}from"./admin-pages.BuCPNRRu.js";import{s as d}from"./index.Cy6Rp-9S.js";import"./supabase-vendor.CX-WoPCS.js";import"./park-pages.DqtvJl8J.js";import"./stripe-vendor.CcgPsVUa.js";function l(){const l=r(),x=i(),[u,h]=o.useState(!0),[p,j]=o.useState(null),[f,b]=o.useState(!1);return o.useEffect(()=>{(async()=>{var e;try{h(!0);const s=window.location.hash;if(!s||!s.includes("access_token"))return void j("無効なMagic Linkです。もう一度ログインしてください。");const a=new URLSearchParams(s.substring(1)),t=a.get("access_token"),r=a.get("refresh_token");if(!t||!r)return void j("認証トークンが見つかりません。もう一度ログインしてください。");const{error:i}=await m.auth.setSession({access_token:t,refresh_token:r});if(i)throw i;const{data:{user:o},error:n}=await m.auth.getUser();if(n||!o)throw n||new Error("ユーザー情報の取得に失敗しました");const{data:c,error:x}=await m.from("profiles").select("id").eq("id",o.id).maybeSingle();if(x&&x.code,!c){const s=o.user_metadata||{},{error:a}=await m.from("profiles").upsert([{id:o.id,user_type:s.user_type||"user",name:s.name||(null==(e=o.email)?void 0:e.split("@")[0])||"ユーザー",postal_code:s.postal_code||"",address:s.address||"",phone_number:s.phone_number||""}],{onConflict:"id"})}o&&d(`trusted_device_${o.id}`,"true"),b(!0),setTimeout(()=>{l("/dashboard")},2e3)}catch(s){j(s.message||"マジックリンクの送信に失敗しました")}finally{h(!1)}})()},[l,x]),u?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(n,{className:"text-center p-8",children:[e.jsx(s,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(n,{className:"text-center p-8",children:[e.jsx(a,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p}),e.jsx(c,{onClick:()=>l("/login"),children:"ログインページに戻る"})]})}):f?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(n,{className:"text-center p-8",children:[e.jsx(t,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(c,{onClick:()=>l("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{l as MagicLink};
