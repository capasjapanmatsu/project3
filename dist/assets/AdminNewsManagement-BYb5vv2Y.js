import{j as e,B as s,r as t,A as r,g as a,y as n,X as i,T as l,o as c,F as o,V as d}from"./ui-vendor-B03FHkej.js";import{r as m,u as x,L as u}from"./react-vendor-BBLDtDmh.js";import{u as h,s as f,l as g,y as p,c as j,C as y,B as b}from"./index-CWMjoAp3.js";import{I as w}from"./Input-D52zIDZ_.js";import{S as N}from"./Select-CyS8FvOq.js";import"./query-vendor-Cy2yKKks.js";import"./supabase-vendor-BcfcqyaE.js";function v(){const{user:d}=h(),[x,u]=m.useState([]),[v,_]=m.useState({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),[k,S]=m.useState(null),[E,C]=m.useState(!1),[q,T]=m.useState(!1),[A,D]=m.useState(""),[I,L]=m.useState("");m.useEffect(()=>{$(),P()},[]);const P=async()=>{if(d)try{const{data:e,error:s}=await f.from("profiles").select("*").eq("id",d.id).single();if(s&&"PGRST116"===s.code){const{data:e,error:s}=await f.from("profiles").insert([{id:d.id,user_type:"admin",name:d.email||"Admin User",email:d.email}]).select().single();s?(g("error","Error creating admin profile:",{createError:s}),D("管理者プロファイルの作成に失敗しました。")):(g("info","Admin profile created successfully:",{newProfile:e}),L("管理者プロファイルを作成しました。"),setTimeout(()=>L(""),3e3))}else if(s)g("error","Error fetching user profile:",{error:s}),D("ユーザープロファイルの取得に失敗しました。");else if(!e||"admin"!==e.user_type){g("info","Updating user to admin...");const{error:e}=await f.from("profiles").update({user_type:"admin"}).eq("id",d.id);e?(g("error","Error updating user to admin:",{updateError:e}),D("管理者権限の設定に失敗しました。")):(g("info","User updated to admin successfully"),L("管理者権限を設定しました。ページを手動でリロードしてください。"),setTimeout(()=>L(""),5e3))}}catch(e){g("error","Error checking user profile:",{error:p(e)}),D("ユーザープロファイルの確認に失敗しました。")}},$=async()=>{try{const e=await j(()=>f.from("news_announcements").select("*").order("created_at",{ascending:!1}));if(e.error)throw e.error;u(e.data||[]),D("")}catch(e){g("error","Error fetching news:",{error:p(e)}),D("新着情報の取得に失敗しました。")}},z=e=>({news:"お知らせ",announcement:"重要なお知らせ",sale:"セール情報"}[e]||e),F=t=>{switch(t){case"news":return e.jsx(o,{className:"w-4 h-4"});case"announcement":return e.jsx(c,{className:"w-4 h-4"});case"sale":return e.jsx(l,{className:"w-4 h-4"});default:return e.jsx(s,{className:"w-4 h-4"})}};return e.jsxs(e.Fragment,{children:[e.jsxs(y,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(s,{className:"w-5 h-5 text-blue-600 mr-2"}),"新着情報管理"]}),e.jsxs(b,{onClick:()=>{S(null),_({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),C(!0)},children:[e.jsx(t,{className:"w-4 h-4 mr-2"}),"新着情報を追加"]})]}),A&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start",children:[e.jsx(r,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:A})]}),I&&e.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start",children:[e.jsx(a,{className:"w-5 h-5 text-green-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:I})]}),e.jsx("div",{className:"space-y-4",children:0===x.length?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"新着情報がありません"}):x.map(s=>{return e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${t=s.category,{news:"bg-blue-100 text-blue-800",announcement:"bg-red-100 text-red-800",sale:"bg-green-100 text-green-800"}[t]||"bg-gray-100 text-gray-800"}`,children:[F(s.category),e.jsx("span",{children:z(s.category)})]}),s.is_important&&e.jsx("span",{className:"bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium",children:"重要"})]}),e.jsx("h3",{className:"font-bold text-lg mb-2",children:s.title}),e.jsx("p",{className:"text-sm text-gray-700 mb-2 line-clamp-2",children:s.content}),e.jsxs("div",{className:"text-xs text-gray-500",children:["作成日: ",new Date(s.created_at).toLocaleString("ja-JP"),s.updated_at!==s.created_at&&e.jsxs("span",{children:[" / 更新日: ",new Date(s.updated_at).toLocaleString("ja-JP")]})]})]}),e.jsxs("div",{className:"flex space-x-2 ml-4",children:[e.jsxs(b,{variant:"secondary",size:"sm",onClick:()=>(e=>{S(e),_({title:e.title,content:e.content,category:e.category,is_important:e.is_important||!1,image_url:"",link_url:""}),C(!0)})(s),disabled:q,children:[e.jsx(n,{className:"w-4 h-4 mr-1"}),"編集"]}),e.jsxs(b,{variant:"danger",size:"sm",onClick:()=>(async e=>{if(confirm("この新着情報を削除してもよろしいですか？"))try{T(!0),D("");const{error:s}=await f.from("news_announcements").delete().eq("id",e);if(s)throw s;L("新着情報を削除しました。"),await $(),setTimeout(()=>{L("")},3e3)}catch(s){g("error","Error deleting news:",{error:p(s)}),D("新着情報の削除に失敗しました。")}finally{T(!1)}})(s.id),disabled:q,children:[e.jsx(i,{className:"w-4 h-4 mr-1"}),"削除"]})]})]})},s.id);var t})})]}),E&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:k?"新着情報を編集":"新着情報を追加"}),e.jsx("button",{onClick:()=>C(!1),className:"text-gray-500 hover:text-gray-700",disabled:q,children:e.jsx(i,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),v.title.trim())if(v.content.trim())if(d)try{T(!0),D(""),L("");const{data:e,error:s}=await f.from("profiles").select("*").eq("id",d.id).single(),t={title:v.title,content:v.content,category:v.category,is_important:v.is_important,created_by:d?.id};if(k){const{error:e}=await f.from("news_announcements").update({title:v.title,content:v.content,category:v.category,is_important:v.is_important,updated_at:(new Date).toISOString()}).eq("id",k.id);if(e)throw e;L("新着情報を更新しました。")}else{g("info","Attempting to insert new announcement...");const{data:e,error:s}=await f.from("news_announcements").insert([t]).select();if(g("info","Insert result:",{insertResult:e}),s)throw g("error","Insert error details:",{message:s.message,details:s.details,hint:s.hint,code:s.code}),s;L("新着情報を追加しました。")}_({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),S(null),C(!1),await $(),setTimeout(()=>{L("")},3e3)}catch(s){g("error","=== エラー詳細 ==="),g("error","Error saving news:",{error:p(s)});let e="新着情報の保存に失敗しました。";s&&"object"==typeof s&&("message"in s&&"string"==typeof s.message&&(e+=` エラー詳細: ${s.message}`),"details"in s&&"string"==typeof s.details&&(e+=` 詳細: ${s.details}`),"hint"in s&&"string"==typeof s.hint&&(e+=` ヒント: ${s.hint}`),"code"in s&&(e+=` コード: ${s.code}`)),D(e)}finally{T(!1)}else D("ユーザーが認証されていません。ログインしてください。");else D("内容を入力してください。");else D("タイトルを入力してください。")},children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(w,{label:"タイトル *",value:v.title,onChange:e=>_({...v,title:e.target.value}),required:!0,disabled:q}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容 *"}),e.jsx("textarea",{value:v.content,onChange:e=>_({...v,content:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:6,required:!0,disabled:q})]}),e.jsx(N,{label:"カテゴリー *",options:[{value:"news",label:"お知らせ"},{value:"announcement",label:"重要なお知らせ"},{value:"sale",label:"セール情報"}],value:v.category,onChange:e=>_({...v,category:e.target.value}),required:!0,disabled:q}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_important",checked:v.is_important,onChange:e=>_({...v,is_important:e.target.checked}),className:"rounded text-blue-600",disabled:q}),e.jsx("label",{htmlFor:"is_important",className:"text-sm text-gray-700",children:"重要なお知らせとして表示する"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx(b,{type:"button",variant:"secondary",onClick:()=>C(!1),disabled:q,children:"キャンセル"}),e.jsx(b,{type:"submit",isLoading:q,children:k?"更新する":"追加する"})]})]})]})})})]})}function _(){const{user:t,isAdmin:r}=h(),a=x();return m.useEffect(()=>{r||a("/")},[r,a]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(u,{to:"/admin",children:e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:e.jsx(d,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(s,{className:"w-8 h-8 text-yellow-600 mr-3"}),"新着情報管理"]}),e.jsx("p",{className:"text-gray-600",children:"サイトの新着情報を管理します"})]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["最終更新: ",(new Date).toLocaleString("ja-JP")]})]}),e.jsx(v,{})]})}export{_ as AdminNewsManagement};
