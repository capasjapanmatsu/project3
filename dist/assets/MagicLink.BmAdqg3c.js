import{j as e,C as s,B as t,s as a,a as r}from"./index.D9xag4tn.js";import{u as n,b as i,r as o}from"./router.BWT_vQps.js";import{s as l,p as c,a as m}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function d(){const d=n(),x=i(),[u,h]=o.useState(!0),[p,f]=o.useState(null),[j,b]=o.useState(!1);return o.useEffect((()=>{var e,s,t;e=null,s=null,t=function*(){var e;try{h(!0);const s=window.location.hash;if(!s||!s.includes("access_token"))return void f("無効なMagic Linkです。もう一度ログインしてください。");const t=new URLSearchParams(s.substring(1)),n=t.get("access_token"),i=t.get("refresh_token");if(!n||!i)return void f("認証トークンが見つかりません。もう一度ログインしてください。");const{error:o}=yield a.auth.setSession({access_token:n,refresh_token:i});if(o)throw o;const{data:{user:l},error:c}=yield a.auth.getUser();if(c||!l)throw c||new Error("ユーザー情報の取得に失敗しました");const{data:m,error:x}=yield a.from("profiles").select("id").eq("id",l.id).maybeSingle();if(x&&x.code,!m){const s=l.user_metadata||{},{error:t}=yield a.from("profiles").upsert([{id:l.id,user_type:s.user_type||"user",name:s.name||(null==(e=l.email)?void 0:e.split("@")[0])||"ユーザー",postal_code:s.postal_code||"",address:s.address||"",phone_number:s.phone_number||""}],{onConflict:"id"})}l&&r(`trusted_device_${l.id}`,"true"),b(!0),setTimeout((()=>{d("/dashboard")}),2e3)}catch(s){f(s.message||"マジックリンクの送信に失敗しました")}finally{h(!1)}},new Promise(((a,r)=>{var n=e=>{try{o(t.next(e))}catch(s){r(s)}},i=e=>{try{o(t.throw(e))}catch(s){r(s)}},o=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,i);o((t=t.apply(e,s)).next())}))}),[d,x]),u?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(s,{className:"text-center p-8",children:[e.jsx(l,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(s,{className:"text-center p-8",children:[e.jsx(c,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p}),e.jsx(t,{onClick:()=>d("/login"),children:"ログインページに戻る"})]})}):j?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(s,{className:"text-center p-8",children:[e.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(t,{onClick:()=>d("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{d as MagicLink};
