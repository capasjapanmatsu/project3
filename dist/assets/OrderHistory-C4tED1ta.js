import{u as Z,s as I,j as e,B as c,C as B}from"./index-fyCrE4_U.js";import{d as K,r as o,L as j}from"./react-vendor-Co5xHYdE.js";import{V as Q,_ as D,c as ee,Y as se,Z as te,p as ae,i as y,A as J,D as ne,C as w,w as le,G as ce,X as S,au as re}from"./ui-vendor-C9ptRAmi.js";import"./supabase-vendor-FDBaXLCh.js";function xe(){const{user:u}=Z(),g=K(),[f,E]=o.useState([]),[U,q]=o.useState(!0),[a,b]=o.useState(null),[F,$]=o.useState(!1),[R,M]=o.useState(!1),[O,T]=o.useState(null),[z,C]=o.useState(null),[P,N]=o.useState(null);o.useEffect(()=>{if(u){A();const s=setInterval(()=>{V()},6e4);return()=>clearInterval(s)}g.state?.orderSuccess&&($(!0),setTimeout(()=>$(!1),5e3))},[u,g]);const A=async()=>{try{const{data:s,error:n}=await I.from("orders").select(`
          *,
          order_items (
            *,
            product:products (*)
          )
        `).eq("user_id",u?.id).order("created_at",{ascending:!1});if(n)throw n;const l=(s||[]).map(i=>{const d=i.cancellable_until?new Date(i.cancellable_until):null,m=new Date,r=d&&m<d&&["pending","confirmed"].includes(i.status);let t;if(r&&d){const x=d.getTime()-m.getTime(),_=Math.floor(x/6e4),v=Math.floor(x%6e4/1e3);t=`${_}分${v}秒`}return{...i,can_cancel:r,time_left:t}});E(l)}catch(s){console.error("Error fetching orders:",s)}finally{q(!1)}},V=()=>{const s=new Date;E(n=>n.map(l=>{const i=l.cancellable_until?new Date(l.cancellable_until):null,d=i&&s<i&&["pending","confirmed"].includes(l.status);let m;if(d&&i){const r=i.getTime()-s.getTime(),t=Math.floor(r/6e4),x=Math.floor(r%6e4/1e3);m=`${t}分${x}秒`}return{...l,can_cancel:d,time_left:m}}))},H=s=>{switch(s){case"pending":return e.jsx(w,{className:"w-5 h-5 text-yellow-600"});case"confirmed":return e.jsx(y,{className:"w-5 h-5 text-blue-600"});case"processing":return e.jsx(D,{className:"w-5 h-5 text-purple-600"});case"shipped":return e.jsx(re,{className:"w-5 h-5 text-orange-600"});case"delivered":return e.jsx(y,{className:"w-5 h-5 text-green-600"});case"cancelled":return e.jsx(S,{className:"w-5 h-5 text-red-600"});default:return e.jsx(w,{className:"w-5 h-5 text-gray-600"})}},L=s=>({pending:"注文受付中",confirmed:"注文確定",processing:"準備中",shipped:"発送済み",delivered:"配達完了",cancelled:"キャンセル"})[s]||s,G=s=>({pending:"text-yellow-600 bg-yellow-100",confirmed:"text-blue-600 bg-blue-100",processing:"text-purple-600 bg-purple-100",shipped:"text-orange-600 bg-orange-100",delivered:"text-green-600 bg-green-100",cancelled:"text-red-600 bg-red-100"})[s]||"text-gray-600 bg-gray-100",k=s=>({credit_card:"クレジットカード",bank_transfer:"銀行振込",cod:"代金引換"})[s]||s,W=()=>{if(f.length===0)return;const s="\uFEFF",n=["注文番号","注文日","ステータス","商品名","数量","単価","小計","割引","送料","合計金額","支払い方法","配送先氏名","配送先住所","配送先電話番号"].join(","),l=[];f.forEach(t=>{const x=new Date(t.created_at).toLocaleDateString("ja-JP"),_=L(t.status),v=k(t.payment_method);if(t.order_items&&t.order_items.length>0)t.order_items.forEach((p,h)=>{const Y=[t.order_number,x,_,`"${p.product.name.replace(/"/g,'""')}"`,p.quantity,p.unit_price,p.total_price,h===0?t.discount_amount:"",h===0?t.shipping_fee:"",h===0?t.final_amount:"",h===0?v:"",h===0?`"${t.shipping_name.replace(/"/g,'""')}"`:"",h===0?`"${t.shipping_address.replace(/"/g,'""')}"`:"",h===0?t.shipping_phone:""].join(",");l.push(Y)});else{const p=[t.order_number,x,_,"商品なし","","","",t.discount_amount,t.shipping_fee,t.final_amount,v,`"${t.shipping_name.replace(/"/g,'""')}"`,`"${t.shipping_address.replace(/"/g,'""')}"`,t.shipping_phone].join(",");l.push(p)}});const i=s+[n,...l].join(`
`),d=new Blob([i],{type:"text/csv;charset=utf-8;"}),m=URL.createObjectURL(d),r=document.createElement("a");r.setAttribute("href",m),r.setAttribute("download",`注文履歴_${new Date().toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)},X=async s=>{try{M(!0),T(null),C(null);const{data:n,error:l}=await I.rpc("cancel_order",{order_id:s,user_id:u?.id});if(l)throw l;if(!n.success)throw new Error(n.message||"キャンセルに失敗しました");C("注文をキャンセルしました"),N(null),await A(),setTimeout(()=>{C(null)},3e3)}catch(n){console.error("Error cancelling order:",n),T("注文のキャンセルに失敗しました。")}finally{M(!1)}};return U?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(j,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(D,{className:"w-8 h-8 text-green-600 mr-3"}),"注文履歴"]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx(j,{to:"/profile-settings",children:e.jsxs(c,{variant:"secondary",size:"sm",children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),e.jsx(j,{to:"/payment-method-settings",children:e.jsxs(c,{variant:"secondary",size:"sm",children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),e.jsx(j,{to:"/dogpark-history",children:e.jsxs(c,{variant:"secondary",size:"sm",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"ドッグラン利用履歴"]})}),e.jsx(j,{to:"/shop",children:e.jsxs(c,{variant:"secondary",size:"sm",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"ショップに戻る"]})})]}),F&&g.state?.orderNumber&&e.jsxs("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:"ご注文ありがとうございます！"})]}),e.jsxs("p",{className:"text-green-700 mt-1",children:["注文番号: ",g.state.orderNumber," のご注文を承りました。"]})]}),z&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:z})]})}),O&&e.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),e.jsx("p",{className:"text-red-700 mt-1",children:O})]}),f.length===0?e.jsxs(B,{className:"text-center py-12",children:[e.jsx(D,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"注文履歴がありません"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"まだ商品をご注文いただいていません"}),e.jsx(c,{onClick:()=>window.location.href="/shop",children:"ショッピングを始める"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs(c,{variant:"secondary",size:"sm",onClick:W,children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),f.map(s=>e.jsxs(B,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["注文番号: ",s.order_number]}),e.jsxs("div",{className:`flex items-center space-x-1 px-2 py-1 rounded-full text-sm ${G(s.status)}`,children:[H(s.status),e.jsx("span",{children:L(s.status)})]}),s.can_cancel&&e.jsxs("div",{className:"text-xs text-orange-600 flex items-center",children:[e.jsx(w,{className:"w-3 h-3 mr-1"}),"キャンセル可能: あと",s.time_left]})]}),e.jsxs("p",{className:"text-gray-600 text-sm",children:["注文日: ",new Date(s.created_at).toLocaleDateString("ja-JP")]}),s.estimated_delivery_date&&e.jsxs("p",{className:"text-gray-600 text-sm",children:["お届け予定日: ",new Date(s.estimated_delivery_date).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",s.final_amount.toLocaleString()]}),e.jsx("p",{className:"text-sm text-gray-500",children:k(s.payment_method)})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[s.order_items.slice(0,3).map(n=>e.jsxs("div",{className:"flex items-center space-x-4 bg-gray-50 p-3 rounded-lg",children:[e.jsx("img",{src:n.product.image_url,alt:n.product.name,className:"w-16 h-16 object-cover rounded",onError:l=>{l.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:n.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["数量: ",n.quantity," × ¥",n.unit_price.toLocaleString()]})]}),e.jsxs("p",{className:"font-medium",children:["¥",n.total_price.toLocaleString()]})]},n.id)),s.order_items.length>3&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["他 ",s.order_items.length-3," 点"]})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg mb-4",children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送先"}),e.jsxs("p",{className:"text-sm text-blue-800",children:[s.shipping_name,e.jsx("br",{}),"〒",s.shipping_postal_code,e.jsx("br",{}),s.shipping_address,e.jsx("br",{}),s.shipping_phone]})]}),s.tracking_number&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg mb-4",children:[e.jsx("h4",{className:"font-semibold text-orange-900 mb-1",children:"配送追跡"}),e.jsxs("p",{className:"text-sm text-orange-800",children:["追跡番号: ",s.tracking_number]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(c,{variant:"secondary",size:"sm",onClick:()=>b(s),children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"詳細を見る"]}),s.status==="delivered"&&e.jsxs(c,{variant:"secondary",size:"sm",onClick:()=>{alert("レビュー機能は準備中です")},children:[e.jsx(ce,{className:"w-4 h-4 mr-1"}),"レビューを書く"]})]}),s.can_cancel&&e.jsxs(c,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700",onClick:()=>N(s.id),children:[e.jsx(S,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]},s.id))]}),a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:"注文詳細"}),e.jsx("button",{onClick:()=>b(null),className:"text-gray-500 hover:text-gray-700",children:e.jsx(S,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"注文情報"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"注文番号:"})," ",a.order_number]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"注文日:"})," ",new Date(a.created_at).toLocaleDateString("ja-JP")]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"ステータス:"})," ",L(a.status)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"支払い方法:"})," ",k(a.payment_method)]}),a.estimated_delivery_date&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"お届け予定日:"})," ",new Date(a.estimated_delivery_date).toLocaleDateString("ja-JP")]}),a.can_cancel&&e.jsxs("div",{className:"mt-2 p-2 bg-orange-50 rounded-lg",children:[e.jsxs("p",{className:"text-orange-800 flex items-center",children:[e.jsx(w,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["キャンセル可能時間: あと",a.time_left]})]}),e.jsx("p",{className:"text-xs text-orange-700 mt-1",children:"注文から15分以内はキャンセル可能です"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"配送先"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium",children:a.shipping_name}),e.jsxs("p",{children:["〒",a.shipping_postal_code]}),e.jsx("p",{children:a.shipping_address}),e.jsx("p",{children:a.shipping_phone})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"注文商品"}),e.jsx("div",{className:"space-y-3",children:a.order_items.map(s=>e.jsxs("div",{className:"flex items-center space-x-4 border-b pb-3",children:[e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["¥",s.unit_price.toLocaleString()," × ",s.quantity]})]}),e.jsxs("p",{className:"font-medium",children:["¥",s.total_price.toLocaleString()]})]},s.id))})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"料金詳細"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",a.total_amount.toLocaleString()]})]}),a.discount_amount>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsx("span",{children:"割引"}),e.jsxs("span",{children:["-¥",a.discount_amount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"送料"}),e.jsx("span",{children:a.shipping_fee===0?"無料":`¥${a.shipping_fee.toLocaleString()}`})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",a.final_amount.toLocaleString()]})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>b(null),children:"閉じる"}),a.can_cancel&&e.jsxs(c,{className:"bg-red-600 hover:bg-red-700",onClick:()=>{b(null),N(a.id)},children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"注文をキャンセル"]})]})]})})}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(J,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"注文をキャンセルしますか？"}),e.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(c,{variant:"secondary",onClick:()=>N(null),children:"戻る"}),e.jsx(c,{className:"bg-red-600 hover:bg-red-700",isLoading:R,onClick:()=>X(P),children:"キャンセルする"})]})]})})]})}export{xe as OrderHistory};
