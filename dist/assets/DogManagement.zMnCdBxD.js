const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug.VbQXCuB-.js","assets/admin-pages.BuCPNRRu.js","assets/ui-vendor.5lywbznV.js","assets/react-vendor.C7ykWfwV.js","assets/supabase-vendor.CX-WoPCS.js","assets/directVaccineUpload.B2aBke-V.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-vendor.CX-WoPCS.js";import{j as r,a7 as t,P as a,N as i}from"./ui-vendor.5lywbznV.js";import{r as s,L as o}from"./react-vendor.C7ykWfwV.js";import{u as n,a as c,s as d,l,B as m,C as g}from"./admin-pages.BuCPNRRu.js";import{D as u,a as p}from"./DogCard.gg2WsFJU.js";import"./dogBreeds.6lxY8Uni.js";import"./park-pages.DqtvJl8J.js";import"./stripe-vendor.CcgPsVUa.js";function f(){const{user:f}=n(),[h,v]=s.useState([]),[b,x]=s.useState(!0),[y,_]=s.useState(""),[w,j]=s.useState(!1),[E,S]=s.useState(null),[D,N]=s.useState(!1),[$,C]=s.useState(""),[I,R]=s.useState(""),[U,V]=s.useState(!1),[A,z]=s.useState({name:"",breed:"",gender:"",birthDate:""}),[F,L]=s.useState(null),[P,T]=s.useState(null),[q,B]=s.useState(null),[M,O]=s.useState(null),[W,k]=s.useState(""),[G,H]=s.useState("");s.useEffect(()=>{f&&J()},[f]);const J=async()=>{try{x(!0),_("");const e=await c(()=>d.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",null==f?void 0:f.id).order("created_at",{ascending:!1}));if(e.error)return l("error","Error fetching dogs",{error:e.error,userId:null==f?void 0:f.id}),void _("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");v(e.data||[])}catch(e){l("error","Exception in fetchDogs",{error:e,userId:null==f?void 0:f.id}),_("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")}finally{x(!1)}},K=e=>{var r;S(e),z({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date}),T(e.image_url||null);const t=null==(r=e.vaccine_certifications)?void 0:r[0];t&&(k(t.rabies_expiry_date||""),H(t.combo_expiry_date||"")),j(!0)};return b?r.jsxs("div",{className:"flex justify-center items-center h-64",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),r.jsx("p",{className:"ml-3 text-gray-600",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­..."})]}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsxs(o,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[r.jsx(t,{className:"w-4 h-4 mr-1"}),"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹"]}),r.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"}),r.jsx("p",{className:"text-gray-600",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™"})]}),r.jsx(o,{to:"/register-dog",children:r.jsxs(m,{children:[r.jsx(a,{className:"w-4 h-4 mr-2"}),"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²"]})})]}),y&&r.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:y}),I&&r.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:I}),r.jsxs(g,{children:[r.jsx("div",{className:"flex justify-between items-center mb-4",children:r.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[r.jsx(i,{className:"w-6 h-6 text-blue-600 mr-2"}),"ç™»éŒ²æ¸ˆã¿ãƒ¯ãƒ³ã¡ã‚ƒã‚“ (",h.length,"åŒ¹)"]})}),0===h.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(i,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 mb-4",children:"ã¾ã ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),r.jsx(o,{to:"/register-dog",children:r.jsxs(m,{children:[r.jsx(a,{className:"w-4 h-4 mr-2"}),"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"]})})]}):r.jsx("div",{className:"space-y-4",children:h.map(e=>r.jsx(u,{dog:e,onEdit:K},e.id))})]}),w&&E&&r.jsx(p,{dog:E,isUpdating:D||U,error:$,success:I,dogFormData:A,dogImagePreview:P,onClose:()=>j(!1),onSubmit:async r=>{if(r.preventDefault(),E){N(!0),C(""),R("");try{const r={name:A.name,breed:A.breed,gender:A.gender,birth_date:A.birthDate};if(F){if(!F.type||!F.type.startsWith("image/"))throw new Error(`ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${F.type}`);const e=`${E.id}/dog-photo.jpg`,t=`${"https://onmcivwxtzqajcovptgf.supabase.co"}/storage/v1/object/dog-images/${e}`,{data:{session:a}}=await d.auth.getSession();if(!(null==a?void 0:a.access_token))throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");const i=await fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${a.access_token}`,"Content-Type":F.type,"Cache-Control":"3600"},body:F});if(!i.ok){const e=await i.text();throw l("error","âŒ Direct upload failed",{error:e}),new Error(`ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${i.status} ${e}`)}await i.json();const{data:{publicUrl:s}}=d.storage.from("dog-images").getPublicUrl(e);r.image_url=s}const{error:t}=await d.from("dogs").update(r).eq("id",E.id);if(t)throw t;if(q&&M&&W&&G){const r=q.name.split(".").pop()||"jpg",t=M.name.split(".").pop()||"jpg",a=Date.now(),i=`temp/${E.id}/rabies_${a}.${r}`,s=`temp/${E.id}/combo_${a}.${t}`,{debugAuthStatus:o}=await e(async()=>{const{debugAuthStatus:e}=await import("./authDebug.VbQXCuB-.js");return{debugAuthStatus:e}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);await o();const{directVaccineUpload:n}=await e(async()=>{const{directVaccineUpload:e}=await import("./directVaccineUpload.B2aBke-V.js");return{directVaccineUpload:e}},__vite__mapDeps([5,1,2,3,4]),import.meta.url),[c,m]=await Promise.all([n(i,q),n(s,M)]);if(!c.success||!m.success){l("error","ğŸš¨ === VACCINE UPLOAD ERROR DETAILS ==="),c.success||l("error","âŒ Rabies upload error",{error:c.error}),m.success||l("error","âŒ Combo upload error",{error:m.error});const e=c.error||m.error||"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";throw new Error(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e}`)}const g=c.url,u=m.url,{error:p}=await d.from("vaccine_certifications").upsert([{dog_id:E.id,rabies_vaccine_image:g,combo_vaccine_image:u,rabies_expiry_date:W,combo_expiry_date:G,status:"pending"}],{onConflict:"dog_id"});if(p)throw l("error","âŒ Database save error",{error:p}),p.message&&p.message.includes("520")?new Error("ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"):new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${p.message}`)}R("ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await J(),setTimeout(()=>{j(!1),R(""),L(null),T(null),B(null),O(null),k(""),H("")},2e3)}catch(t){l("error","Error updating dog",{error:t,dogId:null==E?void 0:E.id});let e="ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";t instanceof Error&&(e=t.message.includes("520")||t.message.includes("Cloudflare")?"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚":t.message.includes("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")?t.message:`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${t.message}`),C(e)}finally{N(!1)}}},onDelete:async e=>{var r;V(!0),C("");try{const{error:a}=await d.from("vaccine_certifications").delete().eq("dog_id",e.id);if(a&&l("warn","Error deleting vaccine certifications",{error:a,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],a=`${e.id}/${t}`,{error:i}=await d.storage.from("dog-images").remove([a])}catch(t){}const i=null==(r=e.vaccine_certifications)?void 0:r[0];if(i){const e=[];if(i.rabies_vaccine_image&&e.push(i.rabies_vaccine_image),i.combo_vaccine_image&&e.push(i.combo_vaccine_image),e.length>0){const{error:r}=await d.storage.from("vaccine-certs").remove(e)}}const{error:s}=await d.from("dogs").delete().eq("id",e.id);if(s)throw l("error","Error deleting dog",{error:s,dogId:e.id}),s;await J(),j(!1),R(`${e.name}ã®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`),setTimeout(()=>{R("")},3e3)}catch(a){l("error","Error deleting dog",{error:a,dogId:null==e?void 0:e.id});const r=a.message||"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ";C(r)}finally{V(!1)}},onFormChange:z,onImageSelect:async e=>{var r;const t=null==(r=e.target.files)?void 0:r[0];if(l("info","ğŸ” File selected:",t?{name:t.name,type:t.type,size:t.size,lastModified:t.lastModified,isFileObject:t instanceof File}:{message:"No file selected"}),t)try{if(!(t instanceof File))return void C("æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");if(t.size>10485760)return void C("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type||!t.type.startsWith("image/"))return void C(`ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${t.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return void C(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${t.type}`);L(t),l("info","âœ… Dog image file set successfully:",{name:t.name,type:t.type,size:t.size});const e=new FileReader;e.onload=e=>{var r;T(null==(r=e.target)?void 0:r.result)},e.readAsDataURL(t)}catch(a){C("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}},onImageRemove:async()=>{if(E&&E.image_url)try{N(!0),C("");try{const e=new URL(E.image_url).pathname.split("/"),r=e[e.length-1],t=`${E.id}/${r}`,{error:a}=await d.storage.from("dog-images").remove([t])}catch(e){l("warn","Warning: Error processing image deletion",{error:e})}const r=await c(()=>d.from("dogs").update({image_url:null}).eq("id",E.id));if(r.error)return l("error","Error updating dog image_url",{error:r.error,dogId:E.id}),void C("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");L(null),T(null),S({...E,image_url:void 0}),await J(),l("info","âœ… Dog image removed successfully",{dogId:E.id}),R("ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"),setTimeout(()=>{R("")},3e3)}catch(r){l("error","Error removing dog image",{error:r,dogId:null==E?void 0:E.id}),C("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{N(!1)}},rabiesVaccineFile:q,comboVaccineFile:M,rabiesExpiryDate:W,comboExpiryDate:G,onRabiesVaccineSelect:async e=>{var r;const t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>10485760)return void C("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type.startsWith("image/"))return void C("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");B(t)}else B(null)},onComboVaccineSelect:async e=>{var r;const t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>10485760)return void C("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type.startsWith("image/"))return void C("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");O(t)}else O(null)},onRabiesExpiryDateChange:k,onComboExpiryDateChange:H})]})}export{f as DogManagement};
