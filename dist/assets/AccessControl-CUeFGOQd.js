import{j as e,K as s,A as t,g as r,d as a,V as l,P as n,b as c}from"./ui-vendor-B03FHkej.js";import{r as i,u as d}from"./react-vendor-BBLDtDmh.js";import{C as x,B as m,u as o,b as h,s as u}from"./index-CWMjoAp3.js";import{V as j,g}from"./VaccineBadge-CXOJLvpp.js";import"./query-vendor-Cy2yKKks.js";import"./supabase-vendor-BcfcqyaE.js";function N({lockId:l,parkName:n="ドッグパーク",purpose:c="entry",className:d="",onSuccess:o,onError:h}){const[u,j]=i.useState(""),[g,N]=i.useState(!1),[f,b]=i.useState(null),[p,y]=i.useState(null);return e.jsx(x,{className:`p-4 ${d}`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-center",children:[e.jsx(s,{className:"w-5 h-5 text-blue-600 mr-2"}),n,"の","entry"===c?"入口":"出口"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-gray-600 mb-4",children:["entry"===c?"入場":"退場","用のPINコードを入力してください"]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("input",{type:"text",value:u,onChange:e=>{const s=e.target.value.replace(/\D/g,"");s.length<=6&&j(s)},placeholder:"6桁のPINコード",className:"px-4 py-2 text-center text-2xl tracking-widest w-48 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:6,inputMode:"numeric",pattern:"[0-9]*"})}),f&&e.jsxs("div",{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",children:[e.jsx(t,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:f})]}),p&&e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",children:[e.jsx(r,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:p})]}),e.jsxs(m,{onClick:()=>{(async()=>{if(6===u.length){N(!0),b(null),y(null);try{const e=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lock_id:l,pin:u,purpose:c})});if(!e.ok){const s=await e.json();throw new Error(s.error||"PINコードの検証に失敗しました")}const s=await e.json();if(!s.success)throw new Error(s.error||"PINコードが無効です");y(s.message||"PINコードが確認されました"),j(""),o&&o(s),setTimeout(()=>{y(null)},3e3)}catch(e){const s=e.message||"PINコードの検証に失敗しました";b(s),h&&h(s)}finally{N(!1)}}else b("PINコードは6桁で入力してください")})()},isLoading:g,disabled:6!==u.length,className:"w-full",children:[e.jsx(s,{className:"w-4 h-4 mr-2"}),g?e.jsx(a,{className:"w-4 h-4 animate-spin"}):"PINコードを確認"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["entry"===c?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]})]})})}function f(){const{user:a}=o(),f=d();h();const[b,p]=i.useState([]),[y,v]=i.useState([]),[w,k]=i.useState([]),[P,I]=i.useState([]),[S,_]=i.useState(null),[C,q]=i.useState(!1),[E,T]=i.useState(""),[z,B]=i.useState("");i.useEffect(()=>{(async()=>{if(a)try{const{data:e,error:s}=await u.from("dogs").select("\n            *,\n            vaccine_certifications (\n              id,\n              status,\n              rabies_expiry_date,\n              combo_expiry_date,\n              approved_at\n            )\n          ").eq("owner_id",a.id);if(s)throw s;const t=(e||[]).filter(e=>"approved"===g(e));p(t),e&&e.length>0&&0===t.length&&T("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")}catch(e){T("ワンちゃんの情報を取得できませんでした。")}})(),(async()=>{try{q(!0);const{data:e,error:s}=await u.from("dog_parks").select("*").eq("status","approved");if(s)throw s;k(e||[]);const{data:t,error:r}=await u.from("smart_locks").select("*").eq("status","active");if(r)throw r;v(t||[]),t&&t.length>0&&_(t[0])}catch(e){T("データの取得に失敗しました。")}finally{q(!1)}})()},[a]);const V=e=>"オス"===e?"くん":"ちゃん";return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(m,{variant:"primary",size:"sm",onClick:()=>f(-1),className:"mr-3",children:[e.jsx(l,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),E&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:E}),z&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:z}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(x,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(n,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),0===b.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(t,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),e.jsx(m,{onClick:()=>f("/register-dog"),children:"ワンちゃんを登録する"})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",3,"頭）"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[P.length,"/",3,"頭選択中"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:b.map(s=>{const t=P.includes(s.id),a=!t&&P.length>=3;return e.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(t?"border-green-500 bg-green-50":a?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>{return!a&&(e=s.id,void I(s=>s.includes(e)?s.filter(s=>s!==e):s.length<3?[...s,e]:s));var e},children:[t&&e.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:e.jsx(r,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(n,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold",children:[s.name,V(s.gender)]}),e.jsx(j,{status:g(s),size:"sm"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.breed," • ",s.gender]})]})]})]},s.id)})}),P.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),e.jsx("p",{className:"text-sm text-green-800",children:P.map(e=>{const s=b.find(s=>s.id===e);return s?`${s.name}${V(s.gender)}`:""}).filter(Boolean).join("、")}),e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[P.length,"頭が同時入場できます"]})]})]})})]}),e.jsxs(x,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(c,{className:"w-5 h-5 text-blue-600 mr-2"}),"施設を選択"]}),0===y.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(s,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"利用可能な施設がありません"})]}):e.jsx("div",{className:"space-y-3",children:y.map(s=>{const t=w.find(e=>e.id===s.park_id),a=S?.id===s.id;return e.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+(a?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>_(s),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t?.name||"Unknown Park"}),e.jsx("p",{className:"text-sm text-gray-600",children:s.lock_name}),e.jsx("p",{className:"text-xs text-gray-500",children:t?.address})]}),a&&e.jsx(r,{className:"w-5 h-5 text-blue-600"})]})},s.id)})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(x,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(s,{className:"w-5 h-5 text-blue-600 mr-2"}),"PINコード生成"]}),S&&P.length>0?e.jsx(N,{lockId:S.lock_id,parkName:w.find(e=>e.id===S.park_id)?.name||"ドッグパーク",purpose:"entry",onSuccess:e=>{B("PINコードを生成しました"),setTimeout(()=>{B("")},3e3)},onError:e=>{T(e),setTimeout(()=>{T("")},5e3)}}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(t,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-2",children:"PINコードを生成するには："}),e.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[e.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),e.jsx("li",{children:"• 施設を選択"})]})]})]}),e.jsxs(x,{className:"p-6 bg-blue-50 border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"PINコードの使い方"}),e.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"1"}),e.jsx("p",{children:"ワンちゃんと施設を選択してPINコードを生成します"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"2"}),e.jsx("p",{children:"ドッグランの入口にあるスマートロックのキーパッドにPINコードを入力します"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"3"}),e.jsx("p",{children:"PINコードは5分間有効です"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"4"}),e.jsx("p",{children:"退場時も同様にPINコードを生成して使用します"})]})]})]})]})]})]})}export{f as AccessControl};
