import{j as e,g as V,k as E,J as X,A as z,c as G,u as H,b as I,N as A,I as K,a as P,ao as Q}from"./ui-vendor-w2MLOks7.js";import{u as W,d as Y,r,L as b}from"./react-vendor-_GyjDmDn.js";import{u as Z,s as j,C as m,B as f}from"./index-pj4YkVsE.js";import{I as x}from"./Input-BBFNs-Kh.js";import{u as ee}from"./useStripe-BQYBjCbE.js";import"./supabase-vendor-Df9iqQzW.js";function ne(){const{user:n}=Z(),h=W(),N=Y(),{createCheckoutSession:q,loading:D,error:v}=ee(),[U,w]=r.useState(!0),[y,i]=r.useState(null),[u,S]=r.useState([]),[F,C]=r.useState(!1),[_,k]=r.useState(null),[$,M]=r.useState(!1),[T,B]=r.useState(!1),[t,l]=r.useState({name:"",postalCode:"",address:"",phoneNumber:"",email:"",notes:""}),[c,J]=r.useState({subtotal:0,originalSubtotal:0,discountAmount:0,shippingFee:0,total:0});r.useEffect(()=>{if(!n){h("/login");return}const s=N.state;if(!s){h("/cart");return}s.totals&&J(s.totals),O(s)},[n,h,N]);const O=async s=>{try{w(!0);const{data:a,error:p}=await j.from("profiles").select("*").eq("id",n?.id).single();if(p)throw p;if(l({name:a.name||"",postalCode:a.postal_code||"",address:a.address||"",phoneNumber:a.phone_number||"",email:n?.email||"",notes:""}),s.cartItems&&s.cartItems.length>0){const{data:d,error:o}=await j.from("cart_items").select("*, product:products(*)").in("id",s.cartItems).eq("user_id",n?.id);if(o)throw o;S(d||[])}else{const{data:d,error:o}=await j.from("cart_items").select("*, product:products(*)").eq("user_id",n?.id);if(o)throw o;S(d||[])}const g=new URLSearchParams(window.location.search);if(g.get("success")==="true")M(!0),k(g.get("order_number")||L());else if(g.get("canceled")==="true"){B(!0),i("æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");const{data:{user:d}}=await j.auth.getUser();d||(console.warn("âš ï¸ User session lost after payment cancellation"),localStorage.getItem("pre_payment_auth_state")&&(console.log("ğŸ”„ Attempting to restore authentication state"),i("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚"),setTimeout(()=>{h("/login")},3e3))),window.history.replaceState({},document.title,window.location.pathname)}}catch(a){console.error("Error fetching checkout data:",a),i(a.message||"ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")}finally{w(!1)}},L=()=>`DP${Date.now()}${Math.floor(Math.random()*1e3)}`,R=async s=>{if(s.preventDefault(),u.length===0){i("ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");return}try{if(C(!0),i(null),!t.name.trim())throw new Error("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");if(!t.postalCode.trim())throw new Error("éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");if(!t.address.trim())throw new Error("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");if(!t.phoneNumber.trim())throw new Error("é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");const a=L();k(a),await q({priceId:"price_placeholder",mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&order_number=${a}`,cancelUrl:`${window.location.origin}/checkout?canceled=true`,cartItems:u.map(p=>p.id),customParams:{shipping_name:t.name,shipping_address:t.address,shipping_postal_code:t.postalCode,shipping_phone:t.phoneNumber,notes:t.notes,order_number:a}})}catch(a){i(a.message||"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"),C(!1)}};return U?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):$&&_?e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs(m,{className:"p-8 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(V,{className:"w-12 h-12 text-green-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼"}),e.jsxs("p",{className:"text-lg text-gray-600 mb-6",children:["æ³¨æ–‡ç•ªå·: ",e.jsx("span",{className:"font-semibold",children:_})]}),e.jsx("div",{className:"bg-blue-50 p-6 rounded-lg mb-8 max-w-xl mx-auto",children:e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(E,{className:"w-6 h-6 text-blue-600 mr-3"}),e.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°æ³¨æ–‡"})]}),e.jsx("p",{className:"text-blue-800 mb-2",children:"ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å•†å“ã®ç™ºé€æº–å‚™ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚"}),e.jsx("p",{className:"text-blue-800",children:"æ³¨æ–‡ã®è©³ç´°ã¯ã€Œæ³¨æ–‡å±¥æ­´ã€ãƒšãƒ¼ã‚¸ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚"})]})}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx(b,{to:"/orders",children:e.jsx(f,{children:"æ³¨æ–‡å±¥æ­´ã‚’è¦‹ã‚‹"})}),e.jsx(b,{to:"/shop",children:e.jsx(f,{variant:"secondary",children:"ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚’ç¶šã‘ã‚‹"})})]})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(b,{to:"/cart",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"ã‚«ãƒ¼ãƒˆã«æˆ»ã‚‹"]})}),e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(E,{className:"w-8 h-8 text-green-600 mr-3"}),"ãŠæ”¯æ‰•ã„æƒ…å ±"]}),(y||v)&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(z,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800",children:"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}),e.jsx("p",{className:"text-red-700",children:y||v}),T&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-red-700",children:"æ”¯æ‰•ã„å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ã”ç¢ºèªãã ã•ã„ï¼š"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-red-700 mt-1",children:[e.jsx("li",{children:"ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„"}),e.jsx("li",{children:"åˆ¥ã®æ”¯æ‰•ã„æ–¹æ³•ã‚’ãŠè©¦ã—ãã ã•ã„"}),e.jsx("li",{children:"ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(m,{className:"p-6",children:e.jsxs("form",{onSubmit:R,children:[e.jsx("h2",{className:"text-xl font-semibold mb-6",children:"é…é€æƒ…å ±"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsx(x,{label:"ãŠåå‰ *",value:t.name,onChange:s=>l({...t,name:s.target.value}),required:!0,icon:e.jsx(G,{className:"w-4 h-4 text-gray-500"})}),e.jsx(x,{label:"é›»è©±ç•ªå· *",value:t.phoneNumber,onChange:s=>l({...t,phoneNumber:s.target.value}),required:!0,icon:e.jsx(H,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(x,{label:"éƒµä¾¿ç•ªå· *",value:t.postalCode,onChange:s=>l({...t,postalCode:s.target.value}),required:!0,icon:e.jsx(I,{className:"w-4 h-4 text-gray-500"}),placeholder:"123-4567"})}),e.jsx("div",{className:"mb-6",children:e.jsx(x,{label:"ä½æ‰€ *",value:t.address,onChange:s=>l({...t,address:s.target.value}),required:!0,icon:e.jsx(I,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{className:"mb-6",children:[e.jsx(x,{label:"ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *",type:"email",value:t.email,onChange:s=>l({...t,email:s.target.value}),required:!0,disabled:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"æ³¨æ–‡ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã•ã‚Œã¾ã™"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"å‚™è€ƒ"}),e.jsx("textarea",{value:t.notes,onChange:s=>l({...t,notes:s.target.value}),placeholder:"é…é€ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",rows:3})]}),e.jsx("h2",{className:"text-xl font-semibold mb-4 mt-8",children:"æ”¯æ‰•ã„æ–¹æ³•"}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"w-5 h-5 text-gray-600"}),e.jsx("span",{className:"font-medium",children:"ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1 ml-7",children:"VISA, Mastercard, JCB, AMEX"})]}),e.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(K,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"æ”¯æ‰•ã„å‡¦ç†ã«ã¤ã„ã¦"}),e.jsx("p",{children:"ã€Œæ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€é¸æŠã—ãŸæ”¯æ‰•ã„æ–¹æ³•ã®æ±ºæ¸ˆç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚æ±ºæ¸ˆãŒå®Œäº†ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«æ³¨æ–‡ãŒç¢ºå®šã—ã¾ã™ã€‚"})]})]})}),e.jsx("div",{className:"p-4 bg-blue-50 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(P,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"å®‰å…¨ãªæ±ºæ¸ˆ"}),e.jsx("p",{children:"ã™ã¹ã¦ã®æ”¯æ‰•ã„æƒ…å ±ã¯æš—å·åŒ–ã•ã‚Œã¦å®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚å½“ã‚µã‚¤ãƒˆã§ã¯å®Ÿéš›ã®ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã›ã‚“ã€‚"})]})]})}),e.jsxs(f,{type:"submit",isLoading:F||D,className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",disabled:u.length===0,children:[e.jsx(A,{className:"w-5 h-5 mr-2"}),"æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹ (Â¥",c.total.toLocaleString(),")"]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"æ³¨æ–‡å†…å®¹"}),e.jsx("div",{className:"space-y-4 max-h-80 overflow-y-auto mb-4",children:u.map(s=>e.jsxs("div",{className:"flex items-center space-x-3 pb-3 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0",children:e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-full h-full object-cover",onError:a=>{a.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm",children:s.product.name}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["æ•°é‡: ",s.quantity]}),e.jsxs("span",{className:"text-sm font-medium",children:["Â¥",(s.product.price*s.quantity).toLocaleString()]})]})]})]},s.id))}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"å•†å“å°è¨ˆ"}),e.jsxs("span",{children:["Â¥",c.originalSubtotal.toLocaleString()]})]}),c.discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm text-purple-600",children:[e.jsx("span",{children:"ã‚µãƒ–ã‚¹ã‚¯å‰²å¼• (10%)"}),e.jsxs("span",{children:["-Â¥",c.discountAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"é€æ–™"}),e.jsx("span",{children:c.shippingFee===0?e.jsx("span",{className:"text-green-600",children:"ç„¡æ–™"}):`Â¥${c.shippingFee.toLocaleString()}`})]}),e.jsxs("div",{className:"flex justify-between font-bold text-base pt-2 border-t border-gray-200 mt-2",children:[e.jsx("span",{children:"åˆè¨ˆ"}),e.jsxs("span",{className:"text-green-600",children:["Â¥",c.total.toLocaleString()]})]})]})]}),e.jsx(m,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(Q,{className:"w-5 h-5 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"é…é€ã«ã¤ã„ã¦"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"â€¢ å¹³æ—¥14æ™‚ã¾ã§ã®ã”æ³¨æ–‡ã§ç¿Œæ—¥ãŠå±Šã‘"}),e.jsx("p",{children:"â€¢ åœŸæ—¥ç¥æ—¥ã‚‚é…é€ã„ãŸã—ã¾ã™"}),e.jsx("p",{children:"â€¢ é…é€çŠ¶æ³ã¯ãƒ¡ãƒ¼ãƒ«ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™"})]})]})]})}),e.jsx(m,{className:"p-4 bg-gray-50 border-gray-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(P,{className:"w-5 h-5 text-gray-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:"ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"}),e.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[e.jsx("p",{children:"â€¢ SSLæš—å·åŒ–é€šä¿¡ã§å€‹äººæƒ…å ±ã‚’ä¿è­·"}),e.jsx("p",{children:"â€¢ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“"}),e.jsx("p",{children:"â€¢ ç¬¬ä¸‰è€…èªè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–"})]})]})]})})]})]})]})}export{ne as Checkout};
