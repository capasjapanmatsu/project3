import{u as e,s,j as a,C as t,B as r}from"./index-BFgW40ku.js";import{h as i,u as l,r as c,L as d}from"./vendor-BHVjIt_u.js";import{a as n,J as m,t as x,m as o,I as h,ag as g,d as j}from"./ui-Qz4g1iz4.js";import"./supabase-CKbzEL5D.js";function u(){const{id:u,dogId:f}=i(),{user:p}=e();l();const[N,y]=c.useState(null),[v,w]=c.useState(!0),[b,_]=c.useState(""),[k,q]=c.useState(""),[S,D]=c.useState(!1),[T,$]=c.useState(!1),[C,E]=c.useState([]),[L,F]=c.useState(!1),[I,J]=c.useState(0),[M,Y]=c.useState(!1),z=u||f;c.useEffect((()=>{z&&(B(),p&&(O(),P()))}),[z,p]);const B=async()=>{try{w(!0),_("");const{data:e,error:a}=await s.from("dogs").select("*").eq("id",z).single();if(a)throw a;y(e),J(e.like_count||0);const{data:t,error:r}=await s.from("reservations").select("\n          *,\n          dog_park:dog_parks(*)\n        ").eq("dog_id",z).eq("status","confirmed");if(r)throw r;const i={};(t||[]).forEach((e=>{const s=e.park_id;e.dog_park&&(i[s]||(i[s]={park:e.dog_park,visits:0}),i[s].visits++)}));const l=Object.values(i).sort(((e,s)=>s.visits-e.visits)).slice(0,3);E(l)}catch(e){_("ワンちゃんの情報を取得できませんでした。")}finally{w(!1)}},O=async()=>{if(p&&z)try{const{data:e}=await s.from("dogs").select("owner_id").eq("id",z).single();if(!e)return;const{data:a,error:t}=await s.from("friend_requests").select("id, status").or(`and(requester_id.eq.${p.id},requested_id.eq.${e.owner_id}),and(requester_id.eq.${e.owner_id},requested_id.eq.${p.id})`).maybeSingle();!t&&a&&$(!0)}catch(e){}},P=async()=>{if(p&&z)try{const{data:e,error:a}=await s.from("dog_likes").select("id").eq("user_id",p.id).eq("dog_id",z).maybeSingle();!a&&e&&F(!0)}catch(e){}};return v?a.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:a.jsx("div",{className:"flex items-center justify-center py-20",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):b||!N?a.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:a.jsxs(t,{className:"p-8 text-center",children:[a.jsx(n,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),a.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"ワンちゃんが見つかりません"}),a.jsx("p",{className:"text-gray-600 mb-6",children:b||"ワンちゃんの情報が見つかりませんでした。"}),a.jsx(d,{to:"/",children:a.jsxs(r,{variant:"primary",children:[a.jsx(m,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})})]})}):a.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[a.jsx("div",{className:"mb-6",children:a.jsxs(d,{to:"/",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[a.jsx(m,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})}),k&&a.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[a.jsx(x,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),a.jsx("p",{className:"text-green-800",children:k})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[a.jsx("div",{className:"lg:col-span-2",children:a.jsx(t,{className:"p-6",children:a.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx("div",{className:"w-48 h-48 bg-gray-200 rounded-lg overflow-hidden",children:N.image_url?a.jsx("img",{src:N.image_url,alt:N.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/58997/pexels-photo-58997.jpeg?auto=compress&cs=tinysrgb&w=300"}}):a.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:a.jsx(n,{className:"w-12 h-12"})})})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:[N.name,(A=N.gender,"オス"===A?"くん":"ちゃん")]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx(o,{className:"w-5 h-5 text-gray-500 mr-3"}),a.jsxs("span",{className:"text-lg text-gray-700",children:[(e=>{const s=new Date,a=new Date(e);let t=s.getFullYear()-a.getFullYear();const r=s.getMonth()-a.getMonth();return(r<0||0===r&&s.getDate()<a.getDate())&&t--,t})(N.birth_date),"歳"]})]}),a.jsxs("div",{className:"flex items-center",children:[a.jsx(n,{className:"w-5 h-5 text-gray-500 mr-3"}),a.jsx("span",{className:"text-lg text-gray-700",children:N.breed})]}),a.jsxs("div",{className:"flex items-center",children:[a.jsx(h,{className:"w-5 h-5 text-gray-500 mr-3"}),a.jsx("span",{className:"text-lg text-gray-700",children:N.gender})]})]}),a.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"flex items-center space-x-2",children:a.jsxs("span",{className:"text-sm text-gray-600",children:[I,"件のいいね"]})}),p&&a.jsxs(r,{onClick:async()=>{if(p&&N&&!M){Y(!0);try{if(L){const{error:e}=await s.from("dog_likes").delete().eq("user_id",p.id).eq("dog_id",N.id);if(e)throw e;F(!1),J((e=>e-1)),q("いいねを取り消しました")}else{const{error:e}=await s.from("dog_likes").insert({user_id:p.id,dog_id:N.id});if(e)throw e;F(!0),J((e=>e+1)),q("いいねしました")}setTimeout((()=>q("")),2e3)}catch(e){_("いいねの処理に失敗しました"),setTimeout((()=>_("")),3e3)}finally{Y(!1)}}},disabled:M,variant:L?"primary":"secondary",size:"sm",className:"px-4 py-2 "+(L?"bg-pink-500 hover:bg-pink-600 text-white":"bg-white hover:bg-pink-50 text-pink-600 border-pink-300"),children:[a.jsx(h,{className:"w-4 h-4 mr-1 "+(L?"fill-current":"")}),L?"いいね済み":"いいね"]})]})}),p&&N.owner_id!==p.id&&a.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[a.jsx("div",{className:"text-center",children:T?a.jsxs("div",{className:"flex items-center justify-center text-green-600",children:[a.jsx(x,{className:"w-5 h-5 mr-2"}),a.jsx("span",{className:"font-medium",children:"友達申請済み"})]}):a.jsxs(r,{onClick:async()=>{if(p&&N){D(!0);try{const{error:e}=await s.from("friend_requests").insert({requester_id:p.id,requested_id:N.owner_id,message:"ドッグランでお会いした際は、よろしくお願いします！"});if(e)throw e;$(!0),q("友達申請を送信しました"),setTimeout((()=>q("")),3e3)}catch(e){_("友達申請の送信に失敗しました"),setTimeout((()=>_("")),3e3)}finally{D(!1)}}},isLoading:S,className:"px-8 py-3",children:[a.jsx(g,{className:"w-5 h-5 mr-2"}),"友達申請を送る"]})}),a.jsx("div",{className:"mt-4 p-4 bg-blue-50 rounded-lg",children:a.jsxs("div",{className:"text-sm text-blue-800",children:[a.jsx("p",{className:"font-medium mb-1",children:"友達申請について"}),a.jsx("p",{children:"友達申請を送ると、相手の飼い主さんに通知が届きます。 承認されると、メッセージのやり取りができるようになります。"})]})})]})]})]})})}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs(t,{className:"p-6",children:[a.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-4 flex items-center",children:[a.jsx(j,{className:"w-5 h-5 text-green-600 mr-2"}),"よく遊ぶドッグラン"]}),C.length>0?a.jsx("div",{className:"space-y-3",children:C.map(((e,s)=>a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-medium text-gray-900",children:e.park.name}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.visits,"回利用"]})]}),a.jsx("div",{className:"text-2xl",children:0===s?"🥇":1===s?"🥈":"🥉"})]},e.park.id)))}):a.jsx("p",{className:"text-gray-500",children:"まだドッグランの利用履歴がありません"})]}),a.jsxs(t,{className:"p-6",children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"登録日"}),a.jsx("p",{className:"text-gray-700",children:new Date(N.created_at).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})})]})]})]})]});var A}export{u as DogProfile};
