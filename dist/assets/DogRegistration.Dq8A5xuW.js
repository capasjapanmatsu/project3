var e=Object.defineProperty,r=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(r,a,t)=>a in r?e(r,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[a]=t,o=(e,r)=>{for(var a in r||(r={}))i.call(r,a)&&l(e,a,r[a]);if(t)for(var a of t(r))s.call(r,a)&&l(e,a,r[a]);return e},n=(e,t)=>r(e,a(t));import{u as d,j as c,B as u,C as m,s as g,n as b}from"./index.CQlxbczY.js";import{r as h}from"./vendor.CKEClKZl.js";import{L as p}from"./router.B_7Atevv.js";import{I as f}from"./Input.DMWrIIWM.js";import{S as x}from"./Select.DfMWSl4f.js";import{d as y}from"./dogBreeds.6lxY8Uni.js";import{h as v}from"./vaccineUploadFixed.jOAXESeo.js";import{l as j}from"./logger.X2WpaG9g.js";import{z as w,X as N,V as D}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";const I=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}};function S(){const{user:e}=d(),[r,a]=h.useState(!1),[t,i]=h.useState(""),[s,l]=h.useState(null),[S,E]=h.useState(null),[C,V]=h.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),P=(new Date).getFullYear(),M=Array.from({length:21},(e,r)=>{const a=P-r;return{value:a.toString(),label:`${a}年`}}),Y=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}}),O=()=>{if(!C.birthYear||!C.birthMonth||!C.birthDay)return!1;const e=parseInt(C.birthYear),r=parseInt(C.birthMonth),a=parseInt(C.birthDay),t=new Date(e,r-1,a);if(t>new Date)return!1;const i=new Date;return i.setFullYear(i.getFullYear()-20),!(t<i)},$=y.map(e=>({value:e,label:e}));return c.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[c.jsxs("div",{children:[c.jsxs(p,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[c.jsx(w,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),c.jsx("h1",{className:"text-2xl font-bold",children:"ワンちゃん登録"}),c.jsx("p",{className:"text-gray-600",children:"新しいワンちゃんを登録して、ドッグランを利用しましょう"})]}),c.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:c.jsxs("div",{className:"flex items-center justify-between",children:[c.jsxs("div",{children:[c.jsx("h3",{className:"font-medium text-blue-900",children:"既に登録済みのワンちゃんがいますか？"}),c.jsx("p",{className:"text-sm text-blue-700",children:"登録済みのワンちゃんの情報を確認・編集できます"})]}),c.jsx(p,{to:"/dog-management",children:c.jsx(u,{variant:"secondary",size:"sm",children:"ワンちゃん管理"})})]})}),c.jsx(m,{children:c.jsxs("form",{onSubmit:r=>{return t=this,o=null,n=function*(){var t,o;r.preventDefault(),a(!0),i("");try{if(j.info("=== DOG REGISTRATION START ==="),j.info("Starting dog registration for user:",null==e?void 0:e.id),!O())return i("正しい生年月日を選択してください。"),void a(!1);if(!C.rabiesExpiryDate||!C.comboExpiryDate)return i("ワクチンの有効期限を入力してください。"),void a(!1);const r=new Date,d=new Date(C.rabiesExpiryDate),c=new Date(C.comboExpiryDate);if(d<=r||c<=r)return i("ワクチンの有効期限は今日より後の日付を入力してください。"),void a(!1);const u=`${C.birthYear}-${C.birthMonth}-${C.birthDay}`;let m;if("オス"===C.gender||"male"===C.gender||"male"===C.gender.toLowerCase())m="オス";else{if("メス"!==C.gender&&"female"!==C.gender&&"female"!==C.gender.toLowerCase())return i("性別を正しく選択してください。"),void a(!1);m="メス"}j.info("Original gender:",C.gender,"Normalized gender:",m);const{data:h,error:p}=yield g.from("profiles").select("id, name, user_type").eq("id",null==e?void 0:e.id).maybeSingle();if(j.info("Profile check result:",h,p),p&&"PGRST116"!==p.code)throw j.error("Profile error:",p),p;if(h)j.info("Profile exists:",h);else{j.info("Creating profile for dog registration using upsert");const r=(null==(t=null==e?void 0:e.user_metadata)?void 0:t.name)||(null==(o=null==e?void 0:e.email)?void 0:o.split("@")[0])||"ユーザー",{data:a,error:i}=yield g.from("profiles").upsert([{id:null==e?void 0:e.id,user_type:"user",name:r,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(i)throw j.error("Profile upsert error:",i),i;j.info("Profile upserted successfully:",a)}j.info("Registering dog with data:",{name:C.name,breed:C.breed,birth_date:u,gender:m,owner_id:null==e?void 0:e.id});const{data:f,error:x}=yield g.from("dogs").insert([{name:C.name,breed:C.breed,birth_date:u,gender:m,owner_id:null==e?void 0:e.id}]).select().single();if(x)throw j.error("🚨 Dog registration error:",x),j.error("🚨 Error details:",{message:x.message,code:x.code,details:x.details,hint:x.hint}),x;j.info("✅ Dog registered successfully:",f),j.info("✅ Dog ID generated:",f.id);let y=null;if(s){j.info("Uploading dog image...");try{const e=s.name.split(".").pop()||"jpg",r=Date.now(),a=`${f.id}/profile_${r}.${e}`;j.info("Uploading to path:",a),j.info("🔧 Uploading dog image with Content-Type:",s.type);const{error:t}=yield g.storage.from("dog-images").upload(a,s,{cacheControl:"3600",upsert:!0,contentType:s.type});if(t)throw j.error("Image upload error:",t),new Error(`画像のアップロードに失敗しました: ${t.message}`);j.info("Upload successful");const{data:{publicUrl:i}}=g.storage.from("dog-images").getPublicUrl(a);y=i,j.info("Public URL generated:",y);const{error:l}=yield g.from("dogs").update({image_url:y}).eq("id",f.id);if(l)throw j.error("Error updating dog image URL:",l),new Error("画像URLの更新に失敗しました");j.info("Dog image URL updated successfully")}catch(n){j.error("Image processing error:",n),i("画像のアップロードに失敗しましたが、ワンちゃんの登録は完了しました。後でマイページから画像を追加できます。")}}if(C.rabiesVaccineImage&&C.comboVaccineImage){j.info("🧪 Starting vaccine certificates upload using utility...");const e=yield v(f.id,C.rabiesVaccineImage,C.comboVaccineImage,C.rabiesExpiryDate,C.comboExpiryDate);e.success?j.info("✅ Vaccine certificates uploaded successfully"):(j.error("Vaccine upload failed:",e.error),i(`ワクチン証明書のアップロードに失敗しました: ${e.error}`))}j.info("Dog registration completed successfully"),b.success("ワンちゃんの登録が完了しました！"),V({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),l(null),E(null)}catch(d){j.error("Registration error:",d),i("ワンちゃんの登録に失敗しました。もう一度お試しください。")}finally{a(!1)}},new Promise((e,a)=>{var i=e=>{try{l(n.next(e))}catch(r){a(r)}},s=e=>{try{l(n.throw(e))}catch(r){a(r)}},l=r=>r.done?e(r.value):Promise.resolve(r.value).then(i,s);l((n=n.apply(t,o)).next())});var t,o,n},children:[t&&c.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:t}),c.jsxs("div",{className:"mb-6",children:[c.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ワンちゃんの写真（任意）"}),S?c.jsxs("div",{className:"relative",children:[c.jsx("img",{src:S,alt:"ワンちゃんのプレビュー",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),c.jsx("button",{type:"button",onClick:()=>{l(null),E(null)},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:c.jsx(N,{className:"w-4 h-4"})}),s&&c.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:s.name})]}):c.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[c.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){if(j.info("Selected file:",a.name,a.size,a.type),a.size>10485760)return void i("画像ファイルは10MB以下にしてください。");if(!a.type.startsWith("image/"))return void i("画像ファイルを選択してください。");l(a);const e=new FileReader;e.onload=e=>{var r;E(null==(r=e.target)?void 0:r.result),j.info("Image preview created")},e.readAsDataURL(a),i("")}},className:"hidden",id:"dog-image"}),c.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[c.jsx(D,{className:"w-12 h-12 text-gray-400 mb-2"}),c.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"}),c.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (最大10MB)"})]})]})]}),c.jsx(f,{label:"名前",value:C.name,onChange:e=>V(n(o({},C),{name:e.target.value})),required:!0}),c.jsx(x,{label:"犬種",options:$,value:C.breed,onChange:e=>V(n(o({},C),{breed:e.target.value})),required:!0}),c.jsxs("div",{className:"mb-4",children:[c.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"生年月日 *"}),c.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[c.jsx("div",{children:c.jsxs("select",{value:C.birthYear,onChange:e=>{V(n(o({},C),{birthYear:e.target.value,birthDay:""}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[c.jsx("option",{value:"",children:"年"}),M.map(e=>c.jsx("option",{value:e.value,children:e.label},e.value))]})}),c.jsx("div",{children:c.jsxs("select",{value:C.birthMonth,onChange:e=>{V(n(o({},C),{birthMonth:e.target.value,birthDay:""}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[c.jsx("option",{value:"",children:"月"}),Y.map(e=>c.jsx("option",{value:e.value,children:e.label},e.value))]})}),c.jsx("div",{children:c.jsxs("select",{value:C.birthDay,onChange:e=>V(n(o({},C),{birthDay:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!C.birthYear||!C.birthMonth,children:[c.jsx("option",{value:"",children:"日"}),(()=>{if(!C.birthYear||!C.birthMonth)return Array.from({length:31},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}});const e=parseInt(C.birthYear),r=parseInt(C.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}})})().map(e=>c.jsx("option",{value:e.value,children:e.label},e.value))]})})]}),C.birthYear&&C.birthMonth&&!C.birthDay&&c.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"日を選択してください"}),C.birthYear&&C.birthMonth&&C.birthDay&&!O()&&c.jsx("p",{className:"mt-1 text-sm text-red-500",children:"正しい生年月日を選択してください（未来の日付や20年以上前の日付は選択できません）"})]}),c.jsx(x,{label:"性別",options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],value:C.gender,onChange:e=>V(n(o({},C),{gender:e.target.value})),required:!0}),c.jsxs("div",{className:"space-y-4",children:[c.jsx("h3",{className:"text-lg font-semibold",children:"ワクチン証明書"}),c.jsxs("div",{className:"mb-4",children:[c.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン接種証明書 *"}),c.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){const e=I(a);if(!e.isValid)return void i(e.error||"ファイルの検証に失敗しました");i("")}V(n(o({},C),{rabiesVaccineImage:a||null}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),c.jsxs("div",{className:"mb-4",children:[c.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン有効期限 *"}),c.jsx("input",{type:"date",value:C.rabiesExpiryDate,onChange:e=>V(n(o({},C),{rabiesExpiryDate:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]}),c.jsxs("div",{className:"mb-4",children:[c.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン接種証明書 *"}),c.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];if(a){const e=I(a);if(!e.isValid)return void i(e.error||"ファイルの検証に失敗しました");i("")}V(n(o({},C),{comboVaccineImage:a||null}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),c.jsxs("div",{className:"mb-4",children:[c.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン有効期限 *"}),c.jsx("input",{type:"date",value:C.comboExpiryDate,onChange:e=>V(n(o({},C),{comboExpiryDate:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]})]}),c.jsxs("div",{className:"space-y-3",children:[c.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:c.jsx("p",{className:"text-sm text-yellow-800",children:"※ ワクチン接種証明書は運営による確認後に承認されます。承認されるまでドッグランの利用はできません。"})}),c.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:c.jsxs("p",{className:"text-sm text-blue-800",children:[c.jsx("span",{className:"font-medium",children:"ワクチン証明書について:"}),c.jsx("br",{}),"• 管理者が確認しやすい形で保存されます",c.jsx("br",{}),"• 承認されると正式にワクチン情報として登録されます",c.jsx("br",{}),"• 承認後、全国のドッグランをご利用いただけます"]})})]}),c.jsx(u,{type:"submit",isLoading:r,className:"w-full",children:"ワンちゃんを登録する"})]})})]})}export{S as DogRegistration};
