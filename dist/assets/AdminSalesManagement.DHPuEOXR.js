var e=(e,t,s)=>new Promise(((a,n)=>{var r=e=>{try{l(s.next(e))}catch(t){n(t)}},i=e=>{try{l(s.throw(e))}catch(t){n(t)}},l=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,i);l((s=s.apply(e,t)).next())}));import{u as t,s,j as a,C as n,B as r}from"./index.D9xag4tn.js";import{u as i,r as l,L as c}from"./router.BWT_vQps.js";import{I as o}from"./Input.tFQgyGuP.js";import{A as d,ag as m,ai as u,aj as x,ah as p,ak as h,b as g,J as j,C as _,a4 as f,i as y}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function N(){const{isAdmin:N}=t(),v=i(),[w,b]=l.useState([]),[S,k]=l.useState([]),[L,D]=l.useState(null),[C,$]=l.useState(!0),[I,M]=l.useState(""),[F,O]=l.useState(""),[U,q]=l.useState("all"),[P,E]=l.useState(""),[Y,T]=l.useState("transaction_date"),[J,A]=l.useState("desc");l.useEffect((()=>{N?(B(),R()):v("/")}),[N,v]),l.useEffect((()=>{z()}),[w,F,U,P,Y,J]);const B=()=>e(null,null,(function*(){try{$(!0),M("");const{data:n,error:r}=yield s.from("reservations").select("\n          id,\n          user_id,\n          park_id,\n          total_amount,\n          status,\n          reservation_type,\n          created_at\n        ").not("total_amount","is",null).order("created_at",{ascending:!1});if(r)throw new Error("予約売上データの取得に失敗しました");let i=null,l=null;try{const{data:e,error:t}=yield s.from("stripe_subscriptions").select("\n            id,\n            customer_id,\n            status,\n            current_period_start,\n            current_period_end,\n            created_at\n          ").in("status",["active","trialing","past_due","canceled"]).not("deleted_at","is",null);i=e,l=t}catch(t){i=[],l=null}let c=null;try{const{data:e,error:t}=yield s.auth.admin.listUsers();t||(c=e)}catch(a){}const o=yield Promise.all((n||[]).map((t=>e(null,null,(function*(){var e;try{const{data:a}=yield s.from("profiles").select("name").eq("id",t.user_id).single(),{data:n}=yield s.from("dog_parks").select("name").eq("id",t.park_id).single(),r=t.total_amount||0,i=Math.round(.2*r),l=r-i,o=null==(e=null==c?void 0:c.users)?void 0:e.find((e=>e.id===t.user_id)),d=null==o?void 0:o.email;return{id:t.id,user_name:(null==a?void 0:a.name)||"Unknown",user_email:d||`user_${t.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:t.created_at,amount:r,commission:i,commission_rate:.2,net_amount:l,payment_method:"card",payment_status:"confirmed"===t.status?"paid":"pending",description:`${(null==n?void 0:n.name)||"Unknown Park"} - 予約料金`,is_subscription_user:"subscription"===t.reservation_type,created_at:t.created_at}}catch(a){return{id:t.id,user_name:"Unknown",user_email:`user_${t.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:t.created_at,amount:t.total_amount||0,commission:0,commission_rate:.2,net_amount:t.total_amount||0,payment_method:"card",payment_status:"pending",description:"予約料金",is_subscription_user:!1,created_at:t.created_at}}}))))),d=yield Promise.all((i||[]).map((t=>e(null,null,(function*(){var e;try{let a=null;if("user_id"in t)a=t.user_id;else{const{data:e}=yield s.from("stripe_customers").select("user_id").eq("customer_id",t.customer_id).not("deleted_at","is",null).single();a=null==e?void 0:e.user_id}if(!a)throw new Error("User ID not found for subscription");const{data:n}=yield s.from("profiles").select("name").eq("id",a).single(),r=2980,i=Math.round(.1*r),l=r-i,o=null==(e=null==c?void 0:c.users)?void 0:e.find((e=>e.id===a)),d=null==o?void 0:o.email;return{id:t.id,user_name:(null==n?void 0:n.name)||"Unknown",user_email:d||`user_${a.slice(0,8)}@unknown.com`,transaction_type:"subscription",transaction_date:t.created_at,amount:r,commission:i,commission_rate:.1,net_amount:l,payment_method:"card",payment_status:"active"===t.status?"paid":"pending",description:`月額サブスクリプション - ${t.status}`,is_subscription_user:!0,created_at:t.created_at}}catch(a){return{id:t.id,user_name:"Unknown",user_email:"unknown@unknown.com",transaction_type:"subscription",transaction_date:t.created_at,amount:2980,commission:298,commission_rate:.1,net_amount:2682,payment_method:"card",payment_status:"pending",description:"月額サブスクリプション",is_subscription_user:!0,created_at:t.created_at}}}))))),m=[...o,...d];m.sort(((e,t)=>new Date(t.transaction_date).getTime()-new Date(e.transaction_date).getTime())),b(m)}catch(n){M(`売上データの取得に失敗しました: ${n instanceof Error?n.message:"不明なエラー"}`)}finally{$(!1)}})),R=()=>e(null,null,(function*(){try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()-1,1),n=new Date(e.getFullYear(),e.getMonth(),0),{data:r}=yield s.from("reservations").select("total_amount").gte("created_at",t.toISOString()).not("total_amount","is",null),{data:i}=yield s.from("reservations").select("total_amount").gte("created_at",a.toISOString()).lt("created_at",n.toISOString()).not("total_amount","is",null),{count:l}=yield s.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",t.toISOString()),{count:c}=yield s.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",a.toISOString()).lt("created_at",n.toISOString()),o=(r||[]).reduce(((e,t)=>e+(t.total_amount||0)),0),d=((i||[]).reduce(((e,t)=>e+(t.total_amount||0)),0),2980*(l||0)),m=o+d,{count:u}=yield s.from("reservations").select("id",{count:"exact"}).gte("created_at",t.toISOString()),x=(u||0)+(l||0);x>0&&Math.round(m/x),Math.round(.2*o+.1*d);D({daily_revenue:[],top_products:[],top_parks:[],payment_methods:[{method:"card",count:x,total_amount:m}]})}catch(e){}})),z=()=>{let e=[...w];if(F&&(e=e.filter((e=>e.user_name.toLowerCase().includes(F.toLowerCase())||e.user_email.toLowerCase().includes(F.toLowerCase())||e.park_name&&e.park_name.toLowerCase().includes(F.toLowerCase())||e.product_name&&e.product_name.toLowerCase().includes(F.toLowerCase())))),"all"!==U&&(e=e.filter((e=>e.transaction_type===U))),P){const t=new Date(P);e=e.filter((e=>new Date(e.transaction_date).toDateString()===t.toDateString()))}e.sort(((e,t)=>{let s=e[Y],a=t[Y];return"transaction_date"===Y&&(s=new Date(s).getTime(),a=new Date(a).getTime()),"asc"===J?s>a?1:-1:s<a?1:-1})),k(e)},V=e=>({reservation:"ドッグラン予約",shop_order:"ショップ注文",subscription:"サブスクリプション"}[e]||e),G=e=>{const t={reservation:{color:"bg-blue-100 text-blue-800",icon:g},shop_order:{color:"bg-green-100 text-green-800",icon:j},subscription:{color:"bg-purple-100 text-purple-800",icon:_}},s=t[e]||t.reservation,n=s.icon;return a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(n,{className:"w-4 h-4"}),a.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.color}`,children:V(e)})]})};if(C)return a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})});const H=S.reduce(((e,t)=>e+t.amount),0),K=S.reduce(((e,t)=>e+(t.amount-t.net_amount)),0),Q=S.reduce(((e,t)=>e+t.net_amount),0),W=S.length>0?H/S.length:0,X=(new Date).getMonth(),Z=(new Date).getFullYear(),ee=w.filter((e=>{const t=new Date(e.transaction_date);return t.getMonth()===X&&t.getFullYear()===Z})),te=0===X?11:X-1,se=0===X?Z-1:Z,ae=w.filter((e=>{const t=new Date(e.transaction_date);return t.getMonth()===te&&t.getFullYear()===se})),ne=ee.reduce(((e,t)=>e+t.amount),0),re=ae.reduce(((e,t)=>e+t.amount),0),ie=(le=ne,0===(ce=re)?0:(le-ce)/ce*100);var le,ce;return a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"flex items-center space-x-4 mb-6",children:a.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[a.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[a.jsx(m,{className:"w-8 h-8 text-orange-600 mr-3"}),"売上管理"]}),a.jsx("p",{className:"text-gray-600",children:"売上の詳細分析と収益レポート"})]}),a.jsxs("div",{className:"text-sm text-gray-500",children:["総取引数: ",w.length,"件"]})]}),I&&a.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:I}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsx(n,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"今月の売上"}),a.jsxs("p",{className:"text-xl font-bold text-orange-600",children:["¥",ne.toLocaleString()]}),a.jsxs("div",{className:"flex items-center mt-1",children:[ie>=0?a.jsx(u,{className:"w-4 h-4 text-green-600 mr-1"}):a.jsx(x,{className:"w-4 h-4 text-red-600 mr-1"}),a.jsxs("span",{className:"text-xs "+(ie>=0?"text-green-600":"text-red-600"),children:[Math.abs(ie).toFixed(1),"% vs 前月"]})]})]}),a.jsx(m,{className:"w-6 h-6 text-orange-600"})]})}),a.jsx(n,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"平均取引額"}),a.jsxs("p",{className:"text-xl font-bold text-blue-600",children:["¥",Math.round(W).toLocaleString()]})]}),a.jsx(p,{className:"w-6 h-6 text-blue-600"})]})}),a.jsx(n,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"手数料収入"}),a.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",K.toLocaleString()]})]}),a.jsx(h,{className:"w-6 h-6 text-green-600"})]})}),a.jsx(n,{className:"p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-600",children:"純売上"}),a.jsxs("p",{className:"text-xl font-bold text-purple-600",children:["¥",Q.toLocaleString()]})]}),a.jsx(u,{className:"w-6 h-6 text-purple-600"})]})})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[a.jsxs(n,{className:"p-4",children:[a.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[a.jsx(g,{className:"w-5 h-5 text-blue-600 mr-2"}),"ドッグラン予約"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),a.jsxs("span",{className:"font-medium",children:[w.filter((e=>"reservation"===e.transaction_type)).length,"件"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),a.jsxs("span",{className:"font-medium text-blue-600",children:["¥",w.filter((e=>"reservation"===e.transaction_type)).reduce(((e,t)=>e+t.amount),0).toLocaleString()]})]})]})]}),a.jsxs(n,{className:"p-4",children:[a.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[a.jsx(j,{className:"w-5 h-5 text-green-600 mr-2"}),"ショップ注文"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),a.jsxs("span",{className:"font-medium",children:[w.filter((e=>"shop_order"===e.transaction_type)).length,"件"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),a.jsxs("span",{className:"font-medium text-green-600",children:["¥",w.filter((e=>"shop_order"===e.transaction_type)).reduce(((e,t)=>e+t.amount),0).toLocaleString()]})]})]})]}),a.jsxs(n,{className:"p-4",children:[a.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[a.jsx(_,{className:"w-5 h-5 text-purple-600 mr-2"}),"サブスクリプション"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),a.jsxs("span",{className:"font-medium",children:[w.filter((e=>"subscription"===e.transaction_type)).length,"件"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),a.jsxs("span",{className:"font-medium text-purple-600",children:["¥",w.filter((e=>"subscription"===e.transaction_type)).reduce(((e,t)=>e+t.amount),0).toLocaleString()]})]})]})]})]}),a.jsxs(n,{className:"p-6",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[a.jsx("div",{className:"md:col-span-2",children:a.jsx(o,{label:"検索",placeholder:"ユーザー名、メール、商品名、施設名で検索...",value:F,onChange:e=>O(e.target.value),icon:a.jsx(f,{className:"w-4 h-4 text-gray-500"})})}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引タイプ"}),a.jsxs("select",{value:U,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[a.jsx("option",{value:"all",children:"すべて"}),a.jsx("option",{value:"reservation",children:"ドッグラン予約"}),a.jsx("option",{value:"shop_order",children:"ショップ注文"}),a.jsx("option",{value:"subscription",children:"サブスクリプション"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引日"}),a.jsx("input",{type:"date",value:P,onChange:e=>E(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),a.jsxs("select",{value:`${Y}-${J}`,onChange:e=>{const[t,s]=e.target.value.split("-");T(t),A(s)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[a.jsx("option",{value:"transaction_date-desc",children:"取引日（新しい順）"}),a.jsx("option",{value:"transaction_date-asc",children:"取引日（古い順）"}),a.jsx("option",{value:"amount-desc",children:"金額（高い順）"}),a.jsx("option",{value:"amount-asc",children:"金額（低い順）"}),a.jsx("option",{value:"net_amount-desc",children:"純売上（高い順）"}),a.jsx("option",{value:"net_amount-asc",children:"純売上（低い順）"})]})]})]}),a.jsxs("div",{className:"flex justify-between items-center mt-4",children:[a.jsxs("p",{className:"text-sm text-gray-600",children:[S.length,"件の取引が見つかりました",S.length>0&&a.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",H.toLocaleString(),"）"]})]}),a.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{const e=[["取引ID","タイプ","ユーザー名","メール","商品/施設","金額","手数料","純売上","決済方法","取引日"],...S.map((e=>[e.id,V(e.transaction_type),e.user_name,e.user_email,e.park_name||e.product_name||"-",`¥${e.amount.toLocaleString()}`,`${(100*e.commission_rate).toFixed(1)}%`,`¥${e.net_amount.toLocaleString()}`,e.payment_method,new Date(e.transaction_date).toLocaleDateString("ja-JP")]))].map((e=>e.join(","))).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`sales_${(new Date).toISOString().split("T")[0]}.csv`,s.click()},children:[a.jsx(y,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),a.jsx(n,{children:a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"w-full",children:[a.jsx("thead",{className:"bg-gray-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引タイプ"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"商品/施設"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引日"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"金額"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料・純売上"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"決済方法"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.map((e=>a.jsxs("tr",{className:"hover:bg-gray-50",children:[a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.user_name}),e.is_subscription_user&&a.jsx(_,{className:"w-4 h-4 text-purple-600 ml-2"})]}),a.jsx("div",{className:"text-sm text-gray-500",children:e.user_email})]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:G(e.transaction_type)}),a.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[a.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.park_name||e.product_name||"-"}),e.quantity&&a.jsxs("div",{className:"text-sm text-gray-500",children:["数量: ",e.quantity]})]}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.transaction_date).toLocaleDateString("ja-JP")}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",e.amount.toLocaleString()]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:a.jsxs("div",{className:"space-y-1 text-sm",children:[a.jsxs("div",{className:"text-gray-500",children:["手数料: ",(100*e.commission_rate).toFixed(1),"%"]}),a.jsxs("div",{className:"font-medium text-green-600",children:["純売上: ¥",e.net_amount.toLocaleString()]})]})}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.payment_method})]},e.id)))})]})})})]})}export{N as AdminSalesManagement};
