var e=(e,s,t)=>new Promise((a,r)=>{var l=e=>{try{i(t.next(e))}catch(s){r(s)}},c=e=>{try{i(t.throw(e))}catch(s){r(s)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,c);i((t=t.apply(e,s)).next())});import{u as s,b as t,l as a,s as r,j as l,C as c,B as i,k as n}from"./index.CQlxbczY.js";import{r as d}from"./vendor.CKEClKZl.js";import{u as o,L as x}from"./router.B_7Atevv.js";import{S as m,Q as h,A as u,ap as p,p as j,o as g,aq as N,G as f,l as b}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";function y(){const{user:y}=s(),v=o(),[w,S]=d.useState([]),[_,q]=d.useState(!0),{isActive:k}=t(),[L,C]=d.useState(null);d.useEffect(()=>{y&&F();if("true"===new URLSearchParams(window.location.search).get("canceled")){C("決済がキャンセルされました。カートから商品を確認できます。"),window.history.replaceState({},document.title,window.location.pathname);const s=localStorage.getItem("pre_payment_auth_state");if(s)try{const e=JSON.parse(s);a("info","🛒 Cart: Pre-payment auth state found",{authState:e}),y&&y.id===e.user_id||(C("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{v("/login")},3e3)),localStorage.removeItem("pre_payment_auth_state")}catch(e){a("error")}}},[y,v]);const F=()=>e(this,null,function*(){try{const{data:e,error:s}=yield r.from("cart_items").select("*, product:products(*)").eq("user_id",null==y?void 0:y.id).order("created_at",{ascending:!1});if(s)throw s;S(e||[])}catch(e){C(e.message||"カート情報の取得に失敗しました")}finally{q(!1)}}),A=(s,t)=>e(this,null,function*(){if(t<=0)yield I(s);else try{const e=yield n(()=>r.from("cart_items").update({quantity:t}).eq("id",s));if(e.error)throw e.error;yield F()}catch(e){a("error"),C("数量の更新に失敗しました。再度お試しください。")}}),I=s=>e(this,null,function*(){try{const e=yield n(()=>r.from("cart_items").delete().eq("id",s));if(e.error)throw e.error;yield F()}catch(e){a("error"),C("商品の削除に失敗しました。再度お試しください。")}}),P=e=>k?Math.round(.9*e):e,z=()=>{const e=w.reduce((e,s)=>e+P(s.product.price)*s.quantity,0),s=w.reduce((e,s)=>e+s.product.price*s.quantity,0),t=e>=5e3||k?0:690;return{subtotal:e,originalSubtotal:s,discountAmount:s-e,shippingFee:t,total:e+t}};return _?l.jsx("div",{className:"flex justify-center items-center h-64",children:l.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):0===w.length?l.jsxs("div",{className:"max-w-4xl mx-auto",children:[l.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[l.jsx(m,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート"]}),l.jsxs(c,{className:"text-center py-12",children:[l.jsx(m,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),l.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"カートは空です"}),l.jsx("p",{className:"text-gray-500 mb-6",children:"お気に入りの商品をカートに追加してください"}),l.jsx(x,{to:"/shop",children:l.jsx(i,{className:"bg-green-600 hover:bg-green-700",children:"ショッピングを続ける"})})]})]}):l.jsxs("div",{className:"max-w-6xl mx-auto",children:[l.jsxs("div",{className:"flex justify-between items-center mb-8",children:[l.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[l.jsx(m,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート (",w.length,"点)"]}),l.jsxs(i,{variant:"secondary",onClick:()=>e(this,null,function*(){try{const e=yield n(()=>r.from("cart_items").delete().eq("user_id",null==y?void 0:y.id));if(e.error)throw e.error;yield F()}catch(e){a("error","Error clearing cart",{userId:null==y?void 0:y.id}),C("カートの削除に失敗しました。再度お試しください。")}}),className:"text-red-600 hover:text-red-700",children:[l.jsx(h,{className:"w-4 h-4 mr-2"}),"カートを空にする"]})]}),L&&l.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[l.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),l.jsx("p",{className:"text-red-800",children:L})]}),l.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[l.jsx("div",{className:"lg:col-span-2 space-y-4",children:w.map(e=>{const s=e.product.price,t=P(s),a=k&&t<s;return l.jsx(c,{className:"p-4",children:l.jsxs("div",{className:"flex items-start space-x-4",children:[l.jsx("div",{className:"flex-shrink-0",children:l.jsx("img",{src:e.product.image_url,alt:e.product.name,className:"w-20 h-20 object-cover rounded-lg",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),l.jsxs("div",{className:"flex-1",children:[l.jsxs("div",{className:"flex justify-between items-start",children:[l.jsxs("div",{children:[l.jsx("h3",{className:"font-semibold text-lg",children:e.product.name}),e.product.brand&&l.jsx("p",{className:"text-sm text-gray-500",children:e.product.brand}),l.jsxs("div",{className:"mt-1 space-y-1 text-xs text-gray-500",children:[e.product.weight&&l.jsxs("p",{children:["内容量: ",e.product.weight,"g"]}),e.product.size&&l.jsxs("p",{children:["サイズ: ",e.product.size]})]})]}),l.jsx("button",{onClick:()=>I(e.id),className:"text-red-500 hover:text-red-700 p-1",children:l.jsx(h,{className:"w-4 h-4"})})]}),l.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[l.jsxs("div",{children:[l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",t.toLocaleString()]}),a&&l.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",s.toLocaleString()]})]}),k&&l.jsx("p",{className:"text-xs text-purple-600",children:"サブスク会員価格"})]}),l.jsxs("div",{className:"flex items-center space-x-3",children:[l.jsx("button",{onClick:()=>A(e.id,e.quantity-1),className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:l.jsx(p,{className:"w-4 h-4"})}),l.jsx("span",{className:"font-medium w-8 text-center",children:e.quantity}),l.jsx("button",{onClick:()=>A(e.id,e.quantity+1),className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:l.jsx(j,{className:"w-4 h-4"})})]})]}),l.jsx("div",{className:"mt-2 text-right",children:l.jsxs("span",{className:"text-lg font-semibold",children:["小計: ¥",(t*e.quantity).toLocaleString()]})})]})]})},e.id)})}),l.jsxs("div",{className:"space-y-6",children:[k?l.jsxs(c,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[l.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[l.jsx(g,{className:"w-5 h-5"}),l.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),l.jsx("p",{className:"text-sm",children:"全商品10%OFF + 送料無料"})]}):l.jsxs(c,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[l.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[l.jsx(g,{className:"w-5 h-5"}),l.jsx("span",{className:"font-semibold",children:"サブスクリプションでもっとお得に！"})]}),l.jsx("p",{className:"text-sm mb-3",children:"全商品10%OFF + 送料無料"}),l.jsx(x,{to:"/subscription",children:l.jsx(i,{size:"sm",className:"bg-white text-purple-600 hover:bg-gray-100",children:"詳細を見る"})})]}),l.jsxs(c,{className:"p-6",children:[l.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文サマリー"}),l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"flex justify-between",children:[l.jsx("span",{children:"商品小計"}),l.jsxs("span",{children:["¥",z().originalSubtotal.toLocaleString()]})]}),z().discountAmount>0&&l.jsxs("div",{className:"flex justify-between text-purple-600",children:[l.jsx("span",{children:"サブスク割引 (10%)"}),l.jsxs("span",{children:["-¥",z().discountAmount.toLocaleString()]})]}),l.jsxs("div",{className:"flex justify-between",children:[l.jsxs("span",{className:"flex items-center",children:[l.jsx(N,{className:"w-4 h-4 mr-1"}),"送料"]}),l.jsx("span",{children:0===z().shippingFee?l.jsx("span",{className:"text-green-600",children:"無料"}):`¥${z().shippingFee.toLocaleString()}`})]}),l.jsx("hr",{className:"my-3"}),l.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[l.jsx("span",{children:"合計"}),l.jsxs("span",{className:"text-green-600",children:["¥",z().total.toLocaleString()]})]})]}),!k&&z().subtotal<5e3&&l.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:l.jsxs("p",{className:"text-sm text-blue-800",children:["あと¥",(5e3-z().subtotal).toLocaleString(),"で送料無料！"]})}),l.jsxs("div",{className:"space-y-3 mt-4",children:[l.jsxs(i,{onClick:()=>{0!==w.length?v("/checkout",{state:{cartItems:w.map(e=>e.id),totals:z()}}):C("カートに商品がありません。")},className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",children:[l.jsx(f,{className:"w-5 h-5 mr-2"}),"レジに進む",l.jsx(b,{className:"w-5 h-5 ml-2"})]}),l.jsx(x,{to:"/shop",children:l.jsx(i,{variant:"secondary",className:"w-full",children:"ショッピングを続ける"})})]})]}),l.jsx(c,{className:"p-4 bg-blue-50 border-blue-200",children:l.jsxs("div",{className:"flex items-start space-x-3",children:[l.jsx(N,{className:"w-6 h-6 text-blue-600 mt-1"}),l.jsxs("div",{children:[l.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),l.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[l.jsx("p",{children:"• 送料：全国一律¥690"}),l.jsxs("p",{children:["• ¥5,000以上のご注文で",l.jsx("span",{className:"font-medium",children:"送料無料"})]}),l.jsxs("p",{children:["• サブスク会員は",l.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),l.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),l.jsx("p",{children:"• 土日祝日も配送いたします"}),l.jsx("p",{children:"• 時間指定配送も可能です"})]})]})]})})]})]})]})}export{y as Cart};
