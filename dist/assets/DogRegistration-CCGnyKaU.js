import{j as e,V as r,X as a,a1 as t}from"./ui-vendor-B03FHkej.js";import{r as s,L as i}from"./react-vendor-BBLDtDmh.js";import{I as l}from"./Input-D52zIDZ_.js";import{S as o}from"./Select-CyS8FvOq.js";import{u as n,B as d,C as c,s as u,n as m}from"./index-CWMjoAp3.js";import{d as g}from"./dogBreeds-6lxY8Uni.js";import{h as b}from"./vaccineUploadFixed-CvobuGmF.js";import{l as h}from"./logger-hQPzKOcf.js";import"./query-vendor-Cy2yKKks.js";import"./supabase-vendor-BcfcqyaE.js";const p=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}};function x(){const{user:x}=n(),[f,y]=s.useState(!1),[j,v]=s.useState(""),[w,N]=s.useState(null),[D,I]=s.useState(null),[S,C]=s.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),E=(new Date).getFullYear(),V=Array.from({length:21},(e,r)=>{const a=E-r;return{value:a.toString(),label:`${a}年`}}),M=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}}),Y=()=>{if(!S.birthYear||!S.birthMonth||!S.birthDay)return!1;const e=parseInt(S.birthYear),r=parseInt(S.birthMonth),a=parseInt(S.birthDay),t=new Date(e,r-1,a);if(t>new Date)return!1;const s=new Date;return s.setFullYear(s.getFullYear()-20),!(t<s)},q=g.map(e=>({value:e,label:e}));return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[e.jsxs("div",{children:[e.jsxs(i,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[e.jsx(r,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"新しいワンちゃんを登録して、ドッグランを利用しましょう"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-900",children:"既に登録済みのワンちゃんがいますか？"}),e.jsx("p",{className:"text-sm text-blue-700",children:"登録済みのワンちゃんの情報を確認・編集できます"})]}),e.jsx(i,{to:"/dog-management",children:e.jsx(d,{variant:"secondary",size:"sm",children:"ワンちゃん管理"})})]})}),e.jsx(c,{children:e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),y(!0),v("");try{if(h.info("=== DOG REGISTRATION START ==="),h.info("Starting dog registration for user:",x?.id),!Y())return v("正しい生年月日を選択してください。"),void y(!1);if(!S.rabiesExpiryDate||!S.comboExpiryDate)return v("ワクチンの有効期限を入力してください。"),void y(!1);const e=new Date,a=new Date(S.rabiesExpiryDate),t=new Date(S.comboExpiryDate);if(a<=e||t<=e)return v("ワクチンの有効期限は今日より後の日付を入力してください。"),void y(!1);const s=`${S.birthYear}-${S.birthMonth}-${S.birthDay}`;let i;if("オス"===S.gender||"male"===S.gender||"male"===S.gender.toLowerCase())i="オス";else{if("メス"!==S.gender&&"female"!==S.gender&&"female"!==S.gender.toLowerCase())return v("性別を正しく選択してください。"),void y(!1);i="メス"}h.info("Original gender:",S.gender,"Normalized gender:",i);const{data:l,error:o}=await u.from("profiles").select("id, name, user_type").eq("id",x?.id).maybeSingle();if(h.info("Profile check result:",l,o),o&&"PGRST116"!==o.code)throw h.error("Profile error:",o),o;if(l)h.info("Profile exists:",l);else{h.info("Creating profile for dog registration using upsert");const e=x?.user_metadata?.name||x?.email?.split("@")[0]||"ユーザー",{data:r,error:a}=await u.from("profiles").upsert([{id:x?.id,user_type:"user",name:e,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(a)throw h.error("Profile upsert error:",a),a;h.info("Profile upserted successfully:",r)}h.info("Registering dog with data:",{name:S.name,breed:S.breed,birth_date:s,gender:i,owner_id:x?.id});const{data:n,error:d}=await u.from("dogs").insert([{name:S.name,breed:S.breed,birth_date:s,gender:i,owner_id:x?.id}]).select().single();if(d)throw h.error("🚨 Dog registration error:",d),h.error("🚨 Error details:",{message:d.message,code:d.code,details:d.details,hint:d.hint}),d;h.info("✅ Dog registered successfully:",n),h.info("✅ Dog ID generated:",n.id);let c=null;if(w){h.info("Uploading dog image...");try{const e=w.name.split(".").pop()||"jpg",r=Date.now(),a=`${n.id}/profile_${r}.${e}`;h.info("Uploading to path:",a),h.info("🔧 Uploading dog image with Content-Type:",w.type);const{error:t}=await u.storage.from("dog-images").upload(a,w,{cacheControl:"3600",upsert:!0,contentType:w.type});if(t)throw h.error("Image upload error:",t),new Error(`画像のアップロードに失敗しました: ${t.message}`);h.info("Upload successful");const{data:{publicUrl:s}}=u.storage.from("dog-images").getPublicUrl(a);c=s,h.info("Public URL generated:",c);const{error:i}=await u.from("dogs").update({image_url:c}).eq("id",n.id);if(i)throw h.error("Error updating dog image URL:",i),new Error("画像URLの更新に失敗しました");h.info("Dog image URL updated successfully")}catch(r){h.error("Image processing error:",r),v("画像のアップロードに失敗しましたが、ワンちゃんの登録は完了しました。後でマイページから画像を追加できます。")}}if(S.rabiesVaccineImage&&S.comboVaccineImage){h.info("🧪 Starting vaccine certificates upload using utility...");const e=await b(n.id,S.rabiesVaccineImage,S.comboVaccineImage,S.rabiesExpiryDate,S.comboExpiryDate);e.success?h.info("✅ Vaccine certificates uploaded successfully"):(h.error("Vaccine upload failed:",e.error),v(`ワクチン証明書のアップロードに失敗しました: ${e.error}`))}h.info("Dog registration completed successfully"),m.success("ワンちゃんの登録が完了しました！"),C({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),N(null),I(null)}catch(a){h.error("Registration error:",a),v("ワンちゃんの登録に失敗しました。もう一度お試しください。")}finally{y(!1)}},children:[j&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:j}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ワンちゃんの写真（任意）"}),D?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:D,alt:"ワンちゃんのプレビュー",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{N(null),I(null)},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(a,{className:"w-4 h-4"})}),w&&e.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:w.name})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){if(h.info("Selected file:",r.name,r.size,r.type),r.size>10485760)return void v("画像ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void v("画像ファイルを選択してください。");N(r);const e=new FileReader;e.onload=e=>{I(e.target?.result),h.info("Image preview created")},e.readAsDataURL(r),v("")}},className:"hidden",id:"dog-image"}),e.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[e.jsx(t,{className:"w-12 h-12 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (最大10MB)"})]})]})]}),e.jsx(l,{label:"名前",value:S.name,onChange:e=>C({...S,name:e.target.value}),required:!0}),e.jsx(o,{label:"犬種",options:q,value:S.breed,onChange:e=>C({...S,breed:e.target.value}),required:!0}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"生年月日 *"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx("div",{children:e.jsxs("select",{value:S.birthYear,onChange:e=>{C({...S,birthYear:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"年"}),V.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:S.birthMonth,onChange:e=>{C({...S,birthMonth:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"月"}),M.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:S.birthDay,onChange:e=>C({...S,birthDay:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!S.birthYear||!S.birthMonth,children:[e.jsx("option",{value:"",children:"日"}),(()=>{if(!S.birthYear||!S.birthMonth)return Array.from({length:31},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}});const e=parseInt(S.birthYear),r=parseInt(S.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}})})().map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})})]}),S.birthYear&&S.birthMonth&&!S.birthDay&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"日を選択してください"}),S.birthYear&&S.birthMonth&&S.birthDay&&!Y()&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:"正しい生年月日を選択してください（未来の日付や20年以上前の日付は選択できません）"})]}),e.jsx(o,{label:"性別",options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],value:S.gender,onChange:e=>C({...S,gender:e.target.value}),required:!0}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ワクチン証明書"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン接種証明書 *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){const e=p(r);if(!e.isValid)return void v(e.error||"ファイルの検証に失敗しました");v("")}C({...S,rabiesVaccineImage:r||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン有効期限 *"}),e.jsx("input",{type:"date",value:S.rabiesExpiryDate,onChange:e=>C({...S,rabiesExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン接種証明書 *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){const e=p(r);if(!e.isValid)return void v(e.error||"ファイルの検証に失敗しました");v("")}C({...S,comboVaccineImage:r||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン有効期限 *"}),e.jsx("input",{type:"date",value:S.comboExpiryDate,onChange:e=>C({...S,comboExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800",children:"※ ワクチン接種証明書は運営による確認後に承認されます。承認されるまでドッグランの利用はできません。"})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"ワクチン証明書について:"}),e.jsx("br",{}),"• 管理者が確認しやすい形で保存されます",e.jsx("br",{}),"• 承認されると正式にワクチン情報として登録されます",e.jsx("br",{}),"• 承認後、全国のドッグランをご利用いただけます"]})})]}),e.jsx(d,{type:"submit",isLoading:f,className:"w-full",children:"ワンちゃんを登録する"})]})})]})}export{x as DogRegistration};
