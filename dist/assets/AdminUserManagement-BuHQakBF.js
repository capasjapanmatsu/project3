import{u as e,s,j as t,C as a,B as r}from"./index-uQwv9uAE.js";import{u as i,r as n,L as c}from"./vendor-BHVjIt_u.js";import{I as l}from"./Input-Bg5E4HX5.js";import{I as d,U as x,ak as o,j as m,l as p,ax as h,ap as u,M as j,q as g,ay as f,o as v}from"./ui-BLTQwnYp.js";import"./supabase-CKbzEL5D.js";function N(){const{isAdmin:N}=e(),y=i(),[w,_]=n.useState([]),[b,S]=n.useState([]),[k,D]=n.useState(!0),[L,C]=n.useState(""),[$,q]=n.useState(""),[I,E]=n.useState("all"),[P,U]=n.useState("created_at"),[J,M]=n.useState("desc");n.useEffect((()=>{N?O():y("/")}),[N,y]),n.useEffect((()=>{T()}),[w,$,I,P,J]);const O=async()=>{try{D(!0),C("");const{data:e,error:t}=await s.from("profiles").select("\n          id,\n          name,\n          user_type,\n          postal_code,\n          address,\n          phone_number,\n          created_at\n        ");if(t)throw new Error("プロファイル情報の取得に失敗しました");if(!e||0===e.length)return void _([]);const a=e.map((async e=>{try{const{count:t}=await s.from("dogs").select("id",{count:"exact"}).eq("owner_id",e.id),a=new Date;a.setDate(1),a.setHours(0,0,0,0);const{count:r}=await s.from("reservations").select("id",{count:"exact"}).eq("user_id",e.id).gte("created_at",a.toISOString()),{data:i}=await s.from("stripe_subscriptions").select("status").eq("user_id",e.id).eq("status","active").maybeSingle(),{data:n}=await s.from("reservations").select("total_amount").eq("user_id",e.id).not("total_amount","is",null),c=(n||[]).reduce(((e,s)=>e+(s.total_amount||0)),0),l=`user_${e.id.slice(0,8)}@unknown.com`;return{id:e.id,name:e.name||"Unknown",email:l,phone:e.phone_number||"",created_at:e.created_at,last_sign_in_at:"",is_active:!0,subscription_status:i?.status||"inactive",dog_count:t||0,reservation_count:r||0,total_spent:c}}catch(t){const s=`user_${e.id.slice(0,8)}@unknown.com`;return{id:e.id,name:e.name||"Unknown",email:s,phone:e.phone_number||"",created_at:e.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:0,reservation_count:0,total_spent:0}}})),r=await Promise.all(a);_(r)}catch(e){C(`ユーザーデータの取得に失敗しました: ${e instanceof Error?e.message:"不明なエラー"}`)}finally{D(!1)}},T=()=>{let e=[...w];switch($&&(e=e.filter((e=>e.name.toLowerCase().includes($.toLowerCase())||e.email.toLowerCase().includes($.toLowerCase())))),I){case"active":e=e.filter((e=>e.is_active));break;case"inactive":e=e.filter((e=>!e.is_active));break;case"subscribers":e=e.filter((e=>"active"===e.subscription_status))}e.sort(((e,s)=>{let t=e[P],a=s[P];return"created_at"!==P&&"last_sign_in_at"!==P||(t=new Date(t||0).getTime(),a=new Date(a||0).getTime()),"asc"===J?t>a?1:-1:t<a?1:-1})),S(e)},z=e=>"active"===e.subscription_status?t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(m,{className:"w-4 h-4 text-purple-600"}),t.jsx("span",{className:"px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full",children:"サブスク会員"})]}):e.is_active?t.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full",children:"アクティブ"}):t.jsx("span",{className:"px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full",children:"非アクティブ"});return k?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"flex items-center space-x-4 mb-6",children:t.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[t.jsx(x,{className:"w-8 h-8 text-blue-600 mr-3"}),"ユーザー管理"]}),t.jsx("p",{className:"text-gray-600",children:"登録ユーザーの詳細情報と管理"})]}),t.jsxs("div",{className:"text-sm text-gray-500",children:["総ユーザー数: ",w.length,"人"]})]}),L&&t.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:L}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"総ユーザー数"}),t.jsx("p",{className:"text-xl font-bold text-blue-600",children:w.length})]}),t.jsx(x,{className:"w-6 h-6 text-blue-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"アクティブユーザー"}),t.jsx("p",{className:"text-xl font-bold text-green-600",children:w.filter((e=>e.is_active)).length})]}),t.jsx(o,{className:"w-6 h-6 text-green-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"サブスク会員"}),t.jsx("p",{className:"text-xl font-bold text-purple-600",children:w.filter((e=>"active"===e.subscription_status)).length})]}),t.jsx(m,{className:"w-6 h-6 text-purple-600"})]})}),t.jsx(a,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-600",children:"今月新規登録"}),t.jsx("p",{className:"text-xl font-bold text-orange-600",children:w.filter((e=>{const s=new Date(e.created_at),t=new Date;return s.getMonth()===t.getMonth()&&s.getFullYear()===t.getFullYear()})).length})]}),t.jsx(p,{className:"w-6 h-6 text-orange-600"})]})})]}),t.jsxs(a,{className:"p-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[t.jsx("div",{className:"md:col-span-2",children:t.jsx(l,{label:"検索",placeholder:"名前またはメールアドレスで検索...",value:$,onChange:e=>q(e.target.value),icon:t.jsx(h,{className:"w-4 h-4 text-gray-500"})})}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),t.jsxs("select",{value:I,onChange:e=>E(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"all",children:"すべて"}),t.jsx("option",{value:"active",children:"アクティブ"}),t.jsx("option",{value:"inactive",children:"非アクティブ"}),t.jsx("option",{value:"subscribers",children:"サブスク会員"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),t.jsxs("select",{value:`${P}-${J}`,onChange:e=>{const[s,t]=e.target.value.split("-");U(s),M(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),t.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),t.jsx("option",{value:"name-asc",children:"名前（昇順）"}),t.jsx("option",{value:"name-desc",children:"名前（降順）"}),t.jsx("option",{value:"total_spent-desc",children:"支払額（高い順）"}),t.jsx("option",{value:"total_spent-asc",children:"支払額（低い順）"})]})]})]}),t.jsxs("div",{className:"flex justify-between items-center mt-4",children:[t.jsxs("p",{className:"text-sm text-gray-600",children:[b.length,"件のユーザーが見つかりました"]}),t.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{const e=[["名前","メールアドレス","電話番号","登録日","最終ログイン","ステータス","犬の数","予約数","総支払額"],...b.map((e=>[e.name,e.email,e.phone||"",new Date(e.created_at).toLocaleDateString("ja-JP"),e.last_sign_in_at?new Date(e.last_sign_in_at).toLocaleDateString("ja-JP"):"未ログイン",e.is_active?"アクティブ":"非アクティブ",e.dog_count,e.reservation_count,`¥${e.total_spent.toLocaleString()}`]))].map((e=>e.join(","))).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`users_${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[t.jsx(u,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),t.jsx(a,{children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"連絡先"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"最終ログイン"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"統計"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map((e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),t.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",e.id.slice(0,8),"..."]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"flex items-center text-sm text-gray-900",children:[t.jsx(j,{className:"w-4 h-4 mr-2 text-gray-400"}),e.email]}),e.phone&&t.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[t.jsx(g,{className:"w-4 h-4 mr-2 text-gray-400"}),e.phone]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.last_sign_in_at?new Date(e.last_sign_in_at).toLocaleDateString("ja-JP"):"未ログイン"}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:z(e)}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsxs("div",{className:"space-y-1 text-sm",children:[t.jsxs("div",{className:"flex items-center text-gray-900",children:[t.jsx(f,{className:"w-4 h-4 mr-1 text-gray-400"}),"犬: ",e.dog_count,"匹"]}),t.jsxs("div",{className:"text-gray-500",children:["予約: ",e.reservation_count,"件"]}),t.jsxs("div",{className:"text-gray-500",children:["支払: ¥",e.total_spent.toLocaleString()]})]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:t.jsx("div",{className:"flex items-center space-x-2",children:t.jsx(r,{size:"sm",variant:"secondary",onClick:()=>y(`/admin/users/${e.id}`),children:t.jsx(v,{className:"w-4 h-4"})})})})]},e.id)))})]})})})]})}export{N as AdminUserManagement};
