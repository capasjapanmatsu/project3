var e=(e,s,a)=>new Promise(((t,r)=>{var i=e=>{try{l(a.next(e))}catch(s){r(s)}},n=e=>{try{l(a.throw(e))}catch(s){r(s)}},l=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,n);l((a=a.apply(e,s)).next())}));import{s,l as a,j as t,C as r,B as i}from"./index.oOj2R_C7.js";import{e as n,r as l,L as c}from"./router.icJHpBzt.js";import{Y as d,A as x,h as m,az as o,n as h,ak as j,c as g,C as p,t as N,X as u}from"./ui.UnEvinBv.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function f(){const[f]=n(),[v,b]=l.useState({pendingVaccines:0,pendingParks:0,unreadMessages:0,pendingUsers:0}),[y,w]=l.useState([]),[_,k]=l.useState([]),[S,P]=l.useState(!0),[C,D]=l.useState(""),[$,z]=l.useState(""),[M,V]=l.useState("overview"),[E,L]=l.useState(!1);l.useEffect((()=>{const e=f.get("tab");e&&["overview","vaccines","parks","messages"].includes(e)&&V(e),q()}),[f]);const q=()=>e(null,null,(function*(){try{P(!0);const{data:e,error:a}=yield s.from("vaccine_certifications").select("\n          *,\n          dog:dogs(\n            *,\n            owner:profiles(*)\n          )\n        ").eq("status","pending").order("created_at",{ascending:!0});if(a)throw a;const{data:t,error:r}=yield s.from("dog_parks").select("*").in("status",["pending","second_stage_review"]).order("created_at",{ascending:!0});if(r)throw r;w(e||[]),k(t||[]),b({pendingVaccines:(null==e?void 0:e.length)||0,pendingParks:(null==t?void 0:t.length)||0,unreadMessages:0,pendingUsers:0})}catch(e){a("error","Error fetching task data",{error:e}),D("タスクデータの取得に失敗しました")}finally{P(!1)}})),J=(t,r)=>e(null,null,(function*(){L(!0),D(""),z("");try{const e=y.find((e=>e.id===t));if(!e)throw new Error("ワクチン証明書が見つかりません");const{error:a}=yield s.from("vaccine_certifications").update({status:r?"approved":"rejected",reviewed_at:(new Date).toISOString()}).eq("id",t);if(a)throw a;const{error:i}=yield s.from("notifications").insert([{user_id:e.dog.owner.id,type:"vaccine_review",title:r?"ワクチン証明書が承認されました":"ワクチン証明書について",message:r?`${e.dog.name}のワクチン証明書が承認されました。ドッグランのご利用が可能になりました。`:`${e.dog.name}のワクチン証明書の確認が必要です。マイページから再度アップロードしてください。`,data:{vaccine_id:t,dog_id:e.dog_id}}]);if(i)throw i;z(`ワクチン証明書を${r?"承認":"却下"}しました`),yield q()}catch(e){a("error","Error processing vaccine",{error:e}),D("ワクチン証明書の処理に失敗しました")}finally{L(!1)}})),U=(t,r)=>e(null,null,(function*(){L(!0),D(""),z("");try{const e=_.find((e=>e.id===t));if(!e)throw new Error("ドッグランが見つかりません");let a="";a=r?"pending"===e.status?"first_stage_passed":"qr_testing":"rejected";const{error:i}=yield s.from("dog_parks").update({status:a,reviewed_at:(new Date).toISOString()}).eq("id",t);if(i)throw i;const{error:n}=yield s.from("notifications").insert([{user_id:e.owner_id,type:"park_review",title:r?"審査結果のお知らせ":"審査結果について",message:r?`${e.name}の審査が通過しました。${"pending"===e.status?"詳細情報の入力にお進みください。":"QRコード実証検査の準備に入ります。"}`:`${e.name}の審査が不通過となりました。詳細はダッシュボードをご確認ください。`,data:{park_id:t}}]);if(n)throw n;z(`ドッグランを${r?"承認":"却下"}しました`),yield q()}catch(e){a("error","Error processing park",{error:e}),D("ドッグランの処理に失敗しました")}finally{L(!1)}})),I=()=>v.pendingVaccines+v.pendingParks+v.unreadMessages+v.pendingUsers;return S?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):t.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[t.jsx("div",{className:"flex items-center space-x-4 mb-6",children:t.jsxs(c,{to:"/admin",className:"flex items-center text-blue-600 hover:text-blue-800",children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[t.jsx(x,{className:"w-8 h-8 text-red-600 mr-3"}),"緊急対応タスク"]}),t.jsx("p",{className:"text-gray-600",children:"承認待ちの項目を確認・処理してください"})]}),t.jsxs("div",{className:"text-sm text-gray-500",children:["合計タスク数: ",I(),"件"]})]}),C&&t.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[t.jsx(x,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),t.jsx("p",{children:C})]}),$&&t.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 flex items-start",children:[t.jsx(m,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),t.jsx("p",{children:$})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[t.jsx(r,{className:"p-6 cursor-pointer transition-all "+("vaccines"===M?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>V("vaccines"),children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"ワクチン証明書"}),t.jsx("p",{className:"text-2xl font-bold text-red-600",children:v.pendingVaccines}),t.jsx("p",{className:"text-xs text-gray-500",children:"承認待ち"})]}),t.jsx(o,{className:"w-8 h-8 text-red-600"})]})}),t.jsx(r,{className:"p-6 cursor-pointer transition-all "+("parks"===M?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>V("parks"),children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"ドッグラン審査"}),t.jsx("p",{className:"text-2xl font-bold text-orange-600",children:v.pendingParks}),t.jsx("p",{className:"text-xs text-gray-500",children:"審査待ち"})]}),t.jsx(h,{className:"w-8 h-8 text-orange-600"})]})}),t.jsx(r,{className:"p-6 cursor-pointer transition-all "+("messages"===M?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>V("messages"),children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"お問い合わせ"}),t.jsx("p",{className:"text-2xl font-bold text-purple-600",children:v.unreadMessages}),t.jsx("p",{className:"text-xs text-gray-500",children:"未読"})]}),t.jsx(j,{className:"w-8 h-8 text-purple-600"})]})}),t.jsx(r,{className:"p-6 cursor-pointer transition-all "+("overview"===M?"ring-2 ring-blue-500 bg-blue-50":"hover:shadow-lg"),onClick:()=>V("overview"),children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:"全体概要"}),t.jsx("p",{className:"text-2xl font-bold text-blue-600",children:I()}),t.jsx("p",{className:"text-xs text-gray-500",children:"総タスク数"})]}),t.jsx(g,{className:"w-8 h-8 text-blue-600"})]})})]}),"overview"===M&&t.jsx("div",{className:"space-y-6",children:t.jsxs(r,{className:"p-6",children:[t.jsx("h2",{className:"text-lg font-semibold mb-4",children:"タスク概要"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium mb-3",children:"優先度の高いタスク"}),t.jsxs("div",{className:"space-y-2",children:[v.pendingVaccines>0&&t.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(o,{className:"w-4 h-4 text-red-600"}),t.jsx("span",{className:"text-sm",children:"ワクチン証明書承認"})]}),t.jsxs("span",{className:"text-sm font-medium text-red-600",children:[v.pendingVaccines,"件"]})]}),v.pendingParks>0&&t.jsxs("div",{className:"flex items-center justify-between p-3 bg-orange-50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(h,{className:"w-4 h-4 text-orange-600"}),t.jsx("span",{className:"text-sm",children:"ドッグラン審査"})]}),t.jsxs("span",{className:"text-sm font-medium text-orange-600",children:[v.pendingParks,"件"]})]}),v.unreadMessages>0&&t.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(j,{className:"w-4 h-4 text-purple-600"}),t.jsx("span",{className:"text-sm",children:"お問い合わせ対応"})]}),t.jsxs("span",{className:"text-sm font-medium text-purple-600",children:[v.unreadMessages,"件"]})]}),0===I()&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"すべてのタスクが完了しています"})]})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium mb-3",children:"処理時間の目安"}),t.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(p,{className:"w-4 h-4"}),t.jsx("span",{children:"ワクチン証明書: 2-3分/件"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(p,{className:"w-4 h-4"}),t.jsx("span",{children:"ドッグラン審査: 5-10分/件"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(p,{className:"w-4 h-4"}),t.jsx("span",{children:"お問い合わせ: 3-5分/件"})]})]})]})]})]})}),"vaccines"===M&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"ワクチン証明書承認待ち"}),t.jsxs("div",{className:"text-sm text-gray-500",children:[v.pendingVaccines,"件の承認待ち"]})]}),0===y.length?t.jsxs(r,{className:"text-center py-12",children:[t.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"承認待ちのワクチン証明書はありません"})]}):t.jsx("div",{className:"space-y-4",children:y.map((e=>t.jsx(r,{className:"p-6",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[t.jsx("h3",{className:"font-semibold",children:e.dog.name}),t.jsxs("span",{className:"text-sm text-gray-500",children:["飼い主: ",e.dog.owner.name]}),t.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full",children:"承認待ち"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[t.jsxs("div",{children:[t.jsxs("p",{className:"text-gray-600",children:["犬種: ",e.dog.breed]}),t.jsxs("p",{className:"text-gray-600",children:["性別: ",e.dog.gender]}),t.jsxs("p",{className:"text-gray-600",children:["申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]})]}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-gray-600",children:["狂犬病ワクチン期限: ",e.rabies_expiry_date?new Date(e.rabies_expiry_date).toLocaleDateString("ja-JP"):"未設定"]}),t.jsxs("p",{className:"text-gray-600",children:["混合ワクチン期限: ",e.combo_expiry_date?new Date(e.combo_expiry_date).toLocaleDateString("ja-JP"):"未設定"]})]})]})]}),t.jsxs("div",{className:"flex space-x-2 ml-4",children:[t.jsx(c,{to:`/admin/management?tab=vaccines&vaccine=${e.id}`,children:t.jsxs(i,{size:"sm",variant:"secondary",children:[t.jsx(N,{className:"w-4 h-4 mr-1"}),"詳細"]})}),t.jsxs(i,{size:"sm",onClick:()=>J(e.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:E,children:[t.jsx(m,{className:"w-4 h-4 mr-1"}),"承認"]}),t.jsxs(i,{size:"sm",onClick:()=>J(e.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:E,children:[t.jsx(u,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]}),"parks"===M&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"ドッグラン審査待ち"}),t.jsxs("div",{className:"text-sm text-gray-500",children:[v.pendingParks,"件の審査待ち"]})]}),0===_.length?t.jsxs(r,{className:"text-center py-12",children:[t.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"審査待ちのドッグランはありません"})]}):t.jsx("div",{className:"space-y-4",children:_.map((e=>t.jsx(r,{className:"p-6",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[t.jsx("h3",{className:"font-semibold",children:e.name}),t.jsx("span",{className:"text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full",children:"pending"===e.status?"第一審査待ち":"第二審査待ち"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[t.jsxs("div",{children:[t.jsxs("p",{className:"text-gray-600",children:["住所: ",e.address]}),t.jsxs("p",{className:"text-gray-600",children:["料金: ¥",e.price,"/時間"]})]}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-gray-600",children:["申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]}),t.jsxs("p",{className:"text-gray-600",children:["審査段階: ","pending"===e.status?"第一審査":"第二審査"]})]})]})]}),t.jsxs("div",{className:"flex space-x-2 ml-4",children:[t.jsx(c,{to:`/admin/management?tab=parks&park=${e.id}`,children:t.jsxs(i,{size:"sm",variant:"secondary",children:[t.jsx(N,{className:"w-4 h-4 mr-1"}),"詳細"]})}),t.jsxs(i,{size:"sm",onClick:()=>U(e.id,!0),className:"bg-green-600 hover:bg-green-700",disabled:E,children:[t.jsx(m,{className:"w-4 h-4 mr-1"}),"承認"]}),t.jsxs(i,{size:"sm",onClick:()=>U(e.id,!1),className:"bg-red-600 hover:bg-red-700",disabled:E,children:[t.jsx(u,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]}),"messages"===M&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"お問い合わせ対応"}),t.jsxs("div",{className:"text-sm text-gray-500",children:[v.unreadMessages,"件の未読"]})]}),t.jsxs(r,{className:"text-center py-12",children:[t.jsx(j,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 mb-4",children:"お問い合わせ機能は準備中です"}),t.jsx("p",{className:"text-sm text-gray-500",children:"現在はメールでのお問い合わせ対応となります"})]})]})]})}export{f as AdminTasks};
