const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug-DpRwnzaE.js","assets/index-BbveZyU8.js","assets/ui-vendor-CTwuE44L.js","assets/react-vendor-BBLDtDmh.js","assets/query-vendor-9fkSW1iq.js","assets/supabase-vendor-BcfcqyaE.js","assets/index-BHQqSkZs.css","assets/directVaccineUpload-wmVsjV54.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-vendor-BcfcqyaE.js";import{j as r,V as t,q as a,P as s}from"./ui-vendor-CTwuE44L.js";import{r as i,L as o}from"./react-vendor-BBLDtDmh.js";import{u as n,c,s as d,l,B as m,C as g}from"./index-BbveZyU8.js";import{D as u,a as p}from"./DogCard-BsPxYysV.js";import"./query-vendor-9fkSW1iq.js";import"./Input-CogJowp4.js";import"./Select-DXb7rP8v.js";import"./dogBreeds-6lxY8Uni.js";import"./VaccineBadge-BYdht1v_.js";function f(){const{user:f}=n(),[h,b]=i.useState([]),[x,y]=i.useState(!0),[_,j]=i.useState(""),[w,v]=i.useState(!1),[E,S]=i.useState(null),[D,$]=i.useState(!1),[N,I]=i.useState(""),[C,R]=i.useState(""),[V,U]=i.useState(!1),[A,q]=i.useState({name:"",breed:"",gender:"",birthDate:""}),[z,F]=i.useState(null),[L,P]=i.useState(null),[T,B]=i.useState(null),[M,O]=i.useState(null),[W,k]=i.useState(""),[G,H]=i.useState("");i.useEffect(()=>{f&&J()},[f]);const J=async()=>{try{y(!0),j("");const e=await c(()=>d.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",f?.id).order("created_at",{ascending:!1}));if(e.error)return l("error","Error fetching dogs",{error:e.error,userId:f?.id}),void j("ワンちゃんの情報を取得できませんでした。");b(e.data||[])}catch(e){l("error","Exception in fetchDogs",{error:e,userId:f?.id}),j("ワンちゃんの情報を取得できませんでした。")}finally{y(!1)}},K=e=>{S(e),q({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date}),P(e.image_url||null);const r=e.vaccine_certifications?.[0];r&&(k(r.rabies_expiry_date||""),H(r.combo_expiry_date||"")),v(!0)};return x?r.jsxs("div",{className:"flex justify-center items-center h-64",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),r.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsxs(o,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[r.jsx(t,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),r.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),r.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),r.jsx(o,{to:"/register-dog",children:r.jsxs(m,{children:[r.jsx(a,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),_&&r.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:_}),C&&r.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:C}),r.jsxs(g,{children:[r.jsx("div",{className:"flex justify-between items-center mb-4",children:r.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[r.jsx(s,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",h.length,"匹)"]})}),0===h.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(s,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),r.jsx(o,{to:"/register-dog",children:r.jsxs(m,{children:[r.jsx(a,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):r.jsx("div",{className:"space-y-4",children:h.map(e=>r.jsx(u,{dog:e,onEdit:K},e.id))})]}),w&&E&&r.jsx(p,{dog:E,isUpdating:D||V,error:N,success:C,dogFormData:A,dogImagePreview:L,onClose:()=>v(!1),onSubmit:async r=>{if(r.preventDefault(),E){$(!0),I(""),R("");try{const r={name:A.name,breed:A.breed,gender:A.gender,birth_date:A.birthDate};if(z){if(!z.type||!z.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${z.type}`);const e=`${E.id}/dog-photo.jpg`,t=`${"https://onmcivwxtzqajcovptgf.supabase.co"}/storage/v1/object/dog-images/${e}`,{data:{session:a}}=await d.auth.getSession();if(!a?.access_token)throw new Error("認証されていません。ログインしてください。");const s=await fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${a.access_token}`,"Content-Type":z.type,"Cache-Control":"3600"},body:z});if(!s.ok){const e=await s.text();throw l("error","❌ Direct upload failed",{error:e}),new Error(`直接アップロードに失敗しました: ${s.status} ${e}`)}await s.json();const{data:{publicUrl:i}}=d.storage.from("dog-images").getPublicUrl(e);r.image_url=i}const{error:t}=await d.from("dogs").update(r).eq("id",E.id);if(t)throw t;if(T&&M&&W&&G){const r=T.name.split(".").pop()||"jpg",t=M.name.split(".").pop()||"jpg",a=Date.now(),s=`temp/${E.id}/rabies_${a}.${r}`,i=`temp/${E.id}/combo_${a}.${t}`,{debugAuthStatus:o}=await e(async()=>{const{debugAuthStatus:e}=await import("./authDebug-DpRwnzaE.js");return{debugAuthStatus:e}},__vite__mapDeps([0,1,2,3,4,5,6]));await o();const{directVaccineUpload:n}=await e(async()=>{const{directVaccineUpload:e}=await import("./directVaccineUpload-wmVsjV54.js");return{directVaccineUpload:e}},__vite__mapDeps([7,1,2,3,4,5,6])),[c,m]=await Promise.all([n(s,T),n(i,M)]);if(!c.success||!m.success){l("error","🚨 === VACCINE UPLOAD ERROR DETAILS ==="),c.success||l("error","❌ Rabies upload error",{error:c.error}),m.success||l("error","❌ Combo upload error",{error:m.error});const e=c.error||m.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${e}`)}const g=c.url,u=m.url,{error:p}=await d.from("vaccine_certifications").upsert([{dog_id:E.id,rabies_vaccine_image:g,combo_vaccine_image:u,rabies_expiry_date:W,combo_expiry_date:G,status:"pending"}],{onConflict:"dog_id"});if(p)throw l("error","❌ Database save error",{error:p}),p.message&&p.message.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${p.message}`)}R("ワンちゃん情報を更新しました"),await J(),setTimeout(()=>{v(!1),R(""),F(null),P(null),B(null),O(null),k(""),H("")},2e3)}catch(t){l("error","Error updating dog",{error:t,dogId:E?.id});let e="ワンちゃん情報の更新に失敗しました";t instanceof Error&&(e=t.message.includes("520")||t.message.includes("Cloudflare")?"ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":t.message.includes("アップロードに失敗しました")?t.message:`エラーが発生しました: ${t.message}`),I(e)}finally{$(!1)}}},onDelete:async e=>{U(!0),I("");try{const{error:t}=await d.from("vaccine_certifications").delete().eq("dog_id",e.id);if(t&&l("warn","Error deleting vaccine certifications",{error:t,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],a=`${e.id}/${t}`,{error:s}=await d.storage.from("dog-images").remove([a])}catch(r){}const a=e.vaccine_certifications?.[0];if(a){const e=[];if(a.rabies_vaccine_image&&e.push(a.rabies_vaccine_image),a.combo_vaccine_image&&e.push(a.combo_vaccine_image),e.length>0){const{error:r}=await d.storage.from("vaccine-certs").remove(e)}}const{error:s}=await d.from("dogs").delete().eq("id",e.id);if(s)throw l("error","Error deleting dog",{error:s,dogId:e.id}),s;await J(),v(!1),R(`${e.name}の情報を削除しました。`),setTimeout(()=>{R("")},3e3)}catch(t){l("error","Error deleting dog",{error:t,dogId:e?.id});const r=t.message||"ワンちゃんの削除に失敗しました";I(r)}finally{U(!1)}},onFormChange:q,onImageSelect:async e=>{const r=e.target.files?.[0];if(l("info","🔍 File selected:",r?{name:r.name,type:r.type,size:r.size,lastModified:r.lastModified,isFileObject:r instanceof File}:{message:"No file selected"}),r)try{if(!(r instanceof File))return void I("有効なファイルを選択してください。");if(r.size>10485760)return void I("画像ファイルは10MB以下にしてください。");if(!r.type||!r.type.startsWith("image/"))return void I(`画像ファイルを選択してください。選択されたファイルタイプ: ${r.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type))return void I(`サポートされていない画像形式です: ${r.type}`);F(r),l("info","✅ Dog image file set successfully:",{name:r.name,type:r.type,size:r.size});const e=new FileReader;e.onload=e=>{P(e.target?.result)},e.readAsDataURL(r)}catch(t){I("画像の処理に失敗しました。")}},onImageRemove:async()=>{if(E&&E.image_url)try{$(!0),I("");try{const e=new URL(E.image_url).pathname.split("/"),r=e[e.length-1],t=`${E.id}/${r}`,{error:a}=await d.storage.from("dog-images").remove([t])}catch(e){l("warn","Warning: Error processing image deletion",{error:e})}const r=await c(()=>d.from("dogs").update({image_url:null}).eq("id",E.id));if(r.error)return l("error","Error updating dog image_url",{error:r.error,dogId:E.id}),void I("画像の削除に失敗しました。");F(null),P(null),S({...E,image_url:void 0}),await J(),l("info","✅ Dog image removed successfully",{dogId:E.id}),R("画像を削除しました。"),setTimeout(()=>{R("")},3e3)}catch(r){l("error","Error removing dog image",{error:r,dogId:E?.id}),I("画像の削除に失敗しました。")}finally{$(!1)}},rabiesVaccineFile:T,comboVaccineFile:M,rabiesExpiryDate:W,comboExpiryDate:G,onRabiesVaccineSelect:async e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void I("ワクチン証明書ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void I("画像ファイルを選択してください。");B(r)}else B(null)},onComboVaccineSelect:async e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void I("ワクチン証明書ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void I("画像ファイルを選択してください。");O(r)}else O(null)},onRabiesExpiryDateChange:k,onComboExpiryDateChange:H})]})}export{f as DogManagement};
