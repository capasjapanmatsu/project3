import{j as e,l as s,as as t,b as a,at as r,U as l,A as i,g as n,a3 as c,B as d,au as m,av as x,P as o,X as h,K as u,aw as g,ax as j,i as f,a7 as b,Q as N,ay as p}from"./ui-vendor-B03FHkej.js";import{u as y,r as w,L as v}from"./react-vendor-BBLDtDmh.js";import{u as _,s as k,C as q,B as S,l as C,j as D,c as I}from"./index-CWMjoAp3.js";import"./query-vendor-Cy2yKKks.js";import"./supabase-vendor-BcfcqyaE.js";function M(){const{user:l}=_(),i=y(),[n,c]=w.useState([]),[d,m]=w.useState(null),[x,o]=w.useState(!0),[h,u]=w.useState(""),[g,j]=w.useState(""),[f,b]=w.useState(!1);w.useEffect(()=>{N()},[]),w.useEffect(()=>{d&&p()},[d,l]);const N=()=>{if(o(!0),u(""),!navigator.geolocation)return u("お使いのブラウザは位置情報に対応していません"),void o(!1);navigator.geolocation.getCurrentPosition(e=>{m({latitude:e.coords.latitude,longitude:e.coords.longitude}),u("")},e=>{switch(e.code){case e.PERMISSION_DENIED:u("位置情報の利用が許可されていません");break;case e.POSITION_UNAVAILABLE:u("位置情報を取得できませんでした");break;case e.TIMEOUT:u("位置情報の取得がタイムアウトしました");break;default:u("位置情報の取得に失敗しました")}o(!1)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e5})},p=w.useCallback(async()=>{if(d&&l)try{o(!0),j("");const{data:e,error:s}=await k.from("dogs").select("\n          id,\n          name,\n          breed,\n          gender,\n          birth_date,\n          image_url,\n          owner_id,\n          created_at,\n          profiles!dogs_owner_id_fkey(name)\n        ").neq("owner_id",l.id).limit(50);if(s)throw s;if(!e||0===e.length)return void c([]);const t=e.map(e=>{const s=35.6812+.3*(Math.random()-.5),t=139.7671+.3*(Math.random()-.5),a=v(d.latitude,d.longitude,s,t),r=e;return{...e,owner_name:r.profiles?.name||"Unknown",distance:a,last_seen_at:new Date(Date.now()-7*Math.random()*24*60*60*1e3).toISOString()}}).sort((e,s)=>e.distance-s.distance).slice(0,20);c(t)}catch(e){j("近くのワンちゃん情報の取得に失敗しました")}finally{o(!1)}},[d,l]),v=(e,s,t,a)=>{const r=(t-e)*Math.PI/180,l=(a-s)*Math.PI/180,i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},C=e=>{const s=new Date(e),t=new Date,a=12*(t.getFullYear()-s.getFullYear())+t.getMonth()-s.getMonth();if(a<12)return`${a}ヶ月`;{const e=Math.floor(a/12),s=a%12;return s>0?`${e}歳${s}ヶ月`:`${e}歳`}},D=e=>"オス"===e?"♂":"♀";return h?e.jsx(q,{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(s,{className:"w-12 h-12 text-orange-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"位置情報が必要です"}),e.jsx("p",{className:"text-gray-600 mb-4",children:h}),e.jsxs(S,{onClick:N,className:"mb-2",children:[e.jsx(t,{className:"w-4 h-4 mr-2"}),"位置情報を取得"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"近くのワンちゃんを表示するには位置情報の許可が必要です"})]})}):e.jsxs(q,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(a,{className:"w-6 h-6 text-blue-600 mr-2"}),e.jsx("h2",{className:"text-xl font-bold",children:"近くのワンちゃんたち"})]}),e.jsxs(S,{size:"sm",variant:"secondary",onClick:N,disabled:x,children:[e.jsx(t,{className:"w-4 h-4 mr-1"}),"更新"]})]}),g&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 rounded-lg flex items-start",children:[e.jsx(s,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-red-800 text-sm",children:g})]}),x?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):0===n.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(a,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"近くにワンちゃんが見つかりませんでした"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"位置情報を更新するか、時間をおいて再度お試しください"})]}):e.jsxs("div",{className:"space-y-4",children:[(f?n:n.slice(0,5)).map(s=>{return e.jsxs("div",{className:"flex items-center space-x-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer",onClick:()=>(e=>{i(`/dog/${e.id}`)})(s),children:[e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full overflow-hidden flex-shrink-0",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:"🐕"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:[s.name,(t=s.gender,"オス"===t?"くん":"ちゃん")]}),e.jsx("span",{className:"text-sm text-gray-500",children:D(s.gender)})]}),e.jsx("div",{className:"text-sm text-gray-600 space-y-1",children:e.jsxs("p",{children:[s.breed," • ",C(s.birth_date)]})})]})]},s.id);var t}),n.length>5&&!f&&e.jsx("div",{className:"text-center pt-4",children:e.jsxs(S,{variant:"secondary",size:"sm",onClick:()=>b(!0),className:"px-6 py-2",children:[e.jsx(r,{className:"w-4 h-4 mr-2"}),"もっと見る（残り",n.length-5,"匹）"]})}),f&&n.length>=20&&e.jsx("div",{className:"text-center pt-4",children:e.jsx("p",{className:"text-sm text-gray-500",children:"近くに更に多くのワンちゃんがいる可能性があります"})}),f&&n.length>5&&e.jsx("div",{className:"text-center pt-2",children:e.jsxs(S,{variant:"secondary",size:"sm",onClick:()=>b(!1),className:"px-6 py-2",children:[e.jsx(r,{className:"w-4 h-4 mr-2 rotate-180"}),"折りたたむ"]})})]}),e.jsx("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(a,{className:"w-5 h-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"位置情報について"}),e.jsx("p",{children:"お使いの位置情報を基に、近い順でワンちゃんを表示しています。 位置情報は端末内でのみ処理され、サーバーには保存されません。"})]})]})})]})}function E(){const{user:s}=_(),[t,r]=w.useState("friends"),[y,E]=w.useState([]),[P,$]=w.useState([]),[z,T]=w.useState([]),[L,O]=w.useState([]),[A,J]=w.useState(!0),[U,F]=w.useState(null),[R,B]=w.useState(""),[Y,H]=w.useState(!1),[K,Q]=w.useState([]),[V,G]=w.useState([]),[W,X]=w.useState(""),[Z,ee]=w.useState(""),[se,te]=w.useState([]);w.useEffect(()=>{if(s){ae();const e=k.channel("friend_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"friend_requests",filter:`requested_id=eq.${s.id}`},()=>{fetchFriendRequests()}).subscribe(),t=k.channel("notifications_changes").on("postgres_changes",{event:"*",schema:"public",table:"notifications",filter:`user_id=eq.${s.id}`},()=>{fetchNotifications()}).subscribe(),a=k.channel("messages_changes").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${s.id}`},()=>{fetchMessages()}).subscribe();return()=>{e.unsubscribe(),t.unsubscribe(),a.unsubscribe()}}},[s]);const ae=async()=>{try{J(!0),C("info","コミュニティデータ取得開始");const e=await D({friendRequests:()=>I(()=>k.from("friend_requests").select("\n              *,\n              requester:profiles!friend_requests_requester_id_fkey(*)\n            ").eq("requested_id",s?.id).eq("status","pending").order("created_at",{ascending:!1})),friends:()=>I(()=>k.rpc("get_friends_with_dogs",{p_user_id:s?.id})),notifications:()=>I(()=>k.from("notifications").select("*").eq("user_id",s?.id).order("created_at",{ascending:!1}).limit(20)),messages:()=>I(()=>k.from("messages").select("\n              *,\n              sender:profiles!messages_sender_id_fkey(*),\n              receiver:profiles!messages_receiver_id_fkey(*)\n            ").or(`sender_id.eq.${s?.id},receiver_id.eq.${s?.id}`).order("created_at",{ascending:!1}).limit(50)),dogEncounters:()=>I(()=>k.from("dog_encounters").select("\n              *,\n              encountered_dog:dogs!dog_encounters_encountered_dog_id_fkey(\n                *,\n                owner:profiles!dogs_owner_id_fkey(*)\n              )\n            ").eq("user_id",s?.id).order("encounter_date",{ascending:!1}).limit(10)),userDogs:()=>I(()=>k.from("dogs").select("*").eq("owner_id",s?.id)),blacklistedDogs:()=>I(()=>k.from("dog_blacklist").select("\n              *,\n              blacklisted_dog:dogs!dog_blacklist_dog_id_fkey(\n                *,\n                owner:profiles!dogs_owner_id_fkey(*)\n              )\n            ").eq("user_id",s?.id).order("created_at",{ascending:!1}))});E(e.friendRequests||[]),$(e.friends||[]),T(e.notifications||[]),O(e.messages||[]),Q(e.dogEncounters||[]),G(e.userDogs||[]),te(e.blacklistedDogs||[]),C("info","コミュニティデータ取得完了")}catch(e){C("error","コミュニティデータ取得エラー",{error:e})}finally{J(!1)}},re=async(e,s)=>{try{const t=await I(()=>k.from("friend_requests").update({status:s?"accepted":"rejected",responded_at:(new Date).toISOString()}).eq("id",e));if(t.error)throw t.error;await ae(),ee(s?"友達リクエストを承認しました":"友達リクエストを拒否しました"),setTimeout(()=>ee(""),3e3)}catch(t){C("error","Error handling friend request",{error:t,requestId:e,accept:s}),X("リクエストの処理に失敗しました"),setTimeout(()=>X(""),3e3)}},le=s=>{switch(s){case"friend_request":return e.jsx(c,{className:"w-5 h-5 text-blue-600"});case"friend_accepted":return e.jsx(p,{className:"w-5 h-5 text-green-600"});case"friend_at_park":return e.jsx(l,{className:"w-5 h-5 text-purple-600"});case"reservation_reminder":return e.jsx(f,{className:"w-5 h-5 text-orange-600"});case"blacklisted_dog_nearby":return e.jsx(i,{className:"w-5 h-5 text-red-600"});default:return e.jsx(d,{className:"w-5 h-5 text-gray-600"})}},ie=e=>{switch(e){case"friend_request":return"bg-blue-50";case"friend_accepted":return"bg-green-50";case"friend_at_park":return"bg-purple-50";case"reservation_reminder":return"bg-orange-50";case"blacklisted_dog_nearby":return"bg-red-50";default:return"bg-gray-50"}},ne=e=>"オス"===e?"くん":"ちゃん",ce=(e,s)=>{if(s&&s.length>0){const e=s[0];return`${e.name}${ne(e.gender)}の飼い主さん`}return"ワンちゃんの飼い主さん"};return A?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(l,{className:"w-8 h-8 text-blue-600 mr-3"}),"コミュニティ"]}),W&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(i,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:W})]}),Z&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(n,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:Z})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs("div",{className:"flex space-x-1 border-b mb-6 overflow-x-auto",children:[e.jsxs("button",{className:"px-4 py-2 font-medium relative whitespace-nowrap "+("friends"===t?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>r("friends"),children:[e.jsx(l,{className:"w-5 h-5 inline mr-1"}),"友達"]}),e.jsxs("button",{className:"px-4 py-2 font-medium relative whitespace-nowrap "+("requests"===t?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>r("requests"),children:[e.jsx(c,{className:"w-5 h-5 inline mr-1"}),"リクエスト",y.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:y.length})]}),e.jsxs("button",{className:"px-4 py-2 font-medium relative whitespace-nowrap "+("notifications"===t?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>r("notifications"),children:[e.jsx(d,{className:"w-5 h-5 inline mr-1"}),"通知",z.filter(e=>!e.read).length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:z.filter(e=>!e.read).length})]}),e.jsxs("button",{className:"px-4 py-2 font-medium relative whitespace-nowrap "+("messages"===t?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>r("messages"),children:[e.jsx(m,{className:"w-5 h-5 inline mr-1"}),"メッセージ",L.filter(e=>!e.read&&e.receiver_id===s?.id).length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:L.filter(e=>!e.read&&e.receiver_id===s?.id).length})]}),e.jsxs("button",{className:"px-4 py-2 font-medium relative whitespace-nowrap "+("nearby"===t?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>r("nearby"),children:[e.jsx(a,{className:"w-5 h-5 inline mr-1"}),"近くのワンちゃん"]}),e.jsxs("button",{className:"px-4 py-2 font-medium relative whitespace-nowrap "+("blacklist"===t?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>r("blacklist"),children:[e.jsx(i,{className:"w-5 h-5 inline mr-1"}),"ブラックリスト",se.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:se.length})]})]}),"friends"===t&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"友達一覧"}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(S,{variant:"secondary",size:"sm",onClick:()=>fetchFriends(),children:[e.jsx(x,{className:"w-4 h-4 mr-1"}),"並び替え"]})})]}),0===P.length?e.jsxs(q,{className:"text-center py-8",children:[e.jsx(l,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"まだ友達がいません"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"同じドッグランで出会ったワンちゃんの飼い主さんと友達になれます"})]}):e.jsx("div",{className:"space-y-4",children:P.map(s=>e.jsx(q,{className:"p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx(l,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:ce(s.friend,s.friend_dogs)}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.dog_count,"頭のワンちゃんと一緒"]}),s.friend_dogs&&s.friend_dogs.length>0&&e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(o,{className:"w-4 h-4 text-blue-600 mr-1"}),e.jsx("p",{className:"text-xs text-gray-500",children:s.friend_dogs.map(e=>`${e.name}${e.gender?ne(e.gender):"ちゃん"}`).join("、")})]})]})]}),e.jsxs(S,{size:"sm",onClick:()=>F(s),children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"メッセージ"]})]})},s.id))})]}),"requests"===t&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"友達リクエスト"}),0===y.length?e.jsxs(q,{className:"text-center py-8",children:[e.jsx(c,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"リクエストはありません"}),e.jsx("p",{className:"text-gray-500",children:"同じドッグランで出会った人からのリクエストがここに表示されます"})]}):e.jsx("div",{className:"space-y-4",children:y.map(s=>e.jsx(q,{className:"p-4",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx(l,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"ワンちゃんの飼い主さんからのリクエスト"}),e.jsx("p",{className:"text-sm text-gray-600",children:new Date(s.created_at).toLocaleDateString("ja-JP")}),s.message&&e.jsx("p",{className:"text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded",children:s.message})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(S,{size:"sm",onClick:()=>re(s.id,!0),children:[e.jsx(n,{className:"w-4 h-4 mr-1"}),"承認"]}),e.jsxs(S,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>re(s.id,!1),children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),"拒否"]})]})]})},s.id))})]}),"nearby"===t&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"block lg:hidden",children:e.jsx(M,{})}),e.jsx("div",{className:"hidden lg:block",children:e.jsxs(q,{className:"p-6 text-center",children:[e.jsx(a,{className:"w-12 h-12 text-blue-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"近くのワンちゃんたち"}),e.jsx("p",{className:"text-gray-600",children:"この機能はサイドバーでご利用いただけます"})]})})]}),"blacklist"===t&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ブラックリスト"}),0===se.length?e.jsxs(q,{className:"text-center py-8",children:[e.jsx(i,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"ブラックリストは空です"}),e.jsx("p",{className:"text-gray-500",children:"相性が悪いワンちゃんをブラックリストに登録すると、そのワンちゃんがドッグランに入った時に通知されます"})]}):e.jsx("div",{className:"space-y-4",children:se.map(s=>e.jsx(q,{className:"p-4 bg-red-50 border-red-200",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.blacklisted_dog?.image_url?e.jsx("img",{src:s.blacklisted_dog.image_url,alt:s.blacklisted_dog.name,className:"w-full h-full object-cover"}):e.jsx(o,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-red-900",children:[s.blacklisted_dog?.name,s.blacklisted_dog?.gender&&ne(s.blacklisted_dog.gender)]}),e.jsx("p",{className:"text-sm text-red-700",children:"飼い主: ワンちゃんの飼い主さん"}),e.jsxs("p",{className:"text-sm text-red-600 mt-1",children:["理由: ",s.reason]}),e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["登録日: ",new Date(s.created_at).toLocaleDateString("ja-JP")]})]})]}),e.jsxs(S,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>(async e=>{try{const s=await I(()=>k.from("dog_blacklist").delete().eq("id",e));if(s.error)throw s.error;await ae(),ee("ブラックリストから削除しました"),setTimeout(()=>ee(""),3e3)}catch(s){C("error","Error removing from blacklist",{error:s,blacklistId:e}),X("ブラックリストからの削除に失敗しました"),setTimeout(()=>X(""),3e3)}})(s.id),children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),"削除"]})]})},s.id))})]}),"notifications"===t&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"通知"}),0===z.length?e.jsxs(q,{className:"text-center py-8",children:[e.jsx(d,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"通知はありません"}),e.jsx("p",{className:"text-gray-500",children:"友達リクエストや予約の通知がここに表示されます"})]}):e.jsx("div",{className:"space-y-4",children:z.map(s=>e.jsx(q,{className:`p-4 ${s.read?"":"border-l-4 border-blue-500"} ${ie(s.type)}`,onClick:()=>!s.read&&(async e=>{try{const s=await I(()=>k.from("notifications").update({read:!0}).eq("id",e));if(s.error)throw s.error;T(s=>s.map(s=>s.id===e?{...s,read:!0}:s))}catch(s){C("error","Error marking notification as read",{error:s,notificationId:e})}})(s.id),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[le(s.type),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold",children:s.title}),e.jsx("p",{className:"text-sm text-gray-700",children:s.message}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[new Date(s.created_at).toLocaleDateString("ja-JP")," ",new Date(s.created_at).toLocaleTimeString("ja-JP")]})]}),!s.read&&e.jsx("div",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full",children:"新着"})]})},s.id))})]}),"messages"===t&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"メッセージ"}),0===L.length?e.jsxs(q,{className:"text-center py-8",children:[e.jsx(m,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"メッセージはありません"}),e.jsx("p",{className:"text-gray-500",children:"友達とのメッセージがここに表示されます"})]}):e.jsx("div",{className:"space-y-4",children:L.map(t=>{const a=t.receiver_id===s?.id,r=a?t.sender:null;return e.jsx(q,{className:"p-4 "+(!t.read&&a?"border-l-4 border-blue-500":""),onClick:()=>F({id:t.id,friend_id:a?t.sender_id:t.receiver_id,friend:r||{id:"",name:"",user_type:"user",created_at:(new Date).toISOString()},dog_count:0,created_at:(new Date).toISOString()}),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx(l,{className:"w-5 h-5 text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("h3",{className:"font-semibold",children:[a?"ワンちゃんの飼い主さん":"自分"," ","から"]}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(t.created_at).toLocaleDateString("ja-JP")})]}),e.jsx("p",{className:"text-sm text-gray-700 mt-1",children:t.content})]}),!t.read&&a&&e.jsx("div",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full",children:"未読"})]})},t.id)})})]}),U&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"ワンちゃんの飼い主さんとのメッセージ"}),e.jsx("button",{onClick:()=>F(null),className:"text-gray-500 hover:text-gray-700",children:e.jsx(h,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"h-64 overflow-y-auto mb-4 p-3 bg-gray-50 rounded-lg",children:e.jsx("div",{className:"text-center text-gray-500 text-sm py-4",children:"メッセージ履歴はまだありません"})}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("h4",{className:"font-medium text-blue-900 mb-2 flex items-center",children:[e.jsx(u,{className:"w-4 h-4 mr-1"}),"施設貸し切り予約の共有"]}),e.jsx("p",{className:"text-sm text-blue-800 mb-2",children:"施設貸し切り予約がある場合、友達にPINコードを共有できます"}),e.jsxs(S,{size:"sm",variant:"secondary",className:"w-full",onClick:()=>{alert("この機能は準備中です。施設貸し切り予約がある場合に利用できます。")},children:[e.jsx(g,{className:"w-3 h-3 mr-1"}),"予約を共有"]})]}),e.jsx("form",{onSubmit:async e=>{if(e.preventDefault(),U&&R.trim()){H(!0);try{const e=await I(()=>k.from("messages").insert({sender_id:s?.id,receiver_id:U.friend_id,content:R.trim(),read:!1}));if(e.error)throw e.error;await ae(),B("")}catch(t){C("error","Error sending message",{error:t,friendId:U?.friend_id}),X("メッセージの送信に失敗しました"),setTimeout(()=>X(""),3e3)}finally{H(!1)}}},children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"text",value:R,onChange:e=>B(e.target.value),placeholder:"メッセージを入力...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),e.jsxs(S,{type:"submit",isLoading:Y,disabled:!R.trim(),children:[e.jsx(j,{className:"w-4 h-4 mr-1"}),"送信"]})]})})]})})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(M,{}),e.jsxs(q,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(o,{className:"w-5 h-5 text-blue-600 mr-2"}),"最近の出会い"]}),0===K.length?e.jsx("p",{className:"text-gray-600 text-sm",children:"まだ出会いの記録がありません"}):e.jsxs("div",{className:"space-y-4",children:[K.slice(0,5).map(t=>{const r=t.dog1.owner_id===s?.id?t.dog1:t.dog2,l=t.dog1.owner_id===s?.id?t.dog2:t.dog1,n=l.owner_id;return e.jsxs("div",{className:"flex items-start space-x-3 pb-3 border-b border-gray-100 last:border-b-0 last:pb-0",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:l.image_url?e.jsx("img",{src:l.image_url,alt:l.name,className:"w-full h-full object-cover"}):e.jsx(o,{className:"w-5 h-5 text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"font-medium text-sm",children:[r.name,ne(r.gender),"と",l.name,ne(l.gender)]}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs(S,{size:"sm",variant:"secondary",className:"text-xs px-2 py-1",onClick:()=>(async(e,t)=>{try{const t=await I(()=>k.from("friend_requests").insert({requester_id:s?.id,requested_id:e,message:"ドッグランでお会いした際は、よろしくお願いします！"}));if(t.error)throw t.error;ee("友達申請を送信しました"),setTimeout(()=>ee(""),3e3)}catch(a){C("error","Error sending friend request",{error:a,targetUserId:e,dogName:t}),X("友達申請の送信に失敗しました"),setTimeout(()=>X(""),3e3)}})(n,l.name),children:[e.jsx(c,{className:"w-3 h-3 mr-1"}),"友達申請"]}),e.jsxs(S,{size:"sm",variant:"secondary",className:"text-xs px-2 py-1 text-red-600 hover:text-red-700",onClick:()=>{const e=prompt("ブラックリストに登録する理由を入力してください:");e&&(async(e,t)=>{try{const a=await I(()=>k.from("dog_blacklist").insert({user_id:s?.id,dog_id:e,reason:t,notify_when_nearby:!0}));if(a.error)throw a.error;await ae(),ee("ブラックリストに追加しました"),setTimeout(()=>ee(""),3e3)}catch(a){C("error","Error adding to blacklist",{error:a,dogId:e,reason:t}),X("ブラックリストへの追加に失敗しました"),setTimeout(()=>X(""),3e3)}})(l.id,e)},children:[e.jsx(i,{className:"w-3 h-3 mr-1"}),"ブラックリスト"]})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-1 mt-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{className:"w-3 h-3 mr-1"}),e.jsx("span",{children:new Date(t.encounter_date).toLocaleDateString("ja-JP")})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(a,{className:"w-3 h-3 mr-1"}),e.jsx("span",{children:t.park.name})]})]})]})]},t.id)}),e.jsxs(S,{variant:"secondary",size:"sm",className:"w-full",children:["すべての出会いを見る",e.jsx(b,{className:"w-4 h-4 ml-1"})]})]})]}),e.jsxs(q,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(N,{className:"w-5 h-5 text-pink-600 mr-2"}),"あなたのワンちゃん"]}),0===V.length?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-gray-600 text-sm mb-3",children:"まだワンちゃんが登録されていません"}),e.jsx(v,{to:"/register-dog",children:e.jsx(S,{size:"sm",children:"ワンちゃんを登録"})})]}):e.jsxs("div",{className:"space-y-3",children:[V.map(s=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(o,{className:"w-5 h-5 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-sm",children:[s.name,ne(s.gender)]}),e.jsx("p",{className:"text-xs text-gray-500",children:s.breed})]})]},s.id)),e.jsx(v,{to:"/register-dog",children:e.jsxs(S,{variant:"secondary",size:"sm",className:"w-full",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),"ワンちゃんを追加"]})})]})]}),e.jsxs(q,{className:"p-6 bg-blue-50 border-blue-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3 text-blue-900",children:"コミュニティガイド"}),e.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"友達申請について:"}),e.jsx("br",{}),"同じドッグランで出会ったワンちゃんの飼い主さんとのみ友達になれます。"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"メッセージ機能:"}),e.jsx("br",{}),"友達になった方とメッセージのやり取りができます。次回の予約を調整したり、ワンちゃんの情報を共有したりしましょう。"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"通知機能:"}),e.jsx("br",{}),"友達リクエストや予約の通知が届きます。友達のワンちゃんが近くのドッグランにいる場合も通知されます。"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"ブラックリスト機能:"}),e.jsx("br",{}),"相性が悪いワンちゃんをブラックリストに登録すると、そのワンちゃんがドッグランに入った時に通知されます。"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"施設共有機能:"}),e.jsx("br",{}),"施設貸し切り予約をした場合、友達を誘ってPINコードを共有することができます。"]})]})]})]})]})]})}export{E as Community};
