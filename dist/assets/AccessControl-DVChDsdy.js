import{j as e,C as b,B as C,u as M,b as O,s as D}from"./index-BB1ywuBb.js";import{r as l,u as F}from"./react-vendor-Co5xHYdE.js";import{K as I,A as E,i as L,e as K,_ as U,P as T,b as G}from"./ui-vendor-B2-VOB5s.js";import{V as H,g as $}from"./VaccineBadge-CDRo-PLS.js";import"./supabase-vendor-FDBaXLCh.js";function J({lockId:j,parkName:p="ドッグパーク",purpose:i="entry",className:_="",onSuccess:N,onError:y}){const[d,v]=l.useState(""),[c,w]=l.useState(!1),[o,u]=l.useState(null),[k,g]=l.useState(null),P=n=>{const a=n.target.value.replace(/\D/g,"");a.length<=6&&v(a)},x=async()=>{if(d.length!==6){u("PINコードは6桁で入力してください");return}w(!0),u(null),g(null);try{const n=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lock_id:j,pin:d,purpose:i})});if(!n.ok){const f=await n.json();throw new Error(f.error||"PINコードの検証に失敗しました")}const a=await n.json();if(!a.success)throw new Error(a.error||"PINコードが無効です");g(a.message||"PINコードが確認されました"),v(""),N&&N(a),setTimeout(()=>{g(null)},3e3)}catch(n){console.error("Error verifying PIN:",n);const a=n.message||"PINコードの検証に失敗しました";u(a),y&&y(a)}finally{w(!1)}};return e.jsx(b,{className:`p-4 ${_}`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-center",children:[e.jsx(I,{className:"w-5 h-5 text-blue-600 mr-2"}),p,"の",i==="entry"?"入口":"出口"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-gray-600 mb-4",children:[i==="entry"?"入場":"退場","用のPINコードを入力してください"]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("input",{type:"text",value:d,onChange:P,placeholder:"6桁のPINコード",className:"px-4 py-2 text-center text-2xl tracking-widest w-48 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:6,inputMode:"numeric",pattern:"[0-9]*"})}),o&&e.jsxs("div",{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",children:[e.jsx(E,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:o})]}),k&&e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",children:[e.jsx(L,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:k})]}),e.jsxs(C,{onClick:()=>void x(),isLoading:c,disabled:d.length!==6,className:"w-full",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),c?e.jsx(K,{className:"w-4 h-4 animate-spin"}):"PINコードを確認"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[i==="entry"?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]})]})})}function ee(){const{user:j}=M(),p=F();O();const[i,_]=l.useState([]),[N,y]=l.useState([]),[d,v]=l.useState([]),[c,w]=l.useState([]),[o,u]=l.useState(null),[k,g]=l.useState(!1),[P,x]=l.useState(""),[n,a]=l.useState(""),f=3;l.useEffect(()=>{const s=async()=>{if(j)try{const{data:t,error:m}=await D.from("dogs").select(`
            *,
            vaccine_certifications (
              id,
              status,
              rabies_expiry_date,
              combo_expiry_date,
              approved_at
            )
          `).eq("owner_id",j.id);if(m)throw m;const h=(t||[]).filter(S=>$(S)==="approved");_(h),t&&t.length>0&&h.length===0&&x("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")}catch(t){console.error("Error fetching dogs:",t),x("ワンちゃんの情報を取得できませんでした。")}},r=async()=>{try{g(!0);const{data:t,error:m}=await D.from("dog_parks").select("*").eq("status","approved");if(m)throw m;v(t||[]);const{data:h,error:S}=await D.from("smart_locks").select("*").eq("status","active");if(S)throw S;y(h||[]),h&&h.length>0&&u(h[0])}catch(t){console.error("Error fetching data:",t),x("データの取得に失敗しました。")}finally{g(!1)}};s(),r()},[j]);const V=s=>{w(r=>r.includes(s)?r.filter(t=>t!==s):r.length<f?[...r,s]:r)},q=()=>c.map(s=>{const r=i.find(t=>t.id===s);return r?`${r.name}${A(r.gender)}`:""}).filter(Boolean).join("、"),B=s=>{a("PINコードを生成しました"),setTimeout(()=>{a("")},3e3)},z=s=>{x(s),setTimeout(()=>{x("")},5e3)},A=s=>s==="オス"?"くん":"ちゃん";return k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(C,{variant:"primary",size:"sm",onClick:()=>p(-1),className:"mr-3",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),P&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:P}),n&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:n}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(T,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),e.jsx(C,{onClick:()=>p("/register-dog"),children:"ワンちゃんを登録する"})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",f,"頭）"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[c.length,"/",f,"頭選択中"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:i.map(s=>{const r=c.includes(s.id),t=!r&&c.length>=f;return e.jsxs("div",{className:`p-4 border-2 rounded-lg cursor-pointer transition-colors relative ${r?"border-green-500 bg-green-50":t?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"}`,onClick:()=>!t&&V(s.id),children:[r&&e.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:e.jsx(L,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(T,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold",children:[s.name,A(s.gender)]}),e.jsx(H,{status:$(s),size:"sm"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.breed," • ",s.gender]})]})]})]},s.id)})}),c.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),e.jsx("p",{className:"text-sm text-green-800",children:q()}),e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[c.length,"頭が同時入場できます"]})]})]})})]}),e.jsxs(b,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(G,{className:"w-5 h-5 text-blue-600 mr-2"}),"施設を選択"]}),N.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"利用可能な施設がありません"})]}):e.jsx("div",{className:"space-y-3",children:N.map(s=>{const r=d.find(m=>m.id===s.park_id),t=o?.id===s.id;return e.jsx("div",{className:`p-4 border-2 rounded-lg cursor-pointer transition-colors ${t?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>u(s),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:r?.name||"Unknown Park"}),e.jsx("p",{className:"text-sm text-gray-600",children:s.lock_name}),e.jsx("p",{className:"text-xs text-gray-500",children:r?.address})]}),t&&e.jsx(L,{className:"w-5 h-5 text-blue-600"})]})},s.id)})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(I,{className:"w-5 h-5 text-blue-600 mr-2"}),"PINコード生成"]}),o&&c.length>0?e.jsx(J,{lockId:o.lock_id,parkName:d.find(s=>s.id===o.park_id)?.name||"ドッグパーク",purpose:"entry",onSuccess:B,onError:z}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-2",children:"PINコードを生成するには："}),e.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[e.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),e.jsx("li",{children:"• 施設を選択"})]})]})]}),e.jsxs(b,{className:"p-6 bg-blue-50 border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"PINコードの使い方"}),e.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"1"}),e.jsx("p",{children:"ワンちゃんと施設を選択してPINコードを生成します"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"2"}),e.jsx("p",{children:"ドッグランの入口にあるスマートロックのキーパッドにPINコードを入力します"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"3"}),e.jsx("p",{children:"PINコードは5分間有効です"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"4"}),e.jsx("p",{children:"退場時も同様にPINコードを生成して使用します"})]})]})]})]})]})]})}export{ee as AccessControl};
