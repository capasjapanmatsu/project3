import{j as e,V as G,X as J,a1 as W}from"./ui-vendor-FlUr4cJt.js";import{r as j,L as R}from"./react-vendor-_GyjDmDn.js";import{I as X}from"./Input-wBkmcJUR.js";import{S as _}from"./Select-BEASmsUK.js";import{u as H,B as P,C as K,s as p,n as Q}from"./index-BSYT0262.js";import{d as Z}from"./dogBreeds-CaddeN4P.js";import{h as ee}from"./vaccineUploadFixed-mws0h5s7.js";import{l as t}from"./logger-C8dD4C56.js";import"./supabase-vendor-Df9iqQzW.js";const U=n=>{if(!n)return{isValid:!1,error:"ファイルが選択されていません"};const v=10*1024*1024;return n.size>v?{isValid:!1,error:"ファイルサイズは10MB以下にしてください"}:["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(n.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${n.type}`}};function ce(){const{user:n}=H(),[v,m]=j.useState(!1),[V,o]=j.useState(""),[g,w]=j.useState(null),[C,N]=j.useState(null),[r,d]=j.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),$=new Date().getFullYear(),q=Array.from({length:21},(a,s)=>{const i=$-s;return{value:i.toString(),label:`${i}年`}}),L=Array.from({length:12},(a,s)=>{const i=s+1;return{value:i.toString().padStart(2,"0"),label:`${i}月`}}),F=()=>{if(!r.birthYear||!r.birthMonth)return Array.from({length:31},(u,b)=>{const l=b+1;return{value:l.toString().padStart(2,"0"),label:`${l}日`}});const a=parseInt(r.birthYear),s=parseInt(r.birthMonth),i=new Date(a,s,0).getDate();return Array.from({length:i},(u,b)=>{const l=b+1;return{value:l.toString().padStart(2,"0"),label:`${l}日`}})},Y=()=>{if(!r.birthYear||!r.birthMonth||!r.birthDay)return!1;const a=parseInt(r.birthYear),s=parseInt(r.birthMonth),i=parseInt(r.birthDay),u=new Date(a,s-1,i);if(u>new Date)return!1;const l=new Date;return l.setFullYear(l.getFullYear()-20),!(u<l)},T=a=>{const s=a.target.files?.[0];if(s){if(t.info("Selected file:",s.name,s.size,s.type),s.size>10*1024*1024){o("画像ファイルは10MB以下にしてください。");return}if(!s.type.startsWith("image/")){o("画像ファイルを選択してください。");return}w(s);const i=new FileReader;i.onload=u=>{N(u.target?.result),t.info("Image preview created")},i.readAsDataURL(s),o("")}},A=()=>{w(null),N(null)},O=async a=>{a.preventDefault(),m(!0),o("");try{if(t.info("=== DOG REGISTRATION START ==="),t.info("Starting dog registration for user:",n?.id),!Y()){o("正しい生年月日を選択してください。"),m(!1);return}if(!r.rabiesExpiryDate||!r.comboExpiryDate){o("ワクチンの有効期限を入力してください。"),m(!1);return}const s=new Date,i=new Date(r.rabiesExpiryDate),u=new Date(r.comboExpiryDate);if(i<=s||u<=s){o("ワクチンの有効期限は今日より後の日付を入力してください。"),m(!1);return}const b=`${r.birthYear}-${r.birthMonth}-${r.birthDay}`;let l;if(r.gender==="オス"||r.gender==="male"||r.gender.toLowerCase()==="male")l="オス";else if(r.gender==="メス"||r.gender==="female"||r.gender.toLowerCase()==="female")l="メス";else{o("性別を正しく選択してください。"),m(!1);return}t.info("Original gender:",r.gender,"Normalized gender:",l);const{data:D,error:x}=await p.from("profiles").select("id, name, user_type").eq("id",n?.id).maybeSingle();if(t.info("Profile check result:",D,x),x&&x.code!=="PGRST116")throw t.error("Profile error:",x),x;if(D)t.info("Profile exists:",D);else{t.info("Creating profile for dog registration using upsert");const c=n?.user_metadata?.name||n?.email?.split("@")[0]||"ユーザー",{data:E,error:f}=await p.from("profiles").upsert([{id:n?.id,user_type:"user",name:c,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(f)throw t.error("Profile upsert error:",f),f;t.info("Profile upserted successfully:",E)}t.info("Registering dog with data:",{name:r.name,breed:r.breed,birth_date:b,gender:l,owner_id:n?.id});const{data:y,error:h}=await p.from("dogs").insert([{name:r.name,breed:r.breed,birth_date:b,gender:l,owner_id:n?.id}]).select().single();if(h)throw t.error("🚨 Dog registration error:",h),t.error("🚨 Error details:",{message:h.message,code:h.code,details:h.details,hint:h.hint}),h;t.info("✅ Dog registered successfully:",y),t.info("✅ Dog ID generated:",y.id);let I=null;if(g){t.info("Uploading dog image...");try{const c=g.name.split(".").pop()||"jpg",E=Date.now(),f=`${y.id}/profile_${E}.${c}`;t.info("Uploading to path:",f),t.info("🔧 Uploading dog image with Content-Type:",g.type);const{error:S}=await p.storage.from("dog-images").upload(f,g,{cacheControl:"3600",upsert:!0,contentType:g.type});if(S)throw t.error("Image upload error:",S),new Error(`画像のアップロードに失敗しました: ${S.message}`);t.info("Upload successful");const{data:{publicUrl:B}}=p.storage.from("dog-images").getPublicUrl(f);I=B,t.info("Public URL generated:",I);const{error:M}=await p.from("dogs").update({image_url:I}).eq("id",y.id);if(M)throw t.error("Error updating dog image URL:",M),new Error("画像URLの更新に失敗しました");t.info("Dog image URL updated successfully")}catch(c){t.error("Image processing error:",c),o("画像のアップロードに失敗しましたが、ワンちゃんの登録は完了しました。後でマイページから画像を追加できます。")}}if(r.rabiesVaccineImage&&r.comboVaccineImage){t.info("🧪 Starting vaccine certificates upload using utility...");const c=await ee(y.id,r.rabiesVaccineImage,r.comboVaccineImage,r.rabiesExpiryDate,r.comboExpiryDate);c.success?t.info("✅ Vaccine certificates uploaded successfully"):(t.error("Vaccine upload failed:",c.error),o(`ワクチン証明書のアップロードに失敗しました: ${c.error}`))}t.info("Dog registration completed successfully"),Q.success("ワンちゃんの登録が完了しました！"),d({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),w(null),N(null)}catch(s){t.error("Registration error:",s),o("ワンちゃんの登録に失敗しました。もう一度お試しください。")}finally{m(!1)}},k=Z.map(a=>({value:a,label:a})),z=[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}];return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[e.jsxs("div",{children:[e.jsxs(R,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[e.jsx(G,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"新しいワンちゃんを登録して、ドッグランを利用しましょう"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-900",children:"既に登録済みのワンちゃんがいますか？"}),e.jsx("p",{className:"text-sm text-blue-700",children:"登録済みのワンちゃんの情報を確認・編集できます"})]}),e.jsx(R,{to:"/dog-management",children:e.jsx(P,{variant:"secondary",size:"sm",children:"ワンちゃん管理"})})]})}),e.jsx(K,{children:e.jsxs("form",{onSubmit:O,children:[V&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:V}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ワンちゃんの写真（任意）"}),C?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:C,alt:"ワンちゃんのプレビュー",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:A,className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(J,{className:"w-4 h-4"})}),g&&e.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:g.name})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:T,className:"hidden",id:"dog-image"}),e.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[e.jsx(W,{className:"w-12 h-12 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (最大10MB)"})]})]})]}),e.jsx(X,{label:"名前",value:r.name,onChange:a=>d({...r,name:a.target.value}),required:!0}),e.jsx(_,{label:"犬種",options:k,value:r.breed,onChange:a=>d({...r,breed:a.target.value}),required:!0}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"生年月日 *"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx("div",{children:e.jsxs("select",{value:r.birthYear,onChange:a=>{d({...r,birthYear:a.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"年"}),q.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:r.birthMonth,onChange:a=>{d({...r,birthMonth:a.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"月"}),L.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:r.birthDay,onChange:a=>d({...r,birthDay:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!r.birthYear||!r.birthMonth,children:[e.jsx("option",{value:"",children:"日"}),F().map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})})]}),r.birthYear&&r.birthMonth&&!r.birthDay&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"日を選択してください"}),r.birthYear&&r.birthMonth&&r.birthDay&&!Y()&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:"正しい生年月日を選択してください（未来の日付や20年以上前の日付は選択できません）"})]}),e.jsx(_,{label:"性別",options:z,value:r.gender,onChange:a=>d({...r,gender:a.target.value}),required:!0}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ワクチン証明書"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン接種証明書 *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:a=>{const s=a.target.files?.[0];if(s){const i=U(s);if(!i.isValid){o(i.error||"ファイルの検証に失敗しました");return}o("")}d({...r,rabiesVaccineImage:s||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン有効期限 *"}),e.jsx("input",{type:"date",value:r.rabiesExpiryDate,onChange:a=>d({...r,rabiesExpiryDate:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン接種証明書 *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:a=>{const s=a.target.files?.[0];if(s){const i=U(s);if(!i.isValid){o(i.error||"ファイルの検証に失敗しました");return}o("")}d({...r,comboVaccineImage:s||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン有効期限 *"}),e.jsx("input",{type:"date",value:r.comboExpiryDate,onChange:a=>d({...r,comboExpiryDate:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800",children:"※ ワクチン接種証明書は運営による確認後に承認されます。承認されるまでドッグランの利用はできません。"})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"ワクチン証明書について:"}),e.jsx("br",{}),"• 管理者が確認しやすい形で保存されます",e.jsx("br",{}),"• 承認されると正式にワクチン情報として登録されます",e.jsx("br",{}),"• 承認後、全国のドッグランをご利用いただけます"]})})]}),e.jsx(P,{type:"submit",isLoading:v,className:"w-full",children:"ワンちゃんを登録する"})]})})]})}export{ce as DogRegistration};
