import{u as e,s as a,j as s,B as t}from"./index-T-nty6Ge.js";import{u as l,r,L as n}from"./vendor-BHVjIt_u.js";import{C as c}from"./Card-DW8Xk96S.js";import{I as i}from"./Input-B9o2mE6T.js";import{d as o}from"./csvExport-CYgrbVbx.js";import{D as d,a2 as m,am as x,k as u,Z as p,_ as h,ao as j,e as b,ap as f,i as g}from"./ui-srxHNTHo.js";import"./supabase-CKbzEL5D.js";function w(){const{user:w,isAdmin:y}=e(),v=l(),[N,_]=r.useState(!0),[k,S]=r.useState(""),[C,L]=r.useState([]),[D,F]=r.useState([]),[$,P]=r.useState(""),[M,O]=r.useState((new Date).getFullYear()),[I,R]=r.useState((new Date).getMonth()),[Y,E]=r.useState(0),[z,A]=r.useState(0),[T,B]=r.useState(0),Q=Array.from({length:4},((e,a)=>{const s=(new Date).getFullYear()-a;return{value:s,label:`${s}年`}}));r.useEffect((()=>{y?V():v("/")}),[y,v,M,I]),r.useEffect((()=>{C.length>0&&Z()}),[C,$]);const V=async()=>{try{_(!0),S("");const e=new Date(M,I,1),s=new Date(M,I+1,0),t=e.toISOString().split("T")[0],l=s.toISOString().split("T")[0],{data:r,error:n}=await a.rpc("get_monthly_revenue_by_park",{start_date_param:t,end_date_param:l});if(n)throw n;const c=(r||[]).map((e=>({owner_id:e.owner_id,owner_name:e.owner_name,park_id:e.park_id,park_name:e.park_name,total_revenue:e.total_revenue,platform_fee:Math.round(.2*e.total_revenue),owner_payout:Math.round(.8*e.total_revenue),bank_name:e.bank_name||"未設定",bank_code:e.bank_code||"未設定",branch_name:e.branch_name||"未設定",branch_code:e.branch_code||"未設定",account_type:e.account_type||"ordinary",account_number:e.account_number||"未設定",month:I+1,year:M})));L(c);const i=c.reduce(((e,a)=>(e.totalRevenue+=a.total_revenue,e.totalPlatformFee+=a.platform_fee,e.totalOwnerPayout+=a.owner_payout,e)),{totalRevenue:0,totalPlatformFee:0,totalOwnerPayout:0});E(i.totalRevenue),A(i.totalPlatformFee),B(i.totalOwnerPayout),Z()}catch(e){S("売上データの取得に失敗しました。")}finally{_(!1)}},Z=()=>{if(!$.trim())return void F(C);const e=C.filter((e=>e.owner_name.toLowerCase().includes($.toLowerCase())||e.park_name.toLowerCase().includes($.toLowerCase())));F(e)};return N?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs(n,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[s.jsx(d,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[s.jsx(m,{className:"w-8 h-8 text-green-600 mr-3"}),"ドッグラン売上レポート"]}),s.jsxs(t,{onClick:()=>{const e=D.map((e=>[e.owner_name,e.park_name,e.total_revenue,e.platform_fee,e.owner_payout,e.bank_name,e.bank_code,e.branch_name,e.branch_code,"ordinary"===e.account_type?"普通":"当座",e.account_number,e.year,e.month]));o(["オーナー名","ドッグラン名","売上合計額","プラットフォーム手数料（20%）","振込金額（80%）","銀行名","銀行コード","支店名","支店コード","口座種別","口座番号","年","月"],e,`ドッグラン売上_${M}年${I+1}月.csv`)},disabled:0===D.length,children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"CSV出力"]})]}),k&&s.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[s.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{children:k})]}),s.jsx(c,{className:"p-6",children:s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0",children:[s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx(t,{variant:"secondary",size:"sm",onClick:()=>{0===I?(O(M-1),R(11)):R(I-1)},children:s.jsx(p,{className:"w-4 h-4"})}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("select",{value:M,onChange:e=>O(Number(e.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:Q.map((e=>s.jsx("option",{value:e.value,children:e.label},e.value)))}),s.jsx("select",{value:I,onChange:e=>R(Number(e.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[{value:0,label:"1月"},{value:1,label:"2月"},{value:2,label:"3月"},{value:3,label:"4月"},{value:4,label:"5月"},{value:5,label:"6月"},{value:6,label:"7月"},{value:7,label:"8月"},{value:8,label:"9月"},{value:9,label:"10月"},{value:10,label:"11月"},{value:11,label:"12月"}].map((e=>s.jsx("option",{value:e.value,children:e.label},e.value)))})]}),s.jsx(t,{variant:"secondary",size:"sm",onClick:()=>{const e=new Date,a=e.getFullYear(),s=e.getMonth();M===a&&I===s||(11===I?(O(M+1),R(0)):R(I+1))},disabled:M===(new Date).getFullYear()&&I===(new Date).getMonth(),children:s.jsx(h,{className:"w-4 h-4"})})]}),s.jsx("div",{className:"w-full md:w-64",children:s.jsx(i,{label:"",value:$,onChange:e=>P(e.target.value),placeholder:"オーナー名・ドッグラン名で検索...",icon:s.jsx(j,{className:"w-4 h-4 text-gray-500"})})})]})}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsx(c,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"総売上"}),s.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",Y.toLocaleString()]})]}),s.jsx(m,{className:"w-8 h-8 text-green-600"})]})}),s.jsx(c,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"プラットフォーム手数料（20%）"}),s.jsxs("p",{className:"text-2xl font-bold text-blue-600",children:["¥",z.toLocaleString()]})]}),s.jsx(b,{className:"w-8 h-8 text-blue-600"})]})}),s.jsx(c,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"オーナー振込額（80%）"}),s.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:["¥",T.toLocaleString()]})]}),s.jsx(f,{className:"w-8 h-8 text-purple-600"})]})})]}),s.jsxs(c,{className:"p-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ドッグラン別売上"}),0===D.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(g,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"この月の売上データはありません"})]}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full bg-white",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"オーナー名"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン名"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"売上合計"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料（20%）"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込金額（80%）"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込先"})]})}),s.jsx("tbody",{className:"divide-y divide-gray-200",children:D.map((e=>s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.owner_name}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.park_name}),s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:["¥",e.total_revenue.toLocaleString()]}),s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:["¥",e.platform_fee.toLocaleString()]}),s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600",children:["¥",e.owner_payout.toLocaleString()]}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:"未設定"!==e.bank_name?s.jsxs("div",{children:[s.jsxs("p",{children:[e.bank_name,"（",e.bank_code,"）"]}),s.jsxs("p",{children:[e.branch_name,"（",e.branch_code,"）"]}),s.jsxs("p",{children:["ordinary"===e.account_type?"普通":"当座"," ",e.account_number]})]}):s.jsx("span",{className:"text-red-600",children:"未設定"})})]},`${e.park_id}-${e.month}-${e.year}`)))})]})})]}),s.jsx(c,{className:"p-6 bg-blue-50 border-blue-200",children:s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx(f,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"振込情報について"}),s.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[s.jsx("p",{children:"• 振込は毎月15日に前月分を一括で行います"}),s.jsx("p",{children:"• 振込手数料は当社負担です"}),s.jsx("p",{children:"• 振込先情報が未設定のオーナーには振込ができません"}),s.jsx("p",{children:"• 振込金額が5,000円未満の場合は翌月に繰り越されます"}),s.jsx("p",{children:"• 振込完了後、オーナーに自動でメールが送信されます"})]})]})]})})]})}export{w as AdminRevenueReport};
