import{j as e,m as s,A as t}from"./motion-CuO0nkIV.js";import{r as a}from"./react-vendor-cniURDpR.js";import{c as i,a as l,L as r}from"./router-CiK0M--J.js";import{u as n,B as c,s as o,f as d,p as m,e as x,g as h,i as u,m as p,t as g,j as b}from"./index-C8-ZovGr.js";import{C as j}from"./Card-roTxPFVC.js";import{I as f}from"./ImageCropper-DvQ_zHLa.js";import{L as N}from"./LocationEditMap-CQJhO7Zr.js";import{aK as y,X as w,A as v,u as _,K as k,aL as C,O as S,R as T,i as q,a8 as I,C as O,r as P,F as R,aH as z,aI as E,b as B,M as $,Z as D,J as A,j as F,V as M,aM as L,aF as Y,U as H,aN as U,P as X,Y as J,aJ as W,a1 as G,ar as K}from"./ui-basic-DtvVsAeD.js";import"./heavy-features-BIdEME4r.js";import"./supabase-DJQiR77k.js";import"./external-api-DuTtfpce.js";import"./geocoding-C2oaRnzC.js";import"./Input-pnFPNpa9.js";function Q({onComplete:s,onClose:t,onStepChange:i}){const{user:l}=n(),[r,d]=a.useState(0),[m,x]=a.useState(""),[h,u]=a.useState(!1),[p,g]=a.useState(null),[b,f]=a.useState(!1),[N,k]=a.useState(0),C=a.useRef(null),S=a.useRef();a.useRef(!1);const T=[{id:"welcome",title:"🎉 審査通過おめでとうございます！",message:"いよいよオープンです。次に案内する設定を見直しオープンしましょう。",targetSelector:"",position:"bottom"},{id:"location-tab",title:"📍 位置調整を開始",message:"「位置調整」タブをタップして、ドッグランの正確な位置を設定してください。",targetSelector:'[data-walkthrough="location-tab"]',position:"bottom",showArrow:!0,arrowBlinkCount:3,action:()=>{i?.("location"),setTimeout(()=>{I()},300)}},{id:"map-explanation",title:"🗺️ マップで位置を確認",message:"マップ上の赤いマーカーをドラッグして、実際のドッグランの位置に調整してください。正確な位置は利用者が見つけやすくするために重要です！",targetSelector:'[data-walkthrough="location-map"]',position:"top",action:()=>{setTimeout(()=>{const e=document.querySelector('[data-walkthrough="location-map"]');if(e){const s=e.getBoundingClientRect(),t=window.pageYOffset+s.top-420;window.scrollTo({top:Math.max(0,t),behavior:"smooth"})}else window.scrollTo({top:500,behavior:"smooth"})},400)}},{id:"save-location",title:"💾 位置を保存",message:"位置の調整が完了したら、「位置を保存」ボタンをタップして座標を保存してください。",targetSelector:'[data-walkthrough="save-location-button"]',position:"top",showArrow:!0,arrowBlinkCount:3},{id:"pins-tab",title:"🔑 PINコード管理へ",message:"次に、スマートロックの設定を行います。「PINコード管理」タブをタップしてください。",targetSelector:'[data-walkthrough="pins-tab"]',position:"bottom",showArrow:!0,arrowBlinkCount:3,action:()=>{i?.("pins"),setTimeout(()=>{I()},300)}},{id:"setup-smartlock",title:"🔒 スマートロック設定",message:"「スマートロックを設定する」ボタンをタップして、入退場管理システムを設定してください。",targetSelector:'[data-walkthrough="setup-smartlock-button"]',position:"top",showArrow:!0,arrowBlinkCount:3}],q=T[r],I=()=>{window.scrollTo({top:0,behavior:"smooth"})};a.useCallback(e=>{const s=e.getBoundingClientRect(),t=window.pageYOffset+s.top-window.innerHeight/2+s.height/2;window.scrollTo({top:Math.max(0,t),behavior:"smooth"})},[]);const O=a.useCallback(e=>{if(!e||"string"!=typeof e||""===e.trim())return u(!1),void x("");if(h)return;S.current&&clearTimeout(S.current),u(!0),x("");const s=String(e).trim();let t=0;const a=()=>{if(t<s.length){const e=s[t];e&&"undefined"!==e&&x(s=>(s||"")+e),t++,S.current=setTimeout(a,50)}else u(!1)};a()},[h]),P=a.useCallback(()=>{if(!q?.targetSelector)return void g(null);const e=document.querySelector(q.targetSelector);e?(g(e),R(e,q.targetSelector),q.showArrow&&(f(!0),k(q.arrowBlinkCount||0))):g(null)},[q]),R=a.useCallback((e,s)=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),document.querySelectorAll("[data-walkthrough-spotlight]").forEach(e=>{e.__walkthroughCleanup&&e.__walkthroughCleanup()}),e.setAttribute("data-walkthrough-spotlight","true");const t=e.style.zIndex,a=e.style.position,i=e.style.boxShadow,l=e.style.transform,r=e.style.backgroundColor,n=s.includes("button")||"button"===e.tagName.toLowerCase()||"button"===e.getAttribute("role");e.style.cssText+=n?"\n        position: relative !important;\n        z-index: 9999 !important;\n        box-shadow: 0 0 0 4px #3B82F6, 0 0 0 8px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 1.0), 0 0 80px rgba(59, 130, 246, 0.6) !important;\n        transform: scale(1.05) !important;\n        transition: all 0.3s ease-in-out !important;\n        border-radius: 8px !important;\n        filter: brightness(1.1) contrast(1.1) !important;\n      ":"\n        position: relative !important;\n        z-index: 9999 !important;\n        box-shadow: 0 0 0 4px #3B82F6, 0 0 0 8px rgba(59, 130, 246, 0.3), 0 0 30px rgba(59, 130, 246, 0.8), 0 0 60px rgba(59, 130, 246, 0.4) !important;\n        transform: scale(1.02) !important;\n        transition: all 0.3s ease-in-out !important;\n        background-color: rgba(255, 255, 255, 0.95) !important;\n        border-radius: 8px !important;\n      ",e.__walkthroughCleanup=()=>{e.removeAttribute("data-walkthrough-spotlight"),e.style.zIndex=t,e.style.position=a,e.style.boxShadow=i,e.style.transform=l,e.style.backgroundColor=r,e.style.borderRadius="",e.style.transition="",e.style.filter=""}},[]);a.useEffect(()=>{q&&(x(""),u(!1),setTimeout(()=>{q.message&&"string"==typeof q.message?O(q.message):(x("メッセージを読み込めませんでした。"),u(!1))},100),q.action&&q.action(),setTimeout(()=>{P()},q.action?600:200))},[r]),a.useEffect(()=>()=>{S.current&&clearTimeout(S.current),document.querySelectorAll("[data-walkthrough-spotlight]").forEach(e=>{const s=e;s.__walkthroughCleanup&&s.__walkthroughCleanup()})},[]);const z=async()=>{try{l&&await o.from("profiles").update({park_management_walkthrough_completed:!0}).eq("id",l.id),s()}catch(e){s()}};return q?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 "+("map-explanation"===q.id||"setup-smartlock"===q.id?"z-[10000]":"z-40")}),p&&e.jsx("div",{className:"fixed pointer-events-none z-50 rounded-lg shadow-2xl animate-pulse",style:{top:p.getBoundingClientRect().top+window.pageYOffset-8+"px",left:p.getBoundingClientRect().left+window.pageXOffset-8+"px",width:`${p.getBoundingClientRect().width+16}px`,height:`${p.getBoundingClientRect().height+16}px`,background:"rgba(59, 130, 246, 0.2)",border:"4px solid #3B82F6",boxShadow:"0 0 0 4px rgba(59, 130, 246, 0.3), 0 0 30px rgba(59, 130, 246, 0.6), 0 0 0 9999px rgba(0, 0, 0, 0.4)"}}),b&&p&&e.jsx("div",{className:"fixed z-50 text-blue-500 "+(N>0?"animate-pulse":""),style:{top:"top"===q.position?p.getBoundingClientRect().top+window.pageYOffset-40+"px":`${p.getBoundingClientRect().bottom+window.pageYOffset+10}px`,left:p.getBoundingClientRect().left+window.pageXOffset+p.getBoundingClientRect().width/2-12+"px"},children:"top"===q.position?e.jsx(y,{size:24,className:"animate-bounce"}):e.jsx(y,{size:24,className:"animate-bounce rotate-180"})}),e.jsx("div",{ref:C,className:"fixed transition-all duration-500 ease-out "+("map-explanation"===q.id?"w-96 max-w-lg animate-expand z-[10001]":"setup-smartlock"===q.id?"w-80 max-w-sm z-[10001]":"w-80 max-w-sm z-50"),style:{top:"map-explanation"===q.id?"80px":"save-location"===q.id?"200px":"setup-smartlock"===q.id?"120px":p&&"top"===q.position?p.getBoundingClientRect().top+window.pageYOffset-200+"px":p&&"bottom"===q.position?`${p.getBoundingClientRect().bottom+window.pageYOffset+60}px`:"50%",left:"map-explanation"===q.id||"save-location"===q.id||"setup-smartlock"===q.id?"50%":p?`${Math.max(16,Math.min(window.innerWidth-("map-explanation"===q.id?400:336),p.getBoundingClientRect().left+window.pageXOffset+p.getBoundingClientRect().width/2-("map-explanation"===q.id?200:160)))}px`:"50%",transform:"map-explanation"===q.id||"save-location"===q.id||"setup-smartlock"===q.id?"translateX(-50%)":p?"none":"translate(-50%, -50%)"},children:e.jsxs(j,{className:"relative shadow-2xl border-blue-200",children:[e.jsx("button",{onClick:t,className:"absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(w,{size:20})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 pr-8",children:q.title}),e.jsxs("div",{className:"text-gray-600 mb-6 min-h-[3em] whitespace-pre-line",children:[m||"",h&&e.jsx("span",{className:"animate-pulse",children:"|"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(c,{variant:"outline",onClick:()=>{z()},children:"スキップ"}),e.jsxs("div",{className:"text-sm text-gray-500",children:[r+1," / ",T.length]}),e.jsx(c,{onClick:()=>{r<T.length-1?(d(r+1),f(!1)):z()},disabled:h,className:"flex items-center gap-2",children:r<T.length-1?e.jsxs(e.Fragment,{children:["次へ",e.jsx(v,{size:16})]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{size:16}),"完了"]})})]})]})]})})]}):null}const V=document.createElement("style");function Z({lockId:i,parkName:l="ドッグパーク",purpose:r="entry",className:f="",onSuccess:N,onError:y,reservationId:w}){const{user:v}=n(),[P,R]=a.useState(null),[z,E]=a.useState(null),[B,$]=a.useState(null),[D,A]=a.useState(!1),[F,M]=a.useState(null),[L,Y]=a.useState(!1),[H,U]=a.useState(!1),[X,J]=a.useState(!1),[W,G]=a.useState(""),[K,Q]=a.useState(!1);a.useEffect(()=>{if(P&&z){const e=setInterval(()=>{const s=new Date,t=z.getTime()-s.getTime();if(t<=0)$("期限切れ"),R(null),E(null),clearInterval(e);else{const e=Math.floor(t/6e4),s=Math.floor(t%6e4/1e3);$(`${e}:${s.toString().padStart(2,"0")}`)}},1e3);return()=>clearInterval(e)}},[P,z]);const V=async()=>{if(v){A(!0),M(null);try{const{data:{session:e}}=await o.auth.getSession();if(!e?.access_token)throw new Error("認証が必要です");let s=5,t=null;if(w){const e=await(async e=>{try{const{data:s,error:t}=await o.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("id",e).single();return t?null:s}catch(s){return null}})(w);if(e&&"whole_facility"===e.reservation_type&&(t=(e=>{try{const s=new Date(e.date),t=e.start_time.split(":").map(Number),a=t[0]??0,i=t[1]??0;return s.setHours(a,i,0,0),new Date(s.getTime()+60*e.duration*60*1e3)}catch(s){return null}})(e),t)){const e=new Date,a=t.getTime()-e.getTime();s=Math.max(1,Math.ceil(a/6e4))}}const a=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/generate-pin",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({lock_id:i,purpose:r,expiry_minutes:s,reservation_id:w||void 0})});if(!a.ok){const e=await a.json();throw new Error(e.error||"PINコードの生成に失敗しました")}const{pin:l,expires_at:n}=await a.json();R(l),E(new Date(n)),Q(!0),U(!0),await b(),N&&N(l),setTimeout(()=>{U(!1),Q(!1)},3e3)}catch(e){const s=e instanceof Error?e.message:"PINコードの生成に失敗しました";if(s.startsWith("PAYMENT_REQUIRED:")){const e=s.replace("PAYMENT_REQUIRED:","").trim();G(e),J(!0),M(null)}else M(s),J(!1);y&&y(s)}finally{A(!1)}}};return e.jsx(s.div,{className:f,initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4},children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsxs(s.h3,{className:"text-lg font-semibold mb-4 flex items-center justify-center",variants:d,initial:"initial",animate:"animate",children:[e.jsx(s.div,{animate:K?{rotate:[0,15,-15,0]}:{},transition:{duration:.6,repeat:2},children:e.jsx(k,{className:"w-5 h-5 text-blue-600 mr-2"})}),l,"の","entry"===r?"入口":"出口"]}),e.jsx(t,{mode:"wait",children:P?e.jsxs(s.div,{className:"space-y-4",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3},children:[e.jsxs(s.div,{className:"bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border-2 border-blue-200 mx-auto",variants:m,initial:"initial",animate:K?"animate":"initial",children:[e.jsx("p",{className:"text-sm text-blue-800 mb-1",children:"PINコード:"}),e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(s.p,{className:"text-3xl font-bold tracking-widest text-blue-700",initial:{scale:1},animate:K?{scale:[1,1.1,1]}:{},transition:{duration:.6},children:P}),e.jsx(s.button,{onClick:async()=>{if(P)try{await navigator.clipboard.writeText(P),Y(!0),await g(),setTimeout(()=>Y(!1),2e3)}catch{}},className:"p-1 text-blue-600 hover:text-blue-800 transition-colors",title:"コピー",variants:x,whileHover:"hover",whileTap:"tap",children:e.jsx(t,{mode:"wait",children:L?e.jsx(s.div,{variants:h,initial:"initial",animate:"animate",exit:{scale:0,opacity:0},children:e.jsx(_,{className:"w-5 h-5 text-green-600"})},"copied"):e.jsx(s.div,{variants:h,initial:"initial",animate:"animate",exit:{scale:0,opacity:0},children:e.jsx(C,{className:"w-5 h-5"})},"copy")})})]})]}),e.jsx(s.div,{className:"bg-yellow-50 p-2 rounded-lg",variants:d,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-yellow-800",children:[e.jsx(s.div,{animate:{rotate:[0,360]},transition:{duration:2,repeat:1/0,ease:"linear"},children:e.jsx(S,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["有効期限: ",B]})]})}),e.jsx("div",{className:"flex justify-center space-x-3",children:e.jsx(s.div,{variants:x,whileHover:"hover",whileTap:"tap",children:e.jsxs(c,{onClick:()=>{V()},variant:"secondary",size:"sm",isLoading:D,children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),"再生成"]})})}),e.jsxs(s.p,{className:"text-xs text-gray-500",variants:d,children:["entry"===r?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]},"pin-display"):e.jsxs(s.div,{className:"space-y-4",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[e.jsxs(s.p,{className:"text-gray-600 mb-4",variants:d,children:["entry"===r?"入場":"退場","用のPINコードを生成します。",e.jsx("br",{}),"生成されたPINコードは5分間有効です。"]}),e.jsxs(t,{children:[F&&e.jsxs(s.div,{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",variants:u,initial:"initial",animate:"shake",exit:{opacity:0,y:-10},children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:F})]}),X&&e.jsxs(s.div,{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",variants:p,initial:"initial",animate:"animate",exit:"exit",children:[e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsx(I,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"決済が必要です"}),e.jsx("p",{className:"text-sm text-blue-800 mb-4",children:W})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(s.div,{variants:x,whileHover:"hover",whileTap:"tap",children:e.jsxs(c,{onClick:()=>window.location.href="/subscription-intro",className:"w-full bg-purple-600 hover:bg-purple-700",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"サブスクリプションに加入（¥3,800/月）"]})}),e.jsx(s.div,{variants:x,whileHover:"hover",whileTap:"tap",children:e.jsxs(c,{onClick:()=>window.location.href="/parks",variant:"secondary",className:"w-full",children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"1日券を購入（¥800）"]})})]}),e.jsxs("p",{className:"text-xs text-blue-700 mt-3",children:["• サブスクリプション：全国のドッグランが使い放題",e.jsx("br",{}),"• 1日券：選択したドッグランで24時間利用可能"]})]}),H&&e.jsxs(s.div,{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",variants:h,initial:"initial",animate:"animate",exit:{opacity:0,scale:.8},children:[e.jsx(_,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:"🎉 PINコードを生成しました"})]})]}),e.jsx(s.div,{variants:x,whileHover:"hover",whileTap:"tap",children:e.jsxs(c,{onClick:()=>{V()},isLoading:D,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700",children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"🚀 ","entry"===r?"入場":"退場","用PINを生成"]})})]},"pin-generate")})]})})})}V.textContent="\n  @keyframes expand {\n    0% {\n      width: 320px;\n      height: 160px;\n      opacity: 0.8;\n    }\n    100% {\n      width: 384px;\n      height: auto;\n      opacity: 1;\n    }\n  }\n  \n  .animate-expand {\n    animation: expand 0.5s ease-out forwards;\n  }\n",document.head.querySelector("style[data-walkthrough]")||(V.setAttribute("data-walkthrough","true"),document.head.appendChild(V));const ee={overview:{label:"施設全景",description:"ドッグランの全体が見渡せる写真",icon:P,required:!0},entrance:{label:"入口",description:"入口の様子がわかる写真",icon:$,required:!0},gate:{label:"スマートロック",description:"ドッグランのスマートロック（入退場管理）の写真",icon:B,required:!0},large_dog_area:{label:"大型犬エリア",description:"大型犬用のエリアの写真",icon:P,required:!1,conditionalOn:"large_dog_area"},small_dog_area:{label:"小型犬エリア",description:"小型犬用のエリアの写真",icon:P,required:!1,conditionalOn:"small_dog_area"},private_booth:{label:"プライベートブース",description:"プライベートブースの内部と外観",icon:P,required:!1,conditionalOn:"private_booths"},parking:{label:"駐車場",description:"駐車場の様子がわかる写真",icon:E,required:!1,conditionalOn:"facilities.parking"},shower:{label:"シャワー設備",description:"シャワー設備の写真",icon:z,required:!1,conditionalOn:"facilities.shower"},restroom:{label:"トイレ",description:"トイレ設備の写真",icon:R,required:!1,conditionalOn:"facilities.restroom"},agility:{label:"アジリティ設備",description:"アジリティ設備の写真",icon:P,required:!1,conditionalOn:"facilities.agility"},rest_area:{label:"休憩スペース",description:"休憩スペースの写真",icon:P,required:!1,conditionalOn:"facilities.rest_area"},water_station:{label:"給水設備",description:"給水設備の写真",icon:P,required:!1,conditionalOn:"facilities.water_station"}},se=e=>{if(!e)return null;return new Date(e).toISOString()},te=e=>{if(!e)return"";const s=new Date(e);return new Date(s.getTime()-6e4*s.getTimezoneOffset()).toISOString().slice(0,16)};function ae(){const{id:s}=i(),{user:t}=n();l();const[d,m]=a.useState(null),[x,h]=a.useState(!0),[u,p]=a.useState(""),[g,b]=a.useState(""),[y,v]=a.useState("overview"),[C,S]=a.useState([]),[T,I]=a.useState(null),[z,E]=a.useState("entry"),[B,V]=a.useState([]),[ae,ie]=a.useState(!1),[le,re]=a.useState(null),[ne,ce]=a.useState({title:"",description:"",start_date:"",end_date:"",is_emergency:!1,notify_users:!0}),[oe,de]=a.useState(!1),[me,xe]=a.useState(!1),[he,ue]=a.useState(!1),[pe,ge]=a.useState(!1),[be,je]=a.useState(!1),[fe,Ne]=a.useState(""),[ye,we]=a.useState(!1),[ve,_e]=a.useState({max_capacity:0,facilities:{parking:!1,shower:!1,restroom:!1,agility:!1,rest_area:!1,water_station:!1},large_dog_area:!1,small_dog_area:!1,private_booths:!1,private_booth_count:0,facility_details:"",description:"",address:"",latitude:null,longitude:null,is_public:!1}),[ke,Ce]=a.useState([]),[Se,Te]=a.useState(!1),[qe,Ie]=a.useState(""),[Oe,Pe]=a.useState(null),[Re,ze]=a.useState(!1),[Ee,Be]=a.useState(null),[$e,De]=a.useState(""),[Ae,Fe]=a.useState(""),[Me,Le]=a.useState(null),[Ye,He]=a.useState(!1),Ue=async()=>{if(s)try{const{data:e,error:t}=await o.from("maintenance_schedules").select("*").eq("dog_park_id",s).order("start_date",{ascending:!0});if(t)throw t;V(e||[])}catch(e){}};a.useEffect(()=>{"true"===new URLSearchParams(window.location.search).get("test_walkthrough")&&He(!0)},[]);const Xe=a.useCallback(async()=>{if(s&&t&&d)try{const{data:e,error:s}=await o.from("profiles").select("park_management_walkthrough_completed").eq("id",t.id).single();if(s){if(!s.message.includes("column")||!s.message.includes("does not exist"))throw s}else if(e?.park_management_walkthrough_completed)return;"approved"===d.status&&He(!0)}catch(e){}},[s,t,d]),Je=a.useCallback(async()=>{if(t)try{await o.from("profiles").update({park_management_walkthrough_completed:!0}).eq("id",t.id),He(!1)}catch(e){}},[t]),We=a.useCallback(e=>{"location"===e?v("location"):"pins"===e&&v("pins")},[]);a.useEffect(()=>{s&&t&&Ge()},[s,t]),a.useEffect(()=>{d&&(Ke(),Ue())},[d]),a.useEffect(()=>{Xe()},[s,t,d]);const Ge=async()=>{if(s&&t)try{h(!0),p("");const{data:e,error:a}=await o.from("dog_parks").select("*").eq("id",s).eq("owner_id",t.id).single();if(a)throw new Error("ドッグランが見つかりません");m(e),_e({max_capacity:e.max_capacity||0,facilities:{parking:e.facilities?.parking||!1,shower:e.facilities?.shower||!1,restroom:e.facilities?.restroom||!1,agility:e.facilities?.agility||!1,rest_area:e.facilities?.rest_area||!1,water_station:e.facilities?.water_station||!1},large_dog_area:e.large_dog_area||!1,small_dog_area:e.small_dog_area||!1,private_booths:e.private_booths||!1,private_booth_count:e.private_booth_count||0,facility_details:e.facility_details||"",description:e.description||"",address:e.address||"",latitude:e.latitude||null,longitude:e.longitude||null,is_public:e.is_public||!1});const{data:i,error:l}=await o.from("smart_locks").select("*").eq("park_id",s);!l&&i&&(S(i),i.length>0&&I(i[0]))}catch(e){p(e.message||"データの取得に失敗しました")}finally{h(!1)}},Ke=async()=>{if(d)try{const{data:e,error:s}=await o.from("dog_park_facility_images").select("*").eq("park_id",d.id);if(s&&"PGRST116"!==s.code)return;const t=Object.entries(ee).filter(([,e])=>{if(e.required)return!0;if(e.conditionalOn&&d){const s=e.conditionalOn.split(".");if(1===s.length)return d[s[0]]??!1;if(2===s.length){const e=d[s[0]];if(e&&"object"==typeof e)return e[s[1]]??!1}}return!1}).map(([e])=>e).map(s=>{const t=(e||[]).find(e=>e.image_type===s);return{id:t?.id,image_type:s,image_url:t?.image_url,is_approved:t?.is_approved??null,admin_notes:t?.admin_notes}});Ce(t)}catch(e){}},Qe=(e,s)=>{De(e),Fe(s.name),Le({image_type:e,file:s}),Te(!0)};return x?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):d?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:e.jsxs(r,{to:"/my-parks-management",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"管理中ドッグラン一覧に戻る"]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[x&&e.jsx("div",{className:"flex justify-center items-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}),!x&&d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-lg border p-6 mb-6",children:e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:d.name}),e.jsx("p",{className:"text-gray-600 mt-1",children:d.address}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(A,{className:"w-4 h-4 text-yellow-400 fill-current mr-1"}),e.jsx("span",{className:"text-sm font-medium",children:d.average_rating.toFixed(1)}),e.jsxs("span",{className:"text-sm text-gray-500 ml-1",children:["(",d.review_count,"件)"]})]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(r,{to:`/parks/${d.id}`,children:e.jsxs(c,{variant:"secondary",className:"min-w-[100px]",children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),"公開ページ"]})}),e.jsxs(c,{onClick:()=>xe(!0),className:"min-w-[100px]",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"設定編集"]})]})]})}),u&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[e.jsx(q,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:u})]}),g&&e.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 flex items-start",children:[e.jsx(_,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:g})]}),e.jsx(j,{className:"mb-6",children:e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("div",{className:"flex space-x-8 px-6",children:[e.jsxs("button",{className:"py-4 px-2 border-b-2 font-medium text-sm transition-colors "+("overview"===y?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),onClick:()=>v("overview"),children:[e.jsx(P,{className:"w-4 h-4 inline mr-2"}),"概要・メンテナンス"]}),e.jsxs("button",{className:"py-4 px-2 border-b-2 font-medium text-sm transition-colors "+("stats"===y?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),onClick:()=>v("stats"),children:[e.jsx(A,{className:"w-4 h-4 inline mr-2"}),"統計・収益"]}),e.jsxs("button",{className:"py-4 px-2 border-b-2 font-medium text-sm transition-colors "+("pins"===y?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),onClick:()=>v("pins"),"data-walkthrough":"pins-tab",children:[e.jsx(k,{className:"w-4 h-4 inline mr-2"}),"PINコード管理"]}),e.jsxs("button",{className:"py-4 px-2 border-b-2 font-medium text-sm transition-colors "+("settings"===y?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),onClick:()=>v("settings"),children:[e.jsx(L,{className:"w-4 h-4 inline mr-2"}),"設定"]}),e.jsxs("button",{className:"py-4 px-2 border-b-2 font-medium text-sm transition-colors "+("location"===y?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),onClick:()=>v("location"),"data-walkthrough":"location-tab",children:[e.jsx($,{className:"w-4 h-4 inline mr-2"}),"位置調整"]})]})})}),"overview"===y&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(j,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(R,{className:"w-6 h-6 text-blue-600 mr-2"}),"基本情報"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"施設情報"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"住所:"})," ",d.address]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"ステータス:"})," ","approved"===d.status?"運営中":"審査中"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"料金:"})," ¥",d.price||"800","/日"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"最大収容人数:"})," ",d.max_capacity||"未設定","人"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"現在の利用者数:"})," ",d.current_occupancy||0,"人"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"評価:"})," ★",d.average_rating?.toFixed(1)||"0.0"," (",d.review_count||0,"件)"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"設備情報"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries({parking:"駐車場",shower:"シャワー設備",restroom:"トイレ",agility:"アジリティ設備",rest_area:"休憩スペース",water_station:"給水設備"}).map(([s,t])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 rounded "+(d.facilities?.[s]?"bg-green-500":"bg-gray-300")}),e.jsx("span",{className:"text-sm",children:t})]},s))}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"大型犬エリア:"})," ",d.large_dog_area?"あり":"なし"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"小型犬エリア:"})," ",d.small_dog_area?"あり":"なし"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"プライベートブース:"})," ",d.private_booths?`${d.private_booth_count||1}室`:"なし"]})]})]})]})]}),"approved"===d?.status&&e.jsxs(j,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(F,{className:"w-6 h-6 text-blue-600 mr-2"}),"公開設定"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"ドッグラン一覧に表示"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:ve.is_public?"ドッグラン一覧やマップに表示されます。利用者が検索・予約できます。":"ドッグラン一覧に表示されません。直接URLを知る人のみアクセス可能です。"})]}),e.jsx("div",{className:"ml-4",children:e.jsx("button",{type:"button",disabled:pe,onClick:()=>(async e=>{if(s&&t)try{ge(!0),p("");const{error:a}=await o.from("dog_parks").update({is_public:e,updated_at:(new Date).toISOString()}).eq("id",s).eq("owner_id",t.id);if(a)throw a;_e(s=>({...s,is_public:e})),m(s=>s?{...s,is_public:e}:null),b(e?"ドッグランを公開しました":"ドッグランを非公開にしました"),setTimeout(()=>b(""),3e3)}catch(a){p("公開設定の更新に失敗しました: "+a.message)}finally{ge(!1)}})(!ve.is_public),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${ve.is_public?"bg-blue-600":"bg-gray-200"} ${pe?"opacity-50 cursor-not-allowed":""}`,children:e.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform "+(ve.is_public?"translate-x-6":"translate-x-1")})})})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-full "+(ve.is_public?"bg-green-500":"bg-yellow-500")}),e.jsx("span",{className:"font-medium",children:ve.is_public?"公開中":"非公開"})]}),!ve.is_public&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(q,{className:"w-5 h-5 text-yellow-600 mt-0.5 mr-2"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"注意:"})," 非公開設定中は、ドッグランが一覧に表示されず、新しい利用者からの予約を受け付けできません。"]})]})})]})]}),e.jsxs(j,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(O,{className:"w-6 h-6 text-blue-600 mr-2"}),"今日の統計"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(O,{className:"w-5 h-5 text-blue-600"}),e.jsx("h4",{className:"font-medium text-blue-900",children:"今日の予約"})]}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:"5件"}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"前日比 +2件"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Y,{className:"w-5 h-5 text-green-600"}),e.jsx("h4",{className:"font-medium text-green-900",children:"今日の収益"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"¥4,000"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"前日比 +¥1,600"})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(H,{className:"w-5 h-5 text-purple-600"}),e.jsx("h4",{className:"font-medium text-purple-900",children:"利用者数"})]}),e.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:[d.current_occupancy,"人"]}),e.jsxs("p",{className:"text-xs text-purple-700 mt-1",children:["最大: ",d.max_capacity,"人"]})]})]})]}),e.jsxs(j,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[e.jsx(U,{className:"w-6 h-6 text-blue-600 mr-2"}),"メンテナンス管理"]}),e.jsxs(c,{onClick:()=>ie(!0),className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"メンテナンス予定を追加"]})]}),B.length>0?e.jsx("div",{className:"space-y-4",children:B.map(a=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:a.title}),e.jsxs("div",{className:"flex items-center space-x-2",children:[a.is_emergency&&e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"緊急"]}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("scheduled"===a.status?"bg-blue-100 text-blue-800":"active"===a.status?"bg-green-100 text-green-800":"completed"===a.status?"bg-gray-100 text-gray-800":"bg-red-100 text-red-800"),children:"scheduled"===a.status?"予定":"active"===a.status?"実行中":"completed"===a.status?"完了":"キャンセル"})]})]}),a.description&&e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:a.description}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:"開始:"}),e.jsx("span",{className:"ml-2 text-gray-600",children:te(a.start_date).replace("T"," ")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:"終了:"}),e.jsx("span",{className:"ml-2 text-gray-600",children:te(a.end_date).replace("T"," ")})]})]}),a.notify_users&&e.jsxs("div",{className:"mt-2 flex items-center text-xs text-blue-600",children:[e.jsx(_,{className:"w-3 h-3 mr-1"}),"ユーザー通知有効"]}),e.jsxs("div",{className:"mt-4 flex justify-end space-x-2",children:[e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>{return re(e=a),ce({title:e.title,description:e.description||"",start_date:te(e.start_date),end_date:te(e.end_date),is_emergency:e.is_emergency,notify_users:e.notify_users||!0}),void ie(!0);var e},className:"text-blue-600 border-blue-600 hover:bg-blue-50",disabled:oe,children:[e.jsx(M,{className:"w-4 h-4 mr-1"}),"編集"]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>(async e=>{if(s&&t&&window.confirm("このメンテナンス予定を削除しますか？この操作は取り消せません。"))try{de(!0),p("");const{error:t}=await o.from("maintenance_schedules").delete().eq("id",e).eq("dog_park_id",s);if(t)throw t;b("メンテナンス予定を削除しました。"),setTimeout(()=>b(""),3e3),await Ue()}catch(a){p("メンテナンス予定の削除に失敗しました。"),setTimeout(()=>p(""),5e3)}finally{de(!1)}})(a.id),className:"text-red-600 border-red-600 hover:bg-red-50",disabled:oe,children:[e.jsx(J,{className:"w-4 h-4 mr-1"}),"削除"]})]})]},a.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(U,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"メンテナンス予定がありません"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"施設のメンテナンス予定を追加してください"})]}),e.jsx("div",{className:"mt-6 p-4 bg-yellow-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(q,{className:"w-5 h-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"メンテナンス機能について"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsx("li",{children:"• メンテナンス中は新規予約を受け付けません"}),e.jsx("li",{children:"• 既存の予約がある場合は事前に利用者に連絡してください"}),e.jsx("li",{children:"• 緊急メンテナンスの場合は即座に施設が利用停止になります"}),e.jsx("li",{children:"• ユーザー通知を有効にすると、利用者にメール通知が送信されます"})]})]})]})})]})]}),"stats"===y&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(j,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(A,{className:"w-6 h-6 text-blue-600 mr-2"}),"利用統計"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(O,{className:"w-5 h-5 text-blue-600"}),e.jsx("h4",{className:"font-medium text-blue-900",children:"今月の予約"})]}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:"32件"}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"前月比 +12%"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Y,{className:"w-5 h-5 text-green-600"}),e.jsx("h4",{className:"font-medium text-green-900",children:"今月の収益"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"¥25,600"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"前月比 +8%"})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(H,{className:"w-5 h-5 text-purple-600"}),e.jsx("h4",{className:"font-medium text-purple-900",children:"利用者数"})]}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:"128人"}),e.jsx("p",{className:"text-xs text-purple-700 mt-1",children:"前月比 +15%"})]})]}),e.jsx("div",{className:"h-64 bg-gray-100 rounded-lg flex items-center justify-center",children:e.jsx("p",{className:"text-gray-500",children:"利用統計グラフ（実装予定）"})})]}),e.jsxs(j,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(Y,{className:"w-6 h-6 text-blue-600 mr-2"}),"収益情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"収益配分"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-800 mb-1",children:"オーナー取り分（80%）"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:"¥20,480"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-800 mb-1",children:"プラットフォーム手数料（20%）"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:"¥5,120"})]})]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-green-900 mb-3",children:"収益内訳"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-800 mb-1",children:"通常利用"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:"¥12,800"}),e.jsx("p",{className:"text-xs text-green-700",children:"16件"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-800 mb-1",children:"施設貸し切り"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:"¥8,800"}),e.jsx("p",{className:"text-xs text-green-700",children:"2件"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-800 mb-1",children:"プライベートブース"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:"¥4,000"}),e.jsx("p",{className:"text-xs text-green-700",children:"2件"})]})]})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-purple-900 mb-3",children:"振込情報"}),e.jsx("p",{className:"text-sm text-purple-800 mb-2",children:"振込は毎月15日に前月分を一括で行います。振込手数料は当社負担です。"}),e.jsx(r,{to:"/owner-payment-system",children:e.jsxs(c,{size:"sm",className:"bg-purple-600 hover:bg-purple-700",children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"振込情報を確認"]})})]})]})]})]}),"pins"===y&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(j,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(k,{className:"w-6 h-6 text-blue-600 mr-2"}),"オーナー用PINコード発行"]}),e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(_,{className:"w-5 h-5 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"オーナー特権"}),e.jsx("p",{children:"オーナーは決済不要でPINコードを発行できます。施設の管理やメンテナンスに使用してください。"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"PINコードは5分間有効です"}),e.jsx("li",{children:"入場・退場それぞれでPINコードが必要です"}),e.jsx("li",{children:"スタッフと共有することもできます"}),e.jsx("li",{children:"管理用途なので決済は不要です"})]})]})]})}),e.jsxs("div",{className:"flex justify-center space-x-4 mb-4",children:[e.jsxs("button",{className:"px-6 py-3 rounded-lg flex items-center space-x-2 "+("entry"===z?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),onClick:()=>E("entry"),children:[e.jsx(D,{className:"w-5 h-5"}),e.jsx("span",{children:"入場"})]}),e.jsxs("button",{className:"px-6 py-3 rounded-lg flex items-center space-x-2 "+("exit"===z?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),onClick:()=>E("exit"),children:[e.jsx(D,{className:"w-5 h-5 rotate-180"}),e.jsx("span",{children:"退場"})]})]}),C.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"スマートロックを選択"}),e.jsx("select",{value:T?.id||"",onChange:e=>{const s=C.find(s=>s.id===e.target.value);I(s||null)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:C.map(s=>e.jsx("option",{value:s.id,children:s.lock_name},s.id))})]}),T?e.jsx("div",{className:"mt-6",children:e.jsx(Z,{lockId:T.lock_id,parkName:d.name,purpose:z,onSuccess:e=>{b(`PINコード「${e}」を発行しました。有効期限は5分間です。`),setTimeout(()=>b(""),5e3)},onError:e=>{p(e),setTimeout(()=>p(""),5e3)}})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(k,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"スマートロックが設定されていません"}),e.jsx(c,{onClick:()=>v("settings"),"data-walkthrough":"setup-smartlock-button",children:"スマートロックを設定する"})]})]}),e.jsx(j,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(k,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"PINコードについて"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-2",children:[e.jsx("p",{children:"• 利用者はPINコードを使用して入退場します"}),e.jsx("p",{children:"• PINコードは5分間有効で、利用者が支払い後に発行されます"}),e.jsx("p",{children:"• オーナーは決済不要でPINコードを発行できます"}),e.jsx("p",{children:"• 施設貸し切りの場合、利用者は友達にPINコードを共有できます"})]})]})]})})]}),"settings"===y&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(j,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(U,{className:"w-5 h-5 text-blue-600 mr-2"}),"基本設定"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"施設の基本情報や設備情報を編集できます。住所と料金は変更できません。"}),e.jsx(r,{to:`/parks/${d.id}/edit`,children:e.jsxs(c,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"基本情報を編集"]})})]}),e.jsxs(j,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(W,{className:"w-5 h-5 text-blue-600 mr-2"}),"施設画像管理"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"各設備の画像を管理できます。画像はすべて1:1でトリミングされ、最適化されます。"}),u&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700",children:u}),g&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700",children:g}),e.jsx("div",{className:"space-y-6",children:ke.map(s=>{const t=ee[s.image_type],a=t?.icon||P;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(a,{className:"w-5 h-5 text-blue-600"}),e.jsx("h4",{className:"font-medium text-gray-900",children:t?.label||s.image_type})]}),!0===s.is_approved&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full",children:"承認済み"}),!1===s.is_approved&&e.jsx("span",{className:"px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full",children:"却下"})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:t?.description||"画像をアップロードしてください"}),s.image_url?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"aspect-square w-48 bg-gray-100 rounded-lg overflow-hidden cursor-pointer",onClick:()=>Be(s.image_url||null),children:e.jsx("img",{src:s.image_url,alt:t?.label||s.image_type,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://via.placeholder.com/400x400?text=Image+Not+Available"}})}),e.jsxs("div",{className:"absolute top-2 right-2 flex space-x-2",children:[e.jsx("button",{onClick:()=>Be(s.image_url||null),className:"p-1 bg-white rounded-full shadow hover:bg-gray-100",children:e.jsx(F,{className:"w-4 h-4 text-blue-600"})}),e.jsx("button",{onClick:()=>(async e=>{if(e)try{ze(!0),p("");const{error:s}=await o.from("dog_park_facility_images").delete().eq("id",e);if(s)throw s;await Ke(),b("画像を削除しました"),setTimeout(()=>b(""),3e3)}catch(s){p("画像の削除に失敗しました"),setTimeout(()=>p(""),3e3)}finally{ze(!1)}})(s.id,s.image_type),className:"p-1 bg-white rounded-full shadow hover:bg-gray-100",disabled:Re,children:e.jsx(J,{className:"w-4 h-4 text-red-600"})})]})]}),!1===s.is_approved&&s.admin_notes&&e.jsxs("div",{className:"p-3 bg-red-50 rounded-lg text-sm text-red-800",children:[e.jsx("p",{className:"font-medium",children:"却下理由:"}),e.jsx("p",{children:s.admin_notes})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"file",id:`replace-image-${s.image_type}`,accept:"image/*",className:"hidden",onChange:e=>{const t=e.target.files?.[0];t&&Qe(s.image_type,t)}}),e.jsxs("label",{htmlFor:`replace-image-${s.image_type}`,className:"cursor-pointer inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"画像を入れ替える"]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors",children:[e.jsx("input",{type:"file",id:`upload-image-${s.image_type}`,accept:"image/*",className:"hidden",onChange:e=>{const t=e.target.files?.[0];t&&Qe(s.image_type,t)}}),e.jsxs("label",{htmlFor:`upload-image-${s.image_type}`,className:"cursor-pointer flex flex-col items-center",children:[e.jsx(K,{className:"w-8 h-8 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"})]})]}),s.file&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 p-3 rounded",children:[e.jsx("span",{className:"text-sm truncate",children:s.file.name}),e.jsx(c,{size:"sm",onClick:()=>handleImageUpload(s.image_type),disabled:Re,children:Re?"アップロード中...":"アップロード"})]})]})]},s.image_type)})})]}),e.jsxs(j,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(Y,{className:"w-5 h-5 text-blue-600 mr-2"}),"料金設定"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"料金体系は全国統一です。変更はできません。"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium",children:"• 通常利用:"}),e.jsx("span",{children:"¥800/日 (固定)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium",children:"• 施設貸し切り:"}),e.jsx("span",{children:"¥4,400/時間 (固定)"})]})]})]})]}),e.jsx(j,{className:"p-6 bg-gray-50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(R,{className:"w-6 h-6 text-gray-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:"運営サポート"}),e.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[e.jsx("p",{children:"• 設定に関するご質問は運営事務局までお問い合わせください"}),e.jsx("p",{children:"• スマートロックシステムの設置・設定サポートを提供しています"}),e.jsx("p",{children:"• 運営開始後も継続的なサポートを行います"}),e.jsx("p",{children:"• 📧 サポート窓口: info@dogparkjp.com"})]})]})]})})]}),"location"===y&&e.jsx("div",{className:"space-y-6",children:e.jsxs(j,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-6 flex items-center",children:[e.jsx($,{className:"w-6 h-6 text-blue-600 mr-2"}),"ドッグランの位置調整"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("p",{className:"text-blue-800 text-sm",children:[e.jsx("strong",{children:"位置調整について:"}),e.jsx("br",{}),"📍 ",e.jsx("strong",{children:"住所で検索"}),": 住所を入力して検索ボタンを押すと、自動的にマップ上の位置が調整されます。",e.jsx("br",{}),"🔴 ",e.jsx("strong",{children:"手動調整"}),": 赤いマーカーを直接ドラッグして、より正確な位置に調整することも可能です。",e.jsx("br",{}),"💾 マーカーを調整した後、「位置を保存」ボタンで座標を保存してください。"]})}),d&&e.jsx("div",{"data-walkthrough":"location-map",children:e.jsx(N,{initialAddress:ve.address,initialLatitude:ve.latitude||void 0,initialLongitude:ve.longitude||void 0,onLocationChange:(e,s,t)=>{_e(t=>({...t,latitude:e,longitude:s}))}})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{type:"button","data-walkthrough":"save-location-button",onClick:async()=>{if(d&&ve.latitude&&ve.longitude)try{ue(!0),p("");const{error:e}=await o.from("dog_parks").update({latitude:ve.latitude,longitude:ve.longitude,updated_at:(new Date).toISOString()}).eq("id",d.id);if(e)throw e;b("位置情報を更新しました。"),await Ge(),setTimeout(()=>{b("")},3e3)}catch(e){const s=e instanceof Error?e.message:"object"==typeof e&&null!==e&&"message"in e?String(e.message):"不明なエラーが発生しました";p(`位置情報の更新に失敗しました: ${s}`)}finally{ue(!1)}},disabled:he||!ve.latitude||!ve.longitude,className:"min-w-[120px]",children:he?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"保存中..."]}):"位置を保存"})})]})]})})]}),Se&&Me?.file&&e.jsx(f,{imageFile:Me.file,onCropComplete:async e=>{if(s&&$e)try{ze(!0),Te(!1),p("");const t=new File([e],Ae,{type:e.type}),a=`${$e}_${Date.now()}_${Ae}`,i=`${s}/${a}`,{error:l}=await o.storage.from("dog-park-images").upload(i,t,{upsert:!0});if(l)throw l;const{data:{publicUrl:r}}=o.storage.from("dog-park-images").getPublicUrl(i),{data:n,error:c}=await o.from("dog_park_facility_images").select("id").eq("park_id",s).eq("image_type",$e).single();if(c&&"PGRST116"!==c.code)throw c;let d;if(n){const{error:e}=await o.from("dog_park_facility_images").update({image_url:r,is_approved:null,updated_at:(new Date).toISOString()}).eq("id",n.id);d=e}else{const{error:e}=await o.from("dog_park_facility_images").insert({park_id:s,image_type:$e,image_url:r,is_approved:null});d=e}if(d)throw d;await Ke(),b("画像をアップロードしました"),setTimeout(()=>b(""),3e3),De(""),Fe(""),Le(null)}catch(t){p("画像のアップロードに失敗しました"),setTimeout(()=>p(""),3e3)}finally{ze(!1)}},onCancel:()=>{Te(!1),De(""),Fe(""),Le(null)},aspectRatio:1,maxWidth:400,maxHeight:400}),Ee&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"relative max-w-4xl w-full",children:[e.jsx("button",{onClick:()=>Be(null),className:"absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75 z-10",children:e.jsx(w,{className:"w-6 h-6"})}),e.jsx("div",{className:"flex items-center justify-center h-[80vh]",children:e.jsx("img",{src:Ee,alt:"プレビュー",className:"max-h-full max-w-full object-contain"})})]})}),ae&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:le?"メンテナンス予定を編集":"メンテナンス予定を追加"}),e.jsx("button",{onClick:()=>{ie(!1),re(null),ce({title:"",description:"",start_date:"",end_date:"",is_emergency:!1,notify_users:!0})},className:"text-gray-500 hover:text-gray-700 p-1 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(w,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:le?async e=>{if(e.preventDefault(),s&&t&&le)try{de(!0),p("");const e=new Date(ne.start_date);if(new Date(ne.end_date)<=e)return void p("終了日時は開始日時より後に設定してください。");const t=se(ne.start_date),a=se(ne.end_date);if(!t||!a)return void p("日時の形式が正しくありません。");const{error:i}=await o.from("maintenance_schedules").update({title:ne.title,description:ne.description||null,start_date:t,end_date:a,is_emergency:ne.is_emergency,notify_users:ne.notify_users}).eq("id",le.id).eq("dog_park_id",s);if(i)throw i;ce({title:"",description:"",start_date:"",end_date:"",is_emergency:!1,notify_users:!0}),ie(!1),re(null),b("メンテナンス予定を更新しました。"),setTimeout(()=>b(""),3e3),await Ue()}catch(a){p("メンテナンス予定の更新に失敗しました。"),setTimeout(()=>p(""),5e3)}finally{de(!1)}}:async e=>{if(e.preventDefault(),s&&t)try{de(!0),p("");const e=new Date(ne.start_date);if(new Date(ne.end_date)<=e)return void p("終了日時は開始日時より後に設定してください。");const t=se(ne.start_date),a=se(ne.end_date);if(!t||!a)return void p("日時の形式が正しくありません。");const{error:i}=await o.from("maintenance_schedules").insert({dog_park_id:s,title:ne.title,description:ne.description||null,start_date:t,end_date:a,status:"scheduled",is_emergency:ne.is_emergency,notify_users:ne.notify_users});if(i)throw i;ce({title:"",description:"",start_date:"",end_date:"",is_emergency:!1,notify_users:!0}),ie(!1),b("メンテナンス予定を追加しました。"),setTimeout(()=>b(""),3e3),await Ue()}catch(a){p("メンテナンス予定の追加に失敗しました。"),setTimeout(()=>p(""),5e3)}finally{de(!1)}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["メンテナンス名 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:ne.title,onChange:e=>ce(s=>({...s,title:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"例: 設備点検、清掃作業",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"詳細説明"}),e.jsx("textarea",{value:ne.description,onChange:e=>ce(s=>({...s,description:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"メンテナンス内容の詳細を入力してください"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["開始日時 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"datetime-local",value:ne.start_date,onChange:e=>ce(s=>({...s,start_date:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["終了日時 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"datetime-local",value:ne.end_date,onChange:e=>ce(s=>({...s,end_date:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"is_emergency",checked:ne.is_emergency,onChange:e=>ce(s=>({...s,is_emergency:e.target.checked})),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"is_emergency",className:"ml-2 block text-sm text-gray-700",children:"緊急メンテナンス（即座に施設利用を停止）"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"notify_users",checked:ne.notify_users,onChange:e=>ce(s=>({...s,notify_users:e.target.checked})),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"notify_users",className:"ml-2 block text-sm text-gray-700",children:"利用者にメール通知を送信"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(c,{type:"button",variant:"secondary",onClick:()=>ie(!1),children:"キャンセル"}),e.jsx(c,{type:"submit",disabled:oe,className:"bg-blue-600 hover:bg-blue-700",children:oe?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),le?"更新中...":"追加中..."]}):le?"メンテナンス予定を更新":"メンテナンス予定を追加"})]})]})]})})}),Ye&&e.jsx(Q,{onComplete:Je,onClose:()=>He(!1),onStepChange:We})]}):e.jsxs("div",{className:"max-w-4xl mx-auto text-center py-12",children:[e.jsx(q,{className:"w-16 h-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"ドッグランが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"指定されたドッグランが見つからないか、アクセス権限がありません。"}),e.jsx(r,{to:"/owner-dashboard",children:e.jsx(c,{children:"ダッシュボードに戻る"})})]})}export{ae as ParkManagement};
