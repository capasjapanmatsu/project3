import{j as e}from"./data-vendor-BmFUkYzE.js";import{d as s,r as t,L as a}from"./core-vendor-DBEP70vW.js";import{u as r,s as n,C as c,B as i}from"./index-CDzr2Gkx.js";import{I as l}from"./Input-CcyqxK15.js";import{O as d,U as x,az as o,t as m,n as h,a2 as u,D as p,b as j,w as g,aT as f,v,aU as N}from"./ui-vendor-B3gor5_P.js";import"./heavy-vendor-Bb5jGJvT.js";function y(){const{isAdmin:y}=r(),w=s(),[_,b]=t.useState([]),[S,k]=t.useState([]),[D,C]=t.useState(!0),[L,U]=t.useState(""),[$,E]=t.useState(""),[I,O]=t.useState("all"),[P,q]=t.useState("created_at"),[z,J]=t.useState("desc");t.useEffect(()=>{y?B():w("/")},[y,w]),t.useEffect(()=>{F()},[_,$,I,P,z]);const B=async()=>{try{C(!0),U("");const{data:e,error:s}=await n.from("profiles").select("\n          id,\n          name,\n          user_type,\n          postal_code,\n          address,\n          phone_number,\n          created_at\n        ");if(s)throw new Error("プロファイル情報の取得に失敗しました");if(!e||0===e.length)return void b([]);const t=e.map(async e=>{try{const{count:s}=await n.from("dogs").select("id",{count:"exact"}).eq("owner_id",e.id),t=new Date;t.setDate(1),t.setHours(0,0,0,0);const{count:a}=await n.from("reservations").select("id",{count:"exact"}).eq("user_id",e.id).gte("created_at",t.toISOString()),{data:r}=await n.from("reservations").select("total_amount").eq("user_id",e.id).not("total_amount","is",null),c=(r||[]).reduce((e,s)=>e+(s.total_amount||0),0),i=`user_${e.id.slice(0,8)}@unknown.com`;return{id:e.id,name:e.name||"Unknown",email:i,phone:e.phone_number||"",created_at:e.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:s||0,reservation_count:a||0,total_spent:c}}catch(s){return{id:e.id,name:e.name||"Unknown",email:`user_${e.id.slice(0,8)}@unknown.com`,phone:e.phone_number||"",created_at:e.created_at,last_sign_in_at:"",is_active:!0,subscription_status:"inactive",dog_count:0,reservation_count:0,total_spent:0}}}),a=await Promise.all(t);b(a)}catch(e){U(e instanceof Error?e.message:"ユーザー情報の取得に失敗しました")}finally{C(!1)}},F=()=>{let e=[..._];$&&(e=e.filter(e=>e.name.toLowerCase().includes($.toLowerCase())||e.email.toLowerCase().includes($.toLowerCase()))),"all"!==I&&(e=e.filter(e=>{switch(I){case"active":return e.is_active;case"inactive":return!e.is_active;case"subscribers":return"active"===e.subscription_status;default:return!0}})),e.sort((e,s)=>{const t=e[P]||"",a=s[P]||"";return"asc"===z?t>a?1:-1:t<a?1:-1}),k(e)},M=s=>"active"===s.subscription_status?e.jsxs("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(m,{className:"w-3 h-3 mr-1"}),"サブスク"]}):s.is_active?e.jsxs("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(o,{className:"w-3 h-3 mr-1"}),"アクティブ"]}):e.jsxs("span",{className:"bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium flex items-center",children:[e.jsx(N,{className:"w-3 h-3 mr-1"}),"非アクティブ"]});return D?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(a,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(x,{className:"w-8 h-8 text-blue-600 mr-3"}),"ユーザー管理"]}),e.jsx("p",{className:"text-gray-600",children:"登録ユーザーの詳細情報と管理"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["総ユーザー数: ",_.length,"人"]})]}),L&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:L}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"総ユーザー数"}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:_.length})]}),e.jsx(x,{className:"w-6 h-6 text-blue-600"})]})}),e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"アクティブユーザー"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:_.filter(e=>e.is_active).length})]}),e.jsx(o,{className:"w-6 h-6 text-green-600"})]})}),e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"サブスク会員"}),e.jsx("p",{className:"text-xl font-bold text-purple-600",children:_.filter(e=>"active"===e.subscription_status).length})]}),e.jsx(m,{className:"w-6 h-6 text-purple-600"})]})}),e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"今月新規登録"}),e.jsx("p",{className:"text-xl font-bold text-orange-600",children:_.filter(e=>{const s=new Date(e.created_at),t=new Date;return s.getMonth()===t.getMonth()&&s.getFullYear()===t.getFullYear()}).length})]}),e.jsx(h,{className:"w-6 h-6 text-orange-600"})]})})]}),e.jsxs(c,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(l,{label:"検索",placeholder:"名前またはメールアドレスで検索...",value:$,onChange:e=>E(e.target.value),icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),e.jsxs("select",{value:I,onChange:e=>O(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"active",children:"アクティブ"}),e.jsx("option",{value:"inactive",children:"非アクティブ"}),e.jsx("option",{value:"subscribers",children:"サブスク会員"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),e.jsxs("select",{value:`${P}-${z}`,onChange:e=>{const[s,t]=e.target.value.split("-");q(s),J(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),e.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),e.jsx("option",{value:"name-asc",children:"名前（昇順）"}),e.jsx("option",{value:"name-desc",children:"名前（降順）"}),e.jsx("option",{value:"total_spent-desc",children:"支払額（高い順）"}),e.jsx("option",{value:"total_spent-asc",children:"支払額（低い順）"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[S.length,"件のユーザーが見つかりました"]}),e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>{const e=[["名前","メールアドレス","電話番号","登録日","犬数","予約数","支払額","サブスクリプション"].join(","),...S.map(e=>[e.name,e.email,e.phone||"",new Date(e.created_at).toLocaleDateString("ja-JP"),e.dog_count,e.reservation_count,e.total_spent,e.subscription_status].join(","))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`users-${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[e.jsx(p,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),e.jsx(c,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"連絡先"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"最終ログイン"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"統計"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",s.id.slice(0,8),"..."]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm text-gray-900",children:[e.jsx(j,{className:"w-4 h-4 mr-2 text-gray-400"}),s.email]}),s.phone&&e.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[e.jsx(g,{className:"w-4 h-4 mr-2 text-gray-400"}),s.phone]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(s.created_at).toLocaleDateString("ja-JP")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.last_sign_in_at?new Date(s.last_sign_in_at).toLocaleDateString("ja-JP"):"未ログイン"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:M(s)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex items-center text-gray-900",children:[e.jsx(f,{className:"w-4 h-4 mr-1 text-gray-400"}),"犬: ",s.dog_count,"匹"]}),e.jsxs("div",{className:"text-gray-500",children:["予約: ",s.reservation_count,"件"]}),e.jsxs("div",{className:"text-gray-500",children:["支払: ¥",s.total_spent.toLocaleString()]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx(i,{size:"sm",variant:"secondary",onClick:()=>w(`/admin/users/${s.id}`),children:e.jsx(v,{className:"w-4 h-4"})})})})]},s.id))})]})})})]})}export{y as AdminUserManagement};
