import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{c as s,L as a}from"./router-Cg6wfOY4.js";import{u as r,s as i,S as n,C as d}from"./index-CVZFmpsT.js";import{q as l,b as c,r as m,C as o,p as f}from"./ui-basic-CaMd9YQ-.js";import"./heavy-features-BIdEME4r.js";import"./supabase-B0bqaRGb.js";function u(){const{isAdmin:u,user:g}=r(),[p,h]=s(),[_,j]=t.useState([]),[y,b]=t.useState(null),[v,N]=t.useState([]),[w,C]=t.useState(null),[k,S]=t.useState(""),[$,q]=t.useState(!1),E="admin-inquiry-file",I="admin-inquiry-camera";t.useEffect(()=>{u&&g?.id&&(async()=>{const{data:e}=await i.from("profiles").select("id, name").eq("id",g.id).maybeSingle();if(!e)return;C(e);const{data:t}=await i.from("latest_messages").select("id, sender_id, receiver_id, content, created_at").or(`sender_id.eq.${g.id},receiver_id.eq.${g.id}`).order("created_at",{ascending:!1}),s=Array.from(new Set((t||[]).map(e=>e.sender_id===g.id?e.receiver_id:e.sender_id))),{data:a}=await i.from("profiles").select("id, name").in("id",s),r=new Map((a||[]).map(e=>[e.id,e]));j((t||[]).map(e=>({...e,partner:r.get(e.sender_id===g.id?e.receiver_id:e.sender_id)})).filter(e=>!!e.partner));const n=p.get("partner");n&&b(n)})()},[u,g?.id]),t.useEffect(()=>{(async()=>{if(!w||!y)return void N([]);const{data:e}=await i.from("messages").select("id, sender_id, receiver_id, content, created_at").in("sender_id",[w.id,y]).in("receiver_id",[w.id,y]).order("created_at",{ascending:!0});N(e||[])})()},[w,y]);const A=t.useMemo(()=>_.find(e=>(e.sender_id===w?.id?e.receiver_id:e.sender_id)===y)?.partner?.name||"",[_,w,y]),U=async e=>{if(e&&w&&y)try{q(!0);const{data:s,error:a}=await i.from("messages").insert({sender_id:w.id,receiver_id:y,content:k||"(添付あり)"}).select("id").single();if(a||!s)throw a;const r=[];for(const d of Array.from(e))try{const e=d.name.split(".").pop()?.toLowerCase()||"bin",t=`${s.id}/${Date.now()}_${encodeURIComponent(d.name)}`,{error:a}=await i.storage.from("message-attachments").upload(t,d,{upsert:!0,contentType:d.type,cacheControl:"3600"});if(a)throw a;const{data:r}=i.storage.from("message-attachments").getPublicUrl(t),n=d.type.startsWith("image/")?"image":"pdf"===e?"pdf":"other",{error:l}=await i.from("message_attachments").insert({message_id:s.id,file_url:r.publicUrl,file_type:n,file_name:d.name});if(l)throw l}catch(t){r.push(`${d.name}: ${t?.message||t}`)}const{data:n}=await i.from("messages").select("id, sender_id, receiver_id, content, created_at").in("sender_id",[w.id,y]).in("receiver_id",[w.id,y]).order("created_at",{ascending:!0});N(n||[]),S(""),r.length>0&&alert("一部の添付に失敗しました:\n"+r.join("\n"))}catch(s){alert("添付のアップロードに失敗しました: "+(s?.message||s))}finally{q(!1)}};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(n,{title:"お問い合わせ管理"}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(d,{className:"p-4 lg:col-span-1",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center",children:[e.jsx(l,{className:"w-5 h-5 mr-2"}),"スレッド"]}),e.jsxs("div",{className:"divide-y",children:[_.map(t=>{const s=t.sender_id===w?.id?t.receiver_id:t.sender_id;return e.jsx("button",{onClick:()=>{b(s),h({partner:s})},className:"w-full text-left py-3 px-2 hover:bg-gray-50 "+(y===s?"bg-blue-50":""),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-9 w-9 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(c,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.partner?.name||"ユーザー"}),e.jsx("div",{className:"text-xs text-gray-500 line-clamp-1",children:t.content})]})]})},t.id)}),0===_.length&&e.jsx("div",{className:"text-sm text-gray-500 py-6 text-center",children:"スレッドがありません"})]})]}),e.jsx(d,{className:"p-4 lg:col-span-2",children:y?e.jsxs("div",{className:"flex flex-col h-[70vh]",children:[e.jsxs("div",{className:"border-b pb-2 mb-2 flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:A||"ユーザー"}),e.jsx(a,{to:`/admin/users/${y}`,className:"text-blue-600 hover:text-blue-800 text-sm",children:"ユーザー詳細へ"})]}),e.jsx("div",{className:"flex-1 overflow-auto space-y-3",children:v.map(t=>e.jsx(x,{message:t,myId:w.id},t.id))}),e.jsxs("div",{className:"pt-3 mt-2 border-t flex items-center gap-2",children:[e.jsx("input",{value:k,onChange:e=>S(e.target.value),className:"flex-1 border rounded px-3 py-2",placeholder:"メッセージを入力"}),e.jsx("input",{id:E,type:"file",accept:"image/*,application/pdf",multiple:!0,className:"hidden",onChange:e=>U(e.target.files)}),e.jsx("button",{type:"button",onClick:()=>document.getElementById(E)?.click(),className:"w-10 h-10 flex items-center justify-center rounded-full border bg-white hover:bg-gray-50",title:"ファイル添付",children:e.jsx(m,{className:"w-5 h-5 text-gray-700"})}),e.jsx("input",{id:I,type:"file",accept:"image/*",capture:"environment",className:"hidden",onChange:e=>U(e.target.files)}),e.jsx("button",{type:"button",onClick:()=>document.getElementById(I)?.click(),className:"w-10 h-10 flex items-center justify-center rounded-full border bg-white hover:bg-gray-50",title:"カメラ",children:e.jsx(o,{className:"w-5 h-5 text-gray-700"})}),e.jsx("button",{type:"button",onClick:async()=>{if(!w||!y||!k.trim())return;const{error:e}=await i.from("messages").insert({sender_id:w.id,receiver_id:y,content:k.trim()});if(!e){S("");const{data:e}=await i.from("messages").select("id, sender_id, receiver_id, content, created_at").in("sender_id",[w.id,y]).in("receiver_id",[w.id,y]).order("created_at",{ascending:!0});N(e||[])}},className:"w-10 h-10 flex items-center justify-center rounded-full bg-blue-600 hover:bg-blue-700 text-white",title:"送信",children:e.jsx(f,{className:"w-5 h-5"})})]}),$&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"アップロード中..."})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"左のスレッドを選択してください"})})]})]})}function x({message:s,myId:a}){const[r,n]=t.useState([]);t.useEffect(()=>{(async()=>{const{data:e}=await i.from("message_attachments").select("file_url, file_type, file_name").eq("message_id",s.id);n(e||[])})()},[s.id]);const d=s.sender_id===a;return e.jsx("div",{className:"flex "+(d?"justify-end":"justify-start"),children:e.jsxs("div",{className:"max-w-[80%] space-y-2 ",children:[e.jsx("div",{className:"px-3 py-2 rounded-lg text-sm "+(d?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:s.content}),r.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-2",children:r.map((t,s)=>"image"===t.file_type?e.jsx("a",{href:t.file_url,target:"_blank",rel:"noreferrer",className:"block",children:e.jsx("img",{src:t.file_url,alt:t.file_name,className:"rounded border object-cover h-32 w-full"})},s):e.jsx("a",{href:t.file_url,target:"_blank",rel:"noreferrer",className:"block text-xs text-blue-700 underline",children:t.file_name||"添付ファイル"},s))})]})})}export{u as default};
