const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/authDebug-2T0JkNCh.js","assets/js/index-tUba1KNC.js","assets/js/data-vendor-CWrxVXZy.js","assets/js/core-vendor-0N04cbcW.js","assets/js/ui-vendor-DBGK8b52.js","assets/css/index-D_UMrpDm.css","assets/js/directVaccineUpload-BBqdIh5H.js"])))=>i.map(i=>d[i]);
import{j as e,_ as r}from"./data-vendor-CWrxVXZy.js";import{r as t,L as i}from"./core-vendor-0N04cbcW.js";import{B as a}from"./Button-D_zbqes6.js";import{C as o}from"./Card-BskSggiq.js";import{D as s,a as n}from"./DogCard-fAEtu16c.js";import{u as c,s as d,l}from"./index-tUba1KNC.js";import{Y as m,f as u,P as g}from"./ui-vendor-DBGK8b52.js";import"./heavy-vendor-CAfWpiSr.js";import"./dogBreeds-6lxY8Uni.js";import"./Input-CerDW6T2.js";import"./Select-B_HRObGj.js";import"./VaccineBadge-D-4srpoy.js";async function f(e){try{const r=await e();return{data:r.data,error:r.error}}catch(r){return{data:null,error:r}}}function p(){const{user:p}=c(),[h,b]=t.useState([]),[y,x]=t.useState(!0),[_,j]=t.useState(""),[v,w]=t.useState(!1),[D,E]=t.useState(null),[S,N]=t.useState(!1),[U,$]=t.useState(""),[C,I]=t.useState(""),[R,P]=t.useState(!1),[V,z]=t.useState({name:"",breed:"",gender:"",birthDate:"",microchipNumber:""}),[A,F]=t.useState(null),[T,L]=t.useState(null),[B,O]=t.useState(null),[M,k]=t.useState(null),[q,W]=t.useState(""),[Y,J]=t.useState(""),K=t.useCallback(async()=>{try{x(!0),j("");const e=await f(()=>d.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",p?.id).order("created_at",{ascending:!1}));if(e.error)return l("error","Error fetching dogs",{error:e.error,userId:p?.id}),void j("ワンちゃんの情報を取得できませんでした。");b(e.data||[])}catch(e){l("error","Exception in fetchDogs",{error:e,userId:p?.id}),j("ワンちゃんの情報を取得できませんでした。")}finally{x(!1)}},[p?.id]);t.useEffect(()=>{p&&K()},[p,K]);const Z=e=>{E(e),z({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date,microchipNumber:e.microchip_number||""}),L(e.image_url||null);const r=e.vaccine_certifications?.[0];r&&(W(r.rabies_expiry_date||""),J(r.combo_expiry_date||"")),w(!0)};return y?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs(i,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),e.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),e.jsx(i,{to:"/register-dog",children:e.jsxs(a,{children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),_&&e.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:_}),C&&e.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:C}),e.jsxs(o,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[e.jsx(g,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",h.length,"匹)"]})}),0===h.length?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(g,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),e.jsx(i,{to:"/register-dog",children:e.jsxs(a,{children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):e.jsx("div",{className:"space-y-4",children:h.map(r=>e.jsx(s,{dog:r,onEdit:Z},r.id))})]}),v&&D&&e.jsx(n,{dog:D,isUpdating:S||R,error:U,success:C,dogFormData:V,dogImagePreview:T,onClose:()=>w(!1),onSubmit:e=>{(async e=>{if(e.preventDefault(),D){N(!0),$(""),I("");try{const e={name:V.name,breed:V.breed,gender:V.gender,birth_date:V.birthDate,...V.microchipNumber&&{microchip_number:V.microchipNumber}};if(A){if(l("info","Uploading dog image",{name:A.name,type:A.type,size:A.size,lastModified:A.lastModified,isFileObject:A instanceof File}),!A.type||!A.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${A.type}`);const r=`${D.id}/dog-photo.jpg`;l("info","File path",{fileName:r}),l("info","Using direct fetch API to bypass SDK");const t=`https://onmcivwxtzqajcovptgf.supabase.co/storage/v1/object/dog-images/${r}`,{data:{session:i}}=await d.auth.getSession();if(!i?.access_token)throw new Error("認証されていません。ログインしてください。");l("info","Direct upload URL",{uploadUrl:t}),l("info","Using user access token for authentication"),l("info","Using PUT method for Supabase Storage API"),l("info","Upload options",{method:"PUT",contentType:A.type,authorization:"Bearer [token]",cacheControl:"3600"});const a=await fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":A.type,"Cache-Control":"3600"},body:A});if(l("info","Response status",{status:a.status}),l("info","Response headers",{headers:Object.fromEntries(a.headers.entries())}),!a.ok){const e=await a.text();throw l("error","Direct upload failed",{error:e}),new Error(`直接アップロードに失敗しました: ${a.status} ${e}`)}const o=await a.json();l("info","Direct upload success",{responseData:o});const{data:{publicUrl:s}}=d.storage.from("dog-images").getPublicUrl(r);e.image_url=s}const{error:t}=await d.from("dogs").update(e).eq("id",D.id);if(t)throw t;if(B&&M&&q&&Y){const e=B.name.split(".").pop()||"jpg",t=M.name.split(".").pop()||"jpg",i=Date.now(),a=`temp/${D.id}/rabies_${i}.${e}`,o=`temp/${D.id}/combo_${i}.${t}`;l("info","Uploading vaccine certificates with direct method");const{debugAuthStatus:s}=await r(async()=>{const{debugAuthStatus:e}=await import("./authDebug-2T0JkNCh.js");return{debugAuthStatus:e}},__vite__mapDeps([0,1,2,3,4,5]));await s();const{directVaccineUpload:n}=await r(async()=>{const{directVaccineUpload:e}=await import("./directVaccineUpload-BBqdIh5H.js");return{directVaccineUpload:e}},__vite__mapDeps([6,1,2,3,4,5]));l("info","Direct upload function imported successfully");const[c,m]=await Promise.all([n(a,B),n(o,M)]);if(l("info","Upload results",{rabiesUpload:c,comboUpload:m}),!c.success||!m.success){l("error","VACCINE UPLOAD ERROR DETAILS"),c.success||l("error","Rabies upload error",{error:c.error}),m.success||l("error","Combo upload error",{error:m.error});const e=c.error||m.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${e}`)}l("info","Vaccine certificates uploaded successfully"),l("info","Rabies upload result",{url:c.url}),l("info","Combo upload result",{url:m.url});const u=c.url,g=m.url;l("info","Public URLs obtained",{rabiesPublicUrl:u,comboPublicUrl:g}),l("info","Saving vaccine certificates to database");const p=await f(()=>d.from("vaccine_certifications").upsert([{dog_id:D.id,rabies_vaccine_image:u,combo_vaccine_image:g,rabies_expiry_date:q,combo_expiry_date:Y,status:"pending"}],{onConflict:"dog_id"}));if(p.error){l("error","Database save error",{error:p.error});const e=p.error instanceof Error?p.error.message:JSON.stringify(p.error);throw e.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${e}`)}l("info","Vaccine certificates saved to database successfully")}I("ワンちゃん情報を更新しました"),await K(),setTimeout(()=>{w(!1),I(""),F(null),L(null),O(null),k(null),W(""),J("")},2e3)}catch(t){l("error","Error updating dog",{error:t,dogId:D?.id});let e="ワンちゃん情報の更新に失敗しました";t instanceof Error&&(e=t.message.includes("520")||t.message.includes("Cloudflare")?"ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":t.message.includes("アップロードに失敗しました")?t.message:`エラーが発生しました: ${t.message}`),$(e)}finally{N(!1)}}})(e)},onDelete:e=>{(async e=>{P(!0),$("");try{l("info","Deleting dog:",{name:e.name,id:e.id});const{error:t}=await d.from("vaccine_certifications").delete().eq("dog_id",e.id);if(t&&l("warn","Error deleting vaccine certifications",{error:t,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],i=`${e.id}/${t}`,{error:a}=await d.storage.from("dog-images").remove([i])}catch(r){}const i=e.vaccine_certifications?.[0];if(i){const e=[];if(i.rabies_vaccine_image&&e.push(i.rabies_vaccine_image),i.combo_vaccine_image&&e.push(i.combo_vaccine_image),e.length>0){const{error:r}=await d.storage.from("vaccine-certs").remove(e)}}const{error:a}=await d.from("dogs").delete().eq("id",e.id);if(a)throw l("error","Error deleting dog",{error:a,dogId:e.id}),a;l("info","Dog deleted successfully",{dogName:e.name}),await K(),w(!1),I(`${e.name}の情報を削除しました。`),setTimeout(()=>{I("")},3e3)}catch(t){l("error","Error deleting dog",{error:t,dogId:e?.id});const r=t.message||"ワンちゃんの削除に失敗しました";$(r)}finally{P(!1)}})(e)},onFormChange:z,onImageSelect:e=>{const r=e.target.files?.[0];if(l("info","🔍 File selected:",r?{name:r.name,type:r.type,size:r.size,lastModified:r.lastModified,isFileObject:r instanceof File}:{message:"No file selected"}),r)try{if(!(r instanceof File))return void $("有効なファイルを選択してください。");if(r.size>10485760)return void $("画像ファイルは10MB以下にしてください。");if(!r.type||!r.type.startsWith("image/"))return void $(`画像ファイルを選択してください。選択されたファイルタイプ: ${r.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type))return void $(`サポートされていない画像形式です: ${r.type}`);F(r),l("info","✅ Dog image file set successfully:",{name:r.name,type:r.type,size:r.size});const e=new FileReader;e.onload=e=>{L(e.target?.result)},e.readAsDataURL(r)}catch(t){$("画像の処理に失敗しました。")}},onImageRemove:()=>{(async()=>{if(D&&D.image_url)try{N(!0),$("");try{const e=new URL(D.image_url).pathname.split("/"),r=e[e.length-1],t=`${D.id}/${r}`,{error:i}=await d.storage.from("dog-images").remove([t])}catch(e){l("warn","Warning: Error processing image deletion",{error:e})}const r=await f(()=>d.from("dogs").update({image_url:null}).eq("id",D.id));if(r.error)return l("error","Error updating dog image_url",{error:r.error,dogId:D.id}),void $("画像の削除に失敗しました。");F(null),L(null),E({...D,image_url:""}),await K(),l("info","✅ Dog image removed successfully",{dogId:D.id}),I("画像を削除しました。"),setTimeout(()=>{I("")},3e3)}catch(r){l("error","Error removing dog image",{error:r,dogId:D?.id}),$("画像の削除に失敗しました。")}finally{N(!1)}})()},rabiesVaccineFile:B,comboVaccineFile:M,rabiesExpiryDate:q,comboExpiryDate:Y,onRabiesVaccineSelect:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void $("ワクチン証明書ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void $("画像ファイルを選択してください。");O(r)}else O(null)},onComboVaccineSelect:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void $("ワクチン証明書ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void $("画像ファイルを選択してください。");k(r)}else k(null)},onRabiesExpiryDateChange:W,onComboExpiryDateChange:J})]})}export{p as DogManagement};
