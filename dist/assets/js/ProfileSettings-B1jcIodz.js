import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{a,L as t}from"./router-Cg6wfOY4.js";import{B as r}from"./Button-D7FFKgkK.js";import{u as i,b as n,s as l,C as c}from"./index-qwdJeTcH.js";import{I as d}from"./Input-D7pb8xRh.js";import{l as o,f as m}from"./postalCodeLookup-BVBMVLy5.js";import{af as x,aO as h,i as u,a4 as p,b as j,h as f,a as b,M as g,Q as N,V as w,g as y,ao as v,K as _,O as I,aP as S,aQ as k,aR as C,e as E,ae as T,X as z}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function O(){const{user:O,lineUser:P,isLineAuthenticated:L,effectiveUserId:J}=i(),F=a(),{subscription:A,loading:q,isActive:D}=n(),[U,G]=s.useState(!0),[X,Z]=s.useState(!1),[Q,V]=s.useState(!1),[Y,B]=s.useState(null),[M,R]=s.useState(!1),[W,$]=s.useState(""),[H,K]=s.useState(""),[ee,se]=s.useState({name:"",nickname:"",postal_code:"",address:"",phone_number:"",email:""}),[ae,te]=s.useState({name:"",nickname:"",postal_code:"",address:"",phone_number:"",email:""}),[re,ie]=s.useState(!1),[ne,le]=s.useState(!1),[ce,de]=s.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[oe,me]=s.useState(""),[xe,he]=s.useState(!1),[ue,pe]=s.useState(!1),[je,fe]=s.useState(""),[be,ge]=s.useState(""),[Ne,we]=s.useState(""),[ye,ve]=s.useState(!1),[_e,Ie]=s.useState(""),[Se,ke]=s.useState(!1),[Ce,Ee]=s.useState(!1),[Te,ze]=s.useState("user"),[Oe,Pe]=s.useState(!1),[Le,Je]=s.useState(""),[Fe,Ae]=s.useState(null),[qe,De]=s.useState(!1),[Ue,Ge]=s.useState(""),[Xe,Ze]=s.useState(""),[Qe,Ve]=s.useState([]),[Ye,Be]=s.useState("loading"),[Me,Re]=s.useState(!1),[We,$e]=s.useState(null),[He,Ke]=s.useState(""),[es,ss]=s.useState(!1),[as,ts]=s.useState("");s.useEffect(()=>{O||P||J?(rs(),is()):F("/login")},[O,P,J,F]);const rs=async()=>{try{G(!0);const e=O?.id||P?.app_user_id||P?.id||J;if(!e){const e={name:P?.display_name||"",nickname:"",postal_code:"",address:"",phone_number:"",email:O?.email||""};return se(e),te(e),void G(!1)}const{data:s,error:a}=await l.from("profiles").select("*").or(`id.eq.${e},line_user_id.eq.${P?.line_user_id||"null"}`).single();if(a&&"PGRST116"!==a.code){const e={name:P?.display_name||O?.email?.split("@")[0]||"",nickname:"",postal_code:"",address:"",phone_number:"",email:O?.email||""};se(e),te(e)}else if(s){const e={name:s.name||P?.display_name||"",nickname:s.nickname||"",postal_code:s.postal_code||"",address:s.address||"",phone_number:s.phone_number||"",email:s.email||O?.email||""};se(e),te(e),ke(!!s.notify_opt_in),Ee(!!s.line_user_id),ze(s.user_type||"user")}try{const e=O?.id||J;if(e){const{data:s}=await l.from("user_line_link").select("line_user_id").eq("app_user_id",e).limit(1);B((s?.length??0)>0)}else B(null)}catch{B(null)}try{const e=await fetch("/auth/me",{credentials:"include"});R(e.ok)}catch{R(!1)}}catch(e){$("プロフィールの取得に失敗しました。")}finally{G(!1)}},is=async()=>{try{Be("loading");const{data:e,error:s}=await l.auth.mfa.listFactors();if(s)throw s;const a=e?.factors||[];Ve(a);const t=a.some(e=>"totp"===e.factorType&&"verified"===e.status);Be(t?"enabled":"disabled")}catch(e){Be("disabled")}},ns=async e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:ee.postal_code})(e);if(se({...ee,postal_code:s}),7===s.replace(/-/g,"").length){ve(!0),Ie("");try{const e=await o(s);if(e.success&&e.results&&e.results.length>0&&e.results[0]){const s=m(e.results[0]);se(e=>({...e,address:s}))}else Ie(e.message||"住所が見つかりませんでした")}catch(a){Ie("住所の検索中にエラーが発生しました")}finally{ve(!1)}}},ls=async e=>{e.preventDefault(),Z(!0),$(""),K("");try{if(ee.postal_code&&!ee.postal_code.match(/^\d{3}-\d{4}$/))throw new Error("郵便番号は正しい形式で入力してください（例：123-4567）");if(ee.phone_number&&!ee.phone_number.match(/^0\d{2,3}-\d{1,4}-\d{4}$/))throw new Error("電話番号は正しい形式で入力してください（例：090-1234-5678）");const e=O?.id||P?.app_user_id||P?.id||J;if(!e)throw new Error("ユーザー情報が取得できません");const s=ae.postal_code!==ee.postal_code||ae.address!==ee.address;let a=!1;if(!L&&s&&O?.id){const{data:e,error:s}=await l.from("owner_verifications").select("id, status").eq("user_id",O.id).eq("status","verified").single();s&&s.code,e&&(a=!0)}const t={name:ee.name||P?.display_name||"",nickname:ee.nickname,postal_code:ee.postal_code,address:ee.address,phone_number:ee.phone_number,email:ee.email,notify_opt_in:Se,user_type:Te||"user"};L&&P?.line_user_id?(t.line_user_id=P.line_user_id,t.is_line_user=!0,t.auth_type="line"):O&&(t.auth_type="email");const{error:r}=await l.from("profiles").upsert({id:e,...t,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{onConflict:"id"});if(r)throw r;if(a){const{error:e}=await l.from("owner_verifications").update({status:"pending",updated_at:(new Date).toISOString()}).eq("user_id",O?.id),{error:s}=await l.from("notifications").insert([{user_id:O?.id,type:"identity_verification",title:"住所変更により本人確認が必要です",message:"住所を変更されたため、本人確認書類を再度提出する必要があります。ドッグラン施設の登録を継続される場合は、本人確認書類をアップロードしてください。",data:{reason:"address_change"}}])}if(O?.email!==ee.email){const{error:e}=await l.auth.updateUser({email:ee.email});if(e)throw e}te(ee);let i="プロフィールを更新しました";a&&(i+="\n\n住所変更により本人確認が必要になりました。ドッグラン施設の登録を継続される場合は、本人確認書類を再度アップロードしてください。"),K(i);try{await l.from("profiles").update({notify_opt_in:Se}).eq("id",e)}catch{}setTimeout(()=>{K("")},3e3)}catch(s){$(s.message||"プロフィールの更新に失敗しました")}finally{Z(!1)}};return U?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-4xl mx-auto p-4",children:[e.jsx("div",{className:"flex items-center mb-4",children:e.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>F("/dashboard"),className:"mr-4",children:[e.jsx(x,{className:"w-4 h-4 mr-1"}),"マイページに戻る"]})}),e.jsxs(c,{className:"p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"通知設定"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"コミュニティのメッセージやお知らせをLINEに転送します（連携が必要）。"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"LINEで通知を受け取る"}),(()=>{const s=Ce||!0===Y||M;return e.jsxs("div",{className:"text-sm text-gray-500",children:["連携状態: ",s?"連携済み":"未連携"]})})()]}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only",checked:Se,onChange:e=>ke(e.target.checked),disabled:!(Ce||!0===Y||M)}),e.jsx("span",{className:(Se&&(Ce||!0===Y||M)?"bg-green-400":"bg-gray-300")+" w-12 h-6 flex items-center rounded-full p-1 transition-colors",children:e.jsx("span",{className:"bg-white w-5 h-5 rounded-full shadow transform transition-transform "+(Se&&(Ce||!0===Y||M)?"translate-x-6":"")})})]})]}),!(Ce||!0===Y||M)&&e.jsx("div",{className:"mt-3 text-sm text-orange-600",children:"LINEと連携すると有効化できます。上部のLINE連携セクションから連携してください。"}),e.jsx("div",{className:"mt-4 text-right",children:e.jsxs(r,{onClick:async()=>{try{(await fetch("/.netlify/functions/profile-notify-optin",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({notifyOptIn:Se})})).ok?(K("通知設定を保存しました"),setTimeout(()=>K(""),2e3)):await ls({preventDefault:()=>{}})}catch{await ls({preventDefault:()=>{}})}},isLoading:X,children:[e.jsx(h,{className:"w-4 h-4 mr-1"})," 保存"]})})]}),e.jsx(c,{className:"p-6",children:e.jsxs("form",{onSubmit:ls,children:[W&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:W})]}),H&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(p,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:H})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(j,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"基本情報"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(d,{label:"お名前",value:ee.name,onChange:e=>se({...ee,name:e.target.value}),placeholder:"お名前（任意）",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(d,{label:"ニックネーム",value:ee.nickname,onChange:e=>se({...ee,nickname:e.target.value}),placeholder:"表示名やニックネームを入力（任意）",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(d,{label:"メールアドレス",type:"email",value:ee.email,onChange:e=>se({...ee,email:e.target.value}),placeholder:"メールアドレス（任意）",icon:e.jsx(f,{className:"w-4 h-4 text-gray-500"})})]}),e.jsxs("div",{className:"flex items-center space-x-3 mb-6 mt-8",children:[e.jsx(b,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"住所情報"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(g,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:ee.postal_code,onChange:e=>ns(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${_e?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8}),ye&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(N,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),_e&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:_e})]}),e.jsx(d,{label:"電話番号",value:ee.phone_number,onChange:e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:ee.phone_number})(e.target.value);se({...ee,phone_number:s})},placeholder:"090-1234-5678",maxLength:13,icon:e.jsx(w,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(d,{label:"住所",value:ee.address,onChange:e=>se({...ee,address:e.target.value}),placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(r,{type:"submit",isLoading:X,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"保存する"]})})]})]})}),e.jsxs(c,{className:"p-6 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(y,{className:"w-6 h-6 text-yellow-600"}),e.jsx("h2",{className:"text-xl font-semibold",children:"アカウント設定"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-green-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"LINE通知連携"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"dogparkjp公式LINEと友達になり、アプリ内の通知をLINEで受け取れます。 ドッグラン入退場時のPIN発行通知などもLINEで受信できます。"}),e.jsxs("div",{className:"flex items-center gap-2",children:[Y?e.jsx(r,{variant:"secondary",size:"sm",isLoading:Q,disabled:Q,onClick:async()=>{$(""),K(""),V(!0);try{if(!M)return V(!1),void window.location.assign("/liff/login?redirect=/profile-settings");const e=await fetch("/line/unlink-user",{method:"POST",credentials:"include"});if(!e.ok)throw new Error(await e.text());B(!1),K("LINE連携を解除しました"),setTimeout(()=>K(""),2500)}catch(e){$(e instanceof Error?e.message:"解除に失敗しました")}finally{V(!1)}},children:"通知連携済み（解除する）"}):e.jsx(r,{variant:"primary",size:"sm",isLoading:Q,disabled:Q,onClick:async()=>{$(""),K(""),V(!0);try{const e=O?.id||P?.app_user_id||P?.id||J;if(!e)throw new Error("ログインが必要です");const s=await fetch("/line/link-user",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({appUserId:e})});if(401===s.status)return V(!1),$("LINEログインの同意が必要です。画面の案内に従って再度お試しください。"),void window.location.assign("/liff/login?redirect=/profile-settings");if(!s.ok)throw new Error(await s.text());B(!0),K("LINE通知連携が完了しました");try{window.scrollTo({top:0,behavior:"smooth"})}catch{}setTimeout(()=>K(""),3500)}catch(e){$(e instanceof Error?e.message:"連携に失敗しました")}finally{V(!1)}},children:"LINE通知を連携する"}),null!==Y&&e.jsx("span",{className:"text-sm "+(Y?"text-green-600":"text-gray-500"),children:Y?"連携済み":"未連携"})]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"支払い方法"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"登録済みのカードの確認・変更を行います。"}),e.jsx(t,{to:"/payment-method-settings",children:e.jsxs(r,{variant:"secondary",size:"sm",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),"支払い方法を管理"]})})]}),O&&e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"パスワード変更"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを保つため、定期的にパスワードを変更することをおすすめします。"}),e.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>ie(!0),children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"パスワードを変更"]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-purple-200",children:[e.jsxs("div",{className:"flex items-center mb-3",children:[e.jsx(I,{className:"w-5 h-5 text-purple-600 mr-2"}),e.jsx("h3",{className:"font-semibold",children:"サブスクリプション管理"})]}),q?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-sm text-gray-600",children:"読み込み中..."})]}):D&&A?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["現在のプラン: ",e.jsx("span",{className:"font-medium text-purple-600",children:"月額サブスクリプション"})]}),e.jsxs("p",{children:["ステータス: ",e.jsx("span",{className:"font-medium "+("active"===A.subscription_status?"text-green-600":"paused"===A.subscription_status?"text-yellow-600":"text-red-600"),children:"active"===A.subscription_status?"利用中":"paused"===A.subscription_status?"一時停止中":"canceled"===A.subscription_status?"退会済み":A.subscription_status})]}),A.current_period_end&&e.jsxs("p",{children:["次回更新日: ",new Date(1e3*A.current_period_end).toLocaleDateString()]})]}),e.jsx("div",{className:"text-right",children:e.jsxs(r,{variant:"secondary",size:"sm",className:"text-purple-600 hover:text-purple-700 border-purple-300 hover:border-purple-400",onClick:()=>F("/subscription-intro"),children:[e.jsx(I,{className:"w-4 h-4 mr-1"})," 管理ページを開く"]})}),Ue&&e.jsx("div",{className:"p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(u,{className:"w-4 h-4 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:Ue})]})}),Xe&&e.jsx("div",{className:"p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(p,{className:"w-4 h-4 text-green-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-green-800",children:Xe})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:["active"===A.subscription_status&&e.jsxs(e.Fragment,{children:[e.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>Ae("pause"),disabled:qe,children:[e.jsx(S,{className:"w-4 h-4 mr-1"}),"利用を一時停止"]}),e.jsxs(r,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>Ae("cancel"),disabled:qe,children:[e.jsx(k,{className:"w-4 h-4 mr-1"}),"退会する"]})]}),"paused"===A.subscription_status&&e.jsxs(r,{variant:"secondary",size:"sm",className:"text-green-600 hover:text-green-700 border-green-300 hover:border-green-400",onClick:()=>Ae("resume"),disabled:qe,children:[e.jsx(C,{className:"w-4 h-4 mr-1"}),"利用を再開"]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"現在サブスクリプションに加入していません。"}),e.jsxs(r,{variant:"secondary",size:"sm",className:"text-purple-600 hover:text-purple-700 border-purple-300 hover:border-purple-400",onClick:()=>F("/subscription-intro"),children:[e.jsx(I,{className:"w-4 h-4 mr-1"}),"サブスクリプションに加入"]})]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"2段階認証（2FA）"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:"loading"===Ye?e.jsxs("div",{className:"flex items-center text-gray-600 text-sm",children:[e.jsx(N,{className:"w-4 h-4 animate-spin mr-2"}),"状態を確認中..."]}):"enabled"===Ye?e.jsxs("div",{className:"flex items-center text-green-700 text-sm",children:[e.jsx(E,{className:"w-4 h-4 mr-1"}),"有効"]}):e.jsxs("div",{className:"flex items-center text-gray-600 text-sm",children:[e.jsx(E,{className:"w-4 h-4 mr-1"}),"無効"]})}),e.jsx("div",{className:"flex items-center gap-2",children:"enabled"===Ye?e.jsx(r,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>{(async()=>{try{ts("");const e=Qe.find(e=>"totp"===e.factorType&&"verified"===e.status);if(!e)throw new Error("有効な2FA設定が見つかりません");const{error:s}=await l.auth.mfa.unenroll({factorId:e.id});if(s)throw s;await is(),K("2FAを無効化しました"),setTimeout(()=>K(""),3e3)}catch(e){ts(e instanceof Error?e.message:"2FAの無効化に失敗しました"),setTimeout(()=>ts(""),4e3)}})()},children:"無効化する"}):e.jsx(r,{size:"sm",onClick:()=>{(async()=>{try{ts("");const{data:e,error:s}=await l.auth.mfa.listFactors();if(s)throw s;const a=(e?.factors||[]).find(e=>"totp"===e.factorType);if(a&&"verified"===a.status)return Be("enabled"),K("2FAはすでに有効です"),void setTimeout(()=>K(""),2500);if(a&&"verified"!==a.status)try{await l.auth.mfa.unenroll({factorId:a.id})}catch{}const{data:t,error:r}=await l.auth.mfa.enroll({factorType:"totp",friendlyName:"Authenticator"});if(r)throw r;$e({factorId:t.id,qrCode:t?.totp?.qr_code}),Re(!0)}catch(e){const s=e instanceof Error?e.message:"2FAの有効化に失敗しました";if("string"==typeof s&&s.toLowerCase().includes("already exists"))return await is(),K("2FAはすでに登録済みです。必要なら無効化してから再設定してください。"),void setTimeout(()=>K(""),3e3);ts(s),setTimeout(()=>ts(""),4e3)}})()},children:"有効化する"})})]}),as&&e.jsx("div",{className:"mt-3 p-3 bg-red-50 rounded text-red-800 text-sm",children:as})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"アカウント削除"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントを削除すると、すべてのデータが完全に削除され、復元できなくなります。"}),e.jsxs(r,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>le(!0),children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),"アカウントを削除"]})]})]})]}),re&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"パスワード変更"}),e.jsx("button",{onClick:()=>{ie(!1),fe(""),ge(""),de({currentPassword:"",newPassword:"",confirmPassword:""})},className:"text-gray-500 hover:text-gray-700",children:e.jsx(z,{className:"w-6 h-6"})})]}),je&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:je})]})}),be&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(p,{className:"w-5 h-5 text-green-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-green-800",children:be})]})}),e.jsx("form",{onSubmit:async e=>{e.preventDefault(),he(!0),fe(""),ge("");try{if(!ce.currentPassword)throw new Error("現在のパスワードを入力してください");if(!ce.newPassword)throw new Error("新しいパスワードを入力してください");if(ce.newPassword.length<6)throw new Error("パスワードは6文字以上で入力してください");if(ce.newPassword!==ce.confirmPassword)throw new Error("新しいパスワードと確認用パスワードが一致しません");const{error:e}=await l.auth.signInWithPassword({email:O?.email||"",password:ce.currentPassword});if(e)throw new Error("現在のパスワードが正しくありません");const{error:s}=await l.auth.updateUser({password:ce.newPassword});if(s)throw s;ge("パスワードを変更しました"),de({currentPassword:"",newPassword:"",confirmPassword:""}),setTimeout(()=>{ie(!1),ge("")},3e3)}catch(s){fe(s.message||"パスワードの変更に失敗しました")}finally{he(!1)}},children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(d,{label:"現在のパスワード *",type:"password",value:ce.currentPassword,onChange:e=>de({...ce,currentPassword:e.target.value}),required:!0}),e.jsx(d,{label:"新しいパスワード *",type:"password",value:ce.newPassword,onChange:e=>de({...ce,newPassword:e.target.value}),required:!0,minLength:6}),e.jsx(d,{label:"新しいパスワード（確認） *",type:"password",value:ce.confirmPassword,onChange:e=>de({...ce,confirmPassword:e.target.value}),required:!0,minLength:6}),e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"パスワードの要件"}),e.jsx("br",{}),"• 6文字以上",e.jsx("br",{}),"• 英数字を含めることをおすすめします",e.jsx("br",{}),"• 以前使用したパスワードと異なるものを使用してください"]})}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{ie(!1),fe(""),ge(""),de({currentPassword:"",newPassword:"",confirmPassword:""})},children:"キャンセル"}),e.jsx(r,{type:"submit",isLoading:xe,children:"パスワードを変更"})]})]})})]})}),ne&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-red-600",children:"アカウント削除"}),e.jsx("button",{onClick:()=>{le(!1),we(""),me("")},className:"text-gray-500 hover:text-gray-700",children:e.jsx(z,{className:"w-6 h-6"})})]}),Ne&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-800",children:Ne})]})}),e.jsx("div",{className:"p-4 bg-red-50 rounded-lg mb-4",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 mb-1",children:"警告: この操作は取り消せません"}),e.jsx("p",{className:"text-sm text-red-700",children:"アカウントを削除すると、以下のデータがすべて完全に削除されます："}),e.jsxs("ul",{className:"text-sm text-red-700 list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"プロフィール情報"}),e.jsx("li",{children:"登録したワンちゃんの情報"}),e.jsx("li",{children:"予約履歴"}),e.jsx("li",{children:"支払い情報"}),e.jsx("li",{children:"友達リストとメッセージ"})]})]})]})}),e.jsx("form",{onSubmit:async e=>{e.preventDefault(),pe(!0),we("");try{if("delete"!==oe)throw new Error("確認のため「delete」と入力してください");const e=O?.id||P?.app_user_id||P?.id||J;if(!e)throw new Error("ユーザー情報が取得できません");if(L)await fetch("/auth/logout",{method:"POST",credentials:"include"}),await l.from("profiles").delete().eq("id",e);else{const{error:s}=await l.auth.admin.deleteUser(e);if(s)throw s;await l.auth.signOut()}F("/",{replace:!0})}catch(s){we(s.message||"アカウントの削除に失敗しました")}finally{pe(!1)}},children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"確認のため「delete」と入力してください *"}),e.jsx("input",{type:"text",value:oe,onChange:e=>me(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{le(!1),we(""),me("")},children:"キャンセル"}),e.jsx(r,{type:"submit",isLoading:ue,className:"bg-red-600 hover:bg-red-700",disabled:"delete"!==oe,children:"アカウントを削除"})]})]})})]})}),Fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold text-purple-600",children:["pause"===Fe&&"サブスクリプション一時停止","resume"===Fe&&"サブスクリプション再開","cancel"===Fe&&"サブスクリプション退会"]}),e.jsx("button",{onClick:()=>{Ae(null),Ge(""),Ze("")},className:"text-gray-500 hover:text-gray-700",children:e.jsx(z,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:["pause"===Fe&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(S,{className:"w-5 h-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-yellow-800 mb-1",children:"一時停止について"}),e.jsx("p",{className:"text-sm text-yellow-700",children:"サブスクリプションを一時停止すると、次回の請求が停止されます。 いつでも再開することができます。"})]})]})}),e.jsx("p",{className:"text-sm text-gray-600",children:"一時停止中も現在の期間終了まではサービスをご利用いただけます。"})]}),"resume"===Fe&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(C,{className:"w-5 h-5 text-green-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-green-800 mb-1",children:"再開について"}),e.jsx("p",{className:"text-sm text-green-700",children:"サブスクリプションを再開すると、通常の請求サイクルが復活します。"})]})]})}),e.jsx("p",{className:"text-sm text-gray-600",children:"再開後は全ての機能をご利用いただけます。"})]}),"cancel"===Fe&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 bg-red-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800 mb-1",children:"退会について"}),e.jsx("p",{className:"text-sm text-red-700",children:"退会すると、現在の期間終了後にサブスクリプションが終了します。 いつでも再度加入することができます。"})]})]})}),e.jsx("p",{className:"text-sm text-gray-600",children:"退会後も現在の期間終了まではサービスをご利用いただけます。"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{Ae(null),Ge(""),Ze("")},disabled:qe,children:"キャンセル"}),e.jsxs(r,{type:"button",isLoading:qe,className:"cancel"===Fe?"bg-red-600 hover:bg-red-700":"resume"===Fe?"bg-green-600 hover:bg-green-700":"bg-yellow-600 hover:bg-yellow-700",onClick:()=>{"pause"===Fe?(async()=>{if(A?.subscription_id){De(!0),Ge(""),Ze("");try{const e=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-pause-subscription",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"},body:JSON.stringify({subscription_id:A.subscription_id})});if(!e.ok){const s=await e.json();throw new Error(s.error||"サブスクリプションの一時停止に失敗しました")}Ze("サブスクリプションを一時停止しました。再開はいつでも可能です。"),Ae(null),setTimeout(()=>{window.location.reload()},2e3)}catch(e){Ge(e instanceof Error?e.message:"サブスクリプションの一時停止に失敗しました")}finally{De(!1)}}})():"resume"===Fe?(async()=>{if(A?.subscription_id){De(!0),Ge(""),Ze("");try{const e=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-resume-subscription",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"},body:JSON.stringify({subscription_id:A.subscription_id})});if(!e.ok){const s=await e.json();throw new Error(s.error||"サブスクリプションの再開に失敗しました")}Ze("サブスクリプションを再開しました。"),Ae(null),setTimeout(()=>{window.location.reload()},2e3)}catch(e){Ge(e instanceof Error?e.message:"サブスクリプションの再開に失敗しました")}finally{De(!1)}}})():"cancel"===Fe&&(async()=>{if(A?.subscription_id){De(!0),Ge(""),Ze("");try{const e=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-cancel-subscription",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"},body:JSON.stringify({subscription_id:A.subscription_id})});if(!e.ok){const s=await e.json();throw new Error(s.error||"サブスクリプションの退会に失敗しました")}Ze("サブスクリプションを退会しました。現在の期間終了まで利用可能です。"),Ae(null),setTimeout(()=>{window.location.reload()},2e3)}catch(e){Ge(e instanceof Error?e.message:"サブスクリプションの退会に失敗しました")}finally{De(!1)}}})()},children:["pause"===Fe&&"一時停止する","resume"===Fe&&"再開する","cancel"===Fe&&"退会する"]})]})]})]})}),Me&&We&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"2FAを有効化"}),e.jsx("button",{onClick:()=>{Re(!1),$e(null),Ke("")},className:"text-gray-500 hover:text-gray-700",children:e.jsx(z,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"認証アプリ（Google Authenticator 等）で以下のQRコードを読み取り、表示された6桁コードを入力してください。"}),We.qrCode&&e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:We.qrCode,alt:"2FA QR",className:"w-40 h-40"})}),e.jsx(d,{label:"6桁コード",value:He,onChange:e=>Ke(e.target.value),placeholder:"123456"}),as&&e.jsx("div",{className:"p-3 bg-red-50 rounded text-red-800 text-sm",children:as}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(r,{variant:"secondary",onClick:()=>{Re(!1),$e(null),Ke("")},children:"キャンセル"}),e.jsx(r,{onClick:()=>{(async()=>{if(We&&He)try{ss(!0);const{data:e,error:s}=await l.auth.mfa.challenge({factorId:We.factorId});if(s)throw s;const{error:a}=await l.auth.mfa.verify({factorId:We.factorId,challengeId:e.id,code:He});if(a)throw a;Re(!1),$e(null),Ke(""),await is(),K("2FAを有効化しました"),setTimeout(()=>K(""),3e3)}catch(e){ts(e instanceof Error?e.message:"認証コードの検証に失敗しました")}finally{ss(!1)}})()},isLoading:es,children:"認証して有効化"})]})]})]})})]})}export{O as ProfileSettings};
