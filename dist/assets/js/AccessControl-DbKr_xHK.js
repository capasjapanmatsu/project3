import{j as e}from"./data-vendor-BmFUkYzE.js";import{r as s,d as t}from"./core-vendor-DBEP70vW.js";import{C as r,B as a,u as l,b as n,s as c}from"./index-CDzr2Gkx.js";import{K as i,A as d,i as x,L as m,O as o,P as h,M as u}from"./ui-vendor-B3gor5_P.js";import{V as j,g}from"./VaccineBadge-DAd5IbSP.js";import"./heavy-vendor-Bb5jGJvT.js";function N({lockId:t,parkName:l="ドッグパーク",purpose:n="entry",className:c="",onSuccess:o,onError:h}){const[u,j]=s.useState(""),[g,N]=s.useState(!1),[f,p]=s.useState(null),[b,y]=s.useState(null);return e.jsx(r,{className:`p-4 ${c}`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-center",children:[e.jsx(i,{className:"w-5 h-5 text-blue-600 mr-2"}),l,"の","entry"===n?"入口":"出口"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-gray-600 mb-4",children:["entry"===n?"入場":"退場","用のPINコードを入力してください"]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("input",{type:"text",value:u,onChange:e=>{const s=e.target.value.replace(/\D/g,"");s.length<=6&&j(s)},placeholder:"6桁のPINコード",className:"px-4 py-2 text-center text-2xl tracking-widest w-48 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:6,inputMode:"numeric",pattern:"[0-9]*"})}),f&&e.jsxs("div",{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",children:[e.jsx(d,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:f})]}),b&&e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",children:[e.jsx(x,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:b})]}),e.jsxs(a,{onClick:()=>{(async()=>{if(6===u.length){N(!0),p(null),y(null);try{const e=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lock_id:t,pin:u,purpose:n})});if(!e.ok){const s=await e.json();throw new Error(s.error||"PINコードの検証に失敗しました")}const s=await e.json();if(!s.success)throw new Error(s.error||"PINコードが無効です");y(s.message||"PINコードが確認されました"),j(""),o&&o(s),setTimeout(()=>{y(null)},3e3)}catch(e){const s=e.message||"PINコードの検証に失敗しました";p(s),h&&h(s)}finally{N(!1)}}else p("PINコードは6桁で入力してください")})()},isLoading:g,disabled:6!==u.length,className:"w-full",children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),g?e.jsx(m,{className:"w-4 h-4 animate-spin"}):"PINコードを確認"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["entry"===n?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]})]})})}function f(){const{user:m}=l(),f=t();n();const[p,b]=s.useState([]),[y,v]=s.useState([]),[w,k]=s.useState([]),[P,I]=s.useState([]),[S,_]=s.useState(null),[C,E]=s.useState(!1),[T,q]=s.useState(""),[z,B]=s.useState("");s.useEffect(()=>{(async()=>{if(m)try{const{data:e,error:s}=await c.from("dogs").select("\n            *,\n            vaccine_certifications (\n              id,\n              status,\n              rabies_expiry_date,\n              combo_expiry_date,\n              approved_at\n            )\n          ").eq("owner_id",m.id);if(s)throw s;const t=(e||[]).filter(e=>"approved"===g(e));b(t),e&&e.length>0&&0===t.length&&q("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")}catch(e){q("ワンちゃんの情報を取得できませんでした。")}})(),(async()=>{try{E(!0);const{data:e,error:s}=await c.from("dog_parks").select("*").eq("status","approved");if(s)throw s;k(e||[]);const{data:t,error:r}=await c.from("smart_locks").select("*").eq("status","active");if(r)throw r;v(t||[]),t&&t.length>0&&_(t[0])}catch(e){q("データの取得に失敗しました。")}finally{E(!1)}})()},[m]);const L=e=>"オス"===e?"くん":"ちゃん";return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(a,{variant:"primary",size:"sm",onClick:()=>f(-1),className:"mr-3",children:[e.jsx(o,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),T&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:T}),z&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:z}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(r,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(h,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),0===p.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(d,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),e.jsx(a,{onClick:()=>f("/register-dog"),children:"ワンちゃんを登録する"})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",3,"頭）"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[P.length,"/",3,"頭選択中"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:p.map(s=>{const t=P.includes(s.id),r=!t&&P.length>=3;return e.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(t?"border-green-500 bg-green-50":r?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>{return!r&&(e=s.id,void I(s=>s.includes(e)?s.filter(s=>s!==e):s.length<3?[...s,e]:s));var e},children:[t&&e.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:e.jsx(x,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(h,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold",children:[s.name,L(s.gender)]}),e.jsx(j,{status:g(s),size:"sm"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.breed," • ",s.gender]})]})]})]},s.id)})}),P.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),e.jsx("p",{className:"text-sm text-green-800",children:P.map(e=>{const s=p.find(s=>s.id===e);return s?`${s.name}${L(s.gender)}`:""}).filter(Boolean).join("、")}),e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[P.length,"頭が同時入場できます"]})]})]})})]}),e.jsxs(r,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(u,{className:"w-5 h-5 text-blue-600 mr-2"}),"施設を選択"]}),0===y.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(i,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"利用可能な施設がありません"})]}):e.jsx("div",{className:"space-y-3",children:y.map(s=>{const t=w.find(e=>e.id===s.park_id),r=S?.id===s.id;return e.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+(r?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>_(s),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t?.name||"Unknown Park"}),e.jsx("p",{className:"text-sm text-gray-600",children:s.lock_name}),e.jsx("p",{className:"text-xs text-gray-500",children:t?.address})]}),r&&e.jsx(x,{className:"w-5 h-5 text-blue-600"})]})},s.id)})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(r,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(i,{className:"w-5 h-5 text-blue-600 mr-2"}),"PINコード生成"]}),S&&P.length>0?e.jsx(N,{lockId:S.lock_id,parkName:w.find(e=>e.id===S.park_id)?.name||"ドッグパーク",purpose:"entry",onSuccess:e=>{B("PINコードを生成しました"),setTimeout(()=>{B("")},3e3)},onError:e=>{q(e),setTimeout(()=>{q("")},5e3)}}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(d,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-2",children:"PINコードを生成するには："}),e.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[e.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),e.jsx("li",{children:"• 施設を選択"})]})]})]}),e.jsxs(r,{className:"p-6 bg-blue-50 border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"PINコードの使い方"}),e.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"1"}),e.jsx("p",{children:"ワンちゃんと施設を選択してPINコードを生成します"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"2"}),e.jsx("p",{children:"ドッグランの入口にあるスマートロックのキーパッドにPINコードを入力します"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"3"}),e.jsx("p",{children:"PINコードは5分間有効です"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"4"}),e.jsx("p",{children:"退場時も同様にPINコードを生成して使用します"})]})]})]})]})]})]})}export{f as AccessControl};
