import{j as e}from"./data-vendor-BmFUkYzE.js";import{r,L as a}from"./core-vendor-DBEP70vW.js";import{s as t,u as s,B as i,C as o,n as l}from"./index-CDzr2Gkx.js";import{I as n}from"./Input-CcyqxK15.js";import{S as d}from"./Select-BRIzR28X.js";import{d as c}from"./dogBreeds-6lxY8Uni.js";import{l as u}from"./logger-hQPzKOcf.js";import{O as m,X as g,$ as b}from"./ui-vendor-B3gor5_P.js";import"./heavy-vendor-Bb5jGJvT.js";const h=e=>{if(!e)return{isValid:!1,error:"ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"};if(e.size>10485760)return{isValid:!1,error:"ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${e.type}`}},p=async(e,r)=>{try{const a=h(e);if(!a.isValid)return{success:!1,error:a.error};const s=Date.now(),i=e.name.split(".").pop()||"jpg",o=`${r.dogId}/${r.imageType}_${s}.${i}`,{data:l,error:n}=await t.storage.from("vaccine-certs").upload(o,e,{cacheControl:"3600",upsert:!0,contentType:e.type});return n?{success:!1,error:`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${n.message}`,errorCode:n.message}:{success:!0,filePath:o}}catch(a){return{success:!1,error:`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${a.message}`}}};function f(){const{user:f}=s(),[x,y]=r.useState(!1),[j,v]=r.useState(""),[w,N]=r.useState(null),[D,I]=r.useState(null),[S,C]=r.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),$=(new Date).getFullYear(),V=Array.from({length:21},(e,r)=>{const a=$-r;return{value:a.toString(),label:`${a}å¹´`}}),E=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}æœˆ`}}),M=()=>{if(!S.birthYear||!S.birthMonth||!S.birthDay)return!1;const e=parseInt(S.birthYear),r=parseInt(S.birthMonth),a=parseInt(S.birthDay),t=new Date(e,r-1,a);if(t>new Date)return!1;const s=new Date;return s.setFullYear(s.getFullYear()-20),!(t<s)},Y=c.map(e=>({value:e,label:e}));return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[e.jsxs("div",{children:[e.jsxs(a,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç™»éŒ²"}),e.jsx("p",{className:"text-gray-600",children:"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã—ã¦ã€ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã—ã‚‡ã†"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-900",children:"æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒã„ã¾ã™ã‹ï¼Ÿ"}),e.jsx("p",{className:"text-sm text-blue-700",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™"})]}),e.jsx(a,{to:"/dog-management",children:e.jsx(i,{variant:"secondary",size:"sm",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"})})]})}),e.jsx(o,{children:e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),y(!0),v("");try{if(u.info("=== DOG REGISTRATION START ==="),u.info("Starting dog registration for user:",f?.id),!M())return v("æ­£ã—ã„ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"),void y(!1);if(!S.rabiesExpiryDate||!S.comboExpiryDate)return v("ãƒ¯ã‚¯ãƒãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"),void y(!1);const e=new Date,a=new Date(S.rabiesExpiryDate),s=new Date(S.comboExpiryDate);if(a<=e||s<=e)return v("ãƒ¯ã‚¯ãƒãƒ³ã®æœ‰åŠ¹æœŸé™ã¯ä»Šæ—¥ã‚ˆã‚Šå¾Œã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"),void y(!1);const i=`${S.birthYear}-${S.birthMonth}-${S.birthDay}`;let o;if("ã‚ªã‚¹"===S.gender||"male"===S.gender||"male"===S.gender.toLowerCase())o="ã‚ªã‚¹";else{if("ãƒ¡ã‚¹"!==S.gender&&"female"!==S.gender&&"female"!==S.gender.toLowerCase())return v("æ€§åˆ¥ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„ã€‚"),void y(!1);o="ãƒ¡ã‚¹"}u.info("Original gender:",S.gender,"Normalized gender:",o);const{data:n,error:d}=await t.from("profiles").select("id, name, user_type").eq("id",f?.id).maybeSingle();if(u.info("Profile check result:",n,d),d&&"PGRST116"!==d.code)throw u.error("Profile error:",d),d;if(n)u.info("Profile exists:",n);else{u.info("Creating profile for dog registration using upsert");const e=f?.user_metadata?.name||f?.email?.split("@")[0]||"ãƒ¦ãƒ¼ã‚¶ãƒ¼",{data:r,error:a}=await t.from("profiles").upsert([{id:f?.id,user_type:"user",name:e,postal_code:"",address:"",phone_number:""}],{onConflict:"id"}).select().single();if(a)throw u.error("Profile upsert error:",a),a;u.info("Profile upserted successfully:",r)}u.info("Registering dog with data:",{name:S.name,breed:S.breed,birth_date:i,gender:o,owner_id:f?.id});const{data:c,error:m}=await t.from("dogs").insert([{name:S.name,breed:S.breed,birth_date:i,gender:o,owner_id:f?.id}]).select().single();if(m)throw u.error("ğŸš¨ Dog registration error:",m),u.error("ğŸš¨ Error details:",{message:m.message,code:m.code,details:m.details,hint:m.hint}),m;u.info("âœ… Dog registered successfully:",c),u.info("âœ… Dog ID generated:",c.id);let g=null;if(w){u.info("Uploading dog image...");try{const e=w.name.split(".").pop()||"jpg",r=Date.now(),a=`${c.id}/profile_${r}.${e}`;u.info("Uploading to path:",a),u.info("ğŸ”§ Uploading dog image with Content-Type:",w.type);const{error:s}=await t.storage.from("dog-images").upload(a,w,{cacheControl:"3600",upsert:!0,contentType:w.type});if(s)throw u.error("Image upload error:",s),new Error(`ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${s.message}`);u.info("Upload successful");const{data:{publicUrl:i}}=t.storage.from("dog-images").getPublicUrl(a);g=i,u.info("Public URL generated:",g);const{error:o}=await t.from("dogs").update({image_url:g}).eq("id",c.id);if(o)throw u.error("Error updating dog image URL:",o),new Error("ç”»åƒURLã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");u.info("Dog image URL updated successfully")}catch(r){u.error("Image processing error:",r),v("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ç™»éŒ²ã¯å®Œäº†ã—ã¾ã—ãŸã€‚å¾Œã§ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã‚’è¿½åŠ ã§ãã¾ã™ã€‚")}}if(S.rabiesVaccineImage&&S.comboVaccineImage){u.info("ğŸ§ª Starting vaccine certificates upload using utility...");const e=await p(S.rabiesVaccineImage,{dogId:c.id,imageType:"rabies"});await p(S.comboVaccineImage,{dogId:c.id,imageType:"combo"});e.success?u.info("âœ… Vaccine certificates uploaded successfully"):(u.error("Vaccine upload failed:",e.error),v(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.error}`))}u.info("Dog registration completed successfully"),l.success("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼"),C({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),N(null),I(null)}catch(a){u.error("Registration error:",a),v("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")}finally{y(!1)}},children:[j&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:j}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å†™çœŸï¼ˆä»»æ„ï¼‰"}),D?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:D,alt:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",className:"w-full h-64 object-cover rounded-lg border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{N(null),I(null)},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(g,{className:"w-4 h-4"})}),w&&e.jsx("div",{className:"absolute bottom-2 left-2 bg-white bg-opacity-90 text-gray-800 text-xs px-2 py-1 rounded border shadow-sm",children:w.name})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){if(u.info("Selected file:",r.name,r.size,r.type),r.size>10485760)return void v("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!r.type.startsWith("image/"))return void v("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");N(r);const e=new FileReader;e.onload=e=>{I(e.target?.result),u.info("Image preview created")},e.readAsDataURL(r),v("")}},className:"hidden",id:"dog-image"}),e.jsxs("label",{htmlFor:"dog-image",className:"cursor-pointer flex flex-col items-center",children:[e.jsx(b,{className:"w-12 h-12 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"JPG, PNG, GIF (æœ€å¤§10MB)"})]})]})]}),e.jsx(n,{label:"åå‰",value:S.name,onChange:e=>C({...S,name:e.target.value}),required:!0}),e.jsx(d,{label:"çŠ¬ç¨®",options:Y,value:S.breed,onChange:e=>C({...S,breed:e.target.value}),required:!0}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ç”Ÿå¹´æœˆæ—¥ *"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx("div",{children:e.jsxs("select",{value:S.birthYear,onChange:e=>{C({...S,birthYear:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"å¹´"}),V.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:S.birthMonth,onChange:e=>{C({...S,birthMonth:e.target.value,birthDay:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"æœˆ"}),E.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})}),e.jsx("div",{children:e.jsxs("select",{value:S.birthDay,onChange:e=>C({...S,birthDay:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,disabled:!S.birthYear||!S.birthMonth,children:[e.jsx("option",{value:"",children:"æ—¥"}),(()=>{if(!S.birthYear||!S.birthMonth)return Array.from({length:31},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}æ—¥`}});const e=parseInt(S.birthYear),r=parseInt(S.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}æ—¥`}})})().map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})})]}),S.birthYear&&S.birthMonth&&!S.birthDay&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„"}),S.birthYear&&S.birthMonth&&S.birthDay&&!M()&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:"æ­£ã—ã„ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆæœªæ¥ã®æ—¥ä»˜ã‚„20å¹´ä»¥ä¸Šå‰ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“ï¼‰"})]}),e.jsx(d,{label:"æ€§åˆ¥",options:[{value:"",label:"æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„"},{value:"ã‚ªã‚¹",label:"ã‚ªã‚¹"},{value:"ãƒ¡ã‚¹",label:"ãƒ¡ã‚¹"}],value:S.gender,onChange:e=>C({...S,gender:e.target.value}),required:!0}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ç‹‚çŠ¬ç—…ãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è¨¼æ˜æ›¸ *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){const e=h(r);if(!e.isValid)return void v(e.error||"ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");v("")}C({...S,rabiesVaccineImage:r||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ç‹‚çŠ¬ç—…ãƒ¯ã‚¯ãƒãƒ³æœ‰åŠ¹æœŸé™ *"}),e.jsx("input",{type:"date",value:S.rabiesExpiryDate,onChange:e=>C({...S,rabiesExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"æ··åˆãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è¨¼æ˜æ›¸ *"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const r=e.target.files?.[0];if(r){const e=h(r);if(!e.isValid)return void v(e.error||"ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");v("")}C({...S,comboVaccineImage:r||null})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"æ··åˆãƒ¯ã‚¯ãƒãƒ³æœ‰åŠ¹æœŸé™ *"}),e.jsx("input",{type:"date",value:S.comboExpiryDate,onChange:e=>C({...S,comboExpiryDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:(new Date).toISOString().split("T")[0],required:!0})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800",children:"â€» ãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è¨¼æ˜æ›¸ã¯é‹å–¶ã«ã‚ˆã‚‹ç¢ºèªå¾Œã«æ‰¿èªã•ã‚Œã¾ã™ã€‚æ‰¿èªã•ã‚Œã‚‹ã¾ã§ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã®åˆ©ç”¨ã¯ã§ãã¾ã›ã‚“ã€‚"})}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã«ã¤ã„ã¦:"}),e.jsx("br",{}),"â€¢ ç®¡ç†è€…ãŒç¢ºèªã—ã‚„ã™ã„å½¢ã§ä¿å­˜ã•ã‚Œã¾ã™",e.jsx("br",{}),"â€¢ æ‰¿èªã•ã‚Œã‚‹ã¨æ­£å¼ã«ãƒ¯ã‚¯ãƒãƒ³æƒ…å ±ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™",e.jsx("br",{}),"â€¢ æ‰¿èªå¾Œã€å…¨å›½ã®ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™"]})})]}),e.jsx(i,{type:"submit",isLoading:x,className:"w-full",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"})]})})]})}export{f as DogRegistration};
