import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{d as a,a as t,L as r}from"./router-Cg6wfOY4.js";import{B as l}from"./Button-BVIkPLCk.js";import{u as n,s as i,C as c}from"./index-Cxr3hxlQ.js";import{I as d}from"./ImageCropper-CFqHywrA.js";import{I as o}from"./Input-D7pb8xRh.js";import{N as m,J as x,aY as h,aZ as u,e as p,M as g,X as b,i as j,af as _,a4 as f,C as N,a_ as v,ae as w,aA as y,ao as k,ac as q}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";const S={overview:{label:"施設全景",description:"ドッグランの全体が見渡せる写真",icon:m,required:!0},entrance:{label:"入口",description:"入口の様子がわかる写真",icon:g,required:!0},gate:{label:"スマートロック",description:"ドッグランのスマートロック（入退場管理）の写真",icon:p,required:!0},large_dog_area:{label:"大型犬エリア",description:"大型犬用のエリアの写真",icon:m,required:!1,conditionalOn:"large_dog_area"},small_dog_area:{label:"小型犬エリア",description:"小型犬用のエリアの写真",icon:m,required:!1,conditionalOn:"small_dog_area"},private_booth:{label:"プライベートブース",description:"プライベートブースの内部と外観",icon:m,required:!1,conditionalOn:"private_booths"},parking:{label:"駐車場",description:"駐車場の様子がわかる写真",icon:u,required:!1,conditionalOn:"facilities.parking"},shower:{label:"シャワー設備",description:"シャワー設備の写真",icon:h,required:!1,conditionalOn:"facilities.shower"},restroom:{label:"トイレ",description:"トイレ設備の写真",icon:x,required:!1,conditionalOn:"facilities.restroom"},agility:{label:"アジリティ設備",description:"アジリティ設備の写真",icon:m,required:!1,conditionalOn:"facilities.agility"},rest_area:{label:"休憩スペース",description:"休憩スペースの写真",icon:m,required:!1,conditionalOn:"facilities.rest_area"},water_station:{label:"給水設備",description:"給水設備の写真",icon:m,required:!1,conditionalOn:"facilities.water_station"}};function C(){const{id:h}=a(),{user:u}=n(),g=t(),[C,$]=s.useState(null),[E,T]=s.useState([]),[I,L]=s.useState(!0),[M,D]=s.useState(!1),[F,P]=s.useState(""),[B,A]=s.useState(""),[G,J]=s.useState(null),[U,H]=s.useState("images"),[R,W]=s.useState({bank_name:"",bank_code:"",branch_name:"",branch_code:"",account_type:"ordinary",account_number:"",account_holder_name:""}),[z,Q]=s.useState(!1),[Y,Z]=s.useState(""),[K,V]=s.useState(""),[X,ee]=s.useState(!1),[se,ae]=s.useState(""),[te,re]=s.useState(!1),[le,ne]=s.useState(""),[ie,ce]=s.useState(null);s.useEffect(()=>{u&&h?de():g("/owner-dashboard")},[u,h,g]);const de=async()=>{try{L(!0);const{data:e,error:s}=await i.from("dog_parks").select("*").eq("id",h).eq("owner_id",u?.id).single();if(s)throw s;if(!e)return void g("/owner-dashboard");$(e);const{data:a,error:t}=await i.from("dog_park_facility_images").select("*").eq("park_id",h),r=Object.entries(S).filter(([,s])=>{if(s.required)return!0;if(s.conditionalOn&&e){const a=s.conditionalOn.split(".");if(1===a.length)return e[a[0]]??!1;if(2===a.length){const s=e[a[0]];if(s&&"object"==typeof s)return s[a[1]]??!1}}return!1}).map(([e])=>e).map(e=>{const s=(a||[]).find(s=>s.image_type===e);return{id:s?.id,image_type:e,image_url:s?.image_url,is_approved:s?.is_approved??null,admin_notes:s?.admin_notes}});T(r);const{data:l,error:n}=await i.rpc("get_owner_bank_account");!n&&l&&l.length>0&&W({id:l[0].id,bank_name:l[0].bank_name,bank_code:l[0].bank_code,branch_name:l[0].branch_name,branch_code:l[0].branch_code,account_type:l[0].account_type,account_number:l[0].account_number,account_holder_name:l[0].account_holder_name})}catch(e){P(e.message||"エラーが発生しました")}finally{L(!1)}};return I?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):G?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"relative max-w-4xl w-full",children:[e.jsx("button",{onClick:()=>J(null),className:"absolute top-2 right-2 p-2 bg-white bg-opacity-90 shadow-lg rounded-full text-gray-800 hover:bg-opacity-100 transition-all",children:e.jsx(b,{className:"w-6 h-6"})}),e.jsx("img",{src:G,alt:"画像プレビュー",className:"max-h-[80vh] max-w-full mx-auto rounded-lg",onError:e=>{e.currentTarget.src="https://via.placeholder.com/800x600?text=Image+Not+Available"}})]})}):C?"first_stage_passed"!==C.status&&"second_stage_waiting"!==C.status&&"second_stage_review"!==C.status&&"approved"!==C.status?e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(r,{to:"/owner-dashboard",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs(c,{className:"text-center py-8",children:[e.jsx(j,{className:"w-16 h-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"このドッグランは現在編集できません"}),e.jsxs("p",{className:"text-gray-600 mb-4",children:["pending"===C.status&&"第一審査が完了するまでお待ちください。","smart_lock_testing"===C.status&&"スマートロック実証検査中です。管理者からの連絡をお待ちください。","rejected"===C.status&&"審査が却下されました。詳細はダッシュボードでご確認ください。"]}),e.jsx(r,{to:"/owner-dashboard",children:e.jsx(l,{children:"ダッシュボードに戻る"})})]})]}):e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(r,{to:"/owner-dashboard",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(m,{className:"w-8 h-8 text-blue-600 mr-3"}),"approved"===C.status?`${C.name}の施設情報編集`:`${C.name}の第二審査`]}),e.jsx("p",{className:"text-lg text-gray-600",children:"approved"===C.status?"承認済みの施設でも画像の差し替えやコメントの編集が可能です":"施設の詳細画像と振込先情報を登録して審査を完了させましょう"})]}),"approved"!==C.status&&e.jsx(c,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(x,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"審査ステータス"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-green-600 text-white rounded-full flex items-center justify-center text-xs font-bold",children:"1"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"第一審査"}),e.jsx("p",{className:"text-xs text-green-600",children:"完了"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-6 h-6 ${"second_stage_review"===C.status?"bg-green-600":"bg-blue-600"} text-white rounded-full flex items-center justify-center text-xs font-bold`,children:"2"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"第二審査"}),e.jsxs("p",{className:"text-xs text-blue-600",children:["first_stage_passed"===C.status&&"画像アップロード中","second_stage_waiting"===C.status&&"申請準備中","second_stage_review"===C.status&&"審査中"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs font-bold",children:"3"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"QR実証検査"}),e.jsx("p",{className:"text-xs text-gray-600",children:"未実施"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs font-bold",children:"4"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"運営開始"}),e.jsx("p",{className:"text-xs text-gray-600",children:"未完了"})]})]})]})]})]})}),F&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[e.jsx(j,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:F})]}),B&&e.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 flex items-start",children:[e.jsx(f,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:B})]}),"approved"!==C.status&&e.jsx(c,{className:"bg-orange-50 border-orange-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(p,{className:"w-6 h-6 text-orange-600 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"font-semibold text-orange-900 mb-2",children:["スマートロック購入確認 ",e.jsx("span",{className:"text-red-600",children:"*必須"})]}),e.jsx("p",{className:"text-sm text-orange-800 mb-4",children:"第二審査に進む前に、スマートロックの購入と設置が完了していることを確認してください。"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-lg border-2 "+(X?"border-green-300 bg-green-50":"border-red-300 bg-red-50"),children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",id:"smartLockPurchased",checked:X,onChange:e=>{ee(e.target.checked),ae("")},className:"w-5 h-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500"}),e.jsx("label",{htmlFor:"smartLockPurchased",className:"text-sm font-medium text-orange-900",children:"スマートロックを購入し、設置を完了しました"})]}),!X&&e.jsx("div",{className:"mt-2 text-sm text-red-700 font-medium",children:"⚠️ この項目をチェックしないと申請できません"}),X&&e.jsx("div",{className:"mt-2 text-sm text-green-700 font-medium",children:"✅ 確認完了"})]}),se&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-100 border border-red-300 p-3 rounded-lg",children:[e.jsx("strong",{children:"⚠️ 申請エラー:"})," ",se]}),e.jsxs("div",{className:"text-xs text-orange-700 space-y-1 bg-orange-100 p-3 rounded",children:[e.jsx("p",{children:e.jsx("strong",{children:"スマートロック購入・設置について:"})}),e.jsxs("p",{children:["• スマートロックは",e.jsx(r,{to:"/petshop",className:"text-blue-600 hover:text-blue-800 underline font-medium",children:"ペットショップ"}),"で購入できます"]}),e.jsx("p",{children:"• 設置完了後、動作確認を行ってください"}),e.jsx("p",{children:"• 第二審査では実際の設置状況を確認します"}),e.jsx("p",{children:"• 設置に関するサポートが必要な場合はお問い合わせください"})]})]})]})]})}),e.jsxs("div",{className:"flex space-x-4 border-b",children:[e.jsxs("button",{className:"px-4 py-2 font-medium "+("images"===U?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>H("images"),children:[e.jsx(N,{className:"w-4 h-4 inline mr-2"}),"施設画像"]}),e.jsxs("button",{className:"px-4 py-2 font-medium "+("bank"===U?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>H("bank"),children:[e.jsx(O,{className:"w-4 h-4 inline mr-2"}),"振込先情報"]})]}),"images"===U&&e.jsxs(c,{children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(N,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設画像のアップロード"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-yellow-50 p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(j,{className:"w-5 h-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"画像アップロードのガイドライン"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsx("li",{children:"• 鮮明で明るい画像を選んでください"}),e.jsx("li",{children:"• 施設の特徴がよくわかる角度から撮影してください"}),e.jsx("li",{children:"• 画像サイズは10MB以下にしてください"}),e.jsx("li",{children:"• JPG、PNG、GIF形式のみ対応しています"}),e.jsx("li",{children:"• 必須項目（*）は必ずアップロードしてください"})]})]})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:E.map(s=>{const a=S[s.image_type],t=a?.icon||m,r=a?.required||!1;let l=null;if(null!==(s.is_approved??null)&&s.image_url){const a=!0===(n=s.is_approved??null)?{icon:f,color:"text-green-600",label:"承認済み"}:!1===n?{icon:b,color:"text-red-600",label:"却下"}:{icon:q,color:"text-yellow-600",label:"審査中"},t=a.icon;l=e.jsxs("div",{className:`flex items-center space-x-1 ${a.color}`,children:[e.jsx(t,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs",children:a.label})]})}var n;return e.jsxs("div",{className:"border rounded-lg p-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(t,{className:"w-5 h-5 text-blue-600"}),e.jsxs("h3",{className:"font-medium",children:[a?.label||s.image_type,r&&e.jsx("span",{className:"text-red-600 ml-1",children:"*"})]})]}),l]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:a?.description||"画像をアップロードしてください"}),s.image_url?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer",onClick:()=>J(s.image_url||null),children:e.jsx("img",{src:s.image_url,alt:a?.label||s.image_type,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://via.placeholder.com/400x400?text=Image+Not+Available"}})}),e.jsxs("div",{className:"absolute top-2 right-2 flex space-x-2",children:[e.jsx("button",{onClick:()=>J(s.image_url||null),className:"p-1 bg-white rounded-full shadow hover:bg-gray-100",children:e.jsx(v,{className:"w-4 h-4 text-blue-600"})}),e.jsx("button",{onClick:()=>(async e=>{if(e)try{const{error:s}=await i.from("dog_park_facility_images").delete().eq("id",e);if(s)throw s;await de(),A("画像を削除しました"),setTimeout(()=>A(""),3e3)}catch(s){P("画像の削除に失敗しました"),setTimeout(()=>P(""),3e3)}})(s.id),className:"p-1 bg-white rounded-full shadow hover:bg-gray-100",disabled:!0===(s.is_approved??null),children:e.jsx(w,{className:"w-4 h-4 "+(!0===(s.is_approved??null)?"text-gray-400":"text-red-600")})})]}),!1===s.is_approved&&s.admin_notes&&e.jsxs("div",{className:"mt-2 p-2 bg-red-50 rounded text-sm text-red-800",children:[e.jsx("p",{className:"font-medium",children:"却下理由:"}),e.jsx("p",{children:s.admin_notes})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[e.jsx("input",{type:"file",id:`image-${s.image_type}`,accept:"image/*",className:"hidden",onChange:e=>{const a=e.target.files?.[0];a&&((e,s)=>{ne(e),ce(s),re(!0)})(s.image_type,a)}}),e.jsxs("label",{htmlFor:`image-${s.image_type}`,className:"cursor-pointer flex flex-col items-center",children:[e.jsx(y,{className:"w-8 h-8 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択・自動アップロード"})]})]}),s.file&&e.jsxs("div",{className:"bg-gray-50 p-2 rounded",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm truncate",children:s.file.name}),s.uploading&&e.jsxs("div",{className:"flex items-center text-blue-600",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"}),e.jsx("span",{className:"text-sm",children:"アップロード中..."})]})]}),!s.uploading&&!s.error&&s.file&&e.jsx("div",{className:"text-sm text-green-600 mt-1",children:"✓ 選択完了（自動アップロード中）"})]}),s.error&&e.jsx("p",{className:"text-sm text-red-600",children:s.error})]})]},s.image_type)})})]})]}),"bank"===U&&e.jsxs(c,{children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(O,{className:"w-6 h-6 text-blue-600 mr-2"}),"振込先情報"]}),Y&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(j,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:Y})]}),K&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(f,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:K})]}),e.jsx("form",{onSubmit:async e=>{e.preventDefault(),Q(!0),Z(""),V("");try{if(!R.bank_name)throw new Error("銀行名を入力してください");if(!R.bank_code)throw new Error("銀行コードを入力してください");if(!R.branch_name)throw new Error("支店名を入力してください");if(!R.branch_code)throw new Error("支店コードを入力してください");if(!R.account_number)throw new Error("口座番号を入力してください");if(!R.account_holder_name)throw new Error("口座名義を入力してください");if(!/^\d{4}$/.test(R.bank_code))throw new Error("銀行コードは4桁の数字で入力してください");if(!/^\d{3}$/.test(R.branch_code))throw new Error("支店コードは3桁の数字で入力してください");if(!/^\d{7}$/.test(R.account_number))throw new Error("口座番号は7桁の数字で入力してください");const{error:e}=await i.rpc("update_owner_bank_account",{bank_name_param:R.bank_name,bank_code_param:R.bank_code,branch_name_param:R.branch_name,branch_code_param:R.branch_code,account_type_param:R.account_type,account_number_param:R.account_number,account_holder_name_param:R.account_holder_name});if(e)throw e;V("振込先情報を保存しました"),setTimeout(()=>{V("")},3e3)}catch(s){Z(s.message||"振込先情報の保存に失敗しました")}finally{Q(!1)}},children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-yellow-50 p-4 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(j,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"振込先情報について"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsx("li",{children:"• 売上金の振込先となる銀行口座情報を入力してください"}),e.jsx("li",{children:"• 振込は毎月15日に前月分を一括で行います"}),e.jsx("li",{children:"• 振込手数料は当社負担です"}),e.jsx("li",{children:"• 振込金額が5,000円未満の場合は翌月に繰り越されます"}),e.jsx("li",{children:"• 口座名義は正確に入力してください（例：ヤマダ タロウ）"})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(o,{label:"銀行名 *",value:R.bank_name,onChange:e=>W({...R,bank_name:e.target.value}),placeholder:"例：三菱UFJ銀行",required:!0,icon:e.jsx(O,{className:"w-4 h-4 text-gray-500"})}),e.jsx(o,{label:"銀行コード（4桁） *",value:R.bank_code,onChange:e=>{const s=e.target.value.replace(/\D/g,"");W({...R,bank_code:s})},placeholder:"例：0005",maxLength:4,required:!0,helperText:"4桁の数字で入力してください"}),e.jsx(o,{label:"支店名 *",value:R.branch_name,onChange:e=>W({...R,branch_name:e.target.value}),placeholder:"例：渋谷支店",required:!0}),e.jsx(o,{label:"支店コード（3桁） *",value:R.branch_code,onChange:e=>{const s=e.target.value.replace(/\D/g,"");W({...R,branch_code:s})},placeholder:"例：135",maxLength:3,required:!0,helperText:"3桁の数字で入力してください"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"口座種別 *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",checked:"ordinary"===R.account_type,onChange:()=>W({...R,account_type:"ordinary"}),className:"form-radio text-blue-600"}),e.jsx("span",{children:"普通"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",checked:"checking"===R.account_type,onChange:()=>W({...R,account_type:"checking"}),className:"form-radio text-blue-600"}),e.jsx("span",{children:"当座"})]})]})]}),e.jsx(o,{label:"口座番号（7桁） *",value:R.account_number,onChange:e=>{const s=e.target.value.replace(/\D/g,"");W({...R,account_number:s})},placeholder:"例：1234567",maxLength:7,required:!0,helperText:"7桁の数字で入力してください",icon:e.jsx(k,{className:"w-4 h-4 text-gray-500"})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(o,{label:"口座名義（カタカナ） *",value:R.account_holder_name,onChange:e=>W({...R,account_holder_name:e.target.value}),placeholder:"例：ヤマダ タロウ",required:!0,helperText:"カタカナで入力してください（姓と名の間にスペース）"})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(l,{type:"submit",isLoading:z,children:"振込先情報を保存"})})]})})]}),e.jsxs("div",{className:"mt-8 space-y-4",children:["approved"!==C?.status&&!X&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"text-sm font-medium text-red-800",children:"申請するには「スマートロック購入確認」のチェックが必要です"})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(l,{onClick:async()=>{try{if(D(!0),P(""),"approved"===C?.status)return A("画像とコメントの更新が完了しました。"),void setTimeout(()=>{A("")},3e3);if(!X)return ae("スマートロックの購入・設置完了をご確認ください"),void D(!1);const r=Object.entries(S).filter(([,e])=>{if(e.required)return!0;if(e.conditionalOn&&C){const s=e.conditionalOn.split(".");if(1===s.length)return C[s[0]]??!1;if(2===s.length){const e=C[s[0]];if(e&&"object"==typeof e)return e[s[1]]??!1}}return!1}).map(([e])=>e).filter(e=>!E.some(s=>s.image_type===e&&s.image_url));if(r.length>0){const e=r.map(e=>{const s=S[e];return s?.label||e}).join("、");return P(`以下の必要な画像がアップロードされていません: ${e}`),void D(!1)}if(!(R.bank_name&&R.bank_code&&R.branch_name&&R.branch_code&&R.account_number&&R.account_holder_name))return P("振込先情報を入力してください"),H("bank"),void D(!1);try{const{data:e,error:s}=await i.from("dog_park_review_stages").select("id").eq("park_id",h).single();if(s&&s.code,e){const{error:e}=await i.from("dog_park_review_stages").update({second_stage_submitted_at:(new Date).toISOString()}).eq("park_id",h)}else{const{error:e}=await i.from("dog_park_review_stages").insert({park_id:h,second_stage_submitted_at:(new Date).toISOString()})}}catch(e){}try{const{error:e}=await i.from("dog_parks").update({status:"second_stage_review"}).eq("id",h)}catch(s){}try{const{error:e}=await i.rpc("update_owner_bank_account",{bank_name_param:R.bank_name,bank_code_param:R.bank_code,branch_name_param:R.branch_name,branch_code_param:R.branch_code,account_type_param:R.account_type,account_number_param:R.account_number,account_holder_name_param:R.account_holder_name})}catch(a){}try{const{error:e}=await i.from("admin_notifications").insert([{type:"park_approval",title:"新しいドッグラン第二審査申請",message:`${C?.name}の第二審査が申請されました。確認してください。`,data:{park_id:h},created_at:(new Date).toISOString()}])}catch(t){}A("第二審査の申請が完了しました。審査結果をお待ちください。"),await de(),setTimeout(()=>{g("/dashboard")},3e3)}catch(r){P("審査申請に失敗しました: "+r.message)}finally{D(!1)}},isLoading:M,disabled:"second_stage_review"===C?.status||"approved"!==C?.status&&!X,className:""+("approved"===C?.status||X?"bg-blue-600 hover:bg-blue-700":"bg-gray-400 cursor-not-allowed"),children:M?"申請中...":"second_stage_review"===C?.status?"審査中です":"approved"===C?.status?"編集する":X?"第二審査を申請する":"スマートロック確認が必要です"})}),"approved"!==C?.status&&"second_stage_review"!==C?.status&&e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"inline-flex items-center space-x-2 px-3 py-2 rounded-lg text-sm "+(X?"bg-green-50 text-green-700 border border-green-200":"bg-yellow-50 text-yellow-700 border border-yellow-200"),children:X?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-4 h-4"}),e.jsx("span",{children:"申請準備完了"})]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:"スマートロック購入確認が必要です"})]})})})]}),e.jsx(c,{className:"bg-gray-50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(x,{className:"w-6 h-6 text-gray-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:"審査プロセスについて"}),e.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[e.jsx("p",{children:"• 第二審査では、施設の詳細画像と振込先情報を確認します"}),e.jsx("p",{children:"• 審査期間は通常3-5営業日です"}),e.jsx("p",{children:"• 画像に問題がある場合は再提出を求められることがあります"}),e.jsx("p",{children:"• 審査通過後、スマートロックシステムの実証検査の日程調整を行います"}),e.jsx("p",{children:"• 実証検査完了後、一般公開となります"})]})]})]})}),te&&ie&&e.jsx(d,{imageFile:ie,onCropComplete:async e=>{const s=new File([e],ie?.name||"image.jpg",{type:e.type}),a=le;if(re(!1),ne(""),ce(null),a)try{T(e=>e.map(e=>e.image_type===a?{...e,file:s,uploading:!0,error:void 0}:e));const e=s.name||"image.jpg",t=e.includes(".")?e.split(".").pop():"jpg",r=`${h}/${a}_${Date.now()}.${t}`,{error:l}=await i.storage.from("dog-park-images").upload(r,s);if(l)throw l;const{data:{publicUrl:n}}=i.storage.from("dog-park-images").getPublicUrl(r),c=E.find(e=>e.image_type===a);if(c?.id){const{error:e}=await i.from("dog_park_facility_images").update({image_url:n,is_approved:null,updated_at:(new Date).toISOString()}).eq("id",c.id);if(e)throw e}else{const{error:e}=await i.from("dog_park_facility_images").insert({park_id:h,image_type:a,image_url:n});if(e)throw e}await de();const d=S[a];A(`${d?.label||a}の画像をアップロードしました`),setTimeout(()=>A(""),3e3)}catch(t){T(e=>e.map(e=>e.image_type===a?{...e,file:s,uploading:!1,error:"アップロードに失敗しました。再度お試しください。"}:e))}},onCancel:()=>{re(!1),ne(""),ce(null)},aspectRatio:1,maxWidth:400,maxHeight:400})]}):e.jsxs("div",{className:"max-w-4xl mx-auto text-center py-12",children:[e.jsx(j,{className:"w-16 h-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"ドッグランが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"指定されたドッグランが見つからないか、アクセス権限がありません。"}),e.jsx(r,{to:"/owner-dashboard",children:e.jsx(l,{children:"ダッシュボードに戻る"})})]})}function O({className:s}){return e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:[e.jsx("path",{d:"M3 21h18"}),e.jsx("path",{d:"M3 10h18"}),e.jsx("path",{d:"M5 6l7-3 7 3"}),e.jsx("path",{d:"M4 10v11"}),e.jsx("path",{d:"M20 10v11"}),e.jsx("path",{d:"M8 14v3"}),e.jsx("path",{d:"M12 14v3"}),e.jsx("path",{d:"M16 14v3"})]})}export{C as ParkRegistrationSecondStage};
