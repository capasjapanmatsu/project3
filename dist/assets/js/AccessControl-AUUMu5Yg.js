var e=Object.defineProperty,s=(s,t,a)=>((s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a)(s,"symbol"!=typeof t?t+"":t,a);import{j as t}from"./motion-CuO0nkIV.js";import{r as a}from"./react-vendor-cniURDpR.js";import{a as r,c as i}from"./router-Cg6wfOY4.js";import{B as n,t as l}from"./Button-CJFAG6V0.js";import{s as c,u as d,a as o,C as m}from"./index-CVZFmpsT.js";import{L as u}from"./LazyImage-D-JxrRiD.js";import{g as x,V as h}from"./VaccineBadge-BFc_cRH8.js";import{u as g,r as y}from"./useRetryWithRecovery-CuoS1EBo.js";import{s as b,a as j}from"./safeStorage-B_ZrVCeK.js";import{af as f,ao as p,P as N,i as v,a4 as w,M as I,a5 as S,ax as _,at as k,ay as M,az as P,K as D}from"./ui-basic-CaMd9YQ-.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";class C extends Error{constructor(e,t){super(e),s(this,"code"),this.code=t,this.name="LocationError"}}const z=(e,s,t,a)=>{const r=E(t-e),i=E(a-s),n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(E(e))*Math.cos(E(t))*Math.sin(i/2)*Math.sin(i/2),l=6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)));return Math.round(100*l)/100},E=e=>e*(Math.PI/180),A=e=>e<1?`${Math.round(1e3*e)}m`:e<10?`${e.toFixed(1)}km`:`${Math.round(e)}km`,T={latitude:35.6812,longitude:139.7671};function G(){const{user:e,effectiveUserId:s}=d(),E=r(),[G]=i();o();const[Z,L]=a.useState([]),[O,q]=a.useState([]),[B,H]=a.useState([]),[J,U]=a.useState([]),[$,Q]=a.useState(null),[R,W]=a.useState(null),[Y,K]=a.useState(null),[V,F]=a.useState(!1),[X,ee]=a.useState(!1),[se,te]=a.useState(""),[ae,re]=a.useState(""),[ie,ne]=a.useState(!1),[le,ce]=a.useState(null),[de,oe]=a.useState(!1),[me,ue]=a.useState(1),[xe,he]=a.useState(null),[ge,ye]=a.useState(0),[be,je]=a.useState(null),[fe,pe]=a.useState("entry"),[Ne,ve]=a.useState(null),[we,Ie]=a.useState(null),[Se,_e]=a.useState(!1),{execute:ke,state:Me,reset:Pe}=g(y.api),De=async()=>{ee(!0);try{const e=await new Promise((e,s)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(s=>{e({latitude:s.coords.latitude,longitude:s.coords.longitude})},e=>{let t="位置情報の取得に失敗しました";switch(e.code){case e.PERMISSION_DENIED:t="位置情報の使用が拒否されました";break;case e.POSITION_UNAVAILABLE:t="位置情報が利用できません";break;case e.TIMEOUT:t="位置情報の取得がタイムアウトしました"}s(new C(t,e.code))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4}):s(new C("このブラウザは位置情報をサポートしていません",0))});K(e)}catch(e){K(T),e instanceof C&&1===e.code&&te("位置情報の使用が拒否されました。手動で施設を選択してください。")}finally{ee(!1)}},Ce=(e,s)=>{const t=((e,s)=>e.filter(e=>e.latitude&&e.longitude).map(e=>({...e,distance:z(s.latitude,s.longitude,e.latitude,e.longitude)})).sort((e,s)=>e.distance-s.distance))(e,s);H(t),t.length>0&&!$&&t[0]&&ze(t[0])},ze=e=>{Q(e),te(""),oe(!1),ue(1),W(null)},Ee=a.useCallback(async()=>{const t=e?.id||s;if(!t)return;const{data:a,error:r}=await c.from("dogs").select("\n        *,\n        vaccine_certifications (\n          id,\n          status,\n          rabies_expiry_date,\n          combo_expiry_date,\n          approved_at\n        )\n      ").eq("owner_id",t);if(r)throw new Error("ワンちゃんの情報を取得できませんでした。");const i=(a||[]).filter(e=>"approved"===x(e));L(i),b("accesscontrol_dogs",JSON.stringify({ts:Date.now(),dogs:i}),"sessionStorage"),a&&a.length>0&&0===i.length&&te("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")},[e,s]),Ae=a.useCallback(async()=>{_e(!1),Pe();const e=setTimeout(()=>_e(!0),2e3);try{await ke(Ee)}catch(s){te(s.message)}finally{clearTimeout(e),_e(!1),F(!1)}},[ke,Ee,Pe]);a.useEffect(()=>{const t=async()=>{try{let e=c.from("dog_parks").select("*").eq("status","approved");const{data:s,error:t}=await e;if(t){const e=[{id:"test-park-1",name:"テスト用ドッグラン",address:"東京都渋谷区1-1-1",city:"渋谷区",status:"approved",is_public:!0,latitude:35.658,longitude:139.7016,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}];return void q(e)}const a=s||[];q(a);const r=G.get("park");if(r){const e=a.find(e=>e.id===r);if(e){const s={...e,distance:0};ze(s)}}else if(we){const e=a.find(e=>e.id===we);if(e){pe("exit");const s={...e,distance:0};ze(s)}}}catch(e){}},a=async()=>{const t=e?.id||s;if(t)try{const e=await(async e=>{try{let s=!1;try{const{data:e}=await c.from("stripe_user_subscriptions").select("status").maybeSingle();!e||"active"!==e.status&&"trialing"!==e.status||(s=!0)}catch{}if(!s){const{data:t}=await c.from("stripe_customers").select("customer_id").eq("user_id",e).maybeSingle();if(t?.customer_id){const{data:e}=await c.from("stripe_subscriptions").select("status").eq("customer_id",t.customer_id).in("status",["active","trialing"]).maybeSingle();e&&(s=!0)}}if(s)return{hasSubscription:!0,hasDayPass:!1,needsPayment:!1,paymentType:"subscription"};const{data:t,error:a}=await c.from("entrance_qr_codes").select("*").eq("user_id",e).eq("status","active").gt("valid_until",(new Date).toISOString()).maybeSingle(),r=t;return t&&r?{hasSubscription:!1,hasDayPass:!0,validUntil:r.valid_until,needsPayment:!1,paymentType:"admin_grant"===r.payment_type?"admin_grant":"day_pass"}:{hasSubscription:!1,hasDayPass:!1,needsPayment:!0}}catch(se){return{hasSubscription:!1,hasDayPass:!1,needsPayment:!0}}})(t);ce(e)}catch(a){ce({hasSubscription:!1,hasDayPass:!1,needsPayment:!0})}};(async()=>{if(!(e?.id||s))return;try{const e=j("accesscontrol_dogs","sessionStorage");if(e){const s=JSON.parse(e);Array.isArray(s?.dogs)&&(L(s.dogs),F(!1))}}catch{}_e(!1);const r=setTimeout(()=>_e(!0),2e3);try{await ke(Ee)}catch(n){te(n.message)}finally{clearTimeout(r),_e(!1),F(!1)}const i=[t(),a(),De()];Promise.allSettled(i)})()},[e]),a.useEffect(()=>{if(Y&&O.length>0){(async()=>{await new Promise(e=>setTimeout(e,10)),Ce(O,Y)})()}},[Y,O]);const Te=a.useCallback(async()=>{try{const t=e?.id||s;if(!t)return;const{data:a}=await c.from("user_entry_status").select("is_inside, park_id").eq("user_id",t).maybeSingle();a&&(je(!!a.is_inside),pe(a.is_inside?"exit":"entry"),a.park_id&&Ie(a.park_id))}catch(t){}},[e,s]),Ge=a.useCallback(async()=>{try{if(!$)return;const{data:e}=await c.from("dog_parks").select("current_occupancy, max_capacity").eq("id",$.id).maybeSingle();e&&ve({current:e.current_occupancy,max:e.max_capacity})}catch(e){}},[$]);a.useEffect(()=>{Te()},[Te]),a.useEffect(()=>{Ge()},[Ge]),a.useEffect(()=>{if(!xe)return;const e=setInterval(()=>{const s=Math.max(0,Math.ceil((3e3-(Date.now()-xe))/1e3));ye(s),0===s&&clearInterval(e)},250);return()=>clearInterval(e)},[xe]);const Ze=a.useCallback(e=>{U(s=>s.includes(e)?s.filter(s=>s!==e):s.length<3?[...s,e]:s)},[]),Le=a.useCallback(()=>J.map(e=>{const s=Z.find(s=>s.id===e);return s?`${s.name}${Oe(s.gender)}`:""}).filter(Boolean).join("、"),[J,Z]),Oe=a.useCallback(e=>"オス"===e?"くん":"ちゃん",[]),qe=a.useMemo(()=>{if(!le)return"";if(le.hasSubscription)return"✅ サブスクリプション会員（全国利用可能）";if(le.hasDayPass){return`✅ 1Dayパス利用可能（${le.validUntil?new Date(le.validUntil).toLocaleString("ja-JP"):""}まで）`}return"⚠️ 利用にはサブスクリプションまたは1Dayパスが必要です"},[le]);return V?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"flex items-center mb-6",children:[t.jsxs(n,{variant:"primary",size:"sm",onClick:()=>E(-1),className:"mr-3",children:[t.jsx(f,{className:"w-4 h-4 mr-2"}),"戻る"]}),t.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),se&&t.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:se}),ae&&t.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:ae}),le&&t.jsx(m,{className:"p-4 mb-6 bg-blue-50 border-blue-200",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx(p,{className:"w-5 h-5 text-blue-600 mr-2"}),t.jsx("span",{className:"text-sm text-blue-800",children:qe})]})}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs(m,{className:"p-6",children:[t.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[t.jsx(N,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),Se&&t.jsxs("div",{className:"mb-4 p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200 text-sm",children:["情報の取得に時間がかかっています。通信環境をご確認の上、",t.jsx("button",{className:"underline ml-1",onClick:Ae,children:"再試行"}),"してください。"]}),0===Z.length?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(v,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),t.jsx(n,{onClick:()=>E("/dog-registration"),children:"ワンちゃんを登録する"})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mb-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-3",children:[t.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",3,"頭）"]}),t.jsxs("div",{className:"text-sm text-gray-600",children:[J.length,"/",3,"頭選択中"]})]}),t.jsx("div",{className:"grid grid-cols-1 gap-4",children:Z.map(e=>{const s=J.includes(e.id),a=!s&&J.length>=3;return t.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(s?"border-green-500 bg-green-50":a?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>!a&&Ze(e.id),children:[s&&t.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:t.jsx(w,{className:"w-4 h-4"})}),t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?t.jsx(u,{src:e.image_url,alt:e.name,width:48,height:48,loading:"lazy",priority:!1,className:"w-full h-full object-cover rounded-full",placeholderSrc:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPGVsbGlwc2UgY3g9IjEyIiBjeT0iMTMiIHJ4PSIxMCIgcnk9IjQiLz4KPHBhdGggZD0ibTEyIDEzIDQuNS05IDQuNSA5Ii8+CjxwYXRoIGQ9Im0xMiAxMyA0LjUtOUw3IDEzIi8+CjxwYXRoIGQ9Im0xMiAxM0w3IDQgNy41IDEzIi8+Cjwvc3ZnPgo8L3N2Zz4K"}):t.jsx(N,{className:"w-6 h-6 text-gray-500"})}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[t.jsxs("h3",{className:"font-semibold",children:[e.name,Oe(e.gender)]}),t.jsx(h,{status:x(e),size:"sm"})]}),t.jsxs("p",{className:"text-sm text-gray-600",children:[e.breed," • ",e.gender]})]})]})]},e.id)})})]}),J.length>0&&t.jsx("div",{className:"p-3 bg-green-50 rounded-lg",children:t.jsxs("p",{className:"text-sm text-green-800",children:[t.jsx("strong",{children:"選択中:"})," ",Le]})})]})]}),t.jsxs(m,{className:"p-6",children:[t.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[t.jsx(I,{className:"w-5 h-5 text-blue-600 mr-2"}),"利用する施設を選択"]}),X&&t.jsxs("div",{className:"flex items-center justify-center py-4 text-blue-600",children:[t.jsx(S,{className:"w-4 h-4 animate-spin mr-2"}),"現在位置を取得中..."]}),0===B.length?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(v,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 mb-4",children:"利用可能な施設がありません"}),t.jsx(n,{onClick:()=>E("/parks"),children:"ドッグラン一覧を見る"})]}):t.jsxs("div",{className:"space-y-3",children:[de?(()=>{const e=B.slice(3),s=10*(me-1),a=s+10,r=e.slice(s,a),i=Math.ceil(e.length/10);return t.jsxs("div",{className:"space-y-3",children:[r.map(e=>t.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+($?.id===e.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>ze(e),children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"font-semibold mb-1",children:e.name}),t.jsx("p",{className:"text-sm text-gray-600 mb-2",children:e.address}),t.jsxs("div",{className:"flex items-center text-sm text-blue-600",children:[t.jsx(S,{className:"w-4 h-4 mr-1"}),"約 ",A(e.distance)]})]}),$?.id===e.id&&t.jsx(w,{className:"w-6 h-6 text-blue-500 flex-shrink-0 ml-2"})]})},e.id)),i>1&&t.jsxs("div",{className:"flex justify-center items-center space-x-2 pt-2",children:[t.jsx(n,{variant:"secondary",size:"sm",disabled:1===me,onClick:()=>ue(e=>e-1),children:"前の10件"}),t.jsxs("span",{className:"text-sm text-gray-600",children:[me," / ",i]}),t.jsx(n,{variant:"secondary",size:"sm",disabled:me===i,onClick:()=>ue(e=>e+1),children:"次の10件"})]})]})})():B.slice(0,3).map(e=>t.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+($?.id===e.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>ze(e),children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"font-semibold mb-1",children:e.name}),t.jsx("p",{className:"text-sm text-gray-600 mb-2",children:e.address}),t.jsxs("div",{className:"flex items-center text-sm text-blue-600",children:[t.jsx(S,{className:"w-4 h-4 mr-1"}),"約 ",A(e.distance)]})]}),$?.id===e.id&&t.jsx(w,{className:"w-6 h-6 text-blue-500 flex-shrink-0 ml-2"})]})},e.id)),B.length>3&&t.jsx(n,{variant:"secondary",className:"w-full",onClick:()=>{oe(!de),de||ue(1)},children:de?t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"w-4 h-4 mr-2"}),"近い順",3,"件のみ表示"]}):t.jsxs(t.Fragment,{children:[t.jsx(k,{className:"w-4 h-4 mr-2"}),"その他の施設を表示（",B.length-3,"件）"]})})]})]})]}),t.jsx("div",{className:"space-y-6",children:t.jsxs(m,{className:"p-6",children:[t.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[t.jsx(M,{className:"w-5 h-5 text-blue-600 mr-2"}),"入退場操作"]}),$&&J.length>0?t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm bg-gray-50 border border-gray-200 rounded-md p-3",children:[t.jsx("span",{className:"text-gray-700",children:"現在の入場者数"}),t.jsxs("span",{className:"font-semibold text-gray-900",children:[Ne?.current??"-",Ne?.max?` / ${Ne.max}`:""]})]}),t.jsxs("div",{className:"flex justify-center gap-2",children:[t.jsx(n,{variant:"entry"===fe?"primary":"secondary",size:"sm",onClick:()=>pe("entry"),children:"入場"}),t.jsx(n,{variant:"exit"===fe?"danger":"secondary",size:"sm",onClick:()=>pe("exit"),children:"退場"})]}),t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsxs("button",{type:"button","aria-label":"entry"===fe?"入場する":"退場する",onClick:async()=>{if(!(ie||ge>0)){try{await l("exit"===fe?"heavy":"medium")}catch{}await(async()=>{if($&&0!==J.length)if("entry"!==fe||le&&!le.needsPayment)if(Y){if($?.latitude&&$?.longitude){const e=z(Y.latitude,Y.longitude,$.latitude,$.longitude),s=$.geofence_radius_km??1;if(e>s)return void te(`この施設から${e.toFixed(2)}km離れています。解錠は${s}km以内でのみ可能です（推奨1.0km）。`)}ne(!0),te(""),re("");try{const{data:t}=await c.from("smart_locks").select("*").eq("park_id",$.id).eq("pin_enabled",!0),a="entry"===fe?"entry":"exit",r=(t||[]).find(e=>e.purpose===a)||(t||[]).find(e=>"entry"===e.purpose)||(t||[])[0];if(!r)return void te("この施設にはスマートロックが未登録です。管理者側で設定が必要です。");const{data:{session:i}}=await c.auth.getSession();if(!i?.access_token)throw new Error("認証が必要です");const n=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/ttlock-unlock",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({lockId:r.lock_id,userId:e?.id||s,purpose:fe,userLat:Y.latitude,userLng:Y.longitude,radiusKm:1})}),l=await n.json();if(!n.ok||!l?.success)throw new Error(l?.error||"解錠に失敗しました");re("entry"===fe?"入場が完了しました。ドアをお開けください。":"退場が完了しました。ドアをお開けください。"),je("entry"===fe),pe(e=>"entry"===e?"exit":"entry"),await Te(),await Ge()}catch(t){te(t.message)}finally{ne(!1),he(Date.now())}}else te("解錠には位置情報（GPS）の許可が必要です。設定 > 位置情報 で有効化し、ブラウザに許可してください。");else E(`/parks/${$.id}/reserve`);else te("犬と施設を選択してください")})()}},disabled:ie||ge>0,className:"relative w-40 h-40 rounded-full text-white shadow-lg select-none outline-none focus:ring-4 transition active:scale-95 "+(ie||ge>0?("entry"===fe?"bg-blue-400":"bg-red-400")+" cursor-not-allowed":"entry"===fe?"from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 bg-gradient-to-b focus:ring-blue-300":"from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 bg-gradient-to-b focus:ring-red-300"),children:[ie?t.jsx(P,{className:"w-10 h-10 animate-spin mx-auto"}):t.jsx(M,{className:"w-12 h-12 mx-auto"}),ie&&t.jsx("span",{className:"absolute inset-0 rounded-full ring-4 animate-ping "+("entry"===fe?"ring-blue-300":"ring-red-300")})]}),t.jsx("div",{className:"mt-3 text-sm text-gray-700",children:ie?("entry"===fe?"入場":"退場")+"処理中...":ge>0?`再試行まで ${ge}秒`:("entry"===fe?"入場":"退場")+"（タップで解錠）"}),t.jsxs("div",{className:"mt-2 text-xs text-gray-600 text-center leading-relaxed",children:["・解錠ボタンを押した後、数秒時間がかかる場合があります。",t.jsx("br",{}),"・マナーを守ってお楽しみください。"]}),be&&t.jsxs("div",{className:"mt-2 text-xs text-red-600",children:["入場中","exit"===fe&&t.jsx("button",{className:"ml-2 underline",onClick:()=>pe("entry"),children:"入場を再試行"})]})]})]}):t.jsxs("div",{className:"text-center py-8",children:[t.jsx(D,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 mb-2",children:"利用するには："}),t.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[t.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),t.jsx("li",{children:"• 施設を選択"})]})]})]})})]})]})}export{G as AccessControl};
