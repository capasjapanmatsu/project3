import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{B as t}from"./Button-CJFAG6V0.js";import{u as r,S as a,C as i,s as n}from"./index-DN5wQuSm.js";import{a as o}from"./router-Cg6wfOY4.js";import{p as l}from"./ui-basic-CaMd9YQ-.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function c(){const{user:c,lineUser:d,effectiveUserId:m}=r(),u=o(),[x,h]=s.useState({category:"ご要望",message:""}),[p,f]=s.useState(!1),[g,j]=s.useState(""),[b,y]=s.useState(""),[w,v]=s.useState(!1),[N,k]=s.useState([]);s.useEffect(()=>{c||d||m||u("/liff/login")},[c,d,m,u]),s.useEffect(()=>{const e=e=>{e.preventDefault(),e.returnValue=""};return(p||w)&&window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[p,w]);const S=async e=>{e&&0!==e.length&&k(s=>[...s,...Array.from(e)])};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[(p||w)&&e.jsx("div",{className:"fixed inset-0 z-50 bg-white/70 backdrop-blur-sm flex items-center justify-center",children:e.jsxs("div",{className:"bg-white border rounded-xl px-6 py-4 shadow-sm text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("div",{className:"text-sm text-gray-700",children:"送信処理中です。画面を離れないでください。"})]})}),e.jsx(a,{title:"要望・お問い合わせ",description:"アプリへのご要望やお問い合わせはこちらから"}),e.jsx("div",{className:"max-w-2xl mx-auto px-4 py-8",children:e.jsxs(i,{className:"p-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"要望・お問い合わせ"}),g&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded text-green-800",children:g}),b&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-800",children:b}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),f(!0),y("");try{const e=c?.id||d?.app_user_id||d?.id||m;if(!e)throw new Error("ログインが必要です");const{data:t}=await n.from("profiles").select("id").eq("user_type","admin").limit(1).maybeSingle(),r=t?.id;if(!r)throw new Error("管理者ユーザーが見つかりません");const a=`[${x.category}]\n\n${x.message}`,{data:i,error:o}=await n.from("messages").insert({sender_id:e,receiver_id:r,content:a}).select("id").single();if(o||!i)throw o;if(N.length>0)for(const s of N){const e=s.name.split(".").pop()?.toLowerCase()||"bin",t=`${i.id}/${Date.now()}_${encodeURIComponent(s.name)}`,{error:r}=await n.storage.from("message-attachments").upload(t,s,{upsert:!0,contentType:s.type});if(r)throw r;const{data:a}=n.storage.from("message-attachments").getPublicUrl(t),o=s.type.startsWith("image/")?"image":"pdf"===e?"pdf":"other";await n.from("message_attachments").insert({message_id:i.id,file_url:a.publicUrl,file_type:o,file_name:s.name})}try{(await fetch("/.netlify/functions/app-notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:r,title:"新規お問い合わせ",message:`${x.category} の問い合わせ`,linkUrl:`${window.location.origin}/community`,kind:"inquiry"})})).ok}catch(s){}sessionStorage.setItem("communityActiveTab","messages"),j("送信しました。コミュニティのメッセージに履歴を作成しました。"),h({category:"ご要望",message:""}),k([]),u("/community")}catch(t){y(t instanceof Error?t.message:"送信に失敗しました")}finally{f(!1)}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"カテゴリー"}),e.jsxs("select",{value:x.category,onChange:e=>h({...x,category:e.target.value}),className:"w-full border rounded px-3 py-2",children:[e.jsx("option",{value:"ご要望",children:"ご要望"}),e.jsx("option",{value:"不具合",children:"不具合"}),e.jsx("option",{value:"その他",children:"その他"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容"}),e.jsx("textarea",{value:x.message,onChange:e=>h({...x,message:e.target.value}),rows:6,placeholder:"できるだけ具体的にご記入ください",className:"w-full border rounded px-3 py-2",required:!0})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:N.length>0?`添付: ${N.length}件`:""}),e.jsxs(t,{type:"submit",disabled:p,children:[e.jsx(l,{className:"w-4 h-4 mr-1"}),p?"送信中...":"送信する"]})]}),e.jsxs("div",{className:"pt-2",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("label",{className:"inline-flex items-center justify-center w-10 h-10 rounded-full border cursor-pointer bg-white",title:"ファイルを選択",children:[e.jsx("input",{type:"file",accept:"image/*,application/pdf",multiple:!0,className:"hidden",onChange:e=>S(e.target.files)}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-700",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M21.44 11.05l-9.19 9.19a5 5 0 01-7.07-7.07l9.19-9.19a3.5 3.5 0 014.95 4.95L8.46 19.04a2 2 0 11-2.83-2.83l8.49-8.49"})})]}),e.jsxs("label",{className:"inline-flex items-center justify-center w-10 h-10 rounded-full border cursor-pointer bg-white",title:"カメラで撮影",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",className:"hidden",onChange:e=>S(e.target.files)}),e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-700",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h3l2-3h8l2 3h3a2 2 0 012 2z"}),e.jsx("circle",{cx:"12",cy:"13",r:"4"})]})]})]}),w&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"アップロード中..."})]})]})]})})]})}export{c as default};
