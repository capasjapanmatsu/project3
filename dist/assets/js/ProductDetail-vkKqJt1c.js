import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{d as t,a,L as i}from"./router-Cg6wfOY4.js";import{B as r}from"./Button-6ascT97E.js";import{u as l,b as n,s as c,C as o,l as d}from"./index-hxb5tPha.js";import{n as m}from"./notification-BEazPlEb.js";import{af as x,al as h,O as p,ag as u,ah as g,t as b,e as j,i as f,am as y,o as N,d as v,an as w,X as k}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function _(){const{id:_}=t(),{user:S}=l(),C=a(),[O,E]=s.useState(null),[$,q]=s.useState([]),[T,z]=s.useState(1),[I,F]=s.useState(!0),{isActive:J}=n(),[R,L]=s.useState([]),[A,W]=s.useState(0),[M,P]=s.useState(!1),[B,U]=s.useState(""),[X,G]=s.useState(""),[V,Y]=s.useState(""),[Z,D]=s.useState(!1),[H,Q]=s.useState(0),[K,ee]=s.useState(0);s.useEffect(()=>{_&&te()},[_,S]);const se=e=>{if(!e)return"";try{const s=JSON.parse(e);if(Array.isArray(s)&&s.length>0)return s[0]}catch{}return e},te=async()=>{try{const[e,s,t]=await Promise.all([c.from("products").select("*").eq("id",_).eq("is_active",!0).single(),S?c.from("cart_items").select("*, product:products(*)").eq("user_id",S?.id):Promise.resolve({data:[]}),c.from("product_images").select("*").eq("product_id",_).order("display_order",{ascending:!0})]);if(e.error)return void C("/petshop");E(e.data),q(s.data||[]);const a=[];if(e.data.image_url)try{const s=JSON.parse(e.data.image_url);Array.isArray(s)?s.forEach((e,s)=>{"string"==typeof e&&e&&a.push({id:`main-${s}`,url:e})}):"string"==typeof e.data.image_url&&a.push({id:"main-0",url:e.data.image_url})}catch{a.push({id:"main-0",url:se(e.data.image_url)})}!t.error&&t.data&&t.data.forEach(e=>{e?.image_url&&a.push({id:e.id,url:e.image_url})});const i=[],r=new Set;for(const l of a)r.has(l.url)||(r.add(l.url),i.push(l));L(i)}catch(e){C("/petshop")}finally{F(!1)}},ae=async()=>{if(S){G("");try{const e=$.find(e=>e.product_id===O?.id);if(e){const{error:s}=await c.from("cart_items").update({quantity:e.quantity+T}).eq("id",e.id);if(s)throw s}else{const{error:e}=await c.from("cart_items").insert([{user_id:S.id,product_id:O.id,quantity:T}]);if(e)throw e}await te(),O?.id&&(e=>{const s=document.querySelector(`img[data-product-id="${e}"]`);if(!s)return;const t=s.getBoundingClientRect(),a=document.createElement("div");Object.assign(a.style,{position:"fixed",inset:"0",pointerEvents:"none",zIndex:"9999",contain:"paint",backfaceVisibility:"hidden"}),document.body.appendChild(a);const i=new Image;i.src=s.src;const r=window.scrollY||window.pageYOffset,l={htmlOverflow:document.documentElement.style.overflow,bodyPosition:document.body.style.position,bodyTop:document.body.style.top,bodyWidth:document.body.style.width,bodyPaddingRight:document.body.style.paddingRight},n=window.innerWidth-document.documentElement.clientWidth;document.documentElement.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${r}px`,document.body.style.width="100%",n>0&&(document.body.style.paddingRight=`${n}px`);try{document.activeElement?.blur()}catch{}const c=.8;Object.assign(i.style,{position:"absolute",transformOrigin:"top left",opacity:"0.9",borderRadius:"8px",pointerEvents:"none",willChange:"transform, opacity",backfaceVisibility:"hidden",boxShadow:"0 12px 24px rgba(0,0,0,0.35)",transform:`translate3d(${t.left}px, ${t.top}px, 0) scale(0.8, 0.8)`}),a.appendChild(i);const o=document.querySelector('[data-cart-target="true"]'),d=o?o.getBoundingClientRect():{left:window.innerWidth-40,top:20,width:20,height:20},m=window.innerWidth/2-t.width*c/2,x=window.innerHeight/2-t.height*c/2,h=d.left+d.width/2-(t.left+t.width*c/2),p=d.top+d.height/2-(t.top+t.height*c/2),u=()=>{i.animate([{transform:`translate3d(${t.left}px, ${t.top}px, 0) scale(0.8, 0.8)`,opacity:.9},{transform:`translate3d(${m}px, ${x}px, 0) scale(0.8, 0.8)`,opacity:.85,offset:.5},{transform:`translate3d(${t.left+h}px, ${t.top+p}px, 0) scale(0.2, 0.2)`,opacity:0}],{duration:3e3,easing:"cubic-bezier(0.16, 0.84, 0.3, 1)",fill:"forwards"}).addEventListener("finish",()=>{a.remove(),document.documentElement.style.overflow=l.htmlOverflow,document.body.style.position=l.bodyPosition,document.body.style.top=l.bodyTop,document.body.style.width=l.bodyWidth,document.body.style.paddingRight=l.bodyPaddingRight,window.scrollTo(0,r)})};i.complete?u():i.onload=()=>u()})(O.id),m.success("カートに追加しました！"),G("")}catch(e){d.error("Error adding to cart:",e),m.error("カートへの追加に失敗しました。")}}else C("/login")},ie=()=>{W(e=>(e+1)%R.length)},re=()=>{W(e=>(e-1+R.length)%R.length)},le=e=>{ee(0),Q(e.targetTouches[0].clientX)},ne=e=>{ee(e.targetTouches[0].clientX)},ce=()=>{if(!H||!K)return;const e=H-K,s=e<-50;e>50&&R.length>0&&ie(),s&&R.length>0&&re()};if(I)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})});if(!O)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-600",children:"商品が見つかりませんでした"}),e.jsx(r,{onClick:()=>C("/petshop"),className:"mt-4",children:"ショップに戻る"})]});const oe=O.price,de=(me=oe,J?Math.round(.9*me):me);var me;const xe=J&&de<oe,he=(()=>{const e=$.find(e=>e.product_id===O?.id);return e?e.quantity:0})();return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("button",{onClick:()=>C("/petshop"),className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"ショップに戻る"]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",onTouchStart:le,onTouchMove:ne,onTouchEnd:ce,children:[R.length>0?e.jsxs(e.Fragment,{children:[e.jsx("img",{"data-product-id":O.id,src:R[A].url,alt:O.name,className:"w-full h-96 object-cover rounded-lg shadow-lg cursor-pointer",onClick:()=>(W(A),void P(!0)),onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),R.length>1&&e.jsx("div",{className:"absolute bottom-4 left-0 right-0 flex justify-center",children:e.jsxs("div",{className:"bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm",children:[A+1,"/",R.length]})})]}):e.jsx("div",{className:"w-full h-96 bg-gray-200 rounded-lg flex items-center justify-center",children:e.jsx(h,{className:"w-16 h-16 text-gray-400"})}),xe&&e.jsx("div",{className:"absolute top-6 left-6",children:e.jsxs("span",{className:"bg-purple-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center",children:[e.jsx(p,{className:"w-4 h-4 mr-1"}),"10%OFF"]})}),O.stock_quantity<=5&&e.jsx("div",{className:"absolute top-6 right-6",children:e.jsxs("span",{className:"bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium",children:["残り",O.stock_quantity,"個"]})}),R.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:re,className:"absolute left-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-75 rounded-full p-2 hover:bg-opacity-100 transition-opacity",children:e.jsx(u,{className:"w-5 h-5 text-gray-800"})}),e.jsx("button",{onClick:ie,className:"absolute right-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-75 rounded-full p-2 hover:bg-opacity-100 transition-opacity",children:e.jsx(g,{className:"w-5 h-5 text-gray-800"})})]})]}),R.length>1&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:R.slice(0,10).map((s,t)=>e.jsx("div",{className:"flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden cursor-pointer border-2 transition-all "+(t===A?"border-green-500 shadow-md":"border-gray-200 hover:border-gray-300"),onClick:()=>W(t),children:e.jsx("img",{src:s.url,alt:`${O.name} - ${t+1}/${R.length}`,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})},t))})})]}),e.jsxs("div",{className:"space-y-6",children:[J&&e.jsx("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスク会員特典: 10%OFF"})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded text-sm",children:(ge=O.category,{food:"ドッグフード",treats:"おやつ",toys:"おもちゃ",accessories:"アクセサリー",health:"ヘルスケア",sheets:"ペットシーツ"}[ge]||ge)}),O.brand&&e.jsx("span",{className:"text-gray-500 text-sm",children:O.brand})]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:O.name}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("span",{className:"text-3xl font-bold text-green-600",children:["¥",de.toLocaleString()]}),xe&&e.jsxs("span",{className:"text-xl text-gray-500 line-through",children:["¥",oe.toLocaleString()]})]}),J&&e.jsx("p",{className:"text-sm text-purple-600 mt-1",children:"サブスク会員価格"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[O.weight&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:["内容量: ",O.weight,"g"]})]}),O.size&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:["サイズ: ",O.size]})]}),O.age_group&&"all"!==O.age_group&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(b,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:["対象年齢: ",(ue=O.age_group,{puppy:"子犬",adult:"成犬",senior:"シニア犬",all:"全年齢"}[ue]||ue)]})]}),O.dog_size&&"all"!==O.dog_size&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:["対象サイズ: ",(pe=O.dog_size,{small:"小型犬",medium:"中型犬",large:"大型犬",all:"全サイズ"}[pe]||pe)]})]})]}),e.jsx("div",{className:"mb-6",children:O.stock_quantity>0?e.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[e.jsx(h,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"在庫あり"})]}):e.jsxs("div",{className:"flex items-center space-x-2 text-red-600",children:[e.jsx(h,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"在庫切れ"})]})}),O.has_variations&&O.variations&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[O.variation_type||"バリエーション"," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:JSON.parse(O.variations||"[]").map((s,t)=>e.jsxs("button",{onClick:()=>{U(s.sku),G("")},className:"p-3 border rounded-lg text-left transition-all "+(B===s.sku?"border-green-500 bg-green-50 text-green-700":"border-gray-300 hover:border-green-400"),children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:["SKU: ",s.sku]})]},t))}),X&&e.jsxs("p",{className:"text-red-500 text-sm mt-2 flex items-center",children:[e.jsx(f,{className:"w-4 h-4 mr-1"}),X]})]}),O.stock_quantity>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"数量"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>z(Math.max(1,T-1)),className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(y,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-xl font-medium w-12 text-center",children:T}),e.jsx("button",{onClick:()=>z(Math.min(O.stock_quantity,T+1)),className:"w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(N,{className:"w-4 h-4"})})]}),he>0&&e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["カートに",he,"個入っています"]})]}),e.jsx("div",{className:"space-y-3",children:O.stock_quantity>0?e.jsxs(e.Fragment,{children:[e.jsx(r,{onClick:async()=>{await ae(),C("/cart")},className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",children:"今すぐ購入"}),e.jsxs(r,{onClick:ae,variant:"secondary",className:"w-full text-lg py-3",children:[e.jsx(v,{className:"w-5 h-5 mr-2"}),"カートに追加"]}),O.subscription_enabled&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"定期購入のプランを選択"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:(O.subscription_options||[]).map(s=>e.jsxs("button",{onClick:()=>Y(s.id),className:"p-3 border rounded-lg text-left transition-all "+(V===s.id?"border-amber-500 bg-amber-50 text-amber-700":"border-gray-300 hover:border-amber-400"),children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.interval_months,"ヶ月ごと"]}),e.jsxs("div",{className:"text-sm font-semibold text-amber-700 mt-1",children:["¥",Number(s.unit_price).toLocaleString()]})]},s.id))})]}),e.jsx(r,{onClick:async()=>{if(!S)return void C("/login");if(!O?.subscription_enabled)return;const e=(O.subscription_options||[]).find(e=>e.id===V);if(e)try{D(!0);const{data:s}=await c.auth.getSession(),t=s.session?.access_token||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU",a=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({mode:"subscription",success_url:`${window.location.origin}/order-history`,cancel_url:`${window.location.origin}/products/${O.id}`,subscription:{product_id:O.id,option_id:e.id,name:`${O.name} - ${e.name}`,interval_months:e.interval_months,unit_price:e.unit_price}})}),i=await a.json();if(!a.ok)throw new Error(i.error||"定期購入の開始に失敗しました");i.url?window.location.href=i.url:m.error("チェックアウトURLの取得に失敗しました")}catch(s){d.error("subscribe error",s),m.error("定期購入の開始に失敗しました")}finally{D(!1)}else m.error("定期購入プランを選択してください")},className:"w-full bg-amber-600 hover:bg-amber-700 text-lg py-3",isLoading:Z,children:"定期購入に申し込む"})]})]}):e.jsx(r,{disabled:!0,className:"w-full text-lg py-3",children:"在庫切れ"})})]})]})]}),e.jsxs("div",{className:"mt-12 grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(o,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"商品説明"}),e.jsx("p",{className:"text-gray-700 leading-relaxed whitespace-pre-line",children:O.description}),O.ingredients&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"原材料"}),e.jsx("p",{className:"text-gray-700 text-sm",children:O.ingredients})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(w,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"})]})]})]})}),e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(j,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-green-900 mb-1",children:"品質保証"}),e.jsxs("div",{className:"text-sm text-green-800 space-y-1",children:[e.jsx("p",{children:"• 厳選された安全な原材料のみ使用"}),e.jsx("p",{children:"• 品質に問題がある場合は返品・交換対応"}),e.jsx("p",{children:"• 愛犬の健康を第一に考えた商品選定"})]})]})]})}),J?e.jsx(o,{className:"p-4 bg-purple-50 border-purple-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(p,{className:"w-5 h-5 text-purple-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-purple-900 mb-1",children:"会員特典"}),e.jsxs("div",{className:"text-sm text-purple-800 space-y-1",children:[e.jsx("p",{children:"• 全商品10%OFF"}),e.jsx("p",{children:"• 送料無料"}),e.jsx("p",{children:"• 優先カスタマーサポート"})]})]})]})}):e.jsx(o,{className:"p-4 bg-purple-50 border-purple-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(p,{className:"w-5 h-5 text-purple-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-purple-900 mb-1",children:"サブスク会員になると"}),e.jsxs("div",{className:"text-sm text-purple-800 space-y-1 mb-3",children:[e.jsx("p",{children:"• 全商品10%OFF"}),e.jsx("p",{children:"• 送料無料"}),e.jsx("p",{children:"• ドッグラン使い放題"})]}),e.jsx(i,{to:"/subscription-intro",children:e.jsxs(r,{size:"sm",className:"w-full bg-purple-600 hover:bg-purple-700",children:[e.jsx(p,{className:"w-3 h-3 mr-1"}),"詳細を見る"]})})]})]})})]})]}),M&&e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50",onTouchStart:le,onTouchMove:ne,onTouchEnd:ce,children:[e.jsx("button",{onClick:()=>P(!1),className:"absolute top-4 right-4 text-white bg-black bg-opacity-50 shadow-lg rounded-full p-3 hover:bg-opacity-70 transition-all z-10",children:e.jsx(k,{className:"w-6 h-6"})}),R.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:re,className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-50 shadow-lg rounded-full p-3 hover:bg-opacity-70 transition-all hidden md:block",children:e.jsx(u,{className:"w-6 h-6"})}),e.jsx("button",{onClick:ie,className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-50 shadow-lg rounded-full p-3 hover:bg-opacity-70 transition-all hidden md:block",children:e.jsx(g,{className:"w-6 h-6"})})]}),e.jsx("img",{src:R[A].url,alt:O.name,className:"max-h-[85vh] max-w-[95vw] object-contain",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),e.jsx("div",{className:"absolute bottom-6 left-0 right-0 text-center",children:e.jsxs("div",{className:"bg-black bg-opacity-60 text-white px-4 py-2 rounded-full text-sm inline-block",children:[A+1," / ",R.length]})}),R.length>1&&e.jsx("div",{className:"absolute top-6 left-0 right-0 text-center md:hidden",children:e.jsx("div",{className:"bg-black bg-opacity-60 text-white px-3 py-1 rounded-full text-xs inline-block",children:"← スワイプして画像を切り替え →"})})]})]});var pe,ue,ge}export{_ as ProductDetail};
