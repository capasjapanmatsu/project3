import{j as e}from"./motion-CuO0nkIV.js";import{r}from"./react-vendor-cniURDpR.js";import{a,L as t}from"./router-Cg6wfOY4.js";import{B as i}from"./Button-6ascT97E.js";import{u as s,S as n,C as l,s as o,l as c}from"./index-hxb5tPha.js";import{I as d}from"./ImageCropper-C1jlYJ5u.js";import{I as m}from"./Input-D7pb8xRh.js";import{S as u}from"./Select-Dd_IZFKg.js";import{d as b}from"./dogBreeds-6lxY8Uni.js";import{e as h}from"./profiles-BHVxtPoM.js";import{n as x}from"./notification-BEazPlEb.js";import{u as g,g as f}from"./webpConverter-ofCI6dMZ.js";import{af as p,X as j,C as v}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";const y=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}},w=async(e,r,a="mixed")=>{try{const t=r,i=y(e);if(!i.isValid)throw new Error(i.error);const s=`${Date.now()}-${crypto.randomUUID?.()||Math.random().toString(36).slice(2)}`,n="rabies"===a?"rabies":"combo"===a?"combo":"mixed",l=`${t}_${n}_${s}`,o=`${t}/${n}/${l}.jpg`,c=await g("vaccine-certs",e,o,{quality:80,generateThumbnail:!0,thumbnailSize:300,keepOriginal:!1,upsert:!1,cacheControl:"0"});if(!c.success)throw new Error(c.error||"アップロードに失敗しました");return{success:!0,publicUrl:c.webpUrl||c.originalUrl,fileName:`${l}.jpg`,filePath:c.webpPath||c.originalPath,thumbnailUrl:c.thumbnailUrl}}catch(t){return{success:!1,error:t instanceof Error?t.message:"アップロードに失敗しました"}}};function N(){const{user:N,lineUser:$,effectiveUserId:D}=s(),I=a(),[C,S]=r.useState(!1),[E,V]=r.useState(""),[_,U]=r.useState(!1),k=r.useRef(!1),[q,M]=r.useState(null),[Y,F]=r.useState(null),[R,z]=r.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),A=(()=>{const e=new Map([["ミックス犬（雑種）",1],["その他",2]]),r=new Intl.Collator("ja",{sensitivity:"base",usage:"sort",numeric:!0}),a=e=>/[\u4E00-\u9FFF]/.test(e);return Array.from(new Set(b)).sort((t,i)=>{const s=e.get(t)||0,n=e.get(i)||0;if(0!==s||0!==n)return s-n;const l=a(t)?0:1,o=a(i)?0:1;return l!==o?l-o:r.compare(t,i)})})(),B=(new Date).getFullYear(),O=Array.from({length:21},(e,r)=>{const a=B-r;return{value:a.toString(),label:`${a}年`}}),P=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}}),T=async(e,r)=>{const a=e.target.files?.[0];if(a)try{const e=y(a);if(!e.isValid)return void V(e.error||"ファイルが無効です。");z(e=>({...e,[`${r}VaccineImage`]:a})),V("")}catch(t){V("ファイルの検証中にエラーが発生しました。")}};return e.jsxs(e.Fragment,{children:[e.jsx(n,{title:"ワンちゃん登録",description:"愛犬の情報を登録してドッグランを利用しましょう"}),e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-blue-50 to-white py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(t,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-700 mb-4",children:[e.jsx(p,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"愛犬の基本情報とワクチン証明書を登録してください"})]}),e.jsx(l,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),k.current||C)return;k.current=!0,S(!0);try{await h(o,N,"line")}catch{}const r=await(async()=>{if(N?.id)return N.id;try{const e=await fetch("/line/exchange-supabase-session",{method:"POST",credentials:"include"});if(e.ok){const{access_token:r,refresh_token:a}=await e.json(),{data:t}=await o.auth.setSession({access_token:r,refresh_token:a});if(t?.session?.user?.id)return t.session.user.id}else if(401===e.status||500===e.status)try{const e=`/liff/login?redirect=${encodeURIComponent(window.location.pathname)}`;window.location.assign(e)}catch{}}catch{}if(D)try{const{data:e}=await o.from("profiles").select("id").eq("id",D).maybeSingle();if(e?.id)return D}catch{}return null})();if(!r)return V("ログインが必要です。"),S(!1),void(k.current=!1);try{await h(o,{id:r},"line")}catch{}if(!R.name.trim())return V("ワンちゃんの名前を入力してください。"),S(!1),void(k.current=!1);if(!R.breed)return V("犬種を選択してください。"),S(!1),void(k.current=!1);if(!R.birthYear||!R.birthMonth||!R.birthDay)return V("生年月日を選択してください。"),S(!1),void(k.current=!1);if(!R.gender)return V("性別を選択してください。"),S(!1),void(k.current=!1);if(!q)return V("プロフィール画像をアップロードしてください。"),S(!1),void(k.current=!1);if(!R.rabiesVaccineImage)return V("狂犬病ワクチン証明書をアップロードしてください。"),S(!1),void(k.current=!1);if(!R.comboVaccineImage)return V("混合ワクチン証明書をアップロードしてください。"),S(!1),void(k.current=!1);if(!R.rabiesExpiryDate)return V("狂犬病ワクチンの有効期限を入力してください。"),S(!1),void(k.current=!1);if(!R.comboExpiryDate)return V("混合ワクチンの有効期限を入力してください。"),S(!1),void(k.current=!1);V("");try{const e=`dog-profiles/${r}/${Date.now()}_${q.name}`,a=await g("dog-images",q,e,{quality:80,generateThumbnail:!0,thumbnailSize:300,keepOriginal:!1});if(!a.success)throw new Error(`プロフィール画像のアップロードに失敗しました: ${a.error}`);const t=f(a.originalUrl,a.webpUrl);let i="",s="";if(R.rabiesVaccineImage){const e=await w(R.rabiesVaccineImage,r,"rabies");if(!e.success)throw new Error(`狂犬病ワクチン証明書のアップロードに失敗しました: ${e.error}`);i=e.publicUrl||""}if(R.comboVaccineImage){const e=await w(R.comboVaccineImage,r,"combo");if(!e.success)throw new Error(`混合ワクチン証明書のアップロードに失敗しました: ${e.error}`);s=e.publicUrl||""}const n=`${R.birthYear}-${R.birthMonth}-${R.birthDay}`,{data:l,error:c}=await o.from("dogs").insert([{owner_id:r,name:R.name.trim(),breed:R.breed,birth_date:n,gender:R.gender,image_url:t}]).select().single();if(c)throw new Error(`ワンちゃんの登録に失敗しました: ${c.message}`);if(i||s){const e={dog_id:l.id,status:"pending"};i&&(e.rabies_vaccine_image=i,e.rabies_expiry_date=R.rabiesExpiryDate),s&&(e.combo_vaccine_image=s,e.combo_expiry_date=R.comboExpiryDate);const{data:r,error:a}=await o.from("vaccine_certifications").insert([e]).select();if(a)throw new Error(`ワクチン証明書の保存に失敗しました: ${a.message}`)}x.success("ワンちゃんの登録が完了しました！"),I("/dashboard")}catch(a){c.error("ワンちゃんの登録でエラーが発生しました",{error:a}),V(a instanceof Error?a.message:"ワンちゃんの登録中にエラーが発生しました。")}finally{S(!1),k.current=!1}},className:"space-y-6",children:[E&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("p",{className:"text-red-600 text-sm",children:E})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["プロフィール画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[Y?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:Y,alt:"プロフィール画像プレビュー",className:"w-24 h-24 rounded-full object-cover border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{M(null),F(null)},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(j,{className:"w-3 h-3"})})]}):e.jsx("div",{className:"w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center",children:e.jsx(v,{className:"w-8 h-8 text-gray-400"})}),e.jsxs(i,{type:"button",variant:"outline",onClick:()=>U(!0),children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),q?"画像を変更":"画像を選択"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"1:1比率で切り取られ、最適化されます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(m,{label:"ワンちゃんの名前",type:"text",value:R.name,onChange:e=>z(r=>({...r,name:e.target.value})),placeholder:"例: ポチ",required:!0})}),e.jsx("div",{children:e.jsx(u,{label:"犬種",value:R.breed,onChange:e=>z(r=>({...r,breed:e.target.value})),options:[{value:"",label:"犬種を選択してください"},...A.map(e=>({value:e,label:e}))],required:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["生年月日 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(u,{value:R.birthYear,onChange:e=>{z(r=>({...r,birthYear:e.target.value,birthDay:""}))},options:[{value:"",label:"年"},...O],required:!0}),e.jsx(u,{value:R.birthMonth,onChange:e=>{z(r=>({...r,birthMonth:e.target.value,birthDay:""}))},options:[{value:"",label:"月"},...P],required:!0}),e.jsx(u,{value:R.birthDay,onChange:e=>z(r=>({...r,birthDay:e.target.value})),options:[{value:"",label:"日"},...(()=>{if(!R.birthYear||!R.birthMonth)return[];const e=parseInt(R.birthYear),r=parseInt(R.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}})})()],required:!0,disabled:!R.birthYear||!R.birthMonth})]})]}),e.jsx("div",{children:e.jsx(u,{label:"性別",value:R.gender,onChange:e=>z(r=>({...r,gender:e.target.value})),options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],required:!0})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"ワクチン証明書"}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>T(e,"rabies"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),R.rabiesVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",R.rabiesVaccineImage.name]})]}),e.jsx(m,{label:"有効期限",type:"date",value:R.rabiesExpiryDate,onChange:e=>z(r=>({...r,rabiesExpiryDate:e.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>T(e,"combo"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),R.comboVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",R.comboVaccineImage.name]})]}),e.jsx(m,{label:"有効期限",type:"date",value:R.comboExpiryDate,onChange:e=>z(r=>({...r,comboExpiryDate:e.target.value})),required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(t,{to:"/dashboard",children:e.jsx(i,{type:"button",variant:"outline",children:"キャンセル"})}),e.jsx(i,{type:"submit",disabled:C,className:"min-w-[120px]",children:C?"登録中...":"ワンちゃんを登録"})]})]})})]})}),_&&e.jsx(d,{onCropComplete:e=>{M(e);const r=URL.createObjectURL(e);F(r),U(!1),V("")},onCancel:()=>U(!1),aspectRatio:1,maxWidth:400,maxHeight:400})]})}export{N as DogRegistration};
