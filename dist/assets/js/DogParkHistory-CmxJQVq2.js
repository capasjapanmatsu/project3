import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{a as t,L as a}from"./router-9ZtQ8-Nn.js";import{B as l}from"./Button-D1CO6kO-.js";import{C as r}from"./Card-roTxPFVC.js";import{I as n}from"./Input-C-0g4Mlj.js";import{u as i,s as c}from"./index-DRDL9Ed3.js";import{Y as d,C as o,l as m,M as x,g as h,v as u,D as g,w as j,P as p,G as f,X as b,U as N,o as v,s as y}from"./ui-basic-BXsWFU4S.js";import"./supabase-hyP6cfTu.js";import"./heavy-features-BIdEME4r.js";function w(){const{user:w}=i(),_=t(),[k,S]=s.useState([]),[C,D]=s.useState(!0),[L,$]=s.useState(""),[z,M]=s.useState("all"),[I,q]=s.useState((new Date).getFullYear().toString()),[Y,F]=s.useState("all"),[P,B]=s.useState([]),[E,O]=s.useState(0),[U,A]=s.useState(0),[J,R]=s.useState(""),[T,G]=s.useState([]),[V,H]=s.useState(null),[K,Q]=s.useState(null),[W,X]=s.useState(null),[Z,ee]=s.useState(null);s.useEffect(()=>{w?se():_("/login")},[w,_]);const se=async()=>{try{D(!0);const{data:e,error:s}=await c.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("user_id",w?.id).order("date",{ascending:!1}).limit(50);if(s)throw s;const{data:t,error:a}=await c.from("dogs").select("*").eq("owner_id",w?.id);if(a)throw a;if(S(e||[]),B(t||[]),e){O(e.length);const s=new Set(e.map(e=>e.park_id));A(s.size);const t={};e.forEach(e=>{const s=e.park_id;t[s]||(t[s]={count:0,name:e.dog_park.name,id:s}),t[s].count++});const a=Object.values(t).sort((e,s)=>s.count-e.count).slice(0,3).map(e=>({id:e.id,name:e.name,visits:e.count}));G(a),a.length>0&&R(a[0].name)}}catch(e){}finally{D(!1)}},te=e=>["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"][e-1],ae=s.useMemo(()=>k.filter(e=>{const s=e.dog_park.name.toLowerCase().includes(L.toLowerCase())||e.dog_park.address.toLowerCase().includes(L.toLowerCase())||e.dog.name.toLowerCase().includes(L.toLowerCase()),t="all"===z||e.dog_id===z,a=new Date(e.date),l="all"===I||a.getFullYear().toString()===I,r="all"===Y||(a.getMonth()+1).toString()===Y;return s&&t&&l&&r}),[k,L,z,I,Y]);return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(a,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(o,{className:"w-8 h-8 text-blue-600 mr-3"}),"ドッグラン利用履歴"]}),e.jsx("p",{className:"text-lg text-gray-600",children:"これまでのドッグラン利用記録を確認できます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(r,{className:"p-6 text-center",children:[e.jsx(o,{className:"w-12 h-12 text-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:E}),e.jsx("p",{className:"text-gray-600",children:"総利用回数"})]}),e.jsxs(r,{className:"p-6 text-center",children:[e.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:U}),e.jsx("p",{className:"text-gray-600",children:"訪問したドッグラン数"})]}),e.jsxs(r,{className:"p-6 text-center",children:[e.jsx(x,{className:"w-12 h-12 text-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-xl font-bold text-gray-900 mb-1",children:J||"-"}),e.jsx("p",{className:"text-gray-600",children:"最も訪問したドッグラン"})]})]}),T.length>0&&e.jsxs(r,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(h,{className:"w-6 h-6 text-pink-600 mr-2"}),"よく行くドッグラン"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:T.map((s,t)=>e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-600 font-bold",children:t+1}),e.jsx("h3",{className:"font-semibold",children:s.name})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(o,{className:"w-4 h-4 text-gray-500 mr-1"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[s.visits,"回利用"]})]}),e.jsx(a,{to:`/parks/${s.id}`,children:e.jsx(l,{size:"sm",variant:"secondary",children:"詳細"})})]})]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(n,{label:"",value:L,onChange:e=>$(e.target.value),placeholder:"ドッグラン名、住所で検索...",icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})})}),e.jsx("div",{children:e.jsxs("select",{value:z,onChange:e=>M(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべてのワンちゃん"}),P.map(s=>e.jsxs("option",{value:s.id,children:[s.name,"ちゃん"]},s.id))]})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("select",{value:I,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべての年"}),(()=>{const e=(new Date).getFullYear(),s=[];for(let t=e;t>=e-2;t--)s.push({value:t.toString(),label:`${t}年`});return s})().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx("select",{value:Y,onChange:e=>F(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:(()=>{const e=[{value:"all",label:"すべての月"}];for(let s=1;s<=12;s++)e.push({value:s.toString(),label:te(s)});return e})().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{if(0===ae.length)return;const e="\ufeff"+[["日付","時間","ドッグラン名","住所","ワンちゃん","料金","予約タイプ"].join(","),...ae.map(e=>[new Date(e.date).toLocaleDateString("ja-JP"),`${e.start_time}〜${parseInt(e.start_time)+e.duration}:00`,`"${e.dog_park.name.replace(/"/g,'""')}"`,`"${e.dog_park.address.replace(/"/g,'""')}"`,`"${e.dog.name.replace(/"/g,'""')}"`,`¥${e.total_amount}`,"regular"===e.reservation_type?"通常利用":"private_booth"===e.reservation_type?"プライベートブース":"施設貸し切り"].join(","))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(s),a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("download",`dogpark_history_${(new Date).toISOString().split("T")[0]}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),0===ae.length?e.jsxs(r,{className:"text-center py-12",children:[e.jsx(o,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"利用履歴がありません"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"まだドッグランを利用していないようです"}),e.jsx(a,{to:"/parks",children:e.jsx(l,{children:"ドッグランを予約する"})})]}):e.jsx("div",{className:"space-y-6",children:ae.map(s=>{const t=new Date(s.date),n=t.toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),i=s.start_time,d=`${parseInt(i)+s.duration}:00`,h="regular"===s.reservation_type?"通常利用":"private_booth"===s.reservation_type?"プライベートブース":"施設貸し切り";return e.jsxs(r,{className:"p-6 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start gap-4",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsxs("div",{className:"bg-blue-100 rounded-lg p-3 text-center min-w-[80px]",children:[e.jsx("p",{className:"text-sm text-blue-800",children:t.getFullYear()}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:t.getDate()}),e.jsx("p",{className:"text-sm text-blue-800",children:te(t.getMonth()+1)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:s.dog_park.name}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(x,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:s.dog_park.address})]}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(j,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-sm",children:[i," 〜 ",d]})]}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(p,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-sm",children:[s.dog.name,"ちゃん（",s.dog.breed,"）"]})]}),Math.random()>.5&&e.jsx("div",{className:"flex items-center mt-2",children:[1,2,3,4,5].map(s=>e.jsx(f,{className:"w-4 h-4 "+(s<=Math.floor(3+2*Math.random())?"text-yellow-400 fill-current":"text-gray-300")},s))})]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",s.total_amount.toLocaleString()]})}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("regular"===s.reservation_type?"bg-blue-100 text-blue-800":"private_booth"===s.reservation_type?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"),children:h})}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("confirmed"===s.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:"confirmed"===s.status?"利用済み":"キャンセル"})})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 flex justify-between items-center",children:[e.jsx("div",{className:"text-sm text-gray-500",children:n}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(a,{to:`/parks/${s.park_id}`,children:e.jsxs(l,{size:"sm",variant:"secondary",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"施設詳細"]})}),e.jsx(a,{to:`/reservation/${s.park_id}`,children:e.jsxs(l,{size:"sm",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),"再予約"]})}),"confirmed"===s.status&&e.jsxs(l,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",isLoading:V===s.id,onClick:async()=>{const e=await(async e=>{const s="whole_facility"===e.reservation_type,t=new Date,a=new Date(e.date),l=new Date(a);if(l.setDate(a.getDate()-1),s)return t<l;{const{data:s}=await c.from("user_entry_exit_logs").select("*").eq("user_id",e.user_id).eq("park_id",e.park_id).eq("action","entry").gte("timestamp",e.date);return!s||0===s.length}})(s);e?Q(s.id):X("この予約はキャンセルできません（貸し切りは1日前まで、通常予約はPIN未使用時のみ）")},children:[e.jsx(b,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]})]},s.id)})}),ae.length>0&&e.jsx(r,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(N,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"コミュニティ機能"}),e.jsx("p",{className:"text-sm text-blue-800 mb-3",children:"同じドッグランを利用した他のワンちゃんとの出会いを「コミュニティ」ページで確認できます。 友達申請を送ったり、次回の予約を調整したりして、ワンちゃん同士の交流を深めましょう。"}),e.jsx(a,{to:"/community",children:e.jsxs(l,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"コミュニティを見る"]})})]})]})}),K&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(v,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"予約をキャンセルしますか？"}),e.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(l,{variant:"secondary",onClick:()=>Q(null),children:"戻る"}),e.jsx(l,{className:"bg-red-600 hover:bg-red-700",isLoading:V===K,onClick:()=>{const e=ae.find(e=>e.id===K);e&&(async e=>{H(e.id),X(null),ee(null);try{const{data:s,error:t}=await c.rpc("cancel_reservation",{p_reservation_id:e.id,p_user_id:e.user_id});if(t||!s?.success)return void X(s&&s.message||t?.message||"キャンセルに失敗しました");ee("予約をキャンセルしました"),Q(null),await se(),setTimeout(()=>ee(null),3e3)}catch(s){X(s.message||"キャンセルに失敗しました")}finally{H(null)}})(e)},children:"キャンセルする"})]})]})}),Z&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:Z})]})}),W&&e.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),e.jsx("p",{className:"text-red-700 mt-1",children:W})]})]})}export{w as DogParkHistory};
