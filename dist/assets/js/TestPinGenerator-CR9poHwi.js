import{j as e}from"./motion-CuO0nkIV.js";import{L as s}from"./router-Cg6wfOY4.js";import{r as t}from"./react-vendor-cniURDpR.js";import{u as r,s as a,C as l}from"./index-qwdJeTcH.js";import{F as n,a4 as c,aJ as i,aK as d,g as o,ac as m,K as x,L as u,R as h,af as g,p as j,aE as b}from"./ui-basic-icnN6BOT.js";import{B as N}from"./Button-D7FFKgkK.js";import"./heavy-features-BIdEME4r.js";import"./supabase-B0bqaRGb.js";const f=({status:s,pinType:t,className:r="",showDetails:a=!1,usedAt:l,expiresAt:x})=>{const u={issued:{text:"まだ使われていません",icon:o,color:"text-gray-600",bgColor:"bg-gray-50",borderColor:"border-gray-200",iconColor:"text-gray-400"},entered:{text:"入場中",icon:d,color:"text-blue-700",bgColor:"bg-blue-50",borderColor:"border-blue-200",iconColor:"text-blue-600"},exit_requested:{text:"退場PINを使用してください",icon:i,color:"text-yellow-700",bgColor:"bg-yellow-50",borderColor:"border-yellow-200",iconColor:"text-yellow-600"},exited:{text:"退場完了しました",icon:c,color:"text-green-700",bgColor:"bg-green-50",borderColor:"border-green-200",iconColor:"text-green-600"}};if(!s)return e.jsxs("div",{className:`flex items-center p-4 bg-gray-50 border border-gray-200 rounded-lg ${r}`,children:[e.jsx(n,{className:"w-5 h-5 text-gray-400 mr-3"}),e.jsx("span",{className:"text-gray-500",children:"ステータス情報がありません"})]});const h=u[s],g=h.icon;return e.jsx("div",{className:`\n        p-4 rounded-lg border-2 transition-all\n        ${h.bgColor} ${h.borderColor}\n        ${r}\n      `,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-full ${h.bgColor} mr-3`,children:e.jsx(g,{className:`w-6 h-6 ${h.iconColor}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:`font-semibold ${h.color}`,children:h.text}),t&&e.jsx("span",{className:"ml-2 text-xs px-2 py-1 rounded-full "+("entry"===t?"bg-blue-100 text-blue-700":"bg-orange-100 text-orange-700"),children:"entry"===t?"入場用":"退場用"})]}),a&&e.jsxs("div",{className:"mt-2 space-y-1",children:[l&&e.jsxs("div",{className:"flex items-center text-xs text-gray-600",children:[e.jsx(m,{className:"w-3 h-3 mr-1"}),"使用日時: ",new Date(l).toLocaleString("ja-JP")]}),x&&"issued"===s&&e.jsxs("div",{className:"flex items-center text-xs text-gray-600",children:[e.jsx(m,{className:"w-3 h-3 mr-1"}),"有効期限: ",new Date(x).toLocaleString("ja-JP")]})]})]})]})})},y=({lockId:s,lockName:c,userId:i,dogId:o,dogRunId:g})=>{const[j,b]=t.useState("entry"),[y,p]=t.useState(""),[w,v]=t.useState(null),[I,k]=t.useState(0),[P,_]=t.useState(!1),[S,C]=t.useState(""),[D,L]=t.useState(!1),{currentLog:A,isLoading:T,refetch:$}=function(e){const{user:s}=r(),[l,n]=t.useState(null),[c,i]=t.useState([]),[d,o]=t.useState(!0),[m,x]=t.useState(null),u=async()=>{if(s?.id)try{o(!0),x(null);let t=a.from("access_logs").select("*").eq("user_id",s?.id).order("issued_at",{ascending:!1});e&&(t=t.eq("lock_id",e));const{data:r,error:l}=await t.limit(10);if(l)throw l;const c=r||[];i(c);const d=h(c);n(d)}catch(t){x(t instanceof Error?t.message:"ログの取得に失敗しました")}finally{o(!1)}else o(!1)},h=e=>{if(0===e.length)return null;const s=e.find(e=>"entered"===e.status);if(s)return s;const t=e.find(e=>"issued"===e.status&&"entry"===e.pin_type);if(t)return t;return e.find(e=>"exit_requested"===e.status)||e[0]};return t.useEffect(()=>{u()},[s?.id,e]),t.useEffect(()=>{if(!s?.id)return;const e=a.channel("access_logs_changes").on("postgres_changes",{event:"*",schema:"public",table:"access_logs",filter:`user_id=eq.${s.id}`},e=>{u()}).subscribe();return()=>{e.unsubscribe()}},[s?.id,e]),{currentLog:l,recentLogs:c,isLoading:d,error:m,refetch:u}}(s);t.useEffect(()=>{if(!w)return;const e=()=>{const e=new Date,s=Math.max(0,Math.floor((w.getTime()-e.getTime())/1e3));k(s),0===s&&(L(!0),p(""))};e();const s=setInterval(e,1e3);return()=>clearInterval(s)},[w]);const J=async e=>{const t=Math.floor(1e5+9e5*Math.random()).toString(),r=new Date,a=new Date;a.setMinutes(a.getMinutes()+5);const l={lockId:s,keyboardPwd:t,startDate:r,endDate:a};return await async function(e){return await new Promise(e=>setTimeout(e,1e3)),{success:!0,keyboardPwdId:Math.floor(1e5*Math.random()),lockId:e.lockId,keyboardPwd:e.keyboardPwd,startDate:e.startDate,endDate:e.endDate,status:"active",message:"【開発環境】モックPINが生成されました"}}(l)},E=t.useCallback(async()=>{_(!0),C(""),L(!1);try{const e=await J();if(e.success&&e.keyboardPwd&&e.endDate){p(e.keyboardPwd),v(e.endDate);const t={user_id:i,lock_id:s,pin:e.keyboardPwd,pin_type:j,status:"entry"===j?"issued":"exit_requested",issued_at:new Date,expires_at:e.endDate,keyboard_pwd_id:e.keyboardPwdId,dog_id:o,dog_run_id:g},r=await async function(e){try{const{data:s,error:t}=await a.from("access_logs").insert(e).select().single();return t?null:s}catch(s){return null}}(t);r&&await $()}else C(e.error||e.message||"PIN発行に失敗しました")}catch(e){C("PIN発行中にエラーが発生しました")}finally{_(!1)}},[j,$]),M=e=>{const s=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},O="entered"===A?.status;return t.useEffect(()=>{O&&"entry"===j?b("exit"):O||"exit"!==j||b("entry")},[O]),e.jsx(l,{className:"max-w-md mx-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 mb-2 flex items-center",children:[e.jsx(x,{className:"w-6 h-6 mr-2 text-blue-600"}),"スマートロック PIN発行"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["ロック名: ",c]})]}),!T&&A&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"現在の状態"}),e.jsx(f,{status:A.status,pinType:A.pin_type,showDetails:!0,usedAt:A.used_at?new Date(A.used_at):void 0,expiresAt:A.expires_at?new Date(A.expires_at):void 0})]}),e.jsxs("div",{className:"flex mb-6 bg-gray-100 p-1 rounded-lg",children:[e.jsxs("button",{onClick:()=>b("entry"),className:"flex-1 flex items-center justify-center py-2 px-4 rounded-md transition-all "+("entry"===j?"bg-blue-500 text-white shadow-sm":"text-gray-600 hover:bg-white/50"),children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"入場用PIN"]}),e.jsxs("button",{onClick:()=>b("exit"),className:"flex-1 flex items-center justify-center py-2 px-4 rounded-md transition-all "+("exit"===j?"bg-orange-500 text-white shadow-sm":"text-gray-600 hover:bg-white/50"),children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"退場用PIN"]})]}),S&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center",children:[e.jsx(n,{className:"w-5 h-5 text-red-500 mr-2 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-red-700",children:S})]}),y&&!D?e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-2 border-blue-200",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["entry"===j?"入場用":"退場用","PINコード"]}),e.jsx("div",{className:"text-4xl font-bold text-blue-900 tracking-wider",children:y.split("").map((s,t)=>e.jsx("span",{className:"inline-block mx-1",children:s},t))})]})}),e.jsxs("div",{className:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(m,{className:"w-5 h-5 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-yellow-800",children:"有効期限"})]}),e.jsxs("span",{className:"text-lg font-bold "+(I<60?"text-red-600":"text-yellow-800"),children:["残り ",M(I)]})]}),I<60&&e.jsx("p",{className:"text-xs text-red-600 mt-2",children:"まもなく有効期限が切れます"})]}),e.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"使用方法："}),e.jsxs("ol",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"1. スマートロックのキーパッドをタッチして起動"}),e.jsx("li",{children:"2. 上記の6桁のPINコードを入力"}),e.jsx("li",{children:"3. #（シャープ）キーを押して確定"})]})]})]}):e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"text-center py-8 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx(x,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-600 mb-1",children:D?"PINの有効期限が切れました":"PINが発行されていません"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ボタンを押してPINを",D?"再":"","発行してください"]})]})}),e.jsx(N,{onClick:E,disabled:P||!!y&&!D,className:"w-full "+(D?"bg-orange-600 hover:bg-orange-700":"bg-blue-600 hover:bg-blue-700"),children:P?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsx(h,{className:"w-5 h-5 mr-2 animate-spin"}),"発行中..."]}):e.jsx("span",{className:"flex items-center justify-center",children:D||!y?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"w-5 h-5 mr-2"}),D?"PINを再発行":"PINを発行"]}):e.jsxs(e.Fragment,{children:[e.jsx(m,{className:"w-5 h-5 mr-2"}),"発行済み（",M(I),"）"]})})}),e.jsxs("div",{className:"mt-6 p-4 bg-gray-50 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"注意事項："}),e.jsxs("ul",{className:"text-xs text-gray-600 space-y-1",children:[e.jsx("li",{children:"• PINコードは1回限り有効です"}),e.jsx("li",{children:"• 有効期限は発行から5分間です"}),e.jsx("li",{children:"• 他の人にPINを教えないでください"}),e.jsx("li",{children:"• 入場と退場で異なるPINが必要です"})]})]})]})})};function p(){const{user:a}=r(),[l,n]=t.useState(""),[i,d]=t.useState("123456"),[o,m]=t.useState(""),[x,u]=t.useState(!1),[h,f]=t.useState("checking");t.useEffect(()=>{(async function(){try{const e="https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/lock-record-notify";return!!(await fetch(e,{method:"OPTIONS",headers:{Origin:window.location.origin}})).ok}catch(e){return!1}})().then(e=>{f(e?"online":"offline")})},[]);return e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(s,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-4",children:[e.jsx(g,{className:"w-5 h-5 mr-2"}),"ダッシュボードに戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"PIN発行システム テスト"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"スマートロックのPIN発行機能をテストできます"})]}),!1,e.jsx("div",{className:"space-y-6",children:[{id:"lock_001",name:"龍田山ドッグラン - メインゲート",lockId:123456},{id:"lock_002",name:"龍田山ドッグラン - サブゲート",lockId:123457}].map(s=>e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:s.name}),e.jsx(y,{lockId:s.id,lockName:s.name,userId:a?.id||"test_user"})]},s.id))}),e.jsxs("div",{className:"mt-12 p-6 bg-white rounded-lg shadow-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"実装状況"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-800 text-xs font-medium mr-3 mt-0.5",children:"✓"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"PIN発行UI"}),e.jsx("p",{className:"text-sm text-gray-600",children:"入場/退場用のPIN発行ボタンとカウントダウンタイマー"})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-800 text-xs font-medium mr-3 mt-0.5",children:"✓"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"データモデル"}),e.jsx("p",{className:"text-sm text-gray-600",children:"AccessLog, DogRunLock等のTypeScript interface定義"})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-800 text-xs font-medium mr-3 mt-0.5",children:"✓"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Sciener API連携関数"}),e.jsx("p",{className:"text-sm text-gray-600",children:"keyboardPwd/add APIを呼び出す関数実装済み（モック/実API切り替え可能）"})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-800 text-xs font-medium mr-3 mt-0.5",children:"✓"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Webhook受信エンドポイント"}),e.jsx("p",{className:"text-sm text-gray-600",children:"lockRecord/notify Webhookでの解錠通知受信とAccessLog更新"})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs font-medium mr-3 mt-0.5",children:"○"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"実際のロック操作"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Scienerスマートロックとの実連携（未実装）"})]})]})]})]}),e.jsxs("div",{className:"mt-12 p-6 bg-white rounded-lg shadow-md",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(j,{className:"w-5 h-5 mr-2 text-purple-600"}),"Webhook受信テスト"]}),e.jsx("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Webhookエンドポイント状態:"}),e.jsx("div",{className:"flex items-center",children:"checking"===h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded-full mr-2 animate-pulse"}),e.jsx("span",{className:"text-sm text-yellow-700",children:"確認中..."})]}):"online"===h?e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"w-5 h-5 text-green-600 mr-2"}),e.jsx("span",{className:"text-sm text-green-700",children:"オンライン"})]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("span",{className:"text-sm text-red-700",children:"オフライン"})]})})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"テスト用PIN（6桁）"}),e.jsx("input",{type:"text",value:l,onChange:e=>n(e.target.value),placeholder:"123456",maxLength:6,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Lock ID"}),e.jsx("input",{type:"text",value:i,onChange:e=>d(e.target.value),placeholder:"123456",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx(N,{onClick:async()=>{if(l&&i){u(!0),m("");try{const e=function(e,s,t=2){return{lockId:e,keyboardPwd:s,recordType:t,date:Date.now(),username:"test_user"}}(i,l,2),s=await async function(e){try{const s="https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/lock-record-notify",t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"},body:JSON.stringify(e)}),r=await t.json();return t.ok?r:{success:!1,message:r.message||"Webhook test failed",error:r.error}}catch(s){return{success:!1,message:"Failed to send webhook test",error:s instanceof Error?s.message:"Unknown error"}}}(e);s.success?m(`✅ 成功: ${s.message}`):m(`❌ 失敗: ${s.error||s.message}`)}catch(e){m(`❌ エラー: ${e instanceof Error?e.message:"Unknown error"}`)}finally{u(!1)}}else m("❌ PINとLock IDを入力してください")},disabled:x||"online"!==h,className:"w-full bg-purple-600 hover:bg-purple-700",children:x?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsx(j,{className:"w-5 h-5 mr-2 animate-pulse"}),"テスト送信中..."]}):e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsx(j,{className:"w-5 h-5 mr-2"}),"解錠通知をテスト送信"]})}),o&&e.jsx("div",{className:"mt-4 p-4 rounded-lg "+(o.startsWith("✅")?"bg-green-50 border border-green-200 text-green-800":"bg-red-50 border border-red-200 text-red-800"),children:e.jsx("p",{className:"text-sm",children:o})})]}),e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-900 mb-2",children:"テスト方法："}),e.jsxs("ol",{className:"text-xs text-blue-800 space-y-1",children:[e.jsx("li",{children:"1. 上部のPIN発行セクションで新しいPINを発行"}),e.jsx("li",{children:"2. 発行されたPINをコピーしてテスト用PINに入力"}),e.jsx("li",{children:"3. Lock IDは発行時と同じものを使用"}),e.jsx("li",{children:"4. 「解錠通知をテスト送信」ボタンをクリック"}),e.jsx("li",{children:"5. AccessLogのステータスが更新されることを確認"})]})]})]})]})})}export{p as TestPinGenerator,p as default};
