import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{a as s,L as a}from"./router-Cg6wfOY4.js";import{u as l,s as r,C as n}from"./index-Cxr3hxlQ.js";import{B as c}from"./Button-BVIkPLCk.js";import{af as i,U as m,N as x,aW as o,be as d}from"./ui-basic-icnN6BOT.js";import"./heavy-features-BIdEME4r.js";import"./supabase-B0bqaRGb.js";function h(){const{isAdmin:h}=l(),j=s(),[p,u]=t.useState(0),[g,f]=t.useState(0),[N,y]=t.useState([]),[v,w]=t.useState(!0),[_,b]=t.useState(""),[S,k]=t.useState([]),[D,M]=t.useState(!1),[L,O]=t.useState(5);t.useEffect(()=>{h?(I(),C(),B()):j("/")},[h,j]);const I=async()=>{try{const{count:e}=await r.from("profiles").select("*",{count:"exact",head:!0});u(e||0);const{count:t}=await r.from("dog_parks").select("*",{count:"exact",head:!0});f(t||0)}catch(e){b("サマリーの取得に失敗しました")}},C=async()=>{try{w(!0),b("");const e=new Date;e.setDate(e.getDate()-29);const{data:t,error:s}=await r.from("reservations").select("created_at,total_amount").gte("created_at",e.toISOString()).not("total_amount","is",null);if(s)throw s;const a={};for(let r=0;r<30;r++){const t=new Date(e);t.setDate(e.getDate()+r);const s=t.toISOString().slice(0,10);a[s]=0}(t||[]).forEach(e=>{const t=new Date(e.created_at).toISOString().slice(0,10);void 0!==a[t]&&(a[t]+=e.total_amount||0)});const l=Object.entries(a).map(([e,t])=>({date:e,total:t}));y(l)}catch(e){b("売上推移の取得に失敗しました")}finally{w(!1)}},B=async()=>{try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0),a=t.toISOString().split("T")[0],l=s.toISOString().split("T")[0],{data:n,error:c}=await r.rpc("get_monthly_revenue_by_park",{start_date_param:a,end_date_param:l});if(c)throw c;const i=(n||[]).map(e=>({park_name:e.park_name,total_revenue:e.total_revenue})).sort((e,t)=>t.total_revenue-e.total_revenue);k(i)}catch(e){}},z=t.useMemo(()=>Math.max(1,...N.map(e=>e.total)),[N]);return e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-2",children:e.jsxs(a,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(i,{className:"w-4 h-4 mr-2"})," 管理者ダッシュボードに戻る"]})}),e.jsx("h1",{className:"text-2xl font-bold",children:"売り上げ管理"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(n,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"ユーザー数"}),e.jsx("p",{className:"text-2xl font-bold",children:p.toLocaleString()})]}),e.jsx(m,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx(n,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"ドッグラン数"}),e.jsx("p",{className:"text-2xl font-bold",children:g.toLocaleString()})]}),e.jsx(x,{className:"w-8 h-8 text-green-600"})]})}),e.jsx(n,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"直近30日売上合計"}),e.jsxs("p",{className:"text-2xl font-bold text-green-700",children:["¥",N.reduce((e,t)=>e+t.total,0).toLocaleString()]})]}),e.jsx(o,{className:"w-8 h-8 text-green-700"})]})})]}),e.jsxs(n,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(d,{className:"w-5 h-5 mr-2"}),"売上推移（直近30日）"]}),e.jsx(a,{to:"/admin/sales",children:e.jsx(c,{size:"sm",children:"詳細レポートへ"})})]}),_&&e.jsx("div",{className:"text-red-600 mb-3 text-sm",children:_}),e.jsx("div",{className:"w-full h-64 bg-white",children:e.jsxs("svg",{viewBox:"0 0 600 240",className:"w-full h-full",children:[e.jsx("polyline",{fill:"none",stroke:"#16a34a",strokeWidth:"2",points:N.map((e,t)=>`${t/Math.max(1,N.length-1)*580+10},${230-e.total/z*200}`).join(" ")}),N.map((t,s)=>{const a=s/Math.max(1,N.length-1)*580+10,l=230-t.total/z*200;return e.jsx("circle",{cx:a,cy:l,r:2,fill:"#16a34a"},t.date)})]})})]}),e.jsxs(n,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(x,{className:"w-5 h-5 mr-2"}),"ドッグラン別売上（今月・上位5）"]}),e.jsx(a,{to:"/admin/revenue",children:e.jsx(c,{size:"sm",children:"一覧を見る"})})]}),0===S.length?e.jsx("div",{className:"text-sm text-gray-500",children:"今月の売上データがありません"}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"ドッグラン"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"売上"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[S.slice(0,5).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-800",children:t.park_name}),e.jsxs("td",{className:"px-4 py-2 text-sm text-right font-medium",children:["¥",t.total_revenue?.toLocaleString?.()||t.total_revenue]})]},t.park_name)),D&&S.slice(5,Math.min(L,S.length)).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-800",children:t.park_name}),e.jsxs("td",{className:"px-4 py-2 text-sm text-right font-medium",children:["¥",t.total_revenue?.toLocaleString?.()||t.total_revenue]})]},t.park_name))]})]}),S.length>5&&e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[D?e.jsxs("div",{className:"flex items-center gap-2",children:[L<S.length&&e.jsx(c,{variant:"secondary",onClick:()=>O(Math.min(L+20,S.length)),children:"さらに表示（+20）"}),e.jsx(c,{onClick:()=>{M(!1),O(5)},children:"折りたたむ"})]}):e.jsx(c,{variant:"secondary",onClick:()=>{M(!0),O(Math.min(25,S.length))},children:"他のドッグランを表示"}),e.jsxs("div",{className:"text-xs text-gray-500 ml-auto",children:[Math.min(L,S.length)," / ",S.length," 件"]})]})]})]})]})}export{h as default};
