import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{u as t,L as a}from"./router-Cg6wfOY4.js";import{B as n}from"./Button-DiksLhRM.js";import{u as r,s as l,C as i}from"./index-DWDIgw5z.js";import{af as c,al as d,z as m,a4 as o,D as x,j as h,a1 as p,X as u,i as j,ac as g,an as f}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function b(){const{user:b}=r(),N=t(),[_,v]=s.useState([]),[y,w]=s.useState(!0),[S,L]=s.useState(null),[D,k]=s.useState(!1),[C,$]=s.useState(!1),[T,z]=s.useState(null),[E,J]=s.useState(null),[P,q]=s.useState(null);s.useEffect(()=>{if(b){M();const e=setInterval(()=>{B()},6e4);return()=>clearInterval(e)}N.state?.orderSuccess&&(k(!0),setTimeout(()=>k(!1),5e3))},[b,N]);const M=async()=>{try{const{data:e,error:s}=await l.from("orders").select("\n          *,\n          order_items (\n            *,\n            product:products (*)\n          )\n        ").eq("user_id",b?.id).order("created_at",{ascending:!1});if(s)throw s;const t=(e||[]).map(e=>{const s=e.cancellable_until?new Date(e.cancellable_until):null,t=new Date,a=s&&t<s&&["pending","confirmed"].includes(e.status);let n;if(a&&s){const e=s.getTime()-t.getTime();n=`${Math.floor(e/6e4)}分${Math.floor(e%6e4/1e3)}秒`}return{...e,can_cancel:a,time_left:n}});v(t)}catch(e){}finally{w(!1)}},B=()=>{const e=new Date;v(s=>s.map(s=>{const t=s.cancellable_until?new Date(s.cancellable_until):null,a=t&&e<t&&["pending","confirmed"].includes(s.status);let n;if(a&&t){const s=t.getTime()-e.getTime();n=`${Math.floor(s/6e4)}分${Math.floor(s%6e4/1e3)}秒`}return{...s,can_cancel:a,time_left:n}}))},I=s=>{switch(s){case"pending":return e.jsx(g,{className:"w-5 h-5 text-yellow-600"});case"confirmed":return e.jsx(o,{className:"w-5 h-5 text-blue-600"});case"processing":return e.jsx(d,{className:"w-5 h-5 text-purple-600"});case"shipped":return e.jsx(f,{className:"w-5 h-5 text-orange-600"});case"delivered":return e.jsx(o,{className:"w-5 h-5 text-green-600"});case"cancelled":return e.jsx(u,{className:"w-5 h-5 text-red-600"});default:return e.jsx(g,{className:"w-5 h-5 text-gray-600"})}},A=e=>({pending:"注文受付中",confirmed:"注文確定",processing:"準備中",shipped:"発送済み",delivered:"配達完了",cancelled:"キャンセル"}[e]||e),O=e=>({credit_card:"クレジットカード",bank_transfer:"銀行振込",cod:"代金引換"}[e]||e);return y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(a,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(c,{className:"w-4 h-4 mr-2"}),"マイページに戻る"]})}),e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(d,{className:"w-8 h-8 text-green-600 mr-3"}),"注文履歴"]}),e.jsx("div",{className:"flex flex-wrap gap-4 mb-6",children:e.jsx(a,{to:"/petshop",children:e.jsxs(n,{variant:"secondary",size:"sm",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"ショップに戻る"]})})}),D&&N.state?.orderNumber&&e.jsxs("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(o,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:"ご注文ありがとうございます！"})]}),e.jsxs("p",{className:"text-green-700 mt-1",children:["注文番号: ",N.state.orderNumber," のご注文を承りました。"]})]}),0===_.length?e.jsxs(i,{className:"text-center py-12",children:[e.jsx(d,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"注文履歴がありません"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"まだ商品をご注文いただいていません"}),e.jsx(n,{onClick:()=>window.location.href="/petshop",children:"ショッピングを始める"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs(n,{variant:"secondary",size:"sm",onClick:()=>{if(0===_.length)return;const e=["注文番号","注文日","ステータス","商品名","数量","単価","小計","割引","送料","合計金額","支払い方法","配送先氏名","配送先住所","配送先電話番号"].join(","),s=[];_.forEach(e=>{const t=new Date(e.created_at).toLocaleDateString("ja-JP"),a=A(e.status),n=O(e.payment_method);if(e.order_items&&e.order_items.length>0)e.order_items.forEach((r,l)=>{const i=[e.order_number,t,a,`"${r.product.name.replace(/"/g,'""')}"`,r.quantity,r.unit_price,r.total_price,0===l?e.discount_amount:"",0===l?e.shipping_fee:"",0===l?e.final_amount:"",0===l?n:"",0===l?`"${e.shipping_name.replace(/"/g,'""')}"`:"",0===l?`"${e.shipping_address.replace(/"/g,'""')}"`:"",0===l?e.shipping_phone:""].join(",");s.push(i)});else{const r=[e.order_number,t,a,"商品なし","","","",e.discount_amount,e.shipping_fee,e.final_amount,n,`"${e.shipping_name.replace(/"/g,'""')}"`,`"${e.shipping_address.replace(/"/g,'""')}"`,e.shipping_phone].join(",");s.push(r)}});const t="\ufeff"+[e,...s].join("\n"),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(a),r=document.createElement("a");r.setAttribute("href",n),r.setAttribute("download",`注文履歴_${(new Date).toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)},children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),_.map(s=>{return e.jsxs(i,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["注文番号: ",s.order_number]}),e.jsxs("div",{className:`flex items-center space-x-1 px-2 py-1 rounded-full text-sm ${t=s.status,{pending:"text-yellow-600 bg-yellow-100",confirmed:"text-blue-600 bg-blue-100",processing:"text-purple-600 bg-purple-100",shipped:"text-orange-600 bg-orange-100",delivered:"text-green-600 bg-green-100",cancelled:"text-red-600 bg-red-100"}[t]||"text-gray-600 bg-gray-100"}`,children:[I(s.status),e.jsx("span",{children:A(s.status)})]})]}),e.jsxs("p",{className:"text-gray-600 text-sm",children:["注文日: ",new Date(s.created_at).toLocaleDateString("ja-JP")]}),s.estimated_delivery_date&&e.jsxs("p",{className:"text-gray-600 text-sm",children:["お届け予定日: ",new Date(s.estimated_delivery_date).toLocaleDateString("ja-JP")]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",s.final_amount.toLocaleString()]})})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[s.order_items.slice(0,3).map(s=>e.jsxs("div",{className:"flex items-center space-x-4 bg-gray-50 p-3 rounded-lg",children:[e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-16 h-16 object-cover rounded",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["数量: ",s.quantity," × ¥",s.unit_price.toLocaleString()]})]}),e.jsxs("p",{className:"font-medium",children:["¥",s.total_price.toLocaleString()]})]},s.id)),s.order_items.length>3&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["他 ",s.order_items.length-3," 点"]})]}),s.tracking_number&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg mb-4",children:[e.jsx("h4",{className:"font-semibold text-orange-900 mb-1",children:"配送追跡"}),e.jsxs("p",{className:"text-sm text-orange-800",children:["追跡番号: ",s.tracking_number]})]}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(n,{variant:"secondary",size:"sm",onClick:()=>L(s),children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),"詳細を見る"]}),"delivered"===s.status&&e.jsxs(n,{variant:"secondary",size:"sm",onClick:()=>{alert("レビュー機能は準備中です")},children:[e.jsx(p,{className:"w-4 h-4 mr-1"}),"レビューを書く"]})]})})]},s.id);var t})]}),S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:"注文詳細"}),e.jsx("button",{onClick:()=>L(null),className:"text-gray-500 hover:text-gray-700",children:e.jsx(u,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"注文情報"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"注文番号:"})," ",S.order_number]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"注文日:"})," ",new Date(S.created_at).toLocaleDateString("ja-JP")]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"ステータス:"})," ",A(S.status)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"支払い方法:"})," ",O(S.payment_method)]}),S.estimated_delivery_date&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"お届け予定日:"})," ",new Date(S.estimated_delivery_date).toLocaleDateString("ja-JP")]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"配送先"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium",children:S.shipping_name}),e.jsxs("p",{children:["〒",S.shipping_postal_code]}),e.jsx("p",{children:S.shipping_address}),e.jsx("p",{children:S.shipping_phone})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"注文商品"}),e.jsx("div",{className:"space-y-3",children:S.order_items.map(s=>e.jsxs("div",{className:"flex items-center space-x-4 border-b pb-3",children:[e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["¥",s.unit_price.toLocaleString()," × ",s.quantity]})]}),e.jsxs("p",{className:"font-medium",children:["¥",s.total_price.toLocaleString()]})]},s.id))})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"料金詳細"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",S.total_amount.toLocaleString()]})]}),S.discount_amount>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsx("span",{children:S.discount_label||"ポイント利用"}),e.jsxs("span",{children:["-¥",S.discount_amount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"送料"}),e.jsx("span",{children:0===S.shipping_fee?"無料":`¥${S.shipping_fee.toLocaleString()}`})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",S.final_amount.toLocaleString()]})]})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx(n,{variant:"secondary",onClick:()=>L(null),children:"閉じる"})})]})})}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(j,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"注文をキャンセルしますか？"}),e.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(n,{variant:"secondary",onClick:()=>q(null),children:"戻る"}),e.jsx(n,{className:"bg-red-600 hover:bg-red-700",isLoading:C,onClick:()=>(async e=>{try{$(!0),z(null),J(null);const{data:s,error:t}=await l.rpc("cancel_order",{order_id:e,user_id:b?.id});if(t)throw t;if(!s.success)throw new Error(s.message||"キャンセルに失敗しました");J("注文をキャンセルしました"),q(null),await M(),setTimeout(()=>{J(null)},3e3)}catch(s){z("注文のキャンセルに失敗しました。")}finally{$(!1)}})(P),children:"キャンセルする"})]})]})})]})}export{b as OrderHistory};
