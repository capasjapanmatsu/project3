import{j as e}from"./data-vendor-BmFUkYzE.js";import{d as s,u as a,r as t}from"./core-vendor-DBEP70vW.js";import{C as r,B as i,s as o,a as n}from"./index-CDzr2Gkx.js";import{L as c,A as m,i as d}from"./ui-vendor-B3gor5_P.js";import"./heavy-vendor-Bb5jGJvT.js";function l(){const l=s(),x=a(),[h,u]=t.useState(!0),[f,j]=t.useState(null),[p,b]=t.useState(!1);return t.useEffect(()=>{(async()=>{try{u(!0);const e=window.location.hash;if(!e||!e.includes("access_token"))return void j("無効なMagic Linkです。もう一度ログインしてください。");const s=new URLSearchParams(e.substring(1)),a=s.get("access_token"),t=s.get("refresh_token");if(!a||!t)return void j("認証トークンが見つかりません。もう一度ログインしてください。");const{error:r}=await o.auth.setSession({access_token:a,refresh_token:t});if(r)throw r;const{data:{user:i},error:c}=await o.auth.getUser();if(c||!i)throw c||new Error("ユーザー情報の取得に失敗しました");const{data:m,error:d}=await o.from("profiles").select("id").eq("id",i.id).maybeSingle();if(d&&d.code,!m){const e=i.user_metadata||{},{error:s}=await o.from("profiles").upsert([{id:i.id,user_type:e.user_type||"user",name:e.name||i.email?.split("@")[0]||"ユーザー",postal_code:e.postal_code||"",address:e.address||"",phone_number:e.phone_number||""}],{onConflict:"id"})}i&&n(`trusted_device_${i.id}`,"true"),b(!0),setTimeout(()=>{l("/dashboard")},2e3)}catch(e){j(e.message||"マジックリンクの送信に失敗しました")}finally{u(!1)}})()},[l,x]),h?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(r,{className:"text-center p-8",children:[e.jsx(c,{className:"w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン処理中..."}),e.jsx("p",{className:"text-gray-600",children:"Magic Linkを処理しています。しばらくお待ちください。"})]})}):f?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(r,{className:"text-center p-8",children:[e.jsx(m,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-6",children:f}),e.jsx(i,{onClick:()=>l("/login"),children:"ログインページに戻る"})]})}):p?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(r,{className:"text-center p-8",children:[e.jsx(d,{className:"w-12 h-12 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログイン成功！"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Magic Linkでのログインに成功しました。ダッシュボードにリダイレクトします..."}),e.jsx(i,{onClick:()=>l("/dashboard"),children:"ダッシュボードへ"})]})}):null}export{l as MagicLink};
