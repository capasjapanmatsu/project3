const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-BHS2ZDIu.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as s}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{a,L as r}from"./router-Cg6wfOY4.js";import{B as i}from"./Button-BVIkPLCk.js";import{u as n,s as l,C as c}from"./index-Cxr3hxlQ.js";import{F as d,a5 as m,M as o,at as x,U as h,i as g,a4 as u,k as f,B as j,q as p,au as y,P as b,X as N,p as _,av as w,r as v,y as k,ah as S,t as I,aw as q}from"./ui-basic-icnN6BOT.js";import"./heavy-features-BIdEME4r.js";function D(){const{user:e,effectiveUserId:r}=n(),h=a(),[g,u]=t.useState([]),[f,j]=t.useState(null),[p,y]=t.useState(!0),[b,N]=t.useState(""),[_,w]=t.useState(""),[v,k]=t.useState(!1);t.useEffect(()=>{S()},[]),t.useEffect(()=>{f&&I()},[f,e]);const S=()=>{if(y(!0),N(""),!navigator.geolocation)return N("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"),void y(!1);navigator.geolocation.getCurrentPosition(e=>{j({latitude:e.coords.latitude,longitude:e.coords.longitude}),N("")},e=>{switch(e.code){case e.PERMISSION_DENIED:N("ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");break;case e.POSITION_UNAVAILABLE:N("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");break;case e.TIMEOUT:N("ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");break;default:N("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")}y(!1)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e5})},I=t.useCallback(async()=>{if(f&&e)try{y(!0),w("");const{data:s,error:t}=await l.from("dogs").select("\n          id,\n          name,\n          breed,\n          gender,\n          birth_date,\n          image_url,\n          owner_id,\n          created_at,\n          profiles!dogs_owner_id_fkey(name)\n        ").neq("owner_id",e?.id||r).limit(50);if(t)throw t;if(!s||0===s.length)return void u([]);const a=s.map(e=>{const s=35.6812+.3*(Math.random()-.5),t=139.7671+.3*(Math.random()-.5),a=q(f.latitude,f.longitude,s,t),r=e;return{...e,owner_name:r.profiles?.name||"Unknown",distance:a,last_seen_at:new Date(Date.now()-7*Math.random()*24*60*60*1e3).toISOString()}}).filter(s=>s.owner_id!==e.id).sort((e,s)=>e.distance-s.distance).slice(0,20);0,u(a)}catch(s){w("è¿‘ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")}finally{y(!1)}},[f,e]),q=(e,s,t,a)=>{const r=(t-e)*Math.PI/180,i=(a-s)*Math.PI/180,n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},D=e=>{const s=new Date(e),t=new Date,a=12*(t.getFullYear()-s.getFullYear())+t.getMonth()-s.getMonth();if(a<12)return`${a}ãƒ¶æœˆ`;{const e=Math.floor(a/12),s=a%12;return s>0?`${e}æ­³${s}ãƒ¶æœˆ`:`${e}æ­³`}},$=e=>"ã‚ªã‚¹"===e?"â™‚":"â™€";return b?s.jsx(c,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx(d,{className:"w-12 h-12 text-orange-500 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"ä½ç½®æƒ…å ±ãŒå¿…è¦ã§ã™"}),s.jsx("p",{className:"text-gray-600 mb-4",children:b}),s.jsxs(i,{onClick:S,className:"mb-2",children:[s.jsx(m,{className:"w-4 h-4 mr-2"}),"ä½ç½®æƒ…å ±ã‚’å–å¾—"]}),s.jsx("p",{className:"text-sm text-gray-500",children:"è¿‘ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™"})]})}):s.jsxs(c,{className:"p-6",children:[s.jsx("div",{className:"flex justify-between items-center mb-4",children:s.jsxs("div",{className:"flex items-center",children:[s.jsx(o,{className:"w-6 h-6 text-blue-600 mr-2"}),s.jsx("h2",{className:"text-xl font-bold",children:"è¿‘ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŸã¡"})]})}),s.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"ã‚ãªãŸã®è¿‘ãã«ã„ã‚‹ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŸã¡ã§ã™ï¼ˆã‚ãªãŸã®çŠ¬ã¯é™¤ãï¼‰"}),s.jsx("div",{className:"flex justify-end mb-2",children:s.jsxs(i,{size:"sm",variant:"secondary",onClick:S,disabled:p,children:[s.jsx(m,{className:"w-4 h-4 mr-1"}),"æ›´æ–°"]})}),_&&s.jsxs("div",{className:"mb-4 p-3 bg-red-50 rounded-lg flex items-start",children:[s.jsx(d,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),s.jsx("p",{className:"text-red-800 text-sm",children:_})]}),p?s.jsx("div",{className:"flex justify-center items-center h-32",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):0===g.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(o,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"è¿‘ãã«ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"}),s.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ã‹ã€æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„"})]}):s.jsxs("div",{className:"space-y-4",children:[(v?g:g.slice(0,5)).map(e=>{return s.jsxs("div",{className:"flex items-center space-x-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer",onClick:()=>(e=>{h(`/dog-profile/${e.id}`)})(e),children:[s.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full overflow-hidden flex-shrink-0",children:e.image_url?s.jsx("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover"}):s.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:"ðŸ•"})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[s.jsxs("h3",{className:"font-semibold text-lg",children:[e.name,(t=e.gender,"ã‚ªã‚¹"===t?"ãã‚“":"ã¡ã‚ƒã‚“")]}),s.jsx("span",{className:"text-sm text-gray-500",children:$(e.gender)})]}),s.jsx("div",{className:"text-sm text-gray-600 space-y-1",children:s.jsxs("p",{children:[e.breed," â€¢ ",D(e.birth_date)]})})]})]},e.id);var t}),g.length>5&&!v&&s.jsx("div",{className:"text-center pt-4",children:s.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>k(!0),className:"px-6 py-2",children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ®‹ã‚Š",g.length-5,"åŒ¹ï¼‰"]})}),v&&g.length>=20&&s.jsx("div",{className:"text-center pt-4",children:s.jsx("p",{className:"text-sm text-gray-500",children:"è¿‘ãã«æ›´ã«å¤šãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"})}),v&&g.length>5&&s.jsx("div",{className:"text-center pt-2",children:s.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>k(!1),className:"px-6 py-2",children:[s.jsx(x,{className:"w-4 h-4 mr-2 rotate-180"}),"æŠ˜ã‚ŠãŸãŸã‚€"]})})]}),s.jsx("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg",children:s.jsxs("div",{className:"flex items-start",children:[s.jsx(o,{className:"w-5 h-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0"}),s.jsxs("div",{className:"text-sm text-blue-800",children:[s.jsx("p",{className:"font-medium mb-1",children:"ä½ç½®æƒ…å ±ã«ã¤ã„ã¦"}),s.jsx("p",{children:"ãŠä½¿ã„ã®ä½ç½®æƒ…å ±ã‚’åŸºã«ã€è¿‘ã„é †ã§ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚ ä½ç½®æƒ…å ±ã¯ç«¯æœ«å†…ã§ã®ã¿å‡¦ç†ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚"})]})]})})]})}function $(){const{user:d,effectiveUserId:m,lineUser:x,isLineAuthenticated:$}=n(),A=d?.id||x?.id||m,P=a(),[M,T]=t.useState(()=>{const e=sessionStorage.getItem("communityActiveTab");return sessionStorage.removeItem("communityActiveTab"),"messages"===e?"messages":"friends"}),L=sessionStorage.getItem("communityOpenPartnerId");L&&sessionStorage.removeItem("communityOpenPartnerId");const[E,O]=t.useState([]),[z,J]=t.useState([]),[U,R]=t.useState([]),[B,F]=t.useState([]),[V,H]=t.useState({}),[K,Y]=t.useState({}),[G,Q]=t.useState({}),[W,X]=t.useState(!0),[Z,ee]=t.useState(null),[se,te]=t.useState(""),[ae,re]=t.useState(!1),[ie,ne]=t.useState(0),[le,ce]=t.useState([]),[de,me]=t.useState(!1),[oe,xe]=t.useState([]),[he,ge]=t.useState([]),[ue,fe]=t.useState(""),[je,pe]=t.useState(""),[ye,be]=t.useState([]),Ne="communityPreferredPrefecture",[_e,we]=t.useState(()=>localStorage.getItem(Ne)||"æ±äº¬éƒ½"),[ve,ke]=t.useState(!1),[Se,Ie]=t.useState(!1),[qe,De]=t.useState([]),[$e,Ce]=t.useState(null),[Ae,Pe]=t.useState("");t.useEffect(()=>{A&&L&&!Z&&ee({id:"new",friend_id:L,friend:{id:L,name:"",user_type:"user",created_at:(new Date).toISOString()},dog_count:0,created_at:(new Date).toISOString()})},[A]),t.useEffect(()=>{d||x||m||P("/login?redirect=/community&message="+encodeURIComponent("ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"))},[d,x,m,P]),t.useEffect(()=>{const e=d?.id||x?.id||m;if(e){try{const e=sessionStorage.getItem("community_cached");if(e){const{msgs:s,notifs:t,frs:a,friendsCache:r,ts:i}=JSON.parse(e);Array.isArray(s)&&F(s),Array.isArray(t)&&R(t),Array.isArray(a)&&O(a),Array.isArray(r)&&J(r),X(!1)}}catch{}Me(e)}},[d,x,m]),t.useEffect(()=>{try{localStorage.setItem(Ne,_e)}catch{}},[_e]);const Me=async e=>{try{X(!0),await Promise.allSettled([Le(e),Ee(e),Oe(e)]),X(!1),Promise.allSettled([ze(e),Je(e),Ue(e),Re(e)]);try{sessionStorage.setItem("community_cached",JSON.stringify({msgs:B,notifs:U,frs:E,friendsCache:z,ts:Date.now()}))}catch{}Te()}catch(s){X(!1)}},Te=()=>{if(!A)return;const e=l.channel("friend_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"friend_requests",filter:`requested_id=eq.${A}`},()=>{Le()}).subscribe(),s=l.channel("notifications_changes").on("postgres_changes",{event:"*",schema:"public",table:"notifications",filter:`user_id=eq.${A}`},()=>{Oe()}).subscribe(),t=l.channel("messages_changes").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${A}`},()=>{ze()}).subscribe();return()=>{e.unsubscribe(),s.unsubscribe(),t.unsubscribe()}},Le=async e=>{const{data:s,error:t}=await l.from("friend_requests").select("\n        *,\n        requester:profiles!friend_requests_requester_id_fkey(*)\n      ").eq("requested_id",e).eq("status","pending").order("created_at",{ascending:!1});if(t)throw t;O(s||[])},Ee=async e=>{const{data:s,error:t}=await l.rpc("get_friends_with_dogs",{p_user_id:e});if(t)throw t;J(s||[])},Oe=async e=>{const{data:s,error:t}=await l.from("notifications").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(20);if(t)throw t;R(s||[]);const a=s?.filter(e=>!e.read)||[];a.length>0&&await l.from("notifications").update({read:!0}).in("id",a.map(e=>e.id))},ze=async e=>{const{data:s,error:t}=await l.from("latest_messages").select("\n        *,\n        sender:profiles!messages_sender_id_fkey(*)\n      ").or(`sender_id.eq.${e},receiver_id.eq.${e}`).order("created_at",{ascending:!1});if(t)throw t;const a=s||[],r=[],i={};for(const l of a){const s=l.sender_id===e?l.receiver_id:l.sender_id;i[s]||(i[s]=!0,r.push(l))}F(r);const{data:n}=await l.from("messages").select("sender_id, read").eq("receiver_id",e).eq("read",!1),c={};(n||[]).forEach(e=>{c[e.sender_id]=(c[e.sender_id]||0)+1}),H(c);const d=r.map(s=>s.sender_id===e?s.receiver_id:s.sender_id);if(d.length>0){const{data:e}=await l.from("profiles").select("id, name, nickname, user_type").in("id",d),s={};(e||[]).forEach(e=>{s[e.id]={name:e.name||null,nickname:e.nickname||null,user_type:e.user_type||null}}),Y(s);const{data:t}=await l.from("dogs").select("owner_id, name, gender, created_at, image_url").in("owner_id",d).order("created_at",{ascending:!0}),a={};(t||[]).forEach(e=>{a[e.owner_id]||(a[e.owner_id]={name:e.name,gender:e.gender,image_url:e.image_url})}),Q(a)}else Y({}),Q({});if(L){const s=r.find(s=>(s.sender_id===e?s.receiver_id:s.sender_id)===L),t=L,a=map&&map[t]||{name:"",user_type:"user"};ee(s?{id:s.id,friend_id:t,friend:{id:t,name:a.name||"",user_type:a.user_type||"user",created_at:(new Date).toISOString()},dog_count:0,created_at:(new Date).toISOString()}:{id:"new",friend_id:t,friend:{id:t,name:a.name||"",user_type:a.user_type||"user",created_at:(new Date).toISOString()},dog_count:0,created_at:(new Date).toISOString()})}},Je=async e=>{const{data:s,error:t}=await l.from("dog_encounters").select("\n        *,\n        dog1:dogs!dog_encounters_dog1_id_fkey(*),\n        dog2:dogs!dog_encounters_dog2_id_fkey(*),\n        park:dog_parks(*)\n      ").order("encounter_date",{ascending:!1}).limit(10);if(t)throw t;xe(s||[])},Ue=async e=>{const{data:s,error:t}=await l.from("dogs").select("*").eq("owner_id",e);if(t)throw t;ge(s||[])},Re=async e=>{const{data:s,error:t}=await l.from("dog_blacklist").select("\n        *,\n        blacklisted_dog:dogs!dog_blacklist_dog_id_fkey(\n          *,\n          owner:profiles!dogs_owner_id_fkey(*)\n        )\n      ").eq("user_id",e).order("created_at",{ascending:!1});if(t)throw t;be(s||[])},Be=async(e,s)=>{try{const{error:t}=await l.from("friend_requests").update({status:s?"accepted":"rejected",responded_at:(new Date).toISOString()}).eq("id",e);if(t)throw t;if(s)try{const{data:s}=await l.from("friend_requests").select("from_user_id").eq("id",e).maybeSingle();s?.from_user_id&&await Fe(s.from_user_id)}catch{}await Le(),s&&await Ee(),pe(s?"å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã—ã¾ã—ãŸ":"å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã—ã¾ã—ãŸ"),setTimeout(()=>pe(""),3e3)}catch(t){fe("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ"),setTimeout(()=>fe(""),3e3)}},Fe=async s=>{try{const{notifyAppAndLine:t}=await e(async()=>{const{notifyAppAndLine:e}=await import("./notify-C6OTkr81.js");return{notifyAppAndLine:e}},__vite__mapDeps([0]));await t({userId:s,title:"å‹é”ç”³è«‹ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ",message:"ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†",linkUrl:`${window.location.origin}/community`,kind:"alert"})}catch{}},Ve=e=>{switch(e){case"friend_request":return s.jsx(f,{className:"w-5 h-5 text-blue-600"});case"friend_accepted":return s.jsx(q,{className:"w-5 h-5 text-green-600"});case"friend_at_park":return s.jsx(h,{className:"w-5 h-5 text-purple-600"});case"reservation_reminder":return s.jsx(k,{className:"w-5 h-5 text-orange-600"});case"blacklisted_dog_nearby":return s.jsx(g,{className:"w-5 h-5 text-red-600"});default:return s.jsx(j,{className:"w-5 h-5 text-gray-600"})}},He=e=>{switch(e){case"friend_request":return"bg-blue-50";case"friend_accepted":return"bg-green-50";case"friend_at_park":return"bg-purple-50";case"reservation_reminder":return"bg-orange-50";case"blacklisted_dog_nearby":return"bg-red-50";default:return"bg-gray-50"}},Ke=e=>"ã‚ªã‚¹"===e?"ãã‚“":"ã¡ã‚ƒã‚“",Ye=(e,s)=>{if(s&&s.length>0){const e=s[0];return`${e.name}${Ke(e.gender)}ã®é£¼ã„ä¸»ã•ã‚“`}return"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“"};return d||x||m?W?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"max-w-6xl mx-auto",children:[s.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[s.jsx(h,{className:"w-8 h-8 text-blue-600 mr-3"}),"ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£"]}),ue&&s.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[s.jsx(g,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{className:"text-red-800",children:ue})]}),je&&s.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[s.jsx(u,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{className:"text-green-800",children:je})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s.jsxs("div",{className:"lg:col-span-2",children:[s.jsx("div",{className:"bg-white border-b mb-6 -mx-4 px-4 md:mx-0 md:px-0",children:s.jsxs("div",{className:"grid grid-cols-3 md:grid-cols-6 gap-2",children:[s.jsxs("button",{className:"px-2 py-3 font-medium relative flex flex-col items-center space-y-1 rounded-lg transition-colors "+("friends"===M?"text-blue-600 bg-blue-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),onClick:()=>T("friends"),children:[s.jsx(h,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs",children:"å‹é”"})]}),s.jsxs("button",{className:"px-2 py-3 font-medium relative flex flex-col items-center space-y-1 rounded-lg transition-colors "+("requests"===M?"text-blue-600 bg-blue-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),onClick:()=>T("requests"),children:[s.jsx(f,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs",children:"ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"}),E.length>0&&s.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:E.length})]}),s.jsxs("button",{className:"px-2 py-3 font-medium relative flex flex-col items-center space-y-1 rounded-lg transition-colors "+("notifications"===M?"text-blue-600 bg-blue-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),onClick:()=>T("notifications"),children:[s.jsx(j,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs",children:"é€šçŸ¥"}),U.filter(e=>!e.read).length>0&&s.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:U.filter(e=>!e.read).length})]}),s.jsxs("button",{className:"px-2 py-3 font-medium relative flex flex-col items-center space-y-1 rounded-lg transition-colors "+("messages"===M?"text-blue-600 bg-blue-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),onClick:()=>T("messages"),children:[s.jsx(p,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs",children:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"}),B.filter(e=>!e.read&&e.receiver_id===d?.id).length>0&&s.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:B.filter(e=>!e.read&&e.receiver_id===d?.id).length})]}),s.jsxs("button",{className:"px-2 py-3 font-medium relative flex flex-col items-center space-y-1 rounded-lg transition-colors "+("nearby"===M?"text-blue-600 bg-blue-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),onClick:()=>T("nearby"),children:[s.jsx(o,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs",children:"è¿‘ãã®å­"})]}),s.jsxs("button",{className:"px-2 py-3 font-medium relative flex flex-col items-center space-y-1 rounded-lg transition-colors "+("blacklist"===M?"text-blue-600 bg-blue-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),onClick:()=>T("blacklist"),children:[s.jsx(g,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs",children:"ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ"}),ye.length>0&&s.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:ye.length})]})]})}),"friends"===M&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h2",{className:"text-xl font-semibold",children:"å‹é”ä¸€è¦§"}),s.jsx("div",{className:"flex items-center space-x-2",children:s.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>Ee(),children:[s.jsx(y,{className:"w-4 h-4 mr-1"}),"ä¸¦ã³æ›¿ãˆ"]})})]}),0===z.length?s.jsxs(c,{className:"text-center py-8",children:[s.jsx(h,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"ã¾ã å‹é”ãŒã„ã¾ã›ã‚“"}),s.jsx("p",{className:"text-gray-500 mb-4",children:"åŒã˜ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã§å‡ºä¼šã£ãŸãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“ã¨å‹é”ã«ãªã‚Œã¾ã™"})]}):s.jsx("div",{className:"space-y-4",children:z.map(e=>s.jsx(c,{className:"p-4 hover:shadow-md transition-shadow",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex items-start space-x-4",children:[s.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center",children:s.jsx(h,{className:"w-6 h-6 text-gray-500"})}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold",children:Ye(e.friend,e.friend_dogs)}),s.jsxs("p",{className:"text-sm text-gray-600",children:[e.dog_count,"é ­ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã¨ä¸€ç·’"]}),e.friend_dogs&&e.friend_dogs.length>0&&s.jsxs("div",{className:"flex items-center mt-1",children:[s.jsx(b,{className:"w-4 h-4 text-blue-600 mr-1"}),s.jsx("p",{className:"text-xs text-gray-500",children:e.friend_dogs.map(e=>`${e.name}${e.gender?Ke(e.gender):"ã¡ã‚ƒã‚“"}`).join("ã€")})]})]})]}),s.jsxs(i,{size:"sm",onClick:()=>ee(e),children:[s.jsx(p,{className:"w-4 h-4 mr-1"}),"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"]})]})},e.id))})]}),"requests"===M&&s.jsxs("div",{className:"space-y-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"}),0===E.length?s.jsxs(c,{className:"text-center py-8",children:[s.jsx(f,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"}),s.jsx("p",{className:"text-gray-500",children:"åŒã˜ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã§å‡ºä¼šã£ãŸäººã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"})]}):s.jsx("div",{className:"space-y-4",children:E.map(e=>s.jsx(c,{className:"p-4",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex items-start space-x-4",children:[s.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center",children:s.jsx(h,{className:"w-6 h-6 text-gray-500"})}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"}),s.jsx("p",{className:"text-sm text-gray-600",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),e.message&&s.jsx("p",{className:"text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded",children:e.message})]})]}),s.jsxs("div",{className:"flex space-x-2",children:[s.jsxs(i,{size:"sm",onClick:()=>Be(e.id,!0),children:[s.jsx(u,{className:"w-4 h-4 mr-1"}),"æ‰¿èª"]}),s.jsxs(i,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>Be(e.id,!1),children:[s.jsx(N,{className:"w-4 h-4 mr-1"}),"æ‹’å¦"]})]})]})},e.id))})]}),"nearby"===M&&s.jsx("div",{className:"space-y-6",children:s.jsxs(c,{className:"p-6 text-center",children:[s.jsx(o,{className:"w-12 h-12 text-blue-500 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"è¿‘ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŸã¡"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"GPSä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€è¿‘ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŸã¡ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"}),s.jsx("p",{className:"text-sm text-gray-500",children:"â€» è©³ç´°ã¯å³å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„"})]})}),"blacklist"===M&&s.jsxs("div",{className:"space-y-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ"}),0===ye.length?s.jsxs(c,{className:"text-center py-8",children:[s.jsx(g,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ç©ºã§ã™"}),s.jsx("p",{className:"text-gray-500",children:"ç›¸æ€§ãŒæ‚ªã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹ã¨ã€ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã«å…¥ã£ãŸæ™‚ã«é€šçŸ¥ã•ã‚Œã¾ã™"})]}):s.jsx("div",{className:"space-y-4",children:ye.map(e=>s.jsx(c,{className:"p-4 bg-red-50 border-red-200",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex items-start space-x-4",children:[s.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.blacklisted_dog?.image_url?s.jsx("img",{src:e.blacklisted_dog.image_url,alt:e.blacklisted_dog.name,className:"w-full h-full object-cover"}):s.jsx(b,{className:"w-6 h-6 text-gray-500"})}),s.jsxs("div",{children:[s.jsxs("h3",{className:"font-semibold text-red-900",children:[e.blacklisted_dog?.name,e.blacklisted_dog?.gender&&Ke(e.blacklisted_dog.gender)]}),s.jsx("p",{className:"text-sm text-red-700",children:"é£¼ã„ä¸»: ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“"}),s.jsxs("p",{className:"text-sm text-red-600 mt-1",children:["ç†ç”±: ",e.reason]}),s.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["ç™»éŒ²æ—¥: ",new Date(e.created_at).toLocaleDateString("ja-JP")]})]})]}),s.jsxs(i,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>(async e=>{try{const{error:s}=await l.from("dog_blacklist").delete().eq("id",e);if(s)throw s;await Re(),pe("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ"),setTimeout(()=>pe(""),3e3)}catch(s){fe("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"),setTimeout(()=>fe(""),3e3)}})(e.id),children:[s.jsx(N,{className:"w-4 h-4 mr-1"}),"å‰Šé™¤"]})]})},e.id))})]}),"notifications"===M&&s.jsxs("div",{className:"space-y-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"é€šçŸ¥"}),0===U.length?s.jsxs(c,{className:"text-center py-8",children:[s.jsx(j,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“"}),s.jsx("p",{className:"text-gray-500",children:"å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„äºˆç´„ã®é€šçŸ¥ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"})]}):s.jsx("div",{className:"space-y-4",children:U.map(e=>s.jsx(c,{className:`p-4 ${e.read?"":"border-l-4 border-blue-500"} ${He(e.type)}`,onClick:()=>!e.read&&(async e=>{try{const{error:s}=await l.from("notifications").update({read:!0}).eq("id",e);if(s)throw s;R(s=>s.map(s=>s.id===e?{...s,read:!0}:s))}catch(s){}})(e.id),children:s.jsxs("div",{className:"flex items-start space-x-3",children:[Ve(e.type),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"font-semibold",children:e.title}),s.jsx("p",{className:"text-sm text-gray-700",children:e.message}),s.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[new Date(e.created_at).toLocaleDateString("ja-JP")," ",new Date(e.created_at).toLocaleTimeString("ja-JP")]})]}),!e.read&&s.jsx("div",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full",children:"æ–°ç€"})]})},e.id))})]}),"messages"===M&&s.jsxs("div",{className:"space-y-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"}),0===B.length?s.jsxs(c,{className:"text-center py-8",children:[s.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“"}),s.jsx("p",{className:"text-gray-500",children:"å‹é”ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"})]}):s.jsx("div",{className:"space-y-4",children:B.map(e=>{const t=e.receiver_id===d?.id,a=e.sender_id===A?e.receiver_id:e.sender_id,r=K[a];let i="ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“";const n="capasjapan@gmail.com";if("admin"===r?.user_type||r?.name===n||r?.nickname===n)i="ãƒ‰ãƒƒã‚°ãƒ‘ãƒ¼ã‚¯JPç®¡ç†è€…";else{const e=G[a];if(e&&e.name){const s="male"===e.gender||"ã‚ªã‚¹"===e.gender?"ãã‚“":"female"===e.gender||"ãƒ¡ã‚¹"===e.gender?"ã¡ã‚ƒã‚“":"";i=`${e.name}${s}ã®é£¼ã„ä¸»ã•ã‚“`}else"owner"===r?.user_type&&(i=r.nickname||r.name||"ã‚ªãƒ¼ãƒŠãƒ¼")}return s.jsx(c,{className:"p-4 "+(!e.read&&t?"border-l-4 border-blue-500":""),onClick:()=>ee({id:e.id,friend_id:a,friend:{id:a,name:i,user_type:r?.user_type||"user",created_at:(new Date).toISOString()},dog_count:0,created_at:(new Date).toISOString()}),children:s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx("div",{className:"w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden",children:"admin"===r?.user_type?s.jsx("img",{src:"/icons/icon_android_96x96.png",alt:"ç®¡ç†è€…",loading:"lazy",className:"w-full h-full object-contain p-1"}):G[a]?.image_url?s.jsx("img",{src:G[a]?.image_url,alt:"çŠ¬",loading:"lazy",className:"w-full h-full object-cover"}):s.jsx(h,{className:"w-5 h-5 text-gray-500"})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("h3",{className:"font-semibold",children:i}),s.jsx("p",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleDateString("ja-JP")})]}),s.jsx("p",{className:"text-sm text-gray-700 mt-1",children:e.content})]}),(()=>{const e=V[a]||0;return e>0?s.jsxs("div",{className:"bg-red-500 text-white text-xs px-2 py-1 rounded-full",children:["æœªèª­ ",e]}):null})()]})},e.id)})})]}),Z&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:s.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h2",{className:"text-xl font-semibold",children:(()=>{const e=K[Z.friend_id],s=G[Z.friend_id];if("admin"===e?.user_type)return"ãƒ‰ãƒƒã‚°ãƒ‘ãƒ¼ã‚¯JPç®¡ç†è€…ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸";if(s?.name){const e="male"===s.gender||"ã‚ªã‚¹"===s.gender?"ãã‚“":"female"===s.gender||"ãƒ¡ã‚¹"===s.gender?"ã¡ã‚ƒã‚“":"";return`${s.name}${e}ã®é£¼ã„ä¸»ã•ã‚“ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`}return"owner"===e?.user_type?`${e.nickname||e.name||"ã‚ªãƒ¼ãƒŠãƒ¼"}ã•ã‚“ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"})()}),s.jsx("button",{onClick:()=>ee(null),className:"text-gray-500 hover:text-gray-700",children:s.jsx(N,{className:"w-6 h-6"})})]}),s.jsx(C,{viewerId:A,partnerId:Z.friend_id,refreshKey:ie,onMarkedRead:()=>ze(A)}),s.jsxs("form",{onSubmit:async s=>{if(s.preventDefault(),Z&&se.trim()){re(!0);try{const s=se.trim(),t=Z.friend_id,{data:a,error:r}=await l.from("messages").insert({sender_id:d?.id,receiver_id:t,content:s,read:!1}).select("id").single();if(r)throw r;const i=a?.id;if(i&&le.length>0){me(!0);for(const e of le)try{const s=`public/${d?.id}/${Date.now()}_${e.name}`,t=await l.storage.from("message-attachments").upload(s,e,{contentType:e.type});if(t.error)continue;const{data:a}=l.storage.from("message-attachments").getPublicUrl(t.data.path);await l.from("message_attachments").insert({message_id:i,file_url:a.publicUrl,file_type:"image",file_name:e.name})}catch{}ce([]),me(!1)}await ze(A),te(""),ne(e=>e+1);try{const{notifyAppAndLine:s}=await e(async()=>{const{notifyAppAndLine:e}=await import("./notify-C6OTkr81.js");return{notifyAppAndLine:e}},__vite__mapDeps([0])),a=he.length>0?he[0]?.name??"å‹é”":"å‹é”",r=`${window.location.origin}/community/messages`;await s({userId:t,title:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",message:`${a}ã•ã‚“ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸ`,linkUrl:r,kind:"alert"})}catch{}}catch(t){fe("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"),setTimeout(()=>fe(""),3e3)}finally{re(!1)}}},children:[s.jsxs("div",{className:"flex space-x-2",children:[s.jsx("input",{type:"text",value:se,onChange:e=>te(e.target.value),placeholder:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),s.jsxs(i,{type:"submit",isLoading:ae,disabled:!se.trim(),children:[s.jsx(_,{className:"w-4 h-4 mr-1"}),"é€ä¿¡"]})]}),s.jsxs("div",{className:"mt-2 flex items-center gap-3 text-sm",children:[s.jsxs("button",{type:"button",className:"flex items-center gap-1 text-blue-600 hover:text-blue-800",onClick:async()=>{try{if(!d?.id)return;ke(!0),Ie(!0);const{data:e}=await l.from("reservations").select("id, park_id, date, start_time, duration, reservation_type").eq("user_id",d.id).eq("reservation_type","whole_facility").eq("status","confirmed").order("date",{ascending:!1}).limit(10),s=e||[],t=Array.from(new Set(s.map(e=>e.park_id)));let a={};if(t.length>0){const{data:e}=await l.from("dog_parks").select("id,name").in("id",t);(e||[]).forEach(e=>{a[e.id]=e.name||"ãƒ‰ãƒƒã‚°ãƒ©ãƒ³"})}const r=new Date,i=s.map(e=>({id:e.id,park_id:e.park_id,park_name:a[e.park_id]||"ãƒ‰ãƒƒã‚°ãƒ©ãƒ³",date:String(e.date),start_time:e.start_time,duration:Number(e.duration||1)})).filter(e=>{const s=String(e.start_time).split(":"),t=parseInt(s[0]||"0",10)||0,a=parseInt(s[1]||"0",10)||0,i=String(e.date).split("-").map(e=>parseInt(e,10)),n=new Date(i[0],(i[1]||1)-1,i[2]||1,t,a,0);return new Date(n.getTime()+60*Math.max(1,e.duration)*60*1e3).getTime()>r.getTime()});De(i),i[0]&&Ce(i[0].id),Pe("")}finally{Ie(!1)}},children:[s.jsx(w,{className:"w-4 h-4"})," äºˆç´„ã‚’å…±æœ‰"]}),s.jsxs("label",{className:"flex items-center gap-1 text-gray-600 hover:text-gray-800 cursor-pointer",children:[s.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:e=>{const s=e.target.files?.[0];s&&ce(e=>[...e,s])}}),s.jsx(v,{className:"w-4 h-4"})," ç”»åƒæ·»ä»˜"]}),le.length>0&&s.jsxs("span",{className:"text-xs text-gray-500",children:[le.length,"ä»¶ã®ç”»åƒã‚’æ·»ä»˜äºˆå®š"]}),de&&s.jsx("span",{className:"text-xs text-gray-500",children:"ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."})]})]})]})})}),ve&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-[60]",children:s.jsxs("div",{className:"bg-white rounded-lg max-w-xl w-full p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-3",children:[s.jsx("h3",{className:"text-lg font-semibold",children:"å…±æœ‰ã™ã‚‹è²¸ã—åˆ‡ã‚Šäºˆç´„ã‚’é¸æŠž"}),s.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>ke(!1),children:s.jsx(N,{className:"w-5 h-5"})})]}),Se?s.jsx("div",{className:"text-center py-6",children:"èª­ã¿è¾¼ã¿ä¸­..."}):0===qe.length?s.jsx("div",{className:"text-sm text-gray-600",children:"è²¸ã—åˆ‡ã‚Šç¢ºå®šæ¸ˆã¿ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"}):s.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:qe.map(e=>{const t=String(e.start_time).split(":"),a=parseInt(t[0]||"0",10)||0,r=parseInt(t[1]||"0",10)||0,i=String(e.date).split("-").map(e=>parseInt(e,10)),n=new Date(i[0],(i[1]||1)-1,i[2]||1,a,r,0),l=new Date(n.getTime()+60*Math.max(1,e.duration)*60*1e3);return s.jsxs("label",{className:"flex items-start gap-3 p-3 rounded border "+($e===e.id?"border-blue-500 bg-blue-50":"border-gray-200"),children:[s.jsx("input",{type:"radio",name:"share-reservation",checked:$e===e.id,onChange:()=>Ce(e.id),className:"mt-1"}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:e.park_name}),s.jsxs("div",{className:"text-sm text-gray-600",children:[n.toLocaleString("ja-JP")," ã€œ ",l.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})]})]})]},e.id)})}),s.jsxs("div",{className:"mt-4",children:[s.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç·¨é›†å¯ï¼‰"}),s.jsx("textarea",{value:Ae,onChange:e=>Pe(e.target.value),className:"w-full border rounded p-2 text-sm",rows:3,placeholder:"äºˆç´„ã‚’å…±æœ‰ã—ã¾ã™ã€‚\\nï¼ˆã“ã“ã«è¿½è¨˜ãŒã‚ã‚Œã°ç·¨é›†ã—ã¦ãã ã•ã„ï¼‰"})]}),s.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[s.jsx(i,{variant:"secondary",onClick:()=>ke(!1),children:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"}),s.jsx(i,{onClick:async()=>{try{if(!d?.id||!$e)return;const e=qe.find(e=>e.id===$e),s=String(e.start_time).split(":"),t=parseInt(s[0]||"0",10)||0,a=parseInt(s[1]||"0",10)||0,r=String(e.date).split("-").map(e=>parseInt(e,10)),i=new Date(r[0],(r[1]||1)-1,r[2]||1,t,a,0),n=Math.max(1,Number(e.duration)||1),c=new Date(i.getTime()+60*n*60*1e3),m=Math.random().toString(36).slice(2)+Date.now().toString(36),{error:o}=await l.from("reservation_invites").insert({token:m,host_user_id:d.id,park_id:e.park_id,title:"ãƒ‰ãƒƒã‚°ãƒ©ãƒ³è²¸ã—åˆ‡ã‚Šã®ã”æ‹›å¾…",start_time:i.toISOString(),end_time:c.toISOString(),max_uses:null});if(o)throw o;const x=`${"http://localhost:3000"}/invite/${m}`,h=`${Ae&&Ae.trim().length>0?`${Ae.trim()}\n`:""}äºˆç´„ã‚’å…±æœ‰ã—ã¾ã™ã€‚${e.park_name} / ${i.toLocaleString("ja-JP")} ã€œ ${c.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})}ã€‚[ã“ã¡ã‚‰](${x})`;await l.from("messages").insert({sender_id:d.id,receiver_id:Z.friend_id,content:h,read:!1}),ne(e=>e+1),ke(!1),alert("æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸ")}catch(e){alert("æ‹›å¾…ãƒªãƒ³ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ")}},children:"é€ä¿¡"})]})]})})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsx(D,{}),s.jsxs(c,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(b,{className:"w-5 h-5 text-blue-600 mr-2"}),"æœ€è¿‘ã®å‡ºä¼šã„"]}),0===oe.length?s.jsx("p",{className:"text-gray-600 text-sm",children:"ã¾ã å‡ºä¼šã„ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"}):s.jsxs("div",{className:"space-y-4",children:[oe.slice(0,5).map(e=>{const t=e.dog1.owner_id===d?.id?e.dog1:e.dog2,a=e.dog1.owner_id===d?.id?e.dog2:e.dog1,r=a.owner_id;return s.jsxs("div",{className:"flex items-start space-x-3 pb-3 border-b border-gray-100 last:border-b-0 last:pb-0",children:[s.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:a.image_url?s.jsx("img",{src:a.image_url,alt:a.name,className:"w-full h-full object-cover"}):s.jsx(b,{className:"w-5 h-5 text-gray-500"})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("h3",{className:"font-medium text-sm",children:[t.name,Ke(t.gender),"ã¨",a.name,Ke(a.gender)]}),s.jsxs("div",{className:"flex space-x-1",children:[s.jsxs(i,{size:"sm",variant:"secondary",className:"text-xs px-2 py-1",onClick:()=>(async e=>{try{const{error:s}=await l.from("friend_requests").insert({requester_id:d?.id,requested_id:e,message:"ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã§ãŠä¼šã„ã—ãŸéš›ã¯ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼"});if(s)throw s;pe("å‹é”ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ"),setTimeout(()=>pe(""),3e3)}catch(s){fe("å‹é”ç”³è«‹ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"),setTimeout(()=>fe(""),3e3)}})(r,a.name),children:[s.jsx(f,{className:"w-3 h-3 mr-1"}),"å‹é”ç”³è«‹"]}),s.jsxs(i,{size:"sm",variant:"secondary",className:"text-xs px-2 py-1 text-red-600 hover:text-red-700",onClick:()=>{const e=prompt("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");e&&(async(e,s)=>{try{const{error:t}=await l.from("dog_blacklist").insert({user_id:d?.id,dog_id:e,reason:s,notify_when_nearby:!0});if(t)throw t;await Re(),pe("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ"),setTimeout(()=>pe(""),3e3)}catch(t){fe("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ"),setTimeout(()=>fe(""),3e3)}})(a.id,e)},children:[s.jsx(g,{className:"w-3 h-3 mr-1"}),"ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ"]})]})]}),s.jsxs("div",{className:"text-xs text-gray-500 space-y-1 mt-1",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(k,{className:"w-3 h-3 mr-1"}),s.jsx("span",{children:new Date(e.encounter_date).toLocaleDateString("ja-JP")})]}),s.jsxs("div",{className:"flex items-center",children:[s.jsx(o,{className:"w-3 h-3 mr-1"}),s.jsx("span",{children:e.park.name})]})]})]})]},e.id)}),s.jsxs(i,{variant:"secondary",size:"sm",className:"w-full",children:["ã™ã¹ã¦ã®å‡ºä¼šã„ã‚’è¦‹ã‚‹",s.jsx(S,{className:"w-4 h-4 ml-1"})]})]})]}),s.jsxs(c,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center",children:[s.jsx(o,{className:"w-5 h-5 text-blue-600 mr-2"}),"åœ°åŸŸæŽ²ç¤ºæ¿"]}),s.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"åœ°åŸŸåˆ¥ã®æƒ…å ±ç™ºä¿¡ã€æ„è¦‹äº¤æ›ã‚’ã—ã¾ã—ã‚‡ã†ã€‚"}),s.jsxs("div",{className:"flex gap-2 items-center",children:[s.jsx("select",{value:_e,onChange:e=>we(e.target.value),className:"flex-1 border rounded px-2 py-2 text-sm","aria-label":"éƒ½é“åºœçœŒã‚’é¸æŠž",children:["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸŽçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸŽçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼çŽ‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥žå¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡ŽçœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´ŽçœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´ŽçœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"].map(e=>s.jsx("option",{value:e,children:e},e))}),s.jsx(r,{to:`/community/boards?pref=${encodeURIComponent(_e)}`,children:s.jsx(i,{className:"whitespace-nowrap",children:"æŽ²ç¤ºæ¿ã‚’é–‹ã"})})]})]}),s.jsxs(c,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(I,{className:"w-5 h-5 text-pink-600 mr-2"}),"ã‚ãªãŸã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“"]}),0===he.length?s.jsxs("div",{className:"text-center py-4",children:[s.jsx("p",{className:"text-gray-600 text-sm mb-3",children:"ã¾ã ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),s.jsx(r,{to:"/dog-registration",children:s.jsx(i,{size:"sm",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²"})})]}):s.jsxs("div",{className:"space-y-3",children:[he.map(e=>s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?s.jsx("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover"}):s.jsx(b,{className:"w-5 h-5 text-gray-500"})}),s.jsxs("div",{children:[s.jsxs("h3",{className:"font-medium text-sm",children:[e.name,Ke(e.gender)]}),s.jsx("p",{className:"text-xs text-gray-500",children:e.breed})]})]},e.id)),s.jsx(r,{to:"/dog-registration",children:s.jsxs(i,{variant:"secondary",size:"sm",className:"w-full",children:[s.jsx(b,{className:"w-4 h-4 mr-1"}),"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’è¿½åŠ "]})})]})]}),s.jsxs(c,{className:"p-6 bg-blue-50 border-blue-200",children:[s.jsx("h2",{className:"text-lg font-semibold mb-3 text-blue-900",children:"ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚¬ã‚¤ãƒ‰"}),s.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"å‹é”ç”³è«‹ã«ã¤ã„ã¦:"}),s.jsx("br",{}),"åŒã˜ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã§å‡ºä¼šã£ãŸãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®é£¼ã„ä¸»ã•ã‚“ã¨ã®ã¿å‹é”ã«ãªã‚Œã¾ã™ã€‚"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½:"}),s.jsx("br",{}),"å‹é”ã«ãªã£ãŸæ–¹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šå–ã‚ŠãŒã§ãã¾ã™ã€‚æ¬¡å›žã®äºˆç´„ã‚’èª¿æ•´ã—ãŸã‚Šã€ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å…±æœ‰ã—ãŸã‚Šã—ã¾ã—ã‚‡ã†ã€‚"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"é€šçŸ¥æ©Ÿèƒ½:"}),s.jsx("br",{}),"å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„äºˆç´„ã®é€šçŸ¥ãŒå±Šãã¾ã™ã€‚å‹é”ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒè¿‘ãã®ãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã«ã„ã‚‹å ´åˆã‚‚é€šçŸ¥ã•ã‚Œã¾ã™ã€‚"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½:"}),s.jsx("br",{}),"ç›¸æ€§ãŒæ‚ªã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹ã¨ã€ãã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒãƒ‰ãƒƒã‚°ãƒ©ãƒ³ã«å…¥ã£ãŸæ™‚ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"æ–½è¨­å…±æœ‰æ©Ÿèƒ½:"}),s.jsx("br",{}),"æ–½è¨­è²¸ã—åˆ‡ã‚Šäºˆç´„ã‚’ã—ãŸå ´åˆã€å‹é”ã‚’èª˜ã£ã¦ãƒªãƒ¢ãƒ¼ãƒˆè§£éŒ ãƒªãƒ³ã‚¯ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚"]})]})]})]})]})]}):null}function C({viewerId:e,partnerId:a,refreshKey:r,onMarkedRead:i}){const[n,c]=t.useState([]),[d,m]=t.useState({}),o=t.useRef(null),x=e=>{const t=/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,a=[];let r=0;const i=e=>{const t=e.split(/\r?\n/);t.forEach((e,r)=>{e&&a.push(e),r<t.length-1&&a.push(s.jsx("br",{},`br-${a.length}`))})};let n;for(;null!==(n=t.exec(e));){const t=e.slice(r,n.index);t&&i(t),a.push(s.jsx("a",{href:n[2],target:"_blank",rel:"noreferrer",className:"text-black font-semibold underline",children:n[1]},`a-${a.length}`)),r=n.index+n[0].length}const l=e.slice(r);return l&&i(l),s.jsx(s.Fragment,{children:a})};return t.useEffect(()=>{(async()=>{const{data:s}=await l.from("messages").select("id, sender_id, receiver_id, content, read, created_at").in("sender_id",[e,a]).in("receiver_id",[e,a]).order("created_at",{ascending:!0});c(s||[]);const t=(s||[]).filter(s=>s.receiver_id===e&&!1===s.read).map(e=>e.id);t.length>0&&(await l.from("messages").update({read:!0}).in("id",t),i());const r=(s||[]).map(e=>e.id);if(r.length>0){const{data:e}=await l.from("message_attachments").select("message_id, file_url, file_type, file_name").in("message_id",r),s={};(e||[]).forEach(e=>{s[e.message_id]||(s[e.message_id]=[]),s[e.message_id].push({file_url:e.file_url,file_type:e.file_type,file_name:e.file_name})}),m(s)}else m({});setTimeout(()=>{o.current&&(o.current.scrollTop=o.current.scrollHeight)},0)})()},[e,a,r]),s.jsx("div",{ref:o,className:"h-96 overflow-y-auto mb-4 p-3 bg-gray-50 rounded-lg space-y-2",children:0===n.length?s.jsx("div",{className:"text-center text-gray-500 text-sm py-4",children:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“"}):n.map(t=>s.jsx("div",{className:"flex "+(t.sender_id===e?"justify-end":"justify-start"),children:s.jsxs("div",{className:"max-w-[80%] space-y-2",children:[s.jsx("div",{className:"px-3 py-2 rounded-lg text-sm "+(t.sender_id===e?"bg-blue-500 text-white":"bg-white border"),children:x(t.content)}),d[t.id]?.length?s.jsx("div",{className:"grid grid-cols-2 gap-2",children:d[t.id].map((e,t)=>"image"===e.file_type?s.jsx("a",{href:e.file_url,target:"_blank",rel:"noreferrer",className:"block",children:s.jsx("img",{src:e.file_url,alt:e.file_name,loading:"lazy",className:"rounded border object-cover h-24 w-full"})},t):s.jsx("a",{href:e.file_url,target:"_blank",rel:"noreferrer",className:"block text-xs text-blue-700 underline",children:e.file_name||"æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«"},t))}):null]})},t.id))})}export{$ as Community};
