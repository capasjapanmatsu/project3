import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{u as a,s as t,S as r,B as n}from"./index-DZFFGm9Y.js";import{C as l}from"./Card-DqVnP9TA.js";import{C as i}from"./CouponDisplay-DIMjfwwk.js";import{az as c,G as d,d as o,x,M as m,C as u,J as p}from"./ui-basic-C77EGLVg.js";import"./heavy-features-Dlg1c9Yc.js";import"./router-DXQOdrLL.js";import"./supabase-D2tiogv8.js";function h(){const{user:h}=a(),[j,g]=s.useState([]),[b,N]=s.useState(!0),[y,f]=s.useState("available"),[v,w]=s.useState(""),[_,D]=s.useState(!1),[C,S]=s.useState(null);s.useEffect(()=>{h&&k()},[h]);const k=async()=>{if(h)try{N(!0);const{data:e,error:s}=await t.from("user_coupons").select("\n          *,\n          coupon:facility_coupons(\n            *,\n            facility:pet_facilities(\n              name,\n              address\n            )\n          )\n        ").eq("user_id",h.id).order("obtained_at",{ascending:!1});if(s)throw s;g(e||[])}catch(e){w("クーポン情報の取得に失敗しました。")}finally{N(!1)}},F=e=>e.discount_value?"percentage"===e.discount_type?`${e.discount_value}% OFF`:`${e.discount_value.toLocaleString()}円 OFF`:"",J=s=>{const a=new Date,t=new Date(s.coupon.end_date);return s.is_used?e.jsx("span",{className:"px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:"使用済み"}):t<a?e.jsx("span",{className:"px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full",children:"期限切れ"}):e.jsx("span",{className:"px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full",children:"利用可能"})},L=(()=>{const e=new Date;switch(y){case"available":return j.filter(s=>!s.is_used&&new Date(s.coupon.end_date)>=e);case"used":return j.filter(e=>e.is_used);case"expired":return j.filter(s=>!s.is_used&&new Date(s.coupon.end_date)<e);default:return j}})();return h?e.jsxs(e.Fragment,{children:[e.jsx(r,{title:"マイクーポン - ドッグパークJP",description:"取得したクーポンを管理・利用できます。"}),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-2 flex items-center justify-center",children:[e.jsx(c,{className:"w-8 h-8 mr-3 text-pink-500"}),"マイクーポン"]}),e.jsx("p",{className:"text-gray-600",children:"取得したクーポンの管理・利用ができます"})]}),v&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 mb-6",children:v}),e.jsx(l,{className:"mb-6",children:e.jsx("div",{className:"border-b",children:e.jsxs("nav",{className:"flex space-x-8 px-6",children:[e.jsxs("button",{onClick:()=>f("available"),className:"py-4 px-2 border-b-2 font-medium text-sm "+("available"===y?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[e.jsx(d,{className:"w-4 h-4 inline mr-2"}),"利用可能 (",j.filter(e=>!e.is_used&&new Date(e.coupon.end_date)>=new Date).length,")"]}),e.jsxs("button",{onClick:()=>f("used"),className:"py-4 px-2 border-b-2 font-medium text-sm "+("used"===y?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[e.jsx(o,{className:"w-4 h-4 inline mr-2"}),"使用済み (",j.filter(e=>e.is_used).length,")"]}),e.jsxs("button",{onClick:()=>f("expired"),className:"py-4 px-2 border-b-2 font-medium text-sm "+("expired"===y?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[e.jsx(x,{className:"w-4 h-4 inline mr-2"}),"期限切れ (",j.filter(e=>!e.is_used&&new Date(e.coupon.end_date)<new Date).length,")"]})]})})}),b?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(s=>e.jsx(l,{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-3/4"})]})]})},s))}):0===L.length?e.jsxs(l,{className:"p-12 text-center",children:[e.jsx(c,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:["available"===y&&"利用可能なクーポンがありません","used"===y&&"使用済みのクーポンがありません","expired"===y&&"期限切れのクーポンがありません"]}),e.jsxs("p",{className:"text-gray-600 mb-6",children:["available"===y&&"施設一覧からクーポンを取得してみましょう","used"===y&&"まだクーポンを使用していません","expired"===y&&"期限切れのクーポンはありません"]}),"available"===y&&e.jsx(n,{onClick:()=>window.location.href="/parks?view=facilities",children:"施設一覧を見る"})]}):e.jsx("div",{className:"space-y-4",children:L.map(s=>e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:s.coupon.title}),J(s),F(s.coupon)&&e.jsx("span",{className:"text-2xl font-bold text-red-600",children:F(s.coupon)})]}),e.jsx("p",{className:"text-gray-700 mb-3",children:s.coupon.service_content}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(m,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsxs("span",{className:"text-gray-600",children:[s.coupon.facility?.name," - ",s.coupon.facility?.address]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(u,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsxs("span",{className:"text-gray-600",children:["有効期限: ",new Date(s.coupon.end_date).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsxs("span",{className:"text-gray-600",children:["取得日: ",new Date(s.obtained_at).toLocaleDateString("ja-JP")]})]}),s.is_used&&s.used_at&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsxs("span",{className:"text-gray-600",children:["使用日: ",new Date(s.used_at).toLocaleDateString("ja-JP")]})]})]}),s.coupon.description&&e.jsx("p",{className:"text-sm text-gray-500",children:s.coupon.description})]}),e.jsx("div",{className:"ml-4",children:"available"===y&&e.jsxs(n,{onClick:()=>(e=>{if(e.is_used&&"once"===e.coupon.usage_limit_type)return void alert("このクーポンは既に使用済みです。");const s=new Date;new Date(e.coupon.end_date)<s?alert("このクーポンは有効期限が切れています。"):(S(e),D(!0))})(s),className:"bg-green-600 hover:bg-green-700",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"クーポンを表示"]})})]}),s.coupon.coupon_image_url&&e.jsx("div",{className:"mt-4",children:e.jsx("img",{src:s.coupon.coupon_image_url,alt:"クーポン画像",className:"max-w-md h-auto border rounded-lg"})})]},s.id))})]}),_&&C&&e.jsx(i,{userCoupon:C,onClose:()=>{D(!1),S(null),k()}})]})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs(l,{className:"p-8 text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"ログインが必要です"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"クーポンを確認するにはログインしてください。"})]})})}export{h as MyCoupons};
