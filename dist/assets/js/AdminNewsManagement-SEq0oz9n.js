import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{a as t,L as r}from"./router-DXQOdrLL.js";import{u as a,s as n,l as i,k as l,c,B as o}from"./index-DrlBAW2y.js";import{C as d}from"./Card-DqVnP9TA.js";import{I as m}from"./Input-R783aYSb.js";import{S as x}from"./Select-YTmN6qyT.js";import{B as u,j as f,q as h,t as g,Q as p,X as j,T as y,m as b,F as w,_ as N}from"./ui-basic-CJygcczc.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function v(){const{user:t}=a(),[r,N]=s.useState([]),[v,_]=s.useState({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),[k,S]=s.useState(null),[C,E]=s.useState(!1),[q,T]=s.useState(!1),[D,I]=s.useState(""),[L,P]=s.useState("");s.useEffect(()=>{A(),$()},[]);const $=async()=>{if(t)try{const{data:e,error:s}=await n.from("profiles").select("*").eq("id",t.id).single();if(s&&"PGRST116"===s.code){const{data:e,error:s}=await n.from("profiles").insert([{id:t.id,user_type:"admin",name:t.email||"Admin User",email:t.email}]).select().single();s?(i("error","Error creating admin profile:",{createError:s}),I("管理者プロファイルの作成に失敗しました。")):(i("info","Admin profile created successfully:",{newProfile:e}),P("管理者プロファイルを作成しました。"),setTimeout(()=>P(""),3e3))}else if(s)i("error","Error fetching user profile:",{error:s}),I("ユーザープロファイルの取得に失敗しました。");else if(!e||"admin"!==e.user_type){i("info","Updating user to admin...");const{error:e}=await n.from("profiles").update({user_type:"admin"}).eq("id",t.id);e?(i("error","Error updating user to admin:",{updateError:e}),I("管理者権限の設定に失敗しました。")):(i("info","User updated to admin successfully"),P("管理者権限を設定しました。ページを手動でリロードしてください。"),setTimeout(()=>P(""),5e3))}}catch(e){i("error","Error checking user profile:",{error:l(e)}),I("ユーザープロファイルの確認に失敗しました。")}},A=async()=>{try{const e=await c(()=>n.from("news_announcements").select("*").order("created_at",{ascending:!1}));if(e.error)throw e.error;N(e.data||[]),I("")}catch(e){i("error","Error fetching news:",{error:l(e)}),I("新着情報の取得に失敗しました。")}},z=e=>({news:"お知らせ",announcement:"重要なお知らせ",sale:"セール情報"}[e]||e),F=s=>{switch(s){case"news":return e.jsx(w,{className:"w-4 h-4"});case"announcement":return e.jsx(b,{className:"w-4 h-4"});case"sale":return e.jsx(y,{className:"w-4 h-4"});default:return e.jsx(u,{className:"w-4 h-4"})}};return e.jsxs(e.Fragment,{children:[e.jsxs(d,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(u,{className:"w-5 h-5 text-blue-600 mr-2"}),"新着情報管理"]}),e.jsxs(o,{onClick:()=>{S(null),_({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),E(!0)},children:[e.jsx(f,{className:"w-4 h-4 mr-2"}),"新着情報を追加"]})]}),D&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start",children:[e.jsx(h,{className:"w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:D})]}),L&&e.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start",children:[e.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5 mr-2 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:L})]}),e.jsx("div",{className:"space-y-4",children:0===r.length?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"新着情報がありません"}):r.map(s=>{return e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${t=s.category,{news:"bg-blue-100 text-blue-800",announcement:"bg-red-100 text-red-800",sale:"bg-green-100 text-green-800"}[t]||"bg-gray-100 text-gray-800"}`,children:[F(s.category),e.jsx("span",{children:z(s.category)})]}),s.is_important&&e.jsx("span",{className:"bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium",children:"重要"})]}),e.jsx("h3",{className:"font-bold text-lg mb-2",children:s.title}),e.jsx("p",{className:"text-sm text-gray-700 mb-2 line-clamp-2",children:s.content}),e.jsxs("div",{className:"text-xs text-gray-500",children:["作成日: ",new Date(s.created_at).toLocaleString("ja-JP"),s.updated_at!==s.created_at&&e.jsxs("span",{children:[" / 更新日: ",new Date(s.updated_at).toLocaleString("ja-JP")]})]})]}),e.jsxs("div",{className:"flex space-x-2 ml-4",children:[e.jsxs(o,{variant:"secondary",size:"sm",onClick:()=>(e=>{S(e),_({title:e.title,content:e.content,category:e.category,is_important:e.is_important||!1,image_url:"",link_url:""}),E(!0)})(s),disabled:q,children:[e.jsx(p,{className:"w-4 h-4 mr-1"}),"編集"]}),e.jsxs(o,{variant:"danger",size:"sm",onClick:()=>(async e=>{if(confirm("この新着情報を削除してもよろしいですか？"))try{T(!0),I("");const{error:s}=await n.from("news_announcements").delete().eq("id",e);if(s)throw s;P("新着情報を削除しました。"),await A(),setTimeout(()=>{P("")},3e3)}catch(s){i("error","Error deleting news:",{error:l(s)}),I("新着情報の削除に失敗しました。")}finally{T(!1)}})(s.id),disabled:q,children:[e.jsx(j,{className:"w-4 h-4 mr-1"}),"削除"]})]})]})},s.id);var t})})]}),C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:k?"新着情報を編集":"新着情報を追加"}),e.jsx("button",{onClick:()=>E(!1),className:"text-gray-500 hover:text-gray-700",disabled:q,children:e.jsx(j,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),v.title.trim())if(v.content.trim())if(t)try{T(!0),I(""),P("");const{data:e,error:s}=await n.from("profiles").select("*").eq("id",t.id).single(),r={title:v.title,content:v.content,category:v.category,is_important:v.is_important,created_by:t?.id};if(k){const{error:e}=await n.from("news_announcements").update({title:v.title,content:v.content,category:v.category,is_important:v.is_important,updated_at:(new Date).toISOString()}).eq("id",k.id);if(e)throw e;P("新着情報を更新しました。")}else{i("info","Attempting to insert new announcement...");const{data:e,error:s}=await n.from("news_announcements").insert([r]).select();if(i("info","Insert result:",{insertResult:e}),s)throw i("error","Insert error details:",{message:s.message,details:s.details,hint:s.hint,code:s.code}),s;P("新着情報を追加しました。")}_({title:"",content:"",category:"news",is_important:!1,image_url:"",link_url:""}),S(null),E(!1),await A(),setTimeout(()=>{P("")},3e3)}catch(s){i("error","=== エラー詳細 ==="),i("error","Error saving news:",{error:l(s)});let e="新着情報の保存に失敗しました。";s&&"object"==typeof s&&("message"in s&&"string"==typeof s.message&&(e+=` エラー詳細: ${s.message}`),"details"in s&&"string"==typeof s.details&&(e+=` 詳細: ${s.details}`),"hint"in s&&"string"==typeof s.hint&&(e+=` ヒント: ${s.hint}`),"code"in s&&(e+=` コード: ${s.code}`)),I(e)}finally{T(!1)}else I("ユーザーが認証されていません。ログインしてください。");else I("内容を入力してください。");else I("タイトルを入力してください。")},children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{label:"タイトル *",value:v.title,onChange:e=>_({...v,title:e.target.value}),required:!0,disabled:q}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容 *"}),e.jsx("textarea",{value:v.content,onChange:e=>_({...v,content:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:6,required:!0,disabled:q})]}),e.jsx(x,{label:"カテゴリー *",options:[{value:"news",label:"お知らせ"},{value:"announcement",label:"重要なお知らせ"},{value:"sale",label:"セール情報"}],value:v.category,onChange:e=>_({...v,category:e.target.value}),required:!0,disabled:q}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_important",checked:v.is_important,onChange:e=>_({...v,is_important:e.target.checked}),className:"rounded text-blue-600",disabled:q}),e.jsx("label",{htmlFor:"is_important",className:"text-sm text-gray-700",children:"重要なお知らせとして表示する"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx(o,{type:"button",variant:"secondary",onClick:()=>E(!1),disabled:q,children:"キャンセル"}),e.jsx(o,{type:"submit",isLoading:q,children:k?"更新する":"追加する"})]})]})]})})})]})}function _(){const{user:n,isAdmin:i}=a(),l=t();return s.useEffect(()=>{i||l("/")},[i,l]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(r,{to:"/admin",children:e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:e.jsx(N,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(u,{className:"w-8 h-8 text-yellow-600 mr-3"}),"新着情報管理"]}),e.jsx("p",{className:"text-gray-600",children:"サイトの新着情報を管理します"})]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["最終更新: ",(new Date).toLocaleString("ja-JP")]})]}),e.jsx(v,{})]})}export{_ as AdminNewsManagement};
