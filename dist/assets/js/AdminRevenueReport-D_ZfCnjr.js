import{j as e}from"./motion-BHsL7Azw.js";import{r as a}from"./react-vendor-CMvmJHsS.js";import{a as s,L as t}from"./router-DXQOdrLL.js";import{C as r}from"./Card-DqVnP9TA.js";import{u as l,s as n,B as c}from"./index-DgI-OqlS.js";import{I as i}from"./Input-BL9Dcu5J.js";import{d as o}from"./csvExport-CWWwNDcn.js";import{_ as m,aD as d,D as x,q as u,Y as p,Z as h,w as j,n as b,an as f,C as w}from"./ui-basic-D1oJx_i8.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function y(){const{user:y,isAdmin:g}=l(),v=s(),[N,_]=a.useState(!0),[k,S]=a.useState(""),[C,L]=a.useState([]),[D,F]=a.useState([]),[P,$]=a.useState(""),[M,O]=a.useState((new Date).getFullYear()),[Y,I]=a.useState((new Date).getMonth()),[E,R]=a.useState(0),[z,A]=a.useState(0),[T,q]=a.useState(0),B=Array.from({length:4},(e,a)=>{const s=(new Date).getFullYear()-a;return{value:s,label:`${s}年`}});a.useEffect(()=>{g?V():v("/")},[g,v,M,Y]),a.useEffect(()=>{C.length>0&&Z()},[C,P]);const V=async()=>{try{_(!0),S("");const e=new Date(M,Y,1),a=new Date(M,Y+1,0),s=e.toISOString().split("T")[0],t=a.toISOString().split("T")[0],{data:r,error:l}=await n.rpc("get_monthly_revenue_by_park",{start_date_param:s,end_date_param:t});if(l)throw l;const c=(r||[]).map(e=>({owner_id:e.owner_id,owner_name:e.owner_name,park_id:e.park_id,park_name:e.park_name,total_revenue:e.total_revenue,platform_fee:Math.round(.2*e.total_revenue),owner_payout:Math.round(.8*e.total_revenue),bank_name:e.bank_name||"未設定",bank_code:e.bank_code||"未設定",branch_name:e.branch_name||"未設定",branch_code:e.branch_code||"未設定",account_type:e.account_type||"ordinary",account_number:e.account_number||"未設定",month:Y+1,year:M}));L(c);const i=c.reduce((e,a)=>(e.totalRevenue+=a.total_revenue,e.totalPlatformFee+=a.platform_fee,e.totalOwnerPayout+=a.owner_payout,e),{totalRevenue:0,totalPlatformFee:0,totalOwnerPayout:0});R(i.totalRevenue),A(i.totalPlatformFee),q(i.totalOwnerPayout),Z()}catch(e){S("売上データの取得に失敗しました。")}finally{_(!1)}},Z=()=>{if(!P.trim())return void F(C);const e=C.filter(e=>e.owner_name.toLowerCase().includes(P.toLowerCase())||e.park_name.toLowerCase().includes(P.toLowerCase()));F(e)};return N?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(t,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(d,{className:"w-8 h-8 text-green-600 mr-3"}),"ドッグラン売上レポート"]}),e.jsxs(c,{onClick:()=>{const e=D.map(e=>[e.owner_name,e.park_name,e.total_revenue,e.platform_fee,e.owner_payout,e.bank_name,e.bank_code,e.branch_name,e.branch_code,"ordinary"===e.account_type?"普通":"当座",e.account_number,e.year,e.month]);o(["オーナー名","ドッグラン名","売上合計額","プラットフォーム手数料（20%）","振込金額（80%）","銀行名","銀行コード","支店名","支店コード","口座種別","口座番号","年","月"],e,`ドッグラン売上_${M}年${Y+1}月.csv`)},disabled:0===D.length,children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"CSV出力"]})]}),k&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 flex items-start",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{children:k})]}),e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(c,{variant:"secondary",size:"sm",onClick:()=>{0===Y?(O(M-1),I(11)):I(Y-1)},children:e.jsx(p,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("select",{value:M,onChange:e=>O(Number(e.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:B.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),e.jsx("select",{value:Y,onChange:e=>I(Number(e.target.value)),className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[{value:0,label:"1月"},{value:1,label:"2月"},{value:2,label:"3月"},{value:3,label:"4月"},{value:4,label:"5月"},{value:5,label:"6月"},{value:6,label:"7月"},{value:7,label:"8月"},{value:8,label:"9月"},{value:9,label:"10月"},{value:10,label:"11月"},{value:11,label:"12月"}].map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsx(c,{variant:"secondary",size:"sm",onClick:()=>{const e=new Date,a=e.getFullYear(),s=e.getMonth();M===a&&Y===s||(11===Y?(O(M+1),I(0)):I(Y+1))},disabled:M===(new Date).getFullYear()&&Y===(new Date).getMonth(),children:e.jsx(h,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"w-full md:w-64",children:e.jsx(i,{label:"",value:P,onChange:e=>$(e.target.value),placeholder:"オーナー名・ドッグラン名で検索...",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})})})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"総売上"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",E.toLocaleString()]})]}),e.jsx(d,{className:"w-8 h-8 text-green-600"})]})}),e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"プラットフォーム手数料（20%）"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600",children:["¥",z.toLocaleString()]})]}),e.jsx(b,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"オーナー振込額（80%）"}),e.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:["¥",T.toLocaleString()]})]}),e.jsx(f,{className:"w-8 h-8 text-purple-600"})]})})]}),e.jsxs(r,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ドッグラン別売上"}),0===D.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(w,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"この月の売上データはありません"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"オーナー名"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン名"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"売上合計"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料（20%）"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込金額（80%）"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"振込先"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:D.map(a=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:a.owner_name}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:a.park_name}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:["¥",a.total_revenue.toLocaleString()]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:["¥",a.platform_fee.toLocaleString()]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600",children:["¥",a.owner_payout.toLocaleString()]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:"未設定"!==a.bank_name?e.jsxs("div",{children:[e.jsxs("p",{children:[a.bank_name,"（",a.bank_code,"）"]}),e.jsxs("p",{children:[a.branch_name,"（",a.branch_code,"）"]}),e.jsxs("p",{children:["ordinary"===a.account_type?"普通":"当座"," ",a.account_number]})]}):e.jsx("span",{className:"text-red-600",children:"未設定"})})]},`${a.park_id}-${a.month}-${a.year}`))})]})})]}),e.jsx(r,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(f,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"振込情報について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 振込は毎月15日に前月分を一括で行います"}),e.jsx("p",{children:"• 振込手数料は当社負担です"}),e.jsx("p",{children:"• 振込先情報が未設定のオーナーには振込ができません"}),e.jsx("p",{children:"• 振込金額が5,000円未満の場合は翌月に繰り越されます"}),e.jsx("p",{children:"• 振込完了後、オーナーに自動でメールが送信されます"})]})]})]})})]})}export{y as AdminRevenueReport};
