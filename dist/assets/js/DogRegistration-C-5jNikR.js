import{j as e}from"./motion-BHsL7Azw.js";import{r as a}from"./react-vendor-CMvmJHsS.js";import{a as r,L as t}from"./router-DXQOdrLL.js";import{s,u as i,S as l,B as n}from"./index-BKW8K1ja.js";import{C as o}from"./Card-DqVnP9TA.js";import{I as c}from"./ImageCropper-atxcrJLn.js";import{I as d}from"./Input-BL9Dcu5J.js";import{S as m}from"./Select-YTmN6qyT.js";import{d as b}from"./dogBreeds-6lxY8Uni.js";import{l as g,n as u}from"./notification-C37g_ZFh.js";import{_ as x,X as h,a0 as p}from"./ui-basic-D1oJx_i8.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";const f=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}},j=async(e,a)=>{try{const r=f(e);if(!r.isValid)return{success:!1,error:r.error};const t=Date.now(),i=e.name.split(".").pop()||"jpg",l=`${a.dogId}/${a.imageType}_${t}.${i}`,{data:n,error:o}=await s.storage.from("vaccine-certs").upload(l,e,{cacheControl:"3600",upsert:!0,contentType:e.type});return o?{success:!1,error:`アップロードに失敗しました: ${o.message}`,errorCode:o.message}:{success:!0,filePath:l}}catch(r){return{success:!1,error:`アップロード中にエラーが発生しました: ${r.message}`}}};function y(){const{user:y}=i(),v=r(),[N,w]=a.useState(!1),[D,I]=a.useState(""),[S,_]=a.useState(!1),[C,V]=a.useState(null),[$,E]=a.useState(null),[q,k]=a.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),M=(new Date).getFullYear(),Y=Array.from({length:21},(e,a)=>{const r=M-a;return{value:r.toString(),label:`${r}年`}}),O=Array.from({length:12},(e,a)=>{const r=a+1;return{value:r.toString().padStart(2,"0"),label:`${r}月`}}),U=async(e,a)=>{const r=e.target.files?.[0];if(r)try{const e=f(r);if(!e.isValid)return void I(e.error||"ファイルが無効です。");k(e=>({...e,[`${a}VaccineImage`]:r})),I("")}catch(t){I("ファイルの検証中にエラーが発生しました。")}};return e.jsxs(e.Fragment,{children:[e.jsx(l,{title:"ワンちゃん登録",description:"愛犬の情報を登録してドッグランを利用しましょう"}),e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-blue-50 to-white py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(t,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-700 mb-4",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"愛犬の基本情報とワクチン証明書を登録してください"})]}),e.jsx(o,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),y)if(q.name.trim())if(q.breed)if(q.birthYear&&q.birthMonth&&q.birthDay)if(q.gender)if(C)if(q.rabiesVaccineImage)if(q.comboVaccineImage)if(q.rabiesExpiryDate)if(q.comboExpiryDate){w(!0),I("");try{const e=`dog-profiles/${y.id}/${Date.now()}_${C.name}`,{data:a,error:r}=await s.storage.from("dog-images").upload(e,C,{cacheControl:"3600",upsert:!1});if(r)throw new Error(`プロフィール画像のアップロードに失敗しました: ${r.message}`);const{data:t}=s.storage.from("dog-images").getPublicUrl(e);let i="",l="";if(q.rabiesVaccineImage){i=(await j(q.rabiesVaccineImage,y.id)).url}if(q.comboVaccineImage){l=(await j(q.comboVaccineImage,y.id)).url}const n=`${q.birthYear}-${q.birthMonth}-${q.birthDay}`,{data:o,error:c}=await s.from("dogs").insert([{owner_id:y.id,name:q.name.trim(),breed:q.breed,birth_date:n,gender:q.gender,profile_image_url:t.publicUrl,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}]).select().single();if(c)throw new Error(`ワンちゃんの登録に失敗しました: ${c.message}`);const d=[];if(i&&d.push({dog_id:o.id,vaccine_type:"rabies",certificate_image_url:i,expiry_date:q.rabiesExpiryDate,status:"pending",created_at:(new Date).toISOString()}),l&&d.push({dog_id:o.id,vaccine_type:"combo",certificate_image_url:l,expiry_date:q.comboExpiryDate,status:"pending",created_at:(new Date).toISOString()}),d.length>0){const{error:e}=await s.from("vaccine_certifications").insert(d);e&&g.warn("ワクチン証明書の保存でエラーが発生しましたが、ワンちゃんの登録は完了しました",{error:e})}u.success("ワンちゃんの登録が完了しました！"),v("/dashboard")}catch(a){g.error("ワンちゃんの登録でエラーが発生しました",{error:a}),I(a instanceof Error?a.message:"ワンちゃんの登録中にエラーが発生しました。")}finally{w(!1)}}else I("混合ワクチンの有効期限を入力してください。");else I("狂犬病ワクチンの有効期限を入力してください。");else I("混合ワクチン証明書をアップロードしてください。");else I("狂犬病ワクチン証明書をアップロードしてください。");else I("プロフィール画像をアップロードしてください。");else I("性別を選択してください。");else I("生年月日を選択してください。");else I("犬種を選択してください。");else I("ワンちゃんの名前を入力してください。");else I("ログインが必要です。")},className:"space-y-6",children:[D&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("p",{className:"text-red-600 text-sm",children:D})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["プロフィール画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[$?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:$,alt:"プロフィール画像プレビュー",className:"w-24 h-24 rounded-full object-cover border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{V(null),E(null)},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(h,{className:"w-3 h-3"})})]}):e.jsx("div",{className:"w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center",children:e.jsx(p,{className:"w-8 h-8 text-gray-400"})}),e.jsxs(n,{type:"button",variant:"outline",onClick:()=>_(!0),children:[e.jsx(p,{className:"w-4 h-4 mr-2"}),C?"画像を変更":"画像を選択"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"1:1比率で切り取られ、最適化されます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(d,{label:"ワンちゃんの名前",type:"text",value:q.name,onChange:e=>k(a=>({...a,name:e.target.value})),placeholder:"例: ポチ",required:!0})}),e.jsx("div",{children:e.jsx(m,{label:"犬種",value:q.breed,onChange:e=>k(a=>({...a,breed:e.target.value})),options:[{value:"",label:"犬種を選択してください"},...b.map(e=>({value:e,label:e}))],required:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["生年月日 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(m,{value:q.birthYear,onChange:e=>{k(a=>({...a,birthYear:e.target.value,birthDay:""}))},options:[{value:"",label:"年"},...Y],required:!0}),e.jsx(m,{value:q.birthMonth,onChange:e=>{k(a=>({...a,birthMonth:e.target.value,birthDay:""}))},options:[{value:"",label:"月"},...O],required:!0}),e.jsx(m,{value:q.birthDay,onChange:e=>k(a=>({...a,birthDay:e.target.value})),options:[{value:"",label:"日"},...(()=>{if(!q.birthYear||!q.birthMonth)return[];const e=parseInt(q.birthYear),a=parseInt(q.birthMonth),r=new Date(e,a,0).getDate();return Array.from({length:r},(e,a)=>{const r=a+1;return{value:r.toString().padStart(2,"0"),label:`${r}日`}})})()],required:!0,disabled:!q.birthYear||!q.birthMonth})]})]}),e.jsx("div",{children:e.jsx(m,{label:"性別",value:q.gender,onChange:e=>k(a=>({...a,gender:e.target.value})),options:[{value:"",label:"性別を選択してください"},{value:"male",label:"オス"},{value:"female",label:"メス"}],required:!0})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"ワクチン証明書"}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>U(e,"rabies"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),q.rabiesVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",q.rabiesVaccineImage.name]})]}),e.jsx(d,{label:"有効期限",type:"date",value:q.rabiesExpiryDate,onChange:e=>k(a=>({...a,rabiesExpiryDate:e.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>U(e,"combo"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),q.comboVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",q.comboVaccineImage.name]})]}),e.jsx(d,{label:"有効期限",type:"date",value:q.comboExpiryDate,onChange:e=>k(a=>({...a,comboExpiryDate:e.target.value})),required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(t,{to:"/dashboard",children:e.jsx(n,{type:"button",variant:"outline",children:"キャンセル"})}),e.jsx(n,{type:"submit",disabled:N,className:"min-w-[120px]",children:N?"登録中...":"ワンちゃんを登録"})]})]})})]})}),S&&e.jsx(c,{onCropComplete:e=>{V(e);const a=URL.createObjectURL(e);E(a),_(!1),I("")},onCancel:()=>_(!1),aspectRatio:1,maxWidth:400,maxHeight:400})]})}export{y as DogRegistration};
