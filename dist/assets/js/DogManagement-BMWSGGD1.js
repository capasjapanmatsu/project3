const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/authDebug-WRDdU_fe.js","assets/js/index-UdMIM4Ug.js","assets/js/motion-BHsL7Azw.js","assets/js/react-vendor-CMvmJHsS.js","assets/js/heavy-features-Dlg1c9Yc.js","assets/js/router-DXQOdrLL.js","assets/js/supabase-D2tiogv8.js","assets/js/ui-basic-CojltCuw.js","assets/css/index-HyCq4Mq5.css","assets/js/directVaccineUpload-xKSOd3Q4.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-D2tiogv8.js";import{j as r}from"./motion-BHsL7Azw.js";import{r as t}from"./react-vendor-CMvmJHsS.js";import{L as i}from"./router-DXQOdrLL.js";import{u as a,s,l as o,B as n}from"./index-UdMIM4Ug.js";import{C as c}from"./Card-DqVnP9TA.js";import{D as d,a as l}from"./DogCard-BfzhQFnv.js";import{_ as m,j as u,P as g}from"./ui-basic-CojltCuw.js";import"./heavy-features-Dlg1c9Yc.js";import"./dogBreeds-6lxY8Uni.js";import"./Input-CI8a3Hs1.js";import"./Select-YTmN6qyT.js";import"./VaccineBadge-kuKItNOL.js";async function f(e){try{const r=await e();return{data:r.data,error:r.error}}catch(r){return{data:null,error:r}}}function p(){const{user:p}=a(),[h,b]=t.useState([]),[y,x]=t.useState(!0),[_,j]=t.useState(""),[w,v]=t.useState(!1),[D,S]=t.useState(null),[E,N]=t.useState(!1),[U,C]=t.useState(""),[$,I]=t.useState(""),[R,P]=t.useState(!1),[V,z]=t.useState({name:"",breed:"",gender:"",birthDate:"",microchipNumber:""}),[A,F]=t.useState(null),[T,L]=t.useState(null),[B,O]=t.useState(null),[k,M]=t.useState(null),[q,W]=t.useState(""),[J,K]=t.useState(""),G=t.useCallback(async()=>{try{x(!0),j("");const e=await f(()=>s.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",p?.id).order("created_at",{ascending:!1}));if(e.error)return o("error","Error fetching dogs",{error:e.error,userId:p?.id}),void j("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");b(e.data||[])}catch(e){o("error","Exception in fetchDogs",{error:e,userId:p?.id}),j("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")}finally{x(!1)}},[p?.id]);t.useEffect(()=>{p&&G()},[p,G]);const H=e=>{S(e),z({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date,microchipNumber:e.microchip_number||""}),L(e.image_url||null);const r=e.vaccine_certifications?.[0];r&&(W(r.rabies_expiry_date||""),K(r.combo_expiry_date||"")),v(!0)};return y?r.jsxs("div",{className:"flex justify-center items-center h-64",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),r.jsx("p",{className:"ml-3 text-gray-600",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­..."})]}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsxs(i,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[r.jsx(m,{className:"w-4 h-4 mr-2"}),"ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹"]}),r.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"}),r.jsx("p",{className:"text-gray-600",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™"})]}),r.jsx(i,{to:"/dog-registration",children:r.jsxs(n,{children:[r.jsx(u,{className:"w-4 h-4 mr-2"}),"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²"]})})]}),_&&r.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:_}),$&&r.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:$}),r.jsxs(c,{children:[r.jsx("div",{className:"flex justify-between items-center mb-4",children:r.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[r.jsx(g,{className:"w-6 h-6 text-blue-600 mr-2"}),"ç™»éŒ²æ¸ˆã¿ãƒ¯ãƒ³ã¡ã‚ƒã‚“ (",h.length,"åŒ¹)"]})}),0===h.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(g,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 mb-4",children:"ã¾ã ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),r.jsx(i,{to:"/dog-registration",children:r.jsxs(n,{children:[r.jsx(u,{className:"w-4 h-4 mr-2"}),"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"]})})]}):r.jsx("div",{className:"space-y-4",children:h.map(e=>r.jsx(d,{dog:e,onEdit:H},e.id))})]}),w&&D&&r.jsx(l,{dog:D,isUpdating:E||R,error:U,success:$,dogFormData:V,dogImagePreview:T,onClose:()=>v(!1),onSubmit:r=>{(async r=>{if(r.preventDefault(),D){N(!0),C(""),I("");try{const r={name:V.name,breed:V.breed,gender:V.gender,birth_date:V.birthDate,...V.microchipNumber&&{microchip_number:V.microchipNumber}};if(A){if(o("info","Uploading dog image",{name:A.name,type:A.type,size:A.size,lastModified:A.lastModified,isFileObject:A instanceof File}),!A.type||!A.type.startsWith("image/"))throw new Error(`ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${A.type}`);const e=`${D.id}/dog-photo.jpg`;o("info","File path",{fileName:e}),o("info","Using direct fetch API to bypass SDK");const t=`https://onmcivwxtzqajcovptgf.supabase.co/storage/v1/object/dog-images/${e}`,{data:{session:i}}=await s.auth.getSession();if(!i?.access_token)throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");o("info","Direct upload URL",{uploadUrl:t}),o("info","Using user access token for authentication"),o("info","Using PUT method for Supabase Storage API"),o("info","Upload options",{method:"PUT",contentType:A.type,authorization:"Bearer [token]",cacheControl:"3600"});const a=await fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":A.type,"Cache-Control":"3600"},body:A});if(o("info","Response status",{status:a.status}),o("info","Response headers",{headers:Object.fromEntries(a.headers.entries())}),!a.ok){const e=await a.text();throw o("error","Direct upload failed",{error:e}),new Error(`ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${a.status} ${e}`)}const n=await a.json();o("info","Direct upload success",{responseData:n});const{data:{publicUrl:c}}=s.storage.from("dog-images").getPublicUrl(e);r.image_url=c}const{error:t}=await s.from("dogs").update(r).eq("id",D.id);if(t)throw t;if(B&&k&&q&&J){const r=B.name.split(".").pop()||"jpg",t=k.name.split(".").pop()||"jpg",i=Date.now(),a=`temp/${D.id}/rabies_${i}.${r}`,n=`temp/${D.id}/combo_${i}.${t}`;o("info","Uploading vaccine certificates with direct method");const{debugAuthStatus:c}=await e(async()=>{const{debugAuthStatus:e}=await import("./authDebug-WRDdU_fe.js");return{debugAuthStatus:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));await c();const{directVaccineUpload:d}=await e(async()=>{const{directVaccineUpload:e}=await import("./directVaccineUpload-xKSOd3Q4.js");return{directVaccineUpload:e}},__vite__mapDeps([9,1,2,3,4,5,6,7,8]));o("info","Direct upload function imported successfully");const[l,m]=await Promise.all([d(a,B),d(n,k)]);if(o("info","Upload results",{rabiesUpload:l,comboUpload:m}),!l.success||!m.success){o("error","VACCINE UPLOAD ERROR DETAILS"),l.success||o("error","Rabies upload error",{error:l.error}),m.success||o("error","Combo upload error",{error:m.error});const e=l.error||m.error||"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";throw new Error(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e}`)}o("info","Vaccine certificates uploaded successfully"),o("info","Rabies upload result",{url:l.url}),o("info","Combo upload result",{url:m.url});const u=l.url,g=m.url;o("info","Public URLs obtained",{rabiesPublicUrl:u,comboPublicUrl:g}),o("info","Saving vaccine certificates to database");const p=await f(()=>s.from("vaccine_certifications").upsert([{dog_id:D.id,rabies_vaccine_image:u,combo_vaccine_image:g,rabies_expiry_date:q,combo_expiry_date:J,status:"pending"}],{onConflict:"dog_id"}));if(p.error){o("error","Database save error",{error:p.error});const e=p.error instanceof Error?p.error.message:JSON.stringify(p.error);throw e.includes("520")?new Error("ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"):new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e}`)}o("info","Vaccine certificates saved to database successfully")}I("ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await G(),setTimeout(()=>{v(!1),I(""),F(null),L(null),O(null),M(null),W(""),K("")},2e3)}catch(t){o("error","Error updating dog",{error:t,dogId:D?.id});let e="ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";t instanceof Error&&(e=t.message.includes("520")||t.message.includes("Cloudflare")?"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚":t.message.includes("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")?t.message:`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${t.message}`),C(e)}finally{N(!1)}}})(r)},onDelete:e=>{(async e=>{P(!0),C("");try{o("info","Deleting dog:",{name:e.name,id:e.id});const{error:t}=await s.from("vaccine_certifications").delete().eq("dog_id",e.id);if(t&&o("warn","Error deleting vaccine certifications",{error:t,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],i=`${e.id}/${t}`,{error:a}=await s.storage.from("dog-images").remove([i])}catch(r){}const i=e.vaccine_certifications?.[0];if(i){const e=[];if(i.rabies_vaccine_image&&e.push(i.rabies_vaccine_image),i.combo_vaccine_image&&e.push(i.combo_vaccine_image),e.length>0){const{error:r}=await s.storage.from("vaccine-certs").remove(e)}}const{error:a}=await s.from("dogs").delete().eq("id",e.id);if(a)throw o("error","Error deleting dog",{error:a,dogId:e.id}),a;o("info","Dog deleted successfully",{dogName:e.name}),await G(),v(!1),I(`${e.name}ã®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`),setTimeout(()=>{I("")},3e3)}catch(t){o("error","Error deleting dog",{error:t,dogId:e?.id});const r=t.message||"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ";C(r)}finally{P(!1)}})(e)},onFormChange:z,onImageSelect:e=>{const r=e.target.files?.[0];if(o("info","ğŸ” File selected:",r?{name:r.name,type:r.type,size:r.size,lastModified:r.lastModified,isFileObject:r instanceof File}:{message:"No file selected"}),r)try{if(!(r instanceof File))return void C("æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");if(r.size>10485760)return void C("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!r.type||!r.type.startsWith("image/"))return void C(`ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${r.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type))return void C(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${r.type}`);F(r),o("info","âœ… Dog image file set successfully:",{name:r.name,type:r.type,size:r.size});const e=new FileReader;e.onload=e=>{L(e.target?.result)},e.readAsDataURL(r)}catch(t){C("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}},onImageRemove:()=>{(async()=>{if(D&&D.image_url)try{if(N(!0),C(""),D.image_url&&D.image_url.includes("dog-images/")){const e=D.image_url.split("dog-images/")[1];if(e){const{error:r}=await s.storage.from("dog-images").remove([e])}}const e=await f(()=>s.from("dogs").update({image_url:null}).eq("id",D.id));if(e.error)return o("error","Error updating dog image_url",{error:e.error,dogId:D.id}),void C("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");F(null),L(null),S({...D,image_url:""}),await G(),o("info","âœ… Dog image removed successfully",{dogId:D.id}),I("ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"),setTimeout(()=>{I("")},3e3)}catch(e){o("error","Error removing dog image",{error:e,dogId:D?.id}),C("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{N(!1)}})()},rabiesVaccineFile:B,comboVaccineFile:k,rabiesExpiryDate:q,comboExpiryDate:J,onRabiesVaccineSelect:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void C("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!r.type.startsWith("image/"))return void C("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");O(r)}else O(null)},onComboVaccineSelect:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void C("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!r.type.startsWith("image/"))return void C("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");M(r)}else M(null)},onRabiesExpiryDateChange:W,onComboExpiryDateChange:K})]})}export{p as DogManagement};
