import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{u as a,B as t,s as r}from"./index-B7x5cu2N.js";import{C as l}from"./Card-DqVnP9TA.js";import{I as d}from"./Input-DXp8CaFq.js";import{a as n}from"./router-DXQOdrLL.js";import{p as i,u as m,r as c,aJ as o}from"./ui-basic-BVqAzqVO.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase--qivnNSU.js";const x=[{id:"pet_hotel",name:"ペットホテル",monthly_fee:5e3,is_free:!0},{id:"pet_salon",name:"ペットサロン",monthly_fee:3e3,is_free:!0},{id:"veterinary",name:"動物病院",monthly_fee:8e3,is_free:!0},{id:"pet_cafe",name:"ペットカフェ",monthly_fee:4e3,is_free:!0},{id:"pet_restaurant",name:"ペット同伴レストラン",monthly_fee:6e3,is_free:!0},{id:"pet_shop",name:"ペットショップ",monthly_fee:7e3,is_free:!0},{id:"pet_accommodation",name:"ペット同伴宿泊",monthly_fee:1e4,is_free:!0},{id:"dog_training",name:"しつけ教室",monthly_fee:4500,is_free:!0},{id:"pet_friendly_other",name:"その他ワンちゃん同伴可能施設",monthly_fee:3500,is_free:!0}];function h(){const{user:h,isAuthenticated:u,userProfile:p}=a(),f=n(),[b,j]=s.useState(!1),[g,y]=s.useState(""),[_,N]=s.useState(""),[v,w]=s.useState({name:"",address:"",isEditing:!1}),[E,k]=s.useState({name:"",category_id:"",address:"",phone:"",website:"",description:""});s.useEffect(()=>{u||f("/login")},[u,f]),s.useEffect(()=>{(async()=>{if(p){const e=p.name||p.display_name||p.full_name||"",s=p.address||p.location||p.postal_address||"";w({name:e,address:s,isEditing:!1})}else if(h)try{const{data:e,error:s}=await r.from("profiles").select("*").eq("id",h.id).single();if(e&&!s){const s=e.name||e.display_name||e.full_name||"",a=e.address||e.location||e.postal_address||"";w({name:s,address:a,isEditing:!s||!a})}else{const e=h.user_metadata||{},s=e.name||e.full_name||e.display_name||e.given_name||e.nickname||(e.given_name&&e.family_name?`${e.family_name} ${e.given_name}`:"")||"",a=e.address||e.location||e.postal_address||e.street_address||e.formatted_address||"";w({name:s,address:a,isEditing:!s||!a})}}catch(e){w({name:"",address:"",isEditing:!0})}else w({name:"",address:"",isEditing:!0})})()},[p,h]);const C=e=>{const{name:s,value:a}=e.target;k(e=>({...e,[s]:a}))},S=e=>{const{name:s,value:a}=e.target;w(e=>({...e,[s]:a}))};return u?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ペット関連施設登録"}),e.jsx("p",{className:"text-gray-600",children:"ペット関連施設の掲載申請を行います。管理者の承認後、地図に表示されます。"})]}),g&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(i,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:g})]})}),_&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(m,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"text-green-700",children:_})]})}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),u&&h)if(E.name&&E.category_id&&E.address)try{j(!0),y("");const e=formatAddressForGeocoding(E.address),s=await async function(e){try{const s="AIzaSyC9sxGamDZmdKIz3vP1CWLJORl-QkoWgHg",a=encodeURIComponent(e),t=await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${a}&key=${s}&region=jp&language=ja&components=country:JP`);if(!t.ok)throw new Error(`HTTP Error: ${t.status}`);const r=await t.json();if("OK"===r.status&&r.results&&r.results.length>0){const s=r.results[0],a=s.geometry?.location;if(a&&"number"==typeof a.lat&&"number"==typeof a.lng)return{latitude:a.lat,longitude:a.lng,formatted_address:s.formatted_address||e}}return"ZERO_RESULTS"===r.status||"OVER_QUERY_LIMIT"===r.status||"REQUEST_DENIED"===r.status||r.status,null}catch(g){return null}}(e);let a=null,t=null;s&&(a=s.latitude,t=s.longitude);const{data:l,error:d}=await r.from("pet_facilities").insert({name:E.name,category_id:E.category_id,address:E.address,latitude:a,longitude:t,phone:E.phone||null,website:E.website||null,description:E.description||null,owner_id:h.id,status:"pending"}).select().single();if(d)throw d;N(s?"施設の申請が正常に送信されました。地図上での正確な位置も設定されています。承認をお待ちください。":"施設の申請が正常に送信されました。（位置情報は後ほど設定されます）承認をお待ちください。"),k({name:"",category_id:"",address:"",phone:"",website:"",description:""})}catch(s){y("申請の送信に失敗しました。再度お試しください。")}finally{j(!1)}else y("施設名、カテゴリ、住所は必須項目です");else y("認証が必要です")},className:"space-y-6",children:[e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(c,{className:"w-6 h-6 mr-2"}),"基本情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設名 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(d,{label:"施設名",name:"name",value:E.name,onChange:C,placeholder:"施設名を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設カテゴリ ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"category_id",value:E.category_id,onChange:C,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"カテゴリを選択してください"}),x.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["住所 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(d,{label:"住所",name:"address",value:E.address,onChange:C,placeholder:"住所を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(d,{label:"電話番号",name:"phone",value:E.phone,onChange:C,placeholder:"電話番号を入力してください"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(d,{label:"ウェブサイト",name:"website",value:E.website,onChange:C,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設説明"}),e.jsx("textarea",{name:"description",value:E.description,onChange:C,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"施設の特徴やサービス内容を説明してください"})]})]})]})}),e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(o,{className:"w-6 h-6 mr-2"}),"施設画像について"]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(i,{className:"w-5 h-5 text-blue-600 mt-1 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-800 mb-1",children:"画像のアップロードについて"}),e.jsx("p",{className:"text-sm text-blue-700",children:"掲載画像は承認後にマイページ内で添付することができます。"})]})]})})]})}),e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(m,{className:"w-6 h-6 mr-2"}),"登録者情報の確認"]}),e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(i,{className:"w-5 h-5 text-blue-500 mr-2 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"登録者情報の確認"}),e.jsx("p",{className:"text-xs mb-2",children:"アカウント情報から自動取得されました。変更が必要な場合は編集できます。"}),e.jsx("p",{className:"text-xs font-medium text-blue-600",children:"⚠️ この情報は公開されません"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"氏名"}),v.isEditing?e.jsx(d,{label:"",name:"name",value:v.name,onChange:S,placeholder:"氏名を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:v.name||"未設定"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),v.isEditing?e.jsx(d,{name:"address",value:v.address,onChange:S,placeholder:"住所を入力してください"}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:v.address||"未設定"})})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:v.isEditing?e.jsxs("div",{className:"space-x-2",children:[e.jsx(t,{type:"button",onClick:()=>{(async()=>{if(h)try{j(!0);const{error:e}=await r.from("profiles").update({name:v.name,address:v.address}).eq("id",h.id);if(e)throw e;w(e=>({...e,isEditing:!1})),N("ユーザー情報を更新しました")}catch(e){y("ユーザー情報の更新に失敗しました")}finally{j(!1)}})()},disabled:b,children:b?"保存中...":"保存"}),e.jsx(t,{type:"button",variant:"secondary",onClick:()=>{w(e=>({...e,isEditing:!1}))},disabled:b,children:"キャンセル"})]}):e.jsx(t,{type:"button",variant:"secondary",onClick:()=>w(e=>({...e,isEditing:!0})),children:"編集"})})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(t,{type:"submit",disabled:b,className:"px-8 py-3 text-lg",children:b?"申請中...":"申請を送信"})})]})]}):null}export{h as default};
