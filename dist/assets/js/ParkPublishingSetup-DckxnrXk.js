import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{B as a}from"./Button-DiksLhRM.js";import{u as r,s as t,C as l}from"./index-DWDIgw5z.js";import{D as i}from"./DoorLockButton-DoFPWwva.js";import{I as c}from"./Input-D7pb8xRh.js";import{u as d,g as n}from"./webpConverter-Vy0VKhOw.js";import{d as m,a as o}from"./router-Cg6wfOY4.js";import{i as x,af as h,a4 as g,aC as j,K as u,g as p,ad as b,C as f,aO as N,X as y,j as w,e as v}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function k(){const{parkId:k}=m(),_=o(),{user:T}=r(),[C,L]=s.useState(null),[S,q]=s.useState([]),[E,P]=s.useState(!0),[$,I]=s.useState(""),[U,B]=s.useState(""),[D,O]=s.useState({smartLockTest:!1,pageEditing:!1,readyToPublish:!1}),[F,R]=s.useState(!1),[A,K]=s.useState({name:"",description:"",facility_details:"",price:0}),[W,z]=s.useState([]),[G,H]=s.useState([]),[J,M]=s.useState(!1),[Q,V]=s.useState(!1);s.useEffect(()=>{T&&k?X():_("/owner-dashboard")},[T,k,_]);const X=async()=>{try{P(!0);const{data:e,error:s}=await t.from("dog_parks").select("*").eq("id",k).eq("owner_id",T?.id).single();if(s)throw s;if(!e)return void I("ドッグランが見つかりません。");if("qr_testing_ready"!==e.status&&"editing"!==e.status&&"ready_to_publish"!==e.status)return void I("このドッグランは公開準備の段階ではありません。");L(e),K({name:e.name||"",description:e.description||"",facility_details:e.facility_details||"",price:e.price||0});const{data:a,error:r}=await t.from("smart_locks").select("*").eq("park_id",k);if(r)throw r;q(a||[]),Y(e)}catch(e){I("データの取得に失敗しました。")}finally{P(!1)}},Y=e=>{const s={smartLockTest:"qr_testing_ready"!==e.status,pageEditing:"ready_to_publish"===e.status,readyToPublish:"ready_to_publish"===e.status};O(s)},Z=async()=>{try{const{error:e}=await t.from("dog_parks").update({status:"editing"}).eq("id",k);if(e)throw e;O(e=>({...e,smartLockTest:!0})),B("スマートロックのテストが完了しました。"),await X()}catch(e){I("スマートロックテストの完了記録に失敗しました。")}},ee=async()=>{for(const e of W){const s=e.name.replace(/\.[^.]+$/,""),a=`${k}/${Date.now()}_${s}.jpg`,r=await d("dog-park-images",e,a,{quality:85,generateThumbnail:!1,keepOriginal:!1});if(!r.success)throw new Error(r.error||"WebP変換に失敗しました");const l=n(r.originalUrl,r.webpUrl);await t.from("dog_parks").update({image_url:l}).eq("id",k)}};return E?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):C?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{children:[e.jsxs(a,{variant:"secondary",onClick:()=>_("/owner-dashboard"),className:"mb-4",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]}),e.jsxs("h1",{className:"text-2xl font-bold",children:[C.name," - 公開準備"]}),e.jsx("p",{className:"text-gray-600",children:"二次審査が承認されました。公開前に以下の作業を完了してください。"})]})}),$&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border-l-4 border-red-400 text-red-700",children:e.jsxs("div",{className:"flex",children:[e.jsx(x,{className:"w-5 h-5 mr-2 mt-0.5"}),$]})}),U&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border-l-4 border-green-400 text-green-700",children:e.jsxs("div",{className:"flex",children:[e.jsx(g,{className:"w-5 h-5 mr-2 mt-0.5"}),U]})}),e.jsxs(l,{className:"mb-6 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"公開準備の進捗"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center p-4 rounded-lg "+(D.smartLockTest?"bg-green-50":"bg-yellow-50"),children:[e.jsx("div",{className:"w-6 h-6 rounded-full mr-4 flex items-center justify-center "+(D.smartLockTest?"bg-green-500":"bg-yellow-500"),children:D.smartLockTest?e.jsx(j,{className:"w-4 h-4 text-white"}):e.jsx("span",{className:"text-white text-sm",children:"1"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:"スマートロックの動作確認"}),e.jsx("p",{className:"text-sm text-gray-600",children:D.smartLockTest?"動作確認が完了しました":"スマートロックの動作を確認してください"})]})]}),e.jsxs("div",{className:"flex items-center p-4 rounded-lg "+(D.pageEditing?"bg-green-50":"bg-yellow-50"),children:[e.jsx("div",{className:"w-6 h-6 rounded-full mr-4 flex items-center justify-center "+(D.pageEditing?"bg-green-500":"bg-yellow-500"),children:D.pageEditing?e.jsx(j,{className:"w-4 h-4 text-white"}):e.jsx("span",{className:"text-white text-sm",children:"2"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:"掲載ページの編集"}),e.jsx("p",{className:"text-sm text-gray-600",children:D.pageEditing?"掲載ページの編集が完了しました":"掲載ページの内容を編集してください"})]})]}),e.jsxs("div",{className:"flex items-center p-4 rounded-lg "+(D.readyToPublish?"bg-green-50":"bg-gray-50"),children:[e.jsx("div",{className:"w-6 h-6 rounded-full mr-4 flex items-center justify-center "+(D.readyToPublish?"bg-green-500":"bg-gray-400"),children:D.readyToPublish?e.jsx(j,{className:"w-4 h-4 text-white"}):e.jsx("span",{className:"text-white text-sm",children:"3"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:"公開準備完了"}),e.jsx("p",{className:"text-sm text-gray-600",children:D.readyToPublish?"公開準備が完了しました":"上記の作業を完了してから公開してください"})]})]})]})]}),!D.smartLockTest&&e.jsxs(l,{className:"mb-6 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(u,{className:"w-5 h-5 mr-2"}),"1. スマートロックの動作確認"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"実際にスマートロックを開錠して動作を確認してください。"}),S.length>0?e.jsx("div",{className:"space-y-4",children:S.map(s=>e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:s.lock_name}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:s.location}),e.jsx(i,{lockId:s.lock_id,label:"PINコードを生成してテスト",onSuccess:()=>{B(`${s.lock_name}のテストが完了しました。`),setTimeout(()=>{Z()},1e3)},onError:e=>I(`スマートロックのテストに失敗しました: ${e}`)})]},s.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"このドッグランにはスマートロックが設定されていません。"}),e.jsx(a,{onClick:Z,className:"mt-4",children:"スマートロックテストを完了として進む"})]})]}),D.smartLockTest&&!D.pageEditing&&e.jsxs(l,{className:"mb-6 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(b,{className:"w-5 h-5 mr-2"}),"2. 掲載ページの編集"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ドッグランの掲載ページを編集してください。"}),F?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"施設名",value:A.name,onChange:e=>K(s=>({...s,name:e.target.value})),required:!0}),e.jsx(c,{label:"料金（円）",type:"number",value:A.price,onChange:e=>K(s=>({...s,price:Number(e.target.value)})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設の説明"}),e.jsx("textarea",{value:A.description,onChange:e=>K(s=>({...s,description:e.target.value})),rows:4,className:"w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"お客様に向けた施設の魅力を説明してください..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設詳細・利用規約"}),e.jsx("textarea",{value:A.facility_details,onChange:e=>K(s=>({...s,facility_details:e.target.value})),rows:6,className:"w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"施設の詳細情報や利用規約を記入してください..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設画像を追加"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{const s=Array.from(e.target.files||[]);z(s);const a=s.map(e=>URL.createObjectURL(e));H(a)},className:"hidden",id:"park-images"}),e.jsxs("label",{htmlFor:"park-images",className:"cursor-pointer",children:[e.jsx(f,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"})]})]}),G.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 md:grid-cols-3 gap-4",children:G.map((s,a)=>e.jsx("img",{src:s,alt:`プレビュー ${a+1}`,className:"w-full h-24 object-cover rounded-lg border"},a))})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs(a,{onClick:async()=>{try{M(!0);const{error:e}=await t.from("dog_parks").update({name:A.name,description:A.description,facility_details:A.facility_details,price:A.price,status:"ready_to_publish"}).eq("id",k);if(e)throw e;W.length>0&&await ee(),O(e=>({...e,pageEditing:!0,readyToPublish:!0})),B("掲載ページの編集が完了しました。"),R(!1),await X()}catch(e){I("掲載ページの保存に失敗しました。")}finally{M(!1)}},disabled:J,className:"flex-1",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),J?"保存中...":"編集を保存"]}),e.jsxs(a,{variant:"secondary",onClick:()=>{R(!1),z([]),H([])},children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),"キャンセル"]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"現在の掲載内容"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"施設名:"})," ",C.name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"説明:"})," ",C.description||"未設定"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"施設詳細:"})," ",C.facility_details||"未設定"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"料金:"})," ¥",C.price]})]})]}),e.jsxs(a,{onClick:()=>R(!0),children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"編集を開始"]})]})]}),D.readyToPublish&&e.jsxs(l,{className:"mb-6 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(w,{className:"w-5 h-5 mr-2"}),"3. ドッグランを公開"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"すべての準備が完了しました。ドッグランを一般公開してください。"}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg mb-4",children:[e.jsx("h3",{className:"font-medium text-blue-900 mb-2",children:"公開後の流れ"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• ドッグランが一般のユーザーに公開されます"}),e.jsx("li",{children:"• 予約の受付が開始されます"}),e.jsx("li",{children:"• 収益の発生が開始されます"}),e.jsx("li",{children:"• 管理画面で予約状況や収益を確認できます"})]})]}),e.jsxs(a,{onClick:async()=>{if(D.smartLockTest&&D.pageEditing)try{V(!0);const{error:e}=await t.from("dog_parks").update({status:"approved"}).eq("id",k);if(e)throw e;await t.from("admin_notifications").insert([{type:"park_published",title:"ドッグラン公開",message:`${C?.name}が公開されました。`,data:{park_id:k}}]),B("ドッグランが公開されました！"),setTimeout(()=>{_(`/parks/${k}/manage`)},2e3)}catch(e){I("ドッグランの公開に失敗しました。")}finally{V(!1)}else I("すべてのタスクを完了してから公開してください。")},disabled:Q,className:"w-full bg-green-600 hover:bg-green-700",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),Q?"公開中...":"ドッグランを公開する"]})]})]}):e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsxs(l,{className:"p-8 text-center",children:[e.jsx(x,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"ドッグランが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"指定されたドッグランが見つからないか、アクセス権限がありません。"}),e.jsx(a,{onClick:()=>_("/owner-dashboard"),children:"ダッシュボードに戻る"})]})})}export{k as ParkPublishingSetup};
