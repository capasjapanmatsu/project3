import{l as e}from"./external-api-CcgPsVUa.js";import{r as t}from"./react-vendor-cniURDpR.js";import{u as s,s as o}from"./index-CVZFmpsT.js";function i(){const{user:i,lineUser:r,effectiveUserId:a}=s(),[n,c]=t.useState(!1),[l,u]=t.useState(null),m=t.useCallback(async()=>{const{data:{user:e}}=await o.auth.getUser();if(!e&&(r||a))try{const e=await fetch("/line/exchange-supabase-session",{method:"POST",credentials:"include"});if(!e.ok)return;const{access_token:t,refresh_token:s}=await e.json();await o.auth.setSession({access_token:t,refresh_token:s})}catch{}},[r,a]);return{createCheckoutSession:t.useCallback(async({priceId:t,mode:s,successUrl:n,cancelUrl:l,customAmount:d,customName:w,customParams:p,cartItems:h,trialPeriodDays:f})=>{c(!0),u(null);try{await m();const c=i?.id||r?.app_user_id||r?.id||a;if(!c)throw new Error("認証が必要です");let u,_;if(i){const{data:{session:e}}=await o.auth.getSession();u=e?.access_token,_=e?.user.email}else if(r){const{data:e}=await o.from("profiles").select("email").eq("id",c).single();_=e?.email||`line_${r.line_user_id}@line.local`,u=`line_user_${c}`}if(!u&&!r)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:c,user_email:_||"",timestamp:Date.now(),return_url:window.location.href,is_line_user:!!r}));const I=n&&l?null:"localhost"===window.location.hostname?"https://dogparkjp.com":window.location.origin,k={mode:s,success_url:n||`${I}/payment-confirmation?success=true`,cancel_url:l||`${I}/payment-confirmation?canceled=true`};t&&(k.price_id=t),f&&"subscription"===s&&(k.trial_period_days=f),d&&w&&(k.custom_amount=d,k.custom_name=w),h&&h.length>0&&(k.cart_items=h),p&&Object.entries(p).forEach(([e,t])=>{k[e]=t}),r&&(k.user_id=c);const y=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"}`},body:JSON.stringify(k)});if(!y.ok){const e=await y.json();throw new Error(e.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:S,url:g}=await y.json();if(g)return void(window.location.href=g);if(!S)throw new Error("チェックアウトURLが取得できませんでした");{const t=void 0;if(!t)throw new Error("Stripe公開キーが設定されていません");const s=await e(t);if(!s)throw new Error("Stripeの読み込みに失敗しました");const{error:o}=await s.redirectToCheckout({sessionId:S});if(o)throw o}}catch(_){throw u(_.message||"チェックアウトに失敗しました"),_}finally{c(!1)}},[i,r,a]),loading:n,error:l}}export{i as u};
