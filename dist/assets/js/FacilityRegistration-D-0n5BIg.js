import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{u as a,B as t,s as r}from"./index-DYKGJ9IK.js";import{C as l}from"./Card-DqVnP9TA.js";import{I as i}from"./ImageCropper-BQ6sEl3D.js";import{I as n}from"./Input-R783aYSb.js";import{a as d}from"./router-DXQOdrLL.js";import{A as m,t as c,n as o,aI as x,X as h}from"./ui-basic-CJygcczc.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";const g=[{id:"pet_hotel",name:"ペットホテル",monthly_fee:5e3,is_free:!0},{id:"pet_salon",name:"ペットサロン",monthly_fee:3e3,is_free:!0},{id:"veterinary",name:"動物病院",monthly_fee:8e3,is_free:!0},{id:"pet_cafe",name:"ペットカフェ",monthly_fee:4e3,is_free:!0},{id:"pet_restaurant",name:"ペット同伴レストラン",monthly_fee:6e3,is_free:!0},{id:"pet_shop",name:"ペットショップ",monthly_fee:7e3,is_free:!0},{id:"pet_accommodation",name:"ペット同伴宿泊",monthly_fee:1e4,is_free:!0},{id:"dog_training",name:"しつけ教室",monthly_fee:4500,is_free:!0},{id:"pet_friendly_other",name:"その他ワンちゃん同伴可能施設",monthly_fee:3500,is_free:!0}];function u(){const{user:u,isAuthenticated:p,userProfile:b}=a(),j=d(),[f,y]=s.useState(!1),[N,v]=s.useState(""),[w,_]=s.useState(""),[C,F]=s.useState([!1,!1,!1,!1,!1]),[I,E]=s.useState({isOpen:!1,imageIndex:-1,originalFile:null}),[k,$]=s.useState({name:"",address:"",isEditing:!1}),[S,O]=s.useState({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:["","","","",""],imageFiles:[null,null,null,null,null]});s.useEffect(()=>{p||j("/login")},[p,j]),s.useEffect(()=>{b&&$({name:b.name||b.display_name||"",address:b.address||"",isEditing:!1})},[b]);const U=e=>{const{name:s,value:a}=e.target;O(e=>({...e,[s]:a}))},R=(e,s)=>{const a=e.target.files?.[0];if(a){if(a.size>5242880)return v("画像ファイルのサイズは5MB以下にしてください"),void(e.target.value="");if(!a.type.startsWith("image/"))return v("画像ファイルを選択してください"),void(e.target.value="");E({isOpen:!0,imageIndex:s,originalFile:a}),e.target.value=""}},L=e=>{O(s=>{const a=[...s.images],t=[...s.imageFiles];return a[e]&&a[e].startsWith("blob:")&&URL.revokeObjectURL(a[e]),a[e]="",t[e]=null,{...s,images:a,imageFiles:t}});const s=0===e?"mainImage":`additionalImage${e}`,a=document.getElementById(s);a&&(a.value="")},P=e=>{const{name:s,value:a}=e.target;$(e=>({...e,[s]:a}))};return p?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ペット関連施設登録"}),e.jsx("p",{className:"text-gray-600",children:"ペット関連施設の掲載申請を行います。管理者の承認後、地図に表示されます。"})]}),N&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(m,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:N})]})}),w&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"text-green-700",children:w})]})}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),S.name&&S.category_id&&S.address)if(S.imageFiles&&0!==S.imageFiles.length&&S.imageFiles[0])try{y(!0),v("");const e={owner_id:u?.id,name:S.name,category_id:S.category_id,address:S.address,phone:S.phone||null,website:S.website||null,description:S.description||null,status:"pending"},{data:s,error:a}=await r.from("pet_facilities").insert([e]).select().single();if(a||!s)throw a||new Error("施設の登録に失敗しました");const t=s.id,l=[];S.imageFiles&&S.imageFiles.forEach((e,s)=>{e&&l.push((async(e,s,a,t)=>{try{const a=Date.now(),l=e.name.split(".").pop()||"jpg",i=`${s}/${void 0!==t?`image_${t}_${a}.${l}`:`main_${a}.${l}`}`,{data:n,error:d}=await r.storage.from("pet-facility-images").upload(i,e,{cacheControl:"3600",upsert:!1});if(d)throw d;const{data:{publicUrl:m}}=r.storage.from("pet-facility-images").getPublicUrl(i);return m}catch(l){throw new Error("画像のアップロードに失敗しました")}})(e,t,0,s).then(e=>({url:e,type:0===s?"main":"additional",order:s})))});const i=await Promise.all(l);if(i.length>0){const e=i.map(e=>({facility_id:t,image_url:e.url,image_type:e.type,display_order:e.order,alt_text:`${S.name} - ${"main"===e.type?"メイン画像":`画像${e.order+1}`}`})),{error:s}=await r.from("facility_images").insert(e)}_("施設の申請が完了しました。審査完了までお待ちください。"),O({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:["","","","",""],imageFiles:[null,null,null,null,null]}),setTimeout(()=>{j("/dashboard")},3e3)}catch(s){let e="申請の送信に失敗しました";s&&"object"==typeof s&&"message"in s&&(e=s.message),v(e)}finally{y(!1)}else v("メイン画像は必須です");else v("必須項目を入力してください")},className:"space-y-6",children:[e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(o,{className:"w-6 h-6 mr-2"}),"基本情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設名 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(n,{label:"施設名",name:"name",value:S.name,onChange:U,placeholder:"施設名を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設カテゴリ ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"category_id",value:S.category_id,onChange:U,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"カテゴリを選択してください"}),g.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["住所 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(n,{label:"住所",name:"address",value:S.address,onChange:U,placeholder:"住所を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(n,{label:"電話番号",name:"phone",value:S.phone,onChange:U,placeholder:"電話番号を入力してください"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(n,{label:"ウェブサイト",name:"website",value:S.website,onChange:U,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設説明"}),e.jsx("textarea",{name:"description",value:S.description,onChange:U,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"施設の特徴やサービス内容を説明してください"})]})]})]})}),e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(x,{className:"w-6 h-6 mr-2"}),"施設画像"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["メイン画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"施設の代表的な画像をアップロードしてください（最大5MB、JPG/PNG形式）"}),e.jsx("div",{className:"flex items-center space-x-4",children:S.images[0]?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:S.images[0],alt:"メイン画像プレビュー",className:"w-48 h-36 object-cover rounded-lg border border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>L(0),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:e.jsx(h,{className:"w-4 h-4"})})]}):e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:C[0]?e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"処理中..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("div",{className:"mt-4",children:e.jsxs("label",{htmlFor:"mainImage",className:"cursor-pointer",children:[e.jsx("span",{className:"mt-2 block text-sm font-medium text-gray-900 hover:text-blue-600",children:"メイン画像をアップロード"}),e.jsx("input",{id:"mainImage",name:"mainImage",type:"file",accept:"image/*",onChange:e=>R(e,0),className:"sr-only",disabled:C[0]})]})})]})})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"追加画像（任意）"}),e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"最大4枚まで追加できます（合計5枚）"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx("div",{children:S.images[s]?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:S.images[s],alt:`追加画像${s}プレビュー`,className:"w-full h-32 object-cover rounded-lg border border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>L(s),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:e.jsx(h,{className:"w-4 h-4"})})]}):e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center",children:C[s]?e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"}),e.jsx("p",{className:"mt-2 text-xs text-gray-600",children:"処理中..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("div",{className:"mt-2",children:e.jsxs("label",{htmlFor:`additionalImage${s}`,className:"cursor-pointer",children:[e.jsxs("span",{className:"text-sm text-gray-600 hover:text-blue-600",children:["画像",s]}),e.jsx("input",{id:`additionalImage${s}`,name:`additionalImage${s}`,type:"file",accept:"image/*",onChange:e=>R(e,s),className:"sr-only",disabled:C[s]})]})})]})})},s))})]})]})]})}),e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(c,{className:"w-6 h-6 mr-2"}),"登録者情報の確認"]}),e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(m,{className:"w-5 h-5 text-blue-500 mr-2 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"登録者情報の確認"}),e.jsx("p",{className:"text-xs",children:"アカウント情報から自動取得されました。変更が必要な場合は編集できます。"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"氏名"}),k.isEditing?e.jsx(n,{label:"",name:"name",value:k.name,onChange:P,placeholder:"氏名を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:k.name||"未設定"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),k.isEditing?e.jsx(n,{name:"address",value:k.address,onChange:P,placeholder:"住所を入力してください"}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:k.address||"未設定"})})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:k.isEditing?e.jsxs("div",{className:"space-x-2",children:[e.jsx(t,{type:"button",onClick:()=>{(async()=>{if(u)try{y(!0);const{error:e}=await r.from("profiles").update({name:k.name,address:k.address,updated_at:(new Date).toISOString()}).eq("id",u.id);if(e)throw new Error("ユーザー情報の更新に失敗しました");$(e=>({...e,isEditing:!1})),_("ユーザー情報を更新しました"),setTimeout(()=>_(""),3e3)}catch(e){v(e instanceof Error?e.message:"ユーザー情報の更新に失敗しました")}finally{y(!1)}})()},disabled:f,children:f?"保存中...":"保存"}),e.jsx(t,{type:"button",variant:"secondary",onClick:()=>{$({name:b?.name||b?.display_name||"",address:b?.address||"",isEditing:!1})},disabled:f,children:"キャンセル"})]}):e.jsx(t,{type:"button",variant:"secondary",onClick:()=>$(e=>({...e,isEditing:!0})),children:"編集"})})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(t,{type:"submit",disabled:f,className:"px-8 py-3 text-lg",children:f?"申請中...":"申請を送信"})})]}),I.isOpen&&I.originalFile&&e.jsx(i,{imageFile:I.originalFile,aspectRatio:1,onCropComplete:async e=>{try{const{imageIndex:s}=I;F(e=>{const a=[...e];return a[s]=!0,a});const a=await(async e=>new Promise((s,a)=>{const t=document.createElement("canvas"),r=t.getContext("2d"),l=document.createElement("img");l.onload=()=>{let i=l.naturalWidth,n=l.naturalHeight;i>n?i>800&&(n=800*n/i,i=800):n>800&&(i=800*i/n,n=800),t.width=i,t.height=n,r?.drawImage(l,0,0,i,n),t.toBlob(t=>{if(t){const a=new File([t],e.name,{type:"image/jpeg",lastModified:Date.now()});s(a)}else a(new Error("画像の圧縮に失敗しました"))},"image/jpeg",.8)},l.onerror=a,l.src=URL.createObjectURL(e)}))(e),t=URL.createObjectURL(a);O(e=>{const r=[...e.images],l=[...e.imageFiles];return r[s]=t,l[s]=a,{...e,images:r,imageFiles:l}}),E({isOpen:!1,imageIndex:-1,originalFile:null})}catch(s){v("画像の処理に失敗しました")}finally{F(e=>{const s=[...e];return s[I.imageIndex]=!1,s})}},onCancel:()=>E({isOpen:!1,imageIndex:-1,originalFile:null})})]}):null}export{u as default};
