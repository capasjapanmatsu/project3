import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{u as s,a,L as r}from"./router-Cg6wfOY4.js";import{B as l}from"./Button-BVIkPLCk.js";import{u as c,s as i,C as n}from"./index-Cxr3hxlQ.js";import{M as m,az as d,p as o}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function x(){const{user:x}=c(),h=s(),u=a(),p=new URLSearchParams(h.search).get("pref")||localStorage.getItem("communityPreferredPrefecture")||"東京都",[f,j]=t.useState(p),[g,y]=t.useState(!0),[N,b]=t.useState([]),[v,w]=t.useState(""),[_,S]=t.useState(""),[k,C]=t.useState(!0),[P,I]=t.useState(!1),M=t.useMemo(()=>["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"],[]);t.useEffect(()=>{localStorage.setItem("communityPreferredPrefecture",f),D(f)},[f]);const D=async e=>{y(!0);const{data:t,error:s}=await i.from("pref_threads").select("id, prefecture, title, content, allow_dm, author_id, dog_name, created_at").eq("prefecture",e).order("created_at",{ascending:!1}).limit(50);s||b(t||[]),y(!1)};return e.jsxs("div",{className:"max-w-5xl mx-auto px-4 py-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx(r,{to:"/community",className:"text-gray-600 hover:text-gray-800",children:"← コミュニティへ戻る"})}),e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(m,{className:"w-6 h-6 text-blue-600 mr-2"}),f,"の掲示板"]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-stretch sm:items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"都道府県"}),e.jsx("select",{value:f,onChange:e=>j(e.target.value),className:"w-full border rounded px-2 py-2",children:M.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"flex-[2]",children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"タイトル（例: 迷子犬を探しています）"}),e.jsx("input",{value:v,onChange:e=>w(e.target.value),className:"w-full border rounded px-3 py-2",placeholder:"タイトル"})]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"内容（任意）"}),e.jsx("textarea",{value:_,onChange:e=>S(e.target.value),className:"w-full border rounded px-3 py-2",rows:3,placeholder:"詳細や連絡方法など"})]}),e.jsx("div",{className:"mt-3 flex items-center gap-3 text-sm",children:e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:e=>C(e.target.checked)}),"ダイレクトメッセージを受け付ける"]})}),e.jsx("div",{className:"mt-3",children:e.jsxs(l,{onClick:async()=>{if(x){if(v.trim()){I(!0);try{let e=null;const{data:t}=await i.from("dogs").select("name, gender").eq("owner_id",x.id).order("created_at",{ascending:!0}).limit(1);t&&t[0]?.name&&(e=t[0].name+("オス"===t[0].gender?"くん":"ちゃん"));const{error:s}=await i.from("pref_threads").insert({prefecture:f,title:v.trim(),content:_.trim()||null,allow_dm:k,author_id:x.id,dog_name:e});if(s)throw s;w(""),S(""),C(!0),await D(f)}finally{I(!1)}}}else u("/login?redirect="+encodeURIComponent(`/community/boards?pref=${f}`))},disabled:P,children:[P?e.jsx(d,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(o,{className:"w-4 h-4 mr-2"})," 投稿する"]})})]}),e.jsx("div",{className:"space-y-4",children:g?e.jsx(n,{className:"p-4 text-center text-gray-500",children:"読み込み中..."}):0===N.length?e.jsx(n,{className:"p-4 text-center text-gray-500",children:"まだ投稿がありません"}):N.map(t=>e.jsxs(n,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-500",children:new Date(t.created_at).toLocaleString("ja-JP")}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("div",{children:t.allow_dm?"DM受付中":"DM不可"}),"capasjapan@gmail.com"===x?.email&&e.jsx("button",{className:"text-red-600 hover:text-red-700 underline",onClick:async()=>{if(!confirm("このスレッドを削除しますか？返信も削除されます。"))return;const{data:e,error:s}=await i.from("pref_threads").delete().eq("id",t.id).select("id");!s&&e&&0!==e.length?(b(e=>e.filter(e=>e.id!==t.id)),await D(f)):alert(`削除に失敗しました: ${s?.message||"権限がないか、対象が存在しません"}`)},children:"削除"}),t.allow_dm&&x&&x.id!==t.author_id&&e.jsx("button",{className:"text-blue-600 hover:text-blue-800 underline",onClick:()=>{try{sessionStorage.setItem("communityActiveTab","messages"),sessionStorage.setItem("communityOpenPartnerId",t.author_id)}catch{}u("/community")},children:"DMを送る"})]})]}),e.jsx("h3",{className:"font-semibold text-lg mt-1",children:t.title}),t.dog_name&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[t.dog_name," の飼い主さん"]}),t.content&&e.jsx("p",{className:"text-gray-700 mt-2 whitespace-pre-line",children:t.content}),e.jsx("div",{className:"mt-3",children:e.jsx(r,{to:`/community/boards/${t.id}`,children:"スレッドを開く"})})]},t.id))})]})}export{x as default};
