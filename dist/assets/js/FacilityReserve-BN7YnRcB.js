const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-DxZPnn_v.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as t}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{B as a}from"./Button-CJFAG6V0.js";import{u as i,s as n,C as r}from"./index-DN5wQuSm.js";import{d as o,a as l}from"./router-Cg6wfOY4.js";import"./ui-basic-CaMd9YQ-.js";import"./heavy-features-BIdEME4r.js";function c(){const{id:c}=o(),{user:d}=i(),m=l(),[u,f]=s.useState(!0),[p,_]=s.useState(!1),[g,y]=s.useState(60),[x,S]=s.useState(30),[h,w]=s.useState([]),[$,j]=s.useState(()=>(new Date).toISOString().split("T")[0]),[v,N]=s.useState(""),[b,D]=s.useState(""),[A,k]=s.useState(1),[T,O]=s.useState(""),[C,q]=s.useState("09:00"),[B,I]=s.useState("18:00"),[L,J]=s.useState(!1),[M,E]=s.useState([!1,!1,!1,!1,!1,!1,!1]),[U,H]=s.useState(new Set),[P,R]=s.useState(new Set);s.useEffect(()=>{(async()=>{try{f(!0);const{data:e}=await n.from("facility_reservation_settings").select("*").eq("facility_id",c).maybeSingle();_(Boolean(e?.enabled)),y(e?.slot_unit_minutes||60),S(e?.allowed_days_ahead||30);const{data:t}=await n.from("facility_seats").select("seat_code").eq("facility_id",c);w((t||[]).map(e=>e.seat_code));const{data:s}=await n.from("pet_facilities").select("opening_time, closing_time, weekly_closed_days, specific_closed_dates, specific_open_dates").eq("id",c).maybeSingle();s?.opening_time&&q(String(s.opening_time).slice(0,5)),s?.closing_time&&I(String(s.closing_time).slice(0,5));try{if(s?.weekly_closed_days){const e=JSON.parse(String(s.weekly_closed_days));Array.isArray(e)&&7===e.length&&E(e.map(Boolean))}}catch{}try{if(s?.specific_closed_dates){const e=JSON.parse(String(s.specific_closed_dates));Array.isArray(e)&&H(new Set(e))}}catch{}try{if(s?.specific_open_dates){const e=JSON.parse(String(s.specific_open_dates));Array.isArray(e)&&R(new Set(e))}}catch{}}finally{f(!1)}})()},[c]);const V=s.useMemo(()=>function(e,t,s){const a=[],i=new Date(`1970-01-01T${e}:00`),n=new Date(`1970-01-01T${t}:00`);if(n<=i)return a;let r=i;for(;r<n;){const e=r.getHours().toString().padStart(2,"0"),t=r.getMinutes().toString().padStart(2,"0"),i=new Date(r.getTime()+60*s*1e3);if(i>n)break;const o=i.getHours().toString().padStart(2,"0"),l=i.getMinutes().toString().padStart(2,"0");a.push({start:`${e}:${t}`,end:`${o}:${l}`}),r=i}return a}(C,B,g),[C,B,g]),z=s.useMemo(()=>{const e=$;if(!e)return!1;if(P.has(e))return!1;if(U.has(e))return!0;const t=new Date(`${e}T00:00:00`).getDay();return Boolean(M[t])},[$,M,U,P]),F=s.useMemo(()=>{if(z)return[];const e=(new Date).toISOString().split("T")[0];if($!==e)return V;const t=new Date(Date.now()+36e5);return V.filter(({start:e})=>new Date(`${$}T${e}:00`)>=t)},[V,$,z]);if(u)return t.jsx("div",{className:"p-6",children:"読み込み中..."});if(!p)return t.jsx("div",{className:"p-6",children:"この施設では現在予約を受け付けていません。"});const G=new Date,K=new Date;K.setDate(G.getDate()+x);const Q=e=>e.toISOString().split("T")[0];return t.jsx("div",{className:"max-w-2xl mx-auto p-6",children:t.jsxs(r,{className:"p-6",children:[t.jsx("h1",{className:"text-xl font-semibold mb-4",children:"予約"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"予約者名"}),t.jsx("input",{type:"text",className:"border rounded px-2 py-1 flex-1",placeholder:"予約者名",value:T,onChange:e=>O(e.target.value)})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"日付"}),t.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:$,onChange:e=>j(e.target.value),min:Q(G),max:Q(K)}),z&&t.jsx("span",{className:"ml-2 text-xs text-red-600",children:"定休日のため予約不可"})]}),h.length>0&&t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"座席"}),t.jsxs("select",{className:"border rounded px-2 py-1",value:v,onChange:e=>N(e.target.value),children:[t.jsx("option",{value:"",children:"選択"}),h.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"時間"}),t.jsxs("select",{className:"border rounded px-2 py-1",value:b,onChange:e=>D(e.target.value),disabled:z,children:[t.jsx("option",{value:"",children:"選択"}),F.map(e=>t.jsxs("option",{value:`${e.start}-${e.end}`,children:[e.start," - ",e.end]},`${e.start}-${e.end}`))]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"人数"}),t.jsx("input",{type:"number",min:1,max:20,className:"border rounded px-2 py-1 w-24",value:A,onChange:e=>k(Number(e.target.value))})]}),t.jsx(a,{onClick:async()=>{if(d)if(z)alert("本日は定休日のため予約できません");else if(b)if(T.trim())if(h.length>0&&!v)alert("座席を選択してください");else try{J(!0);const[t,s]=b.split("-"),{data:a}=await n.from("facility_reservation_settings").select("auto_confirm").eq("facility_id",c).maybeSingle(),i=Boolean(a?.auto_confirm??!0)?"confirmed":"pending";let r=null;const o=await n.from("facility_reservations").insert({facility_id:c,user_id:d.id,customer_name:T.trim(),seat_code:v||"未指定",reserved_date:$,start_time:t,end_time:s,guest_count:A,status:i});if(o.error&&String(o.error.message||"").includes("customer_name")){r=(await n.from("facility_reservations").insert({facility_id:c,user_id:d.id,seat_code:v||"未指定",reserved_date:$,start_time:t,end_time:s,guest_count:A,status:i})).error}else{if(o.error&&/uq_facility_resv_slot/i.test(String(o.error.message)))throw alert("選択した時間帯は満席の可能性があります。別の時間または座席を選択してください。"),o.error;r=o.error}if(r)throw r;try{const{data:e}=await n.from("facility_reservation_settings").select("auto_message_enabled, auto_message_text").eq("facility_id",c).maybeSingle(),t=(Boolean(e?.auto_message_enabled),e?.auto_message_text||"ご予約を受け付けました。お気をつけてお越しください。");await n.from("community_messages").insert({user_id:d.id,facility_id:c,content:t,context:"reservation"}).select().maybeSingle()}catch{}try{const{notifyAppAndLine:a}=await e(async()=>{const{notifyAppAndLine:e}=await import("./notify-przsH82t.js");return{notifyAppAndLine:e}},__vite__mapDeps([0])),i=`${window.location.origin}/my-reservations`,r=v?`席:${v}`:"座席:指定なし";await a({userId:d.id,title:"ご予約を受け付けました。",message:`${$} ${t}-${s} / ${A}名`,linkUrl:i,kind:"alert",sendApp:!1,sendLine:!0});const{data:o}=await n.from("pet_facilities").select("id, owner_id, name").eq("id",c).maybeSingle();if(o?.owner_id){const e=`${window.location.origin}/facilities/${c}/reservations`;await a({userId:o.owner_id,title:"新規予約が入りました",message:`${T} 様 / ${o.name} / ${$} ${t}-${s}`,linkUrl:e,kind:"alert",sendApp:!1,sendLine:!0});(await n.from("notifications").insert({user_id:o.owner_id,title:"新規予約が入りました",message:`${T} 様 / ${o.name} / ${$} ${t}-${s} / ${A}名 / ${r}`,link_url:e,read:!1,type:"reservation_reminder",data:{}})).error&&await fetch("/.netlify/functions/app-notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:o.owner_id,title:"新規予約が入りました",message:`${T} 様 / ${o.name} / ${$} ${t}-${s}`,linkUrl:e,kind:"alert"})})}}catch{}alert("予約が完了しました"),m(`/facilities/${c}`)}catch(t){const e="string"==typeof t?.message?t.message:JSON.stringify(t);alert(`予約に失敗しました\n${e}`)}finally{J(!1)}else alert("予約者名を入力してください");else alert("時間を選択してください");else m("/liff/login")},className:"w-full",disabled:L||z,children:L?"処理中...":"予約を確定"})]})]})})}export{c as default};
