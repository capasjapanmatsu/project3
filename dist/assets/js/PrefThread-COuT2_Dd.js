import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{d as a,a as s,L as r}from"./router-Cg6wfOY4.js";import{B as i}from"./Button-BVIkPLCk.js";import{u as n,s as c,C as l}from"./index-Cxr3hxlQ.js";import{aS as o,az as m,p as d}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function x(){const{id:x}=a(),{user:p}=n(),u=s(),[h,f]=t.useState(null),[j,g]=t.useState([]),[w,N]=t.useState(""),[b,y]=t.useState(null),[v,_]=t.useState(!1),[C,S]=t.useState(null);t.useEffect(()=>{x&&U(x)},[x]);const U=async e=>{const{data:t}=await c.from("pref_threads").select("*").eq("id",e).maybeSingle();f(t);const{data:a}=await c.from("pref_replies").select("*").eq("thread_id",e).order("created_at",{ascending:!0});g(a||[])};return t.useEffect(()=>{if(b){const e=URL.createObjectURL(b);return S(e),()=>URL.revokeObjectURL(e)}S(null)},[b]),h?e.jsxs("div",{className:"max-w-3xl mx-auto px-4 py-6 space-y-6",children:[e.jsxs(r,{to:`/community/boards?pref=${encodeURIComponent(h.prefecture)}`,className:"text-gray-600 hover:text-gray-800",children:["← ",h.prefecture,"の掲示板へ"]}),e.jsxs(l,{className:"p-4",children:[e.jsx("h1",{className:"font-bold text-xl",children:h.title}),h.dog_name&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[h.dog_name," の飼い主さん"]}),h.content&&e.jsx("p",{className:"mt-2 whitespace-pre-line",children:h.content}),"capasjapan@gmail.com"===p?.email&&e.jsx("div",{className:"mt-3",children:e.jsx("button",{className:"text-red-600 hover:text-red-700 underline text-sm",onClick:async()=>{if(!confirm("このスレッドを削除しますか？"))return;const{error:e}=await c.from("pref_threads").delete().eq("id",h.id);e?alert(`削除に失敗しました: ${e.message}`):u(`/community/boards?pref=${encodeURIComponent(h.prefecture)}`)},children:"スレッドを削除"})}),h.allow_dm&&p&&p.id!==h.author_id&&e.jsx("div",{className:"mt-3",children:e.jsx("button",{className:"text-blue-600 hover:text-blue-800 underline text-sm",onClick:()=>{try{sessionStorage.setItem("communityActiveTab","messages"),sessionStorage.setItem("communityOpenPartnerId",h.author_id)}catch{}u("/community")},children:"この投稿者にDMを送る"})})]}),e.jsx("div",{className:"space-y-3",children:j.map(t=>e.jsxs(l,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-gray-500",children:new Date(t.created_at).toLocaleString("ja-JP")}),t.image_url&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.image_url,alt:"attachment",className:"w-full max-h-80 object-cover rounded"})}),e.jsx("p",{className:"mt-2 whitespace-pre-line",children:t.content}),"capasjapan@gmail.com"===p?.email&&e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"text-red-600 hover:text-red-700 underline text-sm",onClick:async()=>{if(!confirm("この返信を削除しますか？"))return;const{error:e}=await c.from("pref_replies").delete().eq("id",t.id);e||g(e=>e.filter(e=>e.id!==t.id))},children:"返信を削除"})})]},t.id))}),e.jsxs(l,{className:"p-4",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"返信を書く"}),e.jsx("textarea",{value:w,onChange:e=>N(e.target.value),className:"w-full border rounded px-3 py-2",rows:3,placeholder:"返信内容"}),e.jsxs("div",{className:"mt-2 flex items-center gap-3 text-sm",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer px-3 py-2 rounded border hover:bg-gray-50 transition",children:[e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:e=>y(e.target.files?.[0]||null)}),e.jsx(o,{className:"w-4 h-4"})," 画像を添付"]}),C&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:C,alt:"preview",className:"w-10 h-10 object-cover rounded border"}),e.jsx("button",{className:"text-xs text-red-600 underline",onClick:()=>y(null),children:"取り消す"})]})]}),e.jsx("div",{className:"mt-3",children:e.jsxs(i,{onClick:async()=>{if(p){if(x){_(!0);try{let e=null;if(b){const t=await(async e=>{const t=await createImageBitmap(e),a=document.createElement("canvas"),s=Math.min(t.width,t.height,1200);a.width=s,a.height=s;const r=a.getContext("2d"),i=(t.width-s)/2,n=(t.height-s)/2;return r.drawImage(t,i,n,s,s,0,0,s,s),await new Promise(e=>a.toBlob(t=>e(t),"image/webp",.9))})(b),a=`boards/${x}/${p.id}_${Date.now()}.webp`;if(!(await c.storage.from("photos").upload(a,t,{contentType:"image/webp"})).error){const{data:t}=c.storage.from("photos").getPublicUrl(a);e=t.publicUrl}}const{error:t}=await c.from("pref_replies").insert({thread_id:x,content:w.trim(),author_id:p.id,image_url:e});if(t)throw t;N(""),y(null),await U(x)}finally{_(!1)}}}else u("/login?redirect="+encodeURIComponent(location.pathname))},disabled:v||!w.trim(),children:[v?e.jsx(m,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(d,{className:"w-4 h-4 mr-2"})," 返信する"]})})]})]}):e.jsx("div",{className:"max-w-3xl mx-auto px-4 py-6",children:e.jsx(l,{className:"p-4 text-center text-gray-500",children:"読み込み中..."})})}export{x as default};
