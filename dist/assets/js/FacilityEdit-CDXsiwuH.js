import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{c as t,a,L as r}from"./router-DXQOdrLL.js";import{s as i,B as l,u as d,S as n}from"./index-CU9jGkWm.js";import{C as c}from"./Card-DqVnP9TA.js";import{I as o}from"./ImageCropper-CcuPMJz6.js";import{I as m}from"./Input-2E2l4WcX.js";import{G as x,j as u,aI as h,av as g,C as p,U as j,r as f,V as b,_ as y,A as N,t as v,n as w,aM as _}from"./ui-basic-C77EGLVg.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function C({facilityId:t,facilityName:a}){const[r,d]=s.useState([]),[n,y]=s.useState({}),[N,v]=s.useState(!0),[w,_]=s.useState(!1),[C,S]=s.useState(null),[k,q]=s.useState(""),[E,$]=s.useState(""),[I,D]=s.useState({title:"",description:"",service_content:"",discount_type:"amount",start_date:"",end_date:"",usage_limit_type:"unlimited"}),[F,L]=s.useState(!1),[T,U]=s.useState(null),[z,O]=s.useState(!1),[R,P]=s.useState("");s.useEffect(()=>{B()},[t]);const B=async()=>{try{v(!0);const{data:e,error:s}=await i.from("facility_coupons").select("*").eq("facility_id",t).order("created_at",{ascending:!1});if(s)throw s;if(d(e||[]),e?.length){const s=e.map(async e=>{const{data:s}=await i.rpc("get_coupon_stats",{coupon_uuid:e.id});return{couponId:e.id,stats:s}}),t=(await Promise.all(s)).reduce((e,{couponId:s,stats:t})=>(e[s]=t,e),{});y(t)}}catch(e){q("クーポン情報の取得に失敗しました。")}finally{v(!1)}},G=()=>{D({title:"",description:"",service_content:"",discount_type:"amount",start_date:"",end_date:"",usage_limit_type:"unlimited"}),U(null),P(""),S(null),_(!1)};return N?e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-3/4"})]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center",children:[e.jsx(x,{className:"w-5 h-5 mr-2 text-pink-500"}),"クーポン管理"]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"お客様向けのクーポンを作成・管理できます"})]}),e.jsxs(l,{onClick:()=>_(!0),className:"flex items-center",children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"クーポン作成"]})]}),k&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:k}),E&&e.jsx("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4",children:E}),w&&e.jsxs(c,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:C?"クーポン編集":"クーポン作成"}),e.jsx(l,{variant:"secondary",onClick:G,className:"text-sm",children:"キャンセル"})]}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),L(!0),q("");try{if(!I.title.trim())throw new Error("クーポンタイトルを入力してください。");if(!I.service_content.trim())throw new Error("サービス内容を入力してください。");if(!I.start_date)throw new Error("開始日を入力してください。");if(!I.end_date)throw new Error("終了日を入力してください。");const e=new Date(I.start_date);if(new Date(I.end_date)<=e)throw new Error("終了日は開始日より後である必要があります。");let s=C?.coupon_image_url||"";if(T){const e=Date.now(),a=`coupon_${t}_${e}.jpg`,{error:r}=await i.storage.from("facility-images").upload(a,T,{contentType:"image/jpeg",upsert:!0});if(r)throw r;const{data:l}=i.storage.from("facility-images").getPublicUrl(a);s=l.publicUrl}const a={facility_id:t,title:I.title.trim(),description:I.description.trim(),service_content:I.service_content.trim(),coupon_image_url:s||null,discount_value:I.discount_value||null,discount_type:I.discount_type,start_date:I.start_date,end_date:I.end_date,usage_limit_type:I.usage_limit_type,max_uses:"once"===I.usage_limit_type?1:null,updated_at:(new Date).toISOString()};if(C){const{error:e}=await i.from("facility_coupons").update(a).eq("id",C.id);if(e)throw e;$("クーポンが更新されました！")}else{const{error:e}=await i.from("facility_coupons").insert(a);if(e)throw e;$("クーポンが作成されました！")}G(),B()}catch(s){q(s instanceof Error?s.message:"クーポンの保存に失敗しました。")}finally{L(!1)}},className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"クーポンタイトル *"}),e.jsx(m,{value:I.title,onChange:e=>D({...I,title:e.target.value}),placeholder:"例：初回利用10%OFF",maxLength:100,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"割引設定"}),e.jsxs("div",{className:"flex space-x-2 items-center",children:[e.jsxs("select",{value:I.discount_type,onChange:e=>D({...I,discount_type:e.target.value}),className:"border border-gray-300 rounded-md px-3 py-2 text-sm",children:[e.jsx("option",{value:"amount",children:"金額"}),e.jsx("option",{value:"percentage",children:"割引率"})]}),e.jsx(m,{type:"number",value:I.discount_value||"",onChange:e=>D({...I,discount_value:parseInt(e.target.value)||void 0}),placeholder:"amount"===I.discount_type?"500":"10",className:"w-24 text-lg font-medium text-center"}),e.jsx("span",{className:"flex items-center text-lg text-gray-700 font-medium",children:"amount"===I.discount_type?"円":"%"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"サービス内容 *"}),e.jsx("textarea",{value:I.service_content,onChange:e=>D({...I,service_content:e.target.value}),placeholder:"例：トリミング料金10%OFF（初回利用限定）",rows:3,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"詳細説明"}),e.jsx("textarea",{value:I.description,onChange:e=>D({...I,description:e.target.value}),placeholder:"クーポンの詳細な利用条件や注意事項を記載してください",rows:2,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"開始日 *"}),e.jsx(m,{type:"date",value:I.start_date,onChange:e=>D({...I,start_date:e.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"終了日 *"}),e.jsx(m,{type:"date",value:I.end_date,onChange:e=>D({...I,end_date:e.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"使用制限"}),e.jsxs("select",{value:I.usage_limit_type,onChange:e=>D({...I,usage_limit_type:e.target.value}),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",children:[e.jsx("option",{value:"unlimited",children:"何回でも"}),e.jsx("option",{value:"once",children:"1回限り"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"クーポン画像（オプション）"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[R&&e.jsx("img",{src:R,alt:"クーポン画像プレビュー",className:"w-32 h-20 object-cover border rounded-lg"}),e.jsxs(l,{type:"button",variant:"secondary",onClick:()=>document.getElementById("coupon-image-input")?.click(),className:"flex items-center",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"画像を選択"]}),e.jsx("input",{id:"coupon-image-input",type:"file",accept:"image/*",onChange:e=>{const s=e.target.files?.[0];s&&(e=>{U(e),O(!0)})(s)},className:"hidden"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(l,{type:"button",variant:"secondary",onClick:G,disabled:F,children:"キャンセル"}),e.jsxs(l,{type:"submit",disabled:F,className:"flex items-center",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),C?"更新":"作成"]})]})]})]}),e.jsx("div",{className:"space-y-4",children:0===r.length?e.jsxs(c,{className:"p-8 text-center",children:[e.jsx(x,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"クーポンがありません"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"最初のクーポンを作成してお客様にお得なサービスを提供しましょう"}),e.jsxs(l,{onClick:()=>_(!0),children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"クーポン作成"]})]}):r.map(s=>e.jsxs(c,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:s.title}),e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded-full "+(s.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"),children:s.is_active?"有効":"無効"}),e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800",children:"once"===s.usage_limit_type?"1回限り":"何回でも"})]}),e.jsx("p",{className:"text-gray-600 mb-3",children:s.service_content}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"期間："}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"w-4 h-4 mr-1 text-gray-400"}),new Date(s.start_date).toLocaleDateString()," 〜",new Date(s.end_date).toLocaleDateString()]})]}),n[s.id]&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"取得数："}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(j,{className:"w-4 h-4 mr-1 text-gray-400"}),n[s.id].total_obtained,"人"]})]}),n[s.id]&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"使用数："}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{className:"w-4 h-4 mr-1 text-gray-400"}),n[s.id].total_used,"回"]})]}),n[s.id]&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"使用率："}),e.jsxs("div",{className:"font-medium",children:[n[s.id].usage_rate,"%"]})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:s.description})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>(e=>{S(e),D({title:e.title,description:e.description,service_content:e.service_content,discount_value:e.discount_value,discount_type:e.discount_type,start_date:e.start_date.split("T")[0],end_date:e.end_date.split("T")[0],usage_limit_type:e.usage_limit_type}),P(e.coupon_image_url||""),_(!0)})(s),children:[e.jsx(f,{className:"w-4 h-4 mr-1"}),"編集"]}),e.jsx(l,{variant:s.is_active?"secondary":"primary",size:"sm",onClick:()=>(async e=>{try{const{error:s}=await i.from("facility_coupons").update({is_active:!e.is_active}).eq("id",e.id);if(s)throw s;$(e.is_active?"クーポンを無効化しました。":"クーポンを有効化しました。"),B()}catch(s){q("クーポンの状態変更に失敗しました。")}})(s),children:s.is_active?"無効化":"有効化"}),e.jsx(l,{variant:"danger",size:"sm",onClick:()=>(async e=>{if(window.confirm("このクーポンを削除しますか？この操作は取り消せません。"))try{const{error:s}=await i.from("facility_coupons").delete().eq("id",e);if(s)throw s;$("クーポンが削除されました。"),B()}catch(s){q("クーポンの削除に失敗しました。")}})(s.id),children:e.jsx(b,{className:"w-4 h-4"})})]})]}),s.coupon_image_url&&e.jsx("div",{className:"mt-4",children:e.jsx("img",{src:s.coupon_image_url,alt:"クーポン画像",className:"max-w-md h-auto border rounded-lg"})})]},s.id))}),z&&T&&e.jsx(o,{imageFile:T,onCropComplete:e=>{const s=URL.createObjectURL(e);P(s),D({...I,coupon_image:e}),U(e),O(!1)},onCancel:()=>O(!1),aspectRatio:1})]})}function S(){const{id:p}=t(),{user:j}=d(),S=a(),[k,q]=s.useState(null),[E,$]=s.useState([]),[I,D]=s.useState(!0),[F,L]=s.useState(!1),[T,U]=s.useState(""),[z,O]=s.useState(""),[R,P]=s.useState(!1),[B,G]=s.useState(""),[M,W]=s.useState(!1),[A,H]=s.useState([]),[V,J]=s.useState(!1),[K,Q]=s.useState(null),[X,Y]=s.useState(null),[Z,ee]=s.useState(!1),[se,te]=s.useState({name:"",category_id:"",address:"",phone:"",website:"",description:""}),[ae,re]=s.useState("info");s.useEffect(()=>{j&&p?ie():S("/my-facilities-management")},[j,p,S]);const ie=async()=>{try{D(!0);const{data:e,error:s}=await i.from("pet_facilities").select("*").eq("id",p).eq("owner_id",j?.id).single();if(s)throw s;if(!e)return void S("/my-facilities-management");q(e),te({name:e.name||"",category_id:e.category_id||"",address:e.address||"",phone:e.phone||"",website:e.website||"",description:e.description||""}),e.identity_document_url;const{data:t,error:a}=await i.from("pet_facility_images").select("*").eq("facility_id",p).order("display_order",{ascending:!0});if(a)throw a;H(t||[]);const{data:r,error:l}=await i.from("facility_categories").select("*").order("name");if(l)throw l;$(r||[])}catch(e){U("施設データの読み込みに失敗しました。"),D(!1)}},le=(e,s)=>{const t=e.target.files?.[0];t&&(t.type.startsWith("image/")?t.size>10485760?U("ファイルサイズは10MB未満にしてください。"):(Q(t),Y(s??null),J(!0)):U("画像ファイルを選択してください。"))},de=async e=>{if(window.confirm("この画像を削除しますか？"))try{U("");const{error:s}=await i.from("pet_facility_images").delete().eq("id",e);if(s)throw s;H(s=>s.filter(s=>s.id!==e));const t=A.filter(s=>s.id!==e);for(let e=0;e<t.length;e++){const s=0===e?"main":"additional";t[e].display_order===e&&t[e].image_type===s||await i.from("pet_facility_images").update({display_order:e,image_type:s}).eq("id",t[e].id)}O("画像が削除されました。"),ie(),setTimeout(()=>O(""),3e3)}catch(s){U("画像の削除に失敗しました。")}},ne=e=>{const{name:s,value:t}=e.target;te(e=>({...e,[s]:t}))};if(I)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!k)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"施設が見つかりません"}),e.jsx(r,{to:"/my-facilities-management",children:e.jsx(l,{children:"管理画面に戻る"})})]})});return e.jsxs(e.Fragment,{children:[e.jsx(n,{title:`${k.name} - 施設編集`,description:"ペット関連施設の情報を編集・管理します。"}),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:e.jsxs(r,{to:"/my-facilities-management",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),"施設管理一覧に戻る"]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("div",{className:"bg-white rounded-lg border p-6 mb-6",children:e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:k.name}),e.jsx("p",{className:"text-gray-600 mt-1",children:k.address}),e.jsx("div",{className:"flex items-center mt-2",children:(s=>{switch(s){case"approved":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full",children:"承認済み"});case"pending":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full",children:"審査中"});case"rejected":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full",children:"却下"});default:return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full",children:"不明"})}})(k.status)})]}),e.jsx("div",{className:"flex space-x-3",children:"approved"===k.status&&e.jsx(r,{to:`/parks?view=facilities&facility=${k.id}`,children:e.jsxs(l,{variant:"secondary",className:"min-w-[100px]",children:[e.jsx(f,{className:"w-4 h-4 mr-2"}),"公開ページ"]})})})]})}),T&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 mb-6",children:[e.jsx(N,{className:"w-5 h-5 inline mr-2"}),T]}),z&&e.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 mb-6",children:[e.jsx(v,{className:"w-5 h-5 inline mr-2"}),z]}),e.jsxs("div",{className:"bg-white rounded-lg border mb-6",children:[e.jsx("div",{className:"border-b",children:e.jsxs("nav",{className:"flex space-x-8 px-6",children:[e.jsxs("button",{onClick:()=>re("info"),className:"py-4 px-2 border-b-2 font-medium text-sm "+("info"===ae?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[e.jsx(w,{className:"w-4 h-4 inline mr-2"}),"基本情報"]}),e.jsxs("button",{onClick:()=>re("images"),className:"py-4 px-2 border-b-2 font-medium text-sm "+("images"===ae?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[e.jsx(h,{className:"w-4 h-4 inline mr-2"}),"画像管理"]}),e.jsxs("button",{onClick:()=>re("coupons"),className:"py-4 px-2 border-b-2 font-medium text-sm "+("coupons"===ae?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[e.jsx(x,{className:"w-4 h-4 inline mr-2"}),"クーポン管理"]})]})}),e.jsxs("div",{className:"p-6",children:["info"===ae&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(w,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設情報の編集"]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),k&&j){L(!0),U(""),O("");try{if(!se.name.trim())throw new Error("施設名を入力してください。");if(!se.category_id)throw new Error("カテゴリを選択してください。");if(!se.address.trim())throw new Error("住所を入力してください。");if(!se.phone.trim())throw new Error("電話番号を入力してください。");k.identity_document_url,k.identity_document_filename;const{error:e}=await i.from("pet_facilities").update({name:se.name.trim(),category_id:se.category_id,address:se.address.trim(),phone:se.phone.trim(),website:se.website.trim()||null,description:se.description.trim()||null,updated_at:(new Date).toISOString()}).eq("id",k.id);if(e)throw e;O("施設情報を更新しました。"),await ie(),setTimeout(()=>{O("")},3e3)}catch(s){U(s instanceof Error?s.message:"更新に失敗しました。")}finally{L(!1)}}},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設名 *"}),e.jsx(m,{name:"name",value:se.name,onChange:ne,placeholder:"施設名を入力",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"カテゴリ *"}),e.jsxs("select",{name:"category_id",value:se.category_id,onChange:ne,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"カテゴリを選択"}),E.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所 *"}),e.jsx(m,{name:"address",value:se.address,onChange:ne,placeholder:"住所を入力",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(m,{name:"phone",value:se.phone,onChange:ne,placeholder:"電話番号を入力",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(m,{name:"website",value:se.website,onChange:ne,placeholder:"https://example.com"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設説明"}),e.jsx("textarea",{name:"description",value:se.description,onChange:ne,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"施設の特徴やサービス内容を入力"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設画像 (最大5枚)"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"1枚目がメイン画像として使用されます。施設の雰囲気がわかる画像をアップロードしてください。"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-4",children:[A.map((s,t)=>e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:s.image_url,alt:`施設画像 ${t+1}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded",children:0===t?"メイン":t+1})}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>le(e,t),className:"hidden",id:`image-replace-${t}`}),e.jsx("label",{htmlFor:`image-replace-${t}`,className:"bg-white text-gray-600 p-1 rounded shadow hover:bg-gray-50 cursor-pointer",title:"画像を変更",children:e.jsx(h,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>de(s.id),className:"bg-red-500 text-white p-1 rounded shadow hover:bg-red-600",title:"画像を削除",children:e.jsx(b,{className:"w-4 h-4"})})]})})]},s.id)),A.length<5&&e.jsxs("div",{className:"aspect-square bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>le(e),className:"hidden",id:"image-add"}),e.jsxs("label",{htmlFor:"image-add",className:"flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600",children:[e.jsx(u,{className:"w-8 h-8 mb-2"}),e.jsx("span",{className:"text-sm font-medium",children:"画像を追加"})]})]})]}),0===A.length&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(_,{className:"w-12 h-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"text-sm",children:"まだ画像がアップロードされていません"}),e.jsx("p",{className:"text-xs mt-1",children:"最初の画像がメイン画像として使用されます"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(l,{type:"submit",isLoading:F,children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"更新"]})})]})]}),"images"===ae&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(h,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設画像の管理"]}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"施設の画像を管理します。最大5枚まで登録でき、最初の画像がメイン画像として使用されます。"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-4",children:[A.map((s,t)=>e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:s.image_url,alt:`施設画像 ${t+1}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded",children:0===t?"メイン":t+1})}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>le(e,t),className:"hidden",id:`image-replace-${t}`}),e.jsx("label",{htmlFor:`image-replace-${t}`,className:"bg-white text-gray-600 p-1 rounded shadow hover:bg-gray-50 cursor-pointer",title:"画像を変更",children:e.jsx(h,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>de(s.id),className:"bg-red-500 text-white p-1 rounded shadow hover:bg-red-600",title:"画像を削除",children:e.jsx(b,{className:"w-4 h-4"})})]})})]},s.id)),A.length<5&&e.jsxs("div",{className:"aspect-square bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>le(e),className:"hidden",id:"image-add"}),e.jsxs("label",{htmlFor:"image-add",className:"flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600",children:[e.jsx(u,{className:"w-8 h-8 mb-2"}),e.jsx("span",{className:"text-sm font-medium",children:"画像を追加"})]})]})]}),0===A.length&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(_,{className:"w-12 h-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"text-sm",children:"まだ画像がアップロードされていません"}),e.jsx("p",{className:"text-xs mt-1",children:"最初の画像がメイン画像として使用されます"})]})]}),"coupons"===ae&&k&&e.jsx(C,{facilityId:k.id,facilityName:k.name})]})]}),"info"===ae&&e.jsx(c,{className:"p-6 border-red-200 bg-red-50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(b,{className:"w-6 h-6 text-red-600 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-red-900 mb-2",children:"危険な操作"}),e.jsxs("p",{className:"text-sm text-red-800 mb-4",children:["この施設を完全に削除します。削除後はデータの復旧はできません。","approved"===k.status&&e.jsx("span",{className:"block mt-1 font-medium",children:"※ 承認済みの施設を削除すると、公開ページからも削除されます。"})]}),e.jsxs(l,{onClick:()=>P(!0),className:"bg-red-600 hover:bg-red-700 text-white",size:"sm",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"施設を削除"]})]})]})}),R&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(b,{className:"w-6 h-6 text-red-600 mr-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"施設の削除確認"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[e.jsx("span",{className:"font-medium text-red-600",children:"警告:"})," この操作は取り消せません。"]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["削除を実行するには、施設名「",e.jsx("span",{className:"font-medium",children:k.name}),"」を入力してください。"]}),e.jsx("input",{type:"text",value:B,onChange:e=>G(e.target.value),placeholder:"施設名を入力",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(l,{onClick:()=>{P(!1),G("")},variant:"secondary",disabled:M,children:"キャンセル"}),e.jsxs(l,{onClick:async()=>{if(k&&B===k.name){if(window.confirm("本当にこの施設を完全に削除しますか？\nこの操作は取り消せません。"))try{W(!0),U("");const{data:s}=await i.from("profiles").select("role").eq("id",j?.id).single();try{await i.from("pet_facility_images").delete().eq("facility_id",k.id)}catch(e){}let t=i.from("pet_facilities").delete();t="admin"===s?.role?t.eq("id",k.id):t.eq("id",k.id).eq("owner_id",j?.id);const{error:a}=await t;if(a){if(a.message?.includes("RLS"))throw new Error("権限エラー: この施設を削除する権限がありません。管理者にお問い合わせください。");throw new Error(`削除処理エラー: ${a.message}`)}const{data:r,error:l}=await i.from("pet_facilities").select("id").eq("id",k.id).single();if(r){if("admin"!==s?.role)throw new Error("削除する施設が見つからない、または削除権限がありません。");{const{error:e}=await i.rpc("force_delete_facility",{target_facility_id:k.id});if(e)throw new Error(`削除に失敗しました。データベース管理者にお問い合わせください。エラー: ${e.message}`);const{data:s}=await i.from("pet_facilities").select("id").eq("id",k.id).single();if(s)throw new Error("施設の削除に失敗しました。データベース管理者にお問い合わせください。")}}else if(l&&"PGRST116"!==l.code)throw new Error(`削除検証でエラーが発生しました: ${l.message}`);O("施設が正常に削除されました。"),setTimeout(()=>{S("/my-facilities-management")},3e3)}catch(s){U(`削除処理でエラーが発生しました: ${s.message}`)}finally{W(!1),P(!1),G("")}}else U("施設名が正しく入力されていません。")},className:"bg-red-600 hover:bg-red-700 text-white",disabled:M||B!==k.name,isLoading:M,children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"削除実行"]})]})]})}),V&&K&&e.jsx(o,{imageFile:K,onCropComplete:async e=>{if(k)try{ee(!0),U("");const s=Date.now(),t=`facility_${k.id}_${s}.jpg`,{data:a,error:r}=await i.storage.from("vaccine-certs").upload(t,e,{contentType:"image/jpeg",upsert:!0});if(r)throw r;const{data:l}=i.storage.from("vaccine-certs").getPublicUrl(t),d=l.publicUrl;if(null===X){const e=A.length,s=0===A.length?"main":"additional",{data:t,error:a}=await i.from("pet_facility_images").insert({facility_id:k.id,image_url:d,image_type:s,display_order:e}).select().single();if(a)throw a;H(e=>[...e,t])}else{const e=A[X],{data:s,error:t}=await i.from("pet_facility_images").update({image_url:d,updated_at:(new Date).toISOString()}).eq("id",e.id).select().single();if(t)throw t;H(e=>e.map(e=>e.id===s.id?s:e))}O("画像がアップロードされました。"),setTimeout(()=>O(""),3e3)}catch(s){U("画像のアップロードに失敗しました。")}finally{ee(!1),J(!1),Q(null),Y(null)}},onCancel:()=>{J(!1),Q(null),Y(null)},aspectRatio:1,maxWidth:400,maxHeight:400})]})]})]})}export{S as default};
