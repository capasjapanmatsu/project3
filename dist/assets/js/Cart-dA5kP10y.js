import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{a as t,L as a}from"./router-DXQOdrLL.js";import{u as r,b as c,l,s as i,B as n,c as d}from"./index-5HajhoTL.js";import{C as o}from"./Card-DqVnP9TA.js";import{c as m,V as x,q as h,a5 as j,j as p,o as u,a6 as g,a7 as N,l as f}from"./ui-basic-CJygcczc.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function b(){const{user:b}=r(),w=t(),[y,v]=s.useState([]),[S,_]=s.useState(!0),{isActive:q}=c(),[L,k]=s.useState(null);s.useEffect(()=>{b&&C();if("true"===new URLSearchParams(window.location.search).get("canceled")){k("決済がキャンセルされました。カートから商品を確認できます。"),window.history.replaceState({},document.title,window.location.pathname);const s=localStorage.getItem("pre_payment_auth_state");if(s)try{const e=JSON.parse(s);l("info","🛒 Cart: Pre-payment auth state found",{authState:e}),b&&b.id===e.user_id||(k("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{w("/login")},3e3)),localStorage.removeItem("pre_payment_auth_state")}catch(e){l("error","Failed to parse pre-payment auth state",{error:e})}}},[b,w]);const C=async()=>{try{const{data:e,error:s}=await i.from("cart_items").select("*, product:products(*)").eq("user_id",b?.id).order("created_at",{ascending:!1});if(s)throw s;v(e||[])}catch(e){k(e.message||"カート情報の取得に失敗しました")}finally{_(!1)}},F=async(e,s)=>{if(s<=0)await I(e);else try{const t=await d(()=>i.from("cart_items").update({quantity:s}).eq("id",e));if(t.error)throw t.error;await C()}catch(t){l("error","Error updating quantity",{error:t,cartItemId:e,newQuantity:s}),k("数量の更新に失敗しました。再度お試しください。")}},I=async e=>{try{const s=await d(()=>i.from("cart_items").delete().eq("id",e));if(s.error)throw s.error;await C()}catch(s){l("error","Error removing item",{error:s,cartItemId:e}),k("商品の削除に失敗しました。再度お試しください。")}},E=e=>q?Math.round(.9*e):e,A=()=>{const e=y.reduce((e,s)=>e+E(s.product.price)*s.quantity,0),s=y.reduce((e,s)=>e+s.product.price*s.quantity,0),t=e>=5e3||q?0:690;return{subtotal:e,originalSubtotal:s,discountAmount:s-e,shippingFee:t,total:e+t}};return S?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):0===y.length?e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(m,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート"]}),e.jsxs(o,{className:"text-center py-12",children:[e.jsx(m,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"カートは空です"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"お気に入りの商品をカートに追加してください"}),e.jsx(a,{to:"/shop",children:e.jsx(n,{className:"bg-green-600 hover:bg-green-700",children:"ショッピングを続ける"})})]})]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(m,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート (",y.length,"点)"]}),e.jsxs(n,{variant:"secondary",onClick:async()=>{try{const e=await d(()=>i.from("cart_items").delete().eq("user_id",b?.id));if(e.error)throw e.error;await C()}catch(e){l("error","Error clearing cart",{error:e,userId:b?.id}),k("カートの削除に失敗しました。再度お試しください。")}},className:"text-red-600 hover:text-red-700",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"カートを空にする"]})]}),L&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(h,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:L})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-4",children:y.map(s=>{const t=s.product.price,a=E(t),r=q&&a<t;return e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-20 h-20 object-cover rounded-lg",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.product.name}),s.product.brand&&e.jsx("p",{className:"text-sm text-gray-500",children:s.product.brand}),e.jsxs("div",{className:"mt-1 space-y-1 text-xs text-gray-500",children:[s.product.weight&&e.jsxs("p",{children:["内容量: ",s.product.weight,"g"]}),s.product.size&&e.jsxs("p",{children:["サイズ: ",s.product.size]})]})]}),e.jsx("button",{onClick:()=>I(s.id),className:"text-red-500 hover:text-red-700 p-1",children:e.jsx(x,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",a.toLocaleString()]}),r&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",t.toLocaleString()]})]}),q&&e.jsx("p",{className:"text-xs text-purple-600",children:"サブスク会員価格"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>F(s.id,s.quantity-1),className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(j,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium w-8 text-center",children:s.quantity}),e.jsx("button",{onClick:()=>F(s.id,s.quantity+1),className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(p,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsxs("span",{className:"text-lg font-semibold",children:["小計: ¥",(a*s.quantity).toLocaleString()]})})]})]})},s.id)})}),e.jsxs("div",{className:"space-y-6",children:[q?e.jsxs(o,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(u,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),e.jsx("p",{className:"text-sm",children:"全商品10%OFF + 送料無料"})]}):e.jsxs(o,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(u,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスクリプションでもっとお得に！"})]}),e.jsx("p",{className:"text-sm mb-3",children:"全商品10%OFF + 送料無料"}),e.jsx(a,{to:"/subscription-intro",children:e.jsx(n,{size:"sm",className:"bg-white text-purple-600 hover:bg-gray-100",children:"詳細を見る"})})]}),e.jsxs(o,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文サマリー"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",A().originalSubtotal.toLocaleString()]})]}),A().discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsx("span",{children:"サブスク割引 (10%)"}),e.jsxs("span",{children:["-¥",A().discountAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(g,{className:"w-4 h-4 mr-1"}),"送料"]}),e.jsx("span",{children:0===A().shippingFee?e.jsx("span",{className:"text-green-600",children:"無料"}):`¥${A().shippingFee.toLocaleString()}`})]}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",A().total.toLocaleString()]})]})]}),!q&&A().subtotal<5e3&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["あと¥",(5e3-A().subtotal).toLocaleString(),"で送料無料！"]})}),e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsxs(n,{onClick:()=>{0!==y.length?w("/checkout",{state:{cartItems:y.map(e=>e.id),totals:A()}}):k("カートに商品がありません。")},className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",children:[e.jsx(N,{className:"w-5 h-5 mr-2"}),"レジに進む",e.jsx(f,{className:"w-5 h-5 ml-2"})]}),e.jsx(a,{to:"/shop",children:e.jsx(n,{variant:"secondary",className:"w-full",children:"ショッピングを続ける"})})]})]}),e.jsx(o,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(g,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"}),e.jsx("p",{children:"• 時間指定配送も可能です"})]})]})]})})]})]})]})}export{b as Cart};
