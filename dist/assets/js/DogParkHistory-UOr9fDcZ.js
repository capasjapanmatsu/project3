import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{a,L as t}from"./router-DXQOdrLL.js";import{u as l,s as r,B as n}from"./index-B5Yotd62.js";import{C as i}from"./Card-DqVnP9TA.js";import{I as c}from"./Input-BA7ko280.js";import{_ as d,C as o,n as m,M as x,i as h,w as u,D as g,x as j,P as p,J as f,X as b,U as N,q as v,t as y}from"./ui-basic-DDpq4BmP.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function w(){const{user:w}=l(),_=a(),[k,S]=s.useState([]),[C,D]=s.useState(!0),[L,$]=s.useState(""),[z,M]=s.useState("all"),[q,I]=s.useState((new Date).getFullYear().toString()),[F,P]=s.useState("all"),[Y,E]=s.useState([]),[J,O]=s.useState(0),[U,A]=s.useState(0),[B,R]=s.useState(""),[T,V]=s.useState([]),[G,H]=s.useState(null),[K,Q]=s.useState(null),[W,X]=s.useState(null),[Z,ee]=s.useState(null);s.useEffect(()=>{w?se():_("/login")},[w,_]);const se=async()=>{try{D(!0);const{data:e,error:s}=await r.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("user_id",w?.id).order("date",{ascending:!1}).limit(50);if(s)throw s;const{data:a,error:t}=await r.from("dogs").select("*").eq("owner_id",w?.id);if(t)throw t;if(S(e||[]),E(a||[]),e){O(e.length);const s=new Set(e.map(e=>e.park_id));A(s.size);const a={};e.forEach(e=>{const s=e.park_id;a[s]||(a[s]={count:0,name:e.dog_park.name,id:s}),a[s].count++});const t=Object.values(a).sort((e,s)=>s.count-e.count).slice(0,3).map(e=>({id:e.id,name:e.name,visits:e.count}));V(t),t.length>0&&R(t[0].name)}}catch(e){}finally{D(!1)}},ae=e=>["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"][e-1],te=s.useMemo(()=>k.filter(e=>{const s=e.dog_park.name.toLowerCase().includes(L.toLowerCase())||e.dog_park.address.toLowerCase().includes(L.toLowerCase())||e.dog.name.toLowerCase().includes(L.toLowerCase()),a="all"===z||e.dog_id===z,t=new Date(e.date),l="all"===q||t.getFullYear().toString()===q,r="all"===F||(t.getMonth()+1).toString()===F;return s&&a&&l&&r}),[k,L,z,q,F]);return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(t,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(o,{className:"w-8 h-8 text-blue-600 mr-3"}),"ドッグラン利用履歴"]}),e.jsx("p",{className:"text-lg text-gray-600",children:"これまでのドッグラン利用記録を確認できます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(i,{className:"p-6 text-center",children:[e.jsx(o,{className:"w-12 h-12 text-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:J}),e.jsx("p",{className:"text-gray-600",children:"総利用回数"})]}),e.jsxs(i,{className:"p-6 text-center",children:[e.jsx(m,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:U}),e.jsx("p",{className:"text-gray-600",children:"訪問したドッグラン数"})]}),e.jsxs(i,{className:"p-6 text-center",children:[e.jsx(x,{className:"w-12 h-12 text-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-xl font-bold text-gray-900 mb-1",children:B||"-"}),e.jsx("p",{className:"text-gray-600",children:"最も訪問したドッグラン"})]})]}),T.length>0&&e.jsxs(i,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(h,{className:"w-6 h-6 text-pink-600 mr-2"}),"よく行くドッグラン"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:T.map((s,a)=>e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-600 font-bold",children:a+1}),e.jsx("h3",{className:"font-semibold",children:s.name})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(o,{className:"w-4 h-4 text-gray-500 mr-1"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[s.visits,"回利用"]})]}),e.jsx(t,{to:`/parks/${s.id}`,children:e.jsx(n,{size:"sm",variant:"secondary",children:"詳細"})})]})]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(c,{label:"",value:L,onChange:e=>$(e.target.value),placeholder:"ドッグラン名、住所で検索...",icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})})}),e.jsx("div",{children:e.jsxs("select",{value:z,onChange:e=>M(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべてのワンちゃん"}),Y.map(s=>e.jsxs("option",{value:s.id,children:[s.name,"ちゃん"]},s.id))]})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("select",{value:q,onChange:e=>I(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべての年"}),(()=>{const e=(new Date).getFullYear(),s=[];for(let a=e;a>=e-2;a--)s.push({value:a.toString(),label:`${a}年`});return s})().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx("select",{value:F,onChange:e=>P(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:(()=>{const e=[{value:"all",label:"すべての月"}];for(let s=1;s<=12;s++)e.push({value:s.toString(),label:ae(s)});return e})().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(n,{variant:"secondary",size:"sm",onClick:()=>{if(0===te.length)return;const e="\ufeff"+[["日付","時間","ドッグラン名","住所","ワンちゃん","料金","予約タイプ"].join(","),...te.map(e=>[new Date(e.date).toLocaleDateString("ja-JP"),`${e.start_time}〜${parseInt(e.start_time)+e.duration}:00`,`"${e.dog_park.name.replace(/"/g,'""')}"`,`"${e.dog_park.address.replace(/"/g,'""')}"`,`"${e.dog.name.replace(/"/g,'""')}"`,`¥${e.total_amount}`,"regular"===e.reservation_type?"通常利用":"private_booth"===e.reservation_type?"プライベートブース":"施設貸し切り"].join(","))].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(s),t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("download",`dogpark_history_${(new Date).toISOString().split("T")[0]}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)},children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),0===te.length?e.jsxs(i,{className:"text-center py-12",children:[e.jsx(o,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"利用履歴がありません"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"まだドッグランを利用していないようです"}),e.jsx(t,{to:"/parks",children:e.jsx(n,{children:"ドッグランを予約する"})})]}):e.jsx("div",{className:"space-y-6",children:te.map(s=>{const a=new Date(s.date),l=a.toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),c=s.start_time,d=`${parseInt(c)+s.duration}:00`,h="regular"===s.reservation_type?"通常利用":"private_booth"===s.reservation_type?"プライベートブース":"施設貸し切り";return e.jsxs(i,{className:"p-6 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start gap-4",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsxs("div",{className:"bg-blue-100 rounded-lg p-3 text-center min-w-[80px]",children:[e.jsx("p",{className:"text-sm text-blue-800",children:a.getFullYear()}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:a.getDate()}),e.jsx("p",{className:"text-sm text-blue-800",children:ae(a.getMonth()+1)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:s.dog_park.name}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(x,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:s.dog_park.address})]}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(j,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-sm",children:[c," 〜 ",d]})]}),e.jsxs("div",{className:"flex items-center text-gray-600 mt-1",children:[e.jsx(p,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-sm",children:[s.dog.name,"ちゃん（",s.dog.breed,"）"]})]}),Math.random()>.5&&e.jsx("div",{className:"flex items-center mt-2",children:[1,2,3,4,5].map(s=>e.jsx(f,{className:"w-4 h-4 "+(s<=Math.floor(3+2*Math.random())?"text-yellow-400 fill-current":"text-gray-300")},s))})]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",s.total_amount.toLocaleString()]})}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("regular"===s.reservation_type?"bg-blue-100 text-blue-800":"private_booth"===s.reservation_type?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"),children:h})}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+("confirmed"===s.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:"confirmed"===s.status?"利用済み":"キャンセル"})})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 flex justify-between items-center",children:[e.jsx("div",{className:"text-sm text-gray-500",children:l}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(t,{to:`/parks/${s.park_id}`,children:e.jsxs(n,{size:"sm",variant:"secondary",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"施設詳細"]})}),e.jsx(t,{to:`/reservation/${s.park_id}`,children:e.jsxs(n,{size:"sm",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),"再予約"]})}),"confirmed"===s.status&&e.jsxs(n,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",isLoading:G===s.id,onClick:async()=>{const e=await(async e=>{const s="whole_facility"===e.reservation_type,a=new Date,t=new Date(e.date),l=new Date(t);if(l.setDate(t.getDate()-1),s)return a<l;{const{data:s}=await r.from("user_entry_exit_logs").select("*").eq("user_id",e.user_id).eq("park_id",e.park_id).eq("action","entry").gte("timestamp",e.date);return!s||0===s.length}})(s);e?Q(s.id):X("この予約はキャンセルできません（貸し切りは1日前まで、通常予約はPIN未使用時のみ）")},children:[e.jsx(b,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]})]},s.id)})}),te.length>0&&e.jsx(i,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(N,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"コミュニティ機能"}),e.jsx("p",{className:"text-sm text-blue-800 mb-3",children:"同じドッグランを利用した他のワンちゃんとの出会いを「コミュニティ」ページで確認できます。 友達申請を送ったり、次回の予約を調整したりして、ワンちゃん同士の交流を深めましょう。"}),e.jsx(t,{to:"/community",children:e.jsxs(n,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"コミュニティを見る"]})})]})]})}),K&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(v,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"予約をキャンセルしますか？"}),e.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(n,{variant:"secondary",onClick:()=>Q(null),children:"戻る"}),e.jsx(n,{className:"bg-red-600 hover:bg-red-700",isLoading:G===K,onClick:()=>{const e=te.find(e=>e.id===K);e&&(async e=>{H(e.id),X(null),ee(null);try{const{data:s,error:a}=await r.rpc("cancel_reservation",{p_reservation_id:e.id,p_user_id:e.user_id});if(a||!s?.success)return void X(s&&s.message||a?.message||"キャンセルに失敗しました");ee("予約をキャンセルしました"),Q(null),await se(),setTimeout(()=>ee(null),3e3)}catch(s){X(s.message||"キャンセルに失敗しました")}finally{H(null)}})(e)},children:"キャンセルする"})]})]})}),Z&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:Z})]})}),W&&e.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),e.jsx("p",{className:"text-red-700 mt-1",children:W})]})]})}export{w as DogParkHistory};
