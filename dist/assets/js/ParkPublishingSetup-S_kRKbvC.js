import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{u as a,s as r,B as t}from"./index-DZ9PL4Kw.js";import{C as l}from"./Card-DqVnP9TA.js";import{D as i}from"./DoorLockButton-DK382H2I.js";import{I as c}from"./Input-R783aYSb.js";import{c as d,a as n}from"./router-DXQOdrLL.js";import{q as m,_ as o,t as x,ar as h,K as g,p as j,Q as u,a0 as p,aw as b,X as f,r as N,d as y}from"./ui-basic-CJygcczc.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function w(){const{parkId:w}=d(),v=n(),{user:k}=a(),[_,T]=s.useState(null),[C,L]=s.useState([]),[S,q]=s.useState(!0),[E,P]=s.useState(""),[$,I]=s.useState(""),[U,D]=s.useState({smartLockTest:!1,pageEditing:!1,readyToPublish:!1}),[B,R]=s.useState(!1),[A,F]=s.useState({name:"",description:"",facility_details:"",price:0}),[K,O]=s.useState([]),[Q,z]=s.useState([]),[G,H]=s.useState(!1),[J,M]=s.useState(!1);s.useEffect(()=>{k&&w?V():v("/owner-dashboard")},[k,w,v]);const V=async()=>{try{q(!0);const{data:e,error:s}=await r.from("dog_parks").select("*").eq("id",w).eq("owner_id",k?.id).single();if(s)throw s;if(!e)return void P("ドッグランが見つかりません。");if("qr_testing_ready"!==e.status&&"editing"!==e.status&&"ready_to_publish"!==e.status)return void P("このドッグランは公開準備の段階ではありません。");T(e),F({name:e.name||"",description:e.description||"",facility_details:e.facility_details||"",price:e.price||0});const{data:a,error:t}=await r.from("smart_locks").select("*").eq("park_id",w);if(t)throw t;L(a||[]),W(e)}catch(e){P("データの取得に失敗しました。")}finally{q(!1)}},W=e=>{const s={smartLockTest:"qr_testing_ready"!==e.status,pageEditing:"ready_to_publish"===e.status,readyToPublish:"ready_to_publish"===e.status};D(s)},X=async()=>{try{const{error:e}=await r.from("dog_parks").update({status:"editing"}).eq("id",w);if(e)throw e;D(e=>({...e,smartLockTest:!0})),I("スマートロックのテストが完了しました。"),await V()}catch(e){P("スマートロックテストの完了記録に失敗しました。")}},Y=async()=>{for(const e of K){const s=`${Date.now()}_${e.name}`,a=`${w}/${s}`,{error:t}=await r.storage.from("dog-park-images").upload(a,e);if(t)throw t;const l=r.storage.from("dog-park-images").getPublicUrl(a).data.publicUrl;await r.from("dog_parks").update({image_url:l}).eq("id",w)}};return S?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):_?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{children:[e.jsxs(t,{variant:"secondary",onClick:()=>v("/owner-dashboard"),className:"mb-4",children:[e.jsx(o,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]}),e.jsxs("h1",{className:"text-2xl font-bold",children:[_.name," - 公開準備"]}),e.jsx("p",{className:"text-gray-600",children:"二次審査が承認されました。公開前に以下の作業を完了してください。"})]})}),E&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border-l-4 border-red-400 text-red-700",children:e.jsxs("div",{className:"flex",children:[e.jsx(m,{className:"w-5 h-5 mr-2 mt-0.5"}),E]})}),$&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border-l-4 border-green-400 text-green-700",children:e.jsxs("div",{className:"flex",children:[e.jsx(x,{className:"w-5 h-5 mr-2 mt-0.5"}),$]})}),e.jsxs(l,{className:"mb-6 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"公開準備の進捗"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center p-4 rounded-lg "+(U.smartLockTest?"bg-green-50":"bg-yellow-50"),children:[e.jsx("div",{className:"w-6 h-6 rounded-full mr-4 flex items-center justify-center "+(U.smartLockTest?"bg-green-500":"bg-yellow-500"),children:U.smartLockTest?e.jsx(h,{className:"w-4 h-4 text-white"}):e.jsx("span",{className:"text-white text-sm",children:"1"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:"スマートロックの動作確認"}),e.jsx("p",{className:"text-sm text-gray-600",children:U.smartLockTest?"動作確認が完了しました":"スマートロックの動作を確認してください"})]})]}),e.jsxs("div",{className:"flex items-center p-4 rounded-lg "+(U.pageEditing?"bg-green-50":"bg-yellow-50"),children:[e.jsx("div",{className:"w-6 h-6 rounded-full mr-4 flex items-center justify-center "+(U.pageEditing?"bg-green-500":"bg-yellow-500"),children:U.pageEditing?e.jsx(h,{className:"w-4 h-4 text-white"}):e.jsx("span",{className:"text-white text-sm",children:"2"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:"掲載ページの編集"}),e.jsx("p",{className:"text-sm text-gray-600",children:U.pageEditing?"掲載ページの編集が完了しました":"掲載ページの内容を編集してください"})]})]}),e.jsxs("div",{className:"flex items-center p-4 rounded-lg "+(U.readyToPublish?"bg-green-50":"bg-gray-50"),children:[e.jsx("div",{className:"w-6 h-6 rounded-full mr-4 flex items-center justify-center "+(U.readyToPublish?"bg-green-500":"bg-gray-400"),children:U.readyToPublish?e.jsx(h,{className:"w-4 h-4 text-white"}):e.jsx("span",{className:"text-white text-sm",children:"3"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:"公開準備完了"}),e.jsx("p",{className:"text-sm text-gray-600",children:U.readyToPublish?"公開準備が完了しました":"上記の作業を完了してから公開してください"})]})]})]})]}),!U.smartLockTest&&e.jsxs(l,{className:"mb-6 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(g,{className:"w-5 h-5 mr-2"}),"1. スマートロックの動作確認"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"実際にスマートロックを開錠して動作を確認してください。"}),C.length>0?e.jsx("div",{className:"space-y-4",children:C.map(s=>e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:s.lock_name}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:s.location}),e.jsx(i,{lockId:s.lock_id,label:"PINコードを生成してテスト",onSuccess:()=>{I(`${s.lock_name}のテストが完了しました。`),setTimeout(()=>{X()},1e3)},onError:e=>P(`スマートロックのテストに失敗しました: ${e}`)})]},s.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(j,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"このドッグランにはスマートロックが設定されていません。"}),e.jsx(t,{onClick:X,className:"mt-4",children:"スマートロックテストを完了として進む"})]})]}),U.smartLockTest&&!U.pageEditing&&e.jsxs(l,{className:"mb-6 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(u,{className:"w-5 h-5 mr-2"}),"2. 掲載ページの編集"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ドッグランの掲載ページを編集してください。"}),B?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"施設名",value:A.name,onChange:e=>F(s=>({...s,name:e.target.value})),required:!0}),e.jsx(c,{label:"料金（円）",type:"number",value:A.price,onChange:e=>F(s=>({...s,price:Number(e.target.value)})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設の説明"}),e.jsx("textarea",{value:A.description,onChange:e=>F(s=>({...s,description:e.target.value})),rows:4,className:"w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"お客様に向けた施設の魅力を説明してください..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設詳細・利用規約"}),e.jsx("textarea",{value:A.facility_details,onChange:e=>F(s=>({...s,facility_details:e.target.value})),rows:6,className:"w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"施設の詳細情報や利用規約を記入してください..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設画像を追加"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{const s=Array.from(e.target.files||[]);O(s);const a=s.map(e=>URL.createObjectURL(e));z(a)},className:"hidden",id:"park-images"}),e.jsxs("label",{htmlFor:"park-images",className:"cursor-pointer",children:[e.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"クリックして画像を選択"})]})]}),Q.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 md:grid-cols-3 gap-4",children:Q.map((s,a)=>e.jsx("img",{src:s,alt:`プレビュー ${a+1}`,className:"w-full h-24 object-cover rounded-lg border"},a))})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs(t,{onClick:async()=>{try{H(!0);const{error:e}=await r.from("dog_parks").update({name:A.name,description:A.description,facility_details:A.facility_details,price:A.price,status:"ready_to_publish"}).eq("id",w);if(e)throw e;K.length>0&&await Y(),D(e=>({...e,pageEditing:!0,readyToPublish:!0})),I("掲載ページの編集が完了しました。"),R(!1),await V()}catch(e){P("掲載ページの保存に失敗しました。")}finally{H(!1)}},disabled:G,className:"flex-1",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),G?"保存中...":"編集を保存"]}),e.jsxs(t,{variant:"secondary",onClick:()=>{R(!1),O([]),z([])},children:[e.jsx(f,{className:"w-4 h-4 mr-2"}),"キャンセル"]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"現在の掲載内容"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"施設名:"})," ",_.name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"説明:"})," ",_.description||"未設定"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"施設詳細:"})," ",_.facility_details||"未設定"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"料金:"})," ¥",_.price]})]})]}),e.jsxs(t,{onClick:()=>R(!0),children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"編集を開始"]})]})]}),U.readyToPublish&&e.jsxs(l,{className:"mb-6 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(N,{className:"w-5 h-5 mr-2"}),"3. ドッグランを公開"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"すべての準備が完了しました。ドッグランを一般公開してください。"}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg mb-4",children:[e.jsx("h3",{className:"font-medium text-blue-900 mb-2",children:"公開後の流れ"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• ドッグランが一般のユーザーに公開されます"}),e.jsx("li",{children:"• 予約の受付が開始されます"}),e.jsx("li",{children:"• 収益の発生が開始されます"}),e.jsx("li",{children:"• 管理画面で予約状況や収益を確認できます"})]})]}),e.jsxs(t,{onClick:async()=>{if(U.smartLockTest&&U.pageEditing)try{M(!0);const{error:e}=await r.from("dog_parks").update({status:"approved"}).eq("id",w);if(e)throw e;await r.from("admin_notifications").insert([{type:"park_published",title:"ドッグラン公開",message:`${_?.name}が公開されました。`,data:{park_id:w}}]),I("ドッグランが公開されました！"),setTimeout(()=>{v(`/parks/${w}/manage`)},2e3)}catch(e){P("ドッグランの公開に失敗しました。")}finally{M(!1)}else P("すべてのタスクを完了してから公開してください。")},disabled:J,className:"w-full bg-green-600 hover:bg-green-700",children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),J?"公開中...":"ドッグランを公開する"]})]})]}):e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsxs(l,{className:"p-8 text-center",children:[e.jsx(m,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"ドッグランが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"指定されたドッグランが見つからないか、アクセス権限がありません。"}),e.jsx(t,{onClick:()=>v("/owner-dashboard"),children:"ダッシュボードに戻る"})]})})}export{w as ParkPublishingSetup};
