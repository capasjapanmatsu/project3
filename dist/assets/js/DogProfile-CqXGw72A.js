import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{d as a,a as t,u as r,L as i}from"./router-Cg6wfOY4.js";import{B as l}from"./Button-DiksLhRM.js";import{u as c,s as d,C as n}from"./index-DWDIgw5z.js";import{P as o,af as m,a4 as x,y as h,t as g,k as j,M as f}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function u(){const{id:u,dogId:p}=a(),{user:N}=c(),y=t(),w=r(),[v,b]=s.useState(null),[_,q]=s.useState(!0),[k,S]=s.useState(""),[D,$]=s.useState(""),[T,C]=s.useState(!1),[E,L]=s.useState(!1),[M,B]=s.useState([]),[F,P]=s.useState(!1),[Y,I]=s.useState(0),[J,O]=s.useState(!1),z=u||p;s.useEffect(()=>{z&&(A(),N&&(G(),H()))},[z,N]);const A=async()=>{try{q(!0),S("");const{data:e,error:s}=await d.from("dogs").select("*").eq("id",z).single();if(s)throw s;b(e),I(e.like_count||0);const{data:a,error:t}=await d.from("reservations").select("\n          *,\n          dog_park:dog_parks(*)\n        ").eq("dog_id",z).eq("status","confirmed");if(t)throw t;const r={};(a||[]).forEach(e=>{const s=e.park_id;e.dog_park&&(r[s]||(r[s]={park:e.dog_park,visits:0}),r[s].visits++)});const i=Object.values(r).sort((e,s)=>s.visits-e.visits).slice(0,3);B(i)}catch(e){S("ワンちゃんの情報を取得できませんでした。")}finally{q(!1)}},G=async()=>{if(N&&z)try{const{data:e}=await d.from("dogs").select("owner_id").eq("id",z).single();if(!e)return;const{data:s,error:a}=await d.from("friend_requests").select("id, status").or(`and(requester_id.eq.${N.id},requested_id.eq.${e.owner_id}),and(requester_id.eq.${e.owner_id},requested_id.eq.${N.id})`).maybeSingle();!a&&s&&L(!0)}catch(e){}},H=async()=>{if(z)try{const{data:e,error:s}=await d.from("dog_likes").select("id").eq("dog_id",z);if(!s&&e&&I(e.length),N){const{data:e,error:s}=await d.from("dog_likes").select("id").eq("user_id",N?.id).eq("dog_id",z).maybeSingle();!s&&e&&P(!0)}}catch(e){}};return _?e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):k||!v?e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsxs(n,{className:"p-8 text-center",children:[e.jsx(o,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"ワンちゃんが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:k||"ワンちゃんの情報が見つかりませんでした。"}),e.jsx(i,{to:"/",children:e.jsxs(l,{variant:"primary",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})})]})}):e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(i,{to:"/",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})}),D&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:D})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(n,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-48 h-48 bg-gray-200 rounded-lg overflow-hidden",children:v.image_url?e.jsx("img",{src:v.image_url,alt:v.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/58997/pexels-photo-58997.jpeg?auto=compress&cs=tinysrgb&w=300"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:e.jsx(o,{className:"w-12 h-12"})})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:[v.name,(K=v.gender,"オス"===K?"くん":"ちゃん")]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsxs("span",{className:"text-lg text-gray-700",children:[(e=>{const s=new Date,a=new Date(e);let t=s.getFullYear()-a.getFullYear();const r=s.getMonth()-a.getMonth();return(r<0||0===r&&s.getDate()<a.getDate())&&t--,t})(v.birth_date),"歳"]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(o,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsx("span",{className:"text-lg text-gray-700",children:v.breed})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(g,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsx("span",{className:"text-lg text-gray-700",children:v.gender})]})]}),e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{className:"w-5 h-5 text-rose-500 fill-rose-500"}),e.jsxs("span",{className:"text-lg font-medium text-gray-700",children:[Y,"件のいいね"]})]}),e.jsxs("button",{onClick:N?async()=>{if(N&&v&&!J){O(!0);try{if(F){const{error:e}=await d.from("dog_likes").delete().eq("user_id",N?.id).eq("dog_id",v.id);if(e)throw e;P(!1),I(e=>e-1),$("いいねを取り消しました")}else{const{error:e}=await d.from("dog_likes").insert({user_id:N.id,dog_id:v.id});if(e)throw e;P(!0),I(e=>e+1),$("いいねしました");try{d.rpc("rpc_award_dog_like",{p_user:N.id,p_dog_id:v.id}).catch(console.warn)}catch{}}setTimeout(()=>$(""),2e3)}catch(e){S("いいねの処理に失敗しました"),setTimeout(()=>S(""),3e3)}finally{O(!1)}}}:()=>y("/liff/login?redirect="+w.pathname),disabled:J,className:`px-6 py-3 rounded-lg font-medium shadow-md transition-all transform hover:scale-105 flex items-center ${F?"bg-rose-500 hover:bg-rose-600 text-white":"bg-white hover:bg-rose-50 text-rose-500 border-2 border-rose-400"} ${J?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx(g,{className:"w-5 h-5 mr-2 "+(F?"fill-current":"")}),e.jsx("span",{className:"font-semibold",children:F?"いいね済み":"いいね"})]})]})}),N&&v.owner_id!==N.id&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[e.jsx("div",{className:"text-center",children:E?e.jsxs("div",{className:"flex items-center justify-center text-green-600",children:[e.jsx(x,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:"友達申請済み"})]}):e.jsxs(l,{onClick:async()=>{if(N&&v){C(!0);try{const{error:e}=await d.from("friend_requests").insert({requester_id:N.id,requested_id:v.owner_id,message:"ドッグランでお会いした際は、よろしくお願いします！"});if(e)throw e;L(!0),$("友達申請を送信しました"),setTimeout(()=>$(""),3e3)}catch(e){S("友達申請の送信に失敗しました"),setTimeout(()=>S(""),3e3)}finally{C(!1)}}},isLoading:T,className:"px-8 py-3",children:[e.jsx(j,{className:"w-5 h-5 mr-2"}),"友達申請を送る"]})}),e.jsx("div",{className:"mt-4 p-4 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"友達申請について"}),e.jsx("p",{children:"友達申請を送ると、相手の飼い主さんに通知が届きます。 承認されると、メッセージのやり取りができるようになります。"})]})})]})]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(n,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-4 flex items-center",children:[e.jsx(f,{className:"w-5 h-5 text-green-600 mr-2"}),"よく遊ぶドッグラン"]}),M.length>0?e.jsx("div",{className:"space-y-3",children:M.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-900",children:s.park.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.visits,"回利用"]})]}),e.jsx("div",{className:"text-2xl",children:0===a?"🥇":1===a?"🥈":"🥉"})]},s.park.id))}):e.jsx("p",{className:"text-gray-500",children:"まだドッグランの利用履歴がありません"})]}),e.jsxs(n,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"登録日"}),e.jsx("p",{className:"text-gray-700",children:new Date(v.created_at).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})})]})]})]})]});var K}export{u as DogProfile,u as default};
