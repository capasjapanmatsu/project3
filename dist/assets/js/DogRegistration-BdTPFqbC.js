import{j as e}from"./motion-CuO0nkIV.js";import{r}from"./react-vendor-cniURDpR.js";import{a,L as s}from"./router-Cg6wfOY4.js";import{B as t}from"./Button-Bq1kOCic.js";import{u as i,S as l,C as n,s as o,l as c}from"./index-DcAUXhuw.js";import{I as d}from"./ImageCropper-BaK2vU6_.js";import{I as m}from"./Input-rtfXcnE2.js";import{S as b}from"./Select-Dd_IZFKg.js";import{d as u}from"./dogBreeds-6lxY8Uni.js";import{n as x}from"./notification-BEazPlEb.js";import{u as h}from"./webpConverter-BlYlpTMV.js";import{af as g,X as p,C as f}from"./ui-basic-Kxp_U5Up.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";const j=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}},v=async(e,r,a="mixed")=>{try{const s=r,t=j(e);if(!t.isValid)throw new Error(t.error);const i=`${s}_${a}_${Date.now()}_${e.name}`,l=`${s}/${i}`,n=await h("vaccine-certs",e,l,{quality:80,generateThumbnail:!0,thumbnailSize:300,keepOriginal:!1});if(!n.success)throw new Error(n.error||"アップロードに失敗しました");return{success:!0,publicUrl:n.webpUrl,fileName:i,filePath:n.webpPath,thumbnailUrl:n.thumbnailUrl}}catch(s){return{success:!1,error:s instanceof Error?s.message:"アップロードに失敗しました"}}};function y(){const{user:y,lineUser:w,effectiveUserId:N}=i(),D=a(),[$,I]=r.useState(!1),[C,E]=r.useState(""),[V,S]=r.useState(!1),[_,q]=r.useState(null),[U,k]=r.useState(null),[M,Y]=r.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),B=(new Date).getFullYear(),A=Array.from({length:21},(e,r)=>{const a=B-r;return{value:a.toString(),label:`${a}年`}}),L=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}}),z=async(e,r)=>{const a=e.target.files?.[0];if(a)try{const e=j(a);if(!e.isValid)return void E(e.error||"ファイルが無効です。");Y(e=>({...e,[`${r}VaccineImage`]:a})),E("")}catch(s){E("ファイルの検証中にエラーが発生しました。")}};return e.jsxs(e.Fragment,{children:[e.jsx(l,{title:"ワンちゃん登録",description:"愛犬の情報を登録してドッグランを利用しましょう"}),e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-blue-50 to-white py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(s,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-700 mb-4",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"愛犬の基本情報とワクチン証明書を登録してください"})]}),e.jsx(n,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{e.preventDefault();const r=y?.id||w?.id||N;if(r)if(M.name.trim())if(M.breed)if(M.birthYear&&M.birthMonth&&M.birthDay)if(M.gender)if(_)if(M.rabiesVaccineImage)if(M.comboVaccineImage)if(M.rabiesExpiryDate)if(M.comboExpiryDate){I(!0),E("");try{const e=`dog-profiles/${r}/${Date.now()}_${_.name}`,a=await h("dog-images",_,e,{quality:80,generateThumbnail:!0,thumbnailSize:300,keepOriginal:!1});if(!a.success)throw new Error(`プロフィール画像のアップロードに失敗しました: ${a.error}`);a.webpUrl;let s="",t="";if(M.rabiesVaccineImage){const e=await v(M.rabiesVaccineImage,r,"rabies");if(!e.success)throw new Error(`狂犬病ワクチン証明書のアップロードに失敗しました: ${e.error}`);s=e.publicUrl||""}if(M.comboVaccineImage){const e=await v(M.comboVaccineImage,r,"combo");if(!e.success)throw new Error(`混合ワクチン証明書のアップロードに失敗しました: ${e.error}`);t=e.publicUrl||""}const i=`${M.birthYear}-${M.birthMonth}-${M.birthDay}`,{data:l,error:n}=await o.from("dogs").insert([{owner_id:r,name:M.name.trim(),breed:M.breed,birth_date:i,gender:M.gender,image_url:a.webpUrl}]).select().single();if(n)throw new Error(`ワンちゃんの登録に失敗しました: ${n.message}`);if(s||t){const e={dog_id:l.id,status:"pending"};s&&(e.rabies_vaccine_image=s,e.rabies_expiry_date=M.rabiesExpiryDate),t&&(e.combo_vaccine_image=t,e.combo_expiry_date=M.comboExpiryDate);const{data:r,error:a}=await o.from("vaccine_certifications").insert([e]).select();if(a)throw new Error(`ワクチン証明書の保存に失敗しました: ${a.message}`)}x.success("ワンちゃんの登録が完了しました！"),D("/dashboard")}catch(a){c.error("ワンちゃんの登録でエラーが発生しました",{error:a}),E(a instanceof Error?a.message:"ワンちゃんの登録中にエラーが発生しました。")}finally{I(!1)}}else E("混合ワクチンの有効期限を入力してください。");else E("狂犬病ワクチンの有効期限を入力してください。");else E("混合ワクチン証明書をアップロードしてください。");else E("狂犬病ワクチン証明書をアップロードしてください。");else E("プロフィール画像をアップロードしてください。");else E("性別を選択してください。");else E("生年月日を選択してください。");else E("犬種を選択してください。");else E("ワンちゃんの名前を入力してください。");else E("ログインが必要です。")},className:"space-y-6",children:[C&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("p",{className:"text-red-600 text-sm",children:C})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["プロフィール画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[U?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:U,alt:"プロフィール画像プレビュー",className:"w-24 h-24 rounded-full object-cover border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{q(null),k(null)},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(p,{className:"w-3 h-3"})})]}):e.jsx("div",{className:"w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center",children:e.jsx(f,{className:"w-8 h-8 text-gray-400"})}),e.jsxs(t,{type:"button",variant:"outline",onClick:()=>S(!0),children:[e.jsx(f,{className:"w-4 h-4 mr-2"}),_?"画像を変更":"画像を選択"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"1:1比率で切り取られ、最適化されます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(m,{label:"ワンちゃんの名前",type:"text",value:M.name,onChange:e=>Y(r=>({...r,name:e.target.value})),placeholder:"例: ポチ",required:!0})}),e.jsx("div",{children:e.jsx(b,{label:"犬種",value:M.breed,onChange:e=>Y(r=>({...r,breed:e.target.value})),options:[{value:"",label:"犬種を選択してください"},...u.map(e=>({value:e,label:e}))],required:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["生年月日 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(b,{value:M.birthYear,onChange:e=>{Y(r=>({...r,birthYear:e.target.value,birthDay:""}))},options:[{value:"",label:"年"},...A],required:!0}),e.jsx(b,{value:M.birthMonth,onChange:e=>{Y(r=>({...r,birthMonth:e.target.value,birthDay:""}))},options:[{value:"",label:"月"},...L],required:!0}),e.jsx(b,{value:M.birthDay,onChange:e=>Y(r=>({...r,birthDay:e.target.value})),options:[{value:"",label:"日"},...(()=>{if(!M.birthYear||!M.birthMonth)return[];const e=parseInt(M.birthYear),r=parseInt(M.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}})})()],required:!0,disabled:!M.birthYear||!M.birthMonth})]})]}),e.jsx("div",{children:e.jsx(b,{label:"性別",value:M.gender,onChange:e=>Y(r=>({...r,gender:e.target.value})),options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],required:!0})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"ワクチン証明書"}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>z(e,"rabies"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),M.rabiesVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",M.rabiesVaccineImage.name]})]}),e.jsx(m,{label:"有効期限",type:"date",value:M.rabiesExpiryDate,onChange:e=>Y(r=>({...r,rabiesExpiryDate:e.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>z(e,"combo"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),M.comboVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",M.comboVaccineImage.name]})]}),e.jsx(m,{label:"有効期限",type:"date",value:M.comboExpiryDate,onChange:e=>Y(r=>({...r,comboExpiryDate:e.target.value})),required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(s,{to:"/dashboard",children:e.jsx(t,{type:"button",variant:"outline",children:"キャンセル"})}),e.jsx(t,{type:"submit",disabled:$,className:"min-w-[120px]",children:$?"登録中...":"ワンちゃんを登録"})]})]})})]})}),V&&e.jsx(d,{onCropComplete:e=>{q(e);const r=URL.createObjectURL(e);k(r),S(!1),E("")},onCancel:()=>S(!1),aspectRatio:1,maxWidth:400,maxHeight:400})]})}export{y as DogRegistration};
