import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{a as t,L as a}from"./router-DXQOdrLL.js";import{u as r,s as n,B as l}from"./index-C3FXbeFZ.js";import{C as i}from"./Card-DqVnP9TA.js";import{I as c}from"./Input-2E2l4WcX.js";import{_ as d,C as o,o as x,aE as m,aX as p,w as u,D as h,r as g,t as j,aY as f,q as _,x as y}from"./ui-basic-C77EGLVg.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function N(){const{isAdmin:N}=r(),v=t(),[w,b]=s.useState([]),[k,S]=s.useState(null),[D,L]=s.useState(!0),[C,U]=s.useState(""),[$,T]=s.useState(""),[q,P]=s.useState("all"),[V,E]=s.useState(""),[M,B]=s.useState("reservation_date"),[I,A]=s.useState("desc"),J=s.useDeferredValue($),z=s.useDeferredValue(q),F=s.useDeferredValue(V),O=s.useDeferredValue(M),R=s.useDeferredValue(I);s.useEffect(()=>{N?(Y(),G()):v("/")},[N,v]);const X=s.useMemo(()=>{let e=[...w];if(J&&(e=e.filter(e=>e.user_name.toLowerCase().includes(J.toLowerCase())||e.user_email.toLowerCase().includes(J.toLowerCase())||e.park_name.toLowerCase().includes(J.toLowerCase()))),"all"!==z&&(e=e.filter(e=>e.status===z)),F){const s=new Date(F);e=e.filter(e=>new Date(e.reservation_date).toDateString()===s.toDateString())}return e.sort((e,s)=>{let t=e[O],a=s[O];return"reservation_date"!==O&&"created_at"!==O||(t=new Date(t).getTime(),a=new Date(a).getTime()),"asc"===R?t>a?1:-1:t<a?1:-1}),e},[w,J,z,F,O,R]),Y=async()=>{try{L(!0),U("");const{data:s,error:t}=await n.from("reservations").select("\n          id,\n          user_id,\n          park_id,\n          dog_id,\n          date,\n          start_time,\n          duration,\n          status,\n          total_amount,\n          reservation_type,\n          created_at,\n          updated_at\n        ").order("created_at",{ascending:!1});if(t)throw new Error("予約情報の取得に失敗しました");if(!s||0===s.length)return void b([]);let a=null;try{const{data:e,error:s}=await n.auth.admin.listUsers();s||(a=e)}catch(e){}const r=s.map(async e=>{try{const{data:t}=await n.from("profiles").select("name, user_type").eq("id",e.user_id).single(),{data:r}=await n.from("dog_parks").select("name, address").eq("id",e.park_id).single(),{data:l}=await n.from("dogs").select("name, breed").eq("id",e.dog_id).single();let i=null;try{const{data:s}=await n.from("stripe_subscriptions").select("status").eq("user_id",e.user_id).eq("status","active").maybeSingle();i=s}catch(s){}const c=a?.users?.find(s=>s.id===e.user_id),d=c?.email;return{id:e.id,user_name:t?.name||"Unknown",user_email:d||`user_${e.user_id.slice(0,8)}@unknown.com`,park_id:e.park_id,park_name:r?.name||"Unknown Park",park_address:r?.address||"Unknown Address",dog_name:l?.name||"Unknown Dog",dog_breed:l?.breed||"Unknown Breed",dog_count:1,reservation_date:e.date,start_time:e.start_time,duration:e.duration||1,total_price:e.total_amount||0,status:e.status,reservation_type:e.reservation_type,is_subscription:!!i,payment_status:e.total_amount>0?"paid":"pending",created_at:e.created_at,updated_at:e.updated_at}}catch(t){return{id:e.id,user_name:"Unknown",user_email:`user_${e.user_id.slice(0,8)}@unknown.com`,park_id:e.park_id,park_name:"Unknown Park",park_address:"Unknown Address",dog_name:"Unknown Dog",dog_breed:"Unknown Breed",dog_count:1,reservation_date:e.date,start_time:e.start_time,duration:e.duration||1,total_price:e.total_amount||0,status:e.status,reservation_type:e.reservation_type,is_subscription:!1,payment_status:"pending",created_at:e.created_at,updated_at:e.updated_at}}}),l=await Promise.all(r);b(l)}catch(s){U(`予約データの取得に失敗しました: ${s instanceof Error?s.message:"不明なエラー"}`)}finally{L(!1)}},G=async()=>{try{const{data:e,error:s}=await n.rpc("get_admin_reservation_stats");if(s)throw s;S(e)}catch(e){}},H=e=>({confirmed:"確定",cancelled:"キャンセル",completed:"完了"}[e]||e),K=e=>({pending:"未払い",paid:"支払済み",refunded:"返金済み"}[e]||e),Q=s=>{const t={confirmed:{color:"bg-green-100 text-green-800",icon:j},cancelled:{color:"bg-red-100 text-red-800",icon:f},completed:{color:"bg-blue-100 text-blue-800",icon:j}},a=t[s]||t.confirmed,r=a.icon;return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(r,{className:"w-4 h-4"}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${a.color}`,children:H(s)})]})},W=s=>{const t={pending:{color:"bg-yellow-100 text-yellow-800",icon:y},paid:{color:"bg-green-100 text-green-800",icon:j},refunded:{color:"bg-gray-100 text-gray-800",icon:_}},a=t[s]||t.pending,r=a.icon;return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(r,{className:"w-4 h-4"}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${a.color}`,children:K(s)})]})};if(D)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"})});const Z=X.reduce((e,s)=>e+s.total_price,0),ee=X.length>0?Z/X.length:0,se=X.filter(e=>e.is_subscription).length,te=w.length>0?w.filter(e=>"cancelled"===e.status).length/w.length*100:0;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(a,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(o,{className:"w-8 h-8 text-purple-600 mr-3"}),"予約管理"]}),e.jsx("p",{className:"text-gray-600",children:"予約の詳細情報と統計分析"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["総予約数: ",w.length,"件"]})]}),C&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:C}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(i,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"総予約数"}),e.jsx("p",{className:"text-xl font-bold text-purple-600",children:w.length})]}),e.jsx(o,{className:"w-6 h-6 text-purple-600"})]})}),e.jsx(i,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"サブスク予約"}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:se}),e.jsxs("p",{className:"text-xs text-gray-500",children:[w.length>0?Math.round(se/w.length*100):0,"%"]})]}),e.jsx(x,{className:"w-6 h-6 text-blue-600"})]})}),e.jsx(i,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均単価"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",Math.round(ee).toLocaleString()]})]}),e.jsx(m,{className:"w-6 h-6 text-green-600"})]})}),e.jsx(i,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"キャンセル率"}),e.jsxs("p",{className:"text-xl font-bold text-orange-600",children:[te.toFixed(1),"%"]})]}),e.jsx(p,{className:"w-6 h-6 text-orange-600"})]})})]}),k&&k.daily_stats.length>0&&e.jsxs(i,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"日別予約統計（直近30日）"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均日次予約数"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:Math.round(k.daily_stats.reduce((e,s)=>e+s.count,0)/k.daily_stats.length)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均日次売上"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",Math.round(k.daily_stats.reduce((e,s)=>e+s.revenue,0)/k.daily_stats.length).toLocaleString()]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均キャンセル率"}),e.jsxs("p",{className:"text-2xl font-bold text-orange-600",children:[(k.daily_stats.reduce((e,s)=>e+s.cancellation_rate,0)/k.daily_stats.length).toFixed(1),"%"]})]})]})]}),k&&k.top_parks.length>0&&e.jsxs(i,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"人気ドッグランランキング"}),e.jsx("div",{className:"space-y-3",children:k.top_parks.slice(0,5).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold "+(0===t?"bg-yellow-500":1===t?"bg-gray-400":2===t?"bg-orange-600":"bg-blue-500"),children:t+1}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.park_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.reservation_count,"件の予約"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-green-600",children:["¥",s.revenue.toLocaleString()]}),e.jsx("p",{className:"text-sm text-gray-600",children:"売上"})]})]},s.park_name))})]}),e.jsxs(i,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(c,{label:"検索",placeholder:"ユーザー名、メール、ドッグラン名で検索...",value:$,onChange:e=>{return t=e.target.value,T(t),void s.startTransition(()=>{});var t},icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),e.jsxs("select",{value:q,onChange:e=>{return t=e.target.value,void s.startTransition(()=>{P(t)});var t},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"confirmed",children:"確定"}),e.jsx("option",{value:"cancelled",children:"キャンセル"}),e.jsx("option",{value:"completed",children:"完了"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"予約日"}),e.jsx("input",{type:"date",value:V,onChange:e=>{return t=e.target.value,void s.startTransition(()=>{E(t)});var t},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),e.jsxs("select",{value:`${M}-${I}`,onChange:e=>{const[t,a]=e.target.value.split("-");var r;r=t,s.startTransition(()=>{B(r)}),(e=>{s.startTransition(()=>{A(e)})})(a)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"reservation_date-desc",children:"予約日（新しい順）"}),e.jsx("option",{value:"reservation_date-asc",children:"予約日（古い順）"}),e.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),e.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),e.jsx("option",{value:"total_price-desc",children:"料金（高い順）"}),e.jsx("option",{value:"total_price-asc",children:"料金（低い順）"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[X.length,"件の予約が見つかりました",X.length>0&&e.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",Z.toLocaleString(),"）"]})]}),e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{const e=[["予約ID","ユーザー名","メール","ドッグラン","予約日","開始時間","時間","料金","ステータス","支払状況","登録日"],...X.map(e=>[e.id,e.user_name,e.user_email,e.park_name,new Date(e.reservation_date).toLocaleDateString("ja-JP"),`${e.start_time}:00`,`${e.duration}時間`,`¥${e.total_price.toLocaleString()}`,H(e.status),K(e.payment_status),new Date(e.created_at).toLocaleDateString("ja-JP")])].map(e=>e.join(",")).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a");t.href=URL.createObjectURL(s),t.download=`reservations_${(new Date).toISOString().split("T")[0]}.csv`,t.click()},children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),e.jsx(i,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"予約日時"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"料金"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"支払状況"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:X.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.user_name}),s.is_subscription&&e.jsx(x,{className:"w-4 h-4 text-purple-600 ml-2"})]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.user_email}),e.jsxs("div",{className:"text-xs text-gray-400",children:["犬: ",s.dog_count,"匹"]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.park_name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("div",{className:"text-gray-900",children:new Date(s.reservation_date).toLocaleDateString("ja-JP")}),e.jsxs("div",{className:"text-gray-500",children:[s.start_time,":00 (",s.duration,"時間)"]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",s.total_price.toLocaleString()]}),s.is_subscription&&e.jsx("div",{className:"text-xs text-purple-600",children:"サブスク割引適用"})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:Q(s.status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:W(s.payment_status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx(l,{size:"sm",variant:"secondary",onClick:()=>v(`/parks/${s.park_id}`),children:e.jsx(g,{className:"w-4 h-4"})})})})]},s.id))})]})})})]})}export{N as AdminReservationManagement};
