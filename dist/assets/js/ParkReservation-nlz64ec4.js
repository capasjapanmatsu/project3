import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{B as t}from"./Button-Bq1kOCic.js";import{C as a,u as r,a as l,s as i}from"./index-DcAUXhuw.js";import{I as n}from"./Input-rtfXcnE2.js";import{V as c,g as d}from"./VaccineBadge-ZTVmxLHB.js";import{M as o,aR as m,ap as x,a4 as p,P as h,y as j,F as u,O as g,N as b,i as y,ao as N,K as f,X as v}from"./ui-basic-Kxp_U5Up.js";import{u as w}from"./useStripe-AaYka8xN.js";import{p as T}from"./stripe-config-CouKGnnS.js";import{d as S,a as _}from"./router-Cg6wfOY4.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";import"./external-api-CcgPsVUa.js";function D({park:s,error:r,formData:l,setFormData:i,timeSlots:f,isDateTooSoon:v,selectedDogs:w,dogs:T,handleDogSelection:S,handleTimeSlotSelect:_,getEndTime:D,getSlotStatus:F,getSelectedDogNames:I,calculateDayPassPrice:P,calculateTotalPrice:k,hasSubscription:$,handleSubmit:O,isLoading:C,checkoutLoading:A,MAX_DOGS:L}){return e.jsxs(a,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(o,{className:"w-5 h-5 text-gray-500"}),e.jsx("p",{className:"text-gray-600",children:s.address})]}),e.jsx("p",{className:"text-gray-600 mb-4",children:s.description}),e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(m,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"font-semibold text-blue-900",children:"料金体系"})]}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 1Dayパス: ¥800（入場時から24時間有効）"}),e.jsx("p",{children:"• 2頭目以降: +¥400/頭（半額）"}),e.jsx("p",{children:"• サブスク: 月額¥3,800（3頭まで使い放題）"}),e.jsx("p",{children:"• 施設貸し切り: ¥4,400/時間（サブスク会員20%OFF）"})]})]}),e.jsxs("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(x,{className:"w-5 h-5 text-yellow-600"}),e.jsx("h3",{className:"font-semibold text-yellow-900",children:"施設貸し切りの注意事項"})]}),e.jsxs("div",{className:"text-sm text-yellow-800 space-y-1",children:[e.jsx("p",{children:"• 施設貸し切りは1時間単位で予約可能です"}),e.jsxs("p",{children:["• ",e.jsx("strong",{children:"2日前までの予約が必要です"}),"（当日・翌日の予約不可）"]}),e.jsx("p",{children:"• 貸し切り中は他のお客様は入場できません"}),e.jsx("p",{children:"• 友達にPINコードを共有して一緒に利用できます"})]})]})]}),e.jsxs("form",{onSubmit:O,children:[r&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:r}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",L,"頭）"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[w.length,"/",L,"頭選択中"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:T.map(s=>{const t=w.includes(s.id),a=!t&&w.length>=L;return e.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(t?"border-green-500 bg-green-50":a?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>!a&&S(s.id),children:[t&&e.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:e.jsx(p,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(h,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsxs("h3",{className:"font-semibold",children:[s.name,"ちゃん"]}),e.jsx(c,{status:d(s),size:"sm"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.breed," • ",s.gender]})]})]})]},s.id)})}),w.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),e.jsx("p",{className:"text-sm text-green-800",children:I()}),e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[w.length,"頭が同時入場できます"]})]})]}),e.jsxs("div",{className:("subscription"===l.paymentType?"bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 opacity-60":"bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200")+" rounded-xl p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(j,{className:`w-6 h-6 ${"subscription"===l.paymentType?"text-purple-600":"text-blue-600"} mr-3`}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["subscription"===l.paymentType?"サブスクリプション会員":"利用日を選択してください","subscription"!==l.paymentType&&e.jsx("span",{className:"text-red-500 ml-2 text-sm",children:"※必須"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"subscription"===l.paymentType?"サブスクリプション会員は日付選択不要です。決済完了後すぐに全国のドッグランをご利用いただけます。":"ご希望の利用日を選択してください。本日以降の日付が選択可能です。"})]})]}),"subscription"!==l.paymentType&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative",children:e.jsx(n,{label:"",type:"date",value:l.date,onChange:e=>i({date:e.target.value,selectedTimeSlot:""}),min:(new Date).toISOString().split("T")[0],required:!0})}),!l.date&&e.jsx("div",{className:"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(u,{className:"w-4 h-4 text-yellow-600 mr-2"}),e.jsx("p",{className:"text-sm text-yellow-800",children:"利用日の選択が必要です。日付を選択してから時間を選んでください。"})]})})]}),"subscription"===l.paymentType&&e.jsx("div",{className:"mt-3 p-3 bg-purple-50 border border-purple-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"w-4 h-4 text-purple-600 mr-2"}),e.jsx("p",{className:"text-sm text-purple-800",children:"サブスクリプション加入後は、全国どこのドッグランでも予約なしでご利用いただけます。"})]})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"支払い方法"}),e.jsxs("div",{className:"space-y-4",children:[!$&&e.jsxs("label",{className:"flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors "+("single"===l.paymentType?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:[e.jsx("input",{type:"radio",value:"single",checked:"single"===l.paymentType,onChange:e=>i({paymentType:e.target.value}),className:"form-radio text-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(m,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium",children:"1Dayパス（段階的料金制）"})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"1頭目¥800 + 2頭目以降¥400/頭・入場時から24時間有効"}),w.length>0&&e.jsxs("p",{className:"text-sm text-blue-600 mt-1",children:[w.length,"頭選択中: ¥",P().toLocaleString()]})]})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors "+("subscription"===l.paymentType?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-gray-300"),children:[e.jsx("input",{type:"radio",value:"subscription",checked:"subscription"===l.paymentType,onChange:e=>i({paymentType:e.target.value}),className:"form-radio text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium",children:"サブスクリプション（月額¥3,800）"}),$?e.jsx("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs",children:"ご利用中"}):e.jsx("span",{className:"bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs",children:"未加入"})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"3頭まで使い放題・施設貸し切り20%OFF"}),!$&&e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"※ サブスクリプションに加入していません"})]})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-4 border-2 rounded-lg cursor-pointer transition-colors "+("facility_rental"===l.paymentType?"border-orange-500 bg-orange-50":"border-gray-200 hover:border-gray-300"),children:[e.jsx("input",{type:"radio",value:"facility_rental",checked:"facility_rental"===l.paymentType,onChange:e=>i({paymentType:e.target.value,duration:"1"}),className:"form-radio text-orange-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(b,{className:"w-5 h-5 text-orange-600"}),e.jsx("span",{className:"font-medium",children:"施設貸し切り"}),e.jsxs("span",{className:"bg-orange-200 text-orange-800 px-2 py-1 rounded-full text-xs",children:["1時間¥",$?"3,520":"4,400"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"施設全体を独占利用・人数制限なし・友達にPINコード共有可能"}),$&&e.jsx("p",{className:"text-sm text-purple-700 font-medium mt-1",children:"サブスク会員20%OFF適用済み！"})]})]})]})]}),"facility_rental"===l.paymentType&&l.date&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"利用開始時間を選択してください"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-sm text-gray-700",children:"利用時間:"}),e.jsx("select",{value:l.duration,onChange:e=>i({duration:e.target.value}),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[1,2,3,4].map(s=>e.jsxs("option",{value:s.toString(),children:[s,"時間"]},s))})]})]}),v&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(y,{className:"w-5 h-5 mt-0.5 mr-2 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"施設貸し切りは2日前までの予約が必要です"}),e.jsx("p",{className:"text-sm",children:"2日後以降の日付を選択してください。"})]})]}),e.jsx("div",{className:"grid grid-cols-3 md:grid-cols-4 gap-3",children:f.map(s=>{const t=F(s),a=t.icon,r=l.selectedTimeSlot===s.time,i=s.isWholeFacilityAvailable&&!v,n=parseInt(l.duration);let c=!0;if(i&&n>1){const e=parseInt(s.time.split(":")[0]);for(let s=1;s<n;s++){const t=e+s,a=f.find(e=>parseInt(e.time.split(":")[0])===t);if(!a||!a.isWholeFacilityAvailable){c=!1;break}}}const d=i&&c;return e.jsx("button",{type:"button",onClick:()=>{d&&_(s.time)},disabled:!d,className:"p-3 rounded-lg border-2 transition-all "+(r?"border-orange-500 bg-orange-50":d?"border-gray-200 hover:border-gray-300":"border-gray-200 opacity-50 cursor-not-allowed"),children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.time}),e.jsxs("div",{className:`inline-flex items-center space-x-1 px-2 py-1 rounded-full text-xs mt-1 ${d?t.color:"bg-red-500 text-white"}`,children:[e.jsx(a,{className:"w-3 h-3"}),e.jsx("span",{children:d?t.label:"利用不可"})]}),!d&&i&&!c&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["連続",n,"時間予約不可"]})]})},s.time)})}),l.selectedTimeSlot&&e.jsxs("div",{className:"text-sm mt-3 p-3 rounded-lg bg-orange-50 text-orange-800 border border-orange-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(b,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium",children:["選択時間: ",l.selectedTimeSlot," ～ ",D(l.selectedTimeSlot,l.duration)]})]}),e.jsx("p",{className:"text-xs mt-1 flex items-center",children:"施設貸し切りは1時間単位での利用となります。"})]})]})}),e.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-blue-50 text-blue-700 border border-blue-200",children:[e.jsx("p",{className:"font-medium",children:"予約内容"}),e.jsxs("div",{className:"mt-1 space-y-1",children:[e.jsxs("p",{children:["選択ワンちゃん: ",w.length,"頭"]}),"single"===l.paymentType&&e.jsxs("div",{children:[e.jsxs("p",{children:["1Dayパス料金: ¥",P().toLocaleString(),"（",w.length,"頭・段階的料金）"]}),e.jsx("p",{className:"text-xs",children:"入場時から24時間有効・全国のドッグランで利用可能"})]}),"subscription"===l.paymentType&&e.jsx("div",{children:$?e.jsxs("div",{children:[e.jsx("p",{className:"text-purple-700 font-medium",children:"サブスク会員: 3頭まで使い放題"}),e.jsx("p",{className:"text-xs",children:"追加料金なし・全国のドッグランで利用可能"})]}):e.jsxs("div",{children:[e.jsx("p",{className:"text-orange-700 font-medium",children:"サブスクリプション申し込み: 月額¥3,800"}),e.jsx("p",{className:"text-xs",children:"申し込み後、3頭まで使い放題・全国のドッグランで利用可能"})]})}),"facility_rental"===l.paymentType&&e.jsxs("div",{children:[e.jsxs("p",{children:["施設貸し切り料金: ¥",k().toLocaleString()]}),e.jsxs("p",{className:"text-xs",children:[l.duration,"時間利用・施設全体独占・友達にPINコード共有可能"]}),$&&e.jsx("p",{className:"text-purple-700 font-medium text-xs",children:"サブスク会員20%OFF適用済み"})]}),e.jsx("div",{className:"border-t border-blue-300 pt-2 mt-2",children:e.jsxs("p",{className:"font-bold",children:["合計料金: ¥",k().toLocaleString()]})})]}),e.jsxs("p",{className:"text-sm mt-2 flex items-center",children:[e.jsx(N,{className:"w-3 h-3 mr-1"}),"決済完了後、入場用PINコードが発行されます"]})]}),e.jsxs(t,{type:"submit",isLoading:C||A,className:"w-full mt-4 bg-blue-600 hover:bg-blue-700",disabled:0===w.length||"facility_rental"===l.paymentType&&(!l.selectedTimeSlot||v),children:["subscription"!==l.paymentType||$?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),$&&"subscription"===l.paymentType?"PINコードを発行する":"決済に進む"]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"サブスクリプションに加入する"]}),w.length>0&&e.jsxs("span",{className:"ml-2 bg-blue-500 text-white px-2 py-1 rounded-full text-sm",children:[w.length,"頭・¥",k().toLocaleString()]})]})]})]})}function F({hasSubscription:s}){return e.jsxs("div",{className:"space-y-6",children:[s?e.jsxs(a,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(g,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsx("p",{children:"• 3頭まで使い放題"}),e.jsx("p",{children:"• 施設貸し切り20%OFF"}),e.jsx("p",{children:"• ペットショップ10%OFF"})]})]}):e.jsxs(a,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(g,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスクリプションがお得！"})]}),e.jsxs("div",{className:"text-sm space-y-1 mb-3",children:[e.jsx("p",{children:"• 月額¥3,800で3頭まで使い放題"}),e.jsx("p",{children:"• 施設貸し切り20%OFF"}),e.jsx("p",{children:"• ペットショップ10%OFF"}),e.jsx("p",{children:"• 全国のドッグランで利用可能"})]}),e.jsx("p",{className:"text-xs",children:"サブスクリプションを選択して決済ページで申し込みできます"})]}),e.jsxs(a,{className:"p-4 bg-blue-50 border-blue-200",children:[e.jsxs("h3",{className:"font-semibold text-blue-900 mb-2 flex items-center",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"料金体系"]}),e.jsxs("div",{className:"space-y-2 text-sm text-blue-800",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"1Dayパス（段階的料金制）"}),e.jsxs("div",{className:"ml-2 space-y-1",children:[e.jsx("p",{children:"• 1頭目: ¥800"}),e.jsx("p",{children:"• 2頭目: +¥400"}),e.jsx("p",{children:"• 3頭目: +¥400"}),e.jsx("p",{className:"font-medium",children:"3頭合計: ¥1,600"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"サブスク: 月額¥3,800"}),e.jsx("p",{className:"ml-2",children:"3頭まで使い放題"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(b,{className:"w-3 h-3 mr-1"}),"施設貸し切り"]}),e.jsxs("div",{className:"ml-2 space-y-1",children:[e.jsx("p",{children:"• 通常: ¥4,400/1時間"}),e.jsx("p",{className:"text-purple-700 font-medium",children:"• サブスク: ¥3,520/1時間（20%OFF）"}),e.jsx("p",{children:"• 1時間単位で予約可能"}),e.jsxs("p",{children:["• ",e.jsx("strong",{children:"2日前までの予約が必要"})]})]})]})]})]}),e.jsxs(a,{className:"p-4 bg-green-50 border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(N,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"決済について"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-green-800",children:[e.jsx("p",{children:"• 安全なクレジットカード決済"}),e.jsx("p",{children:"• 決済完了後、即座にPINコード発行"}),e.jsx("p",{children:"• 入場時から24時間有効（1Dayパスの場合）"}),e.jsx("p",{children:"• 全国のドッグランで利用可能"}),e.jsx("p",{children:"• 最大3頭まで同時入場"})]})]}),e.jsxs(a,{className:"p-4 bg-green-50 border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(m,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"1Dayパスの特徴"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-green-800",children:[e.jsx("p",{children:"• 入場時から24時間有効"}),e.jsx("p",{children:"• 最大3頭まで同時入場可能"}),e.jsx("p",{children:"• 段階的料金制でお得"}),e.jsx("p",{children:"• 全国のドッグランで利用可能"}),e.jsx("p",{className:"text-red-600 font-medium",children:"• 施設貸し切り中は入場できません"})]})]}),e.jsxs(a,{className:"p-4 bg-orange-50 border-orange-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(b,{className:"w-5 h-5 text-orange-600"}),e.jsx("h3",{className:"font-semibold text-orange-900",children:"施設貸し切り特典"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-orange-800",children:[e.jsx("p",{children:"• 施設全体を独占利用"}),e.jsx("p",{children:"• 人数制限なし"}),e.jsx("p",{children:"• 1時間単位での利用"}),e.jsx("p",{children:"• 最大3頭まで同時入場"}),e.jsx("p",{children:"• 友達にPINコード共有可能"}),e.jsx("p",{children:"• 他の利用者を一切気にせず自由に遊べます"}),e.jsx("p",{children:"• 大型犬・小型犬エリア両方利用可能"}),e.jsx("p",{className:"text-purple-700 font-medium",children:"• サブスク会員は20%OFF！"}),e.jsxs("p",{className:"text-red-600 font-medium",children:["• ",e.jsx("strong",{children:"2日前までの予約が必要"})]})]})]}),e.jsxs(a,{className:"p-4 bg-yellow-50 border-yellow-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(h,{className:"w-5 h-5 text-yellow-600"}),e.jsx("h3",{className:"font-semibold text-yellow-900",children:"入場時の犬選択"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-yellow-800",children:[e.jsx("p",{children:"• 最大3頭まで選択可能"}),e.jsx("p",{children:"• 選択した犬のみ入場可能"}),e.jsx("p",{children:"• 全ての犬のワクチン証明書が必要"}),e.jsx("p",{children:"• 後から犬の変更はできません"})]})]}),e.jsxs(a,{className:"p-4 bg-green-50 border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(f,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-900",children:"決済完了後の流れ"})]}),e.jsxs("div",{className:"text-xs text-green-800 space-y-1",children:[e.jsx("p",{children:"1. 決済完了と同時に入場用PINコードが発行されます"}),e.jsx("p",{children:"2. マイページの「入退場」からPINコードを確認"}),e.jsx("p",{children:"3. 予約日時にドッグラン入口でPINコードを入力"}),e.jsx("p",{children:"4. 選択した全ての犬と一緒に入場できます"}),e.jsx("p",{className:"text-orange-700 font-medium",children:"5. 施設貸し切りの場合、友達にPINコードを共有可能！"})]})]})]})}function I(){const{id:n}=S(),c=_(),{user:d,effectiveUserId:o}=r(),{isActive:m}=l(),{createCheckoutSession:x,loading:p}=w(),[h,j]=s.useState(!1),[u,g]=s.useState(""),[y,N]=s.useState([]),[f,I]=s.useState(null),[P,k]=s.useState([]),[$,O]=s.useState([]),[C,A]=s.useState([]),[L,E]=s.useState({date:"",selectedTimeSlot:"",duration:"1",reservationType:"whole_facility",paymentType:"single"}),q=e=>{E(s=>({...s,...e}))},[M,U]=s.useState(!1),W=s.useMemo(()=>{const e=[];for(let s=6;s<=21;s++){const t=`${s.toString().padStart(2,"0")}:00`;e.push({time:t,available:!0,reservationCount:0,maxCapacity:f?.max_capacity||10,isPrivateBoothAvailable:!0,isWholeFacilityAvailable:!0})}return e},[f?.max_capacity]);s.useEffect(()=>{d||o?n?async function(){const e=d?.id||o;if(e&&n)try{const[s,t]=await Promise.all([i.from("dogs").select("\n              *,\n              vaccine_certifications(*)\n            ").eq("owner_id",e),i.from("dog_parks").select("*").eq("id",n).single()]);if(s.error)throw s.error;if(t.error)throw t.error;const a=(s.data||[]).filter(e=>e.vaccine_certifications&&e.vaccine_certifications.some(e=>"approved"===e.status));N(a),I(t.data)}catch(s){g("データの取得に失敗しました。ページを再読み込みしてください。")}}():g("施設IDが取得できませんでした。"):c("/liff/login")},[d,n,c]),s.useEffect(()=>{m&&"single"===L.paymentType&&q({paymentType:"subscription"})},[m]),s.useEffect(()=>{L.date&&f&&B()},[L.date,f]),s.useEffect(()=>{if(L.date){const e=new Date(L.date),s=new Date;s.setHours(0,0,0,0);const t=new Date(s);t.setDate(s.getDate()+2);const a="facility_rental"===L.paymentType&&e<t;U(a),g(a?"施設貸し切りは2日前までの予約が必要です。":"")}},[L.date,L.paymentType]);const B=async()=>{if(L.date&&f)try{const{data:e,error:s}=await i.from("reservations").select("*").eq("park_id",n).eq("date",L.date).eq("status","confirmed");if(s)throw s;O(e||[]),G(e||[])}catch(e){}},G=e=>{const s=[...W];s.forEach(s=>{const t=parseInt(s.time.split(":")[0]);let a=0,r=0,l=0;e.forEach(e=>{const s=parseInt(e.start_time.split(":")[0]),i=s+e.duration;t>=s&&t<i&&("whole_facility"===e.reservation_type||e.total_amount>=4400?l++:"private_booth"===e.reservation_type||5e3===e.total_amount?r++:a++)}),s.reservationCount=a,s.available=a<s.maxCapacity&&0===l,s.isPrivateBoothAvailable=r<(f?.private_booth_count||0)&&0===l,s.isWholeFacilityAvailable=0===a&&0===r&&0===l}),k(s)},H=()=>{const e=parseInt(L.duration);if(m){const s=4400*e;return Math.round(.8*s)}return 4400*e},J=()=>{const e=C.length;return 0===e?0:1===e?800:800+400*(e-1)},V=()=>"subscription"===L.paymentType?m?0:3800:"facility_rental"===L.paymentType?H():J(),X=()=>C.map(e=>{const s=y.find(s=>s.id===e);return s?.name||""}).filter(e=>e).join("、");return f?0===y.length?e.jsxs(a,{className:"max-w-2xl mx-auto text-center py-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ワクチン接種証明書が必要です"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ドッグランを利用するには、ワクチン接種証明書の承認が必要です。 まだ証明書を提出していない場合は、ワンちゃんの登録時に提出してください。"}),e.jsx(t,{onClick:()=>c("/dog-registration"),children:"ワンちゃんを登録する"})]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold text-center mb-8",children:[f.name,"の予約"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(D,{park:f,error:u,formData:L,setFormData:q,timeSlots:P,isDateTooSoon:M,selectedDogs:C,dogs:y,handleDogSelection:e=>{A(s=>s.includes(e)?s.filter(s=>s!==e):s.length>=3?(g("最大3頭まで選択可能です。"),s):(g(""),[...s,e]))},handleTimeSlotSelect:e=>{E(s=>({...s,selectedTimeSlot:e}))},getEndTime:(e,s)=>`${(parseInt(e.split(":")[0])+parseInt(s)).toString().padStart(2,"0")}:00`,getSlotStatus:e=>e.isWholeFacilityAvailable?{label:"施設貸し切り可能",color:"bg-orange-500 text-white hover:bg-orange-600",icon:b}:{label:"利用不可",color:"bg-red-500 text-white cursor-not-allowed",icon:v},getSelectedDogNames:X,calculateDayPassPrice:J,calculateTotalPrice:V,hasSubscription:m,handleSubmit:async e=>{if(e.preventDefault(),d&&f){j(!0),g("");try{if("subscription"!==L.paymentType&&!L.date)return g("利用日を選択してください。"),void j(!1);if("facility_rental"===L.paymentType&&!L.selectedTimeSlot)return g("施設貸し切りの場合は時間を選択してください。"),void j(!1);if(0===C.length)return g("ワンちゃんを1頭以上選択してください。"),void j(!1);if("facility_rental"===L.paymentType){const e=P.find(e=>e.time===L.selectedTimeSlot);if(!e||!e.isWholeFacilityAvailable)return g("選択された時間は施設貸し切りできません。他の予約が入っています。"),void j(!1);const s=new Date(L.date),t=new Date;t.setHours(0,0,0,0);const a=new Date(t);if(a.setDate(t.getDate()+2),s<a)return g("施設貸し切りは2日前までの予約が必要です。"),void j(!1)}const e={parkId:n,parkName:f.name,selectedDogs:C,dogNames:X(),date:L.date,selectedTimeSlot:L.selectedTimeSlot,duration:parseInt(L.duration),paymentType:L.paymentType,totalPrice:V(),reservationType:"facility_rental"===L.paymentType?"whole_facility":"regular"},s=`DP${Date.now()}${Math.floor(1e3*Math.random())}`;if("single"===L.paymentType){const t=T.find(e=>"payment"===e.mode);return t?void(await x({priceId:t.priceId,mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&type=day_pass&order_number=${s}`,cancelUrl:`${window.location.origin}/reservation/${n}?canceled=true`,customParams:{reservation_data:JSON.stringify(e),order_number:s}})):(g("1Dayパス商品が見つかりません。"),void j(!1))}if("subscription"===L.paymentType&&!m){const e=T.find(e=>"subscription"===e.mode);return e?void(await x({priceId:e.priceId,mode:"subscription",successUrl:`${window.location.origin}/payment-confirmation?success=true&type=subscription`,cancelUrl:`${window.location.origin}/reservation/${n}?canceled=true`})):(g("サブスクリプション商品が見つかりません。"),void j(!1))}if("subscription"===L.paymentType&&m)return void c("/access-control");if("facility_rental"===L.paymentType)return void(await x({priceId:"price_placeholder",mode:"payment",successUrl:`${window.location.origin}/payment-confirmation?success=true&order_number=${s}`,cancelUrl:`${window.location.origin}/reservation/${n}`,customAmount:H(),customName:`${f.name} 施設貸し切り ${L.date} ${L.selectedTimeSlot}〜${parseInt(L.selectedTimeSlot)+parseInt(L.duration)}:00`,customParams:{reservation_data:JSON.stringify(e),order_number:s}}));c("/checkout",{state:{reservationData:e}})}catch(s){g(`予約データの準備に失敗しました: ${s.message}`)}finally{j(!1)}}},isLoading:h,checkoutLoading:p,MAX_DOGS:3})}),e.jsx(F,{hasSubscription:m})]})]}):e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})}export{I as ParkReservation};
