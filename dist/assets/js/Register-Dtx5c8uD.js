import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{a,L as r}from"./router-DXQOdrLL.js";import{B as l,s as t}from"./index-DEqNFMxx.js";import{C as i}from"./Card-DqVnP9TA.js";import{I as n}from"./Input-BL9Dcu5J.js";import{l as d,f as c}from"./postalCodeLookup-BVBMVLy5.js";import{s as m}from"./safeStorage-B_ZrVCeK.js";import{b as o,q as x,a as u,M as h,L as p,s as j,d as g,p as b}from"./ui-basic-D1oJx_i8.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function N(){const N=a(),[f,v]=s.useState(!1),[y,w]=s.useState(""),[C,k]=s.useState(!1),[T,q]=s.useState(!1),[L,S]=s.useState(""),[$,_]=s.useState(!1),[P,U]=s.useState({email:"",password:"",confirmPassword:"",userType:"user",name:"",postalCode:"",address:"",phoneNumber:""}),D=e=>{const s=e.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:P.phoneNumber},I=async e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:P.postalCode})(e);if(U({...P,postalCode:s}),7===s.replace(/-/g,"").length){q(!0),S("");try{const e=await d(s);if(e.success&&e.results&&e.results.length>0){const s=c(e.results[0]);U(e=>({...e,address:s}))}else S(e.message||"住所が見つかりませんでした")}catch(a){S("住所の検索中にエラーが発生しました")}finally{q(!1)}}};return C?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(i,{className:"text-center p-8",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(o,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"メールを確認してください"}),e.jsxs("p",{className:"text-gray-600 mb-4",children:[P.email,"にログインリンクを送信しました。メールを確認してリンクをクリックしてください。"]}),e.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"メールが届かない場合は、迷惑メールフォルダを確認するか、別のメールアドレスでお試しください。"}),e.jsx(l,{onClick:()=>N("/login"),children:"ログイン画面に戻る"})]})}):e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold text-center mb-8",children:"新規登録"}),e.jsxs(i,{children:[e.jsxs("div",{className:"flex justify-center mb-4 space-x-2",children:[e.jsx(l,{type:"button",onClick:()=>_(!1),variant:$?"secondary":"primary",children:"Magic Link"}),e.jsx(l,{type:"button",onClick:()=>_(!0),variant:$?"primary":"secondary",children:"パスワード"})]}),$?e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),v(!0),w(""),!P.name.trim())return w("お名前を入力してください"),void v(!1);if(!P.postalCode.trim())return w("郵便番号を入力してください"),void v(!1);if(!P.address.trim())return w("住所を入力してください"),void v(!1);if(!P.phoneNumber.trim())return w("電話番号を入力してください"),void v(!1);if(!P.password)return w("パスワードを入力してください"),void v(!1);if(P.password.length<6)return w("パスワードは6文字以上で入力してください"),void v(!1);if(P.password!==P.confirmPassword)return w("パスワードが一致しません"),void v(!1);if(!/^\d{3}-\d{4}$/.test(P.postalCode))return w("郵便番号は7桁の数字で入力してください（例：1234567）"),void v(!1);if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(P.phoneNumber))return w("電話番号は正しい形式で入力してください（例：09012345678）"),void v(!1);try{m("lastUsedEmail",P.email);const{data:e,error:s}=await t.auth.signUp({email:P.email,password:P.password,options:{data:{user_type:P.userType,name:P.name,postal_code:P.postalCode,address:P.address,phone_number:P.phoneNumber}}});if(s)throw s;N("/two-factor-setup")}catch(s){const e=s.message||"";e.includes("already registered")||e.includes("already exists")||e.includes("User already")||e.includes("duplicate key")?w("このメールアドレスは既に登録されています"):w(e||"登録に失敗しました")}finally{v(!1)}},className:"p-6",children:[y&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:e.jsx("p",{children:y})})]}),e.jsx(n,{label:"お名前 *",value:P.name,onChange:e=>U({...P,name:e.target.value}),required:!0,placeholder:"山田太郎",icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(h,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:P.postalCode,onChange:e=>I(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${L?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),T&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(p,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),L&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:L})]}),e.jsx(n,{label:"住所 *",value:P.address,onChange:e=>U({...P,address:e.target.value}),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(h,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"電話番号 *",type:"tel",value:P.phoneNumber,onChange:e=>{const s=D(e.target.value);U({...P,phoneNumber:s})},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"メールアドレス *",type:"email",value:P.email,onChange:e=>U({...P,email:e.target.value}),required:!0,placeholder:"example@email.com",icon:e.jsx(o,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"パスワード *",type:"password",value:P.password,onChange:e=>U({...P,password:e.target.value}),required:!0,placeholder:"6文字以上",helperText:"6文字以上で入力してください",icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"パスワード確認 *",type:"password",value:P.confirmPassword,onChange:e=>U({...P,confirmPassword:e.target.value}),required:!0,placeholder:"パスワードを再入力",helperText:"パスワードを再入力してください",icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"user",checked:"user"===P.userType,onChange:e=>U({...P,userType:e.target.value}),className:"mr-2"}),"利用者"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"owner",checked:"owner"===P.userType,onChange:e=>U({...P,userType:e.target.value}),className:"mr-2"}),"施設オーナー"]})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-green-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"セキュリティ強化"}),e.jsx("p",{children:"パスワード登録後、2ファクタ認証（TOTP）の設定をお勧めします。Google Authenticatorなどの認証アプリでQRコードをスキャンするだけで簡単に設定できます。"})]})]})}),e.jsxs(l,{type:"submit",isLoading:f,className:"w-full",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"登録する"]})]}):e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),v(!0),w(""),!P.name.trim())return w("お名前を入力してください"),void v(!1);if(!P.postalCode.trim())return w("郵便番号を入力してください"),void v(!1);if(!P.address.trim())return w("住所を入力してください"),void v(!1);if(!P.phoneNumber.trim())return w("電話番号を入力してください"),void v(!1);if(!/^\d{3}-\d{4}$/.test(P.postalCode))return w("郵便番号は7桁の数字で入力してください（例：1234567）"),void v(!1);if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(P.phoneNumber))return w("電話番号は正しい形式で入力してください（例：09012345678）"),void v(!1);try{m("lastUsedEmail",P.email);const{error:e}=await t.auth.signInWithOtp({email:P.email,options:{emailRedirectTo:`${window.location.origin}/dashboard`,data:{user_type:P.userType,name:P.name,postal_code:P.postalCode,address:P.address,phone_number:P.phoneNumber}}});if(e)throw e;k(!0)}catch(s){const e=s.message||"";e.includes("already registered")||e.includes("already exists")||e.includes("User already")||e.includes("duplicate key")?w("このメールアドレスは既に登録されています"):w(e||"登録に失敗しました")}finally{v(!1)}},className:"p-6",children:[y&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:e.jsx("p",{children:y})})]}),e.jsx(n,{label:"お名前 *",value:P.name,onChange:e=>U({...P,name:e.target.value}),required:!0,placeholder:"山田太郎",icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(h,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:P.postalCode,onChange:e=>I(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${L?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),T&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(p,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),L&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:L})]}),e.jsx(n,{label:"住所 *",value:P.address,onChange:e=>U({...P,address:e.target.value}),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(h,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"電話番号 *",type:"tel",value:P.phoneNumber,onChange:e=>{const s=D(e.target.value);U({...P,phoneNumber:s})},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"メールアドレス *",type:"email",value:P.email,onChange:e=>U({...P,email:e.target.value}),required:!0,placeholder:"example@email.com",icon:e.jsx(o,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"user",checked:"user"===P.userType,onChange:e=>U({...P,userType:e.target.value}),className:"mr-2"}),"利用者"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"owner",checked:"owner"===P.userType,onChange:e=>U({...P,userType:e.target.value}),className:"mr-2"}),"施設オーナー"]})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(g,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Magic Linkについて"}),e.jsx("p",{children:"登録後、入力したメールアドレスにログイン用のリンクが送信されます。リンクをクリックするだけで簡単にログインできます。"})]})]})}),e.jsxs(l,{type:"submit",isLoading:f,className:"w-full",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"登録する"]})]}),e.jsx("div",{className:"mt-4 text-center p-6",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["すでにアカウントをお持ちの方は",e.jsx(r,{to:"/login",className:"text-blue-600 hover:underline ml-1",children:"こちらからログイン"})]})})]})]})}export{N as Register};
