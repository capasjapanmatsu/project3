import{j as e}from"./motion-CuO0nkIV.js";import{P as s}from"./PremiumPaywall-LF-WI4eS.js";import{u as t}from"./usePremiumOwner-D_dGHt1W.js";import{r as a}from"./react-vendor-cniURDpR.js";import{L as r}from"./router-Cg6wfOY4.js";import{B as n}from"./Button-DiksLhRM.js";import{u as i,s as l,C as d,S as o}from"./index-DWDIgw5z.js";import{C as c}from"./CouponDisplay-BVr2ffLh.js";import{aL as x,af as m,G as u,y as h,M as p,e as g}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function f(){if("active"!==t().state)return e.jsx("div",{className:"max-w-3xl mx-auto p-4",children:e.jsx(s,{})});const{user:f,lineUser:b,effectiveUserId:j}=i(),[y,N]=a.useState([]),[w,v]=a.useState(!0),[_,D]=a.useState("available"),[k,S]=a.useState(""),[C,P]=a.useState(!1),[F,L]=a.useState(null);a.useEffect(()=>{(f||b||j)&&O()},[f,b,j]);const O=async()=>{const e=f?.id||b?.app_user_id||b?.id||j;if(e)try{v(!0);const{data:s,error:t}=await l.from("user_coupons").select("\n          *,\n          coupon:facility_coupons!inner (\n            *,\n            facility:pet_facilities (\n              name,\n              address\n            )\n          )\n        ").eq("user_id",e).order("obtained_at",{ascending:!1});if(t)throw t;N(s||[])}catch(s){S("クーポンの取得に失敗しました。")}finally{v(!1)}},q=e=>e.discount_value||"free_gift"===e.discount_type?"free_gift"===e.discount_type?"🎁 無料プレゼント":"percentage"===e.discount_type?`${e.discount_value}% OFF`:`${e.discount_value?.toLocaleString()}円 OFF`:"",J=s=>{const t=new Date,a=new Date(s.coupon.end_date);return s.is_used?e.jsx("span",{className:"px-3 py-1 text-xs font-bold bg-gray-100 text-gray-700 rounded-full",children:"使用済み"}):a<t?e.jsx("span",{className:"px-3 py-1 text-xs font-bold bg-red-100 text-red-700 rounded-full",children:"期限切れ"}):e.jsx("span",{className:"px-3 py-1 text-xs font-bold bg-green-100 text-green-700 rounded-full",children:"利用可能"})},U=(()=>{const e=new Date;switch(_){case"available":return y.filter(s=>!s.is_used&&new Date(s.coupon.end_date)>=e);case"used":return y.filter(e=>e.is_used);case"expired":return y.filter(s=>!s.is_used&&new Date(s.coupon.end_date)<e);default:return y}})();return f||b||j?e.jsxs(e.Fragment,{children:[e.jsx(o,{title:"マイクーポン - ドッグパークJP",description:"取得したクーポンを管理・利用できます。"}),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100",children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(r,{to:"/dashboard",className:"inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"マイページに戻る"]})}),e.jsx("div",{className:"text-center mb-8",children:e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(x,{className:"w-8 h-8 mr-3 text-pink-500"}),"マイクーポン"]})}),k&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-xl p-4 mb-6",children:k}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border mb-6 overflow-hidden",children:e.jsxs("nav",{className:"flex",children:[e.jsxs("button",{onClick:()=>D("available"),className:"flex-1 py-3 px-4 font-medium text-center transition-all duration-300 "+("available"===_?"bg-green-500 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-50"),children:[e.jsx(u,{className:"w-4 h-4 inline mr-2"}),"利用可能",e.jsx("span",{className:"ml-2 text-xs px-2 py-1 rounded-full font-medium "+("available"===_?"bg-white/20 text-white":"bg-green-100 text-green-700"),children:y.filter(e=>!e.is_used&&new Date(e.coupon.end_date)>=new Date).length})]}),e.jsxs("button",{onClick:()=>D("used"),className:"flex-1 py-3 px-4 font-medium text-center transition-all duration-300 "+("used"===_?"bg-gray-500 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-50"),children:[e.jsx(x,{className:"w-4 h-4 inline mr-2"}),"使用済み",e.jsx("span",{className:"ml-2 text-xs px-2 py-1 rounded-full font-medium "+("used"===_?"bg-white/20 text-white":"bg-gray-100 text-gray-700"),children:y.filter(e=>e.is_used).length})]}),e.jsxs("button",{onClick:()=>D("expired"),className:"flex-1 py-3 px-4 font-medium text-center transition-all duration-300 "+("expired"===_?"bg-red-500 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-50"),children:[e.jsx(h,{className:"w-4 h-4 inline mr-2"}),"期限切れ",e.jsx("span",{className:"ml-2 text-xs px-2 py-1 rounded-full font-medium "+("expired"===_?"bg-white/20 text-white":"bg-red-100 text-red-700"),children:y.filter(e=>!e.is_used&&new Date(e.coupon.end_date)<new Date).length})]})]})}),w?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"クーポンを読み込み中..."})]}):0===U.length?e.jsxs(d,{className:"text-center py-16",children:[e.jsx(x,{className:"w-20 h-20 text-gray-300 mx-auto mb-6"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"保有クーポンがありません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"ワンちゃんと行ける施設でクーポンを取得してみましょう！"}),e.jsx(r,{to:"/parks?view=facilities",children:e.jsx(n,{className:"bg-pink-500 hover:bg-pink-600",children:"施設一覧へ（ワンちゃんと行ける施設）"})})]}):e.jsx("div",{className:"space-y-4",children:U.map(s=>e.jsxs(d,{className:"overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300",children:[e.jsx("div",{className:"bg-gradient-to-r from-pink-50 to-purple-50 px-4 py-3 border-b border-pink-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:s.coupon.title}),J(s)]}),q(s.coupon)&&e.jsx("div",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-2 rounded-full shadow-md",children:e.jsx("span",{className:"text-sm font-bold",children:q(s.coupon)})})]})}),e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-gray-700 mb-3",children:s.coupon.service_content}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg mb-3",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(p,{className:"w-4 h-4 mr-2 text-blue-500"}),e.jsx(r,{to:`/facilities/${s.coupon.facility_id}`,className:"font-medium text-blue-600 hover:text-blue-800 underline text-sm",children:s.coupon.facility?.name})]}),s.coupon.facility?.address&&e.jsx("div",{className:"ml-6 text-xs text-gray-600",children:s.coupon.facility.address})]}),s.coupon.description&&e.jsx("div",{className:"bg-blue-50 p-3 rounded-lg mb-3",children:e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsx("span",{className:"font-medium text-blue-800",children:"詳細説明："}),s.coupon.description]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3 text-xs",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h,{className:"w-3 h-3 mr-1 text-blue-500"}),e.jsxs("span",{className:"text-gray-600",children:["期限: ",new Date(s.coupon.end_date).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{className:"w-3 h-3 mr-1 text-green-500"}),e.jsx("span",{className:"font-medium "+("once"===s.coupon.usage_limit_type?"text-red-600":"text-green-600"),children:"once"===s.coupon.usage_limit_type?"1回限定":"何回でも"})]})]}),"available"===_&&"once"===s.coupon.usage_limit_type&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(g,{className:"w-4 h-4 text-amber-500 mr-2 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-amber-800 text-sm",children:"⚠️ 1回限定"}),e.jsx("div",{className:"text-xs text-amber-700",children:"表示すると消えます。店舗でのみ使用してください。"})]})]})})]}),"available"===_&&e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t",children:e.jsxs(n,{onClick:()=>(e=>{if("once"===e.coupon.usage_limit_type&&!window.confirm("このクーポンは一度開くと二度と表示できません。今すぐ表示しますか？"))return;L(e),P(!0)})(s),className:"w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 shadow-md hover:shadow-lg transition-all duration-300",size:"lg",children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"クーポンを表示"]})})]},s.id))})]}),C&&F&&e.jsx(c,{userCoupon:F,onClose:()=>{P(!1),L(null),O()},onUse:async e=>{try{const{error:s}=await l.from("user_coupons").update({is_used:!0,used_at:(new Date).toISOString()}).eq("qr_code_token",e);if(s)return;await O()}catch(s){}}})]})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs(d,{className:"p-8 text-center max-w-md",children:[e.jsx(x,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"ログインが必要です"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"クーポンを確認するにはログインしてください。"}),e.jsx(r,{to:"/login",children:e.jsx(n,{className:"w-full",children:"ログイン"})})]})})}export{f as MyCoupons};
