import{l as e}from"./external-api-CcgPsVUa.js";import{r as t}from"./react-vendor-cniURDpR.js";import{u as s,s as r}from"./index-Cxr3hxlQ.js";function i(){const{user:i,lineUser:o,effectiveUserId:a}=s(),[n,c]=t.useState(!1),[l,u]=t.useState(null),m=t.useCallback(async()=>{const{data:{user:e}}=await r.auth.getUser();if(!e&&(o||a))try{const e=await fetch("/line/exchange-supabase-session",{method:"POST",credentials:"include"});if(!e.ok)return;const{access_token:t,refresh_token:s}=await e.json();await r.auth.setSession({access_token:t,refresh_token:s})}catch{}},[o,a]);return{createCheckoutSession:t.useCallback(async({priceId:t,mode:s,successUrl:n,cancelUrl:l,customAmount:d,customName:p,customParams:h,cartItems:f,trialPeriodDays:w})=>{c(!0),u(null);try{await m();const c=i?.id||o?.app_user_id||o?.id||a;if(!c)throw new Error("認証が必要です");let u,_;if(i){const{data:{session:e}}=await r.auth.getSession();u=e?.access_token,_=e?.user.email}else if(o){const{data:e}=await r.from("profiles").select("email").eq("id",c).single();_=e?.email||`line_${o.line_user_id}@line.local`,u=`line_user_${c}`}if(!u&&!o)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:c,user_email:_||"",timestamp:Date.now(),return_url:window.location.href,is_line_user:!!o}));const I=n&&l?null:"http://localhost:3000",y={mode:s,success_url:n||`${I}/payment-confirmation?success=true`,cancel_url:l||`${I}/payment-confirmation?canceled=true`};t&&(y.price_id=t),w&&"subscription"===s&&(y.trial_period_days=w),d&&p&&(y.custom_amount=d,y.custom_name=p),f&&f.length>0&&(y.cart_items=f),h&&Object.entries(h).forEach(([e,t])=>{y[e]=t}),o&&(y.user_id=c);const S=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"}`},body:JSON.stringify(y)});if(!S.ok){const e=await S.json();throw new Error(e.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:k,url:j}=await S.json();if(j)return void(window.location.href=j);if(!k)throw new Error("チェックアウトURLが取得できませんでした");{const t="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",s=await e(t);if(!s)throw new Error("Stripeの読み込みに失敗しました");const{error:r}=await s.redirectToCheckout({sessionId:k});if(r)throw r}}catch(_){throw u(_.message||"チェックアウトに失敗しました"),_}finally{c(!1)}},[i,o,a]),loading:n,error:l}}export{i as u};
