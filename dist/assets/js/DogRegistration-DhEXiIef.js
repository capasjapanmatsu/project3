import{j as e}from"./motion-CuO0nkIV.js";import{r}from"./react-vendor-cniURDpR.js";import{a,L as s}from"./router-CiK0M--J.js";import{s as t,u as i,S as l,B as o,l as n}from"./index-C8-ZovGr.js";import{C as c}from"./Card-roTxPFVC.js";import{I as d}from"./ImageCropper-DvQ_zHLa.js";import{I as m}from"./Input-pnFPNpa9.js";import{S as b}from"./Select-Dd_IZFKg.js";import{d as x}from"./dogBreeds-6lxY8Uni.js";import{n as u}from"./notification-BEazPlEb.js";import{Z as h,X as g,a1 as p}from"./ui-basic-DtvVsAeD.js";import"./heavy-features-BIdEME4r.js";import"./supabase-DJQiR77k.js";const f=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}},j=async(e,r,a="mixed")=>{try{const s=r,i=f(e);if(!i.isValid)throw new Error(i.error);const l=`${s}_${a}_${Date.now()}.jpg`,o=`${s}/${l}`,{data:n,error:c}=await t.storage.from("vaccine-certs").upload(o,e,{cacheControl:"3600",upsert:!1,contentType:e.type});if(c)throw c;return{success:!0,publicUrl:t.storage.from("vaccine-certs").getPublicUrl(n.path).data.publicUrl,fileName:l,filePath:n.path}}catch(s){return{success:!1,error:s instanceof Error?s.message:"アップロードに失敗しました"}}};function v(){const{user:v}=i(),y=a(),[N,w]=r.useState(!1),[D,$]=r.useState(""),[C,I]=r.useState(!1),[V,E]=r.useState(null),[_,S]=r.useState(null),[q,k]=r.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),M=(new Date).getFullYear(),U=Array.from({length:21},(e,r)=>{const a=M-r;return{value:a.toString(),label:`${a}年`}}),Y=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}}),A=async(e,r)=>{const a=e.target.files?.[0];if(a)try{const e=f(a);if(!e.isValid)return void $(e.error||"ファイルが無効です。");k(e=>({...e,[`${r}VaccineImage`]:a})),$("")}catch(s){$("ファイルの検証中にエラーが発生しました。")}};return e.jsxs(e.Fragment,{children:[e.jsx(l,{title:"ワンちゃん登録",description:"愛犬の情報を登録してドッグランを利用しましょう"}),e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-blue-50 to-white py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(s,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-700 mb-4",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"愛犬の基本情報とワクチン証明書を登録してください"})]}),e.jsx(c,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),v)if(q.name.trim())if(q.breed)if(q.birthYear&&q.birthMonth&&q.birthDay)if(q.gender)if(V)if(q.rabiesVaccineImage)if(q.comboVaccineImage)if(q.rabiesExpiryDate)if(q.comboExpiryDate){w(!0),$("");try{const e=`dog-profiles/${v.id}/${Date.now()}_${V.name}`,{data:r,error:a}=await t.storage.from("dog-images").upload(e,V,{cacheControl:"3600",upsert:!1});if(a)throw new Error(`プロフィール画像のアップロードに失敗しました: ${a.message}`);const{data:s}=t.storage.from("dog-images").getPublicUrl(e);let i="",l="";if(q.rabiesVaccineImage){const e=await j(q.rabiesVaccineImage,v.id,"rabies");if(!e.success)throw new Error(`狂犬病ワクチン証明書のアップロードに失敗しました: ${e.error}`);i=e.publicUrl||""}if(q.comboVaccineImage){const e=await j(q.comboVaccineImage,v.id,"combo");if(!e.success)throw new Error(`混合ワクチン証明書のアップロードに失敗しました: ${e.error}`);l=e.publicUrl||""}const o=`${q.birthYear}-${q.birthMonth}-${q.birthDay}`,{data:n,error:c}=await t.from("dogs").insert([{owner_id:v.id,name:q.name.trim(),breed:q.breed,birth_date:o,gender:q.gender,image_url:s.publicUrl}]).select().single();if(c)throw new Error(`ワンちゃんの登録に失敗しました: ${c.message}`);if(i||l){const e={dog_id:n.id,status:"pending"};i&&(e.rabies_vaccine_image=i,e.rabies_expiry_date=q.rabiesExpiryDate),l&&(e.combo_vaccine_image=l,e.combo_expiry_date=q.comboExpiryDate);const{data:r,error:a}=await t.from("vaccine_certifications").insert([e]).select();if(a)throw new Error(`ワクチン証明書の保存に失敗しました: ${a.message}`)}u.success("ワンちゃんの登録が完了しました！"),y("/dashboard")}catch(r){n.error("ワンちゃんの登録でエラーが発生しました",{error:r}),$(r instanceof Error?r.message:"ワンちゃんの登録中にエラーが発生しました。")}finally{w(!1)}}else $("混合ワクチンの有効期限を入力してください。");else $("狂犬病ワクチンの有効期限を入力してください。");else $("混合ワクチン証明書をアップロードしてください。");else $("狂犬病ワクチン証明書をアップロードしてください。");else $("プロフィール画像をアップロードしてください。");else $("性別を選択してください。");else $("生年月日を選択してください。");else $("犬種を選択してください。");else $("ワンちゃんの名前を入力してください。");else $("ログインが必要です。")},className:"space-y-6",children:[D&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("p",{className:"text-red-600 text-sm",children:D})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["プロフィール画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[_?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:_,alt:"プロフィール画像プレビュー",className:"w-24 h-24 rounded-full object-cover border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{E(null),S(null)},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(g,{className:"w-3 h-3"})})]}):e.jsx("div",{className:"w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center",children:e.jsx(p,{className:"w-8 h-8 text-gray-400"})}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>I(!0),children:[e.jsx(p,{className:"w-4 h-4 mr-2"}),V?"画像を変更":"画像を選択"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"1:1比率で切り取られ、最適化されます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(m,{label:"ワンちゃんの名前",type:"text",value:q.name,onChange:e=>k(r=>({...r,name:e.target.value})),placeholder:"例: ポチ",required:!0})}),e.jsx("div",{children:e.jsx(b,{label:"犬種",value:q.breed,onChange:e=>k(r=>({...r,breed:e.target.value})),options:[{value:"",label:"犬種を選択してください"},...x.map(e=>({value:e,label:e}))],required:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["生年月日 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(b,{value:q.birthYear,onChange:e=>{k(r=>({...r,birthYear:e.target.value,birthDay:""}))},options:[{value:"",label:"年"},...U],required:!0}),e.jsx(b,{value:q.birthMonth,onChange:e=>{k(r=>({...r,birthMonth:e.target.value,birthDay:""}))},options:[{value:"",label:"月"},...Y],required:!0}),e.jsx(b,{value:q.birthDay,onChange:e=>k(r=>({...r,birthDay:e.target.value})),options:[{value:"",label:"日"},...(()=>{if(!q.birthYear||!q.birthMonth)return[];const e=parseInt(q.birthYear),r=parseInt(q.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}})})()],required:!0,disabled:!q.birthYear||!q.birthMonth})]})]}),e.jsx("div",{children:e.jsx(b,{label:"性別",value:q.gender,onChange:e=>k(r=>({...r,gender:e.target.value})),options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],required:!0})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"ワクチン証明書"}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>A(e,"rabies"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),q.rabiesVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",q.rabiesVaccineImage.name]})]}),e.jsx(m,{label:"有効期限",type:"date",value:q.rabiesExpiryDate,onChange:e=>k(r=>({...r,rabiesExpiryDate:e.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>A(e,"combo"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),q.comboVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",q.comboVaccineImage.name]})]}),e.jsx(m,{label:"有効期限",type:"date",value:q.comboExpiryDate,onChange:e=>k(r=>({...r,comboExpiryDate:e.target.value})),required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(s,{to:"/dashboard",children:e.jsx(o,{type:"button",variant:"outline",children:"キャンセル"})}),e.jsx(o,{type:"submit",disabled:N,className:"min-w-[120px]",children:N?"登録中...":"ワンちゃんを登録"})]})]})})]})}),C&&e.jsx(d,{onCropComplete:e=>{E(e);const r=URL.createObjectURL(e);S(r),I(!1),$("")},onCancel:()=>I(!1),aspectRatio:1,maxWidth:400,maxHeight:400})]})}export{v as DogRegistration};
