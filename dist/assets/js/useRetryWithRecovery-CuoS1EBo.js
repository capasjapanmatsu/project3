import{r as e}from"./react-vendor-cniURDpR.js";const r={maxAttempts:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2,retryableErrors:["network","timeout","server","storage"],autoRetry:!0};function t(t={}){const a={...r,...t},[n,s]=e.useState({attempts:0,isRetrying:!1,lastError:null,nextRetryIn:0}),c=e.useRef(),l=e.useRef(),o=e.useCallback(()=>{c.current&&clearTimeout(c.current),l.current&&clearInterval(l.current),s({attempts:0,isRetrying:!1,lastError:null,nextRetryIn:0})},[]),u=e.useCallback(()=>{c.current&&clearTimeout(c.current),l.current&&clearInterval(l.current),s(e=>({...e,isRetrying:!1,nextRetryIn:0}))},[]),i=e.useCallback(e=>{const r=a.baseDelay*Math.pow(a.backoffFactor,e);return Math.min(r,a.maxDelay)},[a]),y=e.useCallback(e=>{const r=e.message.toLowerCase();return!(!a.retryableErrors.includes("network")||!(r.includes("network")||r.includes("fetch")||r.includes("connection")))||(!(!a.retryableErrors.includes("timeout")||!r.includes("timeout")&&!r.includes("timed out")&&"AbortError"!==e.name)||(!(!a.retryableErrors.includes("server")||!(r.includes("500")||r.includes("502")||r.includes("503")||r.includes("520")))||!(!a.retryableErrors.includes("storage")||!r.includes("storage")&&!r.includes("bucket"))))},[a.retryableErrors]),m=e.useCallback((e,r)=>{let t=Math.ceil(e/1e3);s(e=>({...e,nextRetryIn:t})),l.current=setInterval(()=>{t--,s(e=>({...e,nextRetryIn:t})),t<=0&&(l.current&&clearInterval(l.current),r())},1e3)},[]),b=e.useCallback(async(e,r=0)=>{try{s(e=>({...e,attempts:r,lastError:null}));const t=await e();return o(),t}catch(t){const n=t instanceof Error?t:new Error(String(t));if(s(e=>({...e,lastError:n})),r>=a.maxAttempts-1)throw s(e=>({...e,isRetrying:!1})),n;if(!y(n))throw s(e=>({...e,isRetrying:!1})),n;if(!a.autoRetry)throw s(e=>({...e,isRetrying:!1})),n;const l=i(r);return s(e=>({...e,isRetrying:!0})),new Promise((t,a)=>{m(l,()=>{c.current=setTimeout(()=>{b(e,r+1).then(t).catch(a)},0)})})}},[a,y,i,o,m]);return{execute:e.useCallback(e=>b(e,0),[b]),state:n,reset:o,cancelRetry:u}}const a={api:{maxAttempts:3,baseDelay:1e3,maxDelay:5e3,backoffFactor:1.5,retryableErrors:["network","timeout","server"],autoRetry:!0}};export{a as r,t as u};
