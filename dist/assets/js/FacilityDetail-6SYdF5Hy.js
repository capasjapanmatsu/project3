import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{c as a,a as t,L as l}from"./router-DXQOdrLL.js";import{u as r,s as i,B as n,S as c}from"./index-pfXXv_mo.js";import{C as d}from"./Card-DqVnP9TA.js";import{C as o}from"./CouponDisplay-DLHPjDtM.js";import{Y as x,n as m,M as h,s as g,v as u,J as p,I as j,G as f,C as N,U as y,a3 as w,X as b,Z as v,_}from"./ui-basic-kZxfFvQj.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function S(){const{id:S}=a(),{user:k}=r(),C=t(),[$,D]=s.useState(null),[q,O]=s.useState(!0),[z,E]=s.useState(null),[F,J]=s.useState(!1),[P,I]=s.useState(0),[L,M]=s.useState([]),[T,U]=s.useState(!1),[A,B]=s.useState(null),[G,Y]=s.useState(null),[Z,H]=s.useState([]),[K,Q]=s.useState(null),[R,V]=s.useState(!1),[W,X]=s.useState({rating:5,comment:"",visit_date:(new Date).toISOString().split("T")[0]}),[ee,se]=s.useState([]),[ae,te]=s.useState(""),[le,re]=s.useState(!1);s.useEffect(()=>{S?ie():C("/dog-park-list")},[S,C]);const ie=async()=>{try{O(!0),E(null);const[e,s,a]=await Promise.all([i.from("pet_facilities").select("*").eq("id",S).eq("status","approved").single(),i.from("pet_facility_images").select("id, facility_id, image_url, image_type, display_order, created_at, alt_text").eq("facility_id",S).order("display_order",{ascending:!0}),i.from("facility_coupons").select("*").eq("facility_id",S).eq("is_active",!0).gte("validity_end",(new Date).toISOString()).order("created_at",{ascending:!1})]);if(e.error)throw e.error;if(!e.data)throw new Error("施設が見つかりません");const t={...e.data,images:s.data||[],coupons:a.data||[]};if(D(t),H([]),Q(null),se([]),k&&a.data&&a.data.length>0){const e=a.data.map(e=>e.id),{data:s}=await i.from("user_coupons").select("*").eq("user_id",k.id).in("coupon_id",e);M(s||[])}}catch(e){E(e instanceof Error?e.message:"施設情報の取得に失敗しました")}finally{O(!1)}},ne=async e=>{if(k){Y(e);try{const{data:s,error:a}=await i.rpc("obtain_coupon",{p_coupon_id:e,p_user_id:k.id});if(a)throw new Error(`クーポン取得エラー: ${a.message}`);if("success"===s){await(async()=>{if(k)try{const{data:e,error:s}=await i.from("user_coupons").select("*").eq("user_id",k.id).eq("facility_id",S);s||M(e||[])}catch(a){}})();const s=L.find(s=>s.coupon_id===e);s&&(B(s),U(!0))}else{E({coupon_not_found:"クーポンが見つかりません",coupon_expired:"クーポンの有効期限が切れています",coupon_inactive:"クーポンが利用できません",already_obtained:"すでに取得済みのクーポンです"}[s]||`不明なエラー: ${s}`)}}catch(s){const e=s instanceof Error?s.message:"クーポンの取得に失敗しました";E(e)}finally{Y(null)}}else C("/login")},ce=()=>{if(!$?.weekly_closed_days)return null;try{const e=JSON.parse($.weekly_closed_days);return!e[(new Date).getDay()]}catch{return null}},de=({rating:s,size:a="sm"})=>{const t={sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"};return e.jsx("div",{className:"flex items-center space-x-1",children:[1,2,3,4,5].map(l=>e.jsx(j,{className:`${t[a]} ${l<=s?"text-yellow-400 fill-current":"text-gray-300"}`},l))})};return q?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"施設情報を読み込み中..."})]})}):z?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsx(d,{className:"max-w-md w-full",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"⚠️"}),e.jsx("h1",{className:"text-xl font-bold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-4",children:z}),e.jsxs(n,{onClick:()=>C("/parks"),variant:"outline",children:[e.jsx(x,{className:"mr-2 h-4 w-4"}),"ドッグラン・施設一覧に戻る"]})]})})}):$?e.jsxs(e.Fragment,{children:[e.jsx(c,{title:`${$.name} - ペット関連施設`,description:$.description||`${$.category_info?.name||""}の${$.name}の詳細情報をご覧ください。`}),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsxs("div",{className:"relative bg-white",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 sticky top-0 z-10",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex items-center justify-between h-16",children:e.jsxs("button",{onClick:()=>{window.history.length>1?window.history.back():C("/parks")},className:"flex items-center text-gray-600 hover:text-blue-600 transition-colors",children:[e.jsx(x,{className:"w-5 h-5 mr-2"}),"戻る"]})})})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[$.images&&$.images.length>0&&e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"flex gap-4 overflow-x-auto pb-4 scrollbar-hide",style:{scrollSnapType:"x mandatory"},children:$.images.map((s,a)=>e.jsx("div",{className:"flex-shrink-0 w-[calc(50%-8px)] aspect-[4/3] rounded-2xl overflow-hidden shadow-lg cursor-pointer hover:shadow-xl transition-shadow",style:{scrollSnapAlign:"start"},onClick:()=>{I(a),J(!0)},children:e.jsx("img",{src:s.image_url,alt:s.alt_text||`${$.name}の画像${a+1}`,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-300",onError:e=>{e.target.style.display="none"}})},a))}),e.jsx("div",{className:"flex justify-center mt-4 space-x-2",children:$.images.map((s,a)=>e.jsx("button",{className:"w-2 h-2 rounded-full transition-colors "+(a===P?"bg-blue-500":"bg-gray-300 hover:bg-gray-400"),onClick:()=>{I(a),J(!0)}},a))})]})}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 items-start",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),{pet_hotel:"ペットホテル",pet_salon:"ペットサロン",veterinary:"動物病院",pet_cafe:"ペットカフェ",pet_restaurant:"ペット同伴レストラン",pet_shop:"ペットショップ",pet_accommodation:"ペット同伴宿泊",dog_training:"しつけ教室",pet_friendly_other:"その他ワンちゃん同伴可能施設"}[$.category_info?.name||""]||$.category_info?.name||"ペット関連施設"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-4xl lg:text-5xl font-bold text-gray-900 leading-tight",children:$.name}),e.jsxs("div",{className:"flex items-start text-gray-600",children:[e.jsx(h,{className:"w-5 h-5 mr-2 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-lg",children:$.address})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[$.phone&&e.jsxs("div",{className:"flex items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm",children:[e.jsx(g,{className:"w-5 h-5 text-blue-500 mr-3"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"電話番号"}),e.jsx("p",{className:"font-medium text-gray-900",children:$.phone})]})]}),$.website&&e.jsxs("a",{href:$.website,target:"_blank",rel:"noopener noreferrer",className:"flex items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:border-blue-300 hover:shadow-md transition-all group",children:[e.jsx(u,{className:"w-5 h-5 text-blue-500 mr-3 group-hover:text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ウェブサイト"}),e.jsx("p",{className:"font-medium text-gray-900 group-hover:text-blue-600",children:"公式サイトを見る"})]})]})]}),$.description&&e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"施設について"}),e.jsx("p",{className:"text-gray-700 leading-relaxed whitespace-pre-wrap",children:$.description})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(p,{className:"w-5 h-5 text-blue-500 mr-2"}),"営業時間・定休日"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-900",children:"営業時間"}),e.jsx("span",{className:"text-gray-700",children:$?.opening_time&&$?.closing_time?`${$.opening_time.slice(0,5)} 〜 ${$.closing_time.slice(0,5)}`:"営業時間の情報がありません"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-900",children:"定休日"}),e.jsx("span",{className:"text-gray-700",children:(()=>{if(!$?.weekly_closed_days)return"定休日の情報がありません";try{const e=JSON.parse($.weekly_closed_days),s=["日","月","火","水","木","金","土"],a=e.map((e,a)=>e?s[a]:null).filter(e=>null!==e);return 0===a.length?"年中無休":`${a.join("・")}曜日`}catch{return"定休日の情報がありません"}})()})]}),null!==ce()&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-900",children:"本日の営業"}),e.jsx("span",{className:"font-semibold "+(ce()?"text-green-600":"text-red-600"),children:ce()?"営業中":"定休日"})]})]})]}),K&&e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(j,{className:"w-5 h-5 text-yellow-400 mr-2"}),"評価・レビュー"]}),e.jsxs("div",{className:"flex items-center space-x-4 mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(de,{rating:Math.round(K.average_rating),size:"lg"}),e.jsx("span",{className:"text-2xl font-bold text-gray-900",children:K.average_rating})]}),e.jsxs("span",{className:"text-gray-600",children:["(",K.review_count,"件のレビュー)"]})]}),e.jsx("div",{className:"space-y-2",children:[5,4,3,2,1].map(s=>{const a=K[`rating_${s}_count`],t=K.review_count>0?a/K.review_count*100:0;return e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("span",{className:"w-3 text-gray-600",children:s}),e.jsx(j,{className:"w-3 h-3 text-yellow-400 fill-current"}),e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-yellow-400 h-2 rounded-full",style:{width:`${t}%`}})}),e.jsx("span",{className:"w-8 text-gray-600 text-right",children:a})]},s)})})]})]})})]})]}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[$.coupons&&$.coupons.length>0&&e.jsxs("div",{className:"mb-12",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h2",{className:"text-3xl font-bold text-gray-900 mb-4",children:[e.jsx(f,{className:"w-8 h-8 inline mr-3 text-red-500"}),"利用可能なクーポン"]}),e.jsx("p",{className:"text-gray-600",children:"お得なクーポンをご利用ください"})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:$.coupons.map(s=>{const a=L.find(e=>e.coupon_id===s.id),t=new Date(s.validity_end)<new Date,r=!t&&!a&&s.is_active;return e.jsx(d,{className:"overflow-hidden shadow-lg hover:shadow-xl transition-shadow",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"w-full max-w-sm mx-auto",children:s.coupon_image_url?e.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-xl overflow-hidden shadow-md",children:e.jsx("img",{src:s.coupon_image_url,alt:"クーポン画像",className:"w-full h-full object-cover"})}):e.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-xl relative overflow-hidden shadow-md",children:e.jsxs("div",{className:"w-full h-full bg-gradient-to-br from-red-500 to-red-600 relative",children:[e.jsx("div",{className:"absolute top-1/2 -left-3 w-6 h-6 bg-gray-50 rounded-full transform -translate-y-1/2"}),e.jsx("div",{className:"absolute top-1/2 -right-3 w-6 h-6 bg-gray-50 rounded-full transform -translate-y-1/2"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-20",children:e.jsx("span",{className:"text-6xl font-bold text-white transform rotate-12",children:"COUPON"})}),e.jsxs("div",{className:"relative z-10 h-full flex flex-col items-center justify-center p-4 text-center space-y-3",children:[e.jsx("div",{className:"bg-white/95 px-3 py-1 rounded-full shadow-sm",children:e.jsx("span",{className:"text-xs font-medium text-red-600",children:"ドッグパークJPクーポン"})}),e.jsx("div",{className:"text-white font-bold text-sm",children:$.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-base font-bold text-white leading-tight",children:s.title}),e.jsx("p",{className:"text-sm text-white/90 leading-tight",children:s.service_content})]}),s.discount_value&&e.jsxs("div",{className:"bg-white text-red-600 px-4 py-2 rounded-full shadow-md",children:[e.jsxs("span",{className:"text-xl font-bold",children:[s.discount_value,"amount"===s.discount_type?"円":"%"]}),e.jsx("span",{className:"text-xs ml-1",children:"OFF"})]}),e.jsx("div",{className:"pt-2 border-t border-white/30",children:e.jsx("p",{className:"text-xs text-white/80 leading-tight",children:s.description})})]})]})})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:s.title}),e.jsx("p",{className:"text-gray-600 mt-2 leading-relaxed",children:s.service_content})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(N,{className:"w-4 h-4 text-blue-500"}),e.jsxs("span",{className:"text-gray-700",children:["有効期限: ",new Date(s.validity_end).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(y,{className:"w-4 h-4 text-green-500"}),e.jsxs("span",{className:"text-gray-700",children:["利用制限: ","once"===s.usage_limit_type?"1回限り":"何回でも"]})]})]}),e.jsx("div",{className:"pt-4",children:k?a?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(n,{onClick:()=>(e=>{B(e),U(!0)})(a),className:"w-full py-3 text-base bg-green-600 hover:bg-green-700",disabled:a.is_used,children:[e.jsx(w,{className:"w-5 h-5 mr-2"}),a.is_used?"クーポン使用済み":"クーポンを表示"]}),a.is_used&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:[new Date(a.used_at).toLocaleDateString("ja-JP")," に使用"]})]}):r?e.jsx(n,{onClick:()=>ne(s.id),disabled:G===s.id,className:"w-full py-3 text-base bg-red-600 hover:bg-red-700 shadow-lg",children:G===s.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"取得中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-5 h-5 mr-2"}),"クーポンを取得"]})}):e.jsx(n,{disabled:!0,className:"w-full py-3 text-base",variant:"outline",children:t?"クーポンの有効期限切れ":"クーポン利用不可"}):e.jsx(l,{to:"/login",children:e.jsx(n,{className:"w-full py-3 text-base",variant:"outline",children:"ログインしてクーポンを取得"})})})]})]})})},s.id)})})]}),!1]}),F&&$.images&&$.images.length>0&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"relative max-w-4xl w-full",children:[e.jsx("button",{onClick:()=>J(!1),className:"absolute top-4 right-4 text-white hover:text-gray-300 z-10",children:e.jsx(b,{className:"w-8 h-8"})}),e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:$.images[P].image_url,alt:$.images[P].alt_text||"施設画像",className:"w-full h-auto max-h-[80vh] object-contain rounded-lg"}),$.images.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{$?.images&&$.images.length>0&&I(e=>0===e?$.images.length-1:e-1)},className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300",children:e.jsx(v,{className:"w-8 h-8"})}),e.jsx("button",{onClick:()=>{$?.images&&$.images.length>0&&I(e=>e===$.images.length-1?0:e+1)},className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300",children:e.jsx(_,{className:"w-8 h-8"})})]})]}),e.jsxs("div",{className:"text-center mt-4 text-white",children:[e.jsxs("p",{children:[P+1," / ",$.images.length]}),$.images[P].alt_text&&e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:$.images[P].alt_text})]})]})}),T&&A&&e.jsx(o,{userCoupon:A,onClose:()=>{U(!1),B(null)}})]})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsx(d,{className:"max-w-md w-full",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"text-gray-400 text-6xl mb-4",children:"🏢"}),e.jsx("h1",{className:"text-xl font-bold text-gray-900 mb-2",children:"施設が見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"指定された施設は存在しないか、現在利用できません。"}),e.jsxs(n,{onClick:()=>C("/parks"),variant:"outline",children:[e.jsx(x,{className:"mr-2 h-4 w-4"}),"ドッグラン・施設一覧に戻る"]})]})})})}export{S as FacilityDetail};
