import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{c as a,a as t,L as l}from"./router-DXQOdrLL.js";import{u as i,s as r,B as c,S as n}from"./index-KXRGrg5o.js";import{C as d}from"./Card-DqVnP9TA.js";import{C as o}from"./CouponDisplay-u8Dq6uYC.js";import{n as m,_ as x,M as h,s as u,v as g,G as p,C as j,U as f,a3 as N,X as v,Y as b,Z as y}from"./ui-basic-CJygcczc.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function w(){const{id:w}=a(),{user:_}=i();t();const[C,S]=s.useState(null),[k,q]=s.useState(!0),[D,F]=s.useState(null),[O,P]=s.useState(!1),[$,J]=s.useState(0),[z,L]=s.useState([]),[U,B]=s.useState(!1),[E,G]=s.useState(null),[I,M]=s.useState(null);s.useEffect(()=>{w&&(T(),_&&Y())},[w,_]);const T=async()=>{try{q(!0),F(null);const[e,s,a]=await Promise.all([r.from("pet_facilities").select("*").eq("id",w).eq("status","approved").single(),r.from("facility_images").select("*").eq("facility_id",w).order("created_at",{ascending:!0}),r.from("facility_coupons").select("*").eq("facility_id",w).eq("is_active",!0).gte("end_date",(new Date).toISOString().split("T")[0]).order("created_at",{ascending:!1})]);if(e.error)throw e.error;if(!e.data)return void F("施設が見つかりません");let t=null;const l=e.data.category_id||e.data.category;if(l){const{data:e,error:s}=await r.from("facility_categories").select("*").eq("id",l).single();s||(t=e)}S({...e.data,category_info:t,images:s.data||[],coupons:a.data||[]})}catch(e){F(`施設データの取得に失敗しました: ${e.message||JSON.stringify(e)}`)}finally{q(!1)}},Y=async()=>{if(_&&w)try{const{data:e}=await r.from("user_coupons").select("\n          *,\n          coupon:facility_coupons(*)\n        ").eq("user_id",_.id).in("coupon_id",C?.coupons?.map(e=>e.id)||[]);L(e||[])}catch(e){}};return k?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"施設情報を読み込み中..."})]})}):D||!C?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx(d,{className:"p-8 max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(m,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"施設が見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:D||"指定された施設は存在しないか、承認待ちの可能性があります。"}),e.jsx(l,{to:"/parks?view=facilities",children:e.jsxs(c,{children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"施設一覧に戻る"]})})]})})}):e.jsxs(e.Fragment,{children:[e.jsx(n,{title:`${C.name} - 施設詳細`,description:C.description||`${C.name}の詳細情報です。`}),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:e.jsxs(l,{to:"/parks?view=facilities",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"施設一覧に戻る"]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8 space-y-8",children:[e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start gap-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(m,{className:"w-6 h-6 text-blue-600"}),e.jsx("span",{className:"text-sm text-blue-600 font-medium",children:{pet_hotel:"ペットホテル",pet_salon:"ペットサロン",veterinary:"動物病院",pet_cafe:"ペットカフェ",pet_restaurant:"ペット同伴レストラン",pet_shop:"ペットショップ",pet_accommodation:"ペット同伴宿泊",dog_training:"しつけ教室",pet_friendly_other:"その他ワンちゃん同伴可能施設"}[C.category]||C.category})]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:C.name}),e.jsxs("div",{className:"space-y-3 text-gray-600",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(h,{className:"w-5 h-5 mt-0.5 text-gray-400"}),e.jsx("span",{children:C.address})]}),C.phone&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{className:"w-5 h-5 text-gray-400"}),e.jsx("a",{href:`tel:${C.phone}`,className:"hover:text-blue-600",children:C.phone})]})]})]}),e.jsx("div",{className:"flex flex-col gap-3",children:C.website&&e.jsx("a",{href:C.website,target:"_blank",rel:"noopener noreferrer",className:"w-full md:w-auto",children:e.jsxs(c,{className:"w-full",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"公式サイト"]})})})]})}),C.description&&e.jsxs(d,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"施設について"}),e.jsx("p",{className:"text-gray-700 leading-relaxed whitespace-pre-wrap",children:C.description})]}),C.images&&C.images.length>0&&e.jsxs(d,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"施設画像"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[C.images.slice(0,6).map((s,a)=>e.jsx("div",{className:"aspect-square rounded-lg overflow-hidden cursor-pointer hover:opacity-75 transition-opacity",onClick:()=>{J(a),P(!0)},children:e.jsx("img",{src:s.image_url,alt:s.description||`施設画像 ${a+1}`,className:"w-full h-full object-cover"})},s.id)),C.images.length>6&&e.jsx("div",{className:"aspect-square rounded-lg bg-gray-100 flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors",onClick:()=>P(!0),children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-gray-600",children:["+",C.images.length-6]}),e.jsx("p",{className:"text-sm text-gray-500",children:"その他の画像"})]})})]})]}),C.coupons&&C.coupons.length>0&&e.jsxs(d,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-4 flex items-center",children:[e.jsx(p,{className:"w-6 h-6 mr-3 text-red-500"}),"利用可能なクーポン"]}),e.jsx("div",{className:"grid gap-6",children:C.coupons.map(s=>{const a=z.find(e=>e.coupon_id===s.id),t=new Date(s.end_date)<new Date,i=_&&!a&&!t&&s.is_active;return e.jsx("div",{className:"border rounded-lg p-6 bg-white",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"w-full max-w-sm mx-auto",children:[s.coupon_image_url?e.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-lg overflow-hidden",children:e.jsx("img",{src:s.coupon_image_url,alt:"クーポン画像",className:"w-full h-full object-cover"})}):e.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-lg relative overflow-hidden",children:e.jsxs("div",{className:"w-full h-full bg-gradient-to-br from-red-500 to-red-600 relative",children:[e.jsx("div",{className:"absolute top-1/2 -left-3 w-6 h-6 bg-white rounded-full transform -translate-y-1/2"}),e.jsx("div",{className:"absolute top-1/2 -right-3 w-6 h-6 bg-white rounded-full transform -translate-y-1/2"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-20",children:e.jsx("span",{className:"text-6xl font-bold text-white transform rotate-12",children:"COUPON"})}),e.jsxs("div",{className:"relative z-10 h-full flex flex-col items-center justify-center p-4 text-center space-y-2",children:[e.jsx("div",{className:"bg-white/90 px-3 py-1 rounded-full",children:e.jsx("span",{className:"text-xs font-medium text-red-600",children:"ドッグパークJPクーポン"})}),e.jsx("div",{className:"text-white font-bold text-sm",children:C.name}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-base font-bold text-white leading-tight",children:s.title}),e.jsx("p",{className:"text-sm text-white/90 leading-tight",children:s.service_content})]}),s.discount_value&&e.jsxs("div",{className:"bg-white text-red-600 px-3 py-1 rounded-full",children:[e.jsxs("span",{className:"text-xl font-bold",children:[s.discount_value,"amount"===s.discount_type?"円":"%"]}),e.jsx("span",{className:"text-xs ml-1",children:"OFF"})]}),e.jsx("div",{className:"pt-2 border-t border-white/30",children:e.jsx("p",{className:"text-xs text-white/80 leading-tight",children:s.description})})]})]})}),e.jsx("div",{className:"mt-2 text-xs text-gray-500 text-center",children:s.coupon_image_url?"画像クーポン":"クーポン"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:s.title}),e.jsx("p",{className:"text-gray-600 mt-1",children:s.service_content})]}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4"}),e.jsxs("span",{children:["有効期限: ",new Date(s.end_date).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"w-4 h-4"}),e.jsxs("span",{children:["利用制限: ","once"===s.usage_limit_type?"1回限り":"何回でも"]})]})]}),e.jsx("div",{className:"pt-4",children:_?a?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(c,{onClick:()=>(e=>{G(e),B(!0)})(a),className:"w-full bg-green-600 hover:bg-green-700",disabled:a.is_used,children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),a.is_used?"クーポン使用済み":"クーポンを表示"]}),a.is_used&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:[new Date(a.used_at).toLocaleDateString("ja-JP")," に使用"]})]}):i?e.jsx(c,{onClick:()=>(async e=>{if(_&&!I)try{M(e);const{data:s,error:a}=await r.rpc("obtain_coupon",{p_coupon_id:e,p_user_id:_.id});if(a)throw a;if("already_obtained"===s)return void alert("このクーポンは既に取得済みです");if("coupon_not_found"===s)return void alert("クーポンが見つかりません");if("coupon_expired"===s)return void alert("このクーポンは有効期限が切れています");if("coupon_inactive"===s)return void alert("このクーポンは現在利用できません");alert("クーポンを取得しました！"),await Y()}catch(s){alert("クーポンの取得に失敗しました")}finally{M(null)}})(s.id),disabled:I===s.id,className:"w-full bg-red-600 hover:bg-red-700",children:I===s.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"取得中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"w-4 h-4 mr-2"}),"クーポンを取得"]})}):e.jsx(c,{disabled:!0,className:"w-full",variant:"outline",children:t?"クーポンの有効期限切れ":"クーポン利用不可"}):e.jsx(l,{to:"/login",children:e.jsx(c,{className:"w-full",variant:"outline",children:"ログインしてクーポンを取得"})})})]})]})},s.id)})})]})]}),O&&C.images&&C.images.length>0&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"relative max-w-4xl w-full",children:[e.jsx("button",{onClick:()=>P(!1),className:"absolute top-4 right-4 text-white hover:text-gray-300 z-10",children:e.jsx(v,{className:"w-8 h-8"})}),e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:C.images[$].image_url,alt:C.images[$].description||"施設画像",className:"w-full h-auto max-h-[80vh] object-contain rounded-lg"}),C.images.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{C?.images&&J(e=>0===e?C.images.length-1:e-1)},className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300",children:e.jsx(b,{className:"w-8 h-8"})}),e.jsx("button",{onClick:()=>{C?.images&&J(e=>e===C.images.length-1?0:e+1)},className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300",children:e.jsx(y,{className:"w-8 h-8"})})]})]}),e.jsxs("div",{className:"text-center mt-4 text-white",children:[e.jsxs("p",{children:[$+1," / ",C.images.length]}),C.images[$].description&&e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:C.images[$].description})]})]})}),U&&E&&e.jsx(o,{userCoupon:E,onClose:()=>{B(!1),G(null)}})]})]})}export{w as FacilityDetail};
