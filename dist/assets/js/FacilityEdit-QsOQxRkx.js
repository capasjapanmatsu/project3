const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-DxZPnn_v.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as s}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{d as a,a as r,L as i}from"./router-Cg6wfOY4.js";import{B as l}from"./Button-CJFAG6V0.js";import{s as d,C as n,u as c,S as o}from"./index-CVZFmpsT.js";import{I as m}from"./ImageCropper-BqfqFQ-L.js";import{I as x}from"./Input-D3zjVn42.js";import{L as h}from"./LocationEditMap-DYKLsROc.js";import{G as u,o as p,aY as g,aN as b,y as f,U as j,j as y,ae as N,ap as v,af as w,F as _,a4 as S,N as k,M as C,b2 as q,ac as D,i as $,ag as F,ah as E}from"./ui-basic-CaMd9YQ-.js";import"./heavy-features-BIdEME4r.js";import"./geocoding-C2oaRnzC.js";import"./GoogleMapsProvider-BjbauTRt.js";function O({facilityId:e,facilityName:a}){const[r,i]=t.useState([]),[c,o]=t.useState({}),[x,h]=t.useState(!0),[w,_]=t.useState(!1),[S,k]=t.useState(null),[C,q]=t.useState(""),[D,$]=t.useState(""),[F,E]=t.useState({title:"",description:"",service_content:"",discount_type:"amount",start_date:"",end_date:"",usage_limit_type:"once"}),[O,L]=t.useState(!1),[I,T]=t.useState(null),[A,M]=t.useState(!1),[P,U]=t.useState("");t.useEffect(()=>{Y()},[e]);const Y=async()=>{try{h(!0);const{data:s,error:t}=await d.from("facility_coupons").select("*").eq("facility_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(t)throw t;i(s||[])}catch(s){q("クーポンの取得に失敗しました。")}finally{h(!1)}},z=()=>{E({title:"",description:"",service_content:"",discount_type:"amount",start_date:"",end_date:"",usage_limit_type:"once"}),T(null),U(""),k(null),_(!1)};return x?s.jsx(n,{className:"p-6",children:s.jsxs("div",{className:"animate-pulse",children:[s.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-4"}),s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"h-3 bg-gray-200 rounded"}),s.jsx("div",{className:"h-3 bg-gray-200 rounded w-3/4"})]})]})}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center",children:[s.jsx(u,{className:"w-5 h-5 mr-2 text-pink-500"}),"クーポン管理"]}),s.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"お客様向けのクーポンを作成・管理できます"})]}),s.jsxs(l,{onClick:()=>{_(!0),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},100)},className:"flex items-center",children:[s.jsx(p,{className:"w-4 h-4 mr-2"}),"クーポン作成"]})]}),C&&s.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:C}),D&&s.jsx("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4",children:D}),w&&s.jsxs(n,{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold",children:S?"クーポン編集":"クーポン作成"}),s.jsx(l,{variant:"secondary",onClick:z,className:"text-sm",children:"キャンセル"})]}),s.jsxs("form",{onSubmit:async s=>{s.preventDefault(),L(!0),q("");try{if(!F.title.trim())throw new Error("クーポンタイトルを入力してください。");if(!F.service_content.trim())throw new Error("サービス内容を入力してください。");if(!F.start_date)throw new Error("開始日を入力してください。");if(!F.end_date)throw new Error("終了日を入力してください。");if("free_gift"!==F.discount_type&&(!F.discount_value||F.discount_value<=0))throw new Error(("amount"===F.discount_type?"割引金額":"割引率")+"を入力してください。");const s=new Date(`${F.start_date}T00:00:00`),t=new Date(`${F.end_date}T23:59:59`);if(t<=s)throw new Error("終了日は開始日より後である必要があります。");let a=S?.coupon_image_url||"";if(I){const s=Date.now(),t=`${e}/${`coupon_${e}_${s}.jpg`}`,{error:r}=await d.storage.from("pet-facility-images").upload(t,I,{contentType:"image/jpeg",upsert:!0});if(r)throw r;const{data:i}=d.storage.from("pet-facility-images").getPublicUrl(t);a=i.publicUrl}const r={facility_id:e,title:F.title.trim(),description:F.description.trim(),service_content:F.service_content.trim(),coupon_image_url:a||null,discount_value:F.discount_value||null,discount_type:F.discount_type,start_date:s.toISOString(),end_date:t.toISOString(),usage_limit_type:F.usage_limit_type,max_uses:"once"===F.usage_limit_type?1:null,updated_at:(new Date).toISOString()};if(S){const{error:e}=await d.from("facility_coupons").update(r).eq("id",S.id);if(e)throw e;$("クーポンが更新されました！")}else{const{error:e}=await d.from("facility_coupons").insert(r);if(e)throw e;$("クーポンが作成されました！")}z(),Y()}catch(t){q(t instanceof Error?t.message:"クーポンの保存に失敗しました。")}finally{L(!1)}},className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"クーポンタイトル *"}),s.jsx("input",{value:F.title,onChange:e=>E({...F,title:e.target.value}),placeholder:"例：初回利用10%OFF",maxLength:100,required:!0,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"割引設定"}),s.jsxs("div",{className:"flex space-x-2 items-center",children:[s.jsxs("select",{value:F.discount_type,onChange:e=>E({...F,discount_type:e.target.value}),className:"border border-gray-300 rounded-md px-3 py-2 text-sm",children:[s.jsx("option",{value:"amount",children:"金額"}),s.jsx("option",{value:"percentage",children:"割引率"}),s.jsx("option",{value:"free_gift",children:"無料プレゼント"})]}),"free_gift"!==F.discount_type&&s.jsxs(s.Fragment,{children:[s.jsx("input",{type:"number",value:F.discount_value||"",onChange:e=>E({...F,discount_value:e.target.value?parseInt(e.target.value):void 0}),placeholder:"amount"===F.discount_type?"500":"10",className:"w-24 text-lg font-medium text-center border border-gray-300 rounded-md px-3 py-2"}),s.jsx("span",{className:"flex items-center text-lg text-gray-700 font-medium",children:"amount"===F.discount_type?"円":"%"})]}),"free_gift"===F.discount_type&&s.jsx("span",{className:"text-lg text-green-600 font-medium",children:"🎁 無料プレゼント"})]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"サービス内容 *"}),s.jsx("textarea",{value:F.service_content,onChange:e=>E({...F,service_content:e.target.value}),placeholder:"トリミング10%OFF",rows:3,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"詳細説明"}),s.jsx("textarea",{value:F.description,onChange:e=>E({...F,description:e.target.value}),placeholder:"おひとり様初回1回限定です",rows:3,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"開始日時 *"}),s.jsx("input",{type:"date",value:F.start_date,onChange:e=>E({...F,start_date:e.target.value}),required:!0,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"終了日時 *"}),s.jsx("input",{type:"date",value:F.end_date,onChange:e=>E({...F,end_date:e.target.value}),required:!0,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"使用制限"}),s.jsxs("select",{value:F.usage_limit_type,onChange:e=>E({...F,usage_limit_type:e.target.value}),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",children:[s.jsx("option",{value:"unlimited",children:"何回でも"}),s.jsx("option",{value:"once",children:"1回限り"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ご用意頂いた画像にする場合は画像アップロードしてください。"}),s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsxs(l,{type:"button",variant:"secondary",onClick:()=>document.getElementById("coupon-image-input")?.click(),className:"flex items-center",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"画像を選択"]}),P&&s.jsx(l,{type:"button",variant:"outline",onClick:()=>{U(""),T(null);const e={...F};delete e.coupon_image,E(e)},className:"text-red-600 hover:text-red-700",children:"画像を削除"})]}),s.jsx("input",{id:"coupon-image-input",type:"file",accept:"image/*",onChange:e=>{const s=e.target.files?.[0];s&&(e=>{T(e),M(!0)})(s)},className:"hidden"})]})]}),s.jsx("div",{className:"space-y-4",children:s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"クーポンプレビュー"}),s.jsx("div",{className:"w-full max-w-sm mx-auto",children:P?s.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-lg overflow-hidden",children:s.jsx("img",{src:P,alt:"クーポン画像",className:"w-full h-full object-cover"})}):s.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-lg relative overflow-hidden",children:s.jsxs("div",{className:"w-full h-full bg-gradient-to-br from-red-500 to-red-600 relative",children:[s.jsx("div",{className:"absolute top-1/2 -left-3 w-6 h-6 bg-white rounded-full transform -translate-y-1/2"}),s.jsx("div",{className:"absolute top-1/2 -right-3 w-6 h-6 bg-white rounded-full transform -translate-y-1/2"}),s.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-10",children:s.jsx("span",{className:"text-6xl font-bold text-white transform rotate-12",children:"COUPON"})}),s.jsxs("div",{className:"relative z-10 flex flex-col items-center justify-center h-full p-4 text-center space-y-3",children:[s.jsx("div",{className:"bg-white/95 px-3 py-1 rounded-full shadow-sm",children:s.jsx("span",{className:"text-xs font-medium text-red-600",children:"ドッグパークJPクーポン"})}),s.jsx("div",{className:"text-white",children:s.jsx("h2",{className:"text-lg font-bold leading-tight",children:a})}),s.jsx("div",{className:"text-white",children:s.jsx("h3",{className:"text-xl font-bold leading-tight",children:F.title||"クーポンタイトル"})}),s.jsx("div",{className:"text-white/90",children:s.jsx("p",{className:"text-base leading-tight",children:F.service_content||"サービス内容"})}),"free_gift"===F.discount_type?s.jsxs("div",{className:"bg-white text-green-600 px-6 py-3 rounded-lg shadow-md",children:[s.jsx("span",{className:"text-4xl font-bold",children:"🎁"}),s.jsx("span",{className:"text-lg ml-2 font-medium",children:"無料プレゼント"})]}):F.discount_value&&F.discount_type&&s.jsxs("div",{className:"bg-white text-red-600 px-6 py-3 rounded-lg shadow-md",children:[s.jsxs("span",{className:"text-4xl font-bold",children:[F.discount_value,"amount"===F.discount_type?"円":"%"]}),s.jsx("span",{className:"text-lg ml-2 font-medium",children:"OFF"})]}),s.jsx("div",{className:"border-t border-white/30 pt-2",children:s.jsx("p",{className:"text-sm text-white/80",children:F.description||"詳細説明"})}),F.start_date&&F.end_date&&s.jsx("div",{className:"border-t border-white/30 pt-2 mt-2",children:s.jsxs("p",{className:"text-xs text-white/90 font-medium",children:["有効期限: ",new Date(F.start_date).toLocaleDateString()," 〜 ",new Date(F.end_date).toLocaleDateString()]})})]})]})})}),s.jsx("div",{className:"mt-2 text-xs text-gray-500 text-center",children:P?"画像クーポン":"クーポン"})]})})]}),s.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[s.jsx(l,{type:"button",variant:"secondary",onClick:z,disabled:O,children:"キャンセル"}),s.jsxs(l,{type:"submit",disabled:O,className:"flex items-center",children:[s.jsx(b,{className:"w-4 h-4 mr-2"}),S?"更新":"作成"]})]})]})]}),s.jsx("div",{className:"space-y-4",children:0===r.length?s.jsxs(n,{className:"p-8 text-center",children:[s.jsx(u,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"クーポンがありません"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"最初のクーポンを作成してお客様にお得なサービスを提供しましょう"}),s.jsxs(l,{onClick:()=>_(!0),children:[s.jsx(p,{className:"w-4 h-4 mr-2"}),"クーポン作成"]})]}):r.map(e=>s.jsx(n,{className:"p-6",children:s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"w-full max-w-sm mx-auto",children:[e.coupon_image_url?s.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-lg overflow-hidden",children:s.jsx("img",{src:e.coupon_image_url,alt:"クーポン画像",className:"w-full h-full object-cover"})}):s.jsx("div",{className:"aspect-square w-full border-2 border-gray-300 rounded-lg relative overflow-hidden",children:s.jsxs("div",{className:"w-full h-full bg-gradient-to-br from-red-500 to-red-600 relative",children:[s.jsx("div",{className:"absolute top-1/2 -left-3 w-6 h-6 bg-white rounded-full transform -translate-y-1/2"}),s.jsx("div",{className:"absolute top-1/2 -right-3 w-6 h-6 bg-white rounded-full transform -translate-y-1/2"}),s.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-10",children:s.jsx("span",{className:"text-6xl font-bold text-white transform rotate-12",children:"COUPON"})}),s.jsxs("div",{className:"relative z-10 flex flex-col items-center justify-center h-full p-4 text-center space-y-3",children:[s.jsx("div",{className:"bg-white/95 px-3 py-1 rounded-full shadow-sm",children:s.jsx("span",{className:"text-xs font-medium text-red-600",children:"ドッグパークJPクーポン"})}),s.jsx("div",{className:"text-white",children:s.jsx("h2",{className:"text-lg font-bold leading-tight",children:a})}),s.jsx("div",{className:"text-white",children:s.jsx("h3",{className:"text-xl font-bold leading-tight",children:e.title})}),s.jsx("div",{className:"text-white/90",children:s.jsx("p",{className:"text-base leading-tight",children:e.service_content})}),e.discount_value&&e.discount_type&&s.jsxs("div",{className:"bg-white text-red-600 px-6 py-3 rounded-lg shadow-md",children:[s.jsxs("span",{className:"text-4xl font-bold",children:[e.discount_value,"amount"===e.discount_type?"円":"%"]}),s.jsx("span",{className:"text-lg ml-2 font-medium",children:"OFF"})]}),e.description&&s.jsx("div",{className:"border-t border-white/30 pt-2",children:s.jsx("p",{className:"text-sm text-white/80",children:e.description})}),e.start_date&&e.end_date&&s.jsx("div",{className:"border-t border-white/30 pt-2 mt-2",children:s.jsxs("p",{className:"text-xs text-white/90 font-medium",children:["有効期限: ",new Date(e.start_date).toLocaleDateString()," 〜 ",new Date(e.end_date).toLocaleDateString()]})})]})]})}),s.jsx("div",{className:"mt-2 text-xs text-gray-500 text-center",children:e.coupon_image_url?"画像クーポン":"クーポン"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("span",{className:"px-3 py-1 text-sm font-medium rounded-full "+(e.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"),children:e.is_active?"有効":"無効"}),s.jsx("span",{className:"px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800",children:"once"===e.usage_limit_type?"1回限り":"何回でも"})]}),s.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"期間："}),s.jsxs("div",{className:"flex items-center text-sm",children:[s.jsx(f,{className:"w-4 h-4 mr-1 text-gray-400"}),new Date(e.start_date).toLocaleDateString()," 〜",new Date(e.end_date).toLocaleDateString()]})]}),c[e.id]&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"取得数："}),s.jsxs("div",{className:"flex items-center text-sm",children:[s.jsx(j,{className:"w-4 h-4 mr-1 text-gray-400"}),c[e.id].total_obtained,"人"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"使用数："}),s.jsxs("div",{className:"flex items-center text-sm",children:[s.jsx(u,{className:"w-4 h-4 mr-1 text-gray-400"}),c[e.id].total_used,"回"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"使用率："}),s.jsxs("div",{className:"font-medium text-sm",children:[c[e.id].usage_rate,"%"]})]})]})]}),s.jsxs("div",{className:"flex flex-col space-y-2",children:[s.jsxs(l,{variant:"secondary",onClick:()=>(e=>{k(e),E({title:e.title||"",description:e.description||"",service_content:e.service_content||"",discount_value:e.discount_value||0,discount_type:e.discount_type||"percentage",start_date:e.start_date?e.start_date.split("T")[0]:"",end_date:e.end_date?e.end_date.split("T")[0]:"",usage_limit_type:e.usage_limit_type||"unlimited"}),U(e.coupon_image_url||""),_(!0),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},100)})(e),className:"w-full",children:[s.jsx(y,{className:"w-4 h-4 mr-2"}),"編集"]}),s.jsx(l,{variant:e.is_active?"secondary":"primary",onClick:()=>(async e=>{try{const{error:s}=await d.from("facility_coupons").update({is_active:!e.is_active}).eq("id",e.id);if(s)throw s;$(e.is_active?"クーポンを無効化しました。":"クーポンを有効化しました。"),Y()}catch(s){q("クーポンの状態変更に失敗しました。")}})(e),className:"w-full",children:e.is_active?"無効化":"有効化"}),s.jsxs(l,{variant:"danger",onClick:()=>(async e=>{if(window.confirm("このクーポンを削除しますか？この操作は取り消せません。"))try{const{error:s}=await d.from("facility_coupons").delete().eq("id",e);if(s)throw s;$("クーポンが削除されました。"),Y()}catch(s){q("クーポンの削除に失敗しました。")}})(e.id),className:"w-full",children:[s.jsx(N,{className:"w-4 h-4 mr-2"}),"削除"]})]})]})]})},e.id))}),s.jsx(n,{className:"mt-6",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(v,{className:"w-5 h-5 mr-2 text-blue-600"}),"クーポンについて"]}),s.jsxs("div",{className:"space-y-3 text-sm text-gray-700",children:[s.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[s.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"📱 クーポンの表示方法"}),s.jsx("p",{className:"text-blue-700",children:"クーポンはスマートフォンの画面に表示され、お客様が店舗で提示します。"})]}),s.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[s.jsx("h4",{className:"font-semibold text-yellow-800 mb-2",children:"🔒 1回限りクーポンの仕組み"}),s.jsx("p",{className:"text-yellow-700 mb-2",children:"「おひとり様1回限り」のクーポンは、1ユーザーにつき1回のみ取得可能です。"}),s.jsx("p",{className:"text-yellow-700 mb-2",children:"• お客様がクーポンを表示した段階で自動削除されます"}),s.jsx("p",{className:"text-yellow-700",children:"• 2回目以降は使用できなくなり、再表示もできません"})]}),s.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[s.jsx("h4",{className:"font-semibold text-green-800 mb-2",children:"♻️ 何回でもクーポンの仕組み"}),s.jsx("p",{className:"text-green-700 mb-2",children:"「何回でも」のクーポンは、有効期限内であれば何度でも使用可能です。"}),s.jsx("p",{className:"text-green-700",children:"• 同じお客様が複数回利用できます（期限内）"})]}),s.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[s.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"⏰ 有効期限について"}),s.jsx("p",{className:"text-gray-700",children:"設定した有効期限を過ぎると、クーポンは自動的に無効になります。"})]}),s.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[s.jsx("h4",{className:"font-semibold text-purple-800 mb-2",children:"🔄 クーポン編集時の再取得機能"}),s.jsx("p",{className:"text-purple-700 mb-2",children:"店舗がクーポンを編集（有効期限延長など）した場合、新しいバージョンとして作成されます。"}),s.jsxs("p",{className:"text-purple-700 mb-2",children:["• ",s.jsx("strong",{children:"1回限りクーポンを使用済み"}),"のお客様も、編集後は",s.jsx("strong",{children:"新しいクーポンとして再取得可能"}),"になります"]}),s.jsx("p",{className:"text-purple-700 mb-2",children:"• 編集前の古いクーポンは自動的に無効化され、新しいクーポンIDが生成されます"}),s.jsx("p",{className:"text-purple-700",children:"• これにより、有効期限延長などの際にお客様が不利益を被ることなく、継続してクーポンをご利用いただけます"})]})]})]})}),A&&I&&s.jsx(m,{imageFile:I,onCropComplete:e=>{const s=URL.createObjectURL(e);U(s),E({...F,coupon_image:e}),T(e),M(!1)},onCancel:()=>M(!1),aspectRatio:1})]})}const L={pet_hotel:"ペットホテル",pet_salon:"ペットサロン",veterinary:"動物病院",pet_cafe:"ペットカフェ",pet_restaurant:"ペット同伴レストラン",pet_shop:"ペットショップ",pet_accommodation:"ペット同伴宿泊",dog_training:"しつけ教室",pet_friendly_other:"その他ワンちゃん同伴可能施設"};function I(){const{id:j}=a(),{user:v}=c(),I=r(),[T,A]=t.useState(null),[M,P]=t.useState([]),[U,Y]=t.useState(!0),[z,B]=t.useState(!1),[J,R]=t.useState(""),[G,H]=t.useState(""),[W,V]=t.useState(!1),[K,Q]=t.useState(""),[X,Z]=t.useState(!1),[ee,se]=t.useState([]),[te,ae]=t.useState(!1),[re,ie]=t.useState(null),[le,de]=t.useState(null),[ne,ce]=t.useState(!1),[oe,me]=t.useState({name:"",category_id:"",address:"",phone:"",website:"",description:"",latitude:null,longitude:null,is_public:!1}),[xe,he]=t.useState(!1),[ue,pe]=t.useState("info"),[ge,be]=t.useState(!1),[fe,je]=t.useState(60),[ye,Ne]=t.useState(90),[ve,we]=t.useState(10),[_e,Se]=t.useState(!0),[ke,Ce]=t.useState(!1),[qe,De]=t.useState("ご予約を受け付けました。お気をつけてお越しください。"),[$e,Fe]=t.useState([]),[Ee,Oe]=t.useState(""),[Le,Ie]=t.useState([!1,!1,!1,!1,!1,!1,!1]),[Te,Ae]=t.useState("09:00"),[Me,Pe]=t.useState("18:00"),[Ue,Ye]=t.useState([]),[ze,Be]=t.useState([]),[Je,Re]=t.useState(new Date),[Ge,He]=t.useState(""),[We,Ve]=t.useState("all"),[Ke,Qe]=t.useState([]),[Xe,Ze]=t.useState(!1),[es,ss]=t.useState(null),[ts,as]=t.useState(""),[rs,is]=t.useState(!1);t.useEffect(()=>{(async()=>{if("reservation"===ue&&T)try{const e=e=>{let s=d.from("facility_reservations").select(e?"id,user_id,customer_name,seat_code,reserved_date,start_time,end_time,status":"id,user_id,seat_code,reserved_date,start_time,end_time,status").eq("facility_id",T.id).order("reserved_date",{ascending:!0}).order("start_time",{ascending:!0});return Ge&&(s=s.eq("reserved_date",Ge)),"all"!==We&&(s=s.eq("status",We)),s};let{data:s,error:t}=await e(!0);if(t&&/customer_name/i.test(String(t.message))){const t=await e(!1);s=(await t).data}Qe(s||[])}catch(e){Qe([])}})()},[ue,T,Ge,We]);const ls=e=>{switch(e){case"pending":return"予約申請";case"confirmed":return"予約完了";case"cancelled":return"キャンセル";default:return e}};t.useEffect(()=>{v&&j?ds():I("/my-facilities-management")},[v,j,I]);const ds=async()=>{try{Y(!0);const{data:s,error:t}=await d.from("pet_facilities").select("*").eq("id",j).eq("owner_id",v?.id).single();if(t)throw t;if(!s)return void I("/my-facilities-management");if(A(s),me({name:s.name||"",category_id:s.category_id||"",address:s.address||"",phone:s.phone||"",website:s.website||"",description:s.description||"",latitude:s.latitude||null,longitude:s.longitude||null,is_public:s.is_public||!1}),s.opening_time&&Ae(s.opening_time),s.closing_time&&Pe(s.closing_time),s.weekly_closed_days)try{const e=JSON.parse(s.weekly_closed_days);Array.isArray(e)&&7===e.length&&Ie(e)}catch(e){}try{const{data:e}=await d.from("facility_reservation_settings").select("*").eq("facility_id",j).maybeSingle();e&&(be(Boolean(e.enabled)),je(e.slot_unit_minutes||60),Ne(e.allowed_days_ahead||90),we(e.capacity_per_slot||10),Se(Boolean(e.auto_confirm)),Ce(Boolean(e.auto_message_enabled)),e.auto_message_text&&De(e.auto_message_text));const{data:s}=await d.from("facility_seats").select("seat_code").eq("facility_id",j);Fe((s||[]).map(e=>e.seat_code))}catch(e){}if(s.specific_closed_dates)try{const e=JSON.parse(s.specific_closed_dates);Array.isArray(e)&&Ye(e)}catch(e){}if(s.specific_open_dates)try{const e=JSON.parse(s.specific_open_dates);Array.isArray(e)&&Be(e)}catch(e){}s.identity_document_url;const{data:a,error:r}=await d.from("pet_facility_images").select("*").eq("facility_id",j).order("display_order",{ascending:!0});if(r)throw r;se(a||[]);const{data:i,error:l}=await d.from("facility_categories").select("*").order("name");if(l)throw l;P(i||[]),Y(!1)}catch(s){R("施設データの読み込みに失敗しました。"),Y(!1)}},ns=(e,s)=>{const t=e.target.files?.[0];t&&(t.type.startsWith("image/")?t.size>10485760?R("ファイルサイズは10MB未満にしてください。"):(ie(t),de(s??null),ae(!0)):R("画像ファイルを選択してください。"))},cs=async e=>{if(window.confirm("この画像を削除しますか？"))try{R("");const{error:s}=await d.from("pet_facility_images").delete().eq("id",e);if(s)throw s;se(s=>s.filter(s=>s.id!==e));const t=ee.filter(s=>s.id!==e);for(let e=0;e<t.length;e++){const s=0===e?"main":"additional";t[e].display_order===e&&t[e].image_type===s||await d.from("pet_facility_images").update({display_order:e,image_type:s}).eq("id",t[e].id)}H("画像が削除されました。"),ds(),setTimeout(()=>H(""),3e3)}catch(s){R("画像の削除に失敗しました。")}},os=e=>{const{name:s,value:t}=e.target;me(e=>({...e,[s]:t}))},ms=async e=>{if(e.preventDefault(),T&&v){B(!0),R(""),H("");try{if(!oe.name.trim())throw new Error("施設名を入力してください。");if(!oe.category_id)throw new Error("カテゴリを選択してください。");if(!oe.address.trim())throw new Error("住所を入力してください。");if(!oe.phone.trim())throw new Error("電話番号を入力してください。");const{error:e}=await d.from("pet_facilities").update({name:oe.name.trim(),category_id:oe.category_id,address:oe.address.trim(),phone:oe.phone.trim(),website:oe.website.trim()||null,description:oe.description.trim()||null,latitude:oe.latitude,longitude:oe.longitude,updated_at:(new Date).toISOString()}).eq("id",T.id);if(e)throw e;H("施設情報を更新しました。"),await ds(),setTimeout(()=>{H("")},3e3)}catch(s){R(s instanceof Error?s.message:"更新に失敗しました。")}finally{B(!1)}}};if(U)return s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!T)return s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"施設が見つかりません"}),s.jsx(i,{to:"/my-facilities-management",children:s.jsx(l,{children:"管理画面に戻る"})})]})});return s.jsxs(s.Fragment,{children:[s.jsx(o,{title:`${T.name} - 施設編集`,description:"ペット関連施設の情報を編集・管理します。"}),s.jsxs("div",{className:"min-h-screen bg-gray-50",children:[s.jsx("div",{className:"bg-white border-b",children:s.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:s.jsxs(i,{to:"/my-facilities-management",className:"flex items-center text-blue-600 hover:text-blue-800",children:[s.jsx(w,{className:"w-4 h-4 mr-2"}),"施設管理一覧に戻る"]})})}),s.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[s.jsx("div",{className:"bg-white rounded-lg border p-6 mb-6",children:s.jsxs("div",{className:"flex justify-between items-start mb-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:T.name}),s.jsx("p",{className:"text-gray-600 mt-1",children:T.address}),s.jsx("div",{className:"flex items-center mt-2",children:(e=>{switch(e){case"approved":return s.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full",children:"承認済み"});case"pending":return s.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full",children:"審査中"});case"rejected":return s.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full",children:"却下"});default:return s.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full",children:"不明"})}})(T.status)})]}),s.jsx("div",{className:"flex space-x-3",children:"approved"===T.status&&s.jsx(i,{to:`/parks?view=facilities&facility=${T.id}`,children:s.jsxs(l,{variant:"secondary",className:"min-w-[100px]",children:[s.jsx(y,{className:"w-4 h-4 mr-2"}),"公開ページ"]})})})]})}),J&&s.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 mb-6",children:[s.jsx(_,{className:"w-5 h-5 inline mr-2"}),J]}),G&&s.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 mb-6",children:[s.jsx(S,{className:"w-5 h-5 inline mr-2"}),G]}),s.jsxs("div",{className:"bg-white rounded-lg border mb-6",children:[s.jsx("div",{className:"border-b",children:s.jsxs("nav",{className:"flex flex-wrap gap-3 sm:gap-6 px-4",children:[s.jsxs("button",{onClick:()=>pe("info"),className:"py-3 px-3 border-b-2 font-medium text-sm whitespace-nowrap w-1/3 sm:w-auto text-center "+("info"===ue?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(k,{className:"w-4 h-4 inline mr-2"}),"基本情報"]}),s.jsxs("button",{onClick:()=>pe("images"),className:"py-3 px-3 border-b-2 font-medium text-sm whitespace-nowrap w-1/3 sm:w-auto text-center "+("images"===ue?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(g,{className:"w-4 h-4 inline mr-2"}),"画像管理"]}),s.jsxs("button",{onClick:()=>pe("coupons"),className:"py-3 px-3 border-b-2 font-medium text-sm whitespace-nowrap w-1/3 sm:w-auto text-center "+("coupons"===ue?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(u,{className:"w-4 h-4 inline mr-2"}),"クーポン管理"]}),s.jsxs("button",{onClick:()=>pe("schedule"),className:"py-3 px-3 border-b-2 font-medium text-sm whitespace-nowrap w-1/3 sm:w-auto text-center "+("schedule"===ue?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(f,{className:"w-4 h-4 inline mr-2"}),"営業日管理"]}),s.jsxs("button",{onClick:()=>pe("location"),className:"py-3 px-3 border-b-2 font-medium text-sm whitespace-nowrap w-1/3 sm:w-auto text-center "+("location"===ue?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(C,{className:"w-4 h-4 inline mr-2"}),"位置調整"]}),s.jsxs("button",{onClick:()=>pe("reservation"),className:"py-3 px-3 border-b-2 font-medium text-sm whitespace-nowrap w-1/3 sm:w-auto text-center "+("reservation"===ue?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(f,{className:"w-4 h-4 inline mr-2"}),"予約管理"]})]})}),s.jsxs("div",{className:"p-6",children:["info"===ue&&s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[s.jsx(k,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設情報の編集"]}),s.jsxs("form",{onSubmit:ms,className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設名 *"}),s.jsx(x,{name:"name",value:oe.name,onChange:os,placeholder:"施設名を入力",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"カテゴリ *"}),s.jsxs("select",{name:"category_id",value:oe.category_id,onChange:os,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[s.jsx("option",{value:"",children:"カテゴリを選択"}),M.map(e=>s.jsx("option",{value:e.id,children:L[e.name]||e.name},e.id))]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所 *"}),s.jsx(x,{name:"address",value:oe.address,onChange:os,placeholder:"住所を入力",required:!0})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),s.jsx(x,{name:"phone",value:oe.phone,onChange:os,placeholder:"電話番号を入力",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),s.jsx(x,{name:"website",value:oe.website,onChange:os,placeholder:"https://example.com"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設説明"}),s.jsx("textarea",{name:"description",value:oe.description,onChange:os,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"施設の特徴やサービス内容を入力"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設画像 (最大5枚)"}),s.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"1枚目がメイン画像として使用されます。施設の雰囲気がわかる画像をアップロードしてください。"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-4",children:[ee.map((e,t)=>s.jsxs("div",{className:"relative group",children:[s.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200",children:s.jsx("img",{src:e.image_url,alt:`施設画像 ${t+1}`,className:"w-full h-full object-cover"})}),s.jsx("div",{className:"absolute top-2 left-2",children:s.jsx("span",{className:"bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded",children:0===t?"メイン":t+1})}),s.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:s.jsxs("div",{className:"flex space-x-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:e=>ns(e,t),className:"hidden",id:`basic-image-replace-${t}`}),s.jsx("label",{htmlFor:`basic-image-replace-${t}`,className:"bg-white text-gray-600 p-1 rounded shadow hover:bg-gray-50 cursor-pointer",title:"画像を変更",children:s.jsx(g,{className:"w-4 h-4"})}),s.jsx("button",{type:"button",onClick:()=>cs(e.id),className:"bg-red-500 text-white p-1 rounded shadow hover:bg-red-600",title:"画像を削除",children:s.jsx(N,{className:"w-4 h-4"})})]})})]},e.id)),ee.length<5&&s.jsxs("div",{className:"aspect-square bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:e=>ns(e),className:"hidden",id:"basic-image-add"}),s.jsxs("label",{htmlFor:"basic-image-add",className:"flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600",children:[s.jsx(p,{className:"w-8 h-8 mb-2"}),s.jsx("span",{className:"text-sm font-medium",children:"画像を追加"})]})]})]}),0===ee.length&&s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx(q,{className:"w-12 h-12 mx-auto mb-3 text-gray-400"}),s.jsx("p",{className:"text-sm",children:"まだ画像がアップロードされていません"}),s.jsx("p",{className:"text-xs mt-1",children:"最初の画像がメイン画像として使用されます"})]})]}),s.jsx("div",{className:"flex justify-end",children:s.jsxs(l,{type:"submit",isLoading:z,children:[s.jsx(b,{className:"w-4 h-4 mr-2"}),"更新"]})})]})]}),"reservation"===ue&&s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[s.jsx(f,{className:"w-6 h-6 text-blue-600 mr-2"}),"予約管理"]}),s.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"時間単位の予約、客席コード、受付期間を設定します。公開ページからユーザーが予約できます。"}),s.jsxs("div",{className:"bg-white rounded-lg border p-4 mb-6 space-y-3",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("label",{className:"flex items-center space-x-2",children:[s.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:ge,onChange:e=>be(e.target.checked)}),s.jsx("span",{children:"予約を受け付ける"})]})}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-700",children:"予約単位"}),s.jsx("select",{className:"border rounded px-2 py-1",value:fe,onChange:e=>je(Number(e.target.value)),children:[15,30,45,60,90,120].map(e=>s.jsxs("option",{value:e,children:[e,"分"]},e))})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-700",children:"受付可能日数"}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("input",{type:"number",min:1,max:365,className:"border rounded px-2 py-1 w-24 text-right",value:ye,onChange:e=>Ne(Number(e.target.value))}),s.jsx("span",{className:"text-sm text-gray-600",children:"日先"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-700",children:"仮予約の自動承認"}),s.jsxs("label",{className:"flex items-center space-x-2",children:[s.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:_e,onChange:e=>Se(e.target.checked)}),s.jsx("span",{children:"自動で予約確定にする"})]})]}),s.jsxs("div",{className:"mt-2",children:[s.jsxs("label",{className:"flex items-center space-x-2 mb-2",children:[s.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:ke,onChange:e=>Ce(e.target.checked)}),s.jsx("span",{className:"text-sm text-gray-700",children:"予約確定時にデフォルトメッセージを自動送信"})]}),s.jsx("textarea",{className:"w-full border rounded px-2 py-1 text-sm",rows:3,value:qe,onChange:e=>De(e.target.value)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-gray-700",children:"同一時間キャパ"}),s.jsx("input",{type:"number",min:1,max:1e3,className:"border rounded px-2 py-1 w-24 text-right",value:ve,onChange:e=>we(Number(e.target.value))})]}),s.jsx("div",{className:"flex justify-end pt-2",children:s.jsx(l,{onClick:async()=>{try{if(!T)return;const e=await d.from("facility_reservation_settings").upsert({facility_id:T.id,enabled:ge,slot_unit_minutes:fe,allowed_days_ahead:ye,auto_confirm:_e,auto_message_enabled:ke,auto_message_text:qe,capacity_per_slot:ve,updated_at:(new Date).toISOString()});if(e.error&&/auto_message_(enabled|text)/i.test(String(e.error.message))){const e=await d.from("facility_reservation_settings").upsert({facility_id:T.id,enabled:ge,slot_unit_minutes:fe,allowed_days_ahead:ye,auto_confirm:_e,capacity_per_slot:ve,updated_at:(new Date).toISOString()});if(e.error)throw e.error;H("予約設定を保存しました（自動メッセージ列が未適用のため一部設定は保留されました）。管理DBで列を追加後に再保存してください。")}await d.from("facility_seats").delete().eq("facility_id",T.id),$e.length>0&&await d.from("facility_seats").insert($e.map(e=>({facility_id:T.id,seat_code:e}))),/自動メッセージ列が未適用/.test(G)||H("予約設定を保存しました。")}catch(e){R("予約設定の保存に失敗しました。")}},children:"設定を保存"})})]}),s.jsxs("div",{className:"bg-white rounded-lg border p-4 mb-6",children:[s.jsx("h3",{className:"font-semibold mb-3",children:"客席（席コード）"}),s.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"任意です。登録すると予約時にお客さまが座席を選択して予約できます。未登録の場合は公開ページの座席指定欄は非表示になります。"}),s.jsxs("div",{className:"flex space-x-2 mb-3",children:[s.jsx("input",{className:"border rounded px-2 py-1 flex-1",placeholder:"例: A1,B,4人席,個室 など",value:Ee,onChange:e=>Oe(e.target.value)}),s.jsx(l,{onClick:()=>{const e=Ee.trim();e&&($e.includes(e)||(Fe(s=>[...s,e]),Oe("")))},variant:"secondary",children:"追加"})]}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[$e.map(e=>s.jsxs("div",{className:"px-3 py-1 bg-gray-100 rounded-full flex items-center space-x-2",children:[s.jsx("span",{children:e}),s.jsx("button",{className:"text-red-600",onClick:()=>{return s=e,Fe(e=>e.filter(e=>e!==s));var s},children:"×"})]},e)),0===$e.length&&s.jsx("p",{className:"text-sm text-gray-500",children:"まだ客席が登録されていません"})]})]}),s.jsxs("div",{className:"bg-white rounded-lg border p-4 mb-6",children:[s.jsx("h3",{className:"font-semibold mb-3",children:"予約一覧"}),s.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"対象日"}),s.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:Ge,onChange:e=>He(e.target.value)}),Ge&&s.jsx("button",{className:"text-xs text-blue-600 underline",onClick:()=>He(""),children:"クリア"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"状態"}),s.jsxs("select",{className:"border rounded px-2 py-1",value:We,onChange:e=>Ve(e.target.value),children:[s.jsx("option",{value:"all",children:"すべて"}),s.jsx("option",{value:"pending",children:"未確定"}),s.jsx("option",{value:"confirmed",children:"確定済み"})]})]})]}),s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-gray-50",children:[s.jsx("th",{className:"text-left px-3 py-2 border",children:"日付"}),s.jsx("th",{className:"text-left px-3 py-2 border",children:"予約者"}),s.jsx("th",{className:"text-left px-3 py-2 border",children:"席"}),s.jsx("th",{className:"text-left px-3 py-2 border",children:"予約時間"}),s.jsx("th",{className:"text-left px-3 py-2 border",children:"状態"}),s.jsx("th",{className:"text-left px-3 py-2 border",children:"操作"})]})}),s.jsx("tbody",{children:0===Ke.length?s.jsx("tr",{children:s.jsx("td",{colSpan:4,className:"px-3 py-4 border text-center text-gray-500",children:"予約はありません"})}):Ke.map((e,t)=>{return s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"px-3 py-2 border",children:e.reserved_date}),s.jsx("td",{className:"px-3 py-2 border",children:e.customer_name||"—"}),s.jsx("td",{className:"px-3 py-2 border",children:e.seat_code}),s.jsx("td",{className:"px-3 py-2 border",children:(a=e.start_time,a?String(a).slice(0,5):"")}),s.jsx("td",{className:"px-3 py-2 border",children:ls(e.status)}),s.jsx("td",{className:"px-3 py-2 border",children:"pending"===e.status?s.jsx(l,{size:"sm",onClick:()=>(e=>{ss(e),as(ke?qe||"ご予約を受け付けました。お気をつけてお越しください。":""),Ze(!0)})(e),children:"予約確定"}):s.jsx("span",{className:"text-gray-400",children:"—"})})]},t);var a})})]})})]}),s.jsx("div",{className:"text-xs text-gray-500",children:"営業日カレンダーで「営業日」のみ予約受付します。公開ページの施設詳細に予約ボタンを表示します。"})]}),Xe&&s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:s.jsxs("div",{className:"bg-white rounded-lg w-full max-w-md p-4",children:[s.jsx("h4",{className:"font-semibold mb-3",children:"予約を確定してメッセージ送信"}),s.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"予約者へ以下のメッセージを送信します。"}),s.jsx("textarea",{className:"w-full border rounded px-2 py-1 text-sm",rows:4,value:ts,onChange:e=>as(e.target.value),placeholder:"例: ご予約を受け付けました。お気をつけてお越しください。"}),s.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[s.jsx(l,{variant:"secondary",onClick:()=>{Ze(!1),as("")},children:"キャンセル"}),s.jsx(l,{onClick:async()=>{if(T&&es)try{is(!0);let s=!1;const t=await d.from("facility_reservations").update({status:"confirmed"}).eq("id",es.id).select("id,status").maybeSingle();if(!t.error&&t.data)s=!0;else try{s=(await fetch("/.netlify/functions/owner-confirm-reservation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reservationId:es.id})})).ok}catch{}if(!s)throw new Error("Failed to confirm reservation");Qe(e=>e.map(e=>e.id===es.id?{...e,status:"confirmed"}:e));const a=ts&&ts.trim().length>0?ts.trim():ke?qe||"ご予約を受け付けました。お気をつけてお越しください。":"";if(a){await d.from("community_messages").insert({user_id:v?.id,facility_id:T.id,content:a,context:"reservation"});try{(await d.from("notifications").insert({user_id:es.user_id,title:"予約受付が完了しました",message:`${T?.name||"店舗"}: ${a}`,link_url:`${window.location.origin}/my-reservations`,read:!1,type:"reservation_reminder",data:{}})).error&&await fetch("/.netlify/functions/app-notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:es.user_id,title:"予約受付が完了しました",message:`${T?.name||"店舗"}: ${a}`,linkUrl:`${window.location.origin}/my-reservations`,kind:"reservation"})})}catch{}try{const{notifyAppAndLine:s}=await e(async()=>{const{notifyAppAndLine:e}=await import("./notify-SwXPgyur.js");return{notifyAppAndLine:e}},__vite__mapDeps([0]));await s({userId:es.user_id,title:"予約受付が完了しました",message:`${T?.name||"店舗"}: ${a}`,linkUrl:`${window.location.origin}/my-reservations`,kind:"reservation"})}catch{}}const r=e=>{let s=d.from("facility_reservations").select(e?"id,user_id,customer_name,seat_code,reserved_date,start_time,end_time,status":"id,user_id,seat_code,reserved_date,start_time,end_time,status").eq("facility_id",T.id).order("reserved_date",{ascending:!0}).order("start_time",{ascending:!0});return Ge&&(s=s.eq("reserved_date",Ge)),"all"!==We&&(s=s.eq("status",We)),s};let i=await r(!0),l=i.data;if(i.error&&/customer_name/i.test(String(i.error.message))){l=(await r(!1)).data}Qe(l||[]),Ze(!1),ss(null),as(""),H("予約を確定し、メッセージを送信しました。")}catch(s){R("予約確定に失敗しました。")}finally{is(!1)}},isLoading:rs,children:"予約確定して送信"})]})]})}),"images"===ue&&s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[s.jsx(g,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設画像の管理"]}),s.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"施設の画像を管理します。最大5枚まで登録でき、最初の画像がメイン画像として使用されます。"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-4",children:[ee.map((e,t)=>s.jsxs("div",{className:"relative group",children:[s.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200",children:s.jsx("img",{src:e.image_url,alt:`施設画像 ${t+1}`,className:"w-full h-full object-cover"})}),s.jsx("div",{className:"absolute top-2 left-2",children:s.jsx("span",{className:"bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded",children:0===t?"メイン":t+1})}),s.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:s.jsxs("div",{className:"flex space-x-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:e=>ns(e,t),className:"hidden",id:`images-tab-replace-${t}`}),s.jsx("label",{htmlFor:`images-tab-replace-${t}`,className:"bg-white text-gray-600 p-1 rounded shadow hover:bg-gray-50 cursor-pointer",title:"画像を変更",children:s.jsx(g,{className:"w-4 h-4"})}),s.jsx("button",{type:"button",onClick:()=>cs(e.id),className:"bg-red-500 text-white p-1 rounded shadow hover:bg-red-600",title:"画像を削除",children:s.jsx(N,{className:"w-4 h-4"})})]})})]},e.id)),ee.length<5&&s.jsxs("div",{className:"aspect-square bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:e=>ns(e),className:"hidden",id:"images-tab-add"}),s.jsxs("label",{htmlFor:"images-tab-add",className:"flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600",children:[s.jsx(p,{className:"w-8 h-8 mb-2"}),s.jsx("span",{className:"text-sm font-medium",children:"画像を追加"})]})]})]}),0===ee.length&&s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx(q,{className:"w-12 h-12 mx-auto mb-3 text-gray-400"}),s.jsx("p",{className:"text-sm",children:"まだ画像がアップロードされていません"}),s.jsx("p",{className:"text-xs mt-1",children:"最初の画像がメイン画像として使用されます"})]})]}),"coupons"===ue&&T&&s.jsx("div",{children:s.jsx(O,{facilityId:T.id,facilityName:T.name})}),"schedule"===ue&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[s.jsx(f,{className:"w-6 h-6 text-blue-600 mr-2"}),"営業日管理"]}),s.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"施設の営業時間と休業日を設定できます。"})]}),s.jsxs(n,{className:"p-6",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(D,{className:"w-5 h-5 text-green-600 mr-2"}),"営業時間"]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"開店時間"}),s.jsx("input",{type:"time",value:Te,onChange:e=>Ae(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"閉店時間"}),s.jsx("input",{type:"time",value:Me,onChange:e=>Pe(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]})]}),s.jsxs(n,{className:"p-6",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(f,{className:"w-5 h-5 text-red-600 mr-2"}),"定休日設定"]}),s.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"毎週の定休日を設定してください。選択した曜日は自動的にカレンダーでも休業日として表示されます。"}),s.jsx("div",{className:"grid grid-cols-7 gap-2",children:["日","月","火","水","木","金","土"].map((e,t)=>s.jsxs("button",{onClick:()=>{const e=[...Le];e[t]=!e[t],Ie(e)},className:"py-3 px-2 text-sm font-medium rounded-lg border-2 transition-colors "+(Le[t]?"bg-red-100 border-red-300 text-red-700":"bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100"),children:[e,Le[t]&&s.jsx("div",{className:"text-xs mt-1",children:"定休日"})]},t))})]}),s.jsxs(n,{className:"p-6",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(f,{className:"w-5 h-5 text-blue-600 mr-2"}),"休業日カレンダー"]}),s.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"特定の日付をクリックして臨時休業日を設定できます。定休日設定で選択した曜日は自動的に表示されます。"}),(()=>{const e=[];for(let s=0;s<3;s++){const t=new Date(Je.getFullYear(),Je.getMonth()+s,1),a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,0).getDate(),i=a.getDay(),l=[];for(let e=0;e<i;e++)l.push(null);for(let e=1;e<=r;e++)l.push(new Date(t.getFullYear(),t.getMonth(),e));const d=[];for(let e=0;e<l.length;e+=7)d.push(l.slice(e,e+7));e.push({month:t,rows:d})}return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(l,{onClick:()=>Re(new Date(Je.getFullYear(),Je.getMonth()-1,1)),variant:"outline",size:"sm",children:[s.jsx(F,{className:"w-4 h-4"}),"前月"]}),s.jsxs("span",{className:"text-lg font-semibold",children:[Je.getFullYear(),"年",Je.getMonth()+1,"月から",3,"か月分"]}),s.jsxs(l,{onClick:()=>Re(new Date(Je.getFullYear(),Je.getMonth()+1,1)),variant:"outline",size:"sm",children:["次月",s.jsx(E,{className:"w-4 h-4"})]})]}),s.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:e.map((e,t)=>s.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[s.jsxs("h4",{className:"text-center font-semibold mb-4",children:[e.month.getFullYear(),"年",e.month.getMonth()+1,"月"]}),s.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["日","月","火","水","木","金","土"].map((e,t)=>s.jsx("div",{className:"text-center text-xs font-medium py-1 "+(0===t?"text-red-500":6===t?"text-blue-500":"text-gray-600"),children:e},e))}),s.jsx("div",{className:"space-y-1",children:e.rows.map((e,a)=>s.jsx("div",{className:"grid grid-cols-7 gap-1",children:e.map((e,r)=>{if(!e)return s.jsx("div",{className:"h-8"},`empty-${t}-${a}-${r}`);const i=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,l=e.getDay(),d=Le[l],n=Ue.includes(i),c=ze.includes(i),o=(new Date).toDateString()===e.toDateString(),m=e<new Date((new Date).setHours(0,0,0,0));return s.jsx("button",{onClick:()=>{m||(d?Be(c?e=>e.filter(e=>e!==i):e=>[...e,i]):Ye(n?e=>e.filter(e=>e!==i):e=>[...e,i]))},disabled:m,className:"h-8 text-xs rounded transition-colors "+(m?"text-gray-300 cursor-not-allowed":d&&!c?"bg-red-100 border-red-300 text-red-700 border":n?"bg-orange-100 border-orange-300 text-orange-700 border":o?"bg-blue-100 border-blue-300 text-blue-700 border font-bold":"bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100 border"),children:e.getDate()},i)})},a))})]},t))}),s.jsxs("div",{className:"flex flex-wrap gap-4 text-xs",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-red-100 border border-red-300 rounded"}),s.jsx("span",{children:"定休日"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-orange-100 border border-orange-300 rounded"}),s.jsx("span",{children:"特定休業日"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-blue-100 border border-blue-300 rounded"}),s.jsx("span",{children:"今日"})]})]})]})})()]}),s.jsx("div",{className:"flex justify-end space-x-3",children:s.jsxs(l,{onClick:async()=>{if(T)try{B(!0),R(""),H("");const{error:e}=await d.from("pet_facilities").update({opening_time:Te,closing_time:Me,weekly_closed_days:Le,specific_closed_dates:Ue,specific_open_dates:ze,updated_at:(new Date).toISOString()}).eq("id",T.id);if(e)throw e;H("営業日設定が保存されました。"),setTimeout(()=>H(""),3e3)}catch(e){R(e instanceof Error?e.message:"営業日設定の保存に失敗しました。")}finally{B(!1)}},className:"bg-green-600 hover:bg-green-700",children:[s.jsx(b,{className:"w-4 h-4 mr-2"}),"営業日設定を保存"]})})]}),"location"===ue&&s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[s.jsx(C,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設の位置調整"]}),s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:s.jsxs("p",{className:"text-blue-800 text-sm",children:[s.jsx("strong",{children:"位置調整について:"}),s.jsx("br",{}),"住所から自動的にマップ上の位置を特定しますが、正確でない場合があります。",s.jsx("br",{}),"赤いマーカーをドラッグして、実際の施設位置に調整してください。"]})}),s.jsx(h,{initialAddress:oe.address,initialLatitude:oe.latitude||void 0,initialLongitude:oe.longitude||void 0,onLocationChange:(e,s,t)=>{me(a=>({...a,latitude:e,longitude:s,...t&&t!==a.address?{address:t}:{}}))}}),s.jsx("div",{className:"flex justify-end",children:s.jsx(l,{type:"button",onClick:ms,disabled:z||!oe.latitude||!oe.longitude,className:"min-w-[120px]",children:z?s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"保存中..."]}):"位置を保存"})})]})]})]})]}),"info"===ue&&"approved"===T?.status&&s.jsxs(n,{className:"p-6",children:[s.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[s.jsx(y,{className:"w-6 h-6 text-blue-600 mr-2"}),"公開設定"]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"font-medium text-gray-900 mb-1",children:"施設の公開状態"}),s.jsx("p",{className:"text-sm text-gray-600",children:"公開設定を切り替えることで、施設を一覧に表示するかどうかを制御できます。"})]}),s.jsx("div",{className:"ml-4",children:s.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:oe.is_public,onChange:e=>(async e=>{if(j&&v)try{he(!0),R("");const{error:s}=await d.from("pet_facilities").update({is_public:e,updated_at:(new Date).toISOString()}).eq("id",j).eq("owner_id",v?.id);if(s)throw s;me(s=>({...s,is_public:e})),A(s=>s?{...s,is_public:e}:null),H(e?"施設を公開しました":"施設を非公開にしました"),setTimeout(()=>H(""),3e3)}catch(s){R("公開設定の更新に失敗しました: "+s.message)}finally{he(!1)}})(e.target.checked),disabled:xe,className:"sr-only peer"}),s.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})})]}),s.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[s.jsx("div",{className:"w-3 h-3 rounded-full "+(oe.is_public?"bg-green-500":"bg-yellow-500")}),s.jsx("span",{className:"font-medium",children:oe.is_public?"公開中":"非公開"})]}),!oe.is_public&&s.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:s.jsxs("div",{className:"flex items-start",children:[s.jsx($,{className:"w-5 h-5 text-yellow-600 mt-0.5 mr-2"}),s.jsxs("div",{className:"text-sm text-yellow-800",children:[s.jsx("strong",{children:"注意:"})," 非公開設定中は、施設が一覧に表示されず、新しい利用者からの予約を受け付けできません。"]})]})})]})]}),"info"===ue&&s.jsx(n,{className:"p-6 border-red-200 bg-red-50",children:s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx(N,{className:"w-6 h-6 text-red-600 mt-1"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"font-semibold text-red-900 mb-2",children:"危険な操作"}),s.jsxs("p",{className:"text-sm text-red-800 mb-4",children:["この施設を完全に削除します。削除後はデータの復旧はできません。","approved"===T.status&&s.jsx("span",{className:"block mt-1 font-medium",children:"※ 承認済みの施設を削除すると、公開ページからも削除されます。"})]}),s.jsxs(l,{onClick:()=>V(!0),className:"bg-red-600 hover:bg-red-700 text-white",size:"sm",children:[s.jsx(N,{className:"w-4 h-4 mr-2"}),"施設を削除"]})]})]})}),W&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[s.jsxs("div",{className:"flex items-center mb-4",children:[s.jsx(N,{className:"w-6 h-6 text-red-600 mr-3"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"施設の削除確認"})]}),s.jsxs("div",{className:"mb-4",children:[s.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[s.jsx("span",{className:"font-medium text-red-600",children:"警告:"})," この操作は取り消せません。"]}),s.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["削除を実行するには、施設名「",s.jsx("span",{className:"font-medium",children:T.name}),"」を入力してください。"]}),s.jsx("input",{type:"text",value:K,onChange:e=>Q(e.target.value),placeholder:"施設名を入力",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsx(l,{onClick:()=>{V(!1),Q("")},variant:"secondary",disabled:X,children:"キャンセル"}),s.jsxs(l,{onClick:async()=>{if(T&&K===T.name){if(window.confirm("本当にこの施設を完全に削除しますか？\nこの操作は取り消せません。"))try{Z(!0),R("");const{data:s}=await d.from("profiles").select("role").eq("id",v?.id).single();try{await d.from("pet_facility_images").delete().eq("facility_id",T.id)}catch(e){}let t=d.from("pet_facilities").delete();t="admin"===s?.role?t.eq("id",T.id):t.eq("id",T.id).eq("owner_id",v?.id);const{error:a}=await t;if(a){if(a.message?.includes("RLS"))throw new Error("権限エラー: この施設を削除する権限がありません。管理者にお問い合わせください。");throw new Error(`削除処理エラー: ${a.message}`)}const{data:r,error:i}=await d.from("pet_facilities").select("id").eq("id",T.id).single();if(r){if("admin"!==s?.role)throw new Error("削除する施設が見つからない、または削除権限がありません。");{const{error:e}=await d.rpc("force_delete_facility",{target_facility_id:T.id});if(e)throw new Error(`削除に失敗しました。データベース管理者にお問い合わせください。エラー: ${e.message}`);const{data:s}=await d.from("pet_facilities").select("id").eq("id",T.id).single();if(s)throw new Error("施設の削除に失敗しました。データベース管理者にお問い合わせください。")}}else if(i&&"PGRST116"!==i.code)throw new Error(`削除検証でエラーが発生しました: ${i.message}`);H("施設が正常に削除されました。"),setTimeout(()=>{I("/my-facilities-management")},3e3)}catch(s){R(`削除処理でエラーが発生しました: ${s.message}`)}finally{Z(!1),V(!1),Q("")}}else R("施設名が正しく入力されていません。")},className:"bg-red-600 hover:bg-red-700 text-white",disabled:X||K!==T.name,isLoading:X,children:[s.jsx(N,{className:"w-4 h-4 mr-2"}),"削除実行"]})]})]})}),te&&re&&s.jsx(m,{imageFile:re,onCropComplete:async e=>{if(T)try{ce(!0),R("");const s=Date.now(),t=`facility_${T.id}_${s}.jpg`,{data:a,error:r}=await d.storage.from("vaccine-certs").upload(t,e,{contentType:"image/jpeg",upsert:!0});if(r)throw r;const{data:i}=d.storage.from("vaccine-certs").getPublicUrl(t),l=i.publicUrl;if(null===le){const{data:e,error:s}=await d.from("pet_facility_images").select("display_order").eq("facility_id",T.id).order("display_order",{ascending:!1}).limit(1);if(s)throw s;const t=e.length>0?e[0].display_order+1:0,a=0===t?"main":"additional",{data:r,error:i}=await d.from("pet_facility_images").insert({facility_id:T.id,image_url:l,image_type:a,display_order:t}).select().single();if(i)throw i;se(e=>[...e,r].sort((e,s)=>e.display_order-s.display_order))}else{const e=ee[le],{data:s,error:t}=await d.from("pet_facility_images").update({image_url:l,updated_at:(new Date).toISOString()}).eq("id",e.id).select().single();if(t)throw t;se(e=>e.map(e=>e.id===s.id?s:e))}H("画像がアップロードされました。"),setTimeout(()=>H(""),3e3)}catch(s){R("画像のアップロードに失敗しました。")}finally{ce(!1),ae(!1),ie(null),de(null)}},onCancel:()=>{ae(!1),ie(null),de(null)},aspectRatio:1,maxWidth:400,maxHeight:400})]})]})]})}export{I as default};
