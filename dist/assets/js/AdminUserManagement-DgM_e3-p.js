import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{a as t,L as a}from"./router-9ZtQ8-Nn.js";import{B as r}from"./Button-CIw720PF.js";import{C as i}from"./Card-roTxPFVC.js";import{I as l}from"./Input-Cfvf556r.js";import{u as c,s as n}from"./index-Dm33kIpv.js";import{b as d}from"./adminFraudDetection-eV8RgsgD.js";import{c as m,Y as x,U as o,o as u,v as h,C as j,r as p,aQ as g,aD as f,m as v,p as N,X as y,aR as b,a6 as _,aS as w,aT as k,aB as S}from"./ui-basic-BFc3AvhI.js";import"./supabase-hyP6cfTu.js";import"./heavy-features-BIdEME4r.js";function D(){const{isAdmin:D}=c(),C=t(),[U,L]=s.useState([]),[A,I]=s.useState([]),[P,R]=s.useState(!0),[q,E]=s.useState(""),[J,z]=s.useState(""),[F,B]=s.useState("all"),[T,M]=s.useState("created_at"),[H,O]=s.useState("desc"),[Q,Y]=s.useState(!1),[$,G]=s.useState(null),[K,V]=s.useState(!1);s.useEffect(()=>{D?W():C("/")},[D,C]),s.useEffect(()=>{X()},[U,J,F,T,H]);const W=async()=>{try{R(!0),E("");const{data:e,error:s}=await n.from("profiles").select("\n          id,\n          name,\n          user_type,\n          postal_code,\n          address,\n          phone_number,\n          created_at\n        ");if(s)throw new Error("プロファイル情報の取得に失敗しました");if(!e||0===e.length)return void L([]);const{data:t,error:a}=await n.from("fraud_detection_logs").select("\n          user_id,\n          risk_score,\n          detection_type,\n          created_at\n        ").order("created_at",{ascending:!1}),r=new Map;t&&!a&&t.forEach(e=>{const s=r.get(e.user_id);s?r.set(e.user_id,{maxRiskScore:Math.max(s.maxRiskScore,e.risk_score),detectionCount:s.detectionCount+1}):r.set(e.user_id,{maxRiskScore:e.risk_score,detectionCount:1})});const i=e.map(async e=>{try{const{count:s}=await n.from("dogs").select("id",{count:"exact"}).eq("owner_id",e.id),t=new Date;t.setDate(1),t.setHours(0,0,0,0);const{count:a}=await n.from("reservations").select("id",{count:"exact"}).eq("user_id",e.id).gte("created_at",t.toISOString()),{data:i}=await n.from("subscriptions").select("status").eq("user_id",e.id).eq("status","active").single(),{data:l}=await n.from("reservations").select("total_amount").eq("user_id",e.id).eq("status","confirmed"),c=l?.reduce((e,s)=>e+(s.total_amount||0),0)||0,d=r.get(e.id);let m="low";return d&&(d.maxRiskScore>=70?m="high":d.maxRiskScore>=50&&(m="medium")),{id:e.id,name:e.name||"Unknown",email:"N/A",phone:e.phone_number,created_at:e.created_at,last_sign_in_at:void 0,is_active:!0,subscription_status:i?"active":"inactive",dog_count:s||0,reservation_count:a||0,total_spent:c,fraud_risk_score:d?.maxRiskScore||0,fraud_risk_level:m,fraud_detection_count:d?.detectionCount||0}}catch(s){return null}}),l=(await Promise.allSettled(i)).filter(e=>"fulfilled"===e.status&&null!==e.value).map(e=>e.value);L(l)}catch(e){E(e instanceof Error?e.message:"ユーザー情報の取得に失敗しました")}finally{R(!1)}},X=()=>{let e=U.filter(e=>{const s=e.name.toLowerCase().includes(J.toLowerCase())||e.email.toLowerCase().includes(J.toLowerCase()),t=(()=>{switch(F){case"active":return e.is_active;case"inactive":return!e.is_active;case"subscribers":return"active"===e.subscription_status;case"high_risk":return"high"===e.fraud_risk_level;case"medium_risk":return"medium"===e.fraud_risk_level;default:return!0}})();return s&&t});e.sort((e,s)=>{let t,a;switch(T){case"name":t=e.name,a=s.name;break;case"created_at":t=new Date(e.created_at),a=new Date(s.created_at);break;case"last_sign_in_at":t=e.last_sign_in_at?new Date(e.last_sign_in_at):new Date(0),a=s.last_sign_in_at?new Date(s.last_sign_in_at):new Date(0);break;case"total_spent":t=e.total_spent,a=s.total_spent;break;case"fraud_risk_score":t=e.fraud_risk_score||0,a=s.fraud_risk_score||0;break;default:t=e.created_at,a=s.created_at}return t<a?"asc"===H?-1:1:t>a?"asc"===H?1:-1:0}),I(e)},Z=(s,t,a)=>{if(0===a)return null;switch(s){case"high":return e.jsxs("span",{className:"inline-flex items-center px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full",children:[e.jsx(S,{className:"w-3 h-3 mr-1"}),"高リスク (",t,")"]});case"medium":return e.jsxs("span",{className:"inline-flex items-center px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full",children:[e.jsx(u,{className:"w-3 h-3 mr-1"}),"中リスク (",t,")"]});default:return e.jsxs("span",{className:"inline-flex items-center px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full",children:[e.jsx(k,{className:"w-3 h-3 mr-1"}),"低リスク (",t,")"]})}};return D?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(a,{to:"/admin",children:e.jsxs(r,{variant:"secondary",size:"sm",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボード"]})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center",children:[e.jsx(o,{className:"w-8 h-8 text-blue-600 mr-3"}),"ユーザー管理"]}),e.jsx("p",{className:"text-gray-600",children:"ユーザー情報と不正検知状況の管理"})]})]})})})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[q&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 mb-6",children:[e.jsx(u,{className:"w-5 h-5 inline mr-2"}),q]}),e.jsx(i,{className:"p-6 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"検索"}),e.jsxs("div",{className:"relative",children:[e.jsx(h,{className:"w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"}),e.jsx(l,{type:"text",placeholder:"名前またはメールで検索",value:J,onChange:e=>z(e.target.value),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"フィルター"}),e.jsxs("select",{value:F,onChange:e=>B(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"active",children:"アクティブ"}),e.jsx("option",{value:"inactive",children:"非アクティブ"}),e.jsx("option",{value:"subscribers",children:"サブスクリプション"}),e.jsx("option",{value:"high_risk",children:"高リスクユーザー"}),e.jsx("option",{value:"medium_risk",children:"中リスクユーザー"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ソート"}),e.jsxs("select",{value:T,onChange:e=>M(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"created_at",children:"登録日"}),e.jsx("option",{value:"name",children:"名前"}),e.jsx("option",{value:"total_spent",children:"支払い合計"}),e.jsx("option",{value:"fraud_risk_score",children:"リスクスコア"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"順序"}),e.jsxs("select",{value:H,onChange:e=>O(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"desc",children:"降順"}),e.jsx("option",{value:"asc",children:"昇順"})]})]})]})}),P?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsx(i,{children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録情報"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"利用状況"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"不正検知"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"アクション"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:A.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(o,{className:"w-5 h-5 text-blue-600"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name}),e.jsx("div",{className:"text-sm text-gray-500",children:s.email})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm text-gray-900",children:[e.jsxs("div",{className:"flex items-center mb-1",children:[e.jsx(j,{className:"w-4 h-4 text-gray-400 mr-1"}),new Date(s.created_at).toLocaleDateString("ja-JP")]}),s.phone&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"w-4 h-4 text-gray-400 mr-1"}),s.phone]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm text-gray-900",children:[e.jsxs("div",{className:"flex items-center mb-1",children:[e.jsx(g,{className:"w-4 h-4 text-gray-400 mr-1"}),s.dog_count,"匹"]}),e.jsxs("div",{className:"flex items-center mb-1",children:[e.jsx(j,{className:"w-4 h-4 text-gray-400 mr-1"}),s.reservation_count,"件"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{className:"w-4 h-4 text-gray-400 mr-1"}),"¥",s.total_spent.toLocaleString()]})]}),"active"===s.subscription_status&&e.jsxs("span",{className:"inline-flex items-center px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full mt-1",children:[e.jsx(v,{className:"w-3 h-3 mr-1"}),"サブスクリプション"]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1",children:[Z(s.fraud_risk_level||"low",s.fraud_risk_score||0,s.fraud_detection_count||0),(s.fraud_detection_count||0)>0&&e.jsxs("div",{className:"text-xs text-gray-500",children:["検知回数: ",s.fraud_detection_count,"回"]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(a,{to:`/admin/users/${s.id}`,children:e.jsxs(r,{variant:"secondary",size:"sm",children:[e.jsx(N,{className:"w-4 h-4 mr-1"}),"詳細"]})}),(s.fraud_detection_count||0)>0&&e.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>(async e=>{V(!0),Y(!0);try{const s=await d(e);G(s)}catch(s){}finally{V(!1)}})(s.id),className:"text-red-600 hover:text-red-800",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"不正検知"]})]})})]},s.id))})]}),0===A.length&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(o,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"ユーザーが見つかりません"}),e.jsx("p",{className:"text-gray-600",children:"検索条件を変更してお試しください。"})]})]})}),Q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[e.jsx(m,{className:"w-6 h-6 text-red-600 mr-2"}),"不正検知詳細情報"]}),e.jsx("button",{onClick:()=>Y(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(y,{className:"w-6 h-6"})})]}),K?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):$?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-md font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(b,{className:"w-5 h-5 text-blue-600 mr-2"}),"デバイス情報"]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:$.deviceFingerprints.length>0?e.jsx("div",{className:"space-y-3",children:$.deviceFingerprints.slice(0,3).map((s,t)=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:["フィンガープリント: ",s.fingerprint.substring(0,16),"..."]}),e.jsxs("div",{className:"text-gray-600",children:["IP: ",s.ipAddress]}),e.jsxs("div",{className:"text-gray-600",children:["ユーザーエージェント: ",s.userAgent.substring(0,50),"..."]}),e.jsxs("div",{className:"text-gray-600",children:["日時: ",new Date(s.createdAt).toLocaleString("ja-JP")]})]},t))}):e.jsx("p",{className:"text-gray-500",children:"デバイス情報がありません"})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-md font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(u,{className:"w-5 h-5 text-orange-600 mr-2"}),"不正検知ログ"]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:$.fraudLogs.length>0?e.jsx("div",{className:"space-y-3",children:$.fraudLogs.map((s,t)=>e.jsxs("div",{className:"text-sm border-b border-gray-200 pb-2 last:border-b-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-red-600",children:s.detectionType}),e.jsxs("span",{className:"text-gray-600",children:["リスクスコア: ",s.riskScore]})]}),e.jsxs("div",{className:"text-gray-600",children:["対応: ",s.actionTaken]}),e.jsxs("div",{className:"text-gray-600",children:["日時: ",new Date(s.createdAt).toLocaleString("ja-JP")]})]},t))}):e.jsx("p",{className:"text-gray-500",children:"不正検知ログがありません"})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-md font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(_,{className:"w-5 h-5 text-green-600 mr-2"}),"カード使用履歴"]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:$.cardUsage.length>0?e.jsx("div",{className:"space-y-3",children:$.cardUsage.map((s,t)=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:["カード: ",s.cardFingerprint.substring(0,16),"..."]}),e.jsxs("div",{className:"text-gray-600",children:["トライアル利用: ",s.trialUsed?"あり":"なし",s.trialUsed&&s.trialUsedAt&&e.jsxs("span",{className:"ml-2",children:["(",new Date(s.trialUsedAt).toLocaleDateString("ja-JP"),")"]})]}),e.jsxs("div",{className:"text-gray-600",children:["登録日: ",new Date(s.createdAt).toLocaleString("ja-JP")]})]},t))}):e.jsx("p",{className:"text-gray-500",children:"カード使用履歴がありません"})})]}),($.duplicateDeviceUsers.length>0||$.duplicateIpUsers.length>0)&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-md font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(w,{className:"w-5 h-5 text-purple-600 mr-2"}),"重複検知"]}),e.jsxs("div",{className:"bg-red-50 rounded-lg p-4",children:[$.duplicateDeviceUsers.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"font-medium text-red-800",children:"同一デバイス使用者:"}),e.jsxs("div",{className:"text-sm text-red-700",children:[$.duplicateDeviceUsers.length,"人のユーザーが同じデバイスを使用"]})]}),$.duplicateIpUsers.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-red-800",children:"同一IP使用者:"}),e.jsxs("div",{className:"text-sm text-red-700",children:[$.duplicateIpUsers.length,"人のユーザーが同じIPアドレスを使用"]})]})]})]})]}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"不正検知情報の取得に失敗しました"})}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx(r,{onClick:()=>Y(!1),children:"閉じる"})})]})})]})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs(i,{className:"p-8 text-center",children:[e.jsx(m,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"アクセス拒否"}),e.jsx("p",{className:"text-gray-600",children:"管理者権限が必要です。"})]})})}export{D as AdminUserManagement};
