import{j as e}from"./motion-BHsL7Azw.js";import{r as t}from"./react-vendor-CMvmJHsS.js";import{L as s,a}from"./router-DXQOdrLL.js";import{B as n,u as r,s as i,a as l}from"./index-DnZPHkpI.js";import{i as c,t as o,M as d,N as x,u as m,U as u,v as h,w as g,X as p,d as f,x as y,y as b,G as j,s as v,h as N,z as w,H as _,k,I as C,J as M,q as S,R as $}from"./ui-basic-9Ga9r2kc.js";import{C as P}from"./Card-DqVnP9TA.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";const I=e=>e<1?`${Math.round(1e3*e)}m`:`${e.toFixed(1)}km`;function E({park:t,userLocation:a,distance:r}){const i=r||(a&&t.latitude&&t.longitude?((e,t,s,a)=>{const n=(s-e)*Math.PI/180,r=(a-t)*Math.PI/180,i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371})(a.lat,a.lng,Number(t.latitude),Number(t.longitude)):null),l=(()=>{if(!t.current_occupancy||!t.max_capacity)return{label:"情報なし",color:"text-gray-500",bgColor:"bg-gray-100"};const e=t.current_occupancy/t.max_capacity*100;return e>=90?{label:"満員",color:"text-red-600",bgColor:"bg-red-100"}:e>=70?{label:"混雑",color:"text-orange-600",bgColor:"bg-orange-100"}:e>=40?{label:"普通",color:"text-yellow-600",bgColor:"bg-yellow-100"}:{label:"空いている",color:"text-green-600",bgColor:"bg-green-100"}})();return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[t.image_url&&e.jsxs("div",{className:"aspect-square relative overflow-hidden rounded-t-lg",children:[e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}),e.jsx("button",{className:"absolute top-3 right-3 p-2 bg-white/80 backdrop-blur-sm rounded-full hover:bg-white transition-colors",onClick:e=>{e.preventDefault(),e.stopPropagation()},children:e.jsx(c,{className:"w-4 h-4 text-gray-600 hover:text-red-500"})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900 flex-1",children:t.name}),e.jsx("div",{className:"flex items-center space-x-2 ml-2",children:e.jsxs("span",{className:"flex items-center text-green-600 text-sm",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),"営業中"]})})]}),e.jsxs("div",{className:"space-y-2 mb-2",children:[t.address&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm",children:[e.jsx(d,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:t.address})]}),i&&e.jsxs("div",{className:"flex items-center text-blue-600 text-sm font-medium",children:[e.jsx(x,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["現在地から ",I(i)]})]})]}),t.price&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-3",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["¥",t.price,"/時間"]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(u,{className:"w-4 h-4 mr-1 text-gray-600"}),e.jsx("span",{className:"text-sm text-gray-600",children:"混雑状況:"})]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${l.color} ${l.bgColor}`,children:l.label})]}),void 0!==t.current_occupancy&&t.max_capacity&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-1",children:[e.jsx("span",{children:"現在の利用者"}),e.jsxs("span",{children:[t.current_occupancy," / ",t.max_capacity,"名"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"h-2 rounded-full transition-all duration-300 "+(t.current_occupancy/t.max_capacity>=.9?"bg-red-500":t.current_occupancy/t.max_capacity>=.7?"bg-orange-500":t.current_occupancy/t.max_capacity>=.4?"bg-yellow-500":"bg-green-500"),style:{width:`${Math.min(t.current_occupancy/t.max_capacity*100,100)}%`}})})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(s,{to:`/parks/${t.id}`,className:"flex-1",children:e.jsxs(n,{variant:"outline",className:"w-full flex items-center justify-center",children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),"詳細を見る"]})}),t.current_occupancy<t.max_capacity&&e.jsx(s,{to:`/reservation/${t.id}`,className:"flex-1",children:e.jsx(n,{className:"w-full",children:"予約する"})})]})]})]})}function L({icon:t,title:s,description:a,action:r,className:i=""}){return e.jsxs("div",{className:`flex flex-col items-center justify-center py-12 px-4 text-center ${i}`,children:[e.jsx("div",{className:"mb-4 text-gray-400",children:t||e.jsx(g,{className:"w-16 h-16"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:s}),a&&e.jsx("p",{className:"text-gray-600 max-w-md mb-6",children:a}),r&&e.jsx(n,{onClick:r.onClick,variant:"outline",children:r.label})]})}function D({userCoupon:s,onClose:a,onUse:n}){const[r,i]=t.useState(""),[l,c]=t.useState(!1),o=t.useRef(null),{coupon:x}=s;t.useEffect(()=>{if(c(!0),o.current){o.current.style.userSelect="none",o.current.style.webkitUserSelect="none",o.current.style.pointerEvents="none";const e=e=>"PrintScreen"===e.key?(e.preventDefault(),alert("スクリーンショットは禁止されています。店員にこの画面を直接お見せください。"),!1):e.ctrlKey&&e.shiftKey&&"I"===e.key||"F12"===e.key||e.ctrlKey&&"s"===e.key?(e.preventDefault(),!1):void 0;document.addEventListener("keydown",e);const t=e=>(e.preventDefault(),!1);return document.addEventListener("contextmenu",t),()=>{document.removeEventListener("keydown",e),document.removeEventListener("contextmenu",t)}}},[]),t.useEffect(()=>{const e=()=>{const e=(new Date).getTime(),t=new Date(x.end_date).getTime()-e;if(t>0){const e=Math.floor(t/864e5),s=Math.floor(t%864e5/36e5),a=Math.floor(t%36e5/6e4);i(e>0?`${e}日${s}時間${a}分`:s>0?`${s}時間${a}分`:`${a}分`)}else i("有効期限切れ")};e();const t=setInterval(e,6e4);return()=>clearInterval(t)},[x.end_date]);const m=()=>x.discount_value?"percentage"===x.discount_type?`${x.discount_value}% OFF`:`${x.discount_value.toLocaleString()}円 OFF`:"";return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{ref:o,className:"bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden",style:{filter:l?"none":"blur(5px)",WebkitFilter:l?"none":"blur(5px)"},children:[e.jsxs("div",{className:"bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6 relative",children:[e.jsx("button",{onClick:a,className:"absolute top-4 right-4 text-white hover:text-gray-200 pointer-events-auto",children:e.jsx(p,{className:"w-6 h-6"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"ドッグパークJP"}),e.jsx("h2",{className:"text-xl font-medium",children:"クーポン"})]}),e.jsxs("div",{className:"flex items-center justify-center mt-4 bg-black bg-opacity-20 rounded-lg p-2",children:[e.jsx(f,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"text-sm",children:"スクリーンショット禁止"})]})]}),x.coupon_image_url&&e.jsx("div",{className:"aspect-[16/9] bg-gray-100",children:e.jsx("img",{src:x.coupon_image_url,alt:"クーポン画像",className:"w-full h-full object-cover",style:{userSelect:"none",pointerEvents:"none"}})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",children:x.title}),m()&&e.jsx("div",{className:"text-3xl font-extrabold text-red-600 mb-2",children:m()})]}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(y,{className:"w-5 h-5 text-yellow-500 mr-2 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:"サービス内容"}),e.jsx("p",{className:"text-gray-700 text-sm",children:x.service_content})]})]})}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(d,{className:"w-5 h-5 text-gray-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:"利用可能店舗"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"対象施設"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(b,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"有効期限："}),e.jsx("span",{className:"text-gray-600 ml-1",children:new Date(x.end_date).toLocaleDateString("ja-JP")}),r&&e.jsxs("span",{className:"text-sm text-red-600 ml-2",children:["(残り",r,")"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"使用制限："}),e.jsx("span",{className:"text-gray-600 ml-1",children:"once"===x.usage_limit_type?"1回限り":"何回でも"})]})]}),x.description&&e.jsx("div",{className:"bg-gray-50 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-gray-600",children:x.description})}),e.jsx("div",{className:"text-center",children:s.is_used?e.jsxs("div",{className:"bg-gray-100 text-gray-600 py-3 px-4 rounded-lg",children:[e.jsx("p",{className:"font-semibold",children:"使用済み"}),e.jsx("p",{className:"text-sm",children:s.used_at&&new Date(s.used_at).toLocaleString("ja-JP")})]}):e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-green-800 font-semibold mb-2",children:"使用可能"}),e.jsx("p",{className:"text-green-700 text-sm mb-3",children:"この画面を店員さんにお見せください"}),"once"===x.usage_limit_type&&e.jsx("p",{className:"text-red-600 text-xs",children:"※このクーポンは1回限りです。使用後は表示できなくなります。"})]})}),e.jsxs("div",{className:"text-center text-xs text-gray-500 mt-4",children:["ID: ",s.qr_code_token.substring(0,8),"..."]})]}),e.jsxs("div",{className:"bg-gray-50 px-6 py-4 text-center",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["※このクーポンは","once"===x.usage_limit_type?"一度":"何度でも","ご利用いただけます"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"※有効期限をお確かめの上ご利用ください"})]})]})})}const F={veterinary_clinic:{icon:M,label:"動物病院",color:"text-red-600"},pet_friendly_restaurant:{icon:C,label:"ペット同伴レストラン",color:"text-orange-600"},pet_shop:{icon:k,label:"ペットショップ",color:"text-blue-600"},pet_friendly_hotel:{icon:_,label:"ペット同伴宿泊",color:"text-green-600"},pet_salon:{icon:N,label:"ペットサロン",color:"text-purple-600"},pet_hotel:{icon:w,label:"ペットホテル",color:"text-indigo-600"},other:{icon:N,label:"その他",color:"text-gray-600"}};function z({facility:a,showDistance:l,distance:o}){const{user:m}=r(),[u,g]=t.useState([]),[p,f]=t.useState([]),[N,w]=t.useState(!1),[_,k]=t.useState(null);t.useEffect(()=>{m&&C()},[m,a.id]);const C=async()=>{try{const{data:e,error:t}=await i.from("facility_coupons").select("*").eq("facility_id",a.id).eq("is_active",!0).lte("start_date",(new Date).toISOString()).gte("end_date",(new Date).toISOString());if(t)throw t;if(g(e||[]),m){const{data:t,error:s}=await i.from("user_coupons").select("\n            *,\n            coupon:facility_coupons(*)\n          ").eq("user_id",m.id).in("coupon_id",(e||[]).map(e=>e.id));if(s)throw s;f(t||[])}}catch(e){}},M=(S=a.category)&&S in F?F[S]:F.other;var S;const $=M.icon,P=(()=>{const e=new Date,t=100*e.getHours()+e.getMinutes();if(a.opening_hours&&a.closing_hours){const e=parseInt(a.opening_hours.replace(":",""),10),s=parseInt(a.closing_hours.replace(":",""),10);return t>=e&&t<=s}return null})();return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[a.image_url&&e.jsxs("div",{className:"aspect-square relative overflow-hidden rounded-t-lg",children:[e.jsx("img",{src:a.image_url,alt:a.name,className:"w-full h-full object-cover",loading:"lazy"}),e.jsx("button",{className:"absolute top-3 right-3 p-2 bg-white/80 backdrop-blur-sm rounded-full hover:bg-white transition-colors",onClick:e=>{e.preventDefault(),e.stopPropagation()},children:e.jsx(c,{className:"w-4 h-4 text-gray-600 hover:text-red-500"})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($,{className:`w-5 h-5 ${M.color}`}),e.jsx("span",{className:"text-sm text-gray-600",children:M.label})]}),P?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full",children:"営業中"}):e.jsx("span",{className:"text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full",children:"営業時間外"})]}),e.jsx("h3",{className:"font-semibold text-lg text-gray-900 mb-2 line-clamp-2",children:a.name}),a.rating&&e.jsx("div",{className:"mb-2",children:(E=a.rating,E?e.jsxs("div",{className:"flex items-center space-x-1",children:[[1,2,3,4,5].map(t=>e.jsx(y,{className:"w-4 h-4 "+(t<=E?"text-yellow-400 fill-current":"text-gray-300")},t)),e.jsxs("span",{className:"text-sm text-gray-600 ml-1",children:["(",E,")"]})]}):null)}),a.address&&e.jsxs("div",{className:"flex items-start text-gray-600 text-sm mb-2",children:[e.jsx(d,{className:"w-4 h-4 mr-1 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"line-clamp-2",children:a.address})]}),l&&o&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-2",children:[e.jsx(x,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["現在地から ",(I=o,I?I<1?`${Math.round(1e3*I)}m`:`${I.toFixed(1)}km`:"")]})]}),a.opening_hours&&a.closing_hours&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-2",children:[e.jsx(b,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:[a.opening_hours," - ",a.closing_hours]})]}),a.phone&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-3",children:[e.jsx(v,{className:"w-4 h-4 mr-1"}),e.jsx("a",{href:`tel:${a.phone}`,className:"hover:text-blue-600 transition-colors",onClick:e=>e.stopPropagation(),children:a.phone})]}),a.description&&e.jsx("p",{className:"text-gray-600 text-sm mb-4 line-clamp-2",children:a.description}),e.jsxs("div",{className:"space-y-2",children:[u.length>0&&e.jsx("div",{className:"space-y-2",children:u.map(t=>{const s=p.find(e=>e.coupon_id===t.id);return s?e.jsxs(n,{onClick:()=>(e=>{if(e.is_used&&"once"===e.coupon?.usage_limit_type)return void alert("このクーポンは既に使用済みです。");k(e),w(!0)})(s),className:"w-full flex items-center justify-center bg-green-600 hover:bg-green-700",disabled:s.is_used&&"once"===t.usage_limit_type,children:[e.jsx(j,{className:"w-4 h-4 mr-2"}),s.is_used&&"once"===t.usage_limit_type?"クーポン使用済み":"クーポンを表示"]},t.id):e.jsxs(n,{onClick:()=>(async e=>{if(m)try{const{data:t,error:s}=await i.rpc("obtain_coupon",{coupon_uuid:e.id});if(s)throw s;const a=t;a.success?(alert(a.message),C()):alert(a.error)}catch(t){alert("クーポンの取得に失敗しました。")}else alert("クーポンの取得にはログインが必要です。")})(t),className:"w-full flex items-center justify-center bg-pink-600 hover:bg-pink-700",children:[e.jsx(j,{className:"w-4 h-4 mr-2"}),"クーポンを取得"]},t.id)})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(s,{to:`/facilities/${a.id}`,className:"flex-1",children:e.jsxs(n,{variant:"outline",className:"w-full flex items-center justify-center",children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),"詳細を見る"]})}),a.website_url&&e.jsx("a",{href:a.website_url,target:"_blank",rel:"noopener noreferrer",className:"flex-1",onClick:e=>e.stopPropagation(),children:e.jsx(n,{className:"w-full",children:"ウェブサイト"})})]})]})]}),N&&_&&e.jsx(D,{userCoupon:_,onClose:()=>{w(!1),k(null)}})]});var I,E}function T({message:t="データを読み込み中..."}){return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:t})]})})}function q({error:t,onRetry:s}){return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md mx-auto px-4",children:[e.jsx(S,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-4",children:t}),e.jsxs(n,{onClick:s,className:"inline-flex items-center",children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"再試行"]})]})})}function U({parks:s=[],facilities:c=[],activeView:o="dogparks",onLocationSelect:m,center:u,userLocation:h,className:g=""}){const p=t.useRef(null),[f,y]=t.useState(h||null),[b,j]=t.useState(""),[v,N]=t.useState(!1),[w,_]=t.useState(null),[k,C]=t.useState(!1),{isLoaded:M,isLoading:S,error:$}=l(),{user:I}=r(),[E,L]=t.useState([]),D=a(),F='\n    <svg width="40" height="56" viewBox="0 0 40 56" fill="none" xmlns="http://www.w3.org/2000/svg">\n      \x3c!-- ピンの形状（先がとがった） --\x3e\n      <path d="M20 0C8.954 0 0 8.954 0 20C0 31.046 20 56 20 56S40 31.046 40 20C40 8.954 31.046 0 20 0Z" fill="url(#dogParkGradient)" stroke="white" stroke-width="2"/>\n      \x3c!-- 背景円 --\x3e\n      <circle cx="20" cy="20" r="15" fill="white"/>\n      \x3c!-- 肉球デザイン --\x3e\n      <g transform="translate(20, 20) scale(0.8)">\n        \x3c!-- メイン肉球 --\x3e\n        <ellipse cx="0" cy="3" rx="6" ry="4" fill="#3B82F6"/>\n        \x3c!-- 上の小さな肉球（左上） --\x3e\n        <ellipse cx="-4" cy="-5" rx="2.5" ry="3" fill="#3B82F6"/>\n        \x3c!-- 上の小さな肉球（右上） --\x3e\n        <ellipse cx="4" cy="-5" rx="2.5" ry="3" fill="#3B82F6"/>\n        \x3c!-- 上の小さな肉球（中央上） --\x3e\n        <ellipse cx="0" cy="-7" rx="2" ry="2.5" fill="#3B82F6"/>\n      </g>\n      <defs>\n        <linearGradient id="dogParkGradient" x1="20" y1="0" x2="20" y2="40" gradientUnits="userSpaceOnUse">\n          <stop stop-color="#3B82F6"/>\n          <stop offset="1" stop-color="#2563EB"/>\n        </linearGradient>\n      </defs>\n    </svg>\n  ',z='\n    <svg width="36" height="50" viewBox="0 0 36 50" fill="none" xmlns="http://www.w3.org/2000/svg">\n      \x3c!-- ピンの形状（先がとがった） --\x3e\n      <path d="M18 0C8.059 0 0 8.059 0 18C0 27.941 18 50 18 50S36 27.941 36 18C36 8.059 27.941 0 18 0Z" fill="#22C55E" stroke="white" stroke-width="2"/>\n      \x3c!-- 背景円 --\x3e\n      <circle cx="18" cy="18" r="13" fill="white"/>\n      \x3c!-- 十字マーク --\x3e\n      <path d="M16 10h4v6h6v4h-6v6h-4v-6h-6v-4h6z" fill="#22C55E"/>\n    </svg>\n  ',T='\n    <svg width="24" height="40" viewBox="0 0 24 40" fill="none" xmlns="http://www.w3.org/2000/svg">\n      \x3c!-- ポール部分 --\x3e\n      <rect x="11" y="20" width="2" height="20" fill="#DC2626" stroke="white" stroke-width="1"/>\n      \x3c!-- 丸い部分 --\x3e\n      <circle cx="12" cy="12" r="11" fill="url(#currentLocationGradient)" stroke="white" stroke-width="2"/>\n      \x3c!-- 中央の小さな円 --\x3e\n      <circle cx="12" cy="12" r="6" fill="white"/>\n      \x3c!-- 中央のドット --\x3e\n      <circle cx="12" cy="12" r="3" fill="#DC2626"/>\n      <defs>\n        <linearGradient id="currentLocationGradient" x1="12" y1="1" x2="12" y2="23" gradientUnits="userSpaceOnUse">\n          <stop stop-color="#EF4444"/>\n          <stop offset="1" stop-color="#DC2626"/>\n        </linearGradient>\n      </defs>\n    </svg>\n  ',q=t.useCallback((e,t,s,a)=>{const n=(s-e)*Math.PI/180,r=(a-t)*Math.PI/180,i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},[]),U=t.useCallback(e=>e<1?`${Math.round(1e3*e)}m`:`${e.toFixed(1)}km`,[]),B=t.useCallback((e,t)=>{const s=e.name||"名前未設定",a="park"===t?`/parks/${e.id}`:`/facilities/${e.id}`;let n="";"main_image_url"in e&&e.main_image_url?n=e.main_image_url:"image_url"in e&&e.image_url?n=e.image_url:"cover_image_url"in e&&e.cover_image_url?n=e.cover_image_url:"thumbnail_url"in e&&e.thumbnail_url&&(n=e.thumbnail_url);const r=n?`\n      <div style="\n        width: 100%;\n        height: 90px;\n        margin: 0px 0px 2px 0px;\n        border-radius: 8px;\n        overflow: hidden;\n        background: #f3f4f6;\n      ">\n        <img \n          src="${n}" \n          alt="${s}"\n          style="\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            border-radius: 8px;\n          "\n          onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;font-size:12px;\\'>画像なし</div>';"\n        />\n      </div>\n    `:`\n      <div style="\n        width: 100%;\n        height: 70px;\n        margin: 0px 0px 2px 0px;\n        border-radius: 8px;\n        background: #f3f4f6;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #9ca3af;\n        font-size: 12px;\n      ">\n        ${"park"===t?"🐾":"🏥"} 画像なし\n      </div>\n    `;let i="";if(f&&e.latitude&&e.longitude){const t=q(f.lat,f.lng,e.latitude,e.longitude);i=`\n        <p style="\n          font-size: 12px;\n          color: #6b7280;\n          margin: 0;\n          display: flex;\n          align-items: center;\n          flex: 1;\n        ">\n          <span style="margin-right: 4px;">📍</span>\n          現在地から ${U(t)}\n        </p>\n      `}return`\n      <div style="\n        min-width: 220px;\n        max-width: 260px;\n        min-height: 185px;\n        padding: 0px 12px 0px 12px;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      ">\n        ${r}\n        \n        <h3 style="\n          font-size: 13px;\n          font-weight: 600;\n          margin: 6px 0 0px 0;\n          color: #1f2937;\n          line-height: 1.3;\n        ">${s}</h3>\n        \n        <div style="\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-top: 3px;\n        ">\n          ${i}\n          <button\n            onclick="window.infoWindowNavigate('${a}')"\n            style="\n              width: 80px;\n              background: #3b82f6;\n              color: white;\n              border: none;\n              padding: 6px 12px;\n              border-radius: 6px;\n              font-size: 12px;\n              font-weight: 500;\n              cursor: pointer;\n              transition: background 0.2s ease-in-out;\n            "\n            onmouseover="this.style.background='#2563eb'"\n            onmouseout="this.style.background='#3b82f6'"\n          >\n            詳細\n          </button>\n        </div>\n      </div>\n    `},[f,q,U]);t.useEffect(()=>(window.infoWindowNavigate=e=>{D(e)},()=>{delete window.infoWindowNavigate}),[D]);const O=t.useCallback(e=>{try{const t=window,a=new t.google.maps.InfoWindow;_(a),"dogparks"===o&&s&&s.forEach(s=>{if(s.latitude&&s.longitude){const n=new t.google.maps.Marker({position:{lat:s.latitude,lng:s.longitude},map:e,title:s.name,icon:{url:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(F)}`,scaledSize:new t.google.maps.Size(40,56),anchor:new t.google.maps.Point(20,56)}});n.addListener("click",()=>{const t=B(s,"park");a.setContent(t),a.open(e,n)})}}),"facilities"===o&&c&&c.forEach(s=>{if(s.latitude&&s.longitude){const n=new t.google.maps.Marker({position:{lat:s.latitude,lng:s.longitude},map:e,title:s.name,icon:{url:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(z)}`,scaledSize:new t.google.maps.Size(36,50),anchor:new t.google.maps.Point(18,50)}});n.addListener("click",()=>{const t=B(s,"facility");a.setContent(t),a.open(e,n)})}}),f&&new t.google.maps.Marker({position:f,map:e,title:"現在地",icon:{url:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(T)}`,scaledSize:new t.google.maps.Size(24,40),anchor:new t.google.maps.Point(12,40)}})}catch(t){}},[o,s,c,f,F,z,T,B]),A=t.useCallback(e=>{try{const t=globalThis.window;if(!t.google?.maps||!M)return;const s={center:h||f||u||{lat:35.6762,lng:139.6503},zoom:13,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",stylers:[{visibility:"off"}]},{featureType:"poi.government",stylers:[{visibility:"off"}]},{featureType:"poi.medical",stylers:[{visibility:"on"}]},{featureType:"poi.medical",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"poi.place_of_worship",stylers:[{visibility:"off"}]},{featureType:"poi.school",stylers:[{visibility:"off"}]},{featureType:"poi.sports_complex",stylers:[{visibility:"off"}]}],mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!1,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!1},a=new t.google.maps.Map(e,s);O(a),j(""),C(!0)}catch(t){j("地図の初期化に失敗しました")}},[h,f,u,O,M]);t.useEffect(()=>{p.current&&(M&&!$?A(p.current):$&&j($))},[M,$,A]);const G=t.useCallback(()=>{navigator.geolocation?(N(!0),navigator.geolocation.getCurrentPosition(e=>{const t={lat:e.coords.latitude,lng:e.coords.longitude};y(t),N(!1),m&&m(t)},e=>{N(!1)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e5})):j("位置情報がサポートされていません")},[m]);if(t.useEffect(()=>{h||f||navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const t={lat:e.coords.latitude,lng:e.coords.longitude};y(t),m&&m(t)},e=>{},{enableHighAccuracy:!1,timeout:8e3,maximumAge:3e5})},[h,f,m]),t.useEffect(()=>{(async()=>{if(I)try{const{data:e,error:t}=await i.from("dogs").select("id, name, image_url").eq("user_id",I.id).order("created_at",{ascending:!0});!t&&e&&e.length>0&&L(e)}catch(e){}})()},[I]),$)return e.jsxs(P,{className:`p-6 text-center ${g}`,children:[e.jsx(d,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"マップ機能は現在利用できません"}),e.jsx("p",{className:"text-gray-600 text-sm mb-4",children:$}),e.jsx("div",{className:"text-xs text-gray-500",children:e.jsxs("p",{children:["dogparks"===o?"ドッグラン":"ペット施設",": ","dogparks"===o?s.length:c.length,"件"]})})]});if(b&&b!==$)return e.jsxs(P,{className:`p-6 text-center ${g}`,children:[e.jsx(d,{className:"w-12 h-12 text-red-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"マップを読み込めませんでした"}),e.jsx("p",{className:"text-gray-600 text-sm mb-4",children:b}),e.jsx(n,{onClick:()=>{j(""),C(!1),p.current&&A(p.current)},children:"再読み込み"})]});const R=("dogparks"===o?s:c).length;return e.jsxs(P,{className:`overflow-hidden ${g}`,children:[e.jsxs("div",{className:"p-4 border-b bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(d,{className:"w-5 h-5 text-blue-600 mr-2"}),e.jsxs("h3",{className:"font-semibold",children:["dogparks"===o?"ドッグラン":"ペット施設","マップ"]})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[R,"件"]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsxs("div",{className:"flex items-center space-x-4 text-xs",children:["dogparks"===o&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full mr-2"}),e.jsx("span",{children:"ドッグラン"})]}),"facilities"===o&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full mr-2"}),e.jsx("span",{children:"ペット施設"})]}),f&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full mr-2"}),e.jsx("span",{children:"現在地"})]})]}),e.jsxs(n,{size:"sm",variant:"secondary",onClick:G,className:"text-xs",disabled:v,children:[e.jsx(x,{className:"w-3 h-3 mr-1"}),v?"取得中...":"現在地"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{ref:p,className:"w-full h-96",style:{minHeight:"400px"}}),(S||!k)&&!$&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:S?"Google Maps APIを読み込み中...":"マップを初期化中..."})]})})]}),e.jsx("div",{className:"p-3 border-t bg-gray-50 text-xs text-gray-500 text-center",children:$?"マップ機能は現在利用できません":"マーカーをクリックすると詳細情報が表示されます"})]})}const B={pet_hotel:"ペットホテル",pet_salon:"ペットサロン",veterinary:"動物病院",pet_cafe:"ペットカフェ",pet_restaurant:"ペット同伴レストラン",pet_shop:"ペットショップ",pet_accommodation:"ペット同伴宿泊",dog_training:"しつけ教室",pet_friendly_other:"その他ワンちゃん同伴可能施設"},O=(e,t,s,a)=>{const n=(s-e)*Math.PI/180,r=(a-t)*Math.PI/180,i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},A=e=>({pet_hotel:"🏨",pet_salon:"✂️",veterinary:"🏥",pet_cafe:"☕",pet_restaurant:"🍽️",pet_shop:"🛍️",pet_accommodation:"🏠",dog_training:"🎓",pet_friendly_other:"🌟"}[e]||"🏢");function G(){const[s,a]=t.useState("dogparks"),[n,l]=t.useState(null),[c,o]=t.useState(!1),[d,x]=t.useState(Object.keys(B)),[m,u]=t.useState(null),[h,g]=t.useState(!1),{user:p,isAuthenticated:f}=r(),{parks:y,isLoading:b,error:j,fetchParkData:v}=function(){const[e,s]=t.useState([]),[a,n]=t.useState(!1),[r,l]=t.useState(null);return{parks:e,isLoading:a,error:r,fetchParkData:t.useCallback(async()=>{try{n(!0),l(null);const{data:e,error:t}=await i.from("dog_parks").select("\n          *,\n          profiles:owner_id (\n            name,\n            address,\n            phone_number,\n            email,\n            postal_code\n          )\n        ").eq("status","approved").order("created_at",{ascending:!1});if(t)throw t;const a=(e||[]).map(e=>(Array.isArray(e.profiles)?e.profiles[0]:e.profiles,{id:e.id||"",name:e.name||"",description:e.description||e.facility_details||"",address:e.address||"",latitude:Number(e.latitude)||0,longitude:Number(e.longitude)||0,max_capacity:Number(e.max_capacity)||20,current_occupancy:Number(e.current_occupancy)||0,price:Number(e.price)||Number(e.hourly_rate)||0,status:e.status||"approved",facilities:e.facilities?"object"==typeof e.facilities?Object.entries(e.facilities).filter(([e,t])=>t).map(([e])=>e).join(","):e.facilities:e.facility_details||"",image_url:e.image_url||e.cover_image_url||"https://via.placeholder.com/400x300?text="+encodeURIComponent(e.name||"ドッグパーク"),average_rating:Number(e.average_rating)||4,review_count:Number(e.review_count)||Math.floor(50*Math.random())+5,created_at:e.created_at||""}));s(a)}catch(e){const t=e instanceof Error?e.message:"データの取得に失敗しました";l(t)}finally{n(!1)}},[]),setError:l,setIsLoading:n}}(),{facilities:N,facilitiesLoading:w,error:_,fetchFacilities:k}=function(){const[e,s]=t.useState([]),[a,n]=t.useState(!1),[r,l]=t.useState(null);return{facilities:e,facilitiesLoading:a,error:r,fetchFacilities:t.useCallback(async()=>{try{n(!0),l(null);const{data:e,error:t}=await i.from("pet_facilities").select("*").eq("status","approved").order("name");if(t)throw t;const a=(e||[]).map(e=>({id:e.id||"",name:e.name||"",description:e.description||"",category:e.category_id||"other",address:e.address||"",latitude:Number(e.latitude)||0,longitude:Number(e.longitude)||0,phone:e.phone||"",website:e.website||"",status:e.status||"pending",created_at:e.created_at||"",category_name:e.facility_categories?.name_ja||""}));s(a)}catch(e){const t=e instanceof Error?e.message:"施設データの取得に失敗しました";l(t),s([])}finally{n(!1)}},[]),setError:l,setFacilitiesLoading:n}}();t.useEffect(()=>{(async()=>{if(navigator.geolocation)try{const e=await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e5})}),t={lat:e.coords.latitude,lng:e.coords.longitude};u(t)}catch(e){}})()},[]),t.useEffect(()=>{(async()=>{try{"dogparks"===s?await v():await k()}catch(e){}})()},[s,v,k]);const C=t.useMemo(()=>m&&0!==y.length?[...y].sort((e,t)=>O(m.lat,m.lng,Number(e.latitude)||0,Number(e.longitude)||0)-O(m.lat,m.lng,Number(t.latitude)||0,Number(t.longitude)||0)):y,[y,m]),M=t.useMemo(()=>{let e=N.filter(e=>d.includes(e.category));return m&&e.length>0&&(e=e.sort((e,t)=>O(m.lat,m.lng,e.latitude||0,e.longitude||0)-O(m.lat,m.lng,t.latitude||0,t.longitude||0))),e},[N,d,m]),S="dogparks"===s?j:_,$=()=>{(async()=>{"dogparks"===s?await v():await k()})()};return("dogparks"===s?b:w)?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[!1,e.jsx(T,{})]}):S?e.jsx(q,{error:S,onRetry:$}):"dogparks"===s&&0===y.length?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx(L,{title:"ドッグランが見つかりません",description:"まだドッグランのデータが登録されていません。"})}):"facilities"===s&&0===N.length?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx(L,{title:"施設が見つかりません",description:"まだ施設のデータが登録されていません。"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"ドッグパーク一覧"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"お近くのドッグランを見つけましょう"})]})})}),!1,e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex justify-center py-4",children:e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>a("dogparks"),className:"px-6 py-3 rounded-md font-medium transition-all "+("dogparks"===s?"bg-blue-600 text-white shadow-md":"text-gray-600 hover:text-gray-900 hover:bg-gray-200"),children:"🐕 ドッグラン"}),e.jsx("button",{onClick:()=>a("facilities"),className:"px-6 py-3 rounded-md font-medium transition-all "+("facilities"===s?"bg-green-600 text-white shadow-md":"text-gray-600 hover:text-gray-900 hover:bg-gray-200"),children:"🏢 ワンちゃんと行ける施設"})]})})})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:["facilities"===s&&e.jsxs("div",{className:"mb-4 bg-white rounded-lg shadow-sm border",children:[e.jsxs("button",{onClick:()=>g(!h),className:"w-full px-3 py-3 flex items-center justify-between text-left hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"🏢 カテゴリフィルター"}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full",children:[d.length," / ",Object.keys(B).length]}),m&&e.jsx("span",{className:"text-xs text-green-600",children:"📍 距離順"})]}),e.jsx("span",{className:"text-gray-400 transition-transform "+(h?"rotate-180":""),children:"▼"})]}),h&&e.jsxs("div",{className:"px-3 pb-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-3 pt-3",children:[e.jsx("button",{onClick:()=>{x(Object.keys(B))},className:"px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"全選択"}),e.jsx("button",{onClick:()=>{x([])},className:"px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors",children:"全解除"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(B).map(([t,s])=>e.jsxs("button",{onClick:()=>(e=>{x(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])})(t),className:"px-3 py-2 text-sm rounded-full border transition-all "+(d.includes(t)?"bg-blue-500 text-white border-blue-500 shadow-md":"bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200"),children:[A(t)," ",s]},t))})]})]}),e.jsx("div",{className:"mb-8",children:e.jsx(U,{parks:C,facilities:"facilities"===s?M:N,activeView:s,userLocation:m})}),"dogparks"===s&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"ドッグラン一覧"}),0===y.length?e.jsx(L,{title:"ドッグランが見つかりません",description:"現在登録されているドッグランがありません。"}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:C.map(t=>{const s=m&&t.latitude&&t.longitude?O(m.lat,m.lng,Number(t.latitude),Number(t.longitude)):void 0;return e.jsx(E,{park:t,userLocation:m,...void 0!==s&&{distance:s}},t.id)})})]}),"facilities"===s&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"ワンちゃんと行ける施設"}),0===M.length?e.jsx(L,{title:"施設が見つかりません",description:0===d.length?"カテゴリを選択してください。":"選択したカテゴリの施設が登録されていません。"}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:M.map(t=>{const s=m&&t.latitude&&t.longitude?O(m.lat,m.lng,t.latitude,t.longitude):void 0;return e.jsx(z,{facility:t,showDistance:!!m,...void 0!==s&&{distance:s}},t.id)})})]})]})]})}export{G as DogParkList};
