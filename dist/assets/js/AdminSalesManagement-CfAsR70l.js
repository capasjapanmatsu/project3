import{j as e}from"./motion-BHsL7Azw.js";import{r as t}from"./react-vendor-CMvmJHsS.js";import{a as s,L as a}from"./router-DXQOdrLL.js";import{C as n}from"./Card-DqVnP9TA.js";import{u as r,s as i,B as c}from"./index-DZFFGm9Y.js";import{I as l}from"./Input-2E2l4WcX.js";import{_ as o,aE as d,aZ as m,a_ as x,aX as u,a$ as p,M as h,k as g,o as j,w as _,D as f}from"./ui-basic-C77EGLVg.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function y(){const{isAdmin:y}=r(),N=s(),[w,v]=t.useState([]),[b,S]=t.useState([]),[k,L]=t.useState(null),[D,C]=t.useState(!0),[$,M]=t.useState(""),[I,F]=t.useState(""),[O,U]=t.useState("all"),[q,E]=t.useState(""),[Y,P]=t.useState("transaction_date"),[T,B]=t.useState("desc");t.useEffect(()=>{y?(J(),R()):N("/")},[y,N]),t.useEffect(()=>{z()},[w,I,O,q,Y,T]);const J=async()=>{try{C(!0),M("");const{data:s,error:a}=await i.from("reservations").select("\n          id,\n          user_id,\n          park_id,\n          total_amount,\n          status,\n          reservation_type,\n          created_at\n        ").not("total_amount","is",null).order("created_at",{ascending:!1});if(a)throw new Error("予約売上データの取得に失敗しました");let n=null,r=null;try{const{data:e,error:t}=await i.from("stripe_subscriptions").select("\n            id,\n            customer_id,\n            status,\n            current_period_start,\n            current_period_end,\n            created_at\n          ").in("status",["active","trialing","past_due","canceled"]).not("deleted_at","is",null);n=e,r=t}catch(e){n=[],r=null}let c=null;try{const{data:e,error:t}=await i.auth.admin.listUsers();t||(c=e)}catch(t){}const l=await Promise.all((s||[]).map(async e=>{try{const{data:t}=await i.from("profiles").select("name").eq("id",e.user_id).single(),{data:s}=await i.from("dog_parks").select("name").eq("id",e.park_id).single(),a=e.total_amount||0,n=Math.round(.2*a),r=a-n,l=c?.users?.find(t=>t.id===e.user_id),o=l?.email;return{id:e.id,user_name:t?.name||"Unknown",user_email:o||`user_${e.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:e.created_at,amount:a,commission:n,commission_rate:.2,net_amount:r,payment_method:"card",payment_status:"confirmed"===e.status?"paid":"pending",description:`${s?.name||"Unknown Park"} - 予約料金`,is_subscription_user:"subscription"===e.reservation_type,created_at:e.created_at}}catch(t){return{id:e.id,user_name:"Unknown",user_email:`user_${e.user_id.slice(0,8)}@unknown.com`,transaction_type:"reservation",transaction_date:e.created_at,amount:e.total_amount||0,commission:0,commission_rate:.2,net_amount:e.total_amount||0,payment_method:"card",payment_status:"pending",description:"予約料金",is_subscription_user:!1,created_at:e.created_at}}})),o=await Promise.all((n||[]).map(async e=>{try{let t=null;if("user_id"in e)t=e.user_id;else{const{data:s}=await i.from("stripe_customers").select("user_id").eq("customer_id",e.customer_id).not("deleted_at","is",null).single();t=s?.user_id}if(!t)throw new Error("User ID not found for subscription");const{data:s}=await i.from("profiles").select("name").eq("id",t).single(),a=2980,n=Math.round(.1*a),r=a-n,l=c?.users?.find(e=>e.id===t),o=l?.email;return{id:e.id,user_name:s?.name||"Unknown",user_email:o||`user_${t.slice(0,8)}@unknown.com`,transaction_type:"subscription",transaction_date:e.created_at,amount:a,commission:n,commission_rate:.1,net_amount:r,payment_method:"card",payment_status:"active"===e.status?"paid":"pending",description:`月額サブスクリプション - ${e.status}`,is_subscription_user:!0,created_at:e.created_at}}catch(t){return{id:e.id,user_name:"Unknown",user_email:"unknown@unknown.com",transaction_type:"subscription",transaction_date:e.created_at,amount:2980,commission:298,commission_rate:.1,net_amount:2682,payment_method:"card",payment_status:"pending",description:"月額サブスクリプション",is_subscription_user:!0,created_at:e.created_at}}})),d=[...l,...o];d.sort((e,t)=>new Date(t.transaction_date).getTime()-new Date(e.transaction_date).getTime()),v(d)}catch(s){M(`売上データの取得に失敗しました: ${s instanceof Error?s.message:"不明なエラー"}`)}finally{C(!1)}},R=async()=>{try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()-1,1),a=new Date(e.getFullYear(),e.getMonth(),0),{data:n}=await i.from("reservations").select("total_amount").gte("created_at",t.toISOString()).not("total_amount","is",null),{data:r}=await i.from("reservations").select("total_amount").gte("created_at",s.toISOString()).lt("created_at",a.toISOString()).not("total_amount","is",null),{count:c}=await i.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",t.toISOString()),{count:l}=await i.from("stripe_subscriptions").select("id",{count:"exact"}).eq("status","active").gte("created_at",s.toISOString()).lt("created_at",a.toISOString()),o=(n||[]).reduce((e,t)=>e+(t.total_amount||0),0),d=((r||[]).reduce((e,t)=>e+(t.total_amount||0),0),2980*(c||0)),m=o+d,{count:x}=await i.from("reservations").select("id",{count:"exact"}).gte("created_at",t.toISOString()),u=(x||0)+(c||0);u>0&&Math.round(m/u),Math.round(.2*o+.1*d);L({daily_revenue:[],top_products:[],top_parks:[],payment_methods:[{method:"card",count:u,total_amount:m}]})}catch(e){}},z=()=>{let e=[...w];if(I&&(e=e.filter(e=>e.user_name.toLowerCase().includes(I.toLowerCase())||e.user_email.toLowerCase().includes(I.toLowerCase())||e.park_name&&e.park_name.toLowerCase().includes(I.toLowerCase())||e.product_name&&e.product_name.toLowerCase().includes(I.toLowerCase()))),"all"!==O&&(e=e.filter(e=>e.transaction_type===O)),q){const t=new Date(q);e=e.filter(e=>new Date(e.transaction_date).toDateString()===t.toDateString())}e.sort((e,t)=>{let s=e[Y],a=t[Y];return"transaction_date"===Y&&(s=new Date(s).getTime(),a=new Date(a).getTime()),"asc"===T?s>a?1:-1:s<a?1:-1}),S(e)},A=e=>({reservation:"ドッグラン予約",shop_order:"ショップ注文",subscription:"サブスクリプション"}[e]||e),V=t=>{const s={reservation:{color:"bg-blue-100 text-blue-800",icon:h},shop_order:{color:"bg-green-100 text-green-800",icon:g},subscription:{color:"bg-purple-100 text-purple-800",icon:j}},a=s[t]||s.reservation,n=a.icon;return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(n,{className:"w-4 h-4"}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${a.color}`,children:A(t)})]})};if(D)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})});const X=b.reduce((e,t)=>e+t.amount,0),Z=b.reduce((e,t)=>e+(t.amount-t.net_amount),0),G=b.reduce((e,t)=>e+t.net_amount,0),H=b.length>0?X/b.length:0,K=(new Date).getMonth(),Q=(new Date).getFullYear(),W=w.filter(e=>{const t=new Date(e.transaction_date);return t.getMonth()===K&&t.getFullYear()===Q}),ee=0===K?11:K-1,te=0===K?Q-1:Q,se=w.filter(e=>{const t=new Date(e.transaction_date);return t.getMonth()===ee&&t.getFullYear()===te}),ae=W.reduce((e,t)=>e+t.amount,0),ne=se.reduce((e,t)=>e+t.amount,0),re=(ie=ae,0===(ce=ne)?0:(ie-ce)/ce*100);var ie,ce;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(a,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(o,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(d,{className:"w-8 h-8 text-orange-600 mr-3"}),"売上管理"]}),e.jsx("p",{className:"text-gray-600",children:"売上の詳細分析と収益レポート"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["総取引数: ",w.length,"件"]})]}),$&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:$}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"今月の売上"}),e.jsxs("p",{className:"text-xl font-bold text-orange-600",children:["¥",ae.toLocaleString()]}),e.jsxs("div",{className:"flex items-center mt-1",children:[re>=0?e.jsx(m,{className:"w-4 h-4 text-green-600 mr-1"}):e.jsx(x,{className:"w-4 h-4 text-red-600 mr-1"}),e.jsxs("span",{className:"text-xs "+(re>=0?"text-green-600":"text-red-600"),children:[Math.abs(re).toFixed(1),"% vs 前月"]})]})]}),e.jsx(d,{className:"w-6 h-6 text-orange-600"})]})}),e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均取引額"}),e.jsxs("p",{className:"text-xl font-bold text-blue-600",children:["¥",Math.round(H).toLocaleString()]})]}),e.jsx(u,{className:"w-6 h-6 text-blue-600"})]})}),e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"手数料収入"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",Z.toLocaleString()]})]}),e.jsx(p,{className:"w-6 h-6 text-green-600"})]})}),e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"純売上"}),e.jsxs("p",{className:"text-xl font-bold text-purple-600",children:["¥",G.toLocaleString()]})]}),e.jsx(m,{className:"w-6 h-6 text-purple-600"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(n,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(h,{className:"w-5 h-5 text-blue-600 mr-2"}),"ドッグラン予約"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),e.jsxs("span",{className:"font-medium",children:[w.filter(e=>"reservation"===e.transaction_type).length,"件"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),e.jsxs("span",{className:"font-medium text-blue-600",children:["¥",w.filter(e=>"reservation"===e.transaction_type).reduce((e,t)=>e+t.amount,0).toLocaleString()]})]})]})]}),e.jsxs(n,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(g,{className:"w-5 h-5 text-green-600 mr-2"}),"ショップ注文"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),e.jsxs("span",{className:"font-medium",children:[w.filter(e=>"shop_order"===e.transaction_type).length,"件"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["¥",w.filter(e=>"shop_order"===e.transaction_type).reduce((e,t)=>e+t.amount,0).toLocaleString()]})]})]})]}),e.jsxs(n,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(j,{className:"w-5 h-5 text-purple-600 mr-2"}),"サブスクリプション"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"取引数:"}),e.jsxs("span",{className:"font-medium",children:[w.filter(e=>"subscription"===e.transaction_type).length,"件"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"売上:"}),e.jsxs("span",{className:"font-medium text-purple-600",children:["¥",w.filter(e=>"subscription"===e.transaction_type).reduce((e,t)=>e+t.amount,0).toLocaleString()]})]})]})]})]}),e.jsxs(n,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(l,{label:"検索",placeholder:"ユーザー名、メール、商品名、施設名で検索...",value:I,onChange:e=>F(e.target.value),icon:e.jsx(_,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引タイプ"}),e.jsxs("select",{value:O,onChange:e=>U(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"reservation",children:"ドッグラン予約"}),e.jsx("option",{value:"shop_order",children:"ショップ注文"}),e.jsx("option",{value:"subscription",children:"サブスクリプション"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"取引日"}),e.jsx("input",{type:"date",value:q,onChange:e=>E(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),e.jsxs("select",{value:`${Y}-${T}`,onChange:e=>{const[t,s]=e.target.value.split("-");P(t),B(s)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"transaction_date-desc",children:"取引日（新しい順）"}),e.jsx("option",{value:"transaction_date-asc",children:"取引日（古い順）"}),e.jsx("option",{value:"amount-desc",children:"金額（高い順）"}),e.jsx("option",{value:"amount-asc",children:"金額（低い順）"}),e.jsx("option",{value:"net_amount-desc",children:"純売上（高い順）"}),e.jsx("option",{value:"net_amount-asc",children:"純売上（低い順）"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[b.length,"件の取引が見つかりました",b.length>0&&e.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",X.toLocaleString(),"）"]})]}),e.jsxs(c,{variant:"secondary",size:"sm",onClick:()=>{const e=[["取引ID","タイプ","ユーザー名","メール","商品/施設","金額","手数料","純売上","決済方法","取引日"],...b.map(e=>[e.id,A(e.transaction_type),e.user_name,e.user_email,e.park_name||e.product_name||"-",`¥${e.amount.toLocaleString()}`,`${(100*e.commission_rate).toFixed(1)}%`,`¥${e.net_amount.toLocaleString()}`,e.payment_method,new Date(e.transaction_date).toLocaleDateString("ja-JP")])].map(e=>e.join(",")).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`sales_${(new Date).toISOString().split("T")[0]}.csv`,s.click()},children:[e.jsx(f,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),e.jsx(n,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引タイプ"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"商品/施設"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"取引日"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"金額"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"手数料・純売上"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"決済方法"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.user_name}),t.is_subscription_user&&e.jsx(j,{className:"w-4 h-4 text-purple-600 ml-2"})]}),e.jsx("div",{className:"text-sm text-gray-500",children:t.user_email})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:V(t.transaction_type)}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.park_name||t.product_name||"-"}),t.quantity&&e.jsxs("div",{className:"text-sm text-gray-500",children:["数量: ",t.quantity]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(t.transaction_date).toLocaleDateString("ja-JP")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",t.amount.toLocaleString()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"text-gray-500",children:["手数料: ",(100*t.commission_rate).toFixed(1),"%"]}),e.jsxs("div",{className:"font-medium text-green-600",children:["純売上: ¥",t.net_amount.toLocaleString()]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.payment_method})]},t.id))})]})})})]})}export{y as AdminSalesManagement};
