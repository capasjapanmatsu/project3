import{j as e}from"./motion-CuO0nkIV.js";import{r}from"./react-vendor-cniURDpR.js";import{a,L as t}from"./router-Cg6wfOY4.js";import{B as s}from"./Button-CJFAG6V0.js";import{u as i,S as l,C as n,s as o,l as c}from"./index-CVZFmpsT.js";import{I as m}from"./ImageCropper-BqfqFQ-L.js";import{I as d}from"./Input-D3zjVn42.js";import{S as b}from"./Select-Dd_IZFKg.js";import{d as u}from"./dogBreeds-6lxY8Uni.js";import{n as h}from"./notification-BEazPlEb.js";import{u as x,g}from"./webpConverter-DjNzWRB8.js";import{af as p,X as f,C as j}from"./ui-basic-CaMd9YQ-.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";const v=e=>{if(!e)return{isValid:!1,error:"ファイルが選択されていません"};if(e.size>10485760)return{isValid:!1,error:"ファイルサイズは10MB以下にしてください"};return["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)?{isValid:!0}:{isValid:!1,error:`サポートされていない画像形式です: ${e.type}`}},y=async(e,r,a="mixed")=>{try{const t=r,s=v(e);if(!s.isValid)throw new Error(s.error);const i=`${Date.now()}-${crypto.randomUUID?.()||Math.random().toString(36).slice(2)}`,l="rabies"===a?"rabies":"combo"===a?"combo":"mixed",n=`${t}_${l}_${i}`,o=`${t}/${l}/${n}.jpg`,c=await x("vaccine-certs",e,o,{quality:80,generateThumbnail:!0,thumbnailSize:300,keepOriginal:!1,upsert:!1,cacheControl:"0"});if(!c.success)throw new Error(c.error||"アップロードに失敗しました");return{success:!0,publicUrl:c.webpUrl||c.originalUrl,fileName:`${n}.jpg`,filePath:c.webpPath||c.originalPath,thumbnailUrl:c.thumbnailUrl}}catch(t){return{success:!1,error:t instanceof Error?t.message:"アップロードに失敗しました"}}};function w(){const{user:w,lineUser:N,effectiveUserId:$}=i(),D=a(),[C,I]=r.useState(!1),[E,S]=r.useState(""),[V,_]=r.useState(!1),[U,q]=r.useState(null),[M,k]=r.useState(null),[Y,B]=r.useState({name:"",breed:"",birthYear:"",birthMonth:"",birthDay:"",gender:"",rabiesVaccineImage:null,comboVaccineImage:null,rabiesExpiryDate:"",comboExpiryDate:""}),F=(()=>{const e=new Map([["ミックス犬（雑種）",1],["その他",2]]),r=new Intl.Collator("ja",{sensitivity:"base",usage:"sort",numeric:!0}),a=e=>/[\u4E00-\u9FFF]/.test(e);return Array.from(new Set(u)).sort((t,s)=>{const i=e.get(t)||0,l=e.get(s)||0;if(0!==i||0!==l)return i-l;const n=a(t)?0:1,o=a(s)?0:1;return n!==o?n-o:r.compare(t,s)})})(),A=(new Date).getFullYear(),z=Array.from({length:21},(e,r)=>{const a=A-r;return{value:a.toString(),label:`${a}年`}}),L=Array.from({length:12},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}月`}}),O=async(e,r)=>{const a=e.target.files?.[0];if(a)try{const e=v(a);if(!e.isValid)return void S(e.error||"ファイルが無効です。");B(e=>({...e,[`${r}VaccineImage`]:a})),S("")}catch(t){S("ファイルの検証中にエラーが発生しました。")}};return e.jsxs(e.Fragment,{children:[e.jsx(l,{title:"ワンちゃん登録",description:"愛犬の情報を登録してドッグランを利用しましょう"}),e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-blue-50 to-white py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(t,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-700 mb-4",children:[e.jsx(p,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ワンちゃん登録"}),e.jsx("p",{className:"text-gray-600",children:"愛犬の基本情報とワクチン証明書を登録してください"})]}),e.jsx(n,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{e.preventDefault();const r=w?.id||N?.id||$;if(r)if(Y.name.trim())if(Y.breed)if(Y.birthYear&&Y.birthMonth&&Y.birthDay)if(Y.gender)if(U)if(Y.rabiesVaccineImage)if(Y.comboVaccineImage)if(Y.rabiesExpiryDate)if(Y.comboExpiryDate){I(!0),S("");try{const e=`dog-profiles/${r}/${Date.now()}_${U.name}`,a=await x("dog-images",U,e,{quality:80,generateThumbnail:!0,thumbnailSize:300,keepOriginal:!1});if(!a.success)throw new Error(`プロフィール画像のアップロードに失敗しました: ${a.error}`);const t=g(a.originalUrl,a.webpUrl);let s="",i="";if(Y.rabiesVaccineImage){const e=await y(Y.rabiesVaccineImage,r,"rabies");if(!e.success)throw new Error(`狂犬病ワクチン証明書のアップロードに失敗しました: ${e.error}`);s=e.publicUrl||""}if(Y.comboVaccineImage){const e=await y(Y.comboVaccineImage,r,"combo");if(!e.success)throw new Error(`混合ワクチン証明書のアップロードに失敗しました: ${e.error}`);i=e.publicUrl||""}const l=`${Y.birthYear}-${Y.birthMonth}-${Y.birthDay}`,{data:n,error:c}=await o.from("dogs").insert([{owner_id:r,name:Y.name.trim(),breed:Y.breed,birth_date:l,gender:Y.gender,image_url:t}]).select().single();if(c)throw new Error(`ワンちゃんの登録に失敗しました: ${c.message}`);if(s||i){const e={dog_id:n.id,status:"pending"};s&&(e.rabies_vaccine_image=s,e.rabies_expiry_date=Y.rabiesExpiryDate),i&&(e.combo_vaccine_image=i,e.combo_expiry_date=Y.comboExpiryDate);const{data:r,error:a}=await o.from("vaccine_certifications").insert([e]).select();if(a)throw new Error(`ワクチン証明書の保存に失敗しました: ${a.message}`)}h.success("ワンちゃんの登録が完了しました！"),D("/dashboard")}catch(a){c.error("ワンちゃんの登録でエラーが発生しました",{error:a}),S(a instanceof Error?a.message:"ワンちゃんの登録中にエラーが発生しました。")}finally{I(!1)}}else S("混合ワクチンの有効期限を入力してください。");else S("狂犬病ワクチンの有効期限を入力してください。");else S("混合ワクチン証明書をアップロードしてください。");else S("狂犬病ワクチン証明書をアップロードしてください。");else S("プロフィール画像をアップロードしてください。");else S("性別を選択してください。");else S("生年月日を選択してください。");else S("犬種を選択してください。");else S("ワンちゃんの名前を入力してください。");else S("ログインが必要です。")},className:"space-y-6",children:[E&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("p",{className:"text-red-600 text-sm",children:E})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["プロフィール画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[M?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:M,alt:"プロフィール画像プレビュー",className:"w-24 h-24 rounded-full object-cover border-2 border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{q(null),k(null)},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(f,{className:"w-3 h-3"})})]}):e.jsx("div",{className:"w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center",children:e.jsx(j,{className:"w-8 h-8 text-gray-400"})}),e.jsxs(s,{type:"button",variant:"outline",onClick:()=>_(!0),children:[e.jsx(j,{className:"w-4 h-4 mr-2"}),U?"画像を変更":"画像を選択"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"1:1比率で切り取られ、最適化されます"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(d,{label:"ワンちゃんの名前",type:"text",value:Y.name,onChange:e=>B(r=>({...r,name:e.target.value})),placeholder:"例: ポチ",required:!0})}),e.jsx("div",{children:e.jsx(b,{label:"犬種",value:Y.breed,onChange:e=>B(r=>({...r,breed:e.target.value})),options:[{value:"",label:"犬種を選択してください"},...F.map(e=>({value:e,label:e}))],required:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["生年月日 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(b,{value:Y.birthYear,onChange:e=>{B(r=>({...r,birthYear:e.target.value,birthDay:""}))},options:[{value:"",label:"年"},...z],required:!0}),e.jsx(b,{value:Y.birthMonth,onChange:e=>{B(r=>({...r,birthMonth:e.target.value,birthDay:""}))},options:[{value:"",label:"月"},...L],required:!0}),e.jsx(b,{value:Y.birthDay,onChange:e=>B(r=>({...r,birthDay:e.target.value})),options:[{value:"",label:"日"},...(()=>{if(!Y.birthYear||!Y.birthMonth)return[];const e=parseInt(Y.birthYear),r=parseInt(Y.birthMonth),a=new Date(e,r,0).getDate();return Array.from({length:a},(e,r)=>{const a=r+1;return{value:a.toString().padStart(2,"0"),label:`${a}日`}})})()],required:!0,disabled:!Y.birthYear||!Y.birthMonth})]})]}),e.jsx("div",{children:e.jsx(b,{label:"性別",value:Y.gender,onChange:e=>B(r=>({...r,gender:e.target.value})),options:[{value:"",label:"性別を選択してください"},{value:"オス",label:"オス"},{value:"メス",label:"メス"}],required:!0})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"ワクチン証明書"}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>O(e,"rabies"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),Y.rabiesVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",Y.rabiesVaccineImage.name]})]}),e.jsx(d,{label:"有効期限",type:"date",value:Y.rabiesExpiryDate,onChange:e=>B(r=>({...r,rabiesExpiryDate:e.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン証明書 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>O(e,"combo"),className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",required:!0}),Y.comboVaccineImage&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["✓ ",Y.comboVaccineImage.name]})]}),e.jsx(d,{label:"有効期限",type:"date",value:Y.comboExpiryDate,onChange:e=>B(r=>({...r,comboExpiryDate:e.target.value})),required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(t,{to:"/dashboard",children:e.jsx(s,{type:"button",variant:"outline",children:"キャンセル"})}),e.jsx(s,{type:"submit",disabled:C,className:"min-w-[120px]",children:C?"登録中...":"ワンちゃんを登録"})]})]})})]})}),V&&e.jsx(m,{onCropComplete:e=>{q(e);const r=URL.createObjectURL(e);k(r),_(!1),S("")},onCancel:()=>_(!1),aspectRatio:1,maxWidth:400,maxHeight:400})]})}export{w as DogRegistration};
