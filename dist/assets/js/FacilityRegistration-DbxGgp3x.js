import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{u as a,B as i,s as t}from"./index-DlnrQNVO.js";import{C as l}from"./Card-DqVnP9TA.js";import{I as r}from"./Input-BL9Dcu5J.js";import{a as d}from"./router-DXQOdrLL.js";import{A as n,t as m,n as c,X as o,aH as x}from"./ui-basic-D1oJx_i8.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";const h=e=>new Promise((s,a)=>{const i=document.createElement("canvas"),t=i.getContext("2d"),l=document.createElement("img");l.onload=()=>{let e=l.naturalWidth,a=l.naturalHeight;e>a?e>800&&(a=800*a/e,e=800):a>600&&(e=600*e/a,a=600),i.width=e,i.height=a,t?.drawImage(l,0,0,e,a);const r=i.toDataURL("image/jpeg",.8);s(r)},l.onerror=a,l.src=URL.createObjectURL(e)}),g=[{id:"pet_hotel",name:"ペットホテル",monthly_fee:5e3,is_free:!0},{id:"pet_salon",name:"ペットサロン",monthly_fee:3e3,is_free:!0},{id:"veterinary",name:"動物病院",monthly_fee:8e3,is_free:!0},{id:"pet_cafe",name:"ペットカフェ",monthly_fee:4e3,is_free:!0},{id:"pet_restaurant",name:"ペット同伴レストラン",monthly_fee:6e3,is_free:!0},{id:"pet_shop",name:"ペットショップ",monthly_fee:7e3,is_free:!0},{id:"pet_accommodation",name:"ペット同伴宿泊",monthly_fee:1e4,is_free:!0},{id:"dog_training",name:"しつけ教室",monthly_fee:4500,is_free:!0},{id:"pet_friendly_other",name:"その他ワンちゃん同伴可能施設",monthly_fee:3500,is_free:!0}];function j(){const{user:j,isAuthenticated:b,userProfile:u}=a(),p=d(),[f,y]=s.useState(!1),[N,v]=s.useState(""),[w,_]=s.useState(""),[I,C]=s.useState({main:!1,additional:[!1,!1,!1]}),[k,E]=s.useState({name:u?.name||"",address:u?.address||"",isEditing:!1}),[F,$]=s.useState({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:[],mainImage:"",additionalImages:[],additionalImageFiles:[]});s.useEffect(()=>{b||p("/login")},[b,p]),s.useEffect(()=>{u&&E({name:u.name||"",address:u.address||"",isEditing:!1})},[u]);const S=e=>{const{name:s,value:a}=e.target;$(e=>({...e,[s]:a}))},q=async(e,s,a,i)=>{try{const l=Date.now(),r=e.name.split(".").pop(),d=`${s}/${"main"===a?`main_${l}.${r}`:`additional_${i}_${l}.${r}`}`,{data:n,error:m}=await t.storage.from("pet-facility-images").upload(d,e,{cacheControl:"3600",upsert:!1});if(m)throw m;const{data:{publicUrl:c}}=t.storage.from("pet-facility-images").getPublicUrl(d);return c}catch(l){throw new Error("画像のアップロードに失敗しました")}},P=e=>{const{name:s,value:a}=e.target;E(e=>({...e,[s]:a}))},U=()=>{(async()=>{if(j)try{y(!0);const{error:e}=await t.from("profiles").update({name:k.name,address:k.address,updated_at:(new Date).toISOString()}).eq("id",j.id);if(e)throw new Error("ユーザー情報の更新に失敗しました");E(e=>({...e,isEditing:!1})),_("ユーザー情報を更新しました"),setTimeout(()=>_(""),3e3)}catch(e){v(e instanceof Error?e.message:"ユーザー情報の更新に失敗しました")}finally{y(!1)}})()},B=()=>{E({name:u?.name||"",address:u?.address||"",isEditing:!1})};return b?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ペット関連施設登録"}),e.jsx("p",{className:"text-gray-600",children:"ペット関連施設の掲載申請を行います。管理者の承認後、地図に表示されます。"})]}),N&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(n,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:N})]})}),w&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(m,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"text-green-700",children:w})]})}),e.jsxs("form",{onSubmit:e=>{(async e=>{if(e.preventDefault(),F.name&&F.category_id&&F.address)if(F.mainImage&&F.mainImageFile)try{y(!0),v("");const e={owner_id:j?.id,name:F.name,category_id:F.category_id,address:F.address,phone:F.phone||null,website:F.website||null,description:F.description||null,status:"pending"},{data:s,error:a}=await t.from("pet_facilities").insert([e]).select().single();if(a||!s)throw a||new Error("施設の登録に失敗しました");const i=s.id,l=[];F.mainImageFile&&l.push(q(F.mainImageFile,i,"main").then(e=>({url:e,type:"main",order:0}))),F.additionalImageFiles&&F.additionalImageFiles.forEach((e,s)=>{e&&l.push(q(e,i,"additional",s).then(e=>({url:e,type:"additional",order:s+1})))});const r=await Promise.all(l);if(r.length>0){const e=r.map(e=>({facility_id:i,image_url:e.url,image_type:e.type,display_order:e.order,alt_text:`${F.name} - ${"main"===e.type?"メイン画像":`追加画像${e.order}`}`})),{error:s}=await t.from("pet_facility_images").insert(e)}_("施設の申請が完了しました。審査完了までお待ちください。"),$({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:[],mainImage:"",additionalImages:[],additionalImageFiles:[]}),setTimeout(()=>{p("/dashboard")},3e3)}catch(s){let e="申請の送信に失敗しました";if(s&&"object"==typeof s&&"message"in s)e=s.message;else if(s&&"object"==typeof s&&"error"in s){const a=s;a.error?.message&&(e=`データベースエラー: ${a.error.message}`)}(e.includes("row-level security policy")||e.includes("RLS"))&&(e="データベースのアクセス権限に問題があります。管理者にお問い合わせください。"),v(e)}finally{y(!1)}else v("メイン画像は必須です");else v("必須項目を入力してください")})(e)},className:"space-y-6",children:[e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(c,{className:"w-6 h-6 mr-2"}),"基本情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設名 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(r,{label:"施設名",name:"name",value:F.name,onChange:S,placeholder:"施設名を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設カテゴリ ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"category_id",value:F.category_id,onChange:S,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"カテゴリを選択してください"}),g.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["住所 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(r,{label:"住所",name:"address",value:F.address,onChange:S,placeholder:"住所を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(r,{label:"電話番号",name:"phone",value:F.phone,onChange:S,placeholder:"電話番号を入力してください"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(r,{label:"ウェブサイト",name:"website",value:F.website,onChange:S,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設の説明"}),e.jsx("textarea",{name:"description",value:F.description,onChange:S,rows:4,placeholder:"施設の特徴やサービス内容を入力してください",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"施設画像"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["メイン画像 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"施設の代表的な画像をアップロードしてください（最大5MB、JPG/PNG形式）"}),F.mainImage?e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:F.mainImage,alt:"メイン画像プレビュー",className:"w-48 h-36 object-cover rounded-lg border border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>{$(e=>({...e,mainImage:"",mainImageFile:void 0}))},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:e.jsx(o,{className:"w-4 h-4"})})]}):e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:I.main?e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"画像を処理中..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("div",{className:"mt-4",children:e.jsxs("label",{htmlFor:"mainImage",className:"cursor-pointer",children:[e.jsx("span",{className:"mt-2 block text-sm font-medium text-gray-900 hover:text-blue-600",children:"メイン画像をアップロード"}),e.jsx("input",{id:"mainImage",name:"mainImage",type:"file",accept:"image/*",onChange:e=>{(async e=>{const s=e.target.files?.[0];if(s)if(s.size>5242880)v("画像ファイルのサイズは5MB以下にしてください");else if(s.type.startsWith("image/"))try{C(e=>({...e,main:!0})),v("");const e=await h(s);$(a=>({...a,mainImage:e,mainImageFile:s}))}catch(a){v("画像の処理に失敗しました")}finally{C(e=>({...e,main:!1}))}else v("画像ファイルを選択してください")})(e)},className:"sr-only",disabled:I.main})]})})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"追加画像（任意）"}),e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"最大3枚まで追加できます"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[0,1,2].map(s=>e.jsx("div",{children:F.additionalImages[s]?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:F.additionalImages[s],alt:`追加画像${s+1}プレビュー`,className:"w-full h-32 object-cover rounded-lg border border-gray-300"}),e.jsx("button",{type:"button",onClick:()=>(e=>{$(s=>{const a=[...s.additionalImages],i=s.additionalImageFiles?[...s.additionalImageFiles]:[];return a[e]="",i[e]=void 0,{...s,additionalImages:a,additionalImageFiles:i}})})(s),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:e.jsx(o,{className:"w-4 h-4"})})]}):e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center",children:I.additional[s]?e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"}),e.jsx("p",{className:"mt-2 text-xs text-gray-600",children:"処理中..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("div",{className:"mt-2",children:e.jsxs("label",{htmlFor:`additionalImage${s}`,className:"cursor-pointer",children:[e.jsxs("span",{className:"text-sm text-gray-600 hover:text-blue-600",children:["画像",s+1]}),e.jsx("input",{id:`additionalImage${s}`,name:`additionalImage${s}`,type:"file",accept:"image/*",onChange:e=>{(async(e,s)=>{const a=e.target.files?.[0];if(a)if(a.size>5242880)v("画像ファイルのサイズは5MB以下にしてください");else if(a.type.startsWith("image/"))try{C(e=>{const a=[...e.additional];return a[s]=!0,{...e,additional:a}}),v("");const e=await h(a);$(i=>{const t=[...i.additionalImages],l=i.additionalImageFiles?[...i.additionalImageFiles]:[];return t[s]=e,l[s]=a,{...i,additionalImages:t,additionalImageFiles:l}})}catch(i){v("画像の処理に失敗しました")}finally{C(e=>{const a=[...e.additional];return a[s]=!1,{...e,additional:a}})}else v("画像ファイルを選択してください")})(e,s)},className:"sr-only",disabled:I.additional[s]})]})})]})})},s))})]})]})]})]})}),e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(c,{className:"w-6 h-6 mr-2"}),"ユーザー情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"名前"}),k.isEditing?e.jsx(r,{label:"名前",name:"name",value:k.name,onChange:P,placeholder:"名前を入力してください"}):e.jsx("p",{className:"text-gray-900",children:k.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),k.isEditing?e.jsx(r,{label:"住所",name:"address",value:k.address,onChange:P,placeholder:"住所を入力してください"}):e.jsx("p",{className:"text-gray-900",children:k.address})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:k.isEditing?e.jsxs(e.Fragment,{children:[e.jsx(i,{onClick:U,className:"mr-2",disabled:f,children:f?"保存中...":"保存"}),e.jsx(i,{onClick:B,disabled:f,children:"キャンセル"})]}):e.jsx(i,{onClick:()=>E(e=>({...e,isEditing:!0})),children:"編集"})})]})}),e.jsx(l,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(m,{className:"w-6 h-6 mr-2"}),"登録者情報の確認"]}),e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(n,{className:"w-5 h-5 text-blue-500 mr-2 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"登録者情報の確認"}),e.jsx("p",{className:"text-xs",children:"以下の情報をご確認ください。変更が必要な場合は編集できます。"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"氏名"}),k.isEditing?e.jsx(r,{label:"氏名",name:"name",value:k.name,onChange:P,placeholder:"氏名を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:k.name||"未設定"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),k.isEditing?e.jsx(r,{label:"住所",name:"address",value:k.address,onChange:P,placeholder:"住所を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:k.address||"未設定"})})]}),e.jsx("div",{className:"flex gap-2",children:k.isEditing?e.jsxs(e.Fragment,{children:[e.jsx(i,{type:"button",onClick:U,disabled:f,children:f?"保存中...":"保存"}),e.jsx(i,{type:"button",onClick:B,children:"キャンセル"})]}):e.jsx(i,{type:"button",onClick:()=>E(e=>({...e,isEditing:!0})),children:"編集"})})]})]})}),e.jsx(l,{className:"mb-6",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(m,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"font-medium text-green-800",children:"無料掲載期間実施中！"})]}),e.jsxs("p",{className:"text-green-700 mb-2",children:["すべてのペット関連施設が",e.jsx("strong",{className:"text-lg",children:"無料"}),"で掲載できます。"]}),e.jsxs("ul",{className:"text-sm text-green-600 space-y-1",children:[e.jsx("li",{children:"• 本人確認手続きは不要です"}),e.jsx("li",{children:"• 申請後、管理者の承認を経て掲載開始となります"}),e.jsx("li",{children:"• 無料掲載となりますので、お店などの施設、ホームページなどに当アプリのご紹介をお願いします。"})]})]})})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(i,{type:"submit",disabled:f,children:f?"申請中...":"申請を送信する"})})]})]}):null}export{j as default};
