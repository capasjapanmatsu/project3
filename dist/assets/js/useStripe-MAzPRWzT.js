import{l as e}from"./external-api-CcgPsVUa.js";import{r as t}from"./react-vendor-cniURDpR.js";import{u as s,s as i}from"./index-hxb5tPha.js";function r(){const{user:r,lineUser:o,effectiveUserId:a}=s(),[n,c]=t.useState(!1),[u,l]=t.useState(null),m=t.useCallback(async()=>{const{data:{user:e}}=await i.auth.getUser();if(!e&&(o||a))try{const e=await fetch("/line/exchange-supabase-session",{method:"POST",credentials:"include"});if(!e.ok)return;const{access_token:t,refresh_token:s}=await e.json();await i.auth.setSession({access_token:t,refresh_token:s})}catch{}},[o,a]);return{createCheckoutSession:t.useCallback(async({priceId:t,mode:s,successUrl:n,cancelUrl:u,customAmount:d,customName:p,customParams:w,cartItems:f,trialPeriodDays:h})=>{c(!0),l(null);try{await m();const c=r?.id||o?.app_user_id||o?.id||a;if(!c)throw new Error("認証が必要です");let l,_;if(r){const{data:{session:e}}=await i.auth.getSession();l=e?.access_token,_=e?.user.email}else if(o){const{data:e}=await i.from("profiles").select("email").eq("id",c).single();_=e?.email||`line_${o.line_user_id}@line.local`,l=`line_user_${c}`}if(!l&&!o)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:c,user_email:_||"",timestamp:Date.now(),return_url:window.location.href,is_line_user:!!o}));const I=n&&u?null:window.location.origin,y={mode:s,success_url:n||`${I}/payment-confirmation?success=true`,cancel_url:u||`${I}/payment-confirmation?canceled=true`};t&&(y.price_id=t),h&&"subscription"===s&&(y.trial_period_days=h),d&&p&&(y.custom_amount=d,y.custom_name=p),f&&f.length>0&&(y.cart_items=f),w&&Object.entries(w).forEach(([e,t])=>{y[e]=t}),o&&(y.user_id=c);const S=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"}`},body:JSON.stringify(y)});if(!S.ok){const e=await S.json();throw new Error(e.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:k,url:j}=await S.json();if(j)return void(window.location.href=j);if(!k)throw new Error("チェックアウトURLが取得できませんでした");{const t="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",s=await e(t);if(!s)throw new Error("Stripeの読み込みに失敗しました");const{error:i}=await s.redirectToCheckout({sessionId:k});if(i)throw i}}catch(_){throw l(_.message||"チェックアウトに失敗しました"),_}finally{c(!1)}},[r,o,a]),loading:n,error:u}}export{r as u};
