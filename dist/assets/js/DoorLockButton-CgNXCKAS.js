import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{u as t,s as a}from"./index-DcAUXhuw.js";import{B as r}from"./Button-Bq1kOCic.js";import{Q as n,K as i,a4 as l,i as o,ao as c,y as m}from"./ui-basic-Kxp_U5Up.js";function u({lockId:u,className:d="",variant:h="primary",size:x="md",label:p="ドアを開ける",showStatus:f=!0,onSuccess:j,onError:w,reservationId:N}){const{user:g}=t(),[v,y]=s.useState(!1),[b,k]=s.useState(null),[_,E]=s.useState(null),[T,I]=s.useState(!1),[S,P]=s.useState("");s.useEffect(()=>{if(_){const e=setTimeout(()=>{E(null)},3e3);return()=>clearTimeout(e)}},[_]),s.useEffect(()=>{if(b){const e=setTimeout(()=>{k(null)},5e3);return()=>clearTimeout(e)}},[b]);const D=async()=>{if(g){y(!0),k(null),E(null);try{const{data:{session:e},error:s}=await a.auth.getSession();if(s||!e?.access_token)throw new Error("認証が必要です");let t=5,r=null;if(N){const e=await(async e=>{try{const{data:s,error:t}=await a.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("id",e).single();return t?null:s}catch(s){return null}})(N);if(e&&"whole_facility"===e.reservation_type&&(r=(e=>{try{const s=new Date(e.date),t=e.start_time.split(":").map(Number),a=t[0]??0,r=t[1]??0;return s.setHours(a,r,0,0),new Date(s.getTime()+60*e.duration*60*1e3)}catch(s){return null}})(e),r)){const e=new Date,s=r.getTime()-e.getTime();t=Math.max(1,Math.ceil(s/6e4))}}const n=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/generate-pin",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({lock_id:u,purpose:"entry",expiry_minutes:t,reservation_id:N||void 0})});if(!n.ok){const e=await n.json();throw new Error(e.error||"PINコードの生成に失敗しました")}const{pin:i}=await n.json();alert(`PINコード: ${i}\n\nこのPINコードをスマートロックのキーパッドに入力してください。`),E(i),j&&j()}catch(e){if(e.message&&e.message.startsWith("PAYMENT_REQUIRED:")){const s=e.message.replace("PAYMENT_REQUIRED:","").trim();P(s),I(!0),k(null)}else k(e.message||"PINコードの生成に失敗しました"),I(!1);w&&w(e.message||"PINコードの生成に失敗しました")}finally{y(!1)}}};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(r,{onClick:()=>{D()},isLoading:v,variant:h,size:x,className:`flex items-center ${d}`,children:[v?e.jsx(n,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(i,{className:"w-4 h-4 mr-2"}),p]}),f&&e.jsxs(e.Fragment,{children:[_&&e.jsxs("div",{className:"flex items-center text-green-600 text-sm mt-1",children:[e.jsx(l,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:"PINコードを生成しました"})]}),b&&e.jsxs("div",{className:"flex items-center text-red-600 text-sm mt-1",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:b})]}),T&&e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200 mt-2",children:[e.jsxs("div",{className:"flex items-start space-x-2 mb-3",children:[e.jsx(c,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-1",children:"決済が必要です"}),e.jsx("p",{className:"text-sm text-blue-800",children:S})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(r,{onClick:()=>window.location.href="/subscription-intro",size:"sm",className:"w-full bg-purple-600 hover:bg-purple-700",children:[e.jsx(c,{className:"w-3 h-3 mr-1"}),"サブスク加入"]}),e.jsxs(r,{onClick:()=>window.location.href="/parks",size:"sm",variant:"secondary",className:"w-full",children:[e.jsx(m,{className:"w-3 h-3 mr-1"}),"1Dayパス購入"]})]})]})]})]})}export{u as D};
