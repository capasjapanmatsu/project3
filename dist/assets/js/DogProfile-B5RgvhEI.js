import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{c as a,a as t,L as r}from"./router-DXQOdrLL.js";import{C as i}from"./Card-DqVnP9TA.js";import{u as l,s as c,B as d}from"./index-pfXXv_mo.js";import{c as n,Y as m,t as x,C as o,j as h,ah as g,M as j}from"./ui-basic-kZxfFvQj.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function u(){const{id:u,dogId:f}=a(),{user:p}=l();t();const[N,y]=s.useState(null),[v,w]=s.useState(!0),[b,_]=s.useState(""),[k,q]=s.useState(""),[S,D]=s.useState(!1),[C,T]=s.useState(!1),[$,E]=s.useState([]),[L,M]=s.useState(!1),[Y,F]=s.useState(0),[z,B]=s.useState(!1),I=u||f;s.useEffect(()=>{I&&(J(),p&&(O(),P()))},[I,p]);const J=async()=>{try{w(!0),_("");const{data:e,error:s}=await c.from("dogs").select("*").eq("id",I).single();if(s)throw s;y(e),F(e.like_count||0);const{data:a,error:t}=await c.from("reservations").select("\n          *,\n          dog_park:dog_parks(*)\n        ").eq("dog_id",I).eq("status","confirmed");if(t)throw t;const r={};(a||[]).forEach(e=>{const s=e.park_id;e.dog_park&&(r[s]||(r[s]={park:e.dog_park,visits:0}),r[s].visits++)});const i=Object.values(r).sort((e,s)=>s.visits-e.visits).slice(0,3);E(i)}catch(e){_("ワンちゃんの情報を取得できませんでした。")}finally{w(!1)}},O=async()=>{if(p&&I)try{const{data:e}=await c.from("dogs").select("owner_id").eq("id",I).single();if(!e)return;const{data:s,error:a}=await c.from("friend_requests").select("id, status").or(`and(requester_id.eq.${p.id},requested_id.eq.${e.owner_id}),and(requester_id.eq.${e.owner_id},requested_id.eq.${p.id})`).maybeSingle();!a&&s&&T(!0)}catch(e){}},P=async()=>{if(p&&I)try{const{data:e,error:s}=await c.from("dog_likes").select("id").eq("user_id",p.id).eq("dog_id",I).maybeSingle();!s&&e&&M(!0)}catch(e){}};return v?e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):b||!N?e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsxs(i,{className:"p-8 text-center",children:[e.jsx(n,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"ワンちゃんが見つかりません"}),e.jsx("p",{className:"text-gray-600 mb-6",children:b||"ワンちゃんの情報が見つかりませんでした。"}),e.jsx(r,{to:"/",children:e.jsxs(d,{variant:"primary",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})})]})}):e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(r,{to:"/",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})}),k&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:k})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-48 h-48 bg-gray-200 rounded-lg overflow-hidden",children:N.image_url?e.jsx("img",{src:N.image_url,alt:N.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/58997/pexels-photo-58997.jpeg?auto=compress&cs=tinysrgb&w=300"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:e.jsx(n,{className:"w-12 h-12"})})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:[N.name,(A=N.gender,"オス"===A?"くん":"ちゃん")]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(o,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsxs("span",{className:"text-lg text-gray-700",children:[(e=>{const s=new Date,a=new Date(e);let t=s.getFullYear()-a.getFullYear();const r=s.getMonth()-a.getMonth();return(r<0||0===r&&s.getDate()<a.getDate())&&t--,t})(N.birth_date),"歳"]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(n,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsx("span",{className:"text-lg text-gray-700",children:N.breed})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(h,{className:"w-5 h-5 text-gray-500 mr-3"}),e.jsx("span",{className:"text-lg text-gray-700",children:N.gender})]})]}),e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("span",{className:"text-sm text-gray-600",children:[Y,"件のいいね"]})}),p&&e.jsxs(d,{onClick:async()=>{if(p&&N&&!z){B(!0);try{if(L){const{error:e}=await c.from("dog_likes").delete().eq("user_id",p.id).eq("dog_id",N.id);if(e)throw e;M(!1),F(e=>e-1),q("いいねを取り消しました")}else{const{error:e}=await c.from("dog_likes").insert({user_id:p.id,dog_id:N.id});if(e)throw e;M(!0),F(e=>e+1),q("いいねしました")}setTimeout(()=>q(""),2e3)}catch(e){_("いいねの処理に失敗しました"),setTimeout(()=>_(""),3e3)}finally{B(!1)}}},disabled:z,variant:L?"primary":"secondary",size:"sm",className:"px-4 py-2 "+(L?"bg-pink-500 hover:bg-pink-600 text-white":"bg-white hover:bg-pink-50 text-pink-600 border-pink-300"),children:[e.jsx(h,{className:"w-4 h-4 mr-1 "+(L?"fill-current":"")}),L?"いいね済み":"いいね"]})]})}),p&&N.owner_id!==p.id&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[e.jsx("div",{className:"text-center",children:C?e.jsxs("div",{className:"flex items-center justify-center text-green-600",children:[e.jsx(x,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:"友達申請済み"})]}):e.jsxs(d,{onClick:async()=>{if(p&&N){D(!0);try{const{error:e}=await c.from("friend_requests").insert({requester_id:p.id,requested_id:N.owner_id,message:"ドッグランでお会いした際は、よろしくお願いします！"});if(e)throw e;T(!0),q("友達申請を送信しました"),setTimeout(()=>q(""),3e3)}catch(e){_("友達申請の送信に失敗しました"),setTimeout(()=>_(""),3e3)}finally{D(!1)}}},isLoading:S,className:"px-8 py-3",children:[e.jsx(g,{className:"w-5 h-5 mr-2"}),"友達申請を送る"]})}),e.jsx("div",{className:"mt-4 p-4 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"友達申請について"}),e.jsx("p",{children:"友達申請を送ると、相手の飼い主さんに通知が届きます。 承認されると、メッセージのやり取りができるようになります。"})]})})]})]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(i,{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-4 flex items-center",children:[e.jsx(j,{className:"w-5 h-5 text-green-600 mr-2"}),"よく遊ぶドッグラン"]}),$.length>0?e.jsx("div",{className:"space-y-3",children:$.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-900",children:s.park.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.visits,"回利用"]})]}),e.jsx("div",{className:"text-2xl",children:0===a?"🥇":1===a?"🥈":"🥉"})]},s.park.id))}):e.jsx("p",{className:"text-gray-500",children:"まだドッグランの利用履歴がありません"})]}),e.jsxs(i,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"登録日"}),e.jsx("p",{className:"text-gray-700",children:new Date(N.created_at).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})})]})]})]})]});var A}export{u as DogProfile};
