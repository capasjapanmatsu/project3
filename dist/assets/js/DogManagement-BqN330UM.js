import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{L as a}from"./router-Cg6wfOY4.js";import{B as i}from"./Button-D7FFKgkK.js";import{u as r,s as o,c as s,C as c}from"./index-qwdJeTcH.js";import{D as n,a as d}from"./DogCard--7H6Km5b.js";import{af as m,o as l,P as g}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";import"./dogBreeds-6lxY8Uni.js";import"./ImageCropper-D1yvC4Ey.js";import"./Input-D7pb8xRh.js";import"./LazyImage-C-8rMYP2.js";import"./Select-Dd_IZFKg.js";import"./VaccineBadge-4VGNeluK.js";function p(){const{user:p}=r(),[u,h]=t.useState([]),[w,f]=t.useState(!0),[b,y]=t.useState(""),[I,j]=t.useState(!1),[x,v]=t.useState(null),[C,N]=t.useState(!1),[S,_]=t.useState(""),[$,z]=t.useState(""),[J,U]=t.useState(!1),[E,O]=t.useState({name:"",breed:"",gender:"",birthDate:"",microchipNumber:""}),[D,k]=t.useState(null),[T,F]=t.useState(null),[G,B]=t.useState({x:0,y:0}),[V,Z]=t.useState(1),[X,A]=t.useState(null),[q,L]=t.useState(null),[M,P]=t.useState(null),[Y,R]=t.useState(""),[W,Q]=t.useState(""),[H,K]=t.useState(void 0),[ee,te]=t.useState(void 0),ae=t.useCallback(async()=>{try{f(!0),y("");const e=await async function(e){try{const t=await e();return{data:t.data,error:t.error}}catch(b){return{data:null,error:b}}}(()=>o.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",p?.id).order("created_at",{ascending:!1}));if(e.error)return s("error","Error fetching dogs",{error:e.error,userId:p?.id}),void y("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");h(e.data||[])}catch(e){s("error","Exception in fetchDogs",{error:e,userId:p?.id}),y("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")}finally{f(!1)}},[p?.id]);t.useEffect(()=>{p&&ae()},[p,ae]);const ie=e=>{v(e),O({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date,microchipNumber:e.microchip_number||""}),F(e.image_url||null);const t=e.vaccine_certifications?.[0];t&&(R(t.rabies_expiry_date||""),Q(t.combo_expiry_date||"")),j(!0)};return w?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-3 text-gray-600",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs(a,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹"]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"}),e.jsx("p",{className:"text-gray-600",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™"})]}),e.jsx(a,{to:"/dog-registration",children:e.jsxs(i,{children:[e.jsx(l,{className:"w-4 h-4 mr-2"}),"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²"]})})]}),b&&e.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:b}),$&&e.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:$}),e.jsxs(c,{children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[e.jsx(g,{className:"w-6 h-6 text-blue-600 mr-2"}),"ç™»éŒ²æ¸ˆã¿ãƒ¯ãƒ³ã¡ã‚ƒã‚“ (",u.length,"åŒ¹)"]})}),0===u.length?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(g,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"ã¾ã ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),e.jsx(a,{to:"/dog-registration",children:e.jsxs(i,{children:[e.jsx(l,{className:"w-4 h-4 mr-2"}),"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"]})})]}):e.jsx("div",{className:"space-y-4",children:u.map(t=>e.jsx(n,{dog:t,onEdit:ie},t.id))})]}),I&&x&&e.jsx(d,{dog:x,isUpdating:C||J,error:S,success:$,dogFormData:E,dogImagePreview:T,onClose:()=>j(!1),onSubmit:e=>{(async e=>{if(e.preventDefault(),x){N(!0),_(""),z("");try{const e={name:E.name,breed:E.breed,gender:E.gender,birth_date:E.birthDate,...E.microchipNumber&&{microchip_number:E.microchipNumber}};if(D||T||(e.image_url=""),D){const t=await createImageBitmap(D),a=Math.min(t.width,t.height),i=Math.min(1200,a),r=document.createElement("canvas");r.width=i,r.height=i;const s=r.getContext("2d"),c=!!X,n=c?X.x:(t.width-a)/2,d=c?X.y:(t.height-a)/2,m=c?X.width:a,l=c?X.height:a;s.drawImage(t,n,d,m,l,0,0,i,i);const g=e=>{const t=e.split(","),a=t[0].match(/:(.*?);/)?.[1]||"image/webp",i=atob(t[1]);let r=i.length;const o=new Uint8Array(r);for(;r--;)o[r]=i.charCodeAt(r);return new Blob([o],{type:a})},p=await new Promise(e=>r.toBlob(t=>{if(t)return e(t);const a=r.toDataURL("image/webp",.9);e(g(a))},"image/webp",.9)),u=new File([p],"dog-square.webp",{type:"image/webp"}),h=`${x.id}/${crypto.randomUUID()}.webp`,{error:w}=await o.storage.from("dog-images").upload(h,u,{upsert:!0,contentType:"image/webp"});if(w)throw w;const{data:f}=o.storage.from("dog-images").getPublicUrl(h),b=f?.publicUrl;if(!b)throw new Error("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");e.image_url=b}const{data:t,error:a}=await o.from("dogs").update(e).eq("id",x.id).eq("owner_id",p?.id).select("id,image_url");if(a)throw a;if(!t||0===t.length)throw new Error("æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯æ¨©é™ã«ã‚ˆã‚Šæ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");if(q||M||Y||W){const{data:{session:e}}=await o.auth.getSession();if(!e?.access_token)throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ï¼ˆæå‡ºï¼‰");const t=async e=>{if("image/jpeg"===e.type)return e;const t=await createImageBitmap(e),a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0);const i=await new Promise(e=>a.toBlob(t=>e(t),"image/jpeg",.92));return new File([i],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg"})},a=async(a,i)=>{const r=await t(a),s=`${e.user.id}/${i}/${Date.now()}-${crypto.randomUUID()}.jpg`,{error:c}=await o.storage.from("vaccine-certs").upload(s,r,{upsert:!1,cacheControl:"0",contentType:"image/jpeg"});if(c){const t="https://onmcivwxtzqajcovptgf.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU",o=await fetch(`${t}/storage/v1/object/vaccine-certs/${s}`,{method:"POST",headers:{Authorization:`Bearer ${e.access_token}`,apikey:a,"Content-Type":"image/jpeg","x-upsert":"false","Cache-Control":"0"},body:r}),c=await o.text();if(!o.ok)throw new Error(`upload ${i} failed: ${o.status} ${c}`)}const{data:n}=o.storage.from("vaccine-certs").getPublicUrl(s);return n.publicUrl};let i=H,r=ee;!i&&q&&(i=await a(q,"rabies")),!r&&M&&(r=await a(M,"combo"));const c=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/submit-vaccine",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"},body:JSON.stringify({dog_id:x.id,rabies_url:i,combo_url:r,rabies_expiry:Y||void 0,combo_expiry:W||void 0})}),n=await c.json().catch(()=>({}));if(!c.ok||!n?.success)throw new Error(`æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ${c.status} ${JSON.stringify(n)}`);s("info","Vaccine submit via Edge Function completed"),K(void 0),te(void 0)}z("ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await ae(),setTimeout(()=>{j(!1),z(""),k(null),F(null),L(null),P(null),R(""),Q("")},2e3)}catch(t){s("error","Error updating dog",{error:t,dogId:x?.id});let e="ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";t instanceof Error&&(e=t.message.includes("520")||t.message.includes("Cloudflare")?"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚":t.message.includes("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")?t.message:`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${t.message}`),_(e)}finally{N(!1)}}})(e)},onDelete:e=>{(async e=>{U(!0),_("");try{s("info","Deleting dog:",{name:e.name,id:e.id});const{error:a}=await o.from("vaccine_certifications").delete().eq("dog_id",e.id);if(a&&s("warn","Error deleting vaccine certifications",{error:a,dogId:e.id}),e.image_url)try{const t=new URL(e.image_url).pathname.split("/"),a=t[t.length-1],i=`${e.id}/${a}`,{error:r}=await o.storage.from("dog-images").remove([i])}catch(t){}const i=e.vaccine_certifications?.[0];if(i){const e=[];if(i.rabies_vaccine_image&&e.push(i.rabies_vaccine_image),i.combo_vaccine_image&&e.push(i.combo_vaccine_image),e.length>0){const{error:t}=await o.storage.from("vaccine-certs").remove(e)}}const{error:r}=await o.from("dogs").delete().eq("id",e.id);if(r)throw s("error","Error deleting dog",{error:r,dogId:e.id}),r;s("info","Dog deleted successfully",{dogName:e.name}),await ae(),j(!1),z(`${e.name}ã®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`),setTimeout(()=>{z("")},3e3)}catch(a){s("error","Error deleting dog",{error:a,dogId:e?.id});const t=a.message||"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ";_(t)}finally{U(!1)}})(e)},onFormChange:O,onImageSelect:e=>{const t=e.target.files?.[0];if(s("info","ğŸ” File selected:",t?{name:t.name,type:t.type,size:t.size,lastModified:t.lastModified,isFileObject:t instanceof File}:{message:"No file selected"}),t)try{if(!(t instanceof File))return void _("æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");if(t.size>10485760)return void _("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type||!t.type.startsWith("image/"))return void _(`ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${t.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return void _(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${t.type}`);k(t),s("info","âœ… Dog image file set successfully:",{name:t.name,type:t.type,size:t.size});const e=new FileReader;e.onload=e=>{F(e.target?.result),B({x:0,y:0}),Z(1),A(null)},e.readAsDataURL(t)}catch(a){_("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}},onImageRemove:()=>{(async()=>{if(x){k(null),F(null),v({...x,image_url:null});try{N(!0),_("");try{if(x.image_url&&x.image_url.includes("dog-images/")){const e=x.image_url.split("dog-images/")[1];e&&await o.storage.from("dog-images").remove([e])}}catch(e){}const{data:t,error:a}=await o.from("dogs").update({image_url:""}).eq("id",x.id).eq("owner_id",p?.id).select("id,image_url");if(a)return s("error","Error updating dog image_url",{error:a,dogId:x.id}),void _("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");t&&0!==t.length||(s("warn","Image delete update affected 0 rows",{dogId:x.id,userId:p?.id}),_("ç”»åƒã®å‰Šé™¤ãŒåæ˜ ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ï¼ˆæ¨©é™ã¾ãŸã¯å¯¾è±¡ãªã—ï¼‰")),await ae(),s("info","âœ… Dog image removed successfully",{dogId:x.id}),z("ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"),setTimeout(()=>{z("")},3e3)}catch(t){s("error","Error removing dog image",{error:t,dogId:x?.id}),_("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{N(!1)}}})()},onImageCropped:e=>(e=>{k(e);const t=URL.createObjectURL(e);F(t)})(e),crop:G,zoom:V,onCropChange:B,onZoomChange:Z,onCropComplete:(e,t)=>A(t),rabiesVaccineFile:q,comboVaccineFile:M,rabiesExpiryDate:Y,comboExpiryDate:W,onRabiesVaccineSelect:e=>{const t=e.target.files?.[0];if(t){if(t.size>10485760)return void _("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type.startsWith("image/"))return void _("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");L(t),(async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(!e?.access_token)throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");const a=async e=>{if("image/jpeg"===e.type)return e;const t=await createImageBitmap(e),a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0);const i=await new Promise(e=>a.toBlob(t=>e(t),"image/jpeg",.92));return new File([i],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg"})},i=await a(t),r=`${e.user.id}/rabies/${Date.now()}-${crypto.randomUUID()}.jpg`,{error:s}=await o.storage.from("vaccine-certs").upload(r,i,{upsert:!1,cacheControl:"0",contentType:"image/jpeg"});if(s){const t="https://onmcivwxtzqajcovptgf.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU",o=await fetch(`${t}/storage/v1/object/vaccine-certs/${r}`,{method:"POST",headers:{Authorization:`Bearer ${e.access_token}`,apikey:a,"Content-Type":"image/jpeg","x-upsert":"false","Cache-Control":"0"},body:i}),s=await o.text();if(!o.ok)throw new Error(`upload rabies failed: ${o.status} ${s}`)}const{data:c}=o.storage.from("vaccine-certs").getPublicUrl(r);K(c.publicUrl)}catch(e){_(e instanceof Error?e.message:"ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")}})()}else L(null),K(void 0)},onComboVaccineSelect:e=>{const t=e.target.files?.[0];if(t){if(t.size>10485760)return void _("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");if(!t.type.startsWith("image/"))return void _("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");P(t),(async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(!e?.access_token)throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");const a=async e=>{if("image/jpeg"===e.type)return e;const t=await createImageBitmap(e),a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0);const i=await new Promise(e=>a.toBlob(t=>e(t),"image/jpeg",.92));return new File([i],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg"})},i=await a(t),r=`${e.user.id}/combo/${Date.now()}-${crypto.randomUUID()}.jpg`,{error:s}=await o.storage.from("vaccine-certs").upload(r,i,{upsert:!1,cacheControl:"0",contentType:"image/jpeg"});if(s){const t="https://onmcivwxtzqajcovptgf.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU",o=await fetch(`${t}/storage/v1/object/vaccine-certs/${r}`,{method:"POST",headers:{Authorization:`Bearer ${e.access_token}`,apikey:a,"Content-Type":"image/jpeg","x-upsert":"false","Cache-Control":"0"},body:i}),s=await o.text();if(!o.ok)throw new Error(`upload combo failed: ${o.status} ${s}`)}const{data:c}=o.storage.from("vaccine-certs").getPublicUrl(r);te(c.publicUrl)}catch(e){_(e instanceof Error?e.message:"ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")}})()}else P(null),te(void 0)},onRabiesExpiryDateChange:R,onComboExpiryDateChange:Q,onSubmitVaccine:async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(!e?.access_token)throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");const t=async e=>{if("image/jpeg"===e.type)return e;const t=await createImageBitmap(e),a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0);const i=await new Promise(e=>a.toBlob(t=>e(t),"image/jpeg",.92));return new File([i],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg"})},a=async(a,i)=>{const r=await t(a),s=`${e.user.id}/${i}/${Date.now()}-${crypto.randomUUID()}.jpg`,{error:c}=await o.storage.from("vaccine-certs").upload(s,r,{upsert:!1,cacheControl:"0",contentType:"image/jpeg"});if(c)try{const t="https://onmcivwxtzqajcovptgf.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU",o=await fetch(`${t}/storage/v1/object/vaccine-certs/${s}`,{method:"POST",headers:{Authorization:`Bearer ${e.access_token}`,apikey:a,"Content-Type":"image/jpeg","x-upsert":"false","Cache-Control":"0"},body:r}),c=await o.text();if(!o.ok)throw new Error(`fallback upload ${i} failed: ${o.status} ${c}`)}catch(d){const e=d instanceof Error?d.message:String(d);throw _(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e}`),d}const{data:n}=o.storage.from("vaccine-certs").getPublicUrl(s);return n.publicUrl};let i=H,r=ee;if(!i&&q&&(i=await a(q,"rabies")),!r&&M&&(r=await a(M,"combo")),!i&&!r)return void _("ãƒ¯ã‚¯ãƒãƒ³ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç”»åƒã‚’é¸ã³ç›´ã—ã¦ã‹ã‚‰æå‡ºã—ã¦ãã ã•ã„ã€‚");const s=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/submit-vaccine",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"},body:JSON.stringify({dog_id:x.id,rabies_url:i,combo_url:r,rabies_expiry:Y||void 0,combo_expiry:W||void 0})}),c=await s.json();if(!s.ok||!c?.success)throw new Error(c?.error||"æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ");L(null),P(null),K(void 0),te(void 0),z("ãƒ¯ã‚¯ãƒãƒ³æå‡ºã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ˆå¯©æŸ»å¾…ã¡ï¼‰"),await ae()}catch(e){_(e instanceof Error?e.message:"æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ")}}})]})}export{p as DogManagement,p as default};
