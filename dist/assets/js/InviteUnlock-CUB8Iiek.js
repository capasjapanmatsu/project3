import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{d as s,a,L as i}from"./router-Cg6wfOY4.js";import{B as r,t as n}from"./Button-CJFAG6V0.js";import{u as c,s as o,C as l}from"./index-DN5wQuSm.js";import{K as m}from"./ui-basic-CaMd9YQ-.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function d(){const{token:d}=s(),x=a(),{user:u,effectiveUserId:h}=c(),[p,j]=t.useState(null),[f,b]=t.useState("ドッグラン"),[y,w]=t.useState(""),[N,g]=t.useState(""),[v,I]=t.useState("entry"),[k,S]=t.useState(!1),[C,J]=t.useState(!0),[z,O]=t.useState(null),[E,T]=t.useState(null),G=t.useRef(null);t.useEffect(()=>{(async()=>{try{if(!d)return void O("トークンが見つかりません");const e=await fetch(`https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/invite-unlock?token=${encodeURIComponent(d)}`,{headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ubWNpdnd4dHpxYWpjb3ZwdGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxODk3OTUsImV4cCI6MjA2NDc2NTc5NX0.AqFCz3GQUVeGaG2988LCzsE4aJpeio3xScoxv5T0-OU"}});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(t?.error||"招待の取得に失敗しました")}const t=(await e.json()).invite;j(t);const{data:s}=await o.from("dog_parks").select("id,name,address").eq("id",t.park_id).maybeSingle();s&&(b(s.name||"ドッグラン"),w(s.address||""),g(s.id||""))}catch(e){O(e instanceof Error?e.message:"読み込みに失敗しました")}finally{J(!1)}})()},[d]),t.useEffect(()=>()=>{G.current&&clearTimeout(G.current)},[]);if(C)return e.jsx("div",{className:"max-w-2xl mx-auto p-6",children:e.jsx(l,{className:"p-6 text-center",children:"読み込み中..."})});if(z)return e.jsx("div",{className:"max-w-2xl mx-auto p-6",children:e.jsx(l,{className:"p-6 text-center text-red-700",children:z})});if(!p)return null;const U=new Date(p.start_time),D=new Date(p.end_time),X=new Date,Z=X>=U&&X<=D;return e.jsx("div",{className:"max-w-2xl mx-auto p-6",children:e.jsxs(l,{className:"p-6",children:[e.jsx("h1",{className:"text-xl font-semibold mb-2",children:"貸し切りドッグランのご招待"}),e.jsxs("p",{className:"text-gray-700 mb-2",children:["「",f,"」の貸し切り予約です。"]}),y&&e.jsxs("div",{className:"text-sm text-gray-600 mb-2",children:["住所: ",y]}),e.jsxs("div",{className:"bg-gray-50 rounded p-4 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"開始"}),e.jsx("span",{className:"font-medium",children:U.toLocaleString("ja-JP")})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-gray-600",children:"終了"}),e.jsx("span",{className:"font-medium",children:D.toLocaleString("ja-JP")})]})]}),N&&e.jsx("div",{className:"mb-4",children:e.jsx(i,{to:`/parks/${N}`,className:"text-blue-700 underline",children:"施設の詳細を見る（住所・説明など）"})}),e.jsxs("div",{className:"text-xs text-gray-600 mb-4",children:["・予約時間内のみ解錠できます。",e.jsx("br",{}),"・場内ではルールを守って安全にご利用ください。",e.jsx("br",{}),"・解錠までに少し時間がかかる場合があります。"]}),E&&e.jsx("div",{className:"mb-3 text-green-700",children:E}),z&&e.jsx("div",{className:"mb-3 text-red-700",children:z}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("button",{onClick:()=>I("entry"),className:"px-3 py-1 rounded-full text-sm font-medium "+("entry"===v?"bg-blue-600 text-white":"bg-gray-200 text-gray-700"),children:"入場"}),e.jsx("button",{onClick:()=>I("exit"),className:"px-3 py-1 rounded-full text-sm font-medium "+("exit"===v?"bg-red-600 text-white":"bg-gray-200 text-gray-700"),children:"退場"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:async()=>{try{S(!0),setTimeout(()=>S(!1),500);try{await n("exit"===v?"heavy":"medium")}catch{}if(O(null),T(null),!p)throw new Error("招待情報がありません");const{data:{session:e}}=await o.auth.getSession();if(!e?.access_token)throw new Error("ログインが必要です");const t=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/invite-unlock",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({token:p.token,userId:u?.id||h,purpose:v})}),s=await t.json().catch(()=>({}));if(!t.ok||!s?.success)throw new Error(s?.error||"解錠に失敗しました");T("解錠しました。安全にご利用ください"),G.current&&clearTimeout(G.current),G.current=window.setTimeout(()=>{I(e=>"entry"===e?"exit":"entry")},3e3)}catch(e){O(e instanceof Error?e.message:"解錠に失敗しました")}},disabled:!Z,title:Z?"entry"===v?"入場（解錠）":"退場（解錠）":"現在は解錠できません",className:`relative overflow-hidden flex items-center justify-center rounded-full shadow-lg transition-colors ${Z?"exit"===v?"bg-red-600 hover:bg-red-700 text-white":"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-300 text-gray-500 cursor-not-allowed"} w-20 h-20 text-lg font-semibold`,children:[e.jsx("span",{className:"absolute inset-0 rounded-full bg-white/30 transition-opacity "+(k?"opacity-100":"opacity-0")}),e.jsx(m,{className:"w-7 h-7 mr-1"})]}),e.jsx(r,{variant:"secondary",onClick:()=>x("/community"),children:"コミュニティへ戻る"})]})]})})}export{d as default};
