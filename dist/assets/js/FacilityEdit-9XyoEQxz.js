import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{c as t,a,L as i}from"./router-DXQOdrLL.js";import{u as r,s as l,B as d,S as n}from"./index-DnG2j1CT.js";import{C as c}from"./Card-DqVnP9TA.js";import{I as o}from"./ImageCropper-CRlQ0R46.js";import{I as m}from"./Input-BA7ko280.js";import{_ as x,r as h,A as u,t as g,n as p,X as f,aH as b,V as j,j as y,aL as w,av as N}from"./ui-basic-DDpq4BmP.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function v(){const{id:v}=t(),{user:_}=r(),S=a(),[C,q]=s.useState(null),[k,E]=s.useState([]),[$,L]=s.useState(!0),[I,T]=s.useState(!1),[U,D]=s.useState(""),[R,F]=s.useState(""),[P,z]=s.useState(!1),[H,O]=s.useState(""),[W,B]=s.useState(!1),[A,G]=s.useState([]),[M,V]=s.useState(!1),[J,K]=s.useState(null),[Q,X]=s.useState(null),[Y,Z]=s.useState(!1),[ee,se]=s.useState({name:"",category_id:"",address:"",phone:"",website:"",description:""}),[te,ae]=s.useState(null),[ie,re]=s.useState("");s.useEffect(()=>{_&&v?le():S("/my-facilities-management")},[_,v,S]);const le=async()=>{try{L(!0);const{data:e,error:s}=await l.from("pet_facilities").select("*").eq("id",v).eq("owner_id",_?.id).single();if(s)throw s;if(!e)return void S("/my-facilities-management");q(e),se({name:e.name||"",category_id:e.category_id||"",address:e.address||"",phone:e.phone||"",website:e.website||"",description:e.description||""}),e.identity_document_url&&re(e.identity_document_url);const{data:t,error:a}=await l.from("pet_facility_images").select("*").eq("facility_id",v).order("display_order",{ascending:!0});if(a)throw a;G(t||[]);const{data:i,error:r}=await l.from("facility_categories").select("*").order("name");if(r)throw r;E(i||[])}catch(e){D("データの取得に失敗しました。")}finally{L(!1)}},de=(e,s)=>{const t=e.target.files?.[0];t&&(t.type.startsWith("image/")?t.size>10485760?D("ファイルサイズは10MB未満にしてください。"):(K(t),X(s??null),V(!0)):D("画像ファイルを選択してください。"))},ne=e=>{const{name:s,value:t}=e.target;se(e=>({...e,[s]:t}))};if($)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!C)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"施設が見つかりません"}),e.jsx(i,{to:"/my-facilities-management",children:e.jsx(d,{children:"管理画面に戻る"})})]})});return e.jsxs(e.Fragment,{children:[e.jsx(n,{title:`${C.name} - 施設編集`,description:"ペット関連施設の情報を編集・管理します。"}),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:e.jsxs(i,{to:"/my-facilities-management",className:"flex items-center text-blue-600 hover:text-blue-800",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"施設管理一覧に戻る"]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("div",{className:"bg-white rounded-lg border p-6 mb-6",children:e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:C.name}),e.jsx("p",{className:"text-gray-600 mt-1",children:C.address}),e.jsx("div",{className:"flex items-center mt-2",children:(s=>{switch(s){case"approved":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full",children:"承認済み"});case"pending":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full",children:"審査中"});case"rejected":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full",children:"却下"});default:return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full",children:"不明"})}})(C.status)})]}),e.jsx("div",{className:"flex space-x-3",children:"approved"===C.status&&e.jsx(i,{to:`/parks?view=facilities&facility=${C.id}`,children:e.jsxs(d,{variant:"secondary",className:"min-w-[100px]",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"公開ページ"]})})})]})}),U&&e.jsxs("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 mb-6",children:[e.jsx(u,{className:"w-5 h-5 inline mr-2"}),U]}),R&&e.jsxs("div",{className:"bg-green-100 border border-green-300 text-green-800 rounded-lg p-4 mb-6",children:[e.jsx(g,{className:"w-5 h-5 inline mr-2"}),R]}),e.jsxs(c,{className:"p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(p,{className:"w-6 h-6 text-blue-600 mr-2"}),"施設情報の編集"]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),C&&_){T(!0),D(""),F("");try{if(!ee.name.trim())throw new Error("施設名を入力してください。");if(!ee.category_id)throw new Error("カテゴリを選択してください。");if(!ee.address.trim())throw new Error("住所を入力してください。");let e=C.identity_document_url,s=C.identity_document_filename;if(te){const t=Date.now(),a=`identity_${_.id}_${t}.jpg`,{data:i,error:r}=await l.storage.from("vaccine-certs").upload(a,te,{contentType:"image/jpeg",upsert:!0});if(r)throw r;const{data:d}=l.storage.from("vaccine-certs").getPublicUrl(a);e=d.publicUrl,s=te.name}const{error:t}=await l.from("pet_facilities").update({name:ee.name.trim(),category_id:ee.category_id,address:ee.address.trim(),phone:ee.phone.trim()||null,website:ee.website.trim()||null,description:ee.description.trim()||null,identity_document_url:e,identity_document_filename:s,identity_status:te?"submitted":C.identity_status,updated_at:(new Date).toISOString()}).eq("id",C.id);if(t)throw t;F("施設情報を更新しました。"),await le(),setTimeout(()=>{F("")},3e3)}catch(s){D(s instanceof Error?s.message:"更新に失敗しました。")}finally{T(!1)}}},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設名 *"}),e.jsx(m,{name:"name",value:ee.name,onChange:ne,placeholder:"施設名を入力",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"カテゴリ *"}),e.jsxs("select",{name:"category_id",value:ee.category_id,onChange:ne,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"カテゴリを選択"}),k.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所 *"}),e.jsx(m,{name:"address",value:ee.address,onChange:ne,placeholder:"住所を入力",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(m,{name:"phone",value:ee.phone,onChange:ne,placeholder:"電話番号を入力"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(m,{name:"website",value:ee.website,onChange:ne,placeholder:"https://example.com"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設説明"}),e.jsx("textarea",{name:"description",value:ee.description,onChange:ne,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"施設の特徴やサービス内容を入力"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"身分証明書"}),e.jsxs("div",{className:"space-y-4",children:[ie&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:ie,alt:"身分証明書プレビュー",className:"max-w-xs h-auto border rounded-lg"}),te&&e.jsx("button",{type:"button",onClick:()=>{ae(null),re(C.identity_document_url||"")},className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(f,{className:"w-4 h-4"})})]}),e.jsxs("div",{children:[e.jsx("input",{type:"file",accept:"image/*",onChange:async e=>{const s=e.target.files?.[0];if(s)try{const e=await(e=>new Promise((s,t)=>{const a=document.createElement("canvas"),i=a.getContext("2d"),r=document.createElement("img");r.onload=()=>{let e=r.naturalWidth,t=r.naturalHeight;e>t?e>800&&(t=800*t/e,e=800):t>600&&(e=600*e/t,t=600),a.width=e,a.height=t,i?.drawImage(r,0,0,e,t),s(a.toDataURL("image/jpeg",.8))},r.onerror=()=>t(new Error("画像の読み込みに失敗しました")),r.src=URL.createObjectURL(e)}))(s);ae(s),re(e)}catch(t){D("画像の処理に失敗しました。")}},className:"hidden",id:"identity-upload"}),e.jsxs("label",{htmlFor:"identity-upload",className:"inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 cursor-pointer",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),ie?"画像を変更":"画像をアップロード"]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設画像 (最大5枚)"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"1枚目がメイン画像として使用されます。施設の雰囲気がわかる画像をアップロードしてください。"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-4",children:[A.map((s,t)=>e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:s.image_url,alt:`施設画像 ${t+1}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded",children:0===t?"メイン":t+1})}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>de(e,t),className:"hidden",id:`image-replace-${t}`}),e.jsx("label",{htmlFor:`image-replace-${t}`,className:"bg-white text-gray-600 p-1 rounded shadow hover:bg-gray-50 cursor-pointer",title:"画像を変更",children:e.jsx(b,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>(async e=>{if(window.confirm("この画像を削除しますか？"))try{D("");const{error:s}=await l.from("pet_facility_images").delete().eq("id",e);if(s)throw s;G(s=>s.filter(s=>s.id!==e));const t=A.filter(s=>s.id!==e);for(let e=0;e<t.length;e++){const s=0===e?"main":"additional";t[e].display_order===e&&t[e].image_type===s||await l.from("pet_facility_images").update({display_order:e,image_type:s}).eq("id",t[e].id)}F("画像を削除しました。"),setTimeout(()=>F(""),3e3)}catch(s){D("画像の削除に失敗しました。")}})(s.id),className:"bg-red-500 text-white p-1 rounded shadow hover:bg-red-600",title:"画像を削除",children:e.jsx(j,{className:"w-4 h-4"})})]})})]},s.id)),A.length<5&&e.jsxs("div",{className:"aspect-square bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:e=>de(e),className:"hidden",id:"image-add"}),e.jsxs("label",{htmlFor:"image-add",className:"flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600",children:[e.jsx(y,{className:"w-8 h-8 mb-2"}),e.jsx("span",{className:"text-sm font-medium",children:"画像を追加"})]})]})]}),0===A.length&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(w,{className:"w-12 h-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"text-sm",children:"まだ画像がアップロードされていません"}),e.jsx("p",{className:"text-xs mt-1",children:"最初の画像がメイン画像として使用されます"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(d,{type:"submit",isLoading:I,children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"更新"]})})]})]}),e.jsx(c,{className:"p-6 border-red-200 bg-red-50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(j,{className:"w-6 h-6 text-red-600 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-red-900 mb-2",children:"危険な操作"}),e.jsxs("p",{className:"text-sm text-red-800 mb-4",children:["この施設を完全に削除します。削除後はデータの復旧はできません。","approved"===C.status&&e.jsx("span",{className:"block mt-1 font-medium",children:"※ 承認済みの施設を削除すると、公開ページからも削除されます。"})]}),e.jsxs(d,{onClick:()=>z(!0),className:"bg-red-600 hover:bg-red-700 text-white",size:"sm",children:[e.jsx(j,{className:"w-4 h-4 mr-2"}),"施設を削除"]})]})]})}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(j,{className:"w-6 h-6 text-red-600 mr-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"施設の削除確認"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[e.jsx("span",{className:"font-medium text-red-600",children:"警告:"})," この操作は取り消せません。"]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["削除を実行するには、施設名「",e.jsx("span",{className:"font-medium",children:C.name}),"」を入力してください。"]}),e.jsx("input",{type:"text",value:H,onChange:e=>O(e.target.value),placeholder:"施設名を入力",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(d,{onClick:()=>{z(!1),O("")},variant:"secondary",disabled:W,children:"キャンセル"}),e.jsxs(d,{onClick:async()=>{if(C&&H===C.name){if(window.confirm("本当にこの施設を完全に削除しますか？\nこの操作は取り消せません。"))try{B(!0),D("");const{data:s,error:t}=await l.from("pet_facilities").select("id, name, owner_id, created_at").eq("id",C.id).single(),{data:a}=await l.from("profiles").select("role").eq("id",_?.id).single();try{const{error:e,count:s}=await l.from("pet_facility_images").delete().eq("facility_id",C.id)}catch(e){}let i=l.from("pet_facilities").delete();i="admin"===a?.role?i.eq("id",C.id):i.eq("id",C.id).eq("owner_id",_?.id);const{error:r,count:d}=await i;if(r){if(r.message?.includes("RLS"))throw new Error("権限エラー: この施設を削除する権限がありません。管理者にお問い合わせください。");throw new Error(`削除処理エラー: ${r.message}`)}const{data:n,error:c}=await l.from("pet_facilities").select("id").eq("id",C.id).single();if(n){if("admin"!==a?.role)throw new Error("削除する施設が見つからない、または削除権限がありません。");{const{error:e}=await l.rpc("force_delete_facility",{target_facility_id:C.id});if(e)throw new Error(`削除に失敗しました。データベース管理者にお問い合わせください。エラー: ${e.message}`);const{data:s}=await l.from("pet_facilities").select("id").eq("id",C.id).single();if(s)throw new Error("施設の削除に失敗しました。データベース管理者にお問い合わせください。")}}else if(c&&"PGRST116"!==c.code)throw new Error(`削除検証でエラーが発生しました: ${c.message}`);F("施設が正常に削除されました。"),setTimeout(()=>{S("/my-facilities-management")},3e3)}catch(s){D(`削除処理でエラーが発生しました: ${s.message}`)}finally{B(!1),z(!1),O("")}}else D("施設名が正しく入力されていません。")},className:"bg-red-600 hover:bg-red-700 text-white",disabled:W||H!==C.name,isLoading:W,children:[e.jsx(j,{className:"w-4 h-4 mr-2"}),"削除実行"]})]})]})}),M&&J&&e.jsx(o,{imageFile:J,onCropComplete:async e=>{if(C)try{Z(!0),D("");const s=Date.now(),t=`facility_${C.id}_${s}.jpg`,{data:a,error:i}=await l.storage.from("vaccine-certs").upload(t,e,{contentType:"image/jpeg",upsert:!0});if(i)throw i;const{data:r}=l.storage.from("vaccine-certs").getPublicUrl(t),d=r.publicUrl;if(null===Q){const e=A.length,s=0===A.length?"main":"additional",{data:t,error:a}=await l.from("pet_facility_images").insert({facility_id:C.id,image_url:d,image_type:s,display_order:e}).select().single();if(a)throw a;G(e=>[...e,t])}else{const e=A[Q],{data:s,error:t}=await l.from("pet_facility_images").update({image_url:d,updated_at:(new Date).toISOString()}).eq("id",e.id).select().single();if(t)throw t;G(e=>e.map(e=>e.id===s.id?s:e))}F("画像をアップロードしました。"),setTimeout(()=>F(""),3e3)}catch(s){D("画像のアップロードに失敗しました。")}finally{Z(!1),V(!1),K(null),X(null)}},onCancel:()=>{V(!1),K(null),X(null)},aspectRatio:1,maxWidth:400,maxHeight:400})]})]})]})}export{v as default};
