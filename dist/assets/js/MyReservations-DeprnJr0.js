const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-DbqOsxtD.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as t}from"./motion-CuO0nkIV.js";import{r as i}from"./react-vendor-cniURDpR.js";import{L as s}from"./router-Cg6wfOY4.js";import{B as a}from"./Button-6ascT97E.js";import{u as r,s as n,C as d}from"./index-hxb5tPha.js";import"./ui-basic-icnN6BOT.js";import"./heavy-features-BIdEME4r.js";function o(){const{user:o}=r(),[c,l]=i.useState([]),[m,_]=i.useState(!0),[f,u]=i.useState(""),[p,x]=i.useState(!1);i.useEffect(()=>{(async()=>{try{_(!0);const{data:e,error:t}=await n.from("facility_reservations").select("*, facility:pet_facilities(name, owner_id)").eq("user_id",o?.id).neq("status","cancelled").order("reserved_date",{ascending:!1});if(t)throw t;l(e)}catch(e){u(e?.message||"取得に失敗しました")}finally{_(!1)}})()},[o?.id]);const y=async t=>{if(window.confirm("この予約をキャンセルしますか？\n開始1時間前までキャンセル可能です。"))if((e=>{const[t,i]=String(e.start_time).split(":").map(e=>parseInt(e,10)),s=new Date(`${e.reserved_date}T00:00:00`);s.setHours(isNaN(t)?0:t,isNaN(i)?0:i,0,0);const a=new Date(s.getTime()-36e5);return(new Date).getTime()<=a.getTime()&&"cancelled"!==e.status})(t))try{x(!0);const{error:i}=await n.from("facility_reservations").update({status:"cancelled"}).eq("id",t.id).eq("user_id",o?.id);if(i)throw i;try{const{notifyAppAndLine:i}=await e(async()=>{const{notifyAppAndLine:e}=await import("./notify-BikvHL_j.js");return{notifyAppAndLine:e}},__vite__mapDeps([0])),s=t.seat_code?`座席:${t.seat_code}`:"座席:指定なし",a=`${window.location.origin}/my-reservations`;await i({userId:o.id,title:"予約をキャンセルしました",message:`${t.reserved_date} ${t.start_time}-${t.end_time} / ${t.guest_count}名 / ${s}`,linkUrl:a,kind:"reservation"});const{data:r}=await n.from("pet_facilities").select("owner_id, name").eq("id",t.facility_id).maybeSingle();if(r?.owner_id){const e=`${window.location.origin}/facilities/${t.facility_id}/reservations`;await i({userId:r.owner_id,title:"予約がキャンセルされました",message:`${r.name} / ${t.reserved_date} ${t.start_time}-${t.end_time}`,linkUrl:e,kind:"reservation"}),await n.from("notifications").insert({user_id:r.owner_id,title:"予約がキャンセルされました",message:`${r.name} / ${t.reserved_date} ${t.start_time}-${t.end_time}`,link_url:e,read:!1,type:"reservation_reminder",data:{}}),await n.from("community_messages").insert({user_id:o.id,facility_id:t.facility_id,content:`予約をキャンセルしました。(${t.reserved_date} ${t.start_time}-${t.end_time})`,context:"reservation"})}}catch{}l(e=>e.filter(e=>e.id!==t.id)),alert("キャンセルしました")}catch(i){alert(`キャンセルに失敗しました\n${i?.message||""}`)}finally{x(!1)}else alert("開始1時間前を過ぎているためキャンセルできません。")};return m?t.jsx("div",{className:"p-6",children:"読み込み中..."}):t.jsxs("div",{className:"max-w-3xl mx-auto p-6 space-y-6",children:[t.jsx("h1",{className:"text-xl font-semibold mb-2",children:"店舗予約一覧"}),f&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 text-red-700 text-sm",children:f}),t.jsx(d,{className:"p-4",children:0===c.length?t.jsx("div",{className:"text-center py-8 text-gray-600",children:"予約はありません"}):t.jsx("div",{className:"space-y-3",children:c.map(e=>{const i=`${e.reserved_date} ${e.start_time}`;return t.jsxs("div",{className:"p-3 border rounded-lg flex items-center justify-between",children:[t.jsxs("div",{className:"text-sm text-gray-800",children:[t.jsx("div",{className:"font-semibold",children:e.facility?.name||"施設"}),t.jsxs("div",{className:"text-gray-600",children:[i," / ",e.guest_count,"名 / ",e.seat_code||"座席:指定なし"," / 状態: ",e.status]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(a,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white",disabled:p,onClick:()=>y(e),children:"キャンセル"}),t.jsx(s,{to:`/facilities/${e.facility_id}`,children:t.jsx(a,{size:"sm",children:"店舗ページ"})})]})]},e.id)})})})]})}export{o as default};
