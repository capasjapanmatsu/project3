const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-BHS2ZDIu.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as t}from"./motion-CuO0nkIV.js";import{u as s}from"./usePremiumOwner-CAKE0cyF.js";import{r as a}from"./react-vendor-cniURDpR.js";import{B as i}from"./Button-D7FFKgkK.js";import{u as r,s as n,C as o}from"./index-qwdJeTcH.js";import{P as l}from"./PremiumPaywall-mv5sqwfp.js";import{d as c,a as d}from"./router-Cg6wfOY4.js";import"./ui-basic-icnN6BOT.js";import"./heavy-features-BIdEME4r.js";function m(){const m=s(),{id:u}=c(),{user:f}=r(),p=d(),[_,x]=a.useState(!0),[g,y]=a.useState(!1),[h,S]=a.useState(60),[w,j]=a.useState(30),[v,N]=a.useState([]),[$,b]=a.useState(()=>(new Date).toISOString().split("T")[0]),[D,A]=a.useState(""),[B,O]=a.useState(""),[T,k]=a.useState(1),[q,C]=a.useState(""),[I,J]=a.useState("09:00"),[M,P]=a.useState("18:00"),[L,E]=a.useState(!1),[H,U]=a.useState([!1,!1,!1,!1,!1,!1,!1]),[R,V]=a.useState(new Set),[z,F]=a.useState(new Set);a.useEffect(()=>{(async()=>{try{x(!0);const{data:e}=await n.from("facility_reservation_settings").select("*").eq("facility_id",u).maybeSingle();y(Boolean(e?.enabled)),S(e?.slot_unit_minutes||60),j(e?.allowed_days_ahead||30);const{data:t}=await n.from("facility_seats").select("seat_code").eq("facility_id",u);N((t||[]).map(e=>e.seat_code));const{data:s}=await n.from("pet_facilities").select("opening_time, closing_time, weekly_closed_days, specific_closed_dates, specific_open_dates").eq("id",u).maybeSingle();s?.opening_time&&J(String(s.opening_time).slice(0,5)),s?.closing_time&&P(String(s.closing_time).slice(0,5));try{if(s?.weekly_closed_days){const e=JSON.parse(String(s.weekly_closed_days));Array.isArray(e)&&7===e.length&&U(e.map(Boolean))}}catch{}try{if(s?.specific_closed_dates){const e=JSON.parse(String(s.specific_closed_dates));Array.isArray(e)&&V(new Set(e))}}catch{}try{if(s?.specific_open_dates){const e=JSON.parse(String(s.specific_open_dates));Array.isArray(e)&&F(new Set(e))}}catch{}}finally{x(!1)}})()},[u]);const G=a.useMemo(()=>function(e,t,s){const a=[],i=new Date(`1970-01-01T${e}:00`),r=new Date(`1970-01-01T${t}:00`);if(r<=i)return a;let n=i;for(;n<r;){const e=n.getHours().toString().padStart(2,"0"),t=n.getMinutes().toString().padStart(2,"0"),i=new Date(n.getTime()+60*s*1e3);if(i>r)break;const o=i.getHours().toString().padStart(2,"0"),l=i.getMinutes().toString().padStart(2,"0");a.push({start:`${e}:${t}`,end:`${o}:${l}`}),n=i}return a}(I,M,h),[I,M,h]),K=a.useMemo(()=>{const e=$;if(!e)return!1;if(z.has(e))return!1;if(R.has(e))return!0;const t=new Date(`${e}T00:00:00`).getDay();return Boolean(H[t])},[$,H,R,z]),Q=a.useMemo(()=>{if(K)return[];const e=(new Date).toISOString().split("T")[0];if($!==e)return G;const t=new Date(Date.now()+36e5);return G.filter(({start:e})=>new Date(`${$}T${e}:00`)>=t)},[G,$,K]);if("active"!==m.state)return t.jsx("div",{className:"max-w-3xl mx-auto p-4",children:t.jsx(l,{})});if(_)return t.jsx("div",{className:"p-6",children:"読み込み中..."});if(!g)return t.jsx("div",{className:"p-6",children:"この施設では現在予約を受け付けていません。"});const W=new Date,X=new Date;X.setDate(W.getDate()+w);const Y=e=>e.toISOString().split("T")[0];return t.jsx("div",{className:"max-w-2xl mx-auto p-6",children:t.jsxs(o,{className:"p-6",children:[t.jsx("h1",{className:"text-xl font-semibold mb-4",children:"予約"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"予約者名"}),t.jsx("input",{type:"text",className:"border rounded px-2 py-1 flex-1",placeholder:"予約者名",value:q,onChange:e=>C(e.target.value)})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"日付"}),t.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:$,onChange:e=>b(e.target.value),min:Y(W),max:Y(X)}),K&&t.jsx("span",{className:"ml-2 text-xs text-red-600",children:"定休日のため予約不可"})]}),v.length>0&&t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"座席"}),t.jsxs("select",{className:"border rounded px-2 py-1",value:D,onChange:e=>A(e.target.value),children:[t.jsx("option",{value:"",children:"選択"}),v.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"時間"}),t.jsxs("select",{className:"border rounded px-2 py-1",value:B,onChange:e=>O(e.target.value),disabled:K,children:[t.jsx("option",{value:"",children:"選択"}),Q.map(e=>t.jsxs("option",{value:`${e.start}-${e.end}`,children:[e.start," - ",e.end]},`${e.start}-${e.end}`))]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"人数"}),t.jsx("input",{type:"number",min:1,max:20,className:"border rounded px-2 py-1 w-24",value:T,onChange:e=>k(Number(e.target.value))})]}),t.jsx(i,{onClick:async()=>{if(f)if(K)alert("本日は定休日のため予約できません");else if(B)if(q.trim())if(v.length>0&&!D)alert("座席を選択してください");else try{E(!0);const[t,s]=B.split("-"),{data:a}=await n.from("facility_reservation_settings").select("auto_confirm").eq("facility_id",u).maybeSingle(),i=Boolean(a?.auto_confirm??!0)?"confirmed":"pending";let r=null;const o=await n.from("facility_reservations").insert({facility_id:u,user_id:f.id,customer_name:q.trim(),seat_code:D||"未指定",reserved_date:$,start_time:t,end_time:s,guest_count:T,status:i});if(o.error&&String(o.error.message||"").includes("customer_name")){r=(await n.from("facility_reservations").insert({facility_id:u,user_id:f.id,seat_code:D||"未指定",reserved_date:$,start_time:t,end_time:s,guest_count:T,status:i})).error}else{if(o.error&&/uq_facility_resv_slot/i.test(String(o.error.message)))throw alert("選択した時間帯は満席の可能性があります。別の時間または座席を選択してください。"),o.error;r=o.error}if(r)throw r;try{const{data:e}=await n.from("facility_reservation_settings").select("auto_message_enabled, auto_message_text").eq("facility_id",u).maybeSingle(),t=(Boolean(e?.auto_message_enabled),e?.auto_message_text||"ご予約を受け付けました。お気をつけてお越しください。");await n.from("community_messages").insert({user_id:f.id,facility_id:u,content:t,context:"reservation"}).select().maybeSingle()}catch{}try{const{notifyAppAndLineBoth:a}=await e(async()=>{const{notifyAppAndLineBoth:e}=await import("./notifyAll-DvkW0YpH.js");return{notifyAppAndLineBoth:e}},__vite__mapDeps([0])),i=`${window.location.origin}/my-reservations`;await a({userId:f.id,type:"reservation_reminder",title:"ご予約を受け付けました。",message:`${$} ${t}-${s} / ${T}名`,linkUrl:i});const{data:r}=await n.from("pet_facilities").select("id, owner_id, name").eq("id",u).maybeSingle();if(r?.owner_id){const e=`${window.location.origin}/facilities/${u}/reservations`;await a({userId:r.owner_id,type:"reservation_reminder",title:"新規予約が入りました",message:`${q} 様 / ${r.name} / ${$} ${t}-${s} / ${T}名`,linkUrl:e})}}catch{}alert("予約が完了しました"),p(`/facilities/${u}`)}catch(t){const e="string"==typeof t?.message?t.message:JSON.stringify(t);alert(`予約に失敗しました\n${e}`)}finally{E(!1)}else alert("予約者名を入力してください");else alert("時間を選択してください");else p("/liff/login")},className:"w-full",disabled:L||K,children:L?"処理中...":"予約を確定"})]})]})})}export{m as default};
