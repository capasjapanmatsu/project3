import{j as e}from"./motion-BHsL7Azw.js";import{r as s}from"./react-vendor-CMvmJHsS.js";import{u as a,L as t}from"./router-DXQOdrLL.js";import{u as r,s as n,B as l}from"./index-CaQz5swK.js";import{C as c}from"./Card-DqVnP9TA.js";import{_ as i,a3 as d,a as m,a6 as o,au as x,k as h,t as p,q as j,D as u,x as g,r as f,J as N,X as b,a5 as _}from"./ui-basic-DDpq4BmP.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase-D2tiogv8.js";function v(){const{user:v}=r(),y=a(),[w,S]=s.useState([]),[k,L]=s.useState(!0),[D,C]=s.useState(null),[$,z]=s.useState(!1),[T,E]=s.useState(!1),[J,q]=s.useState(null),[P,M]=s.useState(null),[I,A]=s.useState(null);s.useEffect(()=>{if(v){B();const e=setInterval(()=>{O()},6e4);return()=>clearInterval(e)}y.state?.orderSuccess&&(z(!0),setTimeout(()=>z(!1),5e3))},[v,y]);const B=async()=>{try{const{data:e,error:s}=await n.from("orders").select("\n          *,\n          order_items (\n            *,\n            product:products (*)\n          )\n        ").eq("user_id",v?.id).order("created_at",{ascending:!1});if(s)throw s;const a=(e||[]).map(e=>{const s=e.cancellable_until?new Date(e.cancellable_until):null,a=new Date,t=s&&a<s&&["pending","confirmed"].includes(e.status);let r;if(t&&s){const e=s.getTime()-a.getTime();r=`${Math.floor(e/6e4)}分${Math.floor(e%6e4/1e3)}秒`}return{...e,can_cancel:t,time_left:r}});S(a)}catch(e){}finally{L(!1)}},O=()=>{const e=new Date;S(s=>s.map(s=>{const a=s.cancellable_until?new Date(s.cancellable_until):null,t=a&&e<a&&["pending","confirmed"].includes(s.status);let r;if(t&&a){const s=a.getTime()-e.getTime();r=`${Math.floor(s/6e4)}分${Math.floor(s%6e4/1e3)}秒`}return{...s,can_cancel:t,time_left:r}}))},R=s=>{switch(s){case"pending":return e.jsx(g,{className:"w-5 h-5 text-yellow-600"});case"confirmed":return e.jsx(p,{className:"w-5 h-5 text-blue-600"});case"processing":return e.jsx(d,{className:"w-5 h-5 text-purple-600"});case"shipped":return e.jsx(_,{className:"w-5 h-5 text-orange-600"});case"delivered":return e.jsx(p,{className:"w-5 h-5 text-green-600"});case"cancelled":return e.jsx(b,{className:"w-5 h-5 text-red-600"});default:return e.jsx(g,{className:"w-5 h-5 text-gray-600"})}},U=e=>({pending:"注文受付中",confirmed:"注文確定",processing:"準備中",shipped:"発送済み",delivered:"配達完了",cancelled:"キャンセル"}[e]||e),V=e=>({credit_card:"クレジットカード",bank_transfer:"銀行振込",cod:"代金引換"}[e]||e);return k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(t,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(d,{className:"w-8 h-8 text-green-600 mr-3"}),"注文履歴"]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx(t,{to:"/profile-settings",children:e.jsxs(l,{variant:"secondary",size:"sm",children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),e.jsx(t,{to:"/payment-method-settings",children:e.jsxs(l,{variant:"secondary",size:"sm",children:[e.jsx(o,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),e.jsx(t,{to:"/dogpark-history",children:e.jsxs(l,{variant:"secondary",size:"sm",children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"ドッグラン利用履歴"]})}),e.jsx(t,{to:"/shop",children:e.jsxs(l,{variant:"secondary",size:"sm",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"ショップに戻る"]})})]}),$&&y.state?.orderNumber&&e.jsxs("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:"ご注文ありがとうございます！"})]}),e.jsxs("p",{className:"text-green-700 mt-1",children:["注文番号: ",y.state.orderNumber," のご注文を承りました。"]})]}),P&&e.jsx("div",{className:"mb-6 p-4 bg-green-100 border border-green-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-800",children:P})]})}),J&&e.jsxs("div",{className:"mb-6 p-4 bg-red-100 border border-red-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-semibold text-red-800",children:"エラー"})]}),e.jsx("p",{className:"text-red-700 mt-1",children:J})]}),0===w.length?e.jsxs(c,{className:"text-center py-12",children:[e.jsx(d,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"注文履歴がありません"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"まだ商品をご注文いただいていません"}),e.jsx(l,{onClick:()=>window.location.href="/shop",children:"ショッピングを始める"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{if(0===w.length)return;const e=["注文番号","注文日","ステータス","商品名","数量","単価","小計","割引","送料","合計金額","支払い方法","配送先氏名","配送先住所","配送先電話番号"].join(","),s=[];w.forEach(e=>{const a=new Date(e.created_at).toLocaleDateString("ja-JP"),t=U(e.status),r=V(e.payment_method);if(e.order_items&&e.order_items.length>0)e.order_items.forEach((n,l)=>{const c=[e.order_number,a,t,`"${n.product.name.replace(/"/g,'""')}"`,n.quantity,n.unit_price,n.total_price,0===l?e.discount_amount:"",0===l?e.shipping_fee:"",0===l?e.final_amount:"",0===l?r:"",0===l?`"${e.shipping_name.replace(/"/g,'""')}"`:"",0===l?`"${e.shipping_address.replace(/"/g,'""')}"`:"",0===l?e.shipping_phone:""].join(",");s.push(c)});else{const n=[e.order_number,a,t,"商品なし","","","",e.discount_amount,e.shipping_fee,e.final_amount,r,`"${e.shipping_name.replace(/"/g,'""')}"`,`"${e.shipping_address.replace(/"/g,'""')}"`,e.shipping_phone].join(",");s.push(n)}});const a="\ufeff"+[e,...s].join("\n"),t=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(t),n=document.createElement("a");n.setAttribute("href",r),n.setAttribute("download",`注文履歴_${(new Date).toISOString().split("T")[0]}.csv`),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)},children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"CSV出力"]})}),w.map(s=>{return e.jsxs(c,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["注文番号: ",s.order_number]}),e.jsxs("div",{className:`flex items-center space-x-1 px-2 py-1 rounded-full text-sm ${a=s.status,{pending:"text-yellow-600 bg-yellow-100",confirmed:"text-blue-600 bg-blue-100",processing:"text-purple-600 bg-purple-100",shipped:"text-orange-600 bg-orange-100",delivered:"text-green-600 bg-green-100",cancelled:"text-red-600 bg-red-100"}[a]||"text-gray-600 bg-gray-100"}`,children:[R(s.status),e.jsx("span",{children:U(s.status)})]}),s.can_cancel&&e.jsxs("div",{className:"text-xs text-orange-600 flex items-center",children:[e.jsx(g,{className:"w-3 h-3 mr-1"}),"キャンセル可能: あと",s.time_left]})]}),e.jsxs("p",{className:"text-gray-600 text-sm",children:["注文日: ",new Date(s.created_at).toLocaleDateString("ja-JP")]}),s.estimated_delivery_date&&e.jsxs("p",{className:"text-gray-600 text-sm",children:["お届け予定日: ",new Date(s.estimated_delivery_date).toLocaleDateString("ja-JP")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",s.final_amount.toLocaleString()]}),e.jsx("p",{className:"text-sm text-gray-500",children:V(s.payment_method)})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[s.order_items.slice(0,3).map(s=>e.jsxs("div",{className:"flex items-center space-x-4 bg-gray-50 p-3 rounded-lg",children:[e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-16 h-16 object-cover rounded",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["数量: ",s.quantity," × ¥",s.unit_price.toLocaleString()]})]}),e.jsxs("p",{className:"font-medium",children:["¥",s.total_price.toLocaleString()]})]},s.id)),s.order_items.length>3&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["他 ",s.order_items.length-3," 点"]})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg mb-4",children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送先"}),e.jsxs("p",{className:"text-sm text-blue-800",children:[s.shipping_name,e.jsx("br",{}),"〒",s.shipping_postal_code,e.jsx("br",{}),s.shipping_address,e.jsx("br",{}),s.shipping_phone]})]}),s.tracking_number&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg mb-4",children:[e.jsx("h4",{className:"font-semibold text-orange-900 mb-1",children:"配送追跡"}),e.jsxs("p",{className:"text-sm text-orange-800",children:["追跡番号: ",s.tracking_number]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>C(s),children:[e.jsx(f,{className:"w-4 h-4 mr-1"}),"詳細を見る"]}),"delivered"===s.status&&e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{alert("レビュー機能は準備中です")},children:[e.jsx(N,{className:"w-4 h-4 mr-1"}),"レビューを書く"]})]}),s.can_cancel&&e.jsxs(l,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700",onClick:()=>A(s.id),children:[e.jsx(b,{className:"w-4 h-4 mr-1"}),"キャンセル"]})]})]},s.id);var a})]}),D&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:"注文詳細"}),e.jsx("button",{onClick:()=>C(null),className:"text-gray-500 hover:text-gray-700",children:e.jsx(b,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"注文情報"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"注文番号:"})," ",D.order_number]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"注文日:"})," ",new Date(D.created_at).toLocaleDateString("ja-JP")]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"ステータス:"})," ",U(D.status)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"支払い方法:"})," ",V(D.payment_method)]}),D.estimated_delivery_date&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"お届け予定日:"})," ",new Date(D.estimated_delivery_date).toLocaleDateString("ja-JP")]}),D.can_cancel&&e.jsxs("div",{className:"mt-2 p-2 bg-orange-50 rounded-lg",children:[e.jsxs("p",{className:"text-orange-800 flex items-center",children:[e.jsx(g,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["キャンセル可能時間: あと",D.time_left]})]}),e.jsx("p",{className:"text-xs text-orange-700 mt-1",children:"注文から15分以内はキャンセル可能です"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"配送先"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium",children:D.shipping_name}),e.jsxs("p",{children:["〒",D.shipping_postal_code]}),e.jsx("p",{children:D.shipping_address}),e.jsx("p",{children:D.shipping_phone})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"注文商品"}),e.jsx("div",{className:"space-y-3",children:D.order_items.map(s=>e.jsxs("div",{className:"flex items-center space-x-4 border-b pb-3",children:[e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["¥",s.unit_price.toLocaleString()," × ",s.quantity]})]}),e.jsxs("p",{className:"font-medium",children:["¥",s.total_price.toLocaleString()]})]},s.id))})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"料金詳細"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",D.total_amount.toLocaleString()]})]}),D.discount_amount>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsx("span",{children:"割引"}),e.jsxs("span",{children:["-¥",D.discount_amount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"送料"}),e.jsx("span",{children:0===D.shipping_fee?"無料":`¥${D.shipping_fee.toLocaleString()}`})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",D.final_amount.toLocaleString()]})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx(l,{variant:"secondary",onClick:()=>C(null),children:"閉じる"}),D.can_cancel&&e.jsxs(l,{className:"bg-red-600 hover:bg-red-700",onClick:()=>{C(null),A(D.id)},children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"注文をキャンセル"]})]})]})})}),I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(j,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"注文をキャンセルしますか？"}),e.jsx("p",{className:"text-gray-600",children:"この操作は取り消せません。本当にキャンセルしますか？"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(l,{variant:"secondary",onClick:()=>A(null),children:"戻る"}),e.jsx(l,{className:"bg-red-600 hover:bg-red-700",isLoading:T,onClick:()=>(async e=>{try{E(!0),q(null),M(null);const{data:s,error:a}=await n.rpc("cancel_order",{order_id:e,user_id:v?.id});if(a)throw a;if(!s.success)throw new Error(s.message||"キャンセルに失敗しました");M("注文をキャンセルしました"),A(null),await B(),setTimeout(()=>{M(null)},3e3)}catch(s){q("注文のキャンセルに失敗しました。")}finally{E(!1)}})(I),children:"キャンセルする"})]})]})})]})}export{v as OrderHistory};
