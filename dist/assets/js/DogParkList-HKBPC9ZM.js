import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{P as s}from"./placeholders-CbXPOCvW.js";import{L as a,a as n}from"./router-Cg6wfOY4.js";import{B as i}from"./Button-CJFAG6V0.js";import{t as r,M as l,i as c,a4 as o,a5 as d,a6 as m,U as x,a7 as u,_ as g,V as h,G as p,x as f,a as y,a8 as b,a9 as j,a0 as _,z as w,a1 as N,R as v,u as k,v as M,aa as C,ab as S}from"./ui-basic-CaMd9YQ-.js";import{u as P,s as $,C as D}from"./index-DN5wQuSm.js";import{C as L}from"./CouponDisplay-B-Fwo3jl.js";import{u as I}from"./GoogleMapsProvider-BjbauTRt.js";import{F as E}from"./facilities-CzfbiNCv.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";const T=e=>e<1?`${Math.round(1e3*e)}m`:`${e.toFixed(1)}km`;function z({park:t,userLocation:n,distance:g}){const h=g||(n&&t.latitude&&t.longitude?((e,t,s,a)=>{const n=(s-e)*Math.PI/180,i=(a-t)*Math.PI/180,r=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371})(n.lat,n.lng,Number(t.latitude),Number(t.longitude)):null),p=(()=>{if(!t.current_occupancy||!t.max_capacity)return{label:"情報なし",color:"text-gray-500",bgColor:"bg-gray-100"};const e=t.current_occupancy/t.max_capacity*100;return e>=90?{label:"満員",color:"text-red-600",bgColor:"bg-red-100"}:e>=70?{label:"混雑",color:"text-orange-600",bgColor:"bg-orange-100"}:e>=40?{label:"普通",color:"text-yellow-600",bgColor:"bg-yellow-100"}:{label:"空いている",color:"text-green-600",bgColor:"bg-green-100"}})();return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"aspect-square relative overflow-hidden rounded-t-lg",children:[e.jsx("img",{src:t.image_url||s,alt:t.name,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.src=s}}),e.jsx("button",{className:"absolute top-3 right-3 p-2 bg-white/80 backdrop-blur-sm rounded-full hover:bg-white transition-colors",onClick:e=>{e.preventDefault(),e.stopPropagation()},children:e.jsx(r,{className:"w-4 h-4 text-gray-600 hover:text-red-500"})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"font-semibold text-lg text-gray-900 flex items-center",children:[e.jsx(l,{className:"w-4 h-4 mr-2 text-gray-700"}),t.name]}),t.currentMaintenance&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("p",{className:"text-red-600 text-sm font-medium",children:[t.currentMaintenance.title,t.currentMaintenance.is_emergency&&" (緊急)"]}),e.jsxs("p",{className:"text-red-500 text-xs",children:[new Date(t.currentMaintenance.start_date).toLocaleDateString("ja-JP")," ",new Date(t.currentMaintenance.start_date).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})," 〜 ",new Date(t.currentMaintenance.end_date).toLocaleDateString("ja-JP")," ",new Date(t.currentMaintenance.end_date).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})]}),t.currentMaintenance.description&&e.jsx("p",{className:"text-red-500 text-xs",children:t.currentMaintenance.description})]})]}),e.jsx("div",{className:"flex items-center space-x-2 ml-2",children:t.currentMaintenance?e.jsxs("span",{className:"flex items-center text-red-600 text-sm",children:[e.jsx(c,{className:"w-4 h-4 mr-1"}),"メンテナンス中"]}):e.jsxs("span",{className:"flex items-center text-green-600 text-sm",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),"営業中"]})})]}),e.jsxs("div",{className:"space-y-2 mb-2",children:[t.address&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm",children:[e.jsx(l,{className:"w-4 h-4 mr-1 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:t.address})]}),h&&e.jsxs("div",{className:"flex items-center text-blue-600 text-sm font-medium",children:[e.jsx(d,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["現在地から ",T(h)]})]})]}),t.price&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-3",children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["¥",t.price,"/日"]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{className:"w-4 h-4 mr-1 text-gray-600"}),e.jsx("span",{className:"text-sm text-gray-600",children:"混雑状況:"})]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${p.color} ${p.bgColor}`,children:p.label})]}),void 0!==t.current_occupancy&&t.max_capacity&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-1",children:[e.jsx("span",{children:"現在の利用者"}),e.jsxs("span",{children:[t.current_occupancy," / ",t.max_capacity,"名"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"h-2 rounded-full transition-all duration-300 "+(t.current_occupancy/t.max_capacity>=.9?"bg-red-500":t.current_occupancy/t.max_capacity>=.7?"bg-orange-500":t.current_occupancy/t.max_capacity>=.4?"bg-yellow-500":"bg-green-500"),style:{width:`${Math.min(t.current_occupancy/t.max_capacity*100,100)}%`}})})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(a,{to:`/parks/${t.id}`,className:"flex-1",children:e.jsxs(i,{variant:"outline",className:"w-full flex items-center justify-center !rounded-lg",style:{borderRadius:"0.5rem"},children:[e.jsx(u,{className:"w-4 h-4 mr-1"}),"詳細"]})}),t.currentMaintenance?e.jsx(i,{className:"w-full opacity-50 cursor-not-allowed !rounded-lg",disabled:!0,title:"メンテナンス中のため予約できません",style:{borderRadius:"0.5rem"},children:"予約不可"}):e.jsxs(e.Fragment,{children:[e.jsx(a,{to:`/access-control?park=${t.id}`,className:"flex-1",children:e.jsx(i,{className:"w-full !rounded-lg",style:{borderRadius:"0.5rem"},children:"入場する"})}),e.jsx(a,{to:`/parks/${t.id}/reserve`,className:"flex-1",children:e.jsx(i,{variant:"secondary",className:"w-full !rounded-lg",style:{borderRadius:"0.5rem"},children:"予約する"})})]})]})]})]})}function F({icon:t,title:s,description:a,action:n,className:r=""}){return e.jsxs("div",{className:`flex flex-col items-center justify-center py-12 px-4 text-center ${r}`,children:[e.jsx("div",{className:"mb-4 text-gray-400",children:t||e.jsx(g,{className:"w-16 h-16"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:s}),a&&e.jsx("p",{className:"text-gray-600 max-w-md mb-6",children:a}),n&&e.jsx(i,{onClick:n.onClick,variant:"outline",children:n.label})]})}const q={veterinary_clinic:{icon:b,label:"動物病院",color:"text-red-600"},pet_friendly_restaurant:{icon:j,label:"ペット同伴レストラン",color:"text-orange-600"},pet_shop:{icon:w,label:"ペットショップ",color:"text-blue-600"},pet_friendly_hotel:{icon:y,label:"ペット同伴宿泊",color:"text-green-600"},pet_salon:{icon:f,label:"ペットサロン",color:"text-purple-600"},pet_hotel:{icon:_,label:"ペットホテル",color:"text-indigo-600"},pet_cafe:{icon:_,label:"ペットカフェ",color:"text-orange-600"},pet_restaurant:{icon:j,label:"ペット同伴レストラン",color:"text-orange-600"},veterinary:{icon:b,label:"動物病院",color:"text-red-600"},pet_accommodation:{icon:y,label:"ペット同伴宿泊",color:"text-green-600"},dog_training:{icon:f,label:"しつけ教室",color:"text-yellow-600"},pet_friendly_other:{icon:f,label:"その他ワンちゃん同伴可能施設",color:"text-gray-600"},other:{icon:f,label:"その他",color:"text-gray-600"}};function A({facility:s,showDistance:n,distance:r}){const{user:c}=P(),[o,m]=t.useState([]),[x,g]=t.useState([]),[f,y]=t.useState(!1),[b,j]=t.useState(null),[_,w]=t.useState([]),[v,k]=t.useState(!0);t.useEffect(()=>{M(),C()},[c,s.id]);const M=async()=>{try{k(!0);const{data:e,error:t}=await $.from("pet_facility_images").select("id, facility_id, image_url, image_type, display_order, created_at, alt_text").eq("facility_id",s.id).order("display_order",{ascending:!0});if(t)return void w([]);w(e||[])}catch(e){w([])}finally{k(!1)}},C=async()=>{try{const{data:e,error:t}=await $.from("facility_coupons").select("*").eq("facility_id",s.id).eq("is_active",!0).lte("start_date",(new Date).toISOString()).gte("end_date",(new Date).toISOString());if(t)throw t;if(m(e||[]),c){const t=(e||[]).map(e=>e.id);if(t.length>0){const{data:e,error:s}=await $.from("user_coupons").select("\n              *,\n              coupon:facility_coupons(*)\n            ").eq("user_id",c?.id).in("coupon_id",t);if(s)throw s;g(e||[])}}}catch(e){}},S=(()=>{const e=function(e){if(!e)return"other";const t=String(e).toLowerCase();return t in q?t:t.includes("veterinary")||t.includes("clinic")?"veterinary":t.includes("restaurant")?"pet_restaurant":t.includes("cafe")?"pet_cafe":t.includes("shop")?"pet_shop":t.includes("salon")?"pet_salon":t.includes("hotel")?"pet_hotel":t.includes("accommodation")?"pet_accommodation":t.includes("training")?"dog_training":t.includes("other")?"pet_friendly_other":"other"}(s.category_id??s.category??"other");return q[e]||q.other})();S.icon;const D=_.length>0?_[0]:null;return e.jsxs("div",{className:"bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 overflow-hidden cursor-pointer border border-gray-200",children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(l,{className:"w-5 h-5 text-gray-700"}),e.jsx("span",{className:"text-sm text-gray-600",children:s.category_name||S.label})]}),(()=>{const e=s.opening_time||void 0,t=s.closing_time||void 0;if(!e||!t)return!1;const a=(new Date).toISOString().slice(0,10);try{if(s.specific_closed_dates){const e=JSON.parse(s.specific_closed_dates);if(Array.isArray(e)&&e.includes(a))return!1}if(s.weekly_closed_days){const e=JSON.parse(s.weekly_closed_days),t=(new Date).getDay();if(e?.[t]){if(!s.specific_open_dates)return!1;{const e=JSON.parse(s.specific_open_dates);if(!Array.isArray(e)||!e.includes(a))return!1}}}}catch{}const n=(new Date).toTimeString().slice(0,5);return n>=e.slice(0,5)&&n<=t.slice(0,5)})()?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full",children:"営業中"}):e.jsx("span",{className:"text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full",children:"営業時間外"})]}),e.jsxs("div",{className:"flex items-center mb-2",children:[D&&e.jsx("div",{className:"w-24 h-24 rounded-lg overflow-hidden border border-gray-200 shadow-sm mr-4 flex-shrink-0",children:e.jsx("img",{src:D.image_url,alt:`${s.name}のサムネイル`,className:"w-full h-full object-cover",onError:e=>{e.target.style.display="none"}})}),e.jsx("h3",{className:"font-semibold text-lg text-gray-900 line-clamp-2 flex-1",children:s.name})]}),s.rating&&e.jsx("div",{className:"mb-2",children:(t=>{const s=[],a=Math.floor(t),n=t%1>=.5;for(let i=0;i<5;i++)i<a?s.push(e.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"},i)):i===a&&n?s.push(e.jsx(N,{className:"w-4 h-4 fill-yellow-400/50 text-yellow-400"},i)):s.push(e.jsx(N,{className:"w-4 h-4 text-gray-300"},i));return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"flex",children:s}),e.jsxs("span",{className:"text-sm text-gray-600",children:["(",t.toFixed(1),")"]})]})})(s.rating)}),s.address&&e.jsxs("div",{className:"flex items-start text-gray-600 text-sm mb-2",children:[e.jsx(l,{className:"w-4 h-4 mr-1 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"line-clamp-2",children:s.address})]}),n&&r&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-2",children:[e.jsx(d,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["現在地から ",(I=r,I<1?`${Math.round(1e3*I)}m`:`${I.toFixed(1)}km`)]})]}),s.phone&&e.jsxs("div",{className:"flex items-center text-gray-600 text-sm mb-3",children:[e.jsx(h,{className:"w-4 h-4 mr-1"}),e.jsx("a",{href:`tel:${s.phone}`,className:"hover:text-blue-600 transition-colors",onClick:e=>e.stopPropagation(),children:s.phone})]}),s.description&&e.jsx("p",{className:"text-gray-600 text-sm mb-4 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-2",children:[o.length>0&&e.jsxs("div",{className:"inline-flex items-center text-sm text-pink-700 bg-pink-50 border border-pink-200 rounded-full px-2 py-1",children:[e.jsx(p,{className:"w-4 h-4 mr-1"}),e.jsx("span",{children:"クーポンあり"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(a,{to:`/facilities/${s.id}`,className:"flex-1",children:e.jsxs(i,{variant:"outline",className:"w-full flex items-center justify-center",children:[e.jsx(u,{className:"w-4 h-4 mr-1"}),"詳細を見る"]})}),s.website_url&&e.jsx("a",{href:s.website_url,target:"_blank",rel:"noopener noreferrer",className:"flex-1",onClick:e=>e.stopPropagation(),children:e.jsx(i,{className:"w-full",children:"ウェブサイト"})})]})]})]}),f&&b&&e.jsx(L,{userCoupon:b,onClose:()=>{y(!1),j(null)}})]});var I}function O({message:t="データを読み込み中..."}){return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:t})]})})}function B({error:t,onRetry:s}){return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md mx-auto px-4",children:[e.jsx(c,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"エラーが発生しました"}),e.jsx("p",{className:"text-gray-600 mb-4",children:t}),e.jsxs(i,{onClick:s,className:"inline-flex items-center",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),"再試行"]})]})})}function R({parks:s=[],facilities:a=[],activeView:r="dogparks",onLocationSelect:c,center:o,userLocation:m,className:x=""}){const u=t.useRef(null),[g,h]=t.useState(m||null),[p,f]=t.useState(""),[y,b]=t.useState(!1),[j,_]=t.useState(null),[w,N]=t.useState(!1),{isLoaded:v,isLoading:k,error:M}=I(),{user:C}=P(),[S,L]=t.useState([]),E=n(),T='\n    <svg width="40" height="56" viewBox="0 0 40 56" fill="none" xmlns="http://www.w3.org/2000/svg">\n      \x3c!-- ピンの形状（先がとがった） --\x3e\n      <path d="M20 0C8.954 0 0 8.954 0 20C0 31.046 20 56 20 56S40 31.046 40 20C40 8.954 31.046 0 20 0Z" fill="url(#dogParkGradient)" stroke="white" stroke-width="2"/>\n      \x3c!-- 背景円 --\x3e\n      <circle cx="20" cy="20" r="15" fill="white"/>\n      \x3c!-- 肉球デザイン --\x3e\n      <g transform="translate(20, 20) scale(0.8)">\n        \x3c!-- メイン肉球 --\x3e\n        <ellipse cx="0" cy="3" rx="6" ry="4" fill="#3B82F6"/>\n        \x3c!-- 上の小さな肉球（左上） --\x3e\n        <ellipse cx="-4" cy="-5" rx="2.5" ry="3" fill="#3B82F6"/>\n        \x3c!-- 上の小さな肉球（右上） --\x3e\n        <ellipse cx="4" cy="-5" rx="2.5" ry="3" fill="#3B82F6"/>\n        \x3c!-- 上の小さな肉球（中央上） --\x3e\n        <ellipse cx="0" cy="-7" rx="2" ry="2.5" fill="#3B82F6"/>\n      </g>\n      <defs>\n        <linearGradient id="dogParkGradient" x1="20" y1="0" x2="20" y2="40" gradientUnits="userSpaceOnUse">\n          <stop stop-color="#3B82F6"/>\n          <stop offset="1" stop-color="#2563EB"/>\n        </linearGradient>\n      </defs>\n    </svg>\n  ',z='\n    <svg width="36" height="50" viewBox="0 0 36 50" fill="none" xmlns="http://www.w3.org/2000/svg">\n      \x3c!-- ピンの形状（先がとがった） --\x3e\n      <path d="M18 0C8.059 0 0 8.059 0 18C0 27.941 18 50 18 50S36 27.941 36 18C36 8.059 27.941 0 18 0Z" fill="#22C55E" stroke="white" stroke-width="2"/>\n      \x3c!-- 背景円 --\x3e\n      <circle cx="18" cy="18" r="13" fill="white"/>\n      \x3c!-- 十字マーク --\x3e\n      <path d="M16 10h4v6h6v4h-6v6h-4v-6h-6v-4h6z" fill="#22C55E"/>\n    </svg>\n  ',F='\n    <svg width="24" height="40" viewBox="0 0 24 40" fill="none" xmlns="http://www.w3.org/2000/svg">\n      \x3c!-- ポール部分 --\x3e\n      <rect x="11" y="20" width="2" height="20" fill="#DC2626" stroke="white" stroke-width="1"/>\n      \x3c!-- 丸い部分 --\x3e\n      <circle cx="12" cy="12" r="11" fill="url(#currentLocationGradient)" stroke="white" stroke-width="2"/>\n      \x3c!-- 中央の小さな円 --\x3e\n      <circle cx="12" cy="12" r="6" fill="white"/>\n      \x3c!-- 中央のドット --\x3e\n      <circle cx="12" cy="12" r="3" fill="#DC2626"/>\n      <defs>\n        <linearGradient id="currentLocationGradient" x1="12" y1="1" x2="12" y2="23" gradientUnits="userSpaceOnUse">\n          <stop stop-color="#EF4444"/>\n          <stop offset="1" stop-color="#DC2626"/>\n        </linearGradient>\n      </defs>\n    </svg>\n  ',q=t.useCallback((e,t,s,a)=>{const n=(s-e)*Math.PI/180,i=(a-t)*Math.PI/180,r=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))},[]),A=t.useCallback(e=>e<1?`${Math.round(1e3*e)}m`:`${e.toFixed(1)}km`,[]),O=t.useCallback((e,t)=>{const s=e.name||"名前未設定",a="park"===t?`/parks/${e.id}`:`/facilities/${e.id}`;let n="";"main_image_url"in e&&e.main_image_url?n=e.main_image_url:"image_url"in e&&e.image_url?n=e.image_url:"cover_image_url"in e&&e.cover_image_url?n=e.cover_image_url:"thumbnail_url"in e&&e.thumbnail_url&&(n=e.thumbnail_url);const i=n?`\n      <div style="\n        width: 100%;\n        height: 90px;\n        margin: 0px 0px 2px 0px;\n        border-radius: 8px;\n        overflow: hidden;\n        background: #f3f4f6;\n      ">\n        <img \n          src="${n}" \n          alt="${s}"\n          style="\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            border-radius: 8px;\n          "\n          onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;font-size:12px;\\'>画像なし</div>';"\n        />\n      </div>\n    `:`\n      <div style="\n        width: 100%;\n        height: 70px;\n        margin: 0px 0px 2px 0px;\n        border-radius: 8px;\n        background: #f3f4f6;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #9ca3af;\n        font-size: 12px;\n      ">\n        ${"park"===t?"🐾":"🏥"} 画像なし\n      </div>\n    `;let r="";if(g&&e.latitude&&e.longitude){const t=q(g.lat,g.lng,e.latitude,e.longitude);r=`\n        <p style="\n          font-size: 12px;\n          color: #6b7280;\n          margin: 0;\n          display: flex;\n          align-items: center;\n          flex: 1;\n        ">\n          <span style="margin-right: 4px;">📍</span>\n          現在地から ${A(t)}\n        </p>\n      `}return`\n      <div style="\n        min-width: 220px;\n        max-width: 260px;\n        min-height: 185px;\n        padding: 0px 12px 0px 12px;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      ">\n        ${i}\n        \n        <h3 style="\n          font-size: 13px;\n          font-weight: 600;\n          margin: 6px 0 0px 0;\n          color: #1f2937;\n          line-height: 1.3;\n        ">${s}</h3>\n        \n        <div style="\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-top: 3px;\n        ">\n          ${r}\n          <button\n            onclick="window.infoWindowNavigate('${a}')"\n            style="\n              width: 80px;\n              background: #3b82f6;\n              color: white;\n              border: none;\n              padding: 6px 12px;\n              border-radius: 6px;\n              font-size: 12px;\n              font-weight: 500;\n              cursor: pointer;\n              transition: background 0.2s ease-in-out;\n            "\n            onmouseover="this.style.background='#2563eb'"\n            onmouseout="this.style.background='#3b82f6'"\n          >\n            詳細\n          </button>\n        </div>\n      </div>\n    `},[g,q,A]);t.useEffect(()=>(window.infoWindowNavigate=e=>{E(e)},()=>{delete window.infoWindowNavigate}),[E]);const B=t.useCallback(e=>{try{const t=window,n=new t.google.maps.InfoWindow;if(_(n),"dogparks"===r&&s&&s.forEach(s=>{if(s.latitude&&s.longitude){const a=new t.google.maps.Marker({position:{lat:s.latitude,lng:s.longitude},map:e,title:s.name,icon:{url:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(T)}`,scaledSize:new t.google.maps.Size(40,56),anchor:new t.google.maps.Point(20,56)}});a.addListener("click",()=>{const t=O(s,"park");n.setContent(t),n.open(e,a)})}}),"facilities"===r&&a){let s=0;a.forEach((a,i)=>{if(a.latitude&&a.longitude&&0!==a.latitude&&0!==a.longitude)try{const i=new t.google.maps.Marker({position:{lat:a.latitude,lng:a.longitude},map:e,title:a.name,icon:{url:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(z)}`,scaledSize:new t.google.maps.Size(36,50),anchor:new t.google.maps.Point(18,50)}});s++,i.addListener("click",()=>{const t=O(a,"facility");n.setContent(t),n.open(e,i)})}catch(r){}})}g&&new t.google.maps.Marker({position:g,map:e,title:"現在地",icon:{url:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(F)}`,scaledSize:new t.google.maps.Size(24,40),anchor:new t.google.maps.Point(12,40)}})}catch(t){}},[r,s,a,g,T,z,F,O]),R=t.useCallback(e=>{try{const t=globalThis.window;if(!t.google?.maps||!v)return;const s={center:m||g||o||{lat:35.6762,lng:139.6503},zoom:13,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",stylers:[{visibility:"off"}]},{featureType:"poi.government",stylers:[{visibility:"off"}]},{featureType:"poi.medical",stylers:[{visibility:"on"}]},{featureType:"poi.medical",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"poi.place_of_worship",stylers:[{visibility:"off"}]},{featureType:"poi.school",stylers:[{visibility:"off"}]},{featureType:"poi.sports_complex",stylers:[{visibility:"off"}]}],mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!1,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!1},a=new t.google.maps.Map(e,s);B(a),f(""),N(!0)}catch(t){f("地図の初期化に失敗しました")}},[m,g,o,B,v]);t.useEffect(()=>{u.current&&(v&&!M?R(u.current):M&&f(M))},[v,M,R]);const G=t.useCallback(()=>{navigator.geolocation?(b(!0),navigator.geolocation.getCurrentPosition(e=>{const t={lat:e.coords.latitude,lng:e.coords.longitude};h(t),b(!1),c&&c(t)},e=>{b(!1)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e5})):f("位置情報がサポートされていません")},[c]);if(t.useEffect(()=>{m||g||navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const t={lat:e.coords.latitude,lng:e.coords.longitude};h(t),c&&c(t)},e=>{},{enableHighAccuracy:!1,timeout:8e3,maximumAge:3e5})},[m,g,c]),t.useEffect(()=>{(async()=>{if(C)try{const{data:e,error:t}=await $.from("dogs").select("id, name, image_url").eq("user_id",C?.id).order("created_at",{ascending:!0});!t&&e&&e.length>0&&L(e)}catch(e){}})()},[C]),M)return e.jsxs(D,{className:`p-6 text-center ${x}`,children:[e.jsx(l,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"マップ機能は現在利用できません"}),e.jsx("p",{className:"text-gray-600 text-sm mb-4",children:M}),e.jsx("div",{className:"text-xs text-gray-500",children:e.jsxs("p",{children:["dogparks"===r?"ドッグラン":"ペット施設",": ","dogparks"===r?s.length:a.length,"件"]})})]});if(p&&p!==M)return e.jsxs(D,{className:`p-6 text-center ${x}`,children:[e.jsx(l,{className:"w-12 h-12 text-red-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"マップを読み込めませんでした"}),e.jsx("p",{className:"text-gray-600 text-sm mb-4",children:p}),e.jsx(i,{onClick:()=>{f(""),N(!1),u.current&&R(u.current)},children:"再読み込み"})]});const U=("dogparks"===r?s:a).length;return e.jsxs(D,{className:`overflow-hidden ${x}`,children:[e.jsxs("div",{className:"p-4 border-b bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(l,{className:"w-5 h-5 text-blue-600 mr-2"}),e.jsxs("h3",{className:"font-semibold",children:["dogparks"===r?"ドッグラン":"ペット施設","マップ"]})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[U,"件"]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsxs("div",{className:"flex items-center space-x-4 text-xs",children:["dogparks"===r&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full mr-2"}),e.jsx("span",{children:"ドッグラン"})]}),"facilities"===r&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full mr-2"}),e.jsx("span",{children:"ペット施設"})]}),g&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full mr-2"}),e.jsx("span",{children:"現在地"})]})]}),e.jsxs(i,{size:"sm",variant:"secondary",onClick:G,className:"text-xs",disabled:y,children:[e.jsx(d,{className:"w-3 h-3 mr-1"}),y?"取得中...":"現在地"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{ref:u,className:"w-full h-96",style:{minHeight:"400px"}}),(k||!w)&&!M&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:k?"Google Maps APIを読み込み中...":"マップを初期化中..."})]})})]}),e.jsx("div",{className:"p-3 border-t bg-gray-50 text-xs text-gray-500 text-center",children:M?"マップ機能は現在利用できません":"マーカーをクリックすると詳細情報が表示されます"})]})}const G={pet_hotel:"ペットホテル",pet_salon:"ペットサロン",veterinary:"動物病院",pet_cafe:"ペットカフェ",pet_restaurant:"ペット同伴レストラン",pet_shop:"ペットショップ",pet_accommodation:"ペット同伴宿泊",dog_training:"しつけ教室",pet_friendly_other:"その他ワンちゃん同伴可能施設"},U=(e,t,s,a)=>{const n=(s-e)*Math.PI/180,i=(a-t)*Math.PI/180,r=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))},J=t=>{const s="w-4 h-4 text-white";return{pet_hotel:e.jsx(S,{className:s}),pet_salon:e.jsx(C,{className:s}),veterinary:e.jsx(r,{className:s}),pet_cafe:e.jsx(_,{className:s}),pet_restaurant:e.jsx(M,{className:s}),pet_shop:e.jsx(w,{className:s}),pet_accommodation:e.jsx(y,{className:s}),dog_training:e.jsx(k,{className:s}),pet_friendly_other:e.jsx(N,{className:s})}[t]||e.jsx(f,{className:s})};function H(){const[a,n]=t.useState("dogparks"),[i,r]=t.useState(null),[c,o]=t.useState(!1),[d,m]=t.useState(Object.keys(G)),[x,u]=t.useState(null),[g,h]=t.useState(!1),{user:p,isAuthenticated:f}=P(),{parks:y,isLoading:b,error:j,fetchParkData:_}=function(){const[e,a]=t.useState([]),[n,i]=t.useState(!1),[r,l]=t.useState(null);return{parks:e,isLoading:n,error:r,fetchParkData:t.useCallback(async()=>{try{i(!0),l(null);const{data:e,error:t}=await $.from("dog_parks").select("\n          *,\n          profiles:owner_id (\n            name,\n            address,\n            phone_number,\n            email,\n            postal_code\n          ),\n          dog_park_facility_images (\n            id,\n            image_type,\n            image_url,\n            is_approved\n          ),\n          maintenance_schedules (\n            id,\n            title,\n            description,\n            start_date,\n            end_date,\n            is_emergency,\n            status\n          )\n        ").eq("status","approved").eq("is_public",!0).order("created_at",{ascending:!1});if(t)throw t;const n=(e||[]).map(e=>{Array.isArray(e.profiles)?e.profiles[0]:e.profiles;let t=e.image_url||e.cover_image_url;if(e.dog_park_facility_images&&e.dog_park_facility_images.length>0){const s=e.dog_park_facility_images.find(e=>!0===e.is_approved);if(s)t=s.image_url;else{const s=e.dog_park_facility_images.find(e=>"overview"===e.image_type);t=s?s.image_url:e.dog_park_facility_images[0].image_url}}let a=null;if(e.maintenance_schedules&&e.maintenance_schedules.length>0){const t=new Date;a=e.maintenance_schedules.find(e=>{const s=new Date(e.start_date),a=new Date(e.end_date);return"active"===e.status||"scheduled"===e.status&&t>=s&&t<=a})}return{id:e.id||"",name:e.name||"",description:e.description||e.facility_details||"",address:e.address||"",latitude:Number(e.latitude)||0,longitude:Number(e.longitude)||0,max_capacity:Number(e.max_capacity)||20,current_occupancy:Number(e.current_occupancy)||0,price:Number(e.price)||Number(e.hourly_rate)||0,status:e.status||"approved",facilities:e.facilities?"object"==typeof e.facilities?Object.entries(e.facilities).filter(([e,t])=>t).map(([e])=>e).join(","):e.facilities:e.facility_details||"",image_url:t||s,average_rating:Number(e.average_rating)||4,review_count:Number(e.review_count)||Math.floor(50*Math.random())+5,created_at:e.created_at||"",currentMaintenance:a||void 0}});a(n)}catch(e){const t=e instanceof Error?e.message:"データの取得に失敗しました";l(t)}finally{i(!1)}},[]),setError:l,setIsLoading:i}}(),{facilities:w,facilitiesLoading:N,error:v,fetchFacilities:k}=function(){const[e,s]=t.useState([]),[a,n]=t.useState(!1),[i,r]=t.useState(null);return{facilities:e,facilitiesLoading:a,error:i,fetchFacilities:t.useCallback(async()=>{try{n(!0),r(null);const{data:e,error:t}=await $.from("pet_facilities").select("\n          *,\n          pet_facility_images (\n            id,\n            image_url,\n            image_type,\n            display_order\n          )\n        ").eq("is_public",!0).in("status",["approved","pending"]).order("name");if(t)throw t;const{data:a}=await $.from("facility_categories").select("id, name, name_ja"),i={};(a||[]).forEach(e=>{i[String(e.id)]=e.name_ja||e.name||""});const l=e=>{if(!e)return"other";return String(e).trim().toLowerCase()||"other"},c=(e||[]).map((e,t)=>{const s=e.latitude&&e.longitude&&0!==e.latitude&&0!==e.longitude,a=e.pet_facility_images||[],n=a.find(e=>"main"===e.image_type)||a.sort((e,t)=>(e.display_order||999)-(t.display_order||999))[0],r=n?.image_url||"",c=e.category_id,o=l(c),d=i[o]||E[o]||"その他";return{id:e.id||"",name:e.name||"",description:e.description||"",category:o,address:e.address||"",latitude:s?Number(e.latitude):null,longitude:s?Number(e.longitude):null,phone:e.phone||"",website:e.website||"",status:e.status||"pending",created_at:e.created_at||"",category_name:d,opening_time:e.opening_time||null,closing_time:e.closing_time||null,weekly_closed_days:e.weekly_closed_days||null,specific_closed_dates:e.specific_closed_dates||null,specific_open_dates:e.specific_open_dates||null,main_image_url:r,image_url:r,thumbnail_url:r,images:a}});c.filter(e=>e.latitude&&e.longitude),c.filter(e=>e.main_image_url),s(c)}catch(e){const t=e instanceof Error?e.message:"施設データの取得に失敗しました";r(t),s([])}finally{n(!1)}},[]),setError:r,setFacilitiesLoading:n}}();t.useEffect(()=>{(async()=>{if(navigator.geolocation)try{const e=await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e5})}),t={lat:e.coords.latitude,lng:e.coords.longitude};u(t)}catch(e){}})()},[]),t.useEffect(()=>{(async()=>{try{"dogparks"===a?await _():await k()}catch(e){}})()},[a,_,k]);const M=t.useMemo(()=>x&&0!==y.length?[...y].sort((e,t)=>U(x.lat,x.lng,Number(e.latitude)||0,Number(e.longitude)||0)-U(x.lat,x.lng,Number(t.latitude)||0,Number(t.longitude)||0)):y,[y,x]),C=t.useMemo(()=>{if(d.length===Object.keys(G).length)return w;const e=new Set(d.map(e=>G[e]||e));let t=w.filter(t=>{const s=t.category_name,a=t.category;return!(!s||!e.has(s))||!(!a||!d.includes(a))});return x&&t.length>0&&(t=t.sort((e,t)=>U(x.lat,x.lng,e.latitude||0,e.longitude||0)-U(x.lat,x.lng,t.latitude||0,t.longitude||0))),t},[w,d,x]),S="dogparks"===a?j:v,D=()=>{(async()=>{"dogparks"===a?await _():await k()})()};return("dogparks"===a?b:N)?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[!1,e.jsx(O,{})]}):S?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(B,{title:"データの取得に失敗しました",description:`${S}\n\n以下をお試しください：\n1. ページを再読み込みしてください\n2. しばらく時間をおいてから再度アクセスしてください\n3. 問題が続く場合は管理者にお問い合わせください`,onRetry:D}),!1]}):"dogparks"===a&&0===y.length?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx(F,{title:"スマートドッグランが見つかりません",description:"まだスマートドッグランのデータが登録されていません。"})}):"facilities"===a&&0===w.length?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx(F,{title:"施設が見つかりません",description:"まだ施設のデータが登録されていません。"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"スマートドッグラン一覧"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"お近くのスマートドッグランを見つけましょう"})]})})}),!1,e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex justify-center py-4",children:e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsxs("button",{onClick:()=>n("dogparks"),className:"px-6 py-3 rounded-md font-medium transition-all "+("dogparks"===a?"bg-blue-600 text-white shadow-md":"text-gray-600 hover:text-gray-900 hover:bg-gray-200"),children:[e.jsx(l,{className:"w-4 h-4 mr-2 inline text-current"}),"スマートドッグラン"]}),e.jsxs("button",{onClick:()=>n("facilities"),className:"px-6 py-3 rounded-md font-medium transition-all "+("facilities"===a?"bg-green-600 text-white shadow-md":"text-gray-600 hover:text-gray-900 hover:bg-gray-200"),children:[e.jsx(l,{className:"w-4 h-4 mr-2 inline text-current"}),"ワンちゃんと行ける施設"]})]})})})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:["facilities"===a&&e.jsxs("div",{className:"mb-4 bg-white rounded-lg shadow-sm border",children:[e.jsxs("button",{onClick:()=>h(!g),className:"w-full px-3 py-3 flex items-center justify-between text-left hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"🏢 カテゴリフィルター"}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full",children:[d.length," / ",Object.keys(G).length]}),x&&e.jsx("span",{className:"text-xs text-green-600",children:"📍 距離順"})]}),e.jsx("span",{className:"text-gray-400 transition-transform "+(g?"rotate-180":""),children:"▼"})]}),g&&e.jsxs("div",{className:"px-3 pb-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-3 pt-3",children:[e.jsx("button",{onClick:()=>{m(Object.keys(G))},className:"px-3 py-1.5 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors",children:"全選択"}),e.jsx("button",{onClick:()=>{m([])},className:"px-3 py-1.5 text-xs bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors",children:"全解除"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(G).map(([t,s])=>e.jsxs("button",{onClick:()=>(e=>{m(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])})(t),className:"flex items-center gap-2 px-4 py-2.5 text-sm rounded-lg border transition-all "+(d.includes(t)?"bg-blue-500 text-white border-blue-500 shadow-md":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"),children:[e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-6 rounded "+(d.includes(t)?"bg-blue-600":"bg-gray-400"),children:J(t)}),s]},t))})]})]}),e.jsx("div",{className:"mb-8",children:e.jsx(R,{parks:M,facilities:"facilities"===a?C:w,activeView:a,userLocation:x})}),"dogparks"===a&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"スマートドッグラン一覧"}),0===y.length?e.jsx(F,{title:"ドッグランが見つかりません",description:"現在登録されているドッグランがありません。"}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:M.map(t=>{const s=x&&t.latitude&&t.longitude?U(x.lat,x.lng,Number(t.latitude),Number(t.longitude)):void 0;return e.jsx(z,{park:t,userLocation:x,...void 0!==s&&{distance:s}},t.id)})})]}),"facilities"===a&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"ワンちゃんと行ける施設"}),0===C.length?e.jsx(F,{title:"施設が見つかりません",description:0===d.length?"カテゴリを選択してください。":"選択したカテゴリの施設が登録されていません。"}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:C.map(t=>{const s=x&&t.latitude&&t.longitude?U(x.lat,x.lng,t.latitude,t.longitude):void 0;return e.jsx(A,{facility:t,showDistance:!!x,...void 0!==s&&{distance:s}},t.id)})})]})]})]})}export{H as DogParkList};
