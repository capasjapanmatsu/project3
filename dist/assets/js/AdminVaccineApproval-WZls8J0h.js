const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-BHS2ZDIu.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as s}from"./motion-CuO0nkIV.js";import{r as a}from"./react-vendor-cniURDpR.js";import{B as r}from"./Button-BVIkPLCk.js";import{u as t,s as i,C as n}from"./index-Cxr3hxlQ.js";import{a as d}from"./router-Cg6wfOY4.js";import{i as c,a4 as l,J as o,f as m,b as x,h,V as g,M as j,j as p,bb as b}from"./ui-basic-icnN6BOT.js";import"./heavy-features-BIdEME4r.js";function u(){const{user:u,isAdmin:v}=t(),_=d(),[N,f]=a.useState([]),[w,y]=a.useState([]),[k,S]=a.useState([]),[C,A]=a.useState(!0),[D,z]=a.useState(""),[L,$]=a.useState(""),[E,I]=a.useState("pending"),[T,q]=a.useState(null),[M,B]=a.useState(!1),[F,J]=a.useState(!1),[O,P]=a.useState(null);a.useEffect(()=>{v?U():_("/")},[v,_]),a.useEffect(()=>{N.length>0&&R()},[N]);const V=e=>{$(e),z(""),setTimeout(()=>$(""),5e3)},Y=e=>{z(e),$(""),setTimeout(()=>z(""),8e3)},R=()=>{const e=N.filter(e=>"pending"===e.status),s=N.filter(e=>"approved"===e.status);y(e),S(s)},U=async()=>{try{A(!0),z("");const{data:e,error:s}=await i.from("vaccine_certifications").select("\n          *,\n          dog:dogs (\n            id,\n            name,\n            breed,\n            gender,\n            birth_date,\n            owner:profiles (\n              id,\n              name,\n              email,\n              phone_number,\n              address,\n              postal_code\n            )\n          )\n        ").order("created_at",{ascending:!1});if(s)throw s;const a=(e||[]).map(e=>({id:e.id,dog_id:e.dog_id,dog_name:e.dog?.name||"不明",dog_breed:e.dog?.breed||"不明",dog_gender:e.dog?.gender||"不明",dog_birth_date:e.dog?.birth_date||"",owner_id:e.dog?.owner?.id||"",owner_name:e.dog?.owner?.name||"不明",owner_email:e.dog?.owner?.email||"不明",owner_phone:e.dog?.owner?.phone_number||"",owner_address:e.dog?.owner?.address||"",owner_postal_code:e.dog?.owner?.postal_code||"",rabies_vaccine_image:e.rabies_vaccine_image||"",combo_vaccine_image:e.combo_vaccine_image||"",rabies_expiry_date:e.rabies_expiry_date||"",combo_expiry_date:e.combo_expiry_date||"",status:e.status||"pending",created_at:e.created_at,admin_notes:e.admin_notes||""}));f(a)}catch(e){Y("ワクチン証明書申請の取得に失敗しました。")}finally{A(!1)}},G=e=>{switch(e){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},H=e=>{switch(e){case"pending":return"承認待ち";case"approved":return"承認済み";case"rejected":return"却下";default:return"不明"}},K=e=>new Date(e).toLocaleDateString("ja-JP"),Q=e=>{if(!e)return"不明";const s=new Date,a=new Date(e),r=s.getFullYear()-a.getFullYear(),t=s.getMonth()-a.getMonth();return t<0||0===t&&s.getDate()<a.getDate()?r-1+"歳":`${r}歳`};return v?C?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"データを読み込み中..."})]})}):s.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:s.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[s.jsxs("div",{className:"bg-white shadow rounded-lg mb-8",children:[s.jsxs("div",{className:"px-6 py-4 border-b border-gray-200",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワクチン証明書 承認管理"}),s.jsx("p",{className:"text-gray-600",children:"登録されたワクチン証明書の承認・却下を管理します。"})]}),D&&s.jsx("div",{className:"px-6 py-4 bg-red-50 border-l-4 border-red-400",children:s.jsxs("div",{className:"flex",children:[s.jsx(c,{className:"h-5 w-5 text-red-400 mr-2"}),s.jsx("p",{className:"text-sm text-red-700",children:D})]})}),L&&s.jsx("div",{className:"px-6 py-4 bg-green-50 border-l-4 border-green-400",children:s.jsxs("div",{className:"flex",children:[s.jsx(l,{className:"h-5 w-5 text-green-400 mr-2"}),s.jsx("p",{className:"text-sm text-green-700",children:L})]})}),s.jsx("div",{className:"px-6",children:s.jsxs("nav",{className:"flex space-x-8","aria-label":"Tabs",children:[s.jsxs("button",{onClick:()=>I("pending"),className:"whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm "+("pending"===E?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(o,{className:"w-5 h-5 inline mr-2"}),"承認待ち",s.jsx("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:w.length})]}),s.jsxs("button",{onClick:()=>I("approved"),className:"whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm "+("approved"===E?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[s.jsx(m,{className:"w-5 h-5 inline mr-2"}),"登録中のワンちゃん",s.jsx("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:k.length})]})]})})]}),"pending"===E&&s.jsx("div",{className:"space-y-6",children:0===w.length?s.jsxs(n,{className:"text-center py-12",children:[s.jsx(o,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"承認待ちのワクチン証明書申請がありません"})]}):s.jsx("div",{className:"space-y-4",children:w.map(a=>s.jsx(n,{className:"p-6",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[s.jsx(m,{className:"w-5 h-5 text-blue-600"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:a.dog_name}),s.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${G(a.status)}`,children:H(a.status)})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"ワンちゃん情報"}),s.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.jsxs("div",{children:["犬種: ",a.dog_breed]}),s.jsxs("div",{children:["性別: ",a.dog_gender]}),s.jsxs("div",{children:["年齢: ",Q(a.dog_birth_date)]})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"飼い主情報"}),s.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),a.owner_name]}),s.jsxs("div",{className:"flex items-center",children:[s.jsx(h,{className:"w-4 h-4 mr-1"}),a.owner_email]}),a.owner_phone&&s.jsxs("div",{className:"flex items-center",children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),a.owner_phone]}),a.owner_address&&s.jsxs("div",{className:"flex items-center",children:[s.jsx(j,{className:"w-4 h-4 mr-1"}),"〒",a.owner_postal_code," ",a.owner_address]})]})]})]}),s.jsxs("div",{className:"text-sm text-gray-500",children:["申請日: ",K(a.created_at)]})]}),s.jsxs("div",{className:"flex space-x-2 ml-4",children:[s.jsxs(r,{size:"sm",variant:"secondary",onClick:()=>{q(a),B(!0)},children:[s.jsx(p,{className:"w-4 h-4 mr-1"}),"詳細"]}),s.jsxs(r,{size:"sm",onClick:()=>(async s=>{if(window.confirm("このワクチン証明書申請を承認してもよろしいですか？"))try{J(!0),z(""),$("");const{error:r}=await i.from("vaccine_certifications").update({status:"approved",approved_at:(new Date).toISOString()}).eq("id",s);if(r)throw r;const t=N.find(e=>e.id===s);if(t)try{const{notifyAppAndLine:s}=await e(async()=>{const{notifyAppAndLine:e}=await import("./notify-C6OTkr81.js");return{notifyAppAndLine:e}},__vite__mapDeps([0]));await s({userId:t.owner_id,title:"ワクチン証明書承認",message:`${t.dog_name}ちゃんのワクチン証明書が承認されました。`,linkUrl:"/dashboard",kind:"alert",sendApp:!1,sendLine:!0})}catch(a){}V("ワクチン証明書を承認しました。"),f(e=>e.map(e=>e.id===s?{...e,status:"approved"}:e))}catch(r){Y("承認処理に失敗しました。")}finally{J(!1)}})(a.id),className:"bg-green-600 hover:bg-green-700",disabled:F,children:[s.jsx(l,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsx(r,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white",onClick:()=>(async e=>{const s=window.prompt("却下理由を入力してください（ユーザーに送信されます）");if(null===s)return;const a=String(s).trim();if(a)try{J(!0),z(""),$("");const{error:s}=await i.from("vaccine_certifications").update({status:"pending"}).eq("id",e.id);if(s)throw s;if(u?.id){let s=e.owner_id;if(!s){const{data:a}=await i.from("vaccine_certifications").select("dog:dogs(owner_id)").eq("id",e.id).single();s=a?.dog?.owner_id||""}if(s){const r=`【ワクチン証明書 却下のお知らせ】\n${e.dog_name}ちゃんのワクチン証明書は却下されました。\n理由: ${a}\nお手数ですが、画像や有効期限をご確認のうえ再提出をお願いいたします。`,{error:t}=await i.from("messages").insert({sender_id:u.id,receiver_id:s,content:r});t&&Y("却下は反映しましたが、メッセージ送信に失敗しました")}else Y("飼い主IDの取得に失敗しました")}f(s=>s.map(s=>s.id===e.id?{...s,status:"pending"}:s)),V("却下（申請待ちに戻しました）し、メッセージを送信しました")}catch(r){Y("却下処理に失敗しました")}finally{J(!1)}else Y("却下理由を入力してください")})(a),disabled:F,children:"却下"})]})]})},a.id))})}),"approved"===E&&s.jsx("div",{className:"space-y-6",children:0===k.length?s.jsxs(n,{className:"text-center py-12",children:[s.jsx(m,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"承認済みのワクチン証明書がありません"})]}):s.jsx("div",{className:"space-y-4",children:k.map(e=>s.jsx(n,{className:"p-6",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[s.jsx(m,{className:"w-5 h-5 text-green-600"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:e.dog_name}),s.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${G(e.status)}`,children:H(e.status)})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"ワンちゃん情報"}),s.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.jsxs("div",{children:["犬種: ",e.dog_breed]}),s.jsxs("div",{children:["性別: ",e.dog_gender]}),s.jsxs("div",{children:["年齢: ",Q(e.dog_birth_date)]})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"飼い主情報"}),s.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),e.owner_name]}),s.jsxs("div",{className:"flex items-center",children:[s.jsx(h,{className:"w-4 h-4 mr-1"}),e.owner_email]}),e.owner_phone&&s.jsxs("div",{className:"flex items-center",children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),e.owner_phone]}),e.owner_address&&s.jsxs("div",{className:"flex items-center",children:[s.jsx(j,{className:"w-4 h-4 mr-1"}),"〒",e.owner_postal_code," ",e.owner_address]})]})]})]}),s.jsxs("div",{className:"text-sm text-gray-500",children:["申請日: ",K(e.created_at)]})]}),s.jsx("div",{className:"flex space-x-2 ml-4",children:s.jsxs(r,{size:"sm",variant:"secondary",onClick:()=>{q(e),B(!0)},children:[s.jsx(p,{className:"w-4 h-4 mr-1"}),"詳細"]})})]})},e.id))})}),M&&T&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:s.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsx("h2",{className:"text-xl font-bold",children:"ワクチン証明書詳細"}),s.jsx("button",{onClick:()=>{B(!1),q(null)},className:"text-gray-500 hover:text-gray-700",children:"×"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"ワンちゃん情報"}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{children:[s.jsx("strong",{children:"名前:"})," ",T.dog_name]}),s.jsxs("div",{children:[s.jsx("strong",{children:"犬種:"})," ",T.dog_breed]}),s.jsxs("div",{children:[s.jsx("strong",{children:"性別:"})," ",T.dog_gender]}),s.jsxs("div",{children:[s.jsx("strong",{children:"年齢:"})," ",Q(T.dog_birth_date)]})]})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"飼い主情報"}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{children:[s.jsx("strong",{children:"名前:"})," ",T.owner_name]}),s.jsxs("div",{children:[s.jsx("strong",{children:"メール:"})," ",T.owner_email]}),T.owner_phone&&s.jsxs("div",{children:[s.jsx("strong",{children:"電話:"})," ",T.owner_phone]}),T.owner_address&&s.jsxs("div",{children:[s.jsx("strong",{children:"住所:"})," 〒",T.owner_postal_code," ",T.owner_address]})]})]})]}),s.jsxs("div",{className:"mt-6",children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"ワクチン証明書画像"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[T.rabies_vaccine_image&&s.jsxs("div",{children:[s.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン",T.rabies_expiry_date&&s.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(有効期限: ",K(T.rabies_expiry_date),")"]})]}),s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:T.rabies_vaccine_image,alt:"狂犬病ワクチン証明書",className:"w-full h-48 object-cover rounded-lg border cursor-pointer",onClick:()=>P(T.rabies_vaccine_image)}),s.jsx("div",{className:"absolute top-2 right-2",children:s.jsx("button",{onClick:()=>P(T.rabies_vaccine_image),className:"bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-70",children:s.jsx(b,{className:"w-4 h-4"})})})]})]}),T.combo_vaccine_image&&s.jsxs("div",{children:[s.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン",T.combo_expiry_date&&s.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(有効期限: ",K(T.combo_expiry_date),")"]})]}),s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:T.combo_vaccine_image,alt:"混合ワクチン証明書",className:"w-full h-48 object-cover rounded-lg border cursor-pointer",onClick:()=>P(T.combo_vaccine_image)}),s.jsx("div",{className:"absolute top-2 right-2",children:s.jsx("button",{onClick:()=>P(T.combo_vaccine_image),className:"bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-70",children:s.jsx(b,{className:"w-4 h-4"})})})]})]})]})]}),s.jsxs("div",{className:"mt-6 text-sm text-gray-500",children:["申請日: ",K(T.created_at)]})]})})}),O&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50",children:s.jsxs("div",{className:"relative max-w-4xl max-h-full",children:[s.jsx("button",{onClick:()=>P(null),className:"absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-70",children:"×"}),s.jsx("img",{src:O,alt:"拡大画像",className:"max-w-full max-h-full object-contain"})]})})]})}):s.jsx("div",{className:"max-w-4xl mx-auto p-4",children:s.jsx(n,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-center",children:[s.jsx(c,{className:"w-12 h-12 text-red-500 mr-4"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-red-700",children:"アクセス権限がありません"}),s.jsx("p",{className:"text-red-600",children:"このページは管理者のみアクセス可能です。"})]})]})})})}export{u as default};
