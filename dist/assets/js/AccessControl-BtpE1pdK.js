var e=Object.defineProperty,s=(s,a,t)=>((s,a,t)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t)(s,"symbol"!=typeof a?a+"":a,t);import{j as a}from"./motion-BHsL7Azw.js";import{r as t}from"./react-vendor-CMvmJHsS.js";import{s as r,u as l,b as i,B as n}from"./index-4WslulxM.js";import{C as c}from"./Card-DqVnP9TA.js";import{L as d}from"./LazyImage-5LRcDmeb.js";import{V as m,g as o}from"./VaccineBadge-DXnDXW8s.js";import{a as x}from"./router-DXQOdrLL.js";import{Z as h,a8 as u,c as j,i as g,u as b,M as N,N as p,an as y,ah as f,K as v,O as w,b as I}from"./ui-basic-BVqAzqVO.js";import"./heavy-features-Dlg1c9Yc.js";import"./supabase--qivnNSU.js";class S extends Error{constructor(e,a){super(e),s(this,"code"),this.code=a,this.name="LocationError"}}const P=(e,s,a,t)=>{const r=k(a-e),l=k(t-s),i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(k(e))*Math.cos(k(a))*Math.sin(l/2)*Math.sin(l/2),n=6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)));return Math.round(100*n)/100},k=e=>e*(Math.PI/180),M=e=>e<1?`${Math.round(1e3*e)}m`:e<10?`${e.toFixed(1)}km`:`${Math.round(e)}km`,_={latitude:35.6812,longitude:139.7671};function D(){const{user:e}=l(),s=x();i();const[k,D]=t.useState([]),[C,z]=t.useState([]),[Z,A]=t.useState([]),[E,O]=t.useState([]),[L,G]=t.useState(null),[T,B]=t.useState(null),[H,U]=t.useState(null),[$,Q]=t.useState(!1),[q,J]=t.useState(!1),[W,R]=t.useState(""),[Y,K]=t.useState(""),[V,F]=t.useState(null),[X,ee]=t.useState(null),[se,ae]=t.useState(!1),[te,re]=t.useState(null),[le,ie]=t.useState(!1),[ne,ce]=t.useState(1),de=()=>{if(L&&0!==E.length)if(te&&!te.needsPayment){ae(!0),R("");try{const e=Math.floor(1e5+9e5*Math.random()).toString(),s=new Date(Date.now()+3e5).toISOString();F(e),ee(s),K("PINコードが生成されました（デモ版）")}catch(e){const s=e instanceof Error?e.message:"PIN生成中にエラーが発生しました";R(s)}finally{ae(!1)}}else s(`/parks/${L.id}/reserve`);else R("犬と施設を選択してください")},me=e=>{const s=new Date(e),a=new Date;return`${Math.floor((s.getTime()-a.getTime())/6e4)}分後`},oe=async()=>{J(!0);try{const e=await new Promise((e,s)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(s=>{e({latitude:s.coords.latitude,longitude:s.coords.longitude})},e=>{let a="位置情報の取得に失敗しました";switch(e.code){case e.PERMISSION_DENIED:a="位置情報の使用が拒否されました";break;case e.POSITION_UNAVAILABLE:a="位置情報が利用できません";break;case e.TIMEOUT:a="位置情報の取得がタイムアウトしました"}s(new S(a,e.code))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4}):s(new S("このブラウザは位置情報をサポートしていません",0))});U(e)}catch(e){U(_),e instanceof S&&1===e.code&&R("位置情報の使用が拒否されました。手動で施設を選択してください。")}finally{J(!1)}},xe=(e,s)=>{const a=((e,s)=>e.filter(e=>e.latitude&&e.longitude).map(e=>({...e,distance:P(s.latitude,s.longitude,e.latitude,e.longitude)})).sort((e,s)=>e.distance-s.distance))(e,s);A(a),a.length>0&&!L&&a[0]&&he(a[0])},he=e=>{G(e),R(""),ie(!1),ce(1);const s={id:`lock_${e.id}`,lock_id:`LOCK_${e.name}`,park_id:e.id,lock_name:`${e.name} - 入場ゲート`,lock_type:"ttlock_smart_lock",purpose:"entry_exit",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};B(s)};t.useEffect(()=>{const s=async()=>{try{let e=r.from("dog_parks").select("*").eq("status","approved");const{data:s,error:a}=await e;if(a){const e=[{id:"test-park-1",name:"テスト用ドッグラン",address:"東京都渋谷区1-1-1",city:"渋谷区",status:"approved",is_public:!0,latitude:35.658,longitude:139.7016,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}];return void z(e)}z(s||[])}catch(e){}},a=async()=>{if(e)try{const s=await(async e=>{try{const{data:s,error:a}=await r.from("stripe_subscriptions").select("*").eq("user_id",e).eq("status","active").single();if(a&&a.code,s)return{hasSubscription:!0,hasDayPass:!1,needsPayment:!1,paymentType:"subscription"};const{data:t,error:l}=await r.from("entrance_qr_codes").select("*").eq("user_id",e).eq("status","active").gt("valid_until",(new Date).toISOString()).maybeSingle(),i=t;return t&&i?{hasSubscription:!1,hasDayPass:!0,validUntil:i.valid_until,needsPayment:!1,paymentType:"admin_grant"===i.payment_type?"admin_grant":"day_pass"}:{hasSubscription:!1,hasDayPass:!1,needsPayment:!0}}catch(W){return{hasSubscription:!1,hasDayPass:!1,needsPayment:!0}}})(e.id);re(s)}catch(s){re({hasSubscription:!1,hasDayPass:!1,needsPayment:!0})}};(async()=>{if(e)try{const{data:t,error:l}=await r.from("dogs").select("\n            *,\n            vaccine_certifications (\n              id,\n              status,\n              rabies_expiry_date,\n              combo_expiry_date,\n              approved_at\n            )\n          ").eq("owner_id",e.id);if(l)R("ワンちゃんの情報を取得できませんでした。");else{const e=(t||[]).filter(e=>"approved"===o(e));D(e),t&&t.length>0&&0===e.length&&R("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")}Q(!1);const i=[s(),a(),oe()];Promise.allSettled(i)}catch(t){R("データの取得に失敗しました。"),Q(!1)}})()},[e]),t.useEffect(()=>{if(H&&C.length>0){(async()=>{await new Promise(e=>setTimeout(e,10)),xe(C,H)})()}},[H,C]);const ue=t.useCallback(e=>{O(s=>s.includes(e)?s.filter(s=>s!==e):s.length<3?[...s,e]:s)},[]),je=t.useCallback(()=>E.map(e=>{const s=k.find(s=>s.id===e);return s?`${s.name}${ge(s.gender)}`:""}).filter(Boolean).join("、"),[E,k]),ge=t.useCallback(e=>"オス"===e?"くん":"ちゃん",[]),be=t.useMemo(()=>{if(!te)return"";if(te.hasSubscription)return"✅ サブスクリプション会員（全国利用可能）";if(te.hasDayPass){return`✅ ワンデイパス利用可能（${te.validUntil?new Date(te.validUntil).toLocaleString("ja-JP"):""}まで）`}return"⚠️ 利用にはサブスクリプションまたはワンデイパスが必要です"},[te]);return $?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a.jsxs("div",{className:"max-w-4xl mx-auto",children:[a.jsxs("div",{className:"flex items-center mb-6",children:[a.jsxs(n,{variant:"primary",size:"sm",onClick:()=>s(-1),className:"mr-3",children:[a.jsx(h,{className:"w-4 h-4 mr-2"}),"戻る"]}),a.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),W&&a.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:W}),Y&&a.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:Y}),te&&a.jsx(c,{className:"p-4 mb-6 bg-blue-50 border-blue-200",children:a.jsxs("div",{className:"flex items-center",children:[a.jsx(u,{className:"w-5 h-5 text-blue-600 mr-2"}),a.jsx("span",{className:"text-sm text-blue-800",children:be})]})}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[a.jsxs("div",{className:"space-y-6",children:[a.jsxs(c,{className:"p-6",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[a.jsx(j,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),0===k.length?a.jsxs("div",{className:"text-center py-8",children:[a.jsx(g,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),a.jsx(n,{onClick:()=>s("/dog-registration"),children:"ワンちゃんを登録する"})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"flex justify-between items-center mb-3",children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",3,"頭）"]}),a.jsxs("div",{className:"text-sm text-gray-600",children:[E.length,"/",3,"頭選択中"]})]}),a.jsx("div",{className:"grid grid-cols-1 gap-4",children:k.map(e=>{const s=E.includes(e.id),t=!s&&E.length>=3;return a.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(s?"border-green-500 bg-green-50":t?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>!t&&ue(e.id),children:[s&&a.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:a.jsx(b,{className:"w-4 h-4"})}),a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?a.jsx(d,{src:e.image_url,alt:e.name,width:48,height:48,loading:"lazy",priority:!1,className:"w-full h-full object-cover rounded-full",placeholderSrc:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPGVsbGlwc2UgY3g9IjEyIiBjeT0iMTMiIHJ4PSIxMCIgcnk9IjQiLz4KPHBhdGggZD0ibTEyIDEzIDQuNS05IDQuNSA5Ii8+CjxwYXRoIGQ9Im0xMiAxMyA0LjUtOUw3IDEzIi8+CjxwYXRoIGQ9Im0xMiAxM0w3IDQgNy41IDEzIi8+Cjwvc3ZnPgo8L3N2Zz4K"}):a.jsx(j,{className:"w-6 h-6 text-gray-500"})}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[a.jsxs("h3",{className:"font-semibold",children:[e.name,ge(e.gender)]}),a.jsx(m,{status:o(e),size:"sm"})]}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.breed," • ",e.gender]})]})]})]},e.id)})})]}),E.length>0&&a.jsx("div",{className:"p-3 bg-green-50 rounded-lg",children:a.jsxs("p",{className:"text-sm text-green-800",children:[a.jsx("strong",{children:"選択中:"})," ",je]})})]})]}),a.jsxs(c,{className:"p-6",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[a.jsx(N,{className:"w-5 h-5 text-blue-600 mr-2"}),"利用する施設を選択"]}),q&&a.jsxs("div",{className:"flex items-center justify-center py-4 text-blue-600",children:[a.jsx(p,{className:"w-4 h-4 animate-spin mr-2"}),"現在位置を取得中..."]}),0===Z.length?a.jsxs("div",{className:"text-center py-8",children:[a.jsx(g,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600 mb-4",children:"利用可能な施設がありません"}),a.jsx(n,{onClick:()=>s("/parks"),children:"ドッグラン一覧を見る"})]}):a.jsxs("div",{className:"space-y-3",children:[le?(()=>{const e=Z.slice(3),s=10*(ne-1),t=s+10,r=e.slice(s,t),l=Math.ceil(e.length/10);return a.jsxs("div",{className:"space-y-3",children:[r.map(e=>a.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+(L?.id===e.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>he(e),children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"font-semibold mb-1",children:e.name}),a.jsx("p",{className:"text-sm text-gray-600 mb-2",children:e.address}),a.jsxs("div",{className:"flex items-center text-sm text-blue-600",children:[a.jsx(p,{className:"w-4 h-4 mr-1"}),"約 ",M(e.distance)]})]}),L?.id===e.id&&a.jsx(b,{className:"w-6 h-6 text-blue-500 flex-shrink-0 ml-2"})]})},e.id)),l>1&&a.jsxs("div",{className:"flex justify-center items-center space-x-2 pt-2",children:[a.jsx(n,{variant:"secondary",size:"sm",disabled:1===ne,onClick:()=>ce(e=>e-1),children:"前の10件"}),a.jsxs("span",{className:"text-sm text-gray-600",children:[ne," / ",l]}),a.jsx(n,{variant:"secondary",size:"sm",disabled:ne===l,onClick:()=>ce(e=>e+1),children:"次の10件"})]})]})})():Z.slice(0,3).map(e=>a.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+(L?.id===e.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>he(e),children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"font-semibold mb-1",children:e.name}),a.jsx("p",{className:"text-sm text-gray-600 mb-2",children:e.address}),a.jsxs("div",{className:"flex items-center text-sm text-blue-600",children:[a.jsx(p,{className:"w-4 h-4 mr-1"}),"約 ",M(e.distance)]})]}),L?.id===e.id&&a.jsx(b,{className:"w-6 h-6 text-blue-500 flex-shrink-0 ml-2"})]})},e.id)),Z.length>3&&a.jsx(n,{variant:"secondary",className:"w-full",onClick:()=>{ie(!le),le||ce(1)},children:le?a.jsxs(a.Fragment,{children:[a.jsx(y,{className:"w-4 h-4 mr-2"}),"近い順",3,"件のみ表示"]}):a.jsxs(a.Fragment,{children:[a.jsx(f,{className:"w-4 h-4 mr-2"}),"その他の施設を表示（",Z.length-3,"件）"]})})]})]})]}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs(c,{className:"p-6",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[a.jsx(v,{className:"w-5 h-5 text-blue-600 mr-2"}),"PINコード生成"]}),L&&E.length>0?a.jsx("div",{className:"space-y-4",children:V?a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[a.jsxs("div",{className:"flex items-center mb-2",children:[a.jsx(b,{className:"w-5 h-5 text-green-600 mr-2"}),a.jsx("span",{className:"text-green-800 font-medium",children:"PIN生成完了"})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-3xl font-bold text-green-800 mb-2 tracking-wider",children:V}),a.jsxs("div",{className:"flex items-center justify-center text-sm text-green-700",children:[a.jsx(w,{className:"w-4 h-4 mr-1"}),a.jsxs("span",{children:["有効期限: ",X&&me(X)]})]})]})]}),a.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:a.jsxs("div",{className:"flex items-start",children:[a.jsx(I,{className:"w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5"}),a.jsxs("div",{className:"text-sm text-blue-800",children:[a.jsx("p",{className:"font-medium mb-1",children:"ご利用方法"}),a.jsx("p",{children:"ドッグランの入り口でこのPINコードを入力してください。"}),a.jsxs("p",{children:["このPINは一度のみ使用可能で、",X&&me(X),"に期限切れとなります。"]})]})]})}),a.jsx(n,{onClick:()=>{F(null),ee(null),K("")},className:"w-full",variant:"secondary",children:"新しいPINを生成"})]}):a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[a.jsx("h3",{className:"font-medium mb-2",children:"利用予定"}),a.jsxs("p",{className:"text-sm text-gray-600 mb-1",children:[a.jsx("strong",{children:"施設:"})," ",L.name]}),a.jsxs("p",{className:"text-sm text-gray-600 mb-1",children:[a.jsx("strong",{children:"ワンちゃん:"})," ",je]}),H&&a.jsxs("p",{className:"text-sm text-gray-600",children:[a.jsx("strong",{children:"距離:"})," 約 ",M(L.distance)]})]}),te?.needsPayment?a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:a.jsxs("div",{className:"flex items-start",children:[a.jsx(u,{className:"w-5 h-5 text-yellow-600 mr-2 flex-shrink-0 mt-0.5"}),a.jsxs("div",{className:"text-sm text-yellow-800",children:[a.jsx("p",{className:"font-medium mb-1",children:"決済が必要です"}),a.jsx("p",{children:"この施設を利用するには、サブスクリプションまたはワンデイパスの購入が必要です。"})]})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[a.jsxs(n,{onClick:()=>s("/subscription-intro"),className:"w-full bg-purple-600 hover:bg-purple-700",children:[a.jsx(u,{className:"w-4 h-4 mr-2"}),"サブスクリプション加入（¥3,800/月）"]}),a.jsxs(n,{onClick:de,className:"w-full",children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),"ワンデイパス購入（¥800〜）"]})]})]}):a.jsxs(n,{onClick:de,isLoading:se,className:"w-full",disabled:se,children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),"PINコードを生成"]})]})}):a.jsxs("div",{className:"text-center py-8",children:[a.jsx(v,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600 mb-2",children:"PINコードを生成するには："}),a.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[a.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),a.jsx("li",{children:"• 施設を選択"})]})]})]}),a.jsxs(c,{className:"p-6 bg-blue-50 border-blue-200",children:[a.jsx("h3",{className:"font-medium text-blue-900 mb-3",children:"PINコードの使い方"}),a.jsxs("div",{className:"space-y-2 text-sm text-blue-800",children:[a.jsx("p",{children:"1. 犬とドッグランを選択してPINを生成"}),a.jsx("p",{children:"2. 現地でスマートロックにPINを入力"}),a.jsx("p",{children:"3. ロックが解除されて入場完了"}),a.jsx("p",{children:"4. 退場時も同様にPINを生成して解錠"})]})]})]})]})]})}export{D as AccessControl};
