import{l as t}from"./external-api-DuTtfpce.js";import{r as o}from"./react-vendor-cniURDpR.js";import{s as e}from"./index-C8-ZovGr.js";function r(){const[r,s]=o.useState(!1),[a,i]=o.useState(null);return{createCheckoutSession:o.useCallback(async({priceId:o,mode:r,successUrl:a=`${window.location.origin}/payment-confirmation?success=true`,cancelUrl:n=`${window.location.origin}/payment-confirmation?canceled=true`,customAmount:c,customName:u,customParams:m,cartItems:l,trialPeriodDays:w})=>{s(!0),i(null);try{const{data:{session:s}}=await e.auth.getSession();if(!s?.access_token)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:s.user.id,user_email:s.user.email,timestamp:Date.now(),return_url:window.location.href}));const i={mode:r,success_url:a,cancel_url:n};o&&(i.price_id=o),w&&"subscription"===r&&(i.trial_period_days=w),c&&u&&(i.custom_amount=c,i.custom_name=u),l&&l.length>0&&(i.cart_items=l),m&&Object.entries(m).forEach(([t,o])=>{i[t]=o});const d=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify(i)});if(!d.ok){const t=await d.json();throw new Error(t.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:p,url:f}=await d.json();if(f)return void(window.location.href=f);if(!p)throw new Error("チェックアウトURLが取得できませんでした");{const o=void 0;if(!o)throw new Error("Stripe公開キーが設定されていません");const e=await t(o);if(!e)throw new Error("Stripeの読み込みに失敗しました");const{error:r}=await e.redirectToCheckout({sessionId:p});if(r)throw r}}catch(d){throw i(d.message||"チェックアウトに失敗しました"),d}finally{s(!1)}},[]),loading:r,error:a}}export{r as u};
