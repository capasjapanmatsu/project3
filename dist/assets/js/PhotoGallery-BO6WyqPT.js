import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{L as a}from"./router-Cg6wfOY4.js";import{B as s}from"./Button-DiksLhRM.js";import{u as r,C as i,s as l}from"./index-DWDIgw5z.js";import{af as o,az as c,aS as n,t as d}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";function m(){const{user:m}=r(),[p,u]=t.useState([]),[h,x]=t.useState(!0),[f,w]=t.useState(null),[g,j]=t.useState(""),[_,y]=t.useState(null),[N,v]=t.useState(null),[b,k]=t.useState(!1),S=t.useRef(null),C=t.useMemo(()=>!(!m||!N||b),[m,N,b]);t.useEffect(()=>{(async()=>{try{w(null),x(!0);const{data:e,error:t}=await l.from("photo_posts").select("id, user_id, image_url, caption, created_at, like_count").order("created_at",{ascending:!1}).limit(50);if(t)throw t;u(e||[])}catch(e){w(e.message||"読み込みに失敗しました")}finally{x(!1)}})()},[]);return e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(a,{to:"/",className:"inline-flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(o,{className:"w-4 h-4 mr-2"})," ホームへ戻る"]})}),e.jsx("h1",{className:"text-2xl font-bold",children:"写真投稿"}),e.jsx(i,{className:"p-4",children:m?e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:S,type:"file",accept:"image/*",onChange:e=>{const t=e.target.files?.[0];if(!t)return;y(t);const a=new FileReader;a.onload=()=>v(a.result),a.readAsDataURL(t)}}),N&&e.jsx("div",{className:"w-48 h-48 overflow-hidden rounded-lg border",children:e.jsx("img",{src:N,alt:"preview",className:"w-full h-full object-cover"})}),e.jsx("input",{type:"text",placeholder:"写真のコメント（任意）",className:"w-full border rounded px-3 py-2",value:g,onChange:e=>j(e.target.value),maxLength:120}),e.jsxs(s,{onClick:async()=>{if(m&&N){k(!0);try{const t=await(async(e,t=1080,a=.9)=>{const s=await new Promise((t,a)=>{const s=new Image;s.onload=()=>t(s),s.onerror=a,s.src=e}),r=Math.min(s.width,s.height,t),i=(s.width-r)/2,l=(s.height-r)/2,o=document.createElement("canvas");return o.width=r,o.height=r,o.getContext("2d").drawImage(s,i,l,r,r,0,0,r,r),await new Promise(e=>o.toBlob(t=>e(t),"image/webp",a))})(N),a=crypto.randomUUID(),s=`${m.id}/${a}.webp`,{error:r}=await l.storage.from("photos").upload(s,t,{contentType:"image/webp",upsert:!1});if(r)throw r;const{data:i}=l.storage.from("photos").getPublicUrl(s),o=i.publicUrl,{data:c,error:n}=await l.from("photo_posts").insert({id:a,user_id:m.id,image_url:o,caption:g.trim()||null}).select("id, user_id, image_url, caption, created_at, like_count").single();if(n)throw n;try{await l.rpc("rpc_award_photo_post",{p_user:m.id,p_photo_id:a})}catch(e){}u(e=>[c,...e]),j(""),v(null),y(null),S.current&&(S.current.value="")}catch(e){w(e.message||"アップロードに失敗しました")}finally{k(!1)}}},disabled:!C,children:[b?e.jsx(c,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(n,{className:"w-4 h-4 mr-2"}),"投稿する"]})]}):e.jsx("p",{className:"text-gray-600",children:"投稿するにはログインしてください。"})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:h?e.jsx("p",{className:"text-gray-500",children:"読み込み中..."}):f?e.jsx("p",{className:"text-red-600",children:f}):0===p.length?e.jsx("p",{className:"text-gray-600",children:"まだ投稿がありません。"}):p.map(t=>e.jsxs(i,{className:"p-2",children:[e.jsx("div",{className:"aspect-square w-full overflow-hidden rounded",children:e.jsx("img",{src:t.image_url,alt:"photo",className:"w-full h-full object-cover"})}),t.caption&&e.jsx("p",{className:"text-sm text-gray-700 mt-2 break-words",children:t.caption}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("button",{onClick:()=>(async e=>{if(m)try{const{error:a}=await l.from("photo_likes").insert({photo_id:e,user_id:m.id});if(a)throw a;try{await l.rpc("rpc_award_photo_like",{p_user:m.id,p_photo_id:e}),await l.rpc("rpc_award_photo_receive_like",{p_photo_id:e,p_liker:m.id})}catch(t){}u(t=>t.map(t=>t.id===e?{...t,like_count:(t.like_count||0)+1}:t))}catch(t){}})(t.id),className:"inline-flex items-center text-pink-600 hover:text-pink-700",children:[e.jsx(d,{className:"w-4 h-4 mr-1"})," いいね ",t.like_count||0]}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date(t.created_at).toLocaleDateString()})]})]},t.id))})]})}export{m as default};
