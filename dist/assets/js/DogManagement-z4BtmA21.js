const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/css/index-zjdDj_dm.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-B0bqaRGb.js";import{j as r}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{L as i}from"./router-Cg6wfOY4.js";import{B as a}from"./Button-Bq1kOCic.js";import{u as o,s,b as n,C as c}from"./index-DcAUXhuw.js";import{D as d,a as l}from"./DogCard-BkexpBlY.js";import{u as m}from"./webpConverter-BlYlpTMV.js";import{af as u,o as g,P as p}from"./ui-basic-Kxp_U5Up.js";import"./heavy-features-BIdEME4r.js";import"./dogBreeds-6lxY8Uni.js";import"./ImageCropper-BaK2vU6_.js";import"./Input-rtfXcnE2.js";import"./LazyImage-BjX-Msut.js";import"./Select-Dd_IZFKg.js";import"./VaccineBadge-ZTVmxLHB.js";async function f(e){try{const r=await e();return{data:r.data,error:r.error}}catch(r){return{data:null,error:r}}}function h(){const{user:h}=o(),[b,x]=t.useState([]),[y,w]=t.useState(!0),[_,j]=t.useState(""),[v,S]=t.useState(!1),[E,N]=t.useState(null),[D,I]=t.useState(!1),[C,U]=t.useState(""),[R,$]=t.useState(""),[V,L]=t.useState(!1),[F,q]=t.useState({name:"",breed:"",gender:"",birthDate:"",microchipNumber:""}),[A,B]=t.useState(null),[P,z]=t.useState(null),[M,O]=t.useState({x:0,y:0}),[T,W]=t.useState(1),[k,G]=t.useState(null),[J,K]=t.useState(null),[Z,H]=t.useState(null),[Q,X]=t.useState(""),[Y,ee]=t.useState(""),re=t.useCallback(async()=>{try{w(!0),j("");const e=await f(()=>s.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",h?.id).order("created_at",{ascending:!1}));if(e.error)return n("error","Error fetching dogs",{error:e.error,userId:h?.id}),void j("ワンちゃんの情報を取得できませんでした。");x(e.data||[])}catch(e){n("error","Exception in fetchDogs",{error:e,userId:h?.id}),j("ワンちゃんの情報を取得できませんでした。")}finally{w(!1)}},[h?.id]);t.useEffect(()=>{h&&re()},[h,re]);const te=e=>{N(e),q({name:e.name,breed:e.breed,gender:e.gender,birthDate:e.birth_date,microchipNumber:e.microchip_number||""}),z(e.image_url||null);const r=e.vaccine_certifications?.[0];r&&(X(r.rabies_expiry_date||""),ee(r.combo_expiry_date||"")),S(!0)};return y?r.jsxs("div",{className:"flex justify-center items-center h-64",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),r.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsxs(i,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[r.jsx(u,{className:"w-4 h-4 mr-2"}),"マイページに戻る"]}),r.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),r.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),r.jsx(i,{to:"/dog-registration",children:r.jsxs(a,{children:[r.jsx(g,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),_&&r.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:_}),R&&r.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:R}),r.jsxs(c,{children:[r.jsx("div",{className:"flex justify-between items-center mb-4",children:r.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[r.jsx(p,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",b.length,"匹)"]})}),0===b.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(p,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),r.jsx(i,{to:"/dog-registration",children:r.jsxs(a,{children:[r.jsx(g,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):r.jsx("div",{className:"space-y-4",children:b.map(e=>r.jsx(d,{dog:e,onEdit:te},e.id))})]}),v&&E&&r.jsx(l,{dog:E,isUpdating:D||V,error:C,success:R,dogFormData:F,dogImagePreview:P,onClose:()=>S(!1),onSubmit:r=>{(async r=>{if(r.preventDefault(),E){I(!0),U(""),$("");try{const r={name:F.name,breed:F.breed,gender:F.gender,birth_date:F.birthDate,...F.microchipNumber&&{microchip_number:F.microchipNumber}};if(A||P||(r.image_url=""),A){const e=await createImageBitmap(A),t=Math.min(e.width,e.height),i=Math.min(1200,t),a=document.createElement("canvas");a.width=i,a.height=i;const o=a.getContext("2d"),s=!!k,n=s?k.x:(e.width-t)/2,c=s?k.y:(e.height-t)/2,d=s?k.width:t,l=s?k.height:t;o.drawImage(e,n,c,d,l,0,0,i,i);const u=await new Promise(e=>a.toBlob(r=>e(r),"image/jpeg",.9)),g=new File([u],"dog-square.jpg",{type:"image/jpeg"}),p=`${E.id}/${crypto.randomUUID()}.webp`,f=await m("dog-images",g,p,{quality:85,generateThumbnail:!1}),h=f.webpUrl||f.originalUrl;if(!h)throw new Error("画像の保存に失敗しました");r.image_url=h}const{data:t,error:i}=await s.from("dogs").update(r).eq("id",E.id).eq("owner_id",h?.id).select("id,image_url");if(i)throw i;if(!t||0===t.length)throw new Error("更新対象が見つからない、または権限により更新できませんでした。");if(J&&Z&&Q&&Y){const r=J.name.split(".").pop()||"jpg",t=Z.name.split(".").pop()||"jpg",i=Date.now(),a=`temp/${E.id}/rabies_${i}.${r}`,o=`temp/${E.id}/combo_${i}.${t}`;n("info","Uploading vaccine certificates with direct method");const{debugAuthStatus:c}=await e(async()=>{const{debugAuthStatus:e}=await import("./authDebug-C27MwyYg.js");return{debugAuthStatus:e}},__vite__mapDeps([0]));await c();const{directVaccineUpload:d}=await e(async()=>{const{directVaccineUpload:e}=await import("./directVaccineUpload-MMACbgSC.js");return{directVaccineUpload:e}},__vite__mapDeps([0]));n("info","Direct upload function imported successfully");const[l,m]=await Promise.all([d(a,J),d(o,Z)]);if(n("info","Upload results",{rabiesUpload:l,comboUpload:m}),!l.success||!m.success){n("error","VACCINE UPLOAD ERROR DETAILS"),l.success||n("error","Rabies upload error",{error:l.error}),m.success||n("error","Combo upload error",{error:m.error});const e=l.error||m.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${e}`)}n("info","Vaccine certificates uploaded successfully"),n("info","Rabies upload result",{url:l.url}),n("info","Combo upload result",{url:m.url});const u=l.url,g=m.url;n("info","Public URLs obtained",{rabiesPublicUrl:u,comboPublicUrl:g}),n("info","Saving vaccine certificates to database");const p=await f(()=>s.from("vaccine_certifications").upsert([{dog_id:E.id,rabies_vaccine_image:u,combo_vaccine_image:g,rabies_expiry_date:Q,combo_expiry_date:Y,status:"pending"}],{onConflict:"dog_id"}));if(p.error){n("error","Database save error",{error:p.error});const e=p.error instanceof Error?p.error.message:JSON.stringify(p.error);throw e.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${e}`)}n("info","Vaccine certificates saved to database successfully")}$("ワンちゃん情報を更新しました"),await re(),setTimeout(()=>{S(!1),$(""),B(null),z(null),K(null),H(null),X(""),ee("")},2e3)}catch(t){n("error","Error updating dog",{error:t,dogId:E?.id});let e="ワンちゃん情報の更新に失敗しました";t instanceof Error&&(e=t.message.includes("520")||t.message.includes("Cloudflare")?"ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":t.message.includes("アップロードに失敗しました")?t.message:`エラーが発生しました: ${t.message}`),U(e)}finally{I(!1)}}})(r)},onDelete:e=>{(async e=>{L(!0),U("");try{n("info","Deleting dog:",{name:e.name,id:e.id});const{error:t}=await s.from("vaccine_certifications").delete().eq("dog_id",e.id);if(t&&n("warn","Error deleting vaccine certifications",{error:t,dogId:e.id}),e.image_url)try{const r=new URL(e.image_url).pathname.split("/"),t=r[r.length-1],i=`${e.id}/${t}`,{error:a}=await s.storage.from("dog-images").remove([i])}catch(r){}const i=e.vaccine_certifications?.[0];if(i){const e=[];if(i.rabies_vaccine_image&&e.push(i.rabies_vaccine_image),i.combo_vaccine_image&&e.push(i.combo_vaccine_image),e.length>0){const{error:r}=await s.storage.from("vaccine-certs").remove(e)}}const{error:a}=await s.from("dogs").delete().eq("id",e.id);if(a)throw n("error","Error deleting dog",{error:a,dogId:e.id}),a;n("info","Dog deleted successfully",{dogName:e.name}),await re(),S(!1),$(`${e.name}の情報を削除しました。`),setTimeout(()=>{$("")},3e3)}catch(t){n("error","Error deleting dog",{error:t,dogId:e?.id});const r=t.message||"ワンちゃんの削除に失敗しました";U(r)}finally{L(!1)}})(e)},onFormChange:q,onImageSelect:e=>{const r=e.target.files?.[0];if(n("info","🔍 File selected:",r?{name:r.name,type:r.type,size:r.size,lastModified:r.lastModified,isFileObject:r instanceof File}:{message:"No file selected"}),r)try{if(!(r instanceof File))return void U("有効なファイルを選択してください。");if(r.size>10485760)return void U("画像ファイルは10MB以下にしてください。");if(!r.type||!r.type.startsWith("image/"))return void U(`画像ファイルを選択してください。選択されたファイルタイプ: ${r.type}`);if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type))return void U(`サポートされていない画像形式です: ${r.type}`);B(r),n("info","✅ Dog image file set successfully:",{name:r.name,type:r.type,size:r.size});const e=new FileReader;e.onload=e=>{z(e.target?.result),O({x:0,y:0}),W(1),G(null)},e.readAsDataURL(r)}catch(t){U("画像の処理に失敗しました。")}},onImageRemove:()=>{(async()=>{if(E){B(null),z(null),N({...E,image_url:null});try{I(!0),U("");try{if(E.image_url&&E.image_url.includes("dog-images/")){const e=E.image_url.split("dog-images/")[1];e&&await s.storage.from("dog-images").remove([e])}}catch(e){}const{data:r,error:t}=await s.from("dogs").update({image_url:""}).eq("id",E.id).eq("owner_id",h?.id).select("id,image_url");if(t)return n("error","Error updating dog image_url",{error:t,dogId:E.id}),void U("画像の削除に失敗しました。");r&&0!==r.length||(n("warn","Image delete update affected 0 rows",{dogId:E.id,userId:h?.id}),U("画像の削除が反映されませんでした。（権限または対象なし）")),await re(),n("info","✅ Dog image removed successfully",{dogId:E.id}),$("画像を削除しました。"),setTimeout(()=>{$("")},3e3)}catch(r){n("error","Error removing dog image",{error:r,dogId:E?.id}),U("画像の削除に失敗しました。")}finally{I(!1)}}})()},onImageCropped:e=>(e=>{B(e);const r=URL.createObjectURL(e);z(r)})(e),crop:M,zoom:T,onCropChange:O,onZoomChange:W,onCropComplete:(e,r)=>G(r),rabiesVaccineFile:J,comboVaccineFile:Z,rabiesExpiryDate:Q,comboExpiryDate:Y,onRabiesVaccineSelect:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void U("ワクチン証明書ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void U("画像ファイルを選択してください。");K(r)}else K(null)},onComboVaccineSelect:e=>{const r=e.target.files?.[0];if(r){if(r.size>10485760)return void U("ワクチン証明書ファイルは10MB以下にしてください。");if(!r.type.startsWith("image/"))return void U("画像ファイルを選択してください。");H(r)}else H(null)},onRabiesExpiryDateChange:X,onComboExpiryDateChange:ee})]})}export{h as DogManagement,h as default};
