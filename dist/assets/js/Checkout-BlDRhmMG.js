import{j as e}from"./motion-CuO0nkIV.js";import{r as s}from"./react-vendor-cniURDpR.js";import{a,u as t,L as l}from"./router-Cg6wfOY4.js";import{B as r}from"./Button-BVIkPLCk.js";import{u as i,s as n,C as c}from"./index-Cxr3hxlQ.js";import{I as d}from"./Input-D7pb8xRh.js";import{u as m}from"./useStripe-BJiOmX4x.js";import{a4 as o,z as x,af as h,i as u,b as j,V as p,M as b,ao as g,ap as N,e as f,an as v}from"./ui-basic-icnN6BOT.js";import"./supabase-B0bqaRGb.js";import"./heavy-features-BIdEME4r.js";import"./external-api-CcgPsVUa.js";function y(){const{user:y}=i(),w=a(),S=t(),{createCheckoutSession:_,loading:C,error:L}=m(),[M,q]=s.useState(!0),[k,I]=s.useState(null),[A,E]=s.useState([]),[F,P]=s.useState(!1),[U,B]=s.useState(null),[D,T]=s.useState(!1),[$,J]=s.useState(!1),[V,z]=s.useState({name:"",postalCode:"",address:"",phoneNumber:"",email:"",notes:""}),[O,R]=s.useState({subtotal:0,originalSubtotal:0,discountAmount:0,shippingFee:0,total:0}),[X,G]=s.useState(0),[H,K]=s.useState(0);s.useEffect(()=>{if(!y)return void w("/login");const e=S.state;e?(e.totals&&R(e.totals),Q(e)):w("/cart")},[y,w,S]);const Q=async e=>{try{q(!0);const{data:s,error:a}=await n.from("profiles").select("*").eq("id",y?.id).single();if(a)throw a;if(z({name:s.name||"",postalCode:s.postal_code||"",address:s.address||"",phoneNumber:s.phone_number||"",email:y?.email||"",notes:""}),e.cartItems&&e.cartItems.length>0){const{data:s,error:a}=await n.from("cart_items").select("*, product:products(*)").in("id",e.cartItems).eq("user_id",y?.id);if(a)throw a;E(s||[])}else{const{data:e,error:s}=await n.from("cart_items").select("*, product:products(*)").eq("user_id",y?.id);if(s)throw s;E(e||[])}const{data:t}=await n.from("points_balances").select("balance").eq("user_id",y?.id).maybeSingle();K(t?.balance||0);const l=new URLSearchParams(window.location.search);if("true"===l.get("success"))T(!0),B(l.get("order_number")||Y());else if("true"===l.get("canceled")){J(!0),I("決済がキャンセルされました。必要に応じて再度お試しください。");const{data:{user:e}}=await n.auth.getUser();if(!e){localStorage.getItem("pre_payment_auth_state")&&(I("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{w("/login")},3e3))}window.history.replaceState({},document.title,window.location.pathname)}}catch(s){I(s.message||"データの取得に失敗しました。もう一度お試しください。")}finally{q(!1)}},W=e=>{if(!e)return"";try{const s=JSON.parse(e);if(Array.isArray(s)&&s.length>0)return s[0]}catch{}return e},Y=()=>`DP${Date.now()}${Math.floor(1e3*Math.random())}`;return M?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):D&&U?e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs(c,{className:"p-8 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(o,{className:"w-12 h-12 text-green-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"ご注文ありがとうございます！"}),e.jsxs("p",{className:"text-lg text-gray-600 mb-6",children:["注文番号: ",e.jsx("span",{className:"font-semibold",children:U})]}),e.jsx("div",{className:"bg-blue-50 p-6 rounded-lg mb-8 max-w-xl mx-auto",children:e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(x,{className:"w-6 h-6 text-blue-600 mr-3"}),e.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"ショッピング注文"})]}),e.jsx("p",{className:"text-blue-800 mb-2",children:"ご注文ありがとうございます。商品の発送準備を進めています。"}),e.jsx("p",{className:"text-blue-800",children:"注文の詳細は「注文履歴」ページでご確認いただけます。"})]})}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx(l,{to:"/orders",children:e.jsx(r,{children:"注文履歴を見る"})}),e.jsx(l,{to:"/petshop",children:e.jsx(r,{variant:"secondary",children:"ショッピングを続ける"})})]})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(l,{to:"/cart",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"カートに戻る"]})}),e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(x,{className:"w-8 h-8 text-green-600 mr-3"}),"お支払い情報"]}),(k||L)&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(u,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800",children:"エラーが発生しました"}),e.jsx("p",{className:"text-red-700",children:k||L}),$&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-red-700",children:"支払い処理に失敗しました。以下をご確認ください："}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-red-700 mt-1",children:[e.jsx("li",{children:"カード情報が正しいか確認してください"}),e.jsx("li",{children:"別の支払い方法をお試しください"}),e.jsx("li",{children:"しばらく経ってから再度お試しください"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(c,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),0!==A.length)try{if(P(!0),I(null),!V.name.trim())throw new Error("お名前を入力してください");if(!V.postalCode.trim())throw new Error("郵便番号を入力してください");if(!V.address.trim())throw new Error("住所を入力してください");if(!V.phoneNumber.trim())throw new Error("電話番号を入力してください");const e=Y();B(e),await _({priceId:"price_placeholder",mode:"payment",successUrl:void 0,cancelUrl:void 0,cartItems:A.map(e=>e.id),customParams:{shipping_name:V.name,shipping_address:V.address,shipping_postal_code:V.postalCode,shipping_phone:V.phoneNumber,notes:V.notes,order_number:e,points_use:Math.min(X,O.total)}})}catch(s){I(s.message||"エラーが発生しました"),P(!1)}else I("カートに商品がありません。")},children:[e.jsx("h2",{className:"text-xl font-semibold mb-6",children:"配送情報"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsx(d,{label:"お名前 *",value:V.name,onChange:e=>z({...V,name:e.target.value}),required:!0,icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(d,{label:"電話番号 *",value:V.phoneNumber,onChange:e=>z({...V,phoneNumber:e.target.value}),required:!0,icon:e.jsx(p,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(d,{label:"郵便番号 *",value:V.postalCode,onChange:e=>z({...V,postalCode:e.target.value}),required:!0,icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"}),placeholder:"123-4567"})}),e.jsx("div",{className:"mb-6",children:e.jsx(d,{label:"住所 *",value:V.address,onChange:e=>z({...V,address:e.target.value}),required:!0,icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{className:"mb-6",children:[e.jsx(d,{label:"メールアドレス *",type:"email",value:V.email,onChange:e=>z({...V,email:e.target.value}),required:!0,disabled:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"注文確認メールがこのアドレスに送信されます"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"備考"}),e.jsx("textarea",{value:V.notes,onChange:e=>z({...V,notes:e.target.value}),placeholder:"配送に関する特記事項があればご記入ください",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",rows:3})]}),e.jsx("h2",{className:"text-xl font-semibold mb-4 mt-8",children:"ポイント利用"}),e.jsxs("div",{className:"mb-4 p-4 bg-yellow-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-yellow-800",children:"保有ポイント"}),e.jsxs("div",{className:"text-2xl font-bold text-yellow-700",children:[H.toLocaleString()," P"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"使用ポイント"}),e.jsx("input",{type:"number",min:0,max:H,value:0===X?"":X,onChange:e=>G(Math.max(0,Math.min(H,Number(e.target.value)||0))),onFocus:e=>{0===X&&e.currentTarget.select()},placeholder:"0",className:"w-32 px-2 py-1 border border-gray-300 rounded"})]})]}),e.jsx("p",{className:"text-xs text-yellow-700 mt-2",children:"ポイントは1ポイント=1円として利用できます。"})]}),e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"支払い方法"}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{className:"w-5 h-5 text-gray-600"}),e.jsx("span",{className:"font-medium",children:"クレジットカード"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1 ml-7",children:"VISA, Mastercard, JCB, AMEX"})]}),e.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(N,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"支払い処理について"}),e.jsx("p",{children:"「注文を確定する」ボタンをクリックすると、選択した支払い方法の決済画面に移動します。決済が完了すると、自動的に注文が確定します。"})]})]})}),e.jsx("div",{className:"p-4 bg-blue-50 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(f,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"安全な決済"}),e.jsx("p",{children:"すべての支払い情報は暗号化されて安全に処理されます。当サイトでは実際のカード情報を保存しません。"})]})]})}),e.jsxs(r,{type:"submit",isLoading:F||C,className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",disabled:0===A.length,children:[e.jsx(g,{className:"w-5 h-5 mr-2"}),"注文を確定する (¥",Math.max(0,O.total-Math.min(X,O.total)).toLocaleString(),")"]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(c,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文内容"}),e.jsx("div",{className:"space-y-4 max-h-80 overflow-y-auto mb-4",children:A.map(s=>e.jsxs("div",{className:"flex items-center space-x-3 pb-3 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0",children:e.jsx("img",{src:W(s.product.image_url),alt:s.product.name,className:"w-full h-full object-cover",width:64,height:64,decoding:"async",onError:e=>{e.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm",children:s.product.name}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["数量: ",s.quantity]}),e.jsxs("span",{className:"text-sm font-medium",children:["¥",(s.product.price*s.quantity).toLocaleString()]})]})]})]},s.id))}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",O.originalSubtotal.toLocaleString()]})]}),O.discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm text-purple-600",children:[e.jsx("span",{children:"サブスク割引 (10%)"}),e.jsxs("span",{children:["-¥",O.discountAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"送料"}),e.jsx("span",{children:0===O.shippingFee?e.jsx("span",{className:"text-green-600",children:"無料"}):`¥${O.shippingFee.toLocaleString()}`})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"ポイント利用"}),e.jsxs("span",{className:"text-red-600",children:["-¥",Math.min(X,O.total).toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between font-bold text-base pt-2 border-t border-gray-200 mt-2",children:[e.jsx("span",{children:"支払い合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",Math.max(0,O.total-Math.min(X,O.total)).toLocaleString()]})]})]})]}),e.jsx(c,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(v,{className:"w-5 h-5 text-blue-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"}),e.jsx("p",{children:"• 配送状況はメールでお知らせします"})]})]})]})}),e.jsx(c,{className:"p-4 bg-gray-50 border-gray-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(f,{className:"w-5 h-5 text-gray-600 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:"セキュリティ"}),e.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[e.jsx("p",{children:"• SSL暗号化通信で個人情報を保護"}),e.jsx("p",{children:"• クレジットカード情報は保存されません"}),e.jsx("p",{children:"• 第三者認証のセキュリティ対策"})]})]})]})})]})]})]})}export{y as Checkout};
