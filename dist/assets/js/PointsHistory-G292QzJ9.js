import{j as e}from"./motion-CuO0nkIV.js";import{r as t}from"./react-vendor-cniURDpR.js";import{L as s}from"./router-Cg6wfOY4.js";import{u as a,C as r,s as n}from"./index-Cxr3hxlQ.js";import{B as l}from"./Button-BVIkPLCk.js";import{af as i,a6 as c,ag as o,ah as d,P as m}from"./ui-basic-icnN6BOT.js";import"./heavy-features-BIdEME4r.js";import"./supabase-B0bqaRGb.js";function x(){const{user:o,lineUser:d,isLineAuthenticated:m}=a(),[x,p]=t.useState(!0),[u,j]=t.useState(null),[g,f]=t.useState(0),[N,y]=t.useState([]),[b,w]=t.useState(0),[v,S]=t.useState(!1);return t.useEffect(()=>{(async()=>{try{p(!0),j(null);const e=o?.id||d?.id;if(!e)return j("ログインが必要です"),void p(!1);try{await n.rpc("rpc_daily_login_bonus",{p_user:e})}catch{}const[{data:t},{data:s,error:a}]=await Promise.all([n.from("points_balances").select("balance").eq("user_id",e).maybeSingle(),n.from("points_ledger").select("*").eq("user_id",e).order("occurred_at",{ascending:!1})]);if(f(t?.balance||0),a)throw a;y(s||[])}catch(e){j(e.message||"読み込みに失敗しました")}finally{p(!1)}})()},[o?.id,d?.id,m]),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(s,{to:"/dashboard",className:"inline-flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),"マイページへ戻る"]})}),e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center",children:[e.jsx(c,{className:"w-6 h-6 text-amber-600 mr-2"}),"ポイント履歴"]}),e.jsxs(r,{className:"p-4",children:[e.jsx("div",{className:"text-gray-700",children:"保有ポイント"}),e.jsxs("div",{className:"text-3xl font-bold text-amber-600",children:[g.toLocaleString()," P"]}),e.jsx("div",{className:"mt-3",children:e.jsx(s,{to:"/petshop",children:e.jsx(l,{className:"bg-purple-600 hover:bg-purple-700 text-white",children:"ペットショップへ"})})})]}),e.jsxs(r,{className:"p-4",children:[e.jsxs("button",{className:"w-full text-left flex items-center justify-between",onClick:()=>S(e=>!e),"aria-expanded":v,"aria-controls":"login-stamp-calendar",children:[e.jsx("span",{className:"font-semibold",children:"ログインカレンダー（+3P）"}),e.jsx("span",{className:"text-sm text-gray-500",children:v?"閉じる":"開く"})]}),v&&e.jsx("div",{id:"login-stamp-calendar",className:"mt-3",children:e.jsx(h,{rows:N,monthOffset:b,onPrevMonth:()=>w(e=>e-1),onNextMonth:()=>w(e=>e+1)})})]}),e.jsx("div",{className:"space-y-3",children:x?e.jsx(r,{className:"p-4 text-center text-gray-500",children:"読み込み中..."}):u?e.jsx(r,{className:"p-4 text-center text-red-600",children:u}):0===N.length?e.jsx(r,{className:"p-4 text-center text-gray-500",children:"履歴がありません"}):N.map(t=>{const s=t.points>0?t.points:0,a=t.points<0?Math.abs(t.points):0,n="earn"===t.entry_type;return e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-gray-900 truncate",children:t.description}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:[new Date(t.occurred_at).toLocaleDateString("ja-JP")," ",new Date(t.occurred_at).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})]})]}),e.jsxs("div",{className:"ml-4 text-right",children:[e.jsxs("div",{className:"text-lg font-bold "+(n?"text-green-600":"text-red-600"),children:[n?`+${s}`:`-${a}`,"P"]}),e.jsx("div",{className:"text-xs text-gray-400",children:n?"獲得":"使用"})]})]})},t.id)})})]})}function h({rows:t,monthOffset:s,onPrevMonth:a,onNextMonth:n}){const l=new Set(t.filter(e=>{const t=(e.source||"").toLowerCase(),s=(e.description||"").toLowerCase();return"earn"===e.entry_type&&e.points>=3&&(t.includes("login")||s.includes("login")||s.includes("ログイン"))||"earn"===e.entry_type&&t.includes("daily_login")}).map(e=>e.occurred_at.slice(0,10))),i=new Date,c=new Date(i.getFullYear(),i.getMonth()+s,1),x=c.getFullYear(),h=c.getMonth(),p=`${x}年${h+1}月`,u=new Date(x,h,1),j=new Date(x,h+1,0),g=u.getDay(),f=j.getDate(),N=(new Date).toISOString().slice(0,10),y=[];for(let e=0;e<g;e++)y.push(null);for(let e=1;e<=f;e++){const t=new Date(x,h,e).toISOString().slice(0,10);y.push({dateStr:t,inMonth:!0})}for(;y.length%7!=0;)y.push(null);return e.jsxs(r,{className:"p-4",children:[e.jsx("style",{children:"\n          @keyframes stampPop { 0% { transform: scale(0) rotate(-20deg); opacity: 0; } 60% { transform: scale(1.2) rotate(8deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }\n        "}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"font-semibold",children:"ログインカレンダー（+3P）"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{"aria-label":"前の月",onClick:a,className:"p-1 rounded hover:bg-gray-100",children:e.jsx(o,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-sm font-medium w-28 text-center",children:p}),e.jsx("button",{"aria-label":"次の月",onClick:n,className:"p-1 rounded hover:bg-gray-100",children:e.jsx(d,{className:"w-5 h-5"})})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-2 text-xs text-gray-600 mb-1",children:["日","月","火","水","木","金","土"].map(t=>e.jsx("div",{className:"text-center",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:y.map((t,s)=>{if(!t)return e.jsx("div",{className:"h-16 bg-transparent"},s);const a=l.has(t.dateStr),r=t.dateStr===N,n=Number(t.dateStr.slice(8,10));return e.jsxs("div",{className:`h-16 rounded border ${r?"border-blue-400":"border-gray-200"} relative flex items-center justify-center bg-white`,children:[e.jsx("span",{className:"absolute top-1 left-1 text-[10px] text-gray-500",children:n}),a?e.jsx(m,{className:"w-7 h-7 text-blue-600 opacity-90 "+(r?"animate-[stampPop_400ms_ease]":"")}):e.jsx(m,{className:"w-7 h-7 text-gray-200"})]},s)})})]})}export{x as default};
