import{l as t}from"./external-api-CcgPsVUa.js";import{r as e}from"./react-vendor-CMvmJHsS.js";import{s as o}from"./index-DSaj1AV3.js";function r(){const[r,s]=e.useState(!1),[a,i]=e.useState(null);return{createCheckoutSession:e.useCallback(async({priceId:e,mode:r,successUrl:a=`${window.location.origin}/payment-confirmation?success=true`,cancelUrl:n=`${window.location.origin}/payment-confirmation?canceled=true`,customAmount:c,customName:u,customParams:l,cartItems:m,trialPeriodDays:p})=>{s(!0),i(null);try{const{data:{session:s}}=await o.auth.getSession();if(!s?.access_token)throw new Error("認証が必要です");localStorage.setItem("pre_payment_auth_state",JSON.stringify({user_id:s.user.id,user_email:s.user.email,timestamp:Date.now(),return_url:window.location.href}));const i={mode:r,success_url:a,cancel_url:n};e&&(i.price_id=e),p&&"subscription"===r&&(i.trial_period_days=p),c&&u&&(i.custom_amount=c,i.custom_name=u),m&&m.length>0&&(i.cart_items=m),l&&Object.entries(l).forEach(([t,e])=>{i[t]=e});const w=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify(i)});if(!w.ok){const t=await w.json();throw new Error(t.error||"チェックアウトセッションの作成に失敗しました")}const{sessionId:d,url:h}=await w.json();if(h)return void(window.location.href=h);if(!d)throw new Error("チェックアウトURLが取得できませんでした");{const e="pk_live_51RYUXtAHWLDQ7ynZJ2Rse439JRUesTrISQjlUpQLJs4RKprLygju98sbPHbhXwSixvYxo2pyo1c5uo4j93pQieSt00z0re16rJ",o=await t(e);if(!o)throw new Error("Stripeの読み込みに失敗しました");const{error:r}=await o.redirectToCheckout({sessionId:d});if(r)throw r}}catch(w){throw i(w.message||"チェックアウトに失敗しました"),w}finally{s(!1)}},[]),loading:r,error:a}}export{r as u};
