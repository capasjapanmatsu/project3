const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug-Cag5JNnR.js","assets/index-BSYT0262.js","assets/ui-vendor-FlUr4cJt.js","assets/react-vendor-_GyjDmDn.js","assets/supabase-vendor-Df9iqQzW.js","assets/index-DfJsLctB.css","assets/directVaccineUpload-BSAWd0d0.js"])))=>i.map(i=>d[i]);
import{_ as G}from"./supabase-vendor-Df9iqQzW.js";import{j as t,V as ue,r as H,P as J}from"./ui-vendor-FlUr4cJt.js";import{r as a,L as z}from"./react-vendor-_GyjDmDn.js";import{u as fe,c as X,s as m,l as i,B as Y,C as pe}from"./index-BSYT0262.js";import{D as he,a as be}from"./DogCard-r50InAfs.js";import"./Input-wBkmcJUR.js";import"./Select-BEASmsUK.js";import"./dogBreeds-CaddeN4P.js";import"./VaccineBadge-Cj0fQWh5.js";function Ue(){const{user:x}=fe(),[C,Z]=a.useState([]),[ee,W]=a.useState(!0),[B,N]=a.useState(""),[re,E]=a.useState(!1),[o,O]=a.useState(null),[te,v]=a.useState(!1),[se,n]=a.useState(""),[R,p]=a.useState(""),[oe,k]=a.useState(!1),[w,q]=a.useState({name:"",breed:"",gender:"",birthDate:""}),[g,$]=a.useState(null),[ae,j]=a.useState(null),[S,F]=a.useState(null),[U,V]=a.useState(null),[T,L]=a.useState(""),[M,A]=a.useState("");a.useEffect(()=>{x&&I()},[x]);const I=async()=>{try{W(!0),N("");const r=await X(()=>m.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",x?.id).order("created_at",{ascending:!1}));if(r.error){i("error","Error fetching dogs",{error:r.error,userId:x?.id}),N("ワンちゃんの情報を取得できませんでした。");return}Z(r.data||[])}catch(r){i("error","Exception in fetchDogs",{error:r,userId:x?.id}),N("ワンちゃんの情報を取得できませんでした。")}finally{W(!1)}},ie=r=>{O(r),q({name:r.name,breed:r.breed,gender:r.gender,birthDate:r.birth_date}),j(r.image_url||null);const e=r.vaccine_certifications?.[0];e&&(L(e.rabies_expiry_date||""),A(e.combo_expiry_date||"")),E(!0)},ne=async r=>{const e=r.target.files?.[0];if(i("info","🔍 File selected:",e?{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified,isFileObject:e instanceof File}:{message:"No file selected"}),e)try{if(!(e instanceof File)){n("有効なファイルを選択してください。");return}if(e.size>10*1024*1024){n("画像ファイルは10MB以下にしてください。");return}if(!e.type||!e.type.startsWith("image/")){n(`画像ファイルを選択してください。選択されたファイルタイプ: ${e.type}`);return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)){n(`サポートされていない画像形式です: ${e.type}`);return}$(e),i("info","✅ Dog image file set successfully:",{name:e.name,type:e.type,size:e.size});const c=new FileReader;c.onload=l=>{j(l.target?.result)},c.readAsDataURL(e)}catch{n("画像の処理に失敗しました。")}},ce=async()=>{if(!(!o||!o.image_url))try{v(!0),n("");try{const s=new URL(o.image_url).pathname.split("/"),c=s[s.length-1],l=`${o.id}/${c}`,{error:d}=await m.storage.from("dog-images").remove([l]);d&&console.warn("Warning: Could not delete image from storage:",d)}catch(e){i("warn","Warning: Error processing image deletion",{error:e})}const r=await X(()=>m.from("dogs").update({image_url:null}).eq("id",o.id));if(r.error){i("error","Error updating dog image_url",{error:r.error,dogId:o.id}),n("画像の削除に失敗しました。");return}$(null),j(null),O({...o,image_url:void 0}),await I(),i("info","✅ Dog image removed successfully",{dogId:o.id}),p("画像を削除しました。"),setTimeout(()=>{p("")},3e3)}catch(r){i("error","Error removing dog image",{error:r,dogId:o?.id}),n("画像の削除に失敗しました。")}finally{v(!1)}},le=async r=>{const e=r.target.files?.[0];if(e){if(e.size>10*1024*1024){n("ワクチン証明書ファイルは10MB以下にしてください。");return}if(!e.type.startsWith("image/")){n("画像ファイルを選択してください。");return}F(e)}else F(null)},de=async r=>{const e=r.target.files?.[0];if(e){if(e.size>10*1024*1024){n("ワクチン証明書ファイルは10MB以下にしてください。");return}if(!e.type.startsWith("image/")){n("画像ファイルを選択してください。");return}V(e)}else V(null)},ge=async r=>{if(r.preventDefault(),!!o){v(!0),n(""),p("");try{const e={name:w.name,breed:w.breed,gender:w.gender,birth_date:w.birthDate};if(g){if(console.log("🔍 Uploading dog image:",{name:g.name,type:g.type,size:g.size,lastModified:g.lastModified,isFileObject:g instanceof File}),!g.type||!g.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${g.type}`);const c=`${o.id}/dog-photo.jpg`;console.log("📁 File path:",c),console.log("🚀 Using direct fetch API to bypass SDK...");const d=`https://onmcivwxtzqajcovptgf.supabase.co/storage/v1/object/dog-images/${c}`,{data:{session:b}}=await m.auth.getSession();if(!b?.access_token)throw new Error("認証されていません。ログインしてください。");console.log("📡 Direct upload URL:",d),console.log("🔑 Using user access token for authentication"),console.log("🔧 Using PUT method for Supabase Storage API..."),console.log("📤 Upload options:",{method:"PUT",contentType:g.type,authorization:"Bearer [token]",cacheControl:"3600"});const u=await fetch(d,{method:"PUT",headers:{Authorization:`Bearer ${b.access_token}`,"Content-Type":g.type,"Cache-Control":"3600"},body:g});if(console.log("📡 Response status:",u.status),console.log("📡 Response headers:",Object.fromEntries(u.headers.entries())),!u.ok){const f=await u.text();throw i("error","❌ Direct upload failed",{error:f}),new Error(`直接アップロードに失敗しました: ${u.status} ${f}`)}const y=await u.json();console.log("✅ Direct upload success:",y);const{data:{publicUrl:P}}=m.storage.from("dog-images").getPublicUrl(c);e.image_url=P}const{error:s}=await m.from("dogs").update(e).eq("id",o.id);if(s)throw s;if(S&&U&&T&&M){const c=S.name.split(".").pop()||"jpg",l=U.name.split(".").pop()||"jpg",d=Date.now(),b=`temp/${o.id}/rabies_${d}.${c}`,u=`temp/${o.id}/combo_${d}.${l}`;console.log("🧪 Uploading vaccine certificates with direct method...");const{debugAuthStatus:y}=await G(async()=>{const{debugAuthStatus:_}=await import("./authDebug-Cag5JNnR.js");return{debugAuthStatus:_}},__vite__mapDeps([0,1,2,3,4,5]));await y();const{directVaccineUpload:P}=await G(async()=>{const{directVaccineUpload:_}=await import("./directVaccineUpload-BSAWd0d0.js");return{directVaccineUpload:_}},__vite__mapDeps([6,1,2,3,4,5]));console.log("✅ Direct upload function imported successfully");const[f,h]=await Promise.all([P(b,S),P(u,U)]);if(console.log("📊 Upload results:",{rabiesUpload:f,comboUpload:h}),!f.success||!h.success){i("error","🚨 === VACCINE UPLOAD ERROR DETAILS ==="),f.success||i("error","❌ Rabies upload error",{error:f.error}),h.success||i("error","❌ Combo upload error",{error:h.error});const _=f.error||h.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${_}`)}console.log("✅ Vaccine certificates uploaded successfully"),console.log("📄 Rabies upload result:",f.url),console.log("📄 Combo upload result:",h.url);const K=f.url,Q=h.url;console.log("🌐 Public URLs obtained:",{rabiesPublicUrl:K,comboPublicUrl:Q}),console.log("💾 Saving vaccine certificates to database...");const{error:D}=await m.from("vaccine_certifications").upsert([{dog_id:o.id,rabies_vaccine_image:K,combo_vaccine_image:Q,rabies_expiry_date:T,combo_expiry_date:M,status:"pending"}],{onConflict:"dog_id"});if(D)throw i("error","❌ Database save error",{error:D}),D.message&&D.message.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${D.message}`);console.log("✅ Vaccine certificates saved to database successfully")}p("ワンちゃん情報を更新しました"),await I(),setTimeout(()=>{E(!1),p(""),$(null),j(null),F(null),V(null),L(""),A("")},2e3)}catch(e){i("error","Error updating dog",{error:e,dogId:o?.id});let s="ワンちゃん情報の更新に失敗しました";e instanceof Error&&(e.message.includes("520")||e.message.includes("Cloudflare")?s="ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":e.message.includes("アップロードに失敗しました")?s=e.message:s=`エラーが発生しました: ${e.message}`),n(s)}finally{v(!1)}}},me=async r=>{k(!0),n("");try{console.log("🗑️ Deleting dog:",r.name,"ID:",r.id);const{error:e}=await m.from("vaccine_certifications").delete().eq("dog_id",r.id);if(e&&i("warn","Error deleting vaccine certifications",{error:e,dogId:r.id}),r.image_url)try{const d=new URL(r.image_url).pathname.split("/"),b=d[d.length-1],u=`${r.id}/${b}`,{error:y}=await m.storage.from("dog-images").remove([u]);y&&console.warn("Warning: Could not delete dog image:",y)}catch(l){console.warn("Warning: Error processing dog image deletion:",l)}const s=r.vaccine_certifications?.[0];if(s){const l=[];if(s.rabies_vaccine_image&&l.push(s.rabies_vaccine_image),s.combo_vaccine_image&&l.push(s.combo_vaccine_image),l.length>0){const{error:d}=await m.storage.from("vaccine-certs").remove(l);d&&console.warn("Warning: Could not delete vaccine images:",d)}}const{error:c}=await m.from("dogs").delete().eq("id",r.id);if(c)throw i("error","Error deleting dog",{error:c,dogId:r.id}),c;console.log("✅ Dog deleted successfully:",r.name),await I(),E(!1),p(`${r.name}の情報を削除しました。`),setTimeout(()=>{p("")},3e3)}catch(e){i("error","Error deleting dog",{error:e,dogId:r?.id});const s=e.message||"ワンちゃんの削除に失敗しました";n(s)}finally{k(!1)}};return ee?t.jsxs("div",{className:"flex justify-center items-center h-64",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),t.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsxs(z,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[t.jsx(ue,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),t.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),t.jsx(z,{to:"/register-dog",children:t.jsxs(Y,{children:[t.jsx(H,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),B&&t.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:B}),R&&t.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:R}),t.jsxs(pe,{children:[t.jsx("div",{className:"flex justify-between items-center mb-4",children:t.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[t.jsx(J,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",C.length,"匹)"]})}),C.length===0?t.jsxs("div",{className:"text-center py-12",children:[t.jsx(J,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),t.jsx(z,{to:"/register-dog",children:t.jsxs(Y,{children:[t.jsx(H,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):t.jsx("div",{className:"space-y-4",children:C.map(r=>t.jsx(he,{dog:r,onEdit:ie},r.id))})]}),re&&o&&t.jsx(be,{dog:o,isUpdating:te||oe,error:se,success:R,dogFormData:w,dogImagePreview:ae,onClose:()=>E(!1),onSubmit:ge,onDelete:me,onFormChange:q,onImageSelect:ne,onImageRemove:ce,rabiesVaccineFile:S,comboVaccineFile:U,rabiesExpiryDate:T,comboExpiryDate:M,onRabiesVaccineSelect:le,onComboVaccineSelect:de,onRabiesExpiryDateChange:L,onComboExpiryDateChange:A})]})}export{Ue as DogManagement};
