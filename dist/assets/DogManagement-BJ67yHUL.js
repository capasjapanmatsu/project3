const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug-Cag5JNnR.js","assets/index-BSYT0262.js","assets/ui-vendor-FlUr4cJt.js","assets/react-vendor-_GyjDmDn.js","assets/supabase-vendor-Df9iqQzW.js","assets/index-DfJsLctB.css","assets/directVaccineUpload-BSAWd0d0.js"])))=>i.map(i=>d[i]);
import{_ as G}from"./supabase-vendor-Df9iqQzW.js";import{j as t,V as ue,r as H,P as J}from"./ui-vendor-FlUr4cJt.js";import{r as a,L as z}from"./react-vendor-_GyjDmDn.js";import{u as fe,c as X,s as m,l as i,B as Y,C as pe}from"./index-BSYT0262.js";import{D as he,a as be}from"./DogCard-r50InAfs.js";import"./Input-wBkmcJUR.js";import"./Select-BEASmsUK.js";import"./dogBreeds-CaddeN4P.js";import"./VaccineBadge-Cj0fQWh5.js";function Ue(){const{user:x}=fe(),[C,Z]=a.useState([]),[ee,W]=a.useState(!0),[B,N]=a.useState(""),[re,E]=a.useState(!1),[o,O]=a.useState(null),[te,v]=a.useState(!1),[se,n]=a.useState(""),[R,p]=a.useState(""),[oe,k]=a.useState(!1),[w,q]=a.useState({name:"",breed:"",gender:"",birthDate:""}),[g,$]=a.useState(null),[ae,j]=a.useState(null),[S,F]=a.useState(null),[U,V]=a.useState(null),[T,L]=a.useState(""),[M,A]=a.useState("");a.useEffect(()=>{x&&I()},[x]);const I=async()=>{try{W(!0),N("");const r=await X(()=>m.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",x?.id).order("created_at",{ascending:!1}));if(r.error){i("error","Error fetching dogs",{error:r.error,userId:x?.id}),N("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");return}Z(r.data||[])}catch(r){i("error","Exception in fetchDogs",{error:r,userId:x?.id}),N("ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")}finally{W(!1)}},ie=r=>{O(r),q({name:r.name,breed:r.breed,gender:r.gender,birthDate:r.birth_date}),j(r.image_url||null);const e=r.vaccine_certifications?.[0];e&&(L(e.rabies_expiry_date||""),A(e.combo_expiry_date||"")),E(!0)},ne=async r=>{const e=r.target.files?.[0];if(i("info","ðŸ” File selected:",e?{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified,isFileObject:e instanceof File}:{message:"No file selected"}),e)try{if(!(e instanceof File)){n("æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚");return}if(e.size>10*1024*1024){n("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");return}if(!e.type||!e.type.startsWith("image/")){n(`ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚é¸æŠžã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${e.type}`);return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)){n(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™: ${e.type}`);return}$(e),i("info","âœ… Dog image file set successfully:",{name:e.name,type:e.type,size:e.size});const c=new FileReader;c.onload=l=>{j(l.target?.result)},c.readAsDataURL(e)}catch{n("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}},ce=async()=>{if(!(!o||!o.image_url))try{v(!0),n("");try{const s=new URL(o.image_url).pathname.split("/"),c=s[s.length-1],l=`${o.id}/${c}`,{error:d}=await m.storage.from("dog-images").remove([l]);d&&console.warn("Warning: Could not delete image from storage:",d)}catch(e){i("warn","Warning: Error processing image deletion",{error:e})}const r=await X(()=>m.from("dogs").update({image_url:null}).eq("id",o.id));if(r.error){i("error","Error updating dog image_url",{error:r.error,dogId:o.id}),n("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");return}$(null),j(null),O({...o,image_url:void 0}),await I(),i("info","âœ… Dog image removed successfully",{dogId:o.id}),p("ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"),setTimeout(()=>{p("")},3e3)}catch(r){i("error","Error removing dog image",{error:r,dogId:o?.id}),n("ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{v(!1)}},le=async r=>{const e=r.target.files?.[0];if(e){if(e.size>10*1024*1024){n("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜Žæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");return}if(!e.type.startsWith("image/")){n("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚");return}F(e)}else F(null)},de=async r=>{const e=r.target.files?.[0];if(e){if(e.size>10*1024*1024){n("ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜Žæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");return}if(!e.type.startsWith("image/")){n("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚");return}V(e)}else V(null)},ge=async r=>{if(r.preventDefault(),!!o){v(!0),n(""),p("");try{const e={name:w.name,breed:w.breed,gender:w.gender,birth_date:w.birthDate};if(g){if(console.log("ðŸ” Uploading dog image:",{name:g.name,type:g.type,size:g.size,lastModified:g.lastModified,isFileObject:g instanceof File}),!g.type||!g.type.startsWith("image/"))throw new Error(`ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${g.type}`);const c=`${o.id}/dog-photo.jpg`;console.log("ðŸ“ File path:",c),console.log("ðŸš€ Using direct fetch API to bypass SDK...");const d=`https://onmcivwxtzqajcovptgf.supabase.co/storage/v1/object/dog-images/${c}`,{data:{session:b}}=await m.auth.getSession();if(!b?.access_token)throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");console.log("ðŸ“¡ Direct upload URL:",d),console.log("ðŸ”‘ Using user access token for authentication"),console.log("ðŸ”§ Using PUT method for Supabase Storage API..."),console.log("ðŸ“¤ Upload options:",{method:"PUT",contentType:g.type,authorization:"Bearer [token]",cacheControl:"3600"});const u=await fetch(d,{method:"PUT",headers:{Authorization:`Bearer ${b.access_token}`,"Content-Type":g.type,"Cache-Control":"3600"},body:g});if(console.log("ðŸ“¡ Response status:",u.status),console.log("ðŸ“¡ Response headers:",Object.fromEntries(u.headers.entries())),!u.ok){const f=await u.text();throw i("error","âŒ Direct upload failed",{error:f}),new Error(`ç›´æŽ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${u.status} ${f}`)}const y=await u.json();console.log("âœ… Direct upload success:",y);const{data:{publicUrl:P}}=m.storage.from("dog-images").getPublicUrl(c);e.image_url=P}const{error:s}=await m.from("dogs").update(e).eq("id",o.id);if(s)throw s;if(S&&U&&T&&M){const c=S.name.split(".").pop()||"jpg",l=U.name.split(".").pop()||"jpg",d=Date.now(),b=`temp/${o.id}/rabies_${d}.${c}`,u=`temp/${o.id}/combo_${d}.${l}`;console.log("ðŸ§ª Uploading vaccine certificates with direct method...");const{debugAuthStatus:y}=await G(async()=>{const{debugAuthStatus:_}=await import("./authDebug-Cag5JNnR.js");return{debugAuthStatus:_}},__vite__mapDeps([0,1,2,3,4,5]));await y();const{directVaccineUpload:P}=await G(async()=>{const{directVaccineUpload:_}=await import("./directVaccineUpload-BSAWd0d0.js");return{directVaccineUpload:_}},__vite__mapDeps([6,1,2,3,4,5]));console.log("âœ… Direct upload function imported successfully");const[f,h]=await Promise.all([P(b,S),P(u,U)]);if(console.log("ðŸ“Š Upload results:",{rabiesUpload:f,comboUpload:h}),!f.success||!h.success){i("error","ðŸš¨ === VACCINE UPLOAD ERROR DETAILS ==="),f.success||i("error","âŒ Rabies upload error",{error:f.error}),h.success||i("error","âŒ Combo upload error",{error:h.error});const _=f.error||h.error||"ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜Žæ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";throw new Error(`ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜Žæ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${_}`)}console.log("âœ… Vaccine certificates uploaded successfully"),console.log("ðŸ“„ Rabies upload result:",f.url),console.log("ðŸ“„ Combo upload result:",h.url);const K=f.url,Q=h.url;console.log("ðŸŒ Public URLs obtained:",{rabiesPublicUrl:K,comboPublicUrl:Q}),console.log("ðŸ’¾ Saving vaccine certificates to database...");const{error:D}=await m.from("vaccine_certifications").upsert([{dog_id:o.id,rabies_vaccine_image:K,combo_vaccine_image:Q,rabies_expiry_date:T,combo_expiry_date:M,status:"pending"}],{onConflict:"dog_id"});if(D)throw i("error","âŒ Database save error",{error:D}),D.message&&D.message.includes("520")?new Error("ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"):new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${D.message}`);console.log("âœ… Vaccine certificates saved to database successfully")}p("ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await I(),setTimeout(()=>{E(!1),p(""),$(null),j(null),F(null),V(null),L(""),A("")},2e3)}catch(e){i("error","Error updating dog",{error:e,dogId:o?.id});let s="ãƒ¯ãƒ³ã¡ã‚ƒã‚“æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";e instanceof Error&&(e.message.includes("520")||e.message.includes("Cloudflare")?s="ãƒ¯ã‚¯ãƒãƒ³è¨¼æ˜Žæ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ä¸€æ™‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚":e.message.includes("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")?s=e.message:s=`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`),n(s)}finally{v(!1)}}},me=async r=>{k(!0),n("");try{console.log("ðŸ—‘ï¸ Deleting dog:",r.name,"ID:",r.id);const{error:e}=await m.from("vaccine_certifications").delete().eq("dog_id",r.id);if(e&&i("warn","Error deleting vaccine certifications",{error:e,dogId:r.id}),r.image_url)try{const d=new URL(r.image_url).pathname.split("/"),b=d[d.length-1],u=`${r.id}/${b}`,{error:y}=await m.storage.from("dog-images").remove([u]);y&&console.warn("Warning: Could not delete dog image:",y)}catch(l){console.warn("Warning: Error processing dog image deletion:",l)}const s=r.vaccine_certifications?.[0];if(s){const l=[];if(s.rabies_vaccine_image&&l.push(s.rabies_vaccine_image),s.combo_vaccine_image&&l.push(s.combo_vaccine_image),l.length>0){const{error:d}=await m.storage.from("vaccine-certs").remove(l);d&&console.warn("Warning: Could not delete vaccine images:",d)}}const{error:c}=await m.from("dogs").delete().eq("id",r.id);if(c)throw i("error","Error deleting dog",{error:c,dogId:r.id}),c;console.log("âœ… Dog deleted successfully:",r.name),await I(),E(!1),p(`${r.name}ã®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`),setTimeout(()=>{p("")},3e3)}catch(e){i("error","Error deleting dog",{error:e,dogId:r?.id});const s=e.message||"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ";n(s)}finally{k(!1)}};return ee?t.jsxs("div",{className:"flex justify-center items-center h-64",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),t.jsx("p",{className:"ml-3 text-gray-600",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­..."})]}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsxs(z,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[t.jsx(ue,{className:"w-4 h-4 mr-1"}),"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ç®¡ç†"}),t.jsx("p",{className:"text-gray-600",children:"ç™»éŒ²æ¸ˆã¿ã®ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™"})]}),t.jsx(z,{to:"/register-dog",children:t.jsxs(Y,{children:[t.jsx(H,{className:"w-4 h-4 mr-2"}),"æ–°ã—ã„ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²"]})})]}),B&&t.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:B}),R&&t.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:R}),t.jsxs(pe,{children:[t.jsx("div",{className:"flex justify-between items-center mb-4",children:t.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[t.jsx(J,{className:"w-6 h-6 text-blue-600 mr-2"}),"ç™»éŒ²æ¸ˆã¿ãƒ¯ãƒ³ã¡ã‚ƒã‚“ (",C.length,"åŒ¹)"]})}),C.length===0?t.jsxs("div",{className:"text-center py-12",children:[t.jsx(J,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 mb-4",children:"ã¾ã ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),t.jsx(z,{to:"/register-dog",children:t.jsxs(Y,{children:[t.jsx(H,{className:"w-4 h-4 mr-2"}),"ãƒ¯ãƒ³ã¡ã‚ƒã‚“ã‚’ç™»éŒ²ã™ã‚‹"]})})]}):t.jsx("div",{className:"space-y-4",children:C.map(r=>t.jsx(he,{dog:r,onEdit:ie},r.id))})]}),re&&o&&t.jsx(be,{dog:o,isUpdating:te||oe,error:se,success:R,dogFormData:w,dogImagePreview:ae,onClose:()=>E(!1),onSubmit:ge,onDelete:me,onFormChange:q,onImageSelect:ne,onImageRemove:ce,rabiesVaccineFile:S,comboVaccineFile:U,rabiesExpiryDate:T,comboExpiryDate:M,onRabiesVaccineSelect:le,onComboVaccineSelect:de,onRabiesExpiryDateChange:L,onComboExpiryDateChange:A})]})}export{Ue as DogManagement};
