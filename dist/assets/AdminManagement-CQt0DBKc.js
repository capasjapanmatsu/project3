import{s as e,j as s,B as a,C as r,g as t,u as i}from"./index-CG6tuKmC.js";import{r as l,u as c,L as n}from"./vendor-BHVjIt_u.js";import{au as d,I as o,R as m,av as x,X as g,s as h,aw as p,o as u,i as j,p as b,b as N,a as y,A as f}from"./ui-BlUB7fmN.js";import"./supabase-CKbzEL5D.js";const v=async s=>{try{const{data:{user:s},error:a}=await e.auth.getUser();if(a)return{success:!1,error:a.message};if(!s)return{success:!1,error:"No user found"};const{data:r,error:t}=await e.from("profiles").select("*").eq("id",s.id).maybeSingle();if(t)return{success:!1,error:t.message};if(!r){const a={id:s.id,name:s.email?.split("@")[0]||"Unknown",user_type:"capasjapan@gmail.com"===s.email?"admin":"user",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{error:r}=await e.from("profiles").insert([a]);return r?{success:!1,error:r.message}:{success:!0,message:"Profile created successfully"}}if("capasjapan@gmail.com"===s.email&&"admin"!==r.user_type){const{error:a}=await e.from("profiles").update({user_type:"admin",updated_at:(new Date).toISOString()}).eq("id",s.id);return a?{success:!1,error:a.message}:{success:!0,message:"User type updated to admin"}}return{success:!0,message:"Profile already exists and is correct"}}catch(a){return{success:!1,error:a.message}}},w=s=>{const[a,r]=l.useState([]),[t,i]=l.useState([]),[c,n]=l.useState(!0),[d,o]=l.useState(""),[m,x]=l.useState("");return{pendingParks:a,pendingVaccines:t,isLoading:c,error:d,success:m,fetchData:async()=>{try{n(!0),o(""),x(""),await(async()=>{try{const{error:s}=await e.storage.updateBucket("vaccine-certs",{public:!0});return!s}catch(d){return!1}})(),"parks"===s?await(async()=>{try{const{data:s,error:a}=await e.from("dog_parks").select("\n          id,\n          name,\n          address,\n          status,\n          created_at,\n          owner_id\n        ").in("status",["first_stage_passed","second_stage_review"]).order("created_at",{ascending:!1});if(a)throw a;if(!s||0===s.length)return void r([]);const t=[...new Set(s.map((e=>e.owner_id)))],i=s.map((e=>e.id)),[l,c,n]=await Promise.allSettled([t.length>0?e.from("profiles").select("id, name").in("id",t):Promise.resolve({data:[],error:null}),i.length>0?e.from("dog_park_review_stages").select("park_id, second_stage_submitted_at").in("park_id",i):Promise.resolve({data:[],error:null}),i.length>0?e.from("dog_park_facility_images").select("park_id, is_approved").in("park_id",i):Promise.resolve({data:[],error:null})]),d="fulfilled"!==l.status||l.value.error?[]:l.value.data||[],o="fulfilled"!==c.status||c.value.error?[]:c.value.data||[],m="fulfilled"!==n.status||n.value.error?[]:n.value.data||[];"rejected"===l.status||"fulfilled"===l.status&&l.value.error,"rejected"===c.status||"fulfilled"===c.status&&c.value.error,"rejected"===n.status||"fulfilled"===n.status&&n.value.error;const x=(s?.map((e=>{const s=o.find((s=>s.park_id===e.id)),a=m.filter((s=>s.park_id===e.id));return{...e,owner_name:d.find((s=>s.id===e.owner_id))?.name||"Unknown",second_stage_submitted_at:s?.second_stage_submitted_at||null,total_images:a.length,pending_images:a.filter((e=>null===e.is_approved)).length,approved_images:a.filter((e=>!0===e.is_approved)).length,rejected_images:a.filter((e=>!1===e.is_approved)).length}}))||[]).filter((e=>"second_stage_review"===e.status||"first_stage_passed"===e.status&&null!==e.second_stage_submitted_at));r(x)}catch(s){throw s}})():await(async()=>{try{const{data:s,error:a}=await e.from("vaccine_certifications").select("\n          *,\n          dog:dogs(*, owner:profiles(*))\n        ").eq("status","pending").order("created_at",{ascending:!1});if(a)throw a;i(s||[])}catch(s){throw s}})()}catch(a){o(a.message||"エラーが発生しました")}finally{n(!1)}},clearMessages:()=>{o(""),x("")},showSuccess:e=>{x(e),setTimeout((()=>x("")),3e3)},showError:e=>{o(e)},setPendingParks:r,setPendingVaccines:i}},_=()=>{const[s,a]=l.useState(!1),r=async s=>{const a=[];if(s.rabies_vaccine_image){let e="";if(s.rabies_vaccine_image.includes("/temp/")){const a=s.rabies_vaccine_image.match(/temp\/[^\/]+\/[^\/\?]+/);a&&(e=a[0])}e&&a.push(e)}if(s.combo_vaccine_image){let e="";if(s.combo_vaccine_image.includes("/temp/")){const a=s.combo_vaccine_image.match(/temp\/[^\/]+\/[^\/\?]+/);a&&(e=a[0])}e&&a.push(e)}if(a.length>0)try{const{error:s}=await e.storage.from("vaccine-certs").remove(a)}catch(r){}},t=async(s,a,r)=>{const{error:t}=await e.from("notifications").insert([{user_id:s.dog.owner_id,type:"vaccine_approval_required",title:a?"ワクチン証明書承認のお知らせ":"ワクチン証明書却下のお知らせ",message:a?`${s.dog.name}ちゃんのワクチン証明書が承認されました。ドッグランを利用できるようになりました。`:`${s.dog.name}ちゃんのワクチン証明書が却下されました。${r?`理由: ${r}`:"詳細はマイページをご確認ください。"}`,data:{dog_id:s.dog_id}}]);if(t)throw new Error(`通知の作成に失敗しました: ${t.message}`)},i=async(s,a,r)=>{let t={};const{data:i,error:l}=await e.from("dog_park_review_stages").select("id").eq("park_id",s).maybeSingle();if(l)throw l;if(i){a?t.first_stage_passed_at=(new Date).toISOString():(t.rejected_at=(new Date).toISOString(),r?.trim()&&(t.rejection_reason=r.trim()));const{error:i}=await e.from("dog_park_review_stages").update(t).eq("park_id",s);if(i)throw i}else{t={park_id:s,first_stage_passed_at:(new Date).toISOString()},a?t.first_stage_passed_at=(new Date).toISOString():(t.rejected_at=(new Date).toISOString(),r?.trim()&&(t.rejection_reason=r.trim()));const{error:i}=await e.from("dog_park_review_stages").insert([t]);if(i)throw i}},c=async(s,a,r)=>{const{data:t,error:i}=await e.from("dog_parks").select("id, name, owner_id").eq("id",s).single();if(i)throw i;const{error:l}=await e.from("notifications").insert([{user_id:t.owner_id,type:"park_approval_required",title:a?"施設承認のお知らせ":"審査結果のお知らせ",message:a?`${t.name}の審査が完了し、承認されました。おめでとうございます！`:`${t.name}の審査結果をお知らせします。${r?`理由: ${r}`:"詳細はオーナーダッシュボードをご確認ください。"}`,data:{park_id:t.id}}]);if(l)throw new Error(`施設通知の作成に失敗しました: ${l.message}`)};return{isProcessing:s,handleVaccineApproval:async(s,i,l)=>{try{a(!0);const{data:c,error:n}=await e.from("vaccine_certifications").select("*, dog:dogs(name, owner_id)").eq("id",s).single();if(n)throw n;const d=c,o={status:i?"approved":"rejected"};i&&(o.approved_at=(new Date).toISOString());const{error:m}=await e.from("vaccine_certifications").update(o).eq("id",s);if(m)throw new Error(`ワクチン証明書の更新に失敗しました: ${m.message}`);const x=d.rabies_vaccine_image,g=d.combo_vaccine_image;return(x?.includes("/temp/")||g?.includes("/temp/"))&&await r(d),await t(d,i,l),{success:!0,message:`ワクチン証明書を${i?"承認":"却下"}しました`}}catch(c){return{success:!1,message:`承認処理に失敗しました: ${c.message}`}}finally{a(!1)}},handleParkApproval:async(s,r,t)=>{try{a(!0);const l={status:r?"approved":"rejected"};r&&(l.approved_at=(new Date).toISOString());const{error:n}=await e.from("dog_parks").update(l).eq("id",s);if(n)throw n;return await i(s,r,t),await c(s,r,t),{success:!0,message:`施設を${r?"承認":"却下"}しました`}}catch(l){return{success:!1,message:"承認処理に失敗しました"}}finally{a(!1)}},handleImageApproval:async(s,r,t)=>{try{a(!0);const i={is_approved:r};!r&&t?.trim()?i.admin_notes=t.trim():i.admin_notes=null;const{error:l}=await e.from("dog_park_facility_images").update(i).eq("id",s.id);if(l)throw l;return{success:!0,message:`画像を${r?"承認":"却下"}しました`}}catch(i){return{success:!1,message:"画像の承認処理に失敗しました"}}finally{a(!1)}},handleVaccineExpiryUpdate:async(s,r,t)=>{try{a(!0);const i={};void 0!==r&&(i.rabies_expiry_date=r),void 0!==t&&(i.combo_expiry_date=t);const{error:l}=await e.from("vaccine_certifications").update(i).eq("id",s);if(l)throw new Error(`有効期限の更新に失敗しました: ${l.message}`);return{success:!0,message:"有効期限を更新しました"}}catch(i){return{success:!1,message:`有効期限の更新に失敗しました: ${i.message}`}}finally{a(!1)}}}},I=({pendingVaccines:e,isLoading:i,onApprovalComplete:c,onError:n})=>{const[j,b]=l.useState(null),[N,y]=l.useState(""),[f,v]=l.useState({}),[w,I]=l.useState({}),[k,S]=l.useState(null),[C,D]=l.useState(1),[P,Z]=l.useState(!1),[B,O]=l.useState({rabies_expiry_date:"",combo_expiry_date:""}),M=_(),z=async(e,s)=>{try{const a=await M.handleVaccineApproval(e,s,N);a.success?(c(a.message),b(null),y("")):n(a.message)}catch(a){n(`処理中にエラーが発生しました: ${a.message}`)}},A=e=>{v((s=>({...s,[e]:!1})))},W=e=>{v((s=>({...s,[e]:!1}))),I((s=>({...s,[e]:!0})))},L=e=>{v((s=>({...s,[e]:!0}))),I((s=>({...s,[e]:!1})))},G=(e,s,a)=>{S({src:e,alt:s,type:a}),D(1)},$=()=>{S(null),D(1)},H=()=>{D((e=>Math.min(e+.5,3)))},V=()=>{D((e=>Math.max(e-.5,.5)))},E=e=>{O({rabies_expiry_date:e.rabies_expiry_date||"",combo_expiry_date:e.combo_expiry_date||""})},R=e=>{if(!e)return"未設定";try{return new Date(e).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})}catch{return"無効な日付"}},T=e=>{if(!e)return!1;return new Date(e)<=new Date((new Date).getTime()+2592e6)},J=e=>{if(!e)return!1;return new Date(e)<new Date};return i?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):j?(""===B.rabies_expiry_date&&""===B.combo_expiry_date&&E(j),s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(d,{className:"w-6 h-6 text-blue-600 mr-2"}),j.dog.name,"のワクチン証明書審査"]}),s.jsxs(a,{variant:"secondary",onClick:()=>{b(null),Z(!1),O({rabies_expiry_date:"",combo_expiry_date:""})},children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),"一覧に戻る"]})]}),s.jsxs(r,{className:"p-4",children:[s.jsx("h3",{className:"font-semibold mb-3",children:"犬の基本情報"}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"名前"}),s.jsx("p",{className:"font-medium",children:j.dog.name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"犬種"}),s.jsx("p",{className:"font-medium",children:j.dog.breed})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"性別"}),s.jsx("p",{className:"font-medium",children:j.dog.gender})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"飼い主"}),s.jsx("p",{className:"font-medium",children:j.dog.owner.name})]})]})]}),s.jsxs(r,{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-semibold",children:"ワクチン有効期限"}),s.jsx(a,{size:"sm",variant:"secondary",onClick:()=>Z(!P),children:P?"キャンセル":"編集"})]}),P?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"狂犬病ワクチン有効期限"}),s.jsx("input",{type:"date",value:B.rabies_expiry_date,onChange:e=>O((s=>({...s,rabies_expiry_date:e.target.value}))),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"混合ワクチン有効期限"}),s.jsx("input",{type:"date",value:B.combo_expiry_date,onChange:e=>O((s=>({...s,combo_expiry_date:e.target.value}))),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),s.jsxs("div",{className:"flex justify-end space-x-2",children:[s.jsx(a,{variant:"secondary",onClick:()=>{Z(!1),E(j)},children:"キャンセル"}),s.jsx(a,{onClick:()=>{(async()=>{if(j)try{const e=await M.handleVaccineExpiryUpdate(j.id,B.rabies_expiry_date||null,B.combo_expiry_date||null);e.success?(c(e.message),Z(!1),j&&(j.rabies_expiry_date=B.rabies_expiry_date||null,j.combo_expiry_date=B.combo_expiry_date||null)):n(e.message)}catch(e){n(`有効期限の更新に失敗しました: ${e.message}`)}})()},isLoading:M.isProcessing,className:"bg-blue-600 hover:bg-blue-700",children:"保存"})]})]}):s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"狂犬病ワクチン有効期限"}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("p",{className:"font-medium "+(J(j.rabies_expiry_date)?"text-red-600":T(j.rabies_expiry_date)?"text-yellow-600":"text-green-600"),children:R(j.rabies_expiry_date)}),J(j.rabies_expiry_date)&&s.jsx("span",{className:"px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full",children:"期限切れ"}),T(j.rabies_expiry_date)&&!J(j.rabies_expiry_date)&&s.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full",children:"期限間近"})]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"混合ワクチン有効期限"}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("p",{className:"font-medium "+(J(j.combo_expiry_date)?"text-red-600":T(j.combo_expiry_date)?"text-yellow-600":"text-green-600"),children:R(j.combo_expiry_date)}),J(j.combo_expiry_date)&&s.jsx("span",{className:"px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full",children:"期限切れ"}),T(j.combo_expiry_date)&&!J(j.combo_expiry_date)&&s.jsx("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full",children:"期限間近"})]})]})]})]}),s.jsxs(r,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"ワクチン証明書"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"狂犬病ワクチン"}),j.rabies_vaccine_image?s.jsxs("div",{className:"border rounded-lg overflow-hidden relative",children:[f[`rabies-${j.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 z-10",children:s.jsx(m,{className:"w-6 h-6 animate-spin text-gray-600"})}),s.jsx("img",{src:t(j.rabies_vaccine_image)||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4=",alt:"狂犬病ワクチン証明書",className:"w-full h-64 object-contain cursor-pointer hover:opacity-80 transition-opacity",onLoadStart:()=>L(`rabies-${j.id}`),onLoad:()=>A(`rabies-${j.id}`),onError:()=>W(`rabies-${j.id}`),onClick:()=>G(t(j.rabies_vaccine_image)||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4=","狂犬病ワクチン証明書","rabies")}),s.jsx("div",{className:"absolute top-2 left-2 bg-white bg-opacity-90 text-gray-800 p-1 rounded border shadow-sm",children:s.jsx(x,{className:"w-4 h-4"})}),w[`rabies-${j.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-50 bg-opacity-90",children:s.jsxs("div",{className:"text-center",children:[s.jsx(g,{className:"w-12 h-12 text-red-500 mx-auto mb-2"}),s.jsx("p",{className:"text-red-700 font-medium",children:"画像が読み込めませんでした"})]})})]}):s.jsx("div",{className:"h-64 bg-gray-100 rounded-lg flex items-center justify-center",children:s.jsx("p",{className:"text-gray-500",children:"画像なし"})})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"混合ワクチン"}),j.combo_vaccine_image?s.jsxs("div",{className:"border rounded-lg overflow-hidden relative",children:[f[`combo-${j.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 z-10",children:s.jsx(m,{className:"w-6 h-6 animate-spin text-gray-600"})}),s.jsx("img",{src:t(j.combo_vaccine_image)||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4=",alt:"混合ワクチン証明書",className:"w-full h-64 object-contain cursor-pointer hover:opacity-80 transition-opacity",onLoadStart:()=>L(`combo-${j.id}`),onLoad:()=>A(`combo-${j.id}`),onError:()=>W(`combo-${j.id}`),onClick:()=>G(t(j.combo_vaccine_image)||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4=","混合ワクチン証明書","combo")}),s.jsx("div",{className:"absolute top-2 left-2 bg-white bg-opacity-90 text-gray-800 p-1 rounded border shadow-sm",children:s.jsx(x,{className:"w-4 h-4"})}),w[`combo-${j.id}`]&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-50 bg-opacity-90",children:s.jsxs("div",{className:"text-center",children:[s.jsx(g,{className:"w-12 h-12 text-red-500 mx-auto mb-2"}),s.jsx("p",{className:"text-red-700 font-medium",children:"画像が読み込めませんでした"})]})})]}):s.jsx("div",{className:"h-64 bg-gray-100 rounded-lg flex items-center justify-center",children:s.jsx("p",{className:"text-gray-500",children:"画像なし"})})]})]})]}),s.jsxs(r,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"審査結果"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"却下理由（却下する場合のみ入力）"}),s.jsx("textarea",{value:N,onChange:e=>y(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:"例: ワクチン証明書の有効期限が切れています。最新の証明書をアップロードしてください。"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsxs(a,{onClick:()=>{z(j.id,!1)},isLoading:M.isProcessing,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"却下"]}),s.jsxs(a,{onClick:()=>{z(j.id,!0)},isLoading:M.isProcessing,className:"bg-green-600 hover:bg-green-700",children:[s.jsx(h,{className:"w-4 h-4 mr-2"}),"承認"]})]})]}),k&&s.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4",children:[s.jsxs("div",{className:"relative max-w-full max-h-full",children:[s.jsxs("div",{className:"absolute top-4 right-4 flex items-center space-x-2 z-10",children:[s.jsx("div",{className:"bg-white bg-opacity-90 text-gray-800 px-3 py-1 rounded border shadow-sm text-sm",children:"rabies"===k.type?"狂犬病ワクチン":"混合ワクチン"}),s.jsx(a,{size:"sm",onClick:V,className:"bg-white bg-opacity-90 shadow-lg text-gray-800 hover:bg-opacity-100 border border-gray-300",children:s.jsx(p,{className:"w-4 h-4"})}),s.jsx(a,{size:"sm",onClick:H,className:"bg-white bg-opacity-90 shadow-lg text-gray-800 hover:bg-opacity-100 border border-gray-300",children:s.jsx(x,{className:"w-4 h-4"})}),s.jsx(a,{size:"sm",onClick:$,className:"bg-white bg-opacity-90 shadow-lg text-gray-800 hover:bg-opacity-100 border border-gray-300",children:s.jsx(g,{className:"w-4 h-4"})})]}),s.jsx("div",{className:"overflow-auto max-h-screen",children:s.jsx("img",{src:k.src,alt:k.alt,className:"max-w-none transition-transform duration-200",style:{transform:`scale(${C})`,transformOrigin:"center center"},onError:e=>{e.currentTarget.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4="}})}),s.jsxs("div",{className:"absolute bottom-4 left-4 bg-white bg-opacity-90 text-gray-800 px-3 py-2 rounded border shadow-sm text-sm",children:[s.jsx("p",{children:"拡大/縮小: ズームボタンを使用"}),s.jsx("p",{children:"閉じる: Xボタンまたは画像外をクリック"})]})]}),s.jsx("div",{className:"absolute inset-0 -z-10",onClick:$})]})]})):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(d,{className:"w-6 h-6 text-blue-600 mr-2"}),"審査待ちワクチン証明書"]}),0===e.length?s.jsxs(r,{className:"text-center py-12",children:[s.jsx(h,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"審査待ちのワクチン証明書はありません"})]}):s.jsx("div",{className:"space-y-4",children:e.map((e=>s.jsx(r,{className:"p-6 hover:shadow-lg transition-shadow",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-2",children:[e.dog.name,"のワクチン証明書"]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"犬種"}),s.jsx("p",{className:"font-medium",children:e.dog.breed})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"性別"}),s.jsx("p",{className:"font-medium",children:e.dog.gender})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"飼い主"}),s.jsx("p",{className:"font-medium",children:e.dog.owner.name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"申請日"}),s.jsx("p",{className:"font-medium",children:new Date(e.created_at).toLocaleDateString("ja-JP")})]})]})]}),s.jsxs("div",{className:"flex space-x-2 ml-4",children:[s.jsxs(a,{size:"sm",variant:"secondary",onClick:()=>b(e),children:[s.jsx(u,{className:"w-4 h-4 mr-1"}),"詳細"]}),s.jsxs(a,{size:"sm",onClick:()=>{z(e.id,!0)},className:"bg-green-600 hover:bg-green-700",disabled:M.isProcessing,children:[s.jsx(h,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsxs(a,{size:"sm",onClick:()=>{b(e),z(e.id,!1)},className:"bg-red-600 hover:bg-red-700",disabled:M.isProcessing,children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]}),k&&s.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4",children:[s.jsxs("div",{className:"relative max-w-full max-h-full",children:[s.jsxs("div",{className:"absolute top-4 right-4 flex items-center space-x-2 z-10",children:[s.jsx("div",{className:"bg-white bg-opacity-90 text-gray-800 px-3 py-1 rounded border shadow-sm text-sm",children:"rabies"===k.type?"狂犬病ワクチン":"混合ワクチン"}),s.jsx(a,{size:"sm",onClick:V,className:"bg-white bg-opacity-90 shadow-lg text-gray-800 hover:bg-opacity-100 border border-gray-300",children:s.jsx(p,{className:"w-4 h-4"})}),s.jsx(a,{size:"sm",onClick:H,className:"bg-white bg-opacity-90 shadow-lg text-gray-800 hover:bg-opacity-100 border border-gray-300",children:s.jsx(x,{className:"w-4 h-4"})}),s.jsx(a,{size:"sm",onClick:$,className:"bg-white bg-opacity-90 shadow-lg text-gray-800 hover:bg-opacity-100 border border-gray-300",children:s.jsx(g,{className:"w-4 h-4"})})]}),s.jsx("div",{className:"overflow-auto max-h-screen",children:s.jsx("img",{src:k.src,alt:k.alt,className:"max-w-none transition-transform duration-200",style:{transform:`scale(${C})`,transformOrigin:"center center"},onError:e=>{e.currentTarget.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzM3NDE1MSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPueUu+WDj+OBjOiqreOCgeWFpeOBv+OBvuOBm+OCk+OBp+OBl+OBnw==</dGV4dD48L3N2Zz4="}})}),s.jsxs("div",{className:"absolute bottom-4 left-4 bg-white bg-opacity-90 text-gray-800 px-3 py-2 rounded border shadow-sm text-sm",children:[s.jsx("p",{children:"拡大/縮小: ズームボタンを使用"}),s.jsx("p",{children:"閉じる: Xボタンまたは画像外をクリック"})]})]}),s.jsx("div",{className:"absolute inset-0 -z-10",onClick:$})]})]})},k=({pendingParks:t,isLoading:i,onApprovalComplete:c,onError:n})=>{const[d,m]=l.useState(null),[p,y]=l.useState(""),[f,v]=l.useState(null),[w,I]=l.useState(!1),[k,S]=l.useState(null),C=_(),D=(s=>{const[a,r]=l.useState([]),[t,i]=l.useState(!1),[c,n]=l.useState(!1),[d,o]=l.useState(""),m=async s=>{try{n(!0),o("");const{data:a,error:t}=await e.from("dog_park_facility_images").select("*").eq("park_id",s).order("created_at",{ascending:!1});if(t)throw t;const l=a?.map((e=>{let s=e.image_url;return s?(s.startsWith("http")||(s=`/storage/v1/object/public/dog-park-images/${s}`),{...e,image_url:s}):{...e,image_url:"https://via.placeholder.com/400x300?text=No+Image+URL"}}))||[];r(l);const c=l.length>0&&l.every((e=>!0===e.is_approved));i(c)}catch(a){o(a.message||"施設画像の取得に失敗しました")}finally{n(!1)}};return l.useEffect((()=>{s?m(s):(r([]),i(!1))}),[s]),{parkImages:a,allImagesApproved:t,isLoading:c,error:d,fetchParkImages:m,setParkImages:r}})(d?.id||null),P=async(e,s)=>{try{if(s){if(D.parkImages.filter((e=>null===e.is_approved||!1===e.is_approved)).length>0)return void n("すべての画像を承認してから施設を承認してください")}const a=await C.handleParkApproval(e,s,p);a.success?(c(a.message),m(null),y("")):n(a.message)}catch(a){n(`処理中にエラーが発生しました: ${a.message}`)}},Z=async e=>{if(f)try{const s=await C.handleImageApproval(f,e,p);s.success?(c(s.message),await D.fetchParkImages(d.id),I(!1),v(null),y("")):n(s.message)}catch(s){n(`処理中にエラーが発生しました: ${s.message}`)}},B=e=>({overview:"施設全景",entrance:"入口",large_dog_area:"大型犬エリア",small_dog_area:"小型犬エリア",private_booth:"プライベートブース",parking:"駐車場",shower:"シャワー設備",restroom:"トイレ",agility:"アジリティ設備",rest_area:"休憩スペース",water_station:"給水設備",exterior:"外観",interior:"内装",equipment:"設備",area:"エリア",other:"その他"}[e]||e);return i?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):k?s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50",children:s.jsxs("div",{className:"relative max-w-6xl w-full max-h-[90vh]",children:[s.jsx("button",{onClick:()=>S(null),className:"absolute top-4 right-4 p-2 bg-white bg-opacity-90 shadow-lg rounded-full text-gray-800 hover:bg-opacity-100 transition-all z-10",children:s.jsx(g,{className:"w-6 h-6"})}),s.jsx("img",{src:k,alt:"拡大画像",className:"max-w-full max-h-full mx-auto rounded-lg object-contain",onError:e=>{e.currentTarget.src="https://via.placeholder.com/800x600?text=Image+Not+Available"}})]})}):w&&f?s.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs("button",{onClick:()=>{I(!1),v(null),y("")},className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),"画像一覧に戻る"]})}),s.jsxs(r,{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsxs("h2",{className:"text-xl font-bold",children:["画像レビュー: ",B(f.image_type)]}),s.jsx("div",{className:"flex space-x-2",children:s.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+(!0===f.is_approved?"bg-green-100 text-green-800":!1===f.is_approved?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:!0===f.is_approved?"承認済み":!1===f.is_approved?"却下":"審査待ち"})})]}),s.jsx("div",{className:"mb-6",children:s.jsxs("div",{className:"w-full h-96 bg-gray-100 rounded-lg overflow-hidden relative group",children:[s.jsx("img",{src:f.image_url,alt:B(f.image_type),className:"w-full h-full object-contain cursor-pointer",onClick:()=>S(f.image_url),onError:e=>{e.currentTarget.src="https://via.placeholder.com/800x600?text=Image+Not+Available"}}),s.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center cursor-pointer",onClick:()=>S(f.image_url),children:s.jsx(x,{className:"w-12 h-12 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-200"})}),s.jsx("div",{className:"absolute bottom-4 right-4",children:s.jsx("span",{className:"px-2 py-1 bg-white bg-opacity-90 text-gray-800 text-xs rounded border shadow-sm",children:"クリックで拡大"})})]})}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"却下理由（却下する場合のみ入力）"}),s.jsx("textarea",{value:p,onChange:e=>y(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:"例: 画像が不鮮明です。より明るく鮮明な画像を再アップロードしてください。"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsx(a,{variant:"secondary",onClick:()=>{I(!1),v(null),y("")},children:"キャンセル"}),s.jsxs(a,{onClick:()=>{Z(!1)},isLoading:C.isProcessing,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"却下"]}),s.jsxs(a,{onClick:()=>{Z(!0)},isLoading:C.isProcessing,className:"bg-green-600 hover:bg-green-700",children:[s.jsx(h,{className:"w-4 h-4 mr-2"}),"承認"]})]})]})]}):d?s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(j,{className:"w-6 h-6 text-blue-600 mr-2"}),d.name,"の審査"]}),s.jsxs(a,{variant:"secondary",onClick:()=>m(null),children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),"一覧に戻る"]})]}),s.jsxs(r,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"施設情報"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"施設名"}),s.jsx("p",{className:"font-medium",children:d.name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"住所"}),s.jsx("p",{className:"font-medium",children:d.address})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"オーナー"}),s.jsx("p",{className:"font-medium",children:d.owner_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"申請日"}),s.jsx("p",{className:"font-medium",children:new Date(d.created_at).toLocaleDateString("ja-JP")})]})]})]}),("second_stage_review"===d.status||"first_stage_passed"===d.status||d.total_images>0)&&s.jsxs(r,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"施設画像"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[s.jsxs("div",{className:"bg-blue-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-blue-800",children:"全画像"}),s.jsxs("p",{className:"text-blue-600",children:[d.total_images,"枚"]})]}),s.jsxs("div",{className:"bg-yellow-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-yellow-800",children:"審査待ち"}),s.jsxs("p",{className:"text-yellow-600",children:[d.pending_images,"枚"]})]}),s.jsxs("div",{className:"bg-green-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-green-800",children:"承認済み"}),s.jsxs("p",{className:"text-green-600",children:[d.approved_images,"枚"]})]}),s.jsxs("div",{className:"bg-red-50 p-3 rounded text-center",children:[s.jsx("p",{className:"font-medium text-red-800",children:"却下"}),s.jsxs("p",{className:"text-red-600",children:[d.rejected_images,"枚"]})]})]}),s.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded text-sm",children:[s.jsx("p",{children:s.jsx("strong",{children:"デバッグ情報:"})}),s.jsxs("p",{children:["Park ID: ",d.id]}),s.jsxs("p",{children:["Status: ",d.status]}),s.jsxs("p",{children:["Images Loading: ",D.isLoading?"Yes":"No"]}),s.jsxs("p",{children:["Images Count: ",D.parkImages.length]}),s.jsxs("p",{children:["Images Error: ",D.error||"None"]}),s.jsxs("p",{children:["Expected Total: ",d.total_images]}),s.jsxs("div",{className:"mt-2 flex space-x-2",children:[s.jsx(a,{size:"sm",variant:"secondary",onClick:()=>{D.fetchParkImages(d.id)},children:"画像再取得"}),s.jsx(a,{size:"sm",variant:"secondary",onClick:async()=>{try{const{data:s,error:a}=await e.from("dog_park_facility_images").select("*").eq("park_id",d.id);a||alert("データベース直接クエリ結果をコンソールに出力しました")}catch(s){}},children:"DB直接確認"})]}),s.jsxs("div",{className:"mt-2",children:[s.jsx("p",{children:s.jsx("strong",{children:"Raw Images Data:"})}),s.jsx("pre",{className:"text-xs bg-white p-2 rounded border max-h-32 overflow-y-auto",children:JSON.stringify(D.parkImages,null,2)})]})]}),D.isLoading?s.jsxs("div",{className:"flex justify-center items-center h-32",children:[s.jsx(b,{className:"w-8 h-8 animate-spin text-blue-600"}),s.jsx("span",{className:"ml-2 text-gray-600",children:"画像を読み込み中..."})]}):D.error?s.jsxs("div",{className:"text-center py-8",children:[s.jsx("p",{className:"text-red-600 mb-2",children:"画像の読み込みに失敗しました"}),s.jsx("p",{className:"text-gray-500 text-sm",children:D.error}),s.jsx(a,{variant:"secondary",onClick:()=>{D.fetchParkImages(d.id)},className:"mt-4",children:"再読み込み"})]}):0===D.parkImages.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx("p",{className:"text-gray-600",children:"アップロードされた画像がありません"}),s.jsxs("p",{className:"text-gray-500 text-sm",children:["パークステータス: ",d.status]}),s.jsxs("p",{className:"text-gray-500 text-sm",children:["期待される画像数: ",d.total_images]}),s.jsx(a,{variant:"secondary",onClick:()=>{D.fetchParkImages(d.id)},className:"mt-4",children:"手動でリフレッシュ"})]}):s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:D.parkImages.map(((e,a)=>s.jsxs("div",{className:"relative group",children:[s.jsxs("div",{className:"relative overflow-hidden rounded-lg bg-gray-100",children:[s.jsx("img",{src:e.image_url,alt:B(e.image_type),className:"w-full h-48 object-cover cursor-pointer hover:scale-105 transition-transform duration-200",onClick:()=>(e=>{v(e),I(!0),y(e.admin_notes||"")})(e),onLoad:()=>{},onError:e=>{e.currentTarget.src="https://via.placeholder.com/400x300?text=Image+Not+Available"}}),s.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 flex items-center justify-center cursor-pointer",onClick:s=>{s.stopPropagation(),S(e.image_url)},children:s.jsx(x,{className:"w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-200"})})]}),s.jsx("div",{className:"absolute top-2 right-2",children:s.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+(!0===e.is_approved?"bg-green-100 text-green-800":!1===e.is_approved?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:!0===e.is_approved?"承認済み":!1===e.is_approved?"却下":"審査待ち"})}),s.jsx("div",{className:"absolute bottom-2 left-2",children:s.jsx("span",{className:"px-2 py-1 bg-white bg-opacity-90 text-gray-800 text-xs rounded border shadow-sm",children:B(e.image_type)})}),!1===e.is_approved&&e.admin_notes&&s.jsxs("div",{className:"mt-2 p-2 bg-red-50 rounded text-sm",children:[s.jsx("p",{className:"text-red-800 font-medium",children:"却下理由:"}),s.jsx("p",{className:"text-red-700",children:e.admin_notes})]})]},e.id)))})]}),s.jsxs(r,{className:"p-6",children:[s.jsx("h3",{className:"font-semibold mb-4",children:"審査結果"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"却下理由（却下する場合のみ入力）"}),s.jsx("textarea",{value:p,onChange:e=>y(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:"例: 施設の安全性に問題があります。安全対策を講じてから再度申請してください。"})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsxs(a,{onClick:()=>{P(d.id,!1)},isLoading:C.isProcessing,className:"bg-red-600 hover:bg-red-700",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"却下"]}),s.jsxs(a,{onClick:()=>{P(d.id,!0)},isLoading:C.isProcessing,className:"bg-green-600 hover:bg-green-700",children:[s.jsx(h,{className:"w-4 h-4 mr-2"}),"承認"]})]})]})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(N,{className:"w-6 h-6 text-blue-600 mr-2"}),"審査待ちドッグラン"]}),0===t.length?s.jsxs(r,{className:"text-center py-12",children:[s.jsx(h,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"審査待ちのドッグランはありません"})]}):s.jsx("div",{className:"space-y-4",children:t.map((e=>s.jsx(r,{className:"p-6 hover:shadow-lg transition-shadow",children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[s.jsx("h3",{className:"text-lg font-semibold",children:e.name}),s.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+("first_stage_passed"===e.status?"bg-blue-100 text-blue-800":"second_stage_review"===e.status?"bg-purple-100 text-purple-800":"bg-yellow-100 text-yellow-800"),children:"first_stage_passed"===e.status?"第一審査通過":"second_stage_review"===e.status?"第二審査中":"審査待ち"})]}),s.jsx("p",{className:"text-gray-600 mb-2",children:e.address}),s.jsxs("div",{className:"text-sm text-gray-500",children:[s.jsxs("p",{children:["オーナー: ",e.owner_name]}),s.jsxs("p",{children:["申請日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]}),e.second_stage_submitted_at&&s.jsxs("p",{children:["第二審査申請日: ",new Date(e.second_stage_submitted_at).toLocaleDateString("ja-JP")]})]}),"second_stage_review"===e.status&&s.jsxs("div",{className:"mt-3 grid grid-cols-4 gap-2 text-sm",children:[s.jsxs("div",{className:"bg-blue-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-blue-800",children:"全画像"}),s.jsxs("p",{className:"text-blue-600",children:[e.total_images,"枚"]})]}),s.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-yellow-800",children:"審査待ち"}),s.jsxs("p",{className:"text-yellow-600",children:[e.pending_images,"枚"]})]}),s.jsxs("div",{className:"bg-green-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-green-800",children:"承認済み"}),s.jsxs("p",{className:"text-green-600",children:[e.approved_images,"枚"]})]}),s.jsxs("div",{className:"bg-red-50 p-2 rounded text-center",children:[s.jsx("p",{className:"font-medium text-red-800",children:"却下"}),s.jsxs("p",{className:"text-red-600",children:[e.rejected_images,"枚"]})]})]})]}),s.jsxs("div",{className:"flex flex-col space-y-2",children:[s.jsxs(a,{onClick:()=>m(e),variant:"secondary",children:[s.jsx(u,{className:"w-4 h-4 mr-2"}),"詳細を見る"]}),s.jsxs(a,{onClick:()=>{P(e.id,!0)},className:"bg-green-600 hover:bg-green-700",disabled:C.isProcessing,children:[s.jsx(h,{className:"w-4 h-4 mr-1"}),"承認"]}),s.jsxs(a,{onClick:()=>{P(e.id,!1)},className:"bg-red-600 hover:bg-red-700",disabled:C.isProcessing,children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"却下"]})]})]})},e.id)))})]})};function S(){const{user:t,isAdmin:m,userProfile:x}=i(),g=c(),[p,u]=l.useState("vaccines"),[j,b]=l.useState(""),[_,S]=l.useState(""),C=w(p),D=e=>{S(e),b(""),setTimeout((()=>S("")),5e3)},P=e=>{b(e),S(""),setTimeout((()=>b("")),8e3)},Z=()=>{b(""),S("")};l.useEffect((()=>{t&&!m&&(async()=>{if("capasjapan@gmail.com"===t?.email&&!m)try{(await v(t.email)).success&&(D("管理者権限を設定しました。ページを再読み込みします..."),setTimeout((()=>window.location.reload()),1500))}catch(e){}})()}),[t,m]),l.useEffect((()=>{m?C.fetchData():g("/")}),[m,g,p]);const B=async e=>{D(e),await C.fetchData()},O=e=>{P(e)};return s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs(n,{to:"/admin",className:"flex items-center text-blue-600 hover:text-blue-800",children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),"管理者ダッシュボードに戻る"]})}),s.jsx("div",{className:"flex justify-between items-center",children:s.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[s.jsx(y,{className:"w-8 h-8 text-red-600 mr-3"}),"管理者審査ページ"]})}),j&&s.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[s.jsx(f,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{className:"text-red-800",children:j})]}),_&&s.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[s.jsx(h,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),s.jsx("p",{className:"text-green-800",children:_})]}),!m&&s.jsxs(r,{className:"p-4 bg-red-50 border-l-4 border-red-500",children:[s.jsx("h3",{className:"font-semibold mb-3 text-red-900",children:"❌ 管理者権限が必要です"}),s.jsxs("div",{className:"text-sm text-red-800 space-y-2",children:[s.jsx("p",{children:s.jsx("strong",{children:"ユーザー情報:"})}),s.jsxs("p",{children:["• Email: ",t?.email||"なし"]}),s.jsxs("p",{children:["• User Type: ",x?.user_type||"undefined"]}),s.jsxs("p",{children:["• Is Admin: ",m?"true":"false"]}),"capasjapan@gmail.com"===t?.email&&s.jsxs("div",{className:"mt-4 space-x-2",children:[s.jsx(a,{size:"sm",onClick:async()=>{Z();try{const e=await v(t.email);e.success?(D("管理者権限を設定しました。ページを再読み込みします..."),setTimeout((()=>window.location.reload()),1500)):P(`管理者権限の設定に失敗: ${e.error}`)}catch(e){P(`エラーが発生しました: ${e.message}`)}},className:"bg-blue-600 hover:bg-blue-700",children:"管理者権限を設定"}),s.jsx(a,{size:"sm",onClick:async()=>{if(Z(),t?.id)try{const s=await(async s=>{try{const{error:a}=await e.from("profiles").update({user_type:"admin"}).eq("id",s);return a?{success:!1,error:a.message}:{success:!0,message:"User type updated successfully"}}catch(j){return{success:!1,error:j.message}}})(t.id);s.success?(D("プロファイルを更新しました。ページを再読み込みします..."),setTimeout((()=>window.location.reload()),1500)):P(`プロファイル更新に失敗: ${s.error}`)}catch(s){P(`エラーが発生しました: ${s.message}`)}else P("ユーザーIDが見つかりません")},className:"bg-orange-600 hover:bg-orange-700",children:"直接更新"})]})]})]}),m&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex space-x-4 border-b",children:[s.jsxs("button",{className:"px-4 py-2 font-medium "+("parks"===p?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>u("parks"),children:[s.jsx(N,{className:"w-4 h-4 inline mr-2"}),"ドッグラン審査"]}),s.jsxs("button",{className:"px-4 py-2 font-medium "+("vaccines"===p?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),onClick:()=>u("vaccines"),children:[s.jsx(d,{className:"w-4 h-4 inline mr-2"}),"ワクチン証明書審査"]})]}),s.jsxs("div",{className:"mt-6",children:["parks"===p&&s.jsx(k,{pendingParks:C.pendingParks,isLoading:C.isLoading,onApprovalComplete:B,onError:O}),"vaccines"===p&&s.jsx(I,{pendingVaccines:C.pendingVaccines,isLoading:C.isLoading,onApprovalComplete:B,onError:O})]})]})]})}export{S as AdminManagement};
