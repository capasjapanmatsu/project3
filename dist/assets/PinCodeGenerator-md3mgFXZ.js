import{u as e,j as s,B as t,b as a}from"./index-rzoKNnex.js";import{r}from"./vendor-Cwmn0chA.js";import{C as l}from"./Card-CRM3w0N8.js";import{K as n,i,ao as c,s as o,R as m,l as d,x,g as u}from"./ui-CMSAjam7.js";function h({lockId:h,parkName:j="ドッグパーク",purpose:p="entry",className:N="",onSuccess:f,onError:b,reservationId:g}){const{user:w}=e(),[v,y]=r.useState(null),[k,I]=r.useState(null),[S,P]=r.useState(null),[_,T]=r.useState(!1),[E,C]=r.useState(null),[D,M]=r.useState(!1),[R,$]=r.useState(!1),[z,A]=r.useState(!1),[O,q]=r.useState("");r.useEffect((()=>{if(v&&k){const e=setInterval((()=>{const s=new Date,t=k.getTime()-s.getTime();if(t<=0)P("期限切れ"),y(null),I(null),clearInterval(e);else{const e=Math.floor(t/6e4),s=Math.floor(t%6e4/1e3);P(`${e}:${s.toString().padStart(2,"0")}`)}}),1e3);return()=>clearInterval(e)}}),[v,k]);const B=async()=>{if(w){T(!0),C(null);try{const{data:{session:e}}=await a.auth.getSession();if(!(null==e?void 0:e.access_token))throw new Error("認証が必要です");let s=5,t=null;if(g){const e=await(async e=>{try{const{data:s,error:t}=await a.from("reservations").select("\n          *,\n          dog_park:dog_parks(*),\n          dog:dogs(*)\n        ").eq("id",e).single();return t?null:s}catch(s){return null}})(g);if(e&&"whole_facility"===e.reservation_type&&(t=(e=>{try{const s=new Date(e.date),[t,a]=e.start_time.split(":").map(Number);return s.setHours(t,a,0,0),new Date(s.getTime()+60*e.duration*60*1e3)}catch(s){return null}})(e),t)){const e=new Date,a=t.getTime()-e.getTime();s=Math.max(1,Math.ceil(a/6e4))}}const r=await fetch("https://onmcivwxtzqajcovptgf.supabase.co/functions/v1/generate-pin",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({lock_id:h,purpose:p,expiry_minutes:s,reservation_id:g||void 0})});if(!r.ok){const e=await r.json();throw new Error(e.error||"PINコードの生成に失敗しました")}const{pin:l,expires_at:n}=await r.json();y(l),I(new Date(n)),$(!0),f&&f(l),setTimeout((()=>{$(!1)}),3e3)}catch(e){if(e.message&&e.message.startsWith("PAYMENT_REQUIRED:")){const s=e.message.replace("PAYMENT_REQUIRED:","").trim();q(s),A(!0),C(null)}else C(e.message||"PINコードの生成に失敗しました"),A(!1);b&&b(e.message||"PINコードの生成に失敗しました")}finally{T(!1)}}};return s.jsx(l,{className:`p-4 ${N}`,children:s.jsxs("div",{className:"text-center",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-center",children:[s.jsx(n,{className:"w-5 h-5 text-blue-600 mr-2"}),j,"の","entry"===p?"入口":"出口"]}),v?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border-2 border-blue-200 mx-auto",children:[s.jsx("p",{className:"text-sm text-blue-800 mb-1",children:"PINコード:"}),s.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[s.jsx("p",{className:"text-3xl font-bold tracking-widest text-blue-700",children:v}),s.jsx("button",{onClick:()=>{v&&navigator.clipboard.writeText(v).then((()=>{M(!0),setTimeout((()=>M(!1)),2e3)}))},className:"p-1 text-blue-600 hover:text-blue-800 transition-colors",title:"コピー",children:D?s.jsx(i,{className:"w-5 h-5"}):s.jsx(c,{className:"w-5 h-5"})})]})]}),s.jsx("div",{className:"bg-yellow-50 p-2 rounded-lg",children:s.jsxs("div",{className:"flex items-center justify-center space-x-2 text-yellow-800",children:[s.jsx(o,{className:"w-4 h-4"}),s.jsxs("span",{className:"font-medium",children:["有効期限: ",S]})]})}),s.jsx("div",{className:"flex justify-center space-x-3",children:s.jsxs(t,{onClick:B,variant:"secondary",size:"sm",isLoading:_,children:[s.jsx(m,{className:"w-4 h-4 mr-1"}),"再生成"]})}),s.jsxs("p",{className:"text-xs text-gray-500",children:["entry"===p?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("p",{className:"text-gray-600 mb-4",children:["entry"===p?"入場":"退場","用のPINコードを生成します。",s.jsx("br",{}),"生成されたPINコードは5分間有効です。"]}),E&&s.jsxs("div",{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",children:[s.jsx(d,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:E})]}),z&&s.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[s.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[s.jsx(x,{className:"w-6 h-6 text-blue-600 mt-1 flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"決済が必要です"}),s.jsx("p",{className:"text-sm text-blue-800 mb-4",children:O})]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs(t,{onClick:()=>window.location.href="/subscription",className:"w-full bg-purple-600 hover:bg-purple-700",children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"サブスクリプションに加入（¥3,800/月）"]}),s.jsxs(t,{onClick:()=>window.location.href="/parks",variant:"secondary",className:"w-full",children:[s.jsx(u,{className:"w-4 h-4 mr-2"}),"1日券を購入（¥800）"]})]}),s.jsxs("p",{className:"text-xs text-blue-700 mt-3",children:["• サブスクリプション：全国のドッグランが使い放題",s.jsx("br",{}),"• 1日券：選択したドッグランで24時間利用可能"]})]}),R&&s.jsxs("div",{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",children:[s.jsx(i,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:"PINコードを生成しました"})]}),s.jsxs(t,{onClick:B,isLoading:_,className:"w-full",children:[s.jsx(n,{className:"w-4 h-4 mr-2"}),"entry"===p?"入場":"退場","用PINを生成"]})]})]})})}export{h as P};
