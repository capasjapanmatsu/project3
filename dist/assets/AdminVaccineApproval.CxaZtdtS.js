var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,i=(s,a,r)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[a]=r,n=(e,s,a)=>new Promise(((r,t)=>{var l=e=>{try{n(a.next(e))}catch(s){t(s)}},i=e=>{try{n(a.throw(e))}catch(s){t(s)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,i);n((a=a.apply(e,s)).next())}));import{u as d,s as c,j as o,C as m,B as x}from"./index.D9xag4tn.js";import{u as h,r as g}from"./router.BWT_vQps.js";import{p as j,a as p,F as u,D as b,U as v,M as N,P as _,b as y,o as f,al as w}from"./ui.BPlS2KKq.js";import"./vendor.D1SiiUJb.js";import"./supabase.CZ8ekJUM.js";function S(){const{user:e,isAdmin:S}=d(),k=h(),[C,O]=g.useState([]),[D,P]=g.useState([]),[z,$]=g.useState([]),[E,F]=g.useState(!0),[I,M]=g.useState(""),[T,Y]=g.useState(""),[q,A]=g.useState("pending"),[B,J]=g.useState(null),[L,U]=g.useState(!1),[G,H]=g.useState(!1),[K,Q]=g.useState(null);g.useEffect((()=>{S?W():k("/")}),[S,k]),g.useEffect((()=>{C.length>0&&V()}),[C]);const R=e=>{M(e),Y(""),setTimeout((()=>M("")),8e3)},V=()=>{const e=C.filter((e=>"pending"===e.status)),s=C.filter((e=>"approved"===e.status));P(e),$(s)},W=()=>n(null,null,(function*(){try{F(!0),M("");const{data:e,error:s}=yield c.from("vaccine_certifications").select("\n          *,\n          dog:dogs (\n            id,\n            name,\n            breed,\n            gender,\n            birth_date,\n            owner:profiles (\n              id,\n              name,\n              email,\n              phone_number,\n              address,\n              postal_code\n            )\n          )\n        ").order("created_at",{ascending:!1});if(s)throw s;const a=(e||[]).map((e=>{var s,a,r,t,l,i,n,d,c,o,m,x,h,g;return{id:e.id,dog_id:e.dog_id,dog_name:(null==(s=e.dog)?void 0:s.name)||"不明",dog_breed:(null==(a=e.dog)?void 0:a.breed)||"不明",dog_gender:(null==(r=e.dog)?void 0:r.gender)||"不明",dog_birth_date:(null==(t=e.dog)?void 0:t.birth_date)||"",owner_id:e.owner_id,owner_name:(null==(i=null==(l=e.dog)?void 0:l.owner)?void 0:i.name)||"不明",owner_email:(null==(d=null==(n=e.dog)?void 0:n.owner)?void 0:d.email)||"不明",owner_phone:(null==(o=null==(c=e.dog)?void 0:c.owner)?void 0:o.phone_number)||"",owner_address:(null==(x=null==(m=e.dog)?void 0:m.owner)?void 0:x.address)||"",owner_postal_code:(null==(g=null==(h=e.dog)?void 0:h.owner)?void 0:g.postal_code)||"",rabies_vaccine_image:e.rabies_vaccine_image||"",combo_vaccine_image:e.combo_vaccine_image||"",rabies_expiry_date:e.rabies_expiry_date||"",combo_expiry_date:e.combo_expiry_date||"",status:e.status||"pending",created_at:e.created_at,admin_notes:e.admin_notes||""}}));O(a)}catch(e){R("ワクチン証明書申請の取得に失敗しました。")}finally{F(!1)}})),X=e=>n(null,null,(function*(){if(window.confirm("このワクチン証明書申請を承認してもよろしいですか？"))try{H(!0),M(""),Y("");const{error:n}=yield c.from("vaccine_certifications").update({status:"approved",approved_at:(new Date).toISOString()}).eq("id",e);if(n)throw n;const d=C.find((s=>s.id===e));d&&(yield c.from("notifications").insert([{user_id:d.owner_id,title:"ワクチン証明書承認",message:`${d.dog_name}ちゃんのワクチン証明書が承認されました。`,type:"vaccine_approved",created_at:(new Date).toISOString(),read:!1}])),Y("ワクチン証明書を承認しました。"),M(""),setTimeout((()=>Y("")),5e3),O((n=>n.map((n=>{return n.id===e?(d=((e,s)=>{for(var a in s||(s={}))t.call(s,a)&&i(e,a,s[a]);if(r)for(var a of r(s))l.call(s,a)&&i(e,a,s[a]);return e})({},n),s(d,a({status:"approved"}))):n;var d}))))}catch(n){R("承認処理に失敗しました。")}finally{H(!1)}})),Z=e=>{switch(e){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},ee=e=>{switch(e){case"pending":return"承認待ち";case"approved":return"承認済み";case"rejected":return"却下";default:return"不明"}},se=e=>new Date(e).toLocaleDateString("ja-JP"),ae=e=>{if(!e)return"不明";const s=new Date,a=new Date(e),r=s.getFullYear()-a.getFullYear(),t=s.getMonth()-a.getMonth();return t<0||0===t&&s.getDate()<a.getDate()?r-1+"歳":`${r}歳`};return S?E?o.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:o.jsxs("div",{className:"text-center",children:[o.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),o.jsx("p",{className:"text-gray-600",children:"データを読み込み中..."})]})}):o.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:o.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[o.jsxs("div",{className:"bg-white shadow rounded-lg mb-8",children:[o.jsxs("div",{className:"px-6 py-4 border-b border-gray-200",children:[o.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワクチン証明書 承認管理"}),o.jsx("p",{className:"text-gray-600",children:"登録されたワクチン証明書の承認・却下を管理します。"})]}),I&&o.jsx("div",{className:"px-6 py-4 bg-red-50 border-l-4 border-red-400",children:o.jsxs("div",{className:"flex",children:[o.jsx(j,{className:"h-5 w-5 text-red-400 mr-2"}),o.jsx("p",{className:"text-sm text-red-700",children:I})]})}),T&&o.jsx("div",{className:"px-6 py-4 bg-green-50 border-l-4 border-green-400",children:o.jsxs("div",{className:"flex",children:[o.jsx(p,{className:"h-5 w-5 text-green-400 mr-2"}),o.jsx("p",{className:"text-sm text-green-700",children:T})]})}),o.jsx("div",{className:"px-6",children:o.jsxs("nav",{className:"flex space-x-8","aria-label":"Tabs",children:[o.jsxs("button",{onClick:()=>A("pending"),className:"whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm "+("pending"===q?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[o.jsx(u,{className:"w-5 h-5 inline mr-2"}),"承認待ち",o.jsx("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:D.length})]}),o.jsxs("button",{onClick:()=>A("approved"),className:"whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm "+("approved"===q?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[o.jsx(b,{className:"w-5 h-5 inline mr-2"}),"登録中のワンちゃん",o.jsx("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:z.length})]})]})})]}),"pending"===q&&o.jsx("div",{className:"space-y-6",children:0===D.length?o.jsxs(m,{className:"text-center py-12",children:[o.jsx(u,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),o.jsx("p",{className:"text-gray-600",children:"承認待ちのワクチン証明書申請がありません"})]}):o.jsx("div",{className:"space-y-4",children:D.map((e=>o.jsx(m,{className:"p-6",children:o.jsxs("div",{className:"flex items-start justify-between",children:[o.jsxs("div",{className:"flex-1",children:[o.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[o.jsx(b,{className:"w-5 h-5 text-blue-600"}),o.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:e.dog_name}),o.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${Z(e.status)}`,children:ee(e.status)})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[o.jsxs("div",{children:[o.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"ワンちゃん情報"}),o.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[o.jsxs("div",{children:["犬種: ",e.dog_breed]}),o.jsxs("div",{children:["性別: ",e.dog_gender]}),o.jsxs("div",{children:["年齢: ",ae(e.dog_birth_date)]})]})]}),o.jsxs("div",{children:[o.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"飼い主情報"}),o.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[o.jsxs("div",{className:"flex items-center",children:[o.jsx(v,{className:"w-4 h-4 mr-1"}),e.owner_name]}),o.jsxs("div",{className:"flex items-center",children:[o.jsx(N,{className:"w-4 h-4 mr-1"}),e.owner_email]}),e.owner_phone&&o.jsxs("div",{className:"flex items-center",children:[o.jsx(_,{className:"w-4 h-4 mr-1"}),e.owner_phone]}),e.owner_address&&o.jsxs("div",{className:"flex items-center",children:[o.jsx(y,{className:"w-4 h-4 mr-1"}),"〒",e.owner_postal_code," ",e.owner_address]})]})]})]}),o.jsxs("div",{className:"text-sm text-gray-500",children:["申請日: ",se(e.created_at)]})]}),o.jsxs("div",{className:"flex space-x-2 ml-4",children:[o.jsxs(x,{size:"sm",variant:"secondary",onClick:()=>{J(e),U(!0)},children:[o.jsx(f,{className:"w-4 h-4 mr-1"}),"詳細"]}),o.jsxs(x,{size:"sm",onClick:()=>X(e.id),className:"bg-green-600 hover:bg-green-700",disabled:G,children:[o.jsx(p,{className:"w-4 h-4 mr-1"}),"承認"]})]})]})},e.id)))})}),"approved"===q&&o.jsx("div",{className:"space-y-6",children:0===z.length?o.jsxs(m,{className:"text-center py-12",children:[o.jsx(b,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),o.jsx("p",{className:"text-gray-600",children:"承認済みのワクチン証明書がありません"})]}):o.jsx("div",{className:"space-y-4",children:z.map((e=>o.jsx(m,{className:"p-6",children:o.jsxs("div",{className:"flex items-start justify-between",children:[o.jsxs("div",{className:"flex-1",children:[o.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[o.jsx(b,{className:"w-5 h-5 text-green-600"}),o.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:e.dog_name}),o.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${Z(e.status)}`,children:ee(e.status)})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[o.jsxs("div",{children:[o.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"ワンちゃん情報"}),o.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[o.jsxs("div",{children:["犬種: ",e.dog_breed]}),o.jsxs("div",{children:["性別: ",e.dog_gender]}),o.jsxs("div",{children:["年齢: ",ae(e.dog_birth_date)]})]})]}),o.jsxs("div",{children:[o.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"飼い主情報"}),o.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[o.jsxs("div",{className:"flex items-center",children:[o.jsx(v,{className:"w-4 h-4 mr-1"}),e.owner_name]}),o.jsxs("div",{className:"flex items-center",children:[o.jsx(N,{className:"w-4 h-4 mr-1"}),e.owner_email]}),e.owner_phone&&o.jsxs("div",{className:"flex items-center",children:[o.jsx(_,{className:"w-4 h-4 mr-1"}),e.owner_phone]}),e.owner_address&&o.jsxs("div",{className:"flex items-center",children:[o.jsx(y,{className:"w-4 h-4 mr-1"}),"〒",e.owner_postal_code," ",e.owner_address]})]})]})]}),o.jsxs("div",{className:"text-sm text-gray-500",children:["申請日: ",se(e.created_at)]})]}),o.jsx("div",{className:"flex space-x-2 ml-4",children:o.jsxs(x,{size:"sm",variant:"secondary",onClick:()=>{J(e),U(!0)},children:[o.jsx(f,{className:"w-4 h-4 mr-1"}),"詳細"]})})]})},e.id)))})}),L&&B&&o.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:o.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:o.jsxs("div",{className:"p-6",children:[o.jsxs("div",{className:"flex justify-between items-center mb-6",children:[o.jsx("h2",{className:"text-xl font-bold",children:"ワクチン証明書詳細"}),o.jsx("button",{onClick:()=>{U(!1),J(null)},className:"text-gray-500 hover:text-gray-700",children:"×"})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[o.jsxs("div",{children:[o.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"ワンちゃん情報"}),o.jsxs("div",{className:"space-y-2 text-sm",children:[o.jsxs("div",{children:[o.jsx("strong",{children:"名前:"})," ",B.dog_name]}),o.jsxs("div",{children:[o.jsx("strong",{children:"犬種:"})," ",B.dog_breed]}),o.jsxs("div",{children:[o.jsx("strong",{children:"性別:"})," ",B.dog_gender]}),o.jsxs("div",{children:[o.jsx("strong",{children:"年齢:"})," ",ae(B.dog_birth_date)]})]})]}),o.jsxs("div",{children:[o.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"飼い主情報"}),o.jsxs("div",{className:"space-y-2 text-sm",children:[o.jsxs("div",{children:[o.jsx("strong",{children:"名前:"})," ",B.owner_name]}),o.jsxs("div",{children:[o.jsx("strong",{children:"メール:"})," ",B.owner_email]}),B.owner_phone&&o.jsxs("div",{children:[o.jsx("strong",{children:"電話:"})," ",B.owner_phone]}),B.owner_address&&o.jsxs("div",{children:[o.jsx("strong",{children:"住所:"})," 〒",B.owner_postal_code," ",B.owner_address]})]})]})]}),o.jsxs("div",{className:"mt-6",children:[o.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"ワクチン証明書画像"}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[B.rabies_vaccine_image&&o.jsxs("div",{children:[o.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["狂犬病ワクチン",B.rabies_expiry_date&&o.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(有効期限: ",se(B.rabies_expiry_date),")"]})]}),o.jsxs("div",{className:"relative",children:[o.jsx("img",{src:B.rabies_vaccine_image,alt:"狂犬病ワクチン証明書",className:"w-full h-48 object-cover rounded-lg border cursor-pointer",onClick:()=>Q(B.rabies_vaccine_image)}),o.jsx("div",{className:"absolute top-2 right-2",children:o.jsx("button",{onClick:()=>Q(B.rabies_vaccine_image),className:"bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-70",children:o.jsx(w,{className:"w-4 h-4"})})})]})]}),B.combo_vaccine_image&&o.jsxs("div",{children:[o.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["混合ワクチン",B.combo_expiry_date&&o.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(有効期限: ",se(B.combo_expiry_date),")"]})]}),o.jsxs("div",{className:"relative",children:[o.jsx("img",{src:B.combo_vaccine_image,alt:"混合ワクチン証明書",className:"w-full h-48 object-cover rounded-lg border cursor-pointer",onClick:()=>Q(B.combo_vaccine_image)}),o.jsx("div",{className:"absolute top-2 right-2",children:o.jsx("button",{onClick:()=>Q(B.combo_vaccine_image),className:"bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-70",children:o.jsx(w,{className:"w-4 h-4"})})})]})]})]})]}),o.jsxs("div",{className:"mt-6 text-sm text-gray-500",children:["申請日: ",se(B.created_at)]})]})})}),K&&o.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50",children:o.jsxs("div",{className:"relative max-w-4xl max-h-full",children:[o.jsx("button",{onClick:()=>Q(null),className:"absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-70",children:"×"}),o.jsx("img",{src:K,alt:"拡大画像",className:"max-w-full max-h-full object-contain"})]})})]})}):o.jsx("div",{className:"max-w-4xl mx-auto p-4",children:o.jsx(m,{className:"p-6",children:o.jsxs("div",{className:"flex items-center justify-center",children:[o.jsx(j,{className:"w-12 h-12 text-red-500 mr-4"}),o.jsxs("div",{children:[o.jsx("h2",{className:"text-xl font-semibold text-red-700",children:"アクセス権限がありません"}),o.jsx("p",{className:"text-red-600",children:"このページは管理者のみアクセス可能です。"})]})]})})})}export{S as default};
