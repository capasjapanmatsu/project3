import{j as e,J as ie,i as V,q as I,ad as de,aN as oe,a0 as xe,D as me,t as ue,g as y,f as pe,A as he,C as ge}from"./ui-vendor-w2MLOks7.js";import{u as fe,r,L as je}from"./react-vendor-_GyjDmDn.js";import{u as _e,s as m,C as x,B as O}from"./index-pj4YkVsE.js";import{I as ye}from"./Input-BBFNs-Kh.js";import"./supabase-vendor-Df9iqQzW.js";function De(){const{isAdmin:N}=_e(),f=fe(),[i,b]=r.useState([]),[c,q]=r.useState(null),[M,w]=r.useState(!0),[v,k]=r.useState(""),[S,J]=r.useState(""),[D,z]=r.useState("all"),[C,W]=r.useState(""),[L,X]=r.useState("reservation_date"),[E,G]=r.useState("desc"),p=r.useDeferredValue(S),j=r.useDeferredValue(D),_=r.useDeferredValue(C),h=r.useDeferredValue(L),U=r.useDeferredValue(E);r.useEffect(()=>{if(!N){f("/");return}ee(),te()},[N,f]);const o=r.useMemo(()=>{console.log(`🔍 Filtering ${i.length} reservations...`);let t=[...i];if(p&&(t=t.filter(a=>a.user_name.toLowerCase().includes(p.toLowerCase())||a.user_email.toLowerCase().includes(p.toLowerCase())||a.park_name.toLowerCase().includes(p.toLowerCase()))),j!=="all"&&(t=t.filter(a=>a.status===j)),_){const a=new Date(_);t=t.filter(n=>new Date(n.reservation_date).toDateString()===a.toDateString())}return t.sort((a,n)=>{let l=a[h],d=n[h];return(h==="reservation_date"||h==="created_at")&&(l=new Date(l).getTime(),d=new Date(d).getTime()),U==="asc"?l>d?1:-1:l<d?1:-1}),console.log(`✅ Filtered to ${t.length} reservations`),t},[i,p,j,_,h,U]),H=t=>{J(t),r.startTransition(()=>{console.log(`🔍 Searching reservations for "${t}"`)})},K=t=>{r.startTransition(()=>{z(t)})},Q=t=>{r.startTransition(()=>{W(t)})},Y=t=>{r.startTransition(()=>{X(t)})},Z=t=>{r.startTransition(()=>{G(t)})},ee=async()=>{try{w(!0),k("");const{data:t,error:a}=await m.from("reservations").select(`
          id,
          user_id,
          park_id,
          dog_id,
          date,
          start_time,
          duration,
          status,
          total_amount,
          reservation_type,
          created_at,
          updated_at
        `).order("created_at",{ascending:!1});if(a)throw console.error("Reservations error:",a),new Error("予約情報の取得に失敗しました");if(!t||t.length===0){b([]);return}let n=null;try{const{data:s,error:u}=await m.auth.admin.listUsers();u?console.warn("Auth users fetch failed for reservations:",u):(n=s,console.log("Successfully fetched auth users for reservations"))}catch(s){console.warn("Auth admin API not available for reservations:",s)}const l=t.map(async s=>{try{const{data:u}=await m.from("profiles").select("name, user_type").eq("id",s.user_id).single(),{data:B}=await m.from("dog_parks").select("name, address").eq("id",s.park_id).single(),{data:R}=await m.from("dogs").select("name, breed").eq("id",s.dog_id).single();let F=null;try{const{data:g}=await m.from("stripe_subscriptions").select("status").eq("user_id",s.user_id).eq("status","active").maybeSingle();F=g}catch(g){console.warn("Stripe subscriptions table not available:",g)}const ce=n?.users?.find(g=>g.id===s.user_id)?.email;return{id:s.id,user_name:u?.name||"Unknown",user_email:ce||`user_${s.user_id.slice(0,8)}@unknown.com`,park_id:s.park_id,park_name:B?.name||"Unknown Park",park_address:B?.address||"Unknown Address",dog_name:R?.name||"Unknown Dog",dog_breed:R?.breed||"Unknown Breed",dog_count:1,reservation_date:s.date,start_time:s.start_time,duration:s.duration||1,total_price:s.total_amount||0,status:s.status,reservation_type:s.reservation_type,is_subscription:!!F,payment_status:s.total_amount>0?"paid":"pending",created_at:s.created_at,updated_at:s.updated_at}}catch(u){return console.error(`Error fetching data for reservation ${s.id}:`,u),{id:s.id,user_name:"Unknown",user_email:`user_${s.user_id.slice(0,8)}@unknown.com`,park_id:s.park_id,park_name:"Unknown Park",park_address:"Unknown Address",dog_name:"Unknown Dog",dog_breed:"Unknown Breed",dog_count:1,reservation_date:s.date,start_time:s.start_time,duration:s.duration||1,total_price:s.total_amount||0,status:s.status,reservation_type:s.reservation_type,is_subscription:!1,payment_status:"pending",created_at:s.created_at,updated_at:s.updated_at}}}),d=await Promise.all(l);b(d)}catch(t){console.error("Error fetching reservations:",t),k(`予約データの取得に失敗しました: ${t instanceof Error?t.message:"不明なエラー"}`)}finally{w(!1)}},te=async()=>{try{const{data:t,error:a}=await m.rpc("get_admin_reservation_stats");if(a)throw a;q(t)}catch(t){console.error("Error fetching reservation stats:",t)}},se=()=>{const t=["予約ID","ユーザー名","メール","ドッグラン","予約日","開始時間","時間","料金","ステータス","支払状況","登録日"],a=o.map(s=>[s.id,s.user_name,s.user_email,s.park_name,new Date(s.reservation_date).toLocaleDateString("ja-JP"),`${s.start_time}:00`,`${s.duration}時間`,`¥${s.total_price.toLocaleString()}`,$(s.status),T(s.payment_status),new Date(s.created_at).toLocaleDateString("ja-JP")]),n=[t,...a].map(s=>s.join(",")).join(`
`),l=new Blob([n],{type:"text/csv;charset=utf-8;"}),d=document.createElement("a");d.href=URL.createObjectURL(l),d.download=`reservations_${new Date().toISOString().split("T")[0]}.csv`,d.click()},$=t=>({confirmed:"確定",cancelled:"キャンセル",completed:"完了"})[t]||t,T=t=>({pending:"未払い",paid:"支払済み",refunded:"返金済み"})[t]||t,ae=t=>{const a={confirmed:{color:"bg-green-100 text-green-800",icon:y},cancelled:{color:"bg-red-100 text-red-800",icon:pe},completed:{color:"bg-blue-100 text-blue-800",icon:y}},n=a[t]||a.confirmed,l=n.icon;return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(l,{className:"w-4 h-4"}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${n.color}`,children:$(t)})]})},re=t=>{const a={pending:{color:"bg-yellow-100 text-yellow-800",icon:ge},paid:{color:"bg-green-100 text-green-800",icon:y},refunded:{color:"bg-gray-100 text-gray-800",icon:he}},n=a[t]||a.pending,l=n.icon;return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(l,{className:"w-4 h-4"}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${n.color}`,children:T(t)})]})};if(M)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"})});const P=o.reduce((t,a)=>t+a.total_price,0),ne=o.length>0?P/o.length:0,A=o.filter(t=>t.is_subscription).length,le=i.length>0?i.filter(t=>t.status==="cancelled").length/i.length*100:0;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(je,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(V,{className:"w-8 h-8 text-purple-600 mr-3"}),"予約管理"]}),e.jsx("p",{className:"text-gray-600",children:"予約の詳細情報と統計分析"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["総予約数: ",i.length,"件"]})]}),v&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:v}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"総予約数"}),e.jsx("p",{className:"text-xl font-bold text-purple-600",children:i.length})]}),e.jsx(V,{className:"w-6 h-6 text-purple-600"})]})}),e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"サブスク予約"}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:A}),e.jsxs("p",{className:"text-xs text-gray-500",children:[i.length>0?Math.round(A/i.length*100):0,"%"]})]}),e.jsx(I,{className:"w-6 h-6 text-blue-600"})]})}),e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均単価"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:["¥",Math.round(ne).toLocaleString()]})]}),e.jsx(de,{className:"w-6 h-6 text-green-600"})]})}),e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"キャンセル率"}),e.jsxs("p",{className:"text-xl font-bold text-orange-600",children:[le.toFixed(1),"%"]})]}),e.jsx(oe,{className:"w-6 h-6 text-orange-600"})]})})]}),c&&c.daily_stats.length>0&&e.jsxs(x,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"日別予約統計（直近30日）"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均日次予約数"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:Math.round(c.daily_stats.reduce((t,a)=>t+a.count,0)/c.daily_stats.length)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均日次売上"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["¥",Math.round(c.daily_stats.reduce((t,a)=>t+a.revenue,0)/c.daily_stats.length).toLocaleString()]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"平均キャンセル率"}),e.jsxs("p",{className:"text-2xl font-bold text-orange-600",children:[(c.daily_stats.reduce((t,a)=>t+a.cancellation_rate,0)/c.daily_stats.length).toFixed(1),"%"]})]})]})]}),c&&c.top_parks.length>0&&e.jsxs(x,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"人気ドッグランランキング"}),e.jsx("div",{className:"space-y-3",children:c.top_parks.slice(0,5).map((t,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${a===0?"bg-yellow-500":a===1?"bg-gray-400":a===2?"bg-orange-600":"bg-blue-500"}`,children:a+1}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.park_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.reservation_count,"件の予約"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-green-600",children:["¥",t.revenue.toLocaleString()]}),e.jsx("p",{className:"text-sm text-gray-600",children:"売上"})]})]},t.park_name))})]}),e.jsxs(x,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(ye,{label:"検索",placeholder:"ユーザー名、メール、ドッグラン名で検索...",value:S,onChange:t=>H(t.target.value),icon:e.jsx(xe,{className:"w-4 h-4 text-gray-500"})})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),e.jsxs("select",{value:D,onChange:t=>K(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"all",children:"すべて"}),e.jsx("option",{value:"confirmed",children:"確定"}),e.jsx("option",{value:"cancelled",children:"キャンセル"}),e.jsx("option",{value:"completed",children:"完了"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"予約日"}),e.jsx("input",{type:"date",value:C,onChange:t=>Q(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),e.jsxs("select",{value:`${L}-${E}`,onChange:t=>{const[a,n]=t.target.value.split("-");Y(a),Z(n)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"reservation_date-desc",children:"予約日（新しい順）"}),e.jsx("option",{value:"reservation_date-asc",children:"予約日（古い順）"}),e.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),e.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),e.jsx("option",{value:"total_price-desc",children:"料金（高い順）"}),e.jsx("option",{value:"total_price-asc",children:"料金（低い順）"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[o.length,"件の予約が見つかりました",o.length>0&&e.jsxs("span",{className:"ml-2",children:["（合計売上: ¥",P.toLocaleString(),"）"]})]}),e.jsxs(O,{variant:"secondary",size:"sm",onClick:se,children:[e.jsx(me,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),e.jsx(x,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ユーザー"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ドッグラン"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"予約日時"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"料金"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"支払状況"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:o.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.user_name}),t.is_subscription&&e.jsx(I,{className:"w-4 h-4 text-purple-600 ml-2"})]}),e.jsx("div",{className:"text-sm text-gray-500",children:t.user_email}),e.jsxs("div",{className:"text-xs text-gray-400",children:["犬: ",t.dog_count,"匹"]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.park_name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("div",{className:"text-gray-900",children:new Date(t.reservation_date).toLocaleDateString("ja-JP")}),e.jsxs("div",{className:"text-gray-500",children:[t.start_time,":00 (",t.duration,"時間)"]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["¥",t.total_price.toLocaleString()]}),t.is_subscription&&e.jsx("div",{className:"text-xs text-purple-600",children:"サブスク割引適用"})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:ae(t.status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:re(t.payment_status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx(O,{size:"sm",variant:"secondary",onClick:()=>f(`/parks/${t.park_id}`),children:e.jsx(ue,{className:"w-4 h-4"})})})})]},t.id))})]})})})]})}export{De as AdminReservationManagement};
