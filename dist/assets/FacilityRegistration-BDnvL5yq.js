import{j as e,l as A,g as k,p as L,al as T,X as J}from"./ui-vendor-FlUr4cJt.js";import{u as X,r as g}from"./react-vendor-_GyjDmDn.js";import{u as Y,C as w,B as j,s as S}from"./index-BSYT0262.js";import{I as f}from"./Input-wBkmcJUR.js";import"./supabase-vendor-Df9iqQzW.js";const $=b=>new Promise((y,m)=>{const u=document.createElement("canvas"),x=u.getContext("2d"),n=document.createElement("img");n.onload=()=>{let o=n.naturalWidth,c=n.naturalHeight;o>c?o>800&&(c=c*800/o,o=800):c>600&&(o=o*600/c,c=600),u.width=o,u.height=c,x?.drawImage(n,0,0,o,c);const v=u.toDataURL("image/jpeg",.8);y(v)},n.onerror=m,n.src=URL.createObjectURL(b)}),K=[{id:"pet_hotel",name:"ペットホテル",monthly_fee:5e3,is_free:!0},{id:"pet_salon",name:"ペットサロン",monthly_fee:3e3,is_free:!0},{id:"veterinary",name:"動物病院",monthly_fee:8e3,is_free:!0},{id:"pet_cafe",name:"ペットカフェ",monthly_fee:4e3,is_free:!0},{id:"pet_restaurant",name:"ペット同伴レストラン",monthly_fee:6e3,is_free:!0},{id:"pet_shop",name:"ペットショップ",monthly_fee:7e3,is_free:!0},{id:"pet_accommodation",name:"ペット同伴宿泊",monthly_fee:1e4,is_free:!0}];function ae(){const{user:b,isAuthenticated:y,userProfile:m}=Y(),u=X(),[x,n]=g.useState(!1),[C,h]=g.useState(""),[o,c]=g.useState(""),[v,F]=g.useState([]),[U,D]=g.useState([]),[t,p]=g.useState({name:m?.name||"",address:m?.address||"",isEditing:!1}),[r,E]=g.useState({name:"",category_id:"",address:"",phone:"",website:"",description:"",images:[]});g.useEffect(()=>{y||u("/login")},[y,u]),g.useEffect(()=>{m&&p({name:m.name||"",address:m.address||"",isEditing:!1})},[m]);const N=s=>{const{name:a,value:i}=s.target;E(l=>({...l,[a]:i}))},R=async s=>{const a=Array.from(s.target.files||[]);if(a.length!==0){if(v.length+a.length>5){h("画像は最大5枚までアップロードできます");return}n(!0),h("");try{if(a.filter(d=>d.size>10485760).length>0){h("画像ファイルのサイズは10MB以下にしてください"),n(!1);return}const l=await Promise.all(a.map(d=>$(d))),I=a.slice(0,5-v.length);F(d=>[...d,...I]),D(d=>[...d,...l]),E(d=>({...d,images:[...d.images,...l]}))}catch(i){h(i instanceof Error?i.message:"画像の処理に失敗しました")}finally{n(!1)}}},B=s=>{F(a=>a.filter((i,l)=>l!==s)),D(a=>a.filter((i,l)=>l!==s)),E(a=>({...a,images:a.images.filter((i,l)=>l!==s)}))},H=s=>{s.preventDefault(),O()},M=s=>{R(s)},O=async()=>{if(!b){h("ログインが必要です");return}if(!r.name||!r.category_id||!r.address){h("必須項目を入力してください");return}n(!0),h("");try{const s={owner_id:b.id,name:r.name,category_id:r.category_id,address:r.address,phone:r.phone,website:r.website,description:r.description,status:"pending",created_at:new Date().toISOString()},a=await S.from("pet_facilities").insert(s).select().single(),{data:i,error:l}=a;if(l)throw console.error("Facility insertion error:",l),l;if(r.images.length>0&&i&&typeof i=="object"&&"id"in i){const I=r.images.map((z,G)=>({facility_id:i.id,image_data:z,is_primary:G===0,created_at:new Date().toISOString()})),{error:d}=await S.from("facility_images").insert(I);d&&(console.error("Image insertion error:",d),console.warn("画像の保存に失敗しましたが、施設登録は完了しました"))}c("施設の掲載申請が完了しました！管理者の承認後、地図に掲載されます。"),setTimeout(()=>{u("/dashboard")},2e3)}catch(s){console.error("❌ Submission error:",s);const a=s instanceof Error?s.message:"申請に失敗しました";h(a),s instanceof Error&&s.message.includes("アップロード")&&(console.error("📋 Storage upload troubleshooting:"),console.error("- Check if vaccine-certs bucket exists"),console.error("- Check storage policies"),console.error("- Check file size and format"),console.error("- User ID:",b?.id))}finally{n(!1)}},_=s=>{const{name:a,value:i}=s.target;p(l=>({...l,[a]:i}))},W=async()=>{if(b)try{n(!0);const{error:s}=await S.from("profiles").update({name:t.name,address:t.address,updated_at:new Date().toISOString()}).eq("id",b.id);if(s)throw console.error("User info update error:",s),new Error("ユーザー情報の更新に失敗しました");p(a=>({...a,isEditing:!1})),c("ユーザー情報を更新しました"),setTimeout(()=>c(""),3e3)}catch(s){console.error("Save user info error:",s),h(s instanceof Error?s.message:"ユーザー情報の更新に失敗しました")}finally{n(!1)}},P=()=>{W()},q=()=>{p({name:m?.name||"",address:m?.address||"",isEditing:!1})};return y?e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ペット関連施設登録"}),e.jsx("p",{className:"text-gray-600",children:"ペット関連施設の掲載申請を行います。管理者の承認後、地図に表示されます。"})]}),C&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(A,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:C})]})}),o&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(k,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"text-green-700",children:o})]})}),e.jsxs("form",{onSubmit:H,className:"space-y-6",children:[e.jsx(w,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(L,{className:"w-6 h-6 mr-2"}),"基本情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設名 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(f,{label:"施設名",name:"name",value:r.name,onChange:N,placeholder:"施設名を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["施設カテゴリ ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"category_id",value:r.category_id,onChange:N,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"カテゴリを選択してください"}),K.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["住所 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(f,{label:"住所",name:"address",value:r.address,onChange:N,placeholder:"住所を入力してください",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"電話番号"}),e.jsx(f,{label:"電話番号",name:"phone",value:r.phone,onChange:N,placeholder:"電話番号を入力してください"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ウェブサイト"}),e.jsx(f,{label:"ウェブサイト",name:"website",value:r.website,onChange:N,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"施設の説明"}),e.jsx("textarea",{name:"description",value:r.description,onChange:N,rows:4,placeholder:"施設の特徴やサービス内容を入力してください",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})]})}),e.jsx(w,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(L,{className:"w-6 h-6 mr-2"}),"ユーザー情報"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"名前"}),t.isEditing?e.jsx(f,{label:"名前",name:"name",value:t.name,onChange:_,placeholder:"名前を入力してください"}):e.jsx("p",{className:"text-gray-900",children:t.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),t.isEditing?e.jsx(f,{label:"住所",name:"address",value:t.address,onChange:_,placeholder:"住所を入力してください"}):e.jsx("p",{className:"text-gray-900",children:t.address})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:t.isEditing?e.jsxs(e.Fragment,{children:[e.jsx(j,{onClick:P,className:"mr-2",disabled:x,children:x?"保存中...":"保存"}),e.jsx(j,{onClick:q,disabled:x,children:"キャンセル"})]}):e.jsx(j,{onClick:()=>p(s=>({...s,isEditing:!0})),children:"編集"})})]})}),e.jsx(w,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(k,{className:"w-6 h-6 mr-2"}),"登録者情報の確認"]}),e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(A,{className:"w-5 h-5 text-blue-500 mr-2 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"登録者情報の確認"}),e.jsx("p",{className:"text-xs",children:"以下の情報をご確認ください。変更が必要な場合は編集できます。"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"氏名"}),t.isEditing?e.jsx(f,{label:"氏名",name:"name",value:t.name,onChange:_,placeholder:"氏名を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:t.name||"未設定"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"住所"}),t.isEditing?e.jsx(f,{label:"住所",name:"address",value:t.address,onChange:_,placeholder:"住所を入力してください",required:!0}):e.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-md",children:e.jsx("p",{className:"text-gray-900",children:t.address||"未設定"})})]}),e.jsx("div",{className:"flex gap-2",children:t.isEditing?e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:P,disabled:x,children:x?"保存中...":"保存"}),e.jsx(j,{type:"button",onClick:q,children:"キャンセル"})]}):e.jsx(j,{type:"button",onClick:()=>p(s=>({...s,isEditing:!0})),children:"編集"})})]})]})}),e.jsx(w,{className:"mb-6",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx(T,{className:"w-6 h-6 mr-2"}),"施設画像 (最大5枚)"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"画像をアップロード"}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:M,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:x||v.length>=5}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"JPG, PNG, GIF対応。1ファイル10MB以下。画像は自動的にリサイズ・圧縮されます。"})]}),U.length>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:U.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`施設画像 ${a+1}`,className:"w-full h-32 object-cover rounded-lg border border-gray-200"}),e.jsx("button",{type:"button",onClick:()=>B(a),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600",children:e.jsx(J,{className:"w-4 h-4"})}),a===0&&e.jsx("div",{className:"absolute bottom-1 left-1 bg-blue-500 text-white text-xs px-2 py-1 rounded",children:"メイン"})]},a))})]})}),e.jsx(w,{className:"mb-6",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(k,{className:"w-5 h-5 text-green-500 mr-2"}),e.jsx("span",{className:"font-medium text-green-800",children:"無料掲載期間実施中！"})]}),e.jsxs("p",{className:"text-green-700 mb-2",children:["現在、すべてのペット関連施設が",e.jsx("strong",{className:"text-lg",children:"無料"}),"で掲載できます。"]}),e.jsxs("ul",{className:"text-sm text-green-600 space-y-1",children:[e.jsx("li",{children:"• 本人確認手続きは不要です"}),e.jsx("li",{children:"• 月額料金は発生しません"}),e.jsx("li",{children:"• 申請後、管理者の承認を経て掲載開始となります"}),e.jsx("li",{children:"• 将来的に有料化する場合は事前にお知らせいたします"})]})]})})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(j,{type:"submit",disabled:x,children:x?"申請中...":"申請を送信する"})})]})]}):null}export{ae as default};
