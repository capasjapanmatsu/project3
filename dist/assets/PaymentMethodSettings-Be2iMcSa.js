import{j as e,V as s,Y as r,c as a,Z as t,_ as l,i as c,X as i,q as n,A as d,f as x,x as m,a0 as o,r as h}from"./ui-vendor-CTwuE44L.js";import{u,r as j,L as p}from"./react-vendor-BBLDtDmh.js";import{u as f,s as g,B as b,C as y}from"./index-BbveZyU8.js";import{I as N}from"./Input-CogJowp4.js";import"./query-vendor-9fkSW1iq.js";import"./supabase-vendor-BcfcqyaE.js";function v(){const{user:v}=f(),w=u(),[_,S]=j.useState(!0),[C,k]=j.useState(""),[D,q]=j.useState(""),[M,Y]=j.useState([]),[A,I]=j.useState(!1),[z,H]=j.useState(!1),[V,F]=j.useState({cardNumber:"",cardHolder:"",expiryMonth:"",expiryYear:"",cvv:"",isDefault:!1});j.useEffect(()=>{v?L():w("/login")},[v,w]);const L=async()=>{try{S(!0);const{data:e,error:s}=await g.from("payment_cards").select("*").eq("user_id",v?.id).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(s)throw s;Y(e||[])}catch(e){k("支払い方法の取得に失敗しました。")}finally{S(!1)}},W=s=>{switch(s){case"visa":return e.jsx("span",{className:"text-blue-600 font-bold",children:"VISA"});case"mastercard":return e.jsx("span",{className:"text-red-600 font-bold",children:"Mastercard"});case"amex":return e.jsx("span",{className:"text-blue-800 font-bold",children:"AMEX"});case"jcb":return e.jsx("span",{className:"text-green-600 font-bold",children:"JCB"});default:return e.jsx(r,{className:"w-5 h-5 text-gray-600"})}};return _?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4 mb-6",children:e.jsxs(p,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(s,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[e.jsx(r,{className:"w-8 h-8 text-blue-600 mr-3"}),"支払い方法の管理"]}),e.jsx("p",{className:"text-lg text-gray-600",children:"クレジットカード情報を管理します"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[e.jsx(p,{to:"/profile-settings",children:e.jsxs(b,{variant:"secondary",size:"sm",children:[e.jsx(a,{className:"w-4 h-4 mr-2"}),"プロフィール編集"]})}),e.jsx(p,{to:"/dogpark-history",children:e.jsxs(b,{variant:"secondary",size:"sm",children:[e.jsx(t,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),e.jsx(p,{to:"/orders",children:e.jsxs(b,{variant:"secondary",size:"sm",children:[e.jsx(l,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),e.jsx(p,{to:"/shop",children:e.jsxs(b,{variant:"secondary",size:"sm",children:[e.jsx(c,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),e.jsxs(y,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[e.jsx(r,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みのカード"]}),e.jsx(b,{onClick:()=>I(!A),size:"sm",children:A?e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"w-4 h-4 mr-1"}),"キャンセル"]}):e.jsxs(e.Fragment,{children:[e.jsx(n,{className:"w-4 h-4 mr-1"}),"カードを追加"]})})]}),C&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(d,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:C})]}),D&&e.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-green-800",children:D})]}),A&&e.jsxs("div",{className:"mb-6 p-6 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"新しいカードを追加"}),e.jsx("form",{onSubmit:async e=>{if(e.preventDefault(),k(""),q(""),(()=>{if(16!==V.cardNumber.replace(/\s/g,"").length)return k("カード番号は16桁で入力してください。"),!1;if(!V.cardHolder.trim())return k("カード名義人を入力してください。"),!1;if(!V.expiryMonth||!V.expiryYear)return k("有効期限を選択してください。"),!1;if(V.cvv.length<3)return k("CVVを正しく入力してください。"),!1;const e=new Date,s=e.getFullYear()%100,r=e.getMonth()+1,a=parseInt(V.expiryYear),t=parseInt(V.expiryMonth);return!(a<s||a===s&&t<r)||(k("有効期限が過去の日付です。"),!1)})()){H(!0);try{const e=V.cardNumber.replace(/\s/g,""),s="**** **** **** "+e.slice(-4),r=(e=>{const s=e.replace(/\s/g,"");return s.startsWith("4")?"visa":s.startsWith("5")||s.startsWith("2")?"mastercard":s.startsWith("3")?"amex":s.startsWith("35")?"jcb":"visa"})(e),{error:a}=await g.from("payment_cards").insert([{user_id:v?.id,card_number_masked:s,card_holder_name:V.cardHolder,expiry_month:parseInt(V.expiryMonth),expiry_year:parseInt(V.expiryYear),card_brand:r,is_default:V.isDefault||0===M.length}]);if(a)throw a;q("クレジットカードを登録しました"),I(!1),F({cardNumber:"",cardHolder:"",expiryMonth:"",expiryYear:"",cvv:"",isDefault:!1}),await L(),setTimeout(()=>{q("")},3e3)}catch(s){k("クレジットカードの登録に失敗しました。もう一度お試しください。")}finally{H(!1)}}},children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(N,{label:"カード番号 *",value:V.cardNumber,onChange:e=>{const s=e.target.value.replace(/\D/g,"").replace(/(.{4})/g,"$1 ").trim().slice(0,19);F({...V,cardNumber:s})},placeholder:"1234 5678 9012 3456",maxLength:19,required:!0}),e.jsx(N,{label:"カード名義人 *",value:V.cardHolder,onChange:e=>F({...V,cardHolder:e.target.value.toUpperCase()}),placeholder:"TARO YAMADA",required:!0}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"有効期限（月） *"}),e.jsxs("select",{value:V.expiryMonth,onChange:e=>F({...V,expiryMonth:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"月"}),Array.from({length:12},(s,r)=>e.jsx("option",{value:String(r+1).padStart(2,"0"),children:String(r+1).padStart(2,"0")},r+1))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"有効期限（年） *"}),e.jsxs("select",{value:V.expiryYear,onChange:e=>F({...V,expiryYear:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"年"}),Array.from({length:10},(s,r)=>{const a=(new Date).getFullYear()+r;return e.jsx("option",{value:String(a).slice(-2),children:a},a)})]})]}),e.jsx(N,{label:"CVV *",value:V.cvv,onChange:e=>F({...V,cvv:e.target.value.replace(/\D/g,"")}),placeholder:"123",maxLength:4,required:!0})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:V.isDefault,onChange:e=>F({...V,isDefault:e.target.checked}),className:"rounded text-blue-600"}),e.jsx("label",{htmlFor:"isDefault",className:"text-sm text-gray-700",children:"デフォルトの支払い方法として設定"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-2",children:[e.jsx(b,{type:"button",variant:"secondary",onClick:()=>I(!1),children:"キャンセル"}),e.jsx(b,{type:"submit",isLoading:z,children:"カードを追加"})]})]})})]}),0===M.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(r,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"登録されているカードはありません"}),e.jsxs(b,{onClick:()=>I(!0),children:[e.jsx(n,{className:"w-4 h-4 mr-2"}),"カードを追加する"]})]}):e.jsx("div",{className:"space-y-4",children:M.map(s=>e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white rounded-lg flex items-center justify-center border border-gray-300",children:W(s.card_brand)}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-semibold",children:s.card_number_masked}),s.is_default&&e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full flex items-center",children:[e.jsx(m,{className:"w-3 h-3 mr-1"}),"デフォルト"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.card_holder_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["有効期限: ",s.expiry_month.toString().padStart(2,"0"),"/",s.expiry_year.toString().padStart(2,"0")]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[!s.is_default&&e.jsxs(b,{size:"sm",variant:"secondary",onClick:()=>(async e=>{try{k(""),q("");const{error:s}=await g.from("payment_cards").update({is_default:!1}).eq("user_id",v?.id);if(s)throw s;const{error:r}=await g.from("payment_cards").update({is_default:!0}).eq("id",e);if(r)throw r;q("デフォルトの支払い方法を変更しました"),await L(),setTimeout(()=>{q("")},3e3)}catch(s){k("デフォルト設定の変更に失敗しました。")}})(s.id),children:[e.jsx(m,{className:"w-4 h-4 mr-1"}),"デフォルトに設定"]}),e.jsx(b,{size:"sm",variant:"secondary",className:"text-red-600 hover:text-red-700",onClick:()=>(async e=>{if(confirm("このカードを削除してもよろしいですか？"))try{k(""),q("");const{error:s}=await g.from("payment_cards").delete().eq("id",e);if(s)throw s;q("クレジットカードを削除しました"),await L(),setTimeout(()=>{q("")},3e3)}catch(s){k(s.message||"決済方法の削除に失敗しました")}})(s.id),children:e.jsx(o,{className:"w-4 h-4"})})]})]})},s.id))})]}),e.jsx(y,{className:"p-6 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(h,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"セキュリティ情報"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• カード情報は暗号化して安全に保存されます"}),e.jsx("p",{children:"• 実際のカード番号は保存されません"}),e.jsx("p",{children:"• 決済処理はSSL暗号化通信で行われます"}),e.jsx("p",{children:"• PCI DSS準拠のセキュリティ基準を満たしています"})]})]})]})})]})}export{v as PaymentMethodSettings};
