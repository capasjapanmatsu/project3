import{j as e,B as s,d as a,b as l}from"./index-rzoKNnex.js";import{u as r,r as t,L as i}from"./vendor-Cwmn0chA.js";import{I as n}from"./Input-DdOgOQvG.js";import{C as d}from"./Card-CRM3w0N8.js";import{l as c,f as m}from"./postalCodeLookup-BVBMVLy5.js";import{M as o,l as x,U as u,b as h,o as p,p as j,a as g,m as b}from"./ui-CMSAjam7.js";import"./supabase-Dzr8oIt2.js";function N(){const N=r(),[v,f]=t.useState(!1),[y,w]=t.useState(""),[C,k]=t.useState(!1),[T,q]=t.useState(!1),[L,S]=t.useState(""),[$,U]=t.useState(!1),[_,P]=t.useState({email:"",password:"",confirmPassword:"",userType:"user",name:"",postalCode:"",address:"",phoneNumber:""}),D=e=>{const s=e.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:_.phoneNumber},I=async e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:_.postalCode})(e);if(P({..._,postalCode:s}),7===s.replace(/-/g,"").length){q(!0),S("");try{const e=await c(s);if(e.success&&e.results&&e.results.length>0){const s=m(e.results[0]);P((e=>({...e,address:s})))}else S(e.message||"住所が見つかりませんでした")}catch(a){S("住所の検索中にエラーが発生しました")}finally{q(!1)}}};return C?e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(d,{className:"text-center p-8",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(o,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"メールを確認してください"}),e.jsxs("p",{className:"text-gray-600 mb-4",children:[_.email,"にログインリンクを送信しました。メールを確認してリンクをクリックしてください。"]}),e.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"メールが届かない場合は、迷惑メールフォルダを確認するか、別のメールアドレスでお試しください。"}),e.jsx(s,{onClick:()=>N("/login"),children:"ログイン画面に戻る"})]})}):e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold text-center mb-8",children:"新規登録"}),e.jsxs(d,{children:[e.jsxs("div",{className:"flex justify-center mb-4 space-x-2",children:[e.jsx(s,{type:"button",onClick:()=>U(!1),variant:$?"secondary":"primary",children:"Magic Link"}),e.jsx(s,{type:"button",onClick:()=>U(!0),variant:$?"primary":"secondary",children:"パスワード"})]}),$?e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),f(!0),w(""),!_.name.trim())return w("お名前を入力してください"),void f(!1);if(!_.postalCode.trim())return w("郵便番号を入力してください"),void f(!1);if(!_.address.trim())return w("住所を入力してください"),void f(!1);if(!_.phoneNumber.trim())return w("電話番号を入力してください"),void f(!1);if(!_.password)return w("パスワードを入力してください"),void f(!1);if(_.password.length<6)return w("パスワードは6文字以上で入力してください"),void f(!1);if(_.password!==_.confirmPassword)return w("パスワードが一致しません"),void f(!1);if(!/^\d{3}-\d{4}$/.test(_.postalCode))return w("郵便番号は7桁の数字で入力してください（例：1234567）"),void f(!1);if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(_.phoneNumber))return w("電話番号は正しい形式で入力してください（例：09012345678）"),void f(!1);try{a("lastUsedEmail",_.email);const{data:e,error:s}=await l.auth.signUp({email:_.email,password:_.password,options:{data:{user_type:_.userType,name:_.name,postal_code:_.postalCode,address:_.address,phone_number:_.phoneNumber}}});if(s)throw s;N("/two-factor-setup")}catch(s){const e=s.message||"";e.includes("already registered")||e.includes("already exists")||e.includes("User already")||e.includes("duplicate key")?w("このメールアドレスは既に登録されています"):w(e||"登録に失敗しました")}finally{f(!1)}},className:"p-6",children:[y&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:e.jsx("p",{children:y})})]}),e.jsx(n,{label:"お名前 *",value:_.name,onChange:e=>P({..._,name:e.target.value}),required:!0,placeholder:"山田太郎",icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(h,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:_.postalCode,onChange:e=>I(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${L?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),T&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(p,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),L&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:L})]}),e.jsx(n,{label:"住所 *",value:_.address,onChange:e=>P({..._,address:e.target.value}),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(h,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"電話番号 *",type:"tel",value:_.phoneNumber,onChange:e=>{const s=D(e.target.value);P({..._,phoneNumber:s})},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"メールアドレス *",type:"email",value:_.email,onChange:e=>P({..._,email:e.target.value}),required:!0,placeholder:"example@email.com",icon:e.jsx(o,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"パスワード *",type:"password",value:_.password,onChange:e=>P({..._,password:e.target.value}),required:!0,placeholder:"6文字以上",helperText:"6文字以上で入力してください",icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"パスワード確認 *",type:"password",value:_.confirmPassword,onChange:e=>P({..._,confirmPassword:e.target.value}),required:!0,placeholder:"パスワードを再入力",helperText:"パスワードを再入力してください",icon:e.jsx(b,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"user",checked:"user"===_.userType,onChange:e=>P({..._,userType:e.target.value}),className:"mr-2"}),"利用者"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"owner",checked:"owner"===_.userType,onChange:e=>P({..._,userType:e.target.value}),className:"mr-2"}),"施設オーナー"]})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(g,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-green-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"セキュリティ強化"}),e.jsx("p",{children:"パスワード登録後、2ファクタ認証（TOTP）の設定をお勧めします。Google Authenticatorなどの認証アプリでQRコードをスキャンするだけで簡単に設定できます。"})]})]})}),e.jsxs(s,{type:"submit",isLoading:v,className:"w-full",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"登録する"]})]}):e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),f(!0),w(""),!_.name.trim())return w("お名前を入力してください"),void f(!1);if(!_.postalCode.trim())return w("郵便番号を入力してください"),void f(!1);if(!_.address.trim())return w("住所を入力してください"),void f(!1);if(!_.phoneNumber.trim())return w("電話番号を入力してください"),void f(!1);if(!/^\d{3}-\d{4}$/.test(_.postalCode))return w("郵便番号は7桁の数字で入力してください（例：1234567）"),void f(!1);if(!/^0\d{2,3}-\d{1,4}-\d{4}$/.test(_.phoneNumber))return w("電話番号は正しい形式で入力してください（例：09012345678）"),void f(!1);try{a("lastUsedEmail",_.email);const{error:e}=await l.auth.signInWithOtp({email:_.email,options:{emailRedirectTo:`${window.location.origin}/dashboard`,data:{user_type:_.userType,name:_.name,postal_code:_.postalCode,address:_.address,phone_number:_.phoneNumber}}});if(e)throw e;k(!0)}catch(s){const e=s.message||"";e.includes("already registered")||e.includes("already exists")||e.includes("User already")||e.includes("duplicate key")?w("このメールアドレスは既に登録されています"):w(e||"登録に失敗しました")}finally{f(!1)}},className:"p-6",children:[y&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg flex items-start",children:[e.jsx(x,{className:"w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:e.jsx("p",{children:y})})]}),e.jsx(n,{label:"お名前 *",value:_.name,onChange:e=>P({..._,name:e.target.value}),required:!0,placeholder:"山田太郎",icon:e.jsx(u,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 * ",e.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(h,{className:"h-4 w-4 text-gray-500"})}),e.jsx("input",{type:"text",value:_.postalCode,onChange:e=>I(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${L?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8,required:!0}),T&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:e.jsx(p,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),L&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:L})]}),e.jsx(n,{label:"住所 *",value:_.address,onChange:e=>P({..._,address:e.target.value}),required:!0,placeholder:"東京都渋谷区渋谷1-1-1",icon:e.jsx(h,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"電話番号 *",type:"tel",value:_.phoneNumber,onChange:e=>{const s=D(e.target.value);P({..._,phoneNumber:s})},required:!0,placeholder:"09012345678（数字のみ入力）",maxLength:13,helperText:"認証に使用します。正確に入力してください。",icon:e.jsx(j,{className:"w-4 h-4 text-gray-500"})}),e.jsx(n,{label:"メールアドレス *",type:"email",value:_.email,onChange:e=>P({..._,email:e.target.value}),required:!0,placeholder:"example@email.com",icon:e.jsx(o,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"アカウントタイプ *"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"user",checked:"user"===_.userType,onChange:e=>P({..._,userType:e.target.value}),className:"mr-2"}),"利用者"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",value:"owner",checked:"owner"===_.userType,onChange:e=>P({..._,userType:e.target.value}),className:"mr-2"}),"施設オーナー"]})]})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),e.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",e.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",e.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(g,{className:"w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Magic Linkについて"}),e.jsx("p",{children:"登録後、入力したメールアドレスにログイン用のリンクが送信されます。リンクをクリックするだけで簡単にログインできます。"})]})]})}),e.jsxs(s,{type:"submit",isLoading:v,className:"w-full",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"登録する"]})]}),e.jsx("div",{className:"mt-4 text-center p-6",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["すでにアカウントをお持ちの方は",e.jsx(i,{to:"/login",className:"text-blue-600 hover:underline ml-1",children:"こちらからログイン"})]})})]})]})}export{N as Register};
