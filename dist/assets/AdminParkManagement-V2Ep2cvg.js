import{u as e,s as t,j as s,C as a,B as r}from"./index-BFgW40ku.js";import{u as n,r as i,L as c}from"./vendor-BHVjIt_u.js";import{I as l}from"./Input-BoeHj-kf.js";import{J as d,d as o,j as x,t as m,z as p,a4 as h,ay as g,aq as u,p as j,V as w,aB as v,C as y}from"./ui-Qz4g1iz4.js";import"./supabase-CKbzEL5D.js";function _(){const{isAdmin:_}=e(),f=n(),[N,b]=i.useState([]),[k,S]=i.useState([]),[L,C]=i.useState(!0),[$,q]=i.useState(""),[D,U]=i.useState(""),[E,F]=i.useState("all"),[I,O]=i.useState("created_at"),[z,P]=i.useState("desc");i.useEffect((()=>{_?B():f("/")}),[_,f]),i.useEffect((()=>{J()}),[N,D,E,I,z]);const B=async()=>{try{C(!0),q("");const{data:s,error:a}=await t.from("dog_parks").select("\n          id,\n          name,\n          address,\n          created_at,\n          status,\n          owner_id,\n          price,\n          max_capacity,\n          description,\n          facilities,\n          image_url,\n          cover_image_url\n        ");if(a)throw new Error("ドッグラン情報の取得に失敗しました");if(!s||0===s.length)return void b([]);let r=null;try{const{data:e,error:s}=await t.auth.admin.listUsers();s||(r=e)}catch(e){}const n=s.map((async e=>{try{const{data:s}=await t.from("profiles").select("name, user_type").eq("id",e.owner_id).single(),a=new Date;a.setDate(1),a.setHours(0,0,0,0);const{count:n}=await t.from("reservations").select("id",{count:"exact"}).eq("park_id",e.id).gte("created_at",a.toISOString()),{data:i}=await t.from("reservations").select("total_amount").eq("park_id",e.id).gte("created_at",a.toISOString()).not("total_amount","is",null),c=(i||[]).reduce(((e,t)=>e+(t.total_amount||0)),0),{data:l}=await t.from("reservations").select("total_amount").eq("park_id",e.id).not("total_amount","is",null),d=(l||[]).reduce(((e,t)=>e+(t.total_amount||0)),0),{data:o}=await t.from("dog_park_reviews").select("rating").eq("park_id",e.id),x=o?.length||0,m=x>0?(o||[]).reduce(((e,t)=>e+t.rating),0)/x:0,p=r?.users?.find((t=>t.id===e.owner_id)),h=p?.email;return{id:e.id,name:e.name,address:e.address,created_at:e.created_at,status:e.status,owner_name:s?.name||"Unknown",owner_email:h||`owner_${e.owner_id.slice(0,8)}@unknown.com`,price:e.price||0,max_capacity:e.max_capacity||0,average_rating:parseFloat(m.toFixed(1)),review_count:x,monthly_revenue:c,monthly_reservations:n||0,total_revenue:d,facilities:e.facilities||{parking:!1,shower:!1,restroom:!1,agility:!1,rest_area:!1,water_station:!1}}}catch(s){return{id:e.id,name:e.name||"Unknown Park",address:e.address||"Unknown Address",created_at:e.created_at,status:e.status||"pending",owner_name:"Unknown",owner_email:`owner_${e.owner_id.slice(0,8)}@unknown.com`,price:e.price||0,max_capacity:e.max_capacity||0,average_rating:0,review_count:0,monthly_revenue:0,monthly_reservations:0,total_revenue:0,facilities:{parking:!1,shower:!1,restroom:!1,agility:!1,rest_area:!1,water_station:!1}}}})),i=await Promise.all(n);b(i)}catch(s){q(`ドッグランデータの取得に失敗しました: ${s instanceof Error?s.message:"不明なエラー"}`)}finally{C(!1)}},J=()=>{let e=[...N];switch(D&&(e=e.filter((e=>e.name.toLowerCase().includes(D.toLowerCase())||e.address.toLowerCase().includes(D.toLowerCase())||e.owner_name.toLowerCase().includes(D.toLowerCase())))),E){case"pending":e=e.filter((e=>["pending","first_stage_passed","second_stage_review","qr_testing"].includes(e.status)));break;case"approved":e=e.filter((e=>"approved"===e.status));break;case"rejected":e=e.filter((e=>"rejected"===e.status))}e.sort(((e,t)=>{let s=e[I],a=t[I];return"created_at"===I&&(s=new Date(s).getTime(),a=new Date(a).getTime()),"asc"===z?s>a?1:-1:s<a?1:-1})),S(e)},R=e=>({pending:"第一審査待ち",first_stage_passed:"第二審査準備中",second_stage_review:"第二審査中",qr_testing:"QR実証検査中",approved:"承認済み",rejected:"却下"}[e]||e),T=e=>{const t={pending:{color:"bg-yellow-100 text-yellow-800",icon:y},first_stage_passed:{color:"bg-blue-100 text-blue-800",icon:y},second_stage_review:{color:"bg-purple-100 text-purple-800",icon:y},qr_testing:{color:"bg-orange-100 text-orange-800",icon:y},approved:{color:"bg-green-100 text-green-800",icon:m},rejected:{color:"bg-red-100 text-red-800",icon:v}},a=t[e]||t.pending,r=a.icon;return s.jsxs("div",{className:"flex items-center space-x-1",children:[s.jsx(r,{className:"w-4 h-4"}),s.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${a.color}`,children:R(e)})]})},A=e=>{const t={parking:"駐車場",shower:"シャワー",restroom:"トイレ",agility:"アジリティ",rest_area:"休憩所",water_station:"給水所"},s=Object.entries(e).filter((([e,t])=>t)).map((([e,s])=>t[e]));return s.slice(0,3).join(", ")+(s.length>3?" +"+(s.length-3):"")};if(L)return s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})});const V=N.reduce(((e,t)=>e+t.monthly_revenue),0),H=N.length>0?N.reduce(((e,t)=>e+t.average_rating),0)/N.length:0;return s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"flex items-center space-x-4 mb-6",children:s.jsxs(c,{to:"/admin",className:"flex items-center text-gray-600 hover:text-gray-800",children:[s.jsx(d,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[s.jsx(o,{className:"w-8 h-8 text-green-600 mr-3"}),"ドッグラン管理"]}),s.jsx("p",{className:"text-gray-600",children:"ドッグラン施設の詳細情報と管理"})]}),s.jsxs("div",{className:"text-sm text-gray-500",children:["総施設数: ",N.length,"施設"]})]}),$&&s.jsx("div",{className:"bg-red-100 border border-red-300 text-red-800 rounded-lg p-4",children:$}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"総施設数"}),s.jsx("p",{className:"text-xl font-bold text-green-600",children:N.length})]}),s.jsx(x,{className:"w-6 h-6 text-green-600"})]})}),s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"承認済み"}),s.jsx("p",{className:"text-xl font-bold text-blue-600",children:N.filter((e=>"approved"===e.status)).length})]}),s.jsx(m,{className:"w-6 h-6 text-blue-600"})]})}),s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"平均評価"}),s.jsx("p",{className:"text-xl font-bold text-yellow-600",children:H.toFixed(1)})]}),s.jsx(p,{className:"w-6 h-6 text-yellow-600"})]})}),s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:"月間総売上"}),s.jsxs("p",{className:"text-xl font-bold text-orange-600",children:["¥",V.toLocaleString()]})]}),s.jsx(h,{className:"w-6 h-6 text-orange-600"})]})})]}),s.jsxs(a,{className:"p-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[s.jsx("div",{className:"md:col-span-2",children:s.jsx(l,{label:"検索",placeholder:"施設名、住所、オーナー名で検索...",value:D,onChange:e=>U(e.target.value),icon:s.jsx(g,{className:"w-4 h-4 text-gray-500"})})}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ステータス"}),s.jsxs("select",{value:E,onChange:e=>F(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[s.jsx("option",{value:"all",children:"すべて"}),s.jsx("option",{value:"pending",children:"審査中"}),s.jsx("option",{value:"approved",children:"承認済み"}),s.jsx("option",{value:"rejected",children:"却下"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"並び順"}),s.jsxs("select",{value:`${I}-${z}`,onChange:e=>{const[t,s]=e.target.value.split("-");O(t),P(s)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",children:[s.jsx("option",{value:"created_at-desc",children:"登録日（新しい順）"}),s.jsx("option",{value:"created_at-asc",children:"登録日（古い順）"}),s.jsx("option",{value:"name-asc",children:"施設名（昇順）"}),s.jsx("option",{value:"name-desc",children:"施設名（降順）"}),s.jsx("option",{value:"monthly_revenue-desc",children:"売上（高い順）"}),s.jsx("option",{value:"monthly_revenue-asc",children:"売上（低い順）"}),s.jsx("option",{value:"average_rating-desc",children:"評価（高い順）"}),s.jsx("option",{value:"average_rating-asc",children:"評価（低い順）"})]})]})]}),s.jsxs("div",{className:"flex justify-between items-center mt-4",children:[s.jsxs("p",{className:"text-sm text-gray-600",children:[k.length,"件の施設が見つかりました"]}),s.jsxs(r,{variant:"secondary",size:"sm",onClick:()=>{const e=[["施設名","住所","オーナー","ステータス","登録日","料金","定員","評価","月間売上","月間予約数"],...k.map((e=>[e.name,e.address,e.owner_name,R(e.status),new Date(e.created_at).toLocaleDateString("ja-JP"),`¥${e.price.toLocaleString()}`,`${e.max_capacity}人`,`${e.average_rating.toFixed(1)} (${e.review_count}件)`,`¥${e.monthly_revenue.toLocaleString()}`,`${e.monthly_reservations}件`]))].map((e=>e.join(","))).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`parks_${(new Date).toISOString().split("T")[0]}.csv`,s.click()},children:[s.jsx(u,{className:"w-4 h-4 mr-1"}),"CSV出力"]})]})]}),s.jsx(a,{children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"施設情報"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"オーナー"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"登録日"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ステータス"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"料金・定員"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"評価・売上"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:k.map((e=>s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),s.jsx("div",{className:"text-sm text-gray-500",children:e.address}),s.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["設備: ",A(e.facilities)]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.owner_name}),s.jsx("div",{className:"text-sm text-gray-500",children:e.owner_email})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:T(e.status)}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"text-gray-900",children:["¥",e.price.toLocaleString(),"/日"]}),s.jsxs("div",{className:"text-gray-500",children:["定員: ",e.max_capacity,"人"]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex items-center text-gray-900",children:[s.jsx(p,{className:"w-4 h-4 mr-1 text-yellow-400 fill-current"}),e.average_rating.toFixed(1)," (",e.review_count,"件)"]}),s.jsxs("div",{className:"text-gray-500",children:["売上: ¥",e.monthly_revenue.toLocaleString(),"/月"]}),s.jsxs("div",{className:"text-gray-500",children:["予約: ",e.monthly_reservations,"件/月"]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(r,{size:"sm",variant:"secondary",onClick:()=>f(`/parks/${e.id}`),children:s.jsx(j,{className:"w-4 h-4"})}),s.jsx(r,{size:"sm",variant:"secondary",onClick:()=>f(`/admin/parks/${e.id}/analytics`),children:s.jsx(w,{className:"w-4 h-4"})})]})})]},e.id)))})]})})})]})}export{_ as AdminParkManagement};
