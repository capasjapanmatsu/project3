import{u as D,b as O,l as x,s as p,j as e,C as o,B as m,k as b}from"./index-BB1ywuBb.js";import{u as R,r as j,L as w}from"./react-vendor-Co5xHYdE.js";import{S as y,a3 as k,A as B,aw as I,x as M,w as L,ax as q,$,s as J}from"./ui-vendor-B2-VOB5s.js";import"./supabase-vendor-FDBaXLCh.js";function Q(){const{user:c}=D(),g=R(),[l,A]=j.useState([]),[P,E]=j.useState(!0),{isActive:i}=O(),[v,n]=j.useState(null);j.useEffect(()=>{if(c&&h(),new URLSearchParams(window.location.search).get("canceled")==="true"){n("決済がキャンセルされました。カートから商品を確認できます。"),window.history.replaceState({},document.title,window.location.pathname);const t=localStorage.getItem("pre_payment_auth_state");if(t)try{const r=JSON.parse(t);x("info","🛒 Cart: Pre-payment auth state found",{authState:r}),(!c||c.id!==r.user_id)&&(console.warn("⚠️ Cart: Authentication state mismatch after payment cancellation"),n("セッションが切断されました。再度ログインしてください。"),setTimeout(()=>{g("/login")},3e3)),localStorage.removeItem("pre_payment_auth_state")}catch(r){x("error","Failed to parse pre-payment auth state",{error:r})}}},[c,g]);const h=async()=>{try{const{data:s,error:t}=await p.from("cart_items").select("*, product:products(*)").eq("user_id",c?.id).order("created_at",{ascending:!1});if(t)throw t;A(s||[])}catch(s){n(s.message||"カート情報の取得に失敗しました")}finally{E(!1)}},S=async(s,t)=>{if(t<=0){await C(s);return}try{const r=await b(()=>p.from("cart_items").update({quantity:t}).eq("id",s));if(r.error)throw r.error;await h()}catch(r){x("error","Error updating quantity",{error:r,cartItemId:s,newQuantity:t}),n("数量の更新に失敗しました。再度お試しください。")}},C=async s=>{try{const t=await b(()=>p.from("cart_items").delete().eq("id",s));if(t.error)throw t.error;await h()}catch(t){x("error","Error removing item",{error:t,cartItemId:s}),n("商品の削除に失敗しました。再度お試しください。")}},F=async()=>{try{const s=await b(()=>p.from("cart_items").delete().eq("user_id",c?.id));if(s.error)throw s.error;await h()}catch(s){x("error","Error clearing cart",{error:s,userId:c?.id}),n("カートの削除に失敗しました。再度お試しください。")}},_=s=>i?Math.round(s*.9):s,a=()=>{const s=l.reduce((f,d)=>{const z=_(d.product.price);return f+z*d.quantity},0),t=l.reduce((f,d)=>f+d.product.price*d.quantity,0),r=t-s,u=s>=5e3||i?0:690,N=s+u;return{subtotal:s,originalSubtotal:t,discountAmount:r,shippingFee:u,total:N}},T=()=>{if(l.length===0){n("カートに商品がありません。");return}g("/checkout",{state:{cartItems:l.map(s=>s.id),totals:a()}})};return P?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):l.length===0?e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-8 flex items-center",children:[e.jsx(y,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート"]}),e.jsxs(o,{className:"text-center py-12",children:[e.jsx(y,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"カートは空です"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"お気に入りの商品をカートに追加してください"}),e.jsx(w,{to:"/shop",children:e.jsx(m,{className:"bg-green-600 hover:bg-green-700",children:"ショッピングを続ける"})})]})]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[e.jsx(y,{className:"w-8 h-8 text-green-600 mr-3"}),"ショッピングカート (",l.length,"点)"]}),e.jsxs(m,{variant:"secondary",onClick:F,className:"text-red-600 hover:text-red-700",children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"カートを空にする"]})]}),v&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[e.jsx(B,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-red-800",children:v})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-4",children:l.map(s=>{const t=s.product.price,r=_(t),u=i&&r<t;return e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:s.product.image_url,alt:s.product.name,className:"w-20 h-20 object-cover rounded-lg",onError:N=>{N.currentTarget.src="https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg"}})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.product.name}),s.product.brand&&e.jsx("p",{className:"text-sm text-gray-500",children:s.product.brand}),e.jsxs("div",{className:"mt-1 space-y-1 text-xs text-gray-500",children:[s.product.weight&&e.jsxs("p",{children:["内容量: ",s.product.weight,"g"]}),s.product.size&&e.jsxs("p",{children:["サイズ: ",s.product.size]})]})]}),e.jsx("button",{onClick:()=>C(s.id),className:"text-red-500 hover:text-red-700 p-1",children:e.jsx(k,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["¥",r.toLocaleString()]}),u&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["¥",t.toLocaleString()]})]}),i&&e.jsx("p",{className:"text-xs text-purple-600",children:"サブスク会員価格"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>S(s.id,s.quantity-1),className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(I,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium w-8 text-center",children:s.quantity}),e.jsx("button",{onClick:()=>S(s.id,s.quantity+1),className:"w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700 transition-colors",children:e.jsx(M,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsxs("span",{className:"text-lg font-semibold",children:["小計: ¥",(r*s.quantity).toLocaleString()]})})]})]})},s.id)})}),e.jsxs("div",{className:"space-y-6",children:[i?e.jsxs(o,{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(L,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスク会員特典"})]}),e.jsx("p",{className:"text-sm",children:"全商品10%OFF + 送料無料"})]}):e.jsxs(o,{className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(L,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:"サブスクリプションでもっとお得に！"})]}),e.jsx("p",{className:"text-sm mb-3",children:"全商品10%OFF + 送料無料"}),e.jsx(w,{to:"/subscription",children:e.jsx(m,{size:"sm",className:"bg-white text-purple-600 hover:bg-gray-100",children:"詳細を見る"})})]}),e.jsxs(o,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"注文サマリー"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"商品小計"}),e.jsxs("span",{children:["¥",a().originalSubtotal.toLocaleString()]})]}),a().discountAmount>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsx("span",{children:"サブスク割引 (10%)"}),e.jsxs("span",{children:["-¥",a().discountAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),"送料"]}),e.jsx("span",{children:a().shippingFee===0?e.jsx("span",{className:"text-green-600",children:"無料"}):`¥${a().shippingFee.toLocaleString()}`})]}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"合計"}),e.jsxs("span",{className:"text-green-600",children:["¥",a().total.toLocaleString()]})]})]}),!i&&a().subtotal<5e3&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["あと¥",(5e3-a().subtotal).toLocaleString(),"で送料無料！"]})}),e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsxs(m,{onClick:T,className:"w-full bg-green-600 hover:bg-green-700 text-lg py-3",children:[e.jsx($,{className:"w-5 h-5 mr-2"}),"レジに進む",e.jsx(J,{className:"w-5 h-5 ml-2"})]}),e.jsx(w,{to:"/shop",children:e.jsx(m,{variant:"secondary",className:"w-full",children:"ショッピングを続ける"})})]})]}),e.jsx(o,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(q,{className:"w-6 h-6 text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"配送について"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("p",{children:"• 送料：全国一律¥690"}),e.jsxs("p",{children:["• ¥5,000以上のご注文で",e.jsx("span",{className:"font-medium",children:"送料無料"})]}),e.jsxs("p",{children:["• サブスク会員は",e.jsx("span",{className:"font-medium",children:"常に送料無料"})]}),e.jsx("p",{children:"• 平日14時までのご注文で翌日お届け"}),e.jsx("p",{children:"• 土日祝日も配送いたします"}),e.jsx("p",{children:"• 時間指定配送も可能です"})]})]})]})})]})]})]})}export{Q as Cart};
