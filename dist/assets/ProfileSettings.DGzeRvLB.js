var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,n=(s,a,r)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[a]=r,i=(e,s)=>{for(var a in s||(s={}))t.call(s,a)&&n(e,a,s[a]);if(r)for(var a of r(s))l.call(s,a)&&n(e,a,s[a]);return e},d=(e,r)=>s(e,a(r)),c=(e,s,a)=>new Promise((r,t)=>{var l=e=>{try{i(a.next(e))}catch(s){t(s)}},n=e=>{try{i(a.throw(e))}catch(s){t(s)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,n);i((a=a.apply(e,s)).next())});import{u as o,s as m,j as x,B as h,C as u}from"./index.CQlxbczY.js";import{r as j}from"./vendor.CKEClKZl.js";import{u as p,L as b}from"./router.B_7Atevv.js";import{I as f}from"./Input.DMWrIIWM.js";import{l as g,f as w}from"./postalCodeLookup.kCzjIztC.js";import{z as N,c as v,G as y,J as P,N as _,j as k,A as S,g as C,M as q,H as O,b as z,d as E,s as L,O as D,q as I,K as A,Q as F,h as U,a as $,X as T}from"./ui.C72fRZ1L.js";import"./supabase.X3H3st79.js";function B(){const{user:e}=o(),s=p(),[a,r]=j.useState(!0),[t,l]=j.useState(!1),[n,B]=j.useState(""),[G,H]=j.useState(""),[J,K]=j.useState({name:"",nickname:"",postal_code:"",address:"",phone_number:"",email:""}),[M,Q]=j.useState({name:"",nickname:"",postal_code:"",address:"",phone_number:"",email:""}),[W,R]=j.useState(!1),[V,X]=j.useState(!1),[Y,Z]=j.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[ee,se]=j.useState(""),[ae,re]=j.useState(!1),[te,le]=j.useState(!1),[ne,ie]=j.useState(""),[de,ce]=j.useState(""),[oe,me]=j.useState(""),[xe,he]=j.useState(!1),[ue,je]=j.useState(""),[pe,be]=j.useState([]),[fe,ge]=j.useState("loading");j.useEffect(()=>{e?(we(),Ne()):s("/login")},[e,s]);const we=()=>c(this,null,function*(){try{r(!0);const{data:s,error:a}=yield m.from("profiles").select("*").eq("id",null==e?void 0:e.id).single();if(a)throw a;const t={name:s.name||"",nickname:s.nickname||"",postal_code:s.postal_code||"",address:s.address||"",phone_number:s.phone_number||"",email:(null==e?void 0:e.email)||""};K(t),Q(t)}catch(s){B(s.message||"プロフィールの取得に失敗しました。")}finally{r(!1)}}),Ne=()=>c(this,null,function*(){try{ge("loading");const{data:e,error:s}=yield m.auth.mfa.listFactors();if(s)throw s;const a=e.totp.filter(e=>"verified"===e.status);be(a),ge(a.length>0?"enabled":"disabled")}catch(e){ge("disabled")}}),ve=e=>c(this,null,function*(){if(confirm("2ファクタ認証を無効にしますか？セキュリティが低下します。"))try{const{error:s}=yield m.auth.mfa.unenroll({factorId:e});if(s)throw s;yield Ne()}catch(s){B("2FAの無効化に失敗しました")}}),ye=e=>c(this,null,function*(){const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=7?s.length>3?s.slice(0,3)+"-"+s.slice(3):s:J.postal_code})(e);if(K(d(i({},J),{postal_code:s})),7===s.replace(/-/g,"").length){he(!0),je("");try{const e=yield g(s);if(e.success&&e.results&&e.results.length>0){const s=w(e.results[0]);K(e=>d(i({},e),{address:s}))}else je(e.message||"住所が見つかりませんでした")}catch(a){je("住所の検索中にエラーが発生しました")}finally{he(!1)}}});return a?x.jsx("div",{className:"flex justify-center items-center h-64",children:x.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):x.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[x.jsx("div",{className:"flex items-center space-x-4 mb-6",children:x.jsxs(b,{to:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[x.jsx(N,{className:"w-4 h-4 mr-2"}),"ダッシュボードに戻る"]})}),x.jsxs("div",{className:"text-center mb-8",children:[x.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-4 flex items-center justify-center",children:[x.jsx(v,{className:"w-8 h-8 text-blue-600 mr-3"}),"プロフィール設定"]}),x.jsx("p",{className:"text-lg text-gray-600",children:"アカウント情報を管理します"})]}),x.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-6",children:[x.jsx(b,{to:"/payment-method-settings",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(y,{className:"w-4 h-4 mr-2"}),"支払い方法"]})}),x.jsx(b,{to:"/dogpark-history",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(P,{className:"w-4 h-4 mr-2"}),"利用履歴"]})}),x.jsx(b,{to:"/orders",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(_,{className:"w-4 h-4 mr-2"}),"注文履歴"]})}),x.jsx(b,{to:"/shop",children:x.jsxs(h,{variant:"secondary",size:"sm",children:[x.jsx(k,{className:"w-4 h-4 mr-2"}),"ショップ"]})})]}),x.jsx(u,{className:"p-6",children:x.jsxs("form",{onSubmit:s=>c(this,null,function*(){s.preventDefault(),l(!0),B(""),H("");try{if(!J.name.trim())throw new Error("お名前を入力してください");if(J.postal_code&&!J.postal_code.match(/^\d{3}-\d{4}$/))throw new Error("郵便番号は正しい形式で入力してください（例：123-4567）");if(J.phone_number&&!J.phone_number.match(/^0\d{2,3}-\d{1,4}-\d{4}$/))throw new Error("電話番号は正しい形式で入力してください（例：090-1234-5678）");const s=M.postal_code!==J.postal_code||M.address!==J.address;let a=!1;if(s){const{data:s,error:r}=yield m.from("owner_verifications").select("id, status").eq("user_id",null==e?void 0:e.id).eq("status","verified").single();r&&r.code,s&&(a=!0)}const{error:r}=yield m.from("profiles").update({name:J.name,nickname:J.nickname,postal_code:J.postal_code,address:J.address,phone_number:J.phone_number}).eq("id",null==e?void 0:e.id);if(r)throw r;if(a){const{error:s}=yield m.from("owner_verifications").update({status:"pending",updated_at:(new Date).toISOString()}).eq("user_id",null==e?void 0:e.id),{error:a}=yield m.from("notifications").insert([{user_id:null==e?void 0:e.id,type:"identity_verification",title:"住所変更により本人確認が必要です",message:"住所を変更されたため、本人確認書類を再度提出する必要があります。ドッグラン施設の登録を継続される場合は、本人確認書類をアップロードしてください。",data:{reason:"address_change"}}])}if((null==e?void 0:e.email)!==J.email){const{error:e}=yield m.auth.updateUser({email:J.email});if(e)throw e}Q(J);let t="プロフィールを更新しました";a&&(t+="\n\n住所変更により本人確認が必要になりました。ドッグラン施設の登録を継続される場合は、本人確認書類を再度アップロードしてください。"),H(t),setTimeout(()=>{H("")},3e3)}catch(a){B(a.message||"プロフィールの更新に失敗しました")}finally{l(!1)}}),children:[n&&x.jsxs("div",{className:"mb-6 p-4 bg-red-50 rounded-lg flex items-start",children:[x.jsx(S,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),x.jsx("p",{className:"text-red-800",children:n})]}),G&&x.jsxs("div",{className:"mb-6 p-4 bg-green-50 rounded-lg flex items-start",children:[x.jsx(C,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),x.jsx("p",{className:"text-green-800",children:G})]}),x.jsxs("div",{className:"space-y-6",children:[x.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[x.jsx(v,{className:"w-6 h-6 text-blue-600"}),x.jsx("h2",{className:"text-xl font-semibold",children:"基本情報"})]}),x.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[x.jsx(f,{label:"お名前 *",value:J.name,onChange:e=>K(d(i({},J),{name:e.target.value})),required:!0,icon:x.jsx(v,{className:"w-4 h-4 text-gray-500"})}),x.jsx(f,{label:"ニックネーム",value:J.nickname,onChange:e=>K(d(i({},J),{nickname:e.target.value})),placeholder:"表示名やニックネームを入力（任意）",icon:x.jsx(v,{className:"w-4 h-4 text-gray-500"})}),x.jsx(f,{label:"メールアドレス *",type:"email",value:J.email,onChange:e=>K(d(i({},J),{email:e.target.value})),required:!0,icon:x.jsx(q,{className:"w-4 h-4 text-gray-500"})})]}),x.jsxs("div",{className:"flex items-center space-x-3 mb-6 mt-8",children:[x.jsx(O,{className:"w-6 h-6 text-blue-600"}),x.jsx("h2",{className:"text-xl font-semibold",children:"住所情報"})]}),x.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[x.jsxs("div",{className:"mb-4 relative",children:[x.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["郵便番号 ",x.jsx("span",{className:"text-xs text-blue-600",children:"(入力すると住所が自動入力されます)"})]}),x.jsxs("div",{className:"relative",children:[x.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:x.jsx(z,{className:"h-4 w-4 text-gray-500"})}),x.jsx("input",{type:"text",value:J.postal_code,onChange:e=>ye(e.target.value),className:`w-full pl-10 pr-10 py-2 border ${ue?"border-red-500":"border-gray-300"} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"123-4567（数字のみ入力）",maxLength:8}),xe&&x.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:x.jsx(E,{className:"h-4 w-4 text-blue-500 animate-spin"})})]}),ue&&x.jsx("p",{className:"mt-1 text-sm text-red-600",children:ue})]}),x.jsx(f,{label:"電話番号",value:J.phone_number,onChange:e=>{const s=(e=>{const s=e.replace(/\D/g,"");return s.length<=11?s.length>7?s.slice(0,3)+"-"+s.slice(3,7)+"-"+s.slice(7):s.length>3?s.slice(0,3)+"-"+s.slice(3):s:J.phone_number})(e.target.value);K(d(i({},J),{phone_number:s}))},placeholder:"090-1234-5678",maxLength:13,icon:x.jsx(L,{className:"w-4 h-4 text-gray-500"})})]}),x.jsx("div",{className:"col-span-2",children:x.jsx(f,{label:"住所",value:J.address,onChange:e=>K(d(i({},J),{address:e.target.value})),placeholder:"東京都渋谷区渋谷1-1-1",icon:x.jsx(O,{className:"w-4 h-4 text-gray-500"})})}),x.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:x.jsxs("p",{className:"text-sm text-blue-800",children:[x.jsx("span",{className:"font-medium",children:"※ 入力のヒント"}),x.jsx("br",{}),"• 郵便番号：数字のみ入力（例：1234567）",x.jsx("br",{}),"• 電話番号：数字のみ入力（例：09012345678）",x.jsx("br",{}),"ハイフンは自動で挿入されます。"]})}),x.jsx("div",{className:"flex justify-end",children:x.jsxs(h,{type:"submit",isLoading:t,className:"bg-blue-600 hover:bg-blue-700",children:[x.jsx(D,{className:"w-4 h-4 mr-2"}),"保存する"]})})]})]})}),x.jsxs(u,{className:"p-6 bg-gray-50",children:[x.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[x.jsx(I,{className:"w-6 h-6 text-yellow-600"}),x.jsx("h2",{className:"text-xl font-semibold",children:"アカウント設定"})]}),x.jsxs("div",{className:"space-y-4",children:[x.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[x.jsx("h3",{className:"font-semibold mb-2",children:"パスワード変更"}),x.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを保つため、定期的にパスワードを変更することをおすすめします。"}),x.jsxs(h,{variant:"secondary",size:"sm",onClick:()=>R(!0),children:[x.jsx(A,{className:"w-4 h-4 mr-2"}),"パスワードを変更"]})]}),x.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[x.jsx("h3",{className:"font-semibold mb-2",children:"アカウント削除"}),x.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントを削除すると、すべてのデータが完全に削除され、復元できなくなります。"}),x.jsxs(h,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>X(!0),children:[x.jsx(F,{className:"w-4 h-4 mr-2"}),"アカウントを削除"]})]}),x.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200",children:[x.jsx("h3",{className:"font-semibold mb-2",children:"2ファクタ認証（2FA）"}),x.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"アカウントのセキュリティを強化するため、2ファクタ認証の設定をおすすめします。"}),"loading"===fe?x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(E,{className:"w-4 h-4 animate-spin"}),x.jsx("span",{className:"text-sm text-gray-600",children:"読み込み中..."})]}):"enabled"===fe?x.jsxs("div",{className:"space-y-3",children:[x.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[x.jsx(C,{className:"w-4 h-4"}),x.jsx("span",{className:"text-sm font-medium",children:"2FAが有効です"})]}),pe.map(e=>x.jsxs("div",{className:"flex items-center justify-between p-2 bg-green-50 rounded border border-green-200",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(U,{className:"w-4 h-4 text-green-600"}),x.jsx("span",{className:"text-sm",children:e.friendly_name||"認証アプリ"})]}),x.jsx(h,{variant:"secondary",size:"sm",className:"text-red-600 hover:text-red-700 border-red-300 hover:border-red-400",onClick:()=>ve(e.id),children:"無効化"})]},e.id))]}):x.jsxs(h,{variant:"secondary",size:"sm",onClick:()=>{s("/two-factor-setup")},children:[x.jsx($,{className:"w-4 h-4 mr-2"}),"2FAを有効化"]})]})]})]}),W&&x.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:x.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[x.jsxs("div",{className:"flex justify-between items-center mb-4",children:[x.jsx("h3",{className:"text-xl font-bold",children:"パスワード変更"}),x.jsx("button",{onClick:()=>{R(!1),ie(""),ce(""),Z({currentPassword:"",newPassword:"",confirmPassword:""})},className:"text-gray-500 hover:text-gray-700",children:x.jsx(T,{className:"w-6 h-6"})})]}),ne&&x.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:x.jsxs("div",{className:"flex items-start space-x-2",children:[x.jsx(S,{className:"w-5 h-5 text-red-600 mt-0.5"}),x.jsx("p",{className:"text-sm text-red-800",children:ne})]})}),de&&x.jsx("div",{className:"mb-4 p-3 bg-green-50 rounded-lg",children:x.jsxs("div",{className:"flex items-start space-x-2",children:[x.jsx(C,{className:"w-5 h-5 text-green-600 mt-0.5"}),x.jsx("p",{className:"text-sm text-green-800",children:de})]})}),x.jsx("form",{onSubmit:s=>c(this,null,function*(){s.preventDefault(),re(!0),ie(""),ce("");try{if(!Y.currentPassword)throw new Error("現在のパスワードを入力してください");if(!Y.newPassword)throw new Error("新しいパスワードを入力してください");if(Y.newPassword.length<6)throw new Error("パスワードは6文字以上で入力してください");if(Y.newPassword!==Y.confirmPassword)throw new Error("新しいパスワードと確認用パスワードが一致しません");const{error:s}=yield m.auth.signInWithPassword({email:(null==e?void 0:e.email)||"",password:Y.currentPassword});if(s)throw new Error("現在のパスワードが正しくありません");const{error:a}=yield m.auth.updateUser({password:Y.newPassword});if(a)throw a;ce("パスワードを変更しました"),Z({currentPassword:"",newPassword:"",confirmPassword:""}),setTimeout(()=>{R(!1),ce("")},3e3)}catch(a){ie(a.message||"パスワードの変更に失敗しました")}finally{re(!1)}}),children:x.jsxs("div",{className:"space-y-4",children:[x.jsx(f,{label:"現在のパスワード *",type:"password",value:Y.currentPassword,onChange:e=>Z(d(i({},Y),{currentPassword:e.target.value})),required:!0}),x.jsx(f,{label:"新しいパスワード *",type:"password",value:Y.newPassword,onChange:e=>Z(d(i({},Y),{newPassword:e.target.value})),required:!0,minLength:6}),x.jsx(f,{label:"新しいパスワード（確認） *",type:"password",value:Y.confirmPassword,onChange:e=>Z(d(i({},Y),{confirmPassword:e.target.value})),required:!0,minLength:6}),x.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:x.jsxs("p",{className:"text-sm text-blue-800",children:[x.jsx("span",{className:"font-medium",children:"パスワードの要件"}),x.jsx("br",{}),"• 6文字以上",x.jsx("br",{}),"• 英数字を含めることをおすすめします",x.jsx("br",{}),"• 以前使用したパスワードと異なるものを使用してください"]})}),x.jsxs("div",{className:"flex justify-end space-x-3",children:[x.jsx(h,{type:"button",variant:"secondary",onClick:()=>{R(!1),ie(""),ce(""),Z({currentPassword:"",newPassword:"",confirmPassword:""})},children:"キャンセル"}),x.jsx(h,{type:"submit",isLoading:ae,children:"パスワードを変更"})]})]})})]})}),V&&x.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:x.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[x.jsxs("div",{className:"flex justify-between items-center mb-4",children:[x.jsx("h3",{className:"text-xl font-bold text-red-600",children:"アカウント削除"}),x.jsx("button",{onClick:()=>{X(!1),me(""),se("")},className:"text-gray-500 hover:text-gray-700",children:x.jsx(T,{className:"w-6 h-6"})})]}),oe&&x.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg",children:x.jsxs("div",{className:"flex items-start space-x-2",children:[x.jsx(S,{className:"w-5 h-5 text-red-600 mt-0.5"}),x.jsx("p",{className:"text-sm text-red-800",children:oe})]})}),x.jsx("div",{className:"p-4 bg-red-50 rounded-lg mb-4",children:x.jsxs("div",{className:"flex items-start space-x-2",children:[x.jsx(S,{className:"w-5 h-5 text-red-600 mt-0.5"}),x.jsxs("div",{children:[x.jsx("p",{className:"font-medium text-red-800 mb-1",children:"警告: この操作は取り消せません"}),x.jsx("p",{className:"text-sm text-red-700",children:"アカウントを削除すると、以下のデータがすべて完全に削除されます："}),x.jsxs("ul",{className:"text-sm text-red-700 list-disc list-inside mt-2 space-y-1",children:[x.jsx("li",{children:"プロフィール情報"}),x.jsx("li",{children:"登録したワンちゃんの情報"}),x.jsx("li",{children:"予約履歴"}),x.jsx("li",{children:"支払い情報"}),x.jsx("li",{children:"友達リストとメッセージ"})]})]})]})}),x.jsx("form",{onSubmit:a=>c(this,null,function*(){a.preventDefault(),le(!0),me("");try{if("delete"!==ee)throw new Error("確認のため「delete」と入力してください");const{error:a}=yield m.auth.admin.deleteUser((null==e?void 0:e.id)||"");if(a)throw a;yield m.auth.signOut(),s("/",{replace:!0})}catch(r){me(r.message||"アカウントの削除に失敗しました")}finally{le(!1)}}),children:x.jsxs("div",{className:"space-y-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"確認のため「delete」と入力してください *"}),x.jsx("input",{type:"text",value:ee,onChange:e=>se(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),x.jsxs("div",{className:"flex justify-end space-x-3",children:[x.jsx(h,{type:"button",variant:"secondary",onClick:()=>{X(!1),me(""),se("")},children:"キャンセル"}),x.jsx(h,{type:"submit",isLoading:te,className:"bg-red-600 hover:bg-red-700",disabled:"delete"!==ee,children:"アカウントを削除"})]})]})})]})})]})}export{B as ProfileSettings};
