/*! Build: 2025-07-17T07:59:15.523Z
Version: 0.0.0 */
import{r as e,j as s,aj as t,f as r,C as l,L as a,u as n,A as c,ad as i,M as d}from"./vendor-react.D8SVeCGP.js";import{C as m,B as o,u as x}from"./components-admin.GT3qRZg5.js";import{c as h}from"./hooks.CTtJlocA.js";import{s as u}from"./utils.C9ZsMnW6.js";import{V as j,g}from"./pages-dog.BrfoFXaJ.js";import"./vendor-misc.qnLj5toF.js";import"./vendor-stripe.B5MJ2ewd.js";import"./vendor-supabase.RBPF72ft.js";function N({lockId:n,parkName:c="ドッグパーク",purpose:i="entry",className:d="",onSuccess:x,onError:h}){const[u,j]=e.useState(""),[g,N]=e.useState(!1),[f,p]=e.useState(null),[b,y]=e.useState(null);return s.jsx(m,{className:`p-4 ${d}`,children:s.jsxs("div",{className:"text-center",children:[s.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-center",children:[s.jsx(t,{className:"w-5 h-5 text-blue-600 mr-2"}),c,"の","entry"===i?"入口":"出口"]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("p",{className:"text-gray-600 mb-4",children:["entry"===i?"入場":"退場","用のPINコードを入力してください"]}),s.jsx("div",{className:"flex justify-center",children:s.jsx("input",{type:"text",value:u,onChange:e=>{const s=e.target.value.replace(/\D/g,"");s.length<=6&&j(s)},placeholder:"6桁のPINコード",className:"px-4 py-2 text-center text-2xl tracking-widest w-48 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:6,inputMode:"numeric",pattern:"[0-9]*"})}),f&&s.jsxs("div",{className:"bg-red-50 p-3 rounded-lg flex items-center justify-center text-red-600",children:[s.jsx(r,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:f})]}),b&&s.jsxs("div",{className:"bg-green-50 p-3 rounded-lg flex items-center justify-center text-green-600",children:[s.jsx(l,{className:"w-4 h-4 mr-1"}),s.jsx("span",{children:b})]}),s.jsxs(o,{onClick:()=>{(async()=>{if(6===u.length){N(!0),p(null),y(null);try{const e=await fetch("/functions/v1/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lock_id:n,pin:u,purpose:i})});if(!e.ok){const s=await e.json();throw new Error(s.error||"PINコードの検証に失敗しました")}const s=await e.json();if(!s.success)throw new Error(s.error||"PINコードが無効です");y(s.message||"PINコードが確認されました"),j(""),x&&x(s),setTimeout((()=>{y(null)}),3e3)}catch(e){const s=e.message||"PINコードの検証に失敗しました";p(s),h&&h(s)}finally{N(!1)}}else p("PINコードは6桁で入力してください")})()},isLoading:g,disabled:6!==u.length,className:"w-full",children:[s.jsx(t,{className:"w-4 h-4 mr-2"}),g?s.jsx(a,{className:"w-4 h-4 animate-spin"}):"PINコードを確認"]}),s.jsxs("p",{className:"text-xs text-gray-500",children:["entry"===i?"入場":"退場","時にスマートロックのキーパッドに上記のPINコードを入力してください"]})]})]})})}function f(){var a;const{user:f}=x(),p=n();h();const[b,y]=e.useState([]),[v,w]=e.useState([]),[k,I]=e.useState([]),[P,S]=e.useState([]),[_,C]=e.useState(null),[E,T]=e.useState(!1),[q,L]=e.useState(""),[$,z]=e.useState("");e.useEffect((()=>{(async()=>{if(f)try{const{data:e,error:s}=await u.from("dogs").select("\n            *,\n            vaccine_certifications (\n              id,\n              status,\n              rabies_expiry_date,\n              combo_expiry_date,\n              approved_at\n            )\n          ").eq("owner_id",f.id);if(s)throw s;const t=(e||[]).filter((e=>"approved"===g(e)));y(t),e&&e.length>0&&0===t.length&&L("ワクチン接種証明書が承認されたワンちゃんがいません。マイページからワクチン証明書をアップロードして承認を受けてください。")}catch(e){L("ワンちゃんの情報を取得できませんでした。")}})(),(async()=>{try{T(!0);const{data:e,error:s}=await u.from("dog_parks").select("*").eq("status","approved");if(s)throw s;I(e||[]);const{data:t,error:r}=await u.from("smart_locks").select("*").eq("status","active");if(r)throw r;w(t||[]),t&&t.length>0&&C(t[0])}catch(e){L("データの取得に失敗しました。")}finally{T(!1)}})()}),[f]);const B=e=>"オス"===e?"くん":"ちゃん";return E?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"max-w-4xl mx-auto",children:[s.jsxs("div",{className:"flex items-center mb-6",children:[s.jsxs(o,{variant:"primary",size:"sm",onClick:()=>p(-1),className:"mr-3",children:[s.jsx(c,{className:"w-4 h-4 mr-2"}),"戻る"]}),s.jsx("h1",{className:"text-2xl font-bold",children:"ドッグラン入場管理"})]}),q&&s.jsx("div",{className:"mb-6 p-4 bg-red-100 text-red-700 rounded-lg",children:q}),$&&s.jsx("div",{className:"mb-6 p-4 bg-green-100 text-green-700 rounded-lg",children:$}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"space-y-6",children:[s.jsxs(m,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(i,{className:"w-5 h-5 text-blue-600 mr-2"}),"入場するワンちゃんを選択"]}),0===b.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(r,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"ワクチン承認済みのワンちゃんがいません"}),s.jsx(o,{onClick:()=>p("/register-dog"),children:"ワンちゃんを登録する"})]}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-3",children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["入場するワンちゃんを選択（最大",3,"頭）"]}),s.jsxs("div",{className:"text-sm text-gray-600",children:[P.length,"/",3,"頭選択中"]})]}),s.jsx("div",{className:"grid grid-cols-1 gap-4",children:b.map((e=>{const t=P.includes(e.id),r=!t&&P.length>=3;return s.jsxs("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors relative "+(t?"border-green-500 bg-green-50":r?"border-gray-200 bg-gray-50 opacity-50 cursor-not-allowed":"border-gray-200 hover:border-gray-300"),onClick:()=>{return!r&&(s=e.id,void S((e=>e.includes(s)?e.filter((e=>e!==s)):e.length<3?[...e,s]:e)));var s},children:[t&&s.jsx("div",{className:"absolute top-2 right-2 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center",children:s.jsx(l,{className:"w-4 h-4"})}),s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.image_url?s.jsx("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover"}):s.jsx(i,{className:"w-6 h-6 text-gray-500"})}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[s.jsxs("h3",{className:"font-semibold",children:[e.name,B(e.gender)]}),s.jsx(j,{status:g(e),size:"sm"})]}),s.jsxs("p",{className:"text-sm text-gray-600",children:[e.breed," • ",e.gender]})]})]})]},e.id)}))}),P.length>0&&s.jsxs("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[s.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"選択中のワンちゃん"}),s.jsx("p",{className:"text-sm text-green-800",children:P.map((e=>{const s=b.find((s=>s.id===e));return s?`${s.name}${B(s.gender)}`:""})).filter(Boolean).join("、")}),s.jsxs("p",{className:"text-xs text-green-700 mt-1",children:[P.length,"頭が同時入場できます"]})]})]})})]}),s.jsxs(m,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(d,{className:"w-5 h-5 text-blue-600 mr-2"}),"施設を選択"]}),0===v.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(t,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"利用可能な施設がありません"})]}):s.jsx("div",{className:"space-y-3",children:v.map((e=>{const t=k.find((s=>s.id===e.park_id)),r=(null==_?void 0:_.id)===e.id;return s.jsx("div",{className:"p-4 border-2 rounded-lg cursor-pointer transition-colors "+(r?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>C(e),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold",children:(null==t?void 0:t.name)||"Unknown Park"}),s.jsx("p",{className:"text-sm text-gray-600",children:e.lock_name}),s.jsx("p",{className:"text-xs text-gray-500",children:null==t?void 0:t.address})]}),r&&s.jsx(l,{className:"w-5 h-5 text-blue-600"})]})},e.id)}))})]})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsxs(m,{className:"p-6",children:[s.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[s.jsx(t,{className:"w-5 h-5 text-blue-600 mr-2"}),"PINコード生成"]}),_&&P.length>0?s.jsx(N,{lockId:_.lock_id,parkName:(null==(a=k.find((e=>e.id===_.park_id)))?void 0:a.name)||"ドッグパーク",purpose:"entry",onSuccess:e=>{z("PINコードを生成しました"),setTimeout((()=>{z("")}),3e3)},onError:e=>{L(e),setTimeout((()=>{L("")}),5e3)}}):s.jsxs("div",{className:"text-center py-8",children:[s.jsx(r,{className:"w-12 h-12 text-yellow-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-2",children:"PINコードを生成するには："}),s.jsxs("ul",{className:"text-sm text-gray-500 space-y-1",children:[s.jsx("li",{children:"• ワンちゃんを1頭以上選択"}),s.jsx("li",{children:"• 施設を選択"})]})]})]}),s.jsxs(m,{className:"p-6 bg-blue-50 border-blue-200",children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"PINコードの使い方"}),s.jsxs("div",{className:"space-y-3 text-sm text-blue-800",children:[s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"1"}),s.jsx("p",{children:"ワンちゃんと施設を選択してPINコードを生成します"})]}),s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"2"}),s.jsx("p",{children:"ドッグランの入口にあるスマートロックのキーパッドにPINコードを入力します"})]}),s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"3"}),s.jsx("p",{children:"PINコードは5分間有効です"})]}),s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx("div",{className:"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center text-blue-800 font-bold flex-shrink-0",children:"4"}),s.jsx("p",{children:"退場時も同様にPINコードを生成して使用します"})]})]})]})]})]})]})}export{f as AccessControl};
