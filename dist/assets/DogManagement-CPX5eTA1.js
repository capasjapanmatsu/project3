const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/authDebug-CemYwf7q.js","assets/index-B2nIfDq6.js","assets/react-vendor-ClX3xUyT.js","assets/ui-vendor-Bbvw08tP.js","assets/supabase-vendor-CRpuwX9I.js","assets/index-CagTPFPs.css","assets/directVaccineUpload-DFfQMz0j.js"])))=>i.map(i=>d[i]);
import{_ as G}from"./supabase-vendor-CRpuwX9I.js";import{u as ge,s as u,l as t,j as s,B as H,C as fe}from"./index-B2nIfDq6.js";import{r as i,L as z}from"./react-vendor-ClX3xUyT.js";import{D as pe,a as he}from"./DogCard-hjp7stu8.js";import{V as be,n as X,P as Y}from"./ui-vendor-Bbvw08tP.js";import"./dogBreeds-CaddeN4P.js";import"./Input-_c6WZwIR.js";import"./Select-DMnQLiAJ.js";import"./VaccineBadge-DlRPUcF1.js";async function W(p){try{const h=await p();return{data:h.data,error:h.error}}catch(h){return{data:null,error:h}}}function Ue(){const{user:p}=ge(),[h,Z]=i.useState([]),[ee,O]=i.useState(!0),[k,P]=i.useState(""),[re,j]=i.useState(!1),[o,B]=i.useState(null),[te,S]=i.useState(!1),[se,n]=i.useState(""),[R,y]=i.useState(""),[ae,q]=i.useState(!1),[x,J]=i.useState({name:"",breed:"",gender:"",birthDate:"",microchipNumber:""}),[m,$]=i.useState(null),[oe,U]=i.useState(null),[N,F]=i.useState(null),[I,V]=i.useState(null),[M,T]=i.useState(""),[L,A]=i.useState(""),E=i.useCallback(async()=>{try{O(!0),P("");const r=await W(()=>u.from("dogs").select("*, vaccine_certifications(*)").eq("owner_id",p?.id).order("created_at",{ascending:!1}));if(r.error){t("error","Error fetching dogs",{error:r.error,userId:p?.id}),P("ワンちゃんの情報を取得できませんでした。");return}Z(r.data||[])}catch(r){t("error","Exception in fetchDogs",{error:r,userId:p?.id}),P("ワンちゃんの情報を取得できませんでした。")}finally{O(!1)}},[p?.id]);i.useEffect(()=>{p&&E()},[p,E]);const ie=r=>{B(r),J({name:r.name,breed:r.breed,gender:r.gender,birthDate:r.birth_date,microchipNumber:r.microchip_number||""}),U(r.image_url||null);const e=r.vaccine_certifications?.[0];e&&(T(e.rabies_expiry_date||""),A(e.combo_expiry_date||"")),j(!0)},ne=r=>{const e=r.target.files?.[0];if(t("info","🔍 File selected:",e?{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified,isFileObject:e instanceof File}:{message:"No file selected"}),e)try{if(!(e instanceof File)){n("有効なファイルを選択してください。");return}if(e.size>10*1024*1024){n("画像ファイルは10MB以下にしてください。");return}if(!e.type||!e.type.startsWith("image/")){n(`画像ファイルを選択してください。選択されたファイルタイプ: ${e.type}`);return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type)){n(`サポートされていない画像形式です: ${e.type}`);return}$(e),t("info","✅ Dog image file set successfully:",{name:e.name,type:e.type,size:e.size});const c=new FileReader;c.onload=l=>{U(l.target?.result)},c.readAsDataURL(e)}catch{n("画像の処理に失敗しました。")}},ce=async()=>{if(!(!o||!o.image_url))try{S(!0),n("");try{const a=new URL(o.image_url).pathname.split("/"),c=a[a.length-1],l=`${o.id}/${c}`,{error:d}=await u.storage.from("dog-images").remove([l]);d&&console.warn("Warning: Could not delete image from storage:",d)}catch(e){t("warn","Warning: Error processing image deletion",{error:e})}const r=await W(()=>u.from("dogs").update({image_url:null}).eq("id",o.id));if(r.error){t("error","Error updating dog image_url",{error:r.error,dogId:o.id}),n("画像の削除に失敗しました。");return}$(null),U(null),B({...o,image_url:""}),await E(),t("info","✅ Dog image removed successfully",{dogId:o.id}),y("画像を削除しました。"),setTimeout(()=>{y("")},3e3)}catch(r){t("error","Error removing dog image",{error:r,dogId:o?.id}),n("画像の削除に失敗しました。")}finally{S(!1)}},le=r=>{const e=r.target.files?.[0];if(e){if(e.size>10*1024*1024){n("ワクチン証明書ファイルは10MB以下にしてください。");return}if(!e.type.startsWith("image/")){n("画像ファイルを選択してください。");return}F(e)}else F(null)},de=r=>{const e=r.target.files?.[0];if(e){if(e.size>10*1024*1024){n("ワクチン証明書ファイルは10MB以下にしてください。");return}if(!e.type.startsWith("image/")){n("画像ファイルを選択してください。");return}V(e)}else V(null)},me=async r=>{if(r.preventDefault(),!!o){S(!0),n(""),y("");try{const e={name:x.name,breed:x.breed,gender:x.gender,birth_date:x.birthDate,...x.microchipNumber&&{microchip_number:x.microchipNumber}};if(m){if(t("info","Uploading dog image",{name:m.name,type:m.type,size:m.size,lastModified:m.lastModified,isFileObject:m instanceof File}),!m.type||!m.type.startsWith("image/"))throw new Error(`無効なファイル形式です: ${m.type}`);const c=`${o.id}/dog-photo.jpg`;t("info","File path",{fileName:c}),t("info","Using direct fetch API to bypass SDK");const d=`https://onmcivwxtzqajcovptgf.supabase.co/storage/v1/object/dog-images/${c}`,{data:{session:_}}=await u.auth.getSession();if(!_?.access_token)throw new Error("認証されていません。ログインしてください。");t("info","Direct upload URL",{uploadUrl:d}),t("info","Using user access token for authentication"),t("info","Using PUT method for Supabase Storage API"),t("info","Upload options",{method:"PUT",contentType:m.type,authorization:"Bearer [token]",cacheControl:"3600"});const g=await fetch(d,{method:"PUT",headers:{Authorization:`Bearer ${_.access_token}`,"Content-Type":m.type,"Cache-Control":"3600"},body:m});if(t("info","Response status",{status:g.status}),t("info","Response headers",{headers:Object.fromEntries(g.headers.entries())}),!g.ok){const f=await g.text();throw t("error","Direct upload failed",{error:f}),new Error(`直接アップロードに失敗しました: ${g.status} ${f}`)}const D=await g.json();t("info","Direct upload success",{responseData:D});const{data:{publicUrl:C}}=u.storage.from("dog-images").getPublicUrl(c);e.image_url=C}const{error:a}=await u.from("dogs").update(e).eq("id",o.id);if(a)throw a;if(N&&I&&M&&L){const c=N.name.split(".").pop()||"jpg",l=I.name.split(".").pop()||"jpg",d=Date.now(),_=`temp/${o.id}/rabies_${d}.${c}`,g=`temp/${o.id}/combo_${d}.${l}`;t("info","Uploading vaccine certificates with direct method");const{debugAuthStatus:D}=await G(async()=>{const{debugAuthStatus:b}=await import("./authDebug-CemYwf7q.js");return{debugAuthStatus:b}},__vite__mapDeps([0,1,2,3,4,5]));await D();const{directVaccineUpload:C}=await G(async()=>{const{directVaccineUpload:b}=await import("./directVaccineUpload-DFfQMz0j.js");return{directVaccineUpload:b}},__vite__mapDeps([6,1,2,3,4,5]));t("info","Direct upload function imported successfully");const[f,w]=await Promise.all([C(_,N),C(g,I)]);if(t("info","Upload results",{rabiesUpload:f,comboUpload:w}),!f.success||!w.success){t("error","VACCINE UPLOAD ERROR DETAILS"),f.success||t("error","Rabies upload error",{error:f.error}),w.success||t("error","Combo upload error",{error:w.error});const b=f.error||w.error||"ワクチン証明書のアップロードに失敗しました。";throw new Error(`ワクチン証明書のアップロードに失敗しました: ${b}`)}t("info","Vaccine certificates uploaded successfully"),t("info","Rabies upload result",{url:f.url}),t("info","Combo upload result",{url:w.url});const K=f.url,Q=w.url;t("info","Public URLs obtained",{rabiesPublicUrl:K,comboPublicUrl:Q}),t("info","Saving vaccine certificates to database");const v=await W(()=>u.from("vaccine_certifications").upsert([{dog_id:o.id,rabies_vaccine_image:K,combo_vaccine_image:Q,rabies_expiry_date:M,combo_expiry_date:L,status:"pending"}],{onConflict:"dog_id"}));if(v.error){t("error","Database save error",{error:v.error});const b=v.error instanceof Error?v.error.message:JSON.stringify(v.error);throw b.includes("520")?new Error("一時的なサーバーエラーが発生しました。ファイルのアップロードは成功しましたが、データベースへの保存に失敗しました。しばらく待ってから再度お試しください。"):new Error(`データベースへの保存に失敗しました: ${b}`)}t("info","Vaccine certificates saved to database successfully")}y("ワンちゃん情報を更新しました"),await E(),setTimeout(()=>{j(!1),y(""),$(null),U(null),F(null),V(null),T(""),A("")},2e3)}catch(e){t("error","Error updating dog",{error:e,dogId:o?.id});let a="ワンちゃん情報の更新に失敗しました";e instanceof Error&&(e.message.includes("520")||e.message.includes("Cloudflare")?a="ワクチン証明書のアップロードは成功しましたが、一時的なサーバーエラーが発生しました。しばらく待ってから再度お試しください。":e.message.includes("アップロードに失敗しました")?a=e.message:a=`エラーが発生しました: ${e.message}`),n(a)}finally{S(!1)}}},ue=async r=>{q(!0),n("");try{t("info","Deleting dog:",{name:r.name,id:r.id});const{error:e}=await u.from("vaccine_certifications").delete().eq("dog_id",r.id);if(e&&t("warn","Error deleting vaccine certifications",{error:e,dogId:r.id}),r.image_url)try{const d=new URL(r.image_url).pathname.split("/"),_=d[d.length-1],g=`${r.id}/${_}`,{error:D}=await u.storage.from("dog-images").remove([g]);D&&console.warn("Warning: Could not delete dog image:",D)}catch(l){console.warn("Warning: Error processing dog image deletion:",l)}const a=r.vaccine_certifications?.[0];if(a){const l=[];if(a.rabies_vaccine_image&&l.push(a.rabies_vaccine_image),a.combo_vaccine_image&&l.push(a.combo_vaccine_image),l.length>0){const{error:d}=await u.storage.from("vaccine-certs").remove(l);d&&console.warn("Warning: Could not delete vaccine images:",d)}}const{error:c}=await u.from("dogs").delete().eq("id",r.id);if(c)throw t("error","Error deleting dog",{error:c,dogId:r.id}),c;t("info","Dog deleted successfully",{dogName:r.name}),await E(),j(!1),y(`${r.name}の情報を削除しました。`),setTimeout(()=>{y("")},3e3)}catch(e){t("error","Error deleting dog",{error:e,dogId:r?.id});const a=e.message||"ワンちゃんの削除に失敗しました";n(a)}finally{q(!1)}};return ee?s.jsxs("div",{className:"flex justify-center items-center h-64",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),s.jsx("p",{className:"ml-3 text-gray-600",children:"ワンちゃんの情報を読み込み中..."})]}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("div",{children:[s.jsxs(z,{to:"/dashboard",className:"inline-flex items-center text-blue-600 hover:text-blue-800 mb-2",children:[s.jsx(be,{className:"w-4 h-4 mr-1"}),"ダッシュボードに戻る"]}),s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ワンちゃん管理"}),s.jsx("p",{className:"text-gray-600",children:"登録済みのワンちゃんの情報を管理できます"})]}),s.jsx(z,{to:"/register-dog",children:s.jsxs(H,{children:[s.jsx(X,{className:"w-4 h-4 mr-2"}),"新しいワンちゃんを登録"]})})]}),k&&s.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:k}),R&&s.jsx("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded",children:R}),s.jsxs(fe,{children:[s.jsx("div",{className:"flex justify-between items-center mb-4",children:s.jsxs("h2",{className:"text-xl font-semibold flex items-center",children:[s.jsx(Y,{className:"w-6 h-6 text-blue-600 mr-2"}),"登録済みワンちゃん (",h.length,"匹)"]})}),h.length===0?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(Y,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"まだワンちゃんが登録されていません"}),s.jsx(z,{to:"/register-dog",children:s.jsxs(H,{children:[s.jsx(X,{className:"w-4 h-4 mr-2"}),"ワンちゃんを登録する"]})})]}):s.jsx("div",{className:"space-y-4",children:h.map(r=>s.jsx(pe,{dog:r,onEdit:ie},r.id))})]}),re&&o&&s.jsx(he,{dog:o,isUpdating:te||ae,error:se,success:R,dogFormData:x,dogImagePreview:oe,onClose:()=>j(!1),onSubmit:r=>void me(r),onDelete:r=>void ue(r),onFormChange:J,onImageSelect:ne,onImageRemove:()=>void ce(),rabiesVaccineFile:N,comboVaccineFile:I,rabiesExpiryDate:M,comboExpiryDate:L,onRabiesVaccineSelect:le,onComboVaccineSelect:de,onRabiesExpiryDateChange:T,onComboExpiryDateChange:A})]})}export{Ue as DogManagement};
