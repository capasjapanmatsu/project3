<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DogParkJP ログイン</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto; padding: 24px; }
    .card { max-width: 560px; margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; }
    .ok { color:#16a34a } .err{ color:#dc2626 }
    pre { background:#f7fafc; padding:12px; border-radius:8px; overflow:auto }
    button { padding:10px 16px; border:0; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer }
  </style>
  <!-- NOTE: {{LIFF_ID}} は動作確認時に実値へ置き換えてください。将来的にビルド時注入でも可 -->
</head>
<body>
  <div class="card">
    <h1>DogParkJP ログイン</h1>
    <p>LINEの同意後、自動でログイン検証を行います。</p>
    <p id="status">初期化中…</p>
    <div id="result"></div>
    <p><button id="retry" style="display:none">もう一度試す</button></p>
  </div>

  <script>
    // ★ LIFF_ID の決め方
    // 1) URLクエリ ?liffId=XXXX を優先
    // 2) それが無い場合は {{LIFF_ID}} を使用（手書き置換前提）
    const params = new URL(location.href).searchParams;
    const LIFF_ID = params.get('liffId') || "{{LIFF_ID}}"; // 例: 2007901083-yrjAg3Q5

    async function main() {
      const $status = document.getElementById('status');
      const $result = document.getElementById('result');
      const $retry  = document.getElementById('retry');

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login({ scope: ['profile','openid'] });
          return;
        }

        $status.textContent = "プロフィール取得中…";
        const profile = await liff.getProfile();
        const idToken = liff.getIDToken();

        $status.textContent = "サーバーで検証中…";
        const res = await fetch('/.netlify/functions/line-login-verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken, lineUserId: profile.userId })
        });

        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || '検証に失敗しました');

        $status.innerHTML = '<span class="ok">ログイン成功！</span>';
        $result.innerHTML = `
          <p>ようこそ、${profile.displayName} さん。</p>
          <pre>${JSON.stringify({ lineUserId: profile.userId, verified: data.user }, null, 2)}</pre>
        `;
        // TODO: 必要に応じて遷移
        // location.href = "/mypage";
      } catch (err) {
        console.error(err);
        $status.innerHTML = '<span class="err">エラー: ' + err.message + '</span>';
        $retry.style.display = 'inline-block';
        $retry.onclick = () => location.reload();
      }
    }

    main();
  </script>
</body>
</html>


