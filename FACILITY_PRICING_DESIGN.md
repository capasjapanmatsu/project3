# 施設掲載料金システム設計書

## 概要

ペット関連施設の掲載サービスにおいて、現在の無料掲載から将来的な有料掲載への移行を可能にするシステム設計です。

## 現在の状況

- **無料掲載期間**: 本人確認不要、月額料金なし
- **申請プロセス**: 基本情報と画像のみで申請可能
- **審査**: 管理者による承認制

## 将来の有料化設計

### 1. 料金体系

- **月額料金**: ¥2,200（税込）
- **支払い方法**:
  - クレジットカード（サブスクリプション）
  - 銀行振込
- **料金変更**: 管理者が自由に変更可能

### 2. 有料化時の要件

- **本人確認**: 必須
  - 運転免許証（表裏）
  - マイナンバーカード（表面のみ）
  - パスポート（顔写真ページ）
  - 法人登記簿謄本（法人の場合）
- **支払い**: 月額料金の支払い必須
- **掲載継続**: 支払い確認後に掲載継続

### 3. 未払い時の対応

- **猶予期間**: 7 日間（管理者が変更可能）
- **掲載停止**: 猶予期間後、自動的に掲載停止
- **再開**: 支払い確認後、自動的に掲載再開

## 技術実装

### 1. 設定管理

- **ファイル**: `src/utils/facilityPricing.ts`
- **機能**: 無料/有料モードの切り替え設定
- **データベース**: Supabase の settings テーブル（予定）

### 2. 管理者コンポーネント

- **ファイル**: `src/components/admin/FacilityPricingManager.tsx`
- **機能**:
  - 無料/有料モードの切り替え
  - 月額料金の設定
  - 支払い方法の設定
  - 猶予期間の設定

### 3. 申請フォーム

- **現在**: 本人確認不要のシンプルフォーム
- **有料化時**: 本人確認書類アップロード機能を追加

### 4. 支払い処理

- **Stripe**: クレジットカード決済（サブスクリプション）
- **銀行振込**: 手動確認システム
- **状態管理**: payment_status フィールドで管理

## データベース設計

### 施設テーブル (pet_facilities)

```sql
- payment_status: 'paid' | 'unpaid' | 'overdue'
- last_payment_date: timestamp
- next_payment_due: timestamp
- subscription_id: string (Stripe用)
```

### 本人確認テーブル (owner_verifications)

```sql
- user_id: uuid
- facility_id: uuid
- document_type: string
- front_image_path: string
- back_image_path: string
- status: 'pending' | 'approved' | 'rejected'
- submitted_at: timestamp
```

### 設定テーブル (facility_settings)

```sql
- key: string (PRIMARY KEY)
- value: jsonb
- updated_at: timestamp
- updated_by: uuid
```

## 移行プロセス

### Phase 1: 現在（無料期間）

- ✅ 本人確認なしの申請フォーム
- ✅ 管理者承認制
- ✅ 無料掲載メッセージ

### Phase 2: 有料化準備

- [ ] 設定管理システムの実装
- [ ] 管理者ページでの切り替え機能
- [ ] 本人確認機能の実装（無効化状態）
- [ ] Stripe 連携の準備

### Phase 3: 有料化実施

- [ ] 管理者が有料モードに切り替え
- [ ] 既存施設への通知
- [ ] 新規申請で本人確認＋支払い必須
- [ ] 未払い施設の掲載停止システム

### Phase 4: 運用・保守

- [ ] 支払い状況の監視
- [ ] 自動課金システム
- [ ] 顧客サポート

## セキュリティ考慮事項

### 本人確認書類

- ストレージ: Supabase Storage（暗号化）
- アクセス制御: 管理者のみ閲覧可能
- 保存期間: 承認後 1 年で自動削除
- ログ: アクセスログを記録

### 支払い情報

- Stripe: PCI DSS 準拠
- 銀行振込: 振込記録の安全な管理
- 個人情報: 最小限の収集・保存

### 管理者権限

- 2FA 必須
- 設定変更のログ記録
- 重要操作の承認プロセス

## 料金変更の柔軟性

### 管理者による変更可能項目

- 月額料金
- 支払い猶予期間
- 支払い方法の有効/無効
- カテゴリ別料金（将来的）
- 無料期間の設定

### 変更時の考慮事項

- 既存契約への影響
- 利用者への事前通知
- 法的要件の確認
- システムテスト

## 監視・レポート

### 管理者ダッシュボード

- 収益レポート
- 支払い状況一覧
- 未払い施設リスト
- 新規申請状況

### 自動化

- 支払い期限の通知
- 掲載停止の自動実行
- 月次レポートの生成
- 異常検知アラート

---

**注意**: この設計は将来の有料化を想定したものです。現在は無料掲載期間中のため、本人確認や支払い機能は実装されていません。
